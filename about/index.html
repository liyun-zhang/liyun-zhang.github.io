<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"liyun-zhang.github.io","root":"/","images":"/images","scheme":"Mist","darkmode":true,"version":"8.17.0","exturl":false,"sidebar":{"position":"right","display":"hide","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="LiyunZhang">
<meta property="og:url" content="http://liyun-zhang.github.io/about/index.html">
<meta property="og:site_name" content="LiyunZhang">
<meta property="og:locale">
<meta property="article:author" content="LiyunZhang">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://liyun-zhang.github.io/about/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-Hans","comments":"","permalink":"","path":"about/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>LiyunZhang</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">LiyunZhang</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">LiyunZhang</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">66</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">11</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">30</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://liyun-zhang.github.io/2024/03/24/Version-Control/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LiyunZhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LiyunZhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LiyunZhang">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/03/24/Version-Control/" class="post-title-link" itemprop="url">Version Control</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-03-24 23:36:44" itemprop="dateCreated datePublished" datetime="2024-03-24T23:36:44+08:00">2024-03-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-03-25 12:11:15" itemprop="dateModified" datetime="2024-03-25T12:11:15+08:00">2024-03-25</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><ul class="markdownIt-TOC">
<li><a href="#file">File</a>
<ul>
<li><a href="#how-to-organize-logs">How to organize logs?</a></li>
<li><a href="#how-do-we-know-the-information-of-files">How do we know the information of files?</a></li>
<li><a href="#how-to-iterate-over-a-block">How to iterate over a Block?</a></li>
</ul>
</li>
</ul>
</p>
<h1 id="file"><a class="markdownIt-Anchor" href="#file"></a> File</h1>
<h2 id="how-to-organize-logs"><a class="markdownIt-Anchor" href="#how-to-organize-logs"></a> How to organize logs?</h2>
<ol>
<li>There are <code>mem_</code>, <code>imm_</code>, and persisted logs. They are all Memtables.</li>
<li>Both <code>mem_</code> and <code>imm_</code> are in volatile storages.
<ul>
<li>The <code>mem_</code> is the latest Memtable to which we can append logs.</li>
<li>When <code>mem_</code> is full, it will be frozen into <code>imm_</code> to be an immutable Memtable.</li>
</ul>
</li>
<li>The <code>imm_</code> will be written into disks as persisted logs.
<ul>
<li>The persisted logs are separated into several levels, starting from <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span>. The lower level contains newer logs.</li>
<li>The SSTables at lower levels can be compacted into higher-level SSTables.</li>
</ul>
</li>
</ol>
<h2 id="how-do-we-know-the-information-of-files"><a class="markdownIt-Anchor" href="#how-do-we-know-the-information-of-files"></a> How do we know the information of files?</h2>
<ol>
<li>Each <code>FileMetaData</code> corresponds to a file on the disk. It contained basic metadata of a file, including ID (<code>number</code>), size (<code>file_size</code>), and its key range (<code>smallest</code> and <code>largest</code>).</li>
<li>The <code>Version</code> contains all the metadata of files.
<ul>
<li>List of files of different levels are stored in <code>std::vector&lt;FileMetaData*&gt; files_[config::kNumLevels]</code>.</li>
<li>Both <code>Version</code> and <code>FileMetaData</code> uses <code>ref</code> to track pointers that point to them. They are destroyed when <code>ref</code> goes to <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span>.</li>
</ul>
</li>
<li>The <code>VersionSet</code> contains all the <code>Version</code>s of the database. They are formed into a list.
<ul>
<li>The most recent version is in <code>current_</code>. There is a <code>dummy_versions_</code> as the head of the list.</li>
<li>The <code>prev_</code> pointer in <code>Version</code> is the previous version while <code>next_</code> is the newer version.</li>
<li>The <code>current_</code> is considered the previous of <code>dummy_versions_</code>.</li>
</ul>
</li>
<li>From <code>VersionSet::AppendVersion</code>, we can see that this list is a cycle.
<ul>
<li>The <code>next_</code> of <code>dummy_versions_</code> points to the oldest version since it will only be set when add the first version into the list.</li>
<li>The <code>prev_</code> of the oldest version points to the <code>dummy_versions_</code>.</li>
</ul>
</li>
</ol>
<h2 id="how-to-iterate-over-a-block"><a class="markdownIt-Anchor" href="#how-to-iterate-over-a-block"></a> How to iterate over a Block?</h2>
<ol>
<li></li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://liyun-zhang.github.io/2024/03/22/OpenSource/LevelDB/Cache/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LiyunZhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LiyunZhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LiyunZhang">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/03/22/OpenSource/LevelDB/Cache/" class="post-title-link" itemprop="url">2. Cache</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-03-22 00:30:14" itemprop="dateCreated datePublished" datetime="2024-03-22T00:30:14+08:00">2024-03-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-03-25 14:51:16" itemprop="dateModified" datetime="2024-03-25T14:51:16+08:00">2024-03-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Open-Source-Code/" itemprop="url" rel="index"><span itemprop="name">Open Source Code</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Open-Source-Code/LevelDB/" itemprop="url" rel="index"><span itemprop="name">LevelDB</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><ul class="markdownIt-TOC">
<li><a href="#how-to-prevent-reading-from-the-disk-too-often">How to prevent reading from the disk too often?</a></li>
<li><a href="#lrucache">LRUCache</a>
<ul>
<li><a href="#how-does-handletable-insert-evict-and-lookup-items-in-table_">How does HandleTable insert, evict, and lookup items in table_?</a></li>
<li><a href="#how-to-insert-evict-and-lookup-items">How to insert, evict, and lookup items?</a></li>
</ul>
</li>
<li><a href="#tablecache">TableCache</a>
<ul>
<li><a href="#what-is-stored-in-each-cache-slot">What is stored in each cache slot?</a></li>
<li><a href="#how-does-tablecache-read-a-key">How does TableCache read a key?</a></li>
<li><a href="#how-does-tablecache-iterate-over-a-file">How does TableCache iterate over a file?</a></li>
</ul>
</li>
</ul>
</p>
<h1 id="how-to-prevent-reading-from-the-disk-too-often"><a class="markdownIt-Anchor" href="#how-to-prevent-reading-from-the-disk-too-often"></a> How to prevent reading from the disk too often?</h1>
<ol>
<li>There are only two Memtables, <code>mem_</code> and <code>imm_</code>, in the memory. We may need to read from disk often, especially for level <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span> files. The solution is to cache</li>
<li>The <code>TableCache</code> provides interfaces for <code>VersionSet</code> to use cache strategies.
<ul>
<li>It has a <code>Cache*</code> that points to a specific cache strategy. The <code>Cache</code> is a base class implemented by <code>ShardedLRUCache</code> in <a target="_blank" rel="noopener" href="https://github.com/google/leveldb/blob/068d5ee1a3ac40dabd00d211d5013af44be55bea/util/cache.cc#L339">cache.cc</a>.</li>
</ul>
</li>
<li>The <code>ShardedLRUCache</code> hashes keys into several <code>LRUCache</code>s.</li>
<li>Each <code>LRUCache</code> uses <code>LRUHandle</code> to store the list of cached contents.
<ul>
<li>There are two lists: one <code>in-use_</code> list contains the items currently referenced by clients, and another <code>lru_</code> list includes the items not currently referenced by clients in LRU order.</li>
<li>Another <code>HandleTable</code> is used to fetch the items according to their hash value.</li>
</ul>
</li>
</ol>
<h1 id="lrucache"><a class="markdownIt-Anchor" href="#lrucache"></a> LRUCache</h1>
<h2 id="how-does-handletable-insert-evict-and-lookup-items-in-table_"><a class="markdownIt-Anchor" href="#how-does-handletable-insert-evict-and-lookup-items-in-table_"></a> How does HandleTable insert, evict, and lookup items in table_?</h2>
<ol>
<li>In <code>HandleTable</code>, <code>length_</code> is the total number of items in the cache. Here, we need to take the modulo operation on h again.
<ul>
<li>Since <code>length_</code> is set to be a power of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn></mrow><annotation encoding="application/x-tex">2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">2</span></span></span></span>, <code>hash &amp; length_-1</code> is the modulo operation of <code>hash</code> concerning <code>length_</code>.</li>
</ul>
</li>
<li>The items in <code>HandleTable</code> are contained in a variable-length array <code>LRUHandle** list_</code>.
<ul>
<li>Normally, each slot only has one item. However, when the size is growing, rehashing may cause a hash collision. Those collide items are connected into a list by <code>next_hash</code>.</li>
</ul>
</li>
<li>The <code>HandleTable::FindPointer</code> returns a pointer that points to the slot instead of the item.
<ul>
<li>The target item is identified by having the same <code>hash</code> or the same key.</li>
<li>When the target item does not exist, it should return a position indicating the slot to insert the item instead of a <code>nullptr</code>.</li>
<li>When inserting an item, the new item will be replaced if the pointer points to another item or increases the number of elements. If the number of elements exceeds the <code>length_</code>, the table needs to resize.</li>
<li>When evicting an item, store the <code>next_hash</code> pointer in the found slot.</li>
</ul>
</li>
</ol>
<h2 id="how-to-insert-evict-and-lookup-items"><a class="markdownIt-Anchor" href="#how-to-insert-evict-and-lookup-items"></a> How to insert, evict, and lookup items?</h2>
<ol>
<li>The <code>next</code> and <code>prev</code> in <code>LRUHandler</code> point to their neighbors in the <code>in_use_</code> or <code>lru_</code> list. The <code>next_hash</code> points to its neighbor in <code>table_</code>.</li>
<li>To lookup a key, the <code>HandleTable::Lookup</code> is invoked. If the key exists, its <code>refs</code> is increased and moved to the <code>in_use_</code> list if it is in the <code>lru_</code>.</li>
<li>To insert a key, it must be appended to the <code>in_use_</code> list and the <code>table_</code>. We also need to remove what it replaced.
<ul>
<li>If the <code>capacity_</code> is <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span> indicating the cache is turned off, these operations can be skipped.</li>
<li>If the cache usage after inserting exceeds the capacity, we need to evict items in the <code>lru_</code> in order.</li>
</ul>
</li>
<li>Both lookup and insert return a <code>Handle*</code> that can be reinterpreted as a <code>LRUHandle*</code>.</li>
<li>When the clients release an item, its <code>refs</code> is decreased.
<ul>
<li>When the <code>refs</code> is <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>, which means that only the LRUCache is holding it and can be moved from <code>in_use_</code> to <code>lru_</code>. The <code>prev</code> of <code>lru_</code> is the newest item while the <code>next</code> of <code>lru_</code> is the oldest. Therefore, <code>lru_.next</code> is the first item to be evicted.</li>
<li>When the <code>refs</code> is <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span>, which means no one is holding it, and it will be deleted.</li>
</ul>
</li>
</ol>
<h1 id="tablecache"><a class="markdownIt-Anchor" href="#tablecache"></a> TableCache</h1>
<h2 id="what-is-stored-in-each-cache-slot"><a class="markdownIt-Anchor" href="#what-is-stored-in-each-cache-slot"></a> What is stored in each cache slot?</h2>
<ol>
<li>The first kind of cached content is a specific fileâ€™s index block.
<ul>
<li>The table cache uses the file number as the key. The value is a void pointer that can be interpreted as <code>TableAndFile*</code>.</li>
<li>The <code>TableAndFile</code> is the <code>RandomAccessFile*</code> and <code>Table*</code> to access the file. So, a cache slot stores the access to a file and the index of its keys.</li>
<li>The <code>RandomAccessFile*</code> provides a <code>Read</code> to read content for a given destination. The cache operations are executed through <code>Table*</code>.</li>
<li>The core of a <code>Table</code> is <code>Table::Rep</code>, which contains the contents of the index block in <code>Block* index_block</code> and its  <code>cache_id</code>, which is a globally unique, monotonously increasing ID.</li>
<li>The <code>rep_-&gt;options.block_cache</code> points to the <code>SharedLRUCache</code> where the <code>Table</code> is.</li>
</ul>
</li>
<li>The second kind of content cached is a data block of a <code>TableAndFile*</code>.
<ul>
<li>The key is the <code>cache_id</code> of the <code>TableAndFile*</code> and its offset in that file. The value is a <code>Block</code> containing its contents.</li>
</ul>
</li>
</ol>
<h2 id="how-does-tablecache-read-a-key"><a class="markdownIt-Anchor" href="#how-does-tablecache-read-a-key"></a> How does TableCache read a key?</h2>
<ol>
<li>To read a key from a specific file with <code>TableCache</code>, <code>TableCache::Get</code> first tries to find the index block of that file by <code>FindTable</code>.
<ul>
<li>If the target key is found, it will be processed by <code>void (*handle_result)(void*, const Slice&amp;, const Slice&amp;)</code>.</li>
<li>If the file is not currently in the cache, it will create an entry and be inserted.</li>
</ul>
</li>
<li>Then, use the <code>Table::InternalGet</code> to seek the target key from the index of the file.
<ul>
<li>If the key is not in this file, do nothing and return.</li>
<li>Otherwise, use the <code>Table::BlockReader</code> to generate a block iterator to seek the key in the block designated by the information from the index iterator.</li>
<li>It would try to find whether the target block is read into the cache. If not, read the block from the disk and insert it into the cache.</li>
<li>If the key is found in that block, <code>handle_result</code> will process the key-value pair.</li>
</ul>
</li>
<li>The table can be released immediately after the <code>InternalGet</code> is returned.</li>
</ol>
<h2 id="how-does-tablecache-iterate-over-a-file"><a class="markdownIt-Anchor" href="#how-does-tablecache-iterate-over-a-file"></a> How does TableCache iterate over a file?</h2>
<ol>
<li>Like reading a value, the <code>FindTable</code> will load the index block into the cache.</li>
<li>Then, a <code>TwoLevelIterator</code> is created to iterate the <code>Table</code> using <code>Table::NewIterator</code>.
<ul>
<li>It is initialized with a <code>Block::Iter</code> to iterate over the index block and a <code>BlockFunction</code> to generate another iterator to read data according to the information from the index iterator from its <code>value()</code>.
<ul>
<li>The <code>BlockFunction</code> is defined as <code>Iterator* (*BlockFunction)(void*, const ReadOptions&amp;, const Slice&amp;)</code>.</li>
</ul>
</li>
<li>In <code>TableCache</code>, <code>Table::BlockReader</code> is passed to be the <code>BlockFunction</code>.</li>
</ul>
</li>
<li>To iterate over the file, iterate over the index block and fetch the corresponding data block of valid index entries.
<ul>
<li>We can initiate the <code>TwoLevelIterator</code> with <code>Seek</code>, <code>SeekToFirst</code>, or <code>SeekToLast</code>.
<ul>
<li>They will set the index iterator to a valid position that satisfies the requests.</li>
<li>Then, <code>TwoLevelIterator::InitDataBlock</code> is invoked to load the iterator of the data block with <code>block_function_</code>.</li>
</ul>
</li>
<li>It can advance with <code>TwoLevelIterator::Next</code> and move backward with <code>TwoLevelIterator::Prev</code>.
<ul>
<li>They will move the data iterator before skipping those empty or invalid entries.</li>
<li>Skipping moves the index iterator and tries to initiate the data iterator until it is valid.</li>
<li>When constructing the data iterator, a <code>data_block_handle_</code> is stored to identify the current file so we can skip the entries in the same block when moving the index iterator.</li>
</ul>
</li>
</ul>
</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://liyun-zhang.github.io/2024/03/20/LSM-Tree/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LiyunZhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LiyunZhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LiyunZhang">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/03/20/LSM-Tree/" class="post-title-link" itemprop="url">2. LSM-Tree</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-03-20 13:29:38" itemprop="dateCreated datePublished" datetime="2024-03-20T13:29:38+08:00">2024-03-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-03-25 14:47:58" itemprop="dateModified" datetime="2024-03-25T14:47:58+08:00">2024-03-25</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><ul class="markdownIt-TOC">
<li><a href="#write">Write</a>
<ul>
<li><a href="#how-to-write-a-log">How to write a log?</a></li>
<li><a href="#how-are-writebatches-encoded">How are WriteBatches encoded?</a></li>
<li><a href="#how-to-make-room-for-the-writes">How to make room for the writes?</a></li>
<li><a href="#how-to-pick-the-tables-to-compact">How to pick the tables to compact?</a></li>
<li><a href="#how-to-perform-compact">How to perform compact?</a></li>
</ul>
</li>
<li><a href="#get">Get</a>
<ul>
<li><a href="#how-to-get-a-key-from-the-database">How to get a key from the database?</a></li>
</ul>
</li>
</ul>
</p>
<h1 id="write"><a class="markdownIt-Anchor" href="#write"></a> Write</h1>
<p>The codes are in <a target="_blank" rel="noopener" href="https://github.com/google/leveldb/blob/068d5ee1a3ac40dabd00d211d5013af44be55bea/db/db_impl.h">db_impl.h</a> and <a target="_blank" rel="noopener" href="https://github.com/google/leveldb/blob/068d5ee1a3ac40dabd00d211d5013af44be55bea/db/db_impl.cc">db_impl.cc</a>.</p>
<h2 id="how-to-write-a-log"><a class="markdownIt-Anchor" href="#how-to-write-a-log"></a> How to write a log?</h2>
<ol>
<li>
<p>The <code>db_impl</code> provided <code>Put</code> and <code>Delete</code>.</p>
<ul>
<li>
<p>They encode requested writes into a <code>WriteBatch</code> and invoke <code>db_impl::Write</code> to finish the write.</p>
</li>
<li>
<p>The orders of concurrent writes are determined by their orders in <code>db_impl::writers_</code>.</p>
</li>
</ul>
</li>
<li>
<p>To execute a write, the first step is to invoke <code>MakeRoomForWrite</code> to reserve enough space in <code>mem_</code>, which is the only structure that can be modified.</p>
</li>
<li>
<p>Each entry in the <code>WriteBatch</code> is assigned a unique, monotonously increasing sequential number.</p>
</li>
<li>
<p>Before calling the <code>MemTableInserter</code> to apply each write to <code>mem_</code>, the write records must be put into the write-ahead log <code>log_</code>.</p>
</li>
</ol>
<h2 id="how-are-writebatches-encoded"><a class="markdownIt-Anchor" href="#how-are-writebatches-encoded"></a> How are WriteBatches encoded?</h2>
<ol>
<li>
<p>In <code>WriteBatch</code>, a <code>req_</code> contains all requests in the following format, where <code>key_size</code> and <code>value_size</code> are encoded by <code>EncodeVarint32</code>, the same as <code>Memtable</code>.</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">req_: </span><br><span class="line">+----------+-------+-----------+</span><br><span class="line">|  SeqNum  |  cnt  |  records  |</span><br><span class="line">+----------+-------+-----------+</span><br><span class="line">records:</span><br><span class="line">+--------+------------+-------+-------------+---------+</span><br><span class="line">|  type  |  key_size  |  key  |  value_size |  value  |</span><br><span class="line">+--------+------------+-------+-------------+---------+</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>A <code>Put</code> request has type <code>kTypeValue</code>. A <code>Delete</code> request has type <code>kTypeDeletion</code> and without the value part.</p>
</li>
<li>
<p>When creating a new <code>WriteBatch</code>, the <code>req_</code> reserves <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>12</mn></mrow><annotation encoding="application/x-tex">12</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord">2</span></span></span></span> bytes, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>8</mn></mrow><annotation encoding="application/x-tex">8</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">8</span></span></span></span> bytes for <code>SeqNum</code> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>4</mn></mrow><annotation encoding="application/x-tex">4</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">4</span></span></span></span> bytes for <code>cnt</code>.</p>
<ul>
<li>The <code>SeqNum</code> and <code>cnt</code> are initially <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span>.</li>
<li>When a new request is added to a <code>WriteBatch</code>, a <code>SetCount</code> is invoked to modify the <code>cnt</code>.</li>
<li>The <code>SeqNum</code> is set when the write is being executed instead of when collecting.</li>
</ul>
</li>
</ol>
<h2 id="how-to-make-room-for-the-writes"><a class="markdownIt-Anchor" href="#how-to-make-room-for-the-writes"></a> How to make room for the writes?</h2>
<ol>
<li>If the <code>WriteBatch</code> is <code>nullptr</code>, the compaction is forced.</li>
<li>If <code>mem_</code> is not full, no more efforts need to be made. Otherwise, we must set the current <code>mem_</code> as immutable, i.e., <code>imm_</code>, and switch to a new one.</li>
<li>If <code>imm_</code> is not empty or there are too many level <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span> files, we need to wait for the background thread to compact the current files.</li>
<li>If <code>mem_</code> is full, <code>imm_</code> is empty, and there is enough space for level <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span> we can schedule a compaction and switch to a new <code>mem_</code>.
<ul>
<li>The write-ahead log file <code>logfile_</code> is bound with a <code>mem_</code>. Switching to a new <code>mem__</code> also needs to create a new <code>logfile_</code>.</li>
<li>Then, <code>imm_</code> points to the current <code>mem_</code> before creating a new Memtable for <code>mem_</code>.</li>
</ul>
</li>
</ol>
<h2 id="how-to-pick-the-tables-to-compact"><a class="markdownIt-Anchor" href="#how-to-pick-the-tables-to-compact"></a> How to pick the tables to compact?</h2>
<p>The codes are in <a target="_blank" rel="noopener" href="https://github.com/google/leveldb/blob/068d5ee1a3ac40dabd00d211d5013af44be55bea/db/db_impl.cc#L702">DBImpl::BackgroundCompaction</a>.</p>
<ol>
<li>The compaction with the highest priority is called a minor compact. It happens when <code>imm_</code> is not empty, it must be written to the level <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span> files.</li>
<li>The second priority is the manual compaction when <code>manual_compaction_</code> is not <code>nullptr</code>.
<ul>
<li>A <code>ManualCompaction</code> indicates the level and the range to compact. All files at the given level that overlaps with the specific range will be compact.</li>
</ul>
</li>
<li>In <code>VersionSet::PickCompaction</code>, there are two kinds of compactions: size compaction and seek compaction.</li>
<li>The size compaction designates a <code>compaction_level_</code> with the highest <code>compaction_score_</code> to compact.
<ul>
<li>It is calculated for each level when editing a new version in the database.</li>
<li>For level-<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span> files, the score is the ratio of the number of files and the <code>kL0_CompactionTrigger</code>. For other levels, it is the ratio of the total file size in that level against the maximum size for each level.</li>
<li>The size compaction is triggered when the <code>compaction_score_ &gt;= 1</code>, i.e., the number or size of files in a certain level exceeds the maximum line.</li>
<li>The first file that comes after <code>compact_pointer_[level]</code> is picked to compact.</li>
</ul>
</li>
<li>The seek compaction designates a <code>file_to_compact_</code> to be the candidate.</li>
<li>The files in level-<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span> may overlap. We must make sure that no remaining files overlap with those files to compact.
<ul>
<li>A file in the level-<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span> may extend the search range and require restarting the search in manual compaction.</li>
<li>The size compaction and seek compaction would pick more than one file to compact when overlap exists.</li>
</ul>
</li>
<li>After the above procedures, the size compaction and the seek compaction have selected some files in the lower level to compact, which is in <code>Compaction.input[0]</code>.
<ul>
<li>Those files will compact with the files in the next level that overlaps with them, which is in <code>Compaction.input[1]</code>.</li>
<li>The boundaries of files are encoded by the user key and sequential number.
<ul>
<li>The sequence number is encoded in a little-endian way. So, the newer keys might be in front of the older keys in the former block, e.g., when a higher byte is changed.</li>
<li>There is a case in the upper bound of a file and the lower bound of another file shares the same user key with an older sequence number.</li>
<li>If we only compact the former file, in reading, we might find the older result in a lower level instead of the correct value in a higher level.</li>
</ul>
</li>
</ul>
</li>
<li>To compact more thoroughly, we try to expand the current inputs by including all files at the compact level that overlap with them.
<ul>
<li>The files overlap with the files at the compact level is already included. This time is mainly for the files at the compact level that overlaps with files in the next level. Also need to include those boundary files.</li>
<li>This is merely a trial. It only happens when the total size of <code>Compaction.inputs[1]</code> and expanded files is less than the <code>ExpandedCompactionByteSizeLimit</code>.</li>
<li>Another condition for this expansion is that we cannot increase the number of files selected from the next level. Namely, the range of the new expanded files is already included in the <code>Compaction.inputs[1]</code>.</li>
</ul>
</li>
<li>The grandparent files in the next two levels that overlap with all files in both lower levels are required.</li>
<li>Finally, update the place where we will do the next compaction for this level in <code>compact_pointer_[level]</code>.</li>
</ol>
<ul>
<li>We update this immediately instead of waiting for the VersionEdit to be applied so that if the compaction fails, we will try a different key range next time.</li>
</ul>
<h2 id="how-to-perform-compact"><a class="markdownIt-Anchor" href="#how-to-perform-compact"></a> How to perform compact?</h2>
<ol>
<li>If this is not a manual compaction and there is only one file in <code>Compaction.inputs[0]</code> and no next-level file to merge, we only need to trivially move the file into the next level.
<ul>
<li>In the <code>VersionEdit</code>, remove the file in <code>Compaction.inputs[0]</code> from its level and add it into the next level.</li>
</ul>
</li>
<li>We create a <code>MergingIterator</code> to complete the merge process.
<ul>
<li>Given that level-<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span> files might overlap, there is a <code>TwoLevelIterator</code> for each files. For other levels, one iterator is enough to traverse them in order.
<ul>
<li>What is read by a <code>TwoLevelIterator</code> is determined by the index interator passed to it.</li>
<li>For the level-<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span> files, we use the index iterator of its index block.</li>
<li>For other levels, the <code>Version::LevelFileNumIterator</code> is passed to be the index iterator. It has an <code>index_</code> pointing the current reading file.</li>
<li>The passed <code>handler_result</code> is <code>GetFileIterator</code> that will create another file iterator of the current reading file using <code>TableCache::NewIterator</code>.</li>
</ul>
</li>
<li>All the files that are involved are pinned in the cache now.</li>
</ul>
</li>
<li>The <code>MergingIterator</code> uses a <code>children_</code> to store all iterators of involved files and a <code>current_</code> to point to the current entry.
<ul>
<li>The <code>SeekToFirst</code> sets all iterators in <code>children_</code> to their first position and <code>current_</code> to the iterator with smallest key. The <code>SeekToLast</code> is similar.</li>
<li>The <code>Seek</code> sets all iterators to their <code>Seek(target)</code> and <code>current_</code> to the smallest.</li>
<li>In the <code>Next</code>, all children are set to their seek of the current key and move to the next if they have the same key. Then, set the <code>current_</code> to the smallest among them. The <code>Prev</code> is similar.</li>
</ul>
</li>
<li></li>
</ol>
<h1 id="get"><a class="markdownIt-Anchor" href="#get"></a> Get</h1>
<h2 id="how-to-get-a-key-from-the-database"><a class="markdownIt-Anchor" href="#how-to-get-a-key-from-the-database"></a> How to get a key from the database?</h2>
<ol>
<li>
<p>The <code>DBImpl::Get</code> searches the key from the latest records to the oldest records. First search on the <code>mem_</code>. If missed, try on the <code>imm_</code>.</p>
</li>
<li>
<p>If it is not found in memory, read from the files on disk by <code>Version::Get</code> of the current version.</p>
<ul>
<li>
<p>The level <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span> files may have overlapped ranges. Search level-<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span> in order from newest to oldest. Check every file that may contain the target key through <code>TableCache::Get</code>.</p>
</li>
<li>
<p>The <code>handle_result</code> is a function to save the matched value to a <code>Save*</code>.</p>
</li>
<li>
<p>Other levels can use binary search to file the possible file.</p>
</li>
</ul>
</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://liyun-zhang.github.io/2024/03/19/OpenSource/LevelDB/Memtable/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LiyunZhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LiyunZhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LiyunZhang">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/03/19/OpenSource/LevelDB/Memtable/" class="post-title-link" itemprop="url">1. Memtable</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-03-19 12:50:37" itemprop="dateCreated datePublished" datetime="2024-03-19T12:50:37+08:00">2024-03-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-03-20 15:37:01" itemprop="dateModified" datetime="2024-03-20T15:37:01+08:00">2024-03-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Open-Source-Code/" itemprop="url" rel="index"><span itemprop="name">Open Source Code</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Open-Source-Code/LevelDB/" itemprop="url" rel="index"><span itemprop="name">LevelDB</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>@[toc]</p>
<h1 id="Skiplist"><a href="#Skiplist" class="headerlink" title="Skiplist"></a>Skiplist</h1><p>The codes are in <a target="_blank" rel="noopener" href="https://github.com/liyun-zhang/leveldb/blob/main/db/skiplist.h">skiplist.h</a></p>
<h2 id="What-is-the-structure-of-the-skip-list"><a href="#What-is-the-structure-of-the-skip-list" class="headerlink" title="What is the structure of the skip list?"></a>What is the structure of the skip list?</h2><ol>
<li>The skip list is a list with extended next pointers. </li>
<li>The next pointers in a node have different heights. The maximum height of each node is different. A next pointer at a specific height points to the next node that is not shorter than the height. </li>
<li>The â€œskipâ€ refers to the higher pointers that point to distant nodes. Therefore, through the skip links, we can quickly locate the possible range of the target in search and inserting, similar to the doubling method in continuous arrays. </li>
</ol>
<h2 id="What-does-the-list-node-look-like"><a href="#What-does-the-list-node-look-like" class="headerlink" title="What does the list node look like?"></a>What does the list node look like?</h2><ol>
<li>A node should contain a key and a series of pointers to the next node. </li>
<li>In the skip list, the next pointers are at different heights. The higher pointers point to further nodes. </li>
<li>To allocate an array of next node pointers, declare an array with one element at the end of the structure. Then, assign a large space to the object of that structure. <ul>
<li>The array of next pointers is declared as <code>std::atomic&lt;Node*&gt; next_[1];</code>. </li>
<li>In the <code>NewNode(const Key&amp; key, int height)</code>, use <code>Arena</code> to allocate size <code>sizeof(Node) + sizeof(std::atomic&lt;Node*&gt;) * (height - 1)</code>. </li>
<li>In <code>sizeof(Node)</code>, an array with one element is allocated. Then, the space of additional <code>height-1</code> elements is extended. Therefore, a <code>Node</code> has total <code>height</code> next pointers. </li>
</ul>
</li>
</ol>
<h2 id="How-to-search-for-a-key"><a href="#How-to-search-for-a-key" class="headerlink" title="How to search for a key?"></a>How to search for a key?</h2><ol>
<li><code>Skiplist</code> provided <code>FindGreaterOrEqual</code> and <code>FindLessThan</code> as basic functions to search for a key. </li>
<li>Each function starts from the <code>head_</code> and compares it with the next key, from higher to lower. </li>
<li>In <code>FindGreaterOrEqual</code>, we should keep lowering the height until the key is larger than the next. If it reaches the lowest height, $0$, directly return the current node. </li>
<li><code>FindLessThan</code> is similar, searching until the key is less than the next or reaches the lowest height. </li>
<li>The search process is fast because the higher next pointers can skip many unnecessary nodes. </li>
</ol>
<h2 id="How-to-insert-a-key"><a href="#How-to-insert-a-key" class="headerlink" title="How to insert a key?"></a>How to insert a key?</h2><ol>
<li>To find a suitable position on the list for the new key, we can get all the previous nodes through <code>FindGreaterOrEqual</code>. <ul>
<li><code>FindGreaterOrEqual</code> only returns when it reaches the $0$ height. Whenever the next key of the current node in a certain height is less than the target key, we record the current node to the <code>prev</code> of the corresponding height. </li>
<li>When it returns, each element in <code>prev</code> is the previous node of the new node. </li>
</ul>
</li>
<li>The maximum height of the new node is random. If it is higher than the highest node, set extra pointers to <code>head_</code>. <ul>
<li>In <code>RandomHeight</code>, <code>while (height &lt; kMaxHeight &amp;&amp; rnd_.OneIn(kBranching))</code> shows that height is geometric distribution with probability of $\frac{1}{kBranching}$ to keep increasing the height. </li>
</ul>
</li>
<li>Finally, we set the next pointers in the new node to the next pointers in <code>prev</code> and set the next pointers in <code>prev</code> to the new node. </li>
</ol>
<h1 id="Memtable"><a href="#Memtable" class="headerlink" title="Memtable"></a>Memtable</h1><p>The codes are in <a target="_blank" rel="noopener" href="https://github.com/liyun-zhang/leveldb/blob/main/db/memtable.h">memtable.h</a> and <a target="_blank" rel="noopener" href="https://github.com/liyun-zhang/leveldb/blob/main/db/memtable.cc">memtable.cc</a></p>
<h2 id="How-does-Memtable-encode-data"><a href="#How-does-Memtable-encode-data" class="headerlink" title="How does Memtable encode data?"></a>How does Memtable encode data?</h2><ol>
<li>In Memtable, the bottom storage uses <code>Table</code> defined as <code>SkipList&lt;const char*, KeyComparator&gt;</code>. <ul>
<li>From the skip list, we can see that it only stores keys instead of key-value pairs. </li>
<li>Memtable encodes values into keys and stores the whole bytes. </li>
</ul>
</li>
<li>There are three parts: <code>key, sequence number and type, value</code>. <ul>
<li>The structure of the encoded buffer is as follows:<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">+----------------+-------+----------------+--------------+---------+</span><br><span class="line">|  key_size + 8  |  key  |  SeqNum, type  |  value_size  |  value  |</span><br><span class="line">+----------------+-------+----------------+--------------+---------+</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li>Both the <code>key_size</code> and <code>value_size</code> are encoded by <code>EncodeVarint32</code>. <ul>
<li>Only content containing the most significant byte is saved. They are in a little-endian way with variant length. </li>
<li>Each byte only stores $7$ bits of the <code>uint32_t</code>. The highest bit in a byte is $0$ when this is the last byte for the variant-length int. </li>
</ul>
</li>
<li><code>SeqNum</code> and <code>type</code> are 8 bytes in total, where <code>SeqNum</code> is in higher bits and <code>type</code> is in lower bits. They are encoded in fixed size. </li>
</ol>
<h2 id="How-does-Memtable-decode-data"><a href="#How-does-Memtable-decode-data" class="headerlink" title="How does Memtable decode data?"></a>How does Memtable decode data?</h2><ol>
<li>The target key is encoded without <code>value_size</code> and <code>value</code> to search the target with <code>FindGreaterOrEqual</code>. </li>
<li>To decode the variant length int, read byte-by-byte until a byte with the highest bit of $0$. </li>
<li>If the key does not match or the type is <code>kTypeDeletion</code>, return <code>Status::NotFound</code>. </li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://liyun-zhang.github.io/2024/03/13/OpenSource/TinyKV/Multi-Raft/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LiyunZhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LiyunZhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LiyunZhang">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/03/13/OpenSource/TinyKV/Multi-Raft/" class="post-title-link" itemprop="url">Placement Driver and Multi-Raft</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-03-13 23:26:08" itemprop="dateCreated datePublished" datetime="2024-03-13T23:26:08+08:00">2024-03-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-03-17 11:48:36" itemprop="dateModified" datetime="2024-03-17T11:48:36+08:00">2024-03-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Open-Source-Code/" itemprop="url" rel="index"><span itemprop="name">Open Source Code</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Open-Source-Code/TiKV-TinyKV/" itemprop="url" rel="index"><span itemprop="name">TiKV/TinyKV</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><ul class="markdownIt-TOC">
<li><a href="#placement-driver">Placement Driver</a>
<ul>
<li><a href="#how-does-pd-know-the-information-of-regions">How does PD know the information of regions?</a></li>
<li><a href="#how-does-pd-schedule-placement">How does PD schedule placement?</a></li>
<li><a href="#what-are-the-schedulers">What are the schedulers?</a></li>
</ul>
</li>
<li><a href="#multi-raft">Multi-Raft</a>
<ul>
<li><a href="#how-to-split-regions">How to split regions?</a></li>
<li><a href="#how-to-move-regions">How to move regions?</a></li>
</ul>
</li>
</ul>
</p>
<h1 id="placement-driver"><a class="markdownIt-Anchor" href="#placement-driver"></a> Placement Driver</h1>
<h2 id="how-does-pd-know-the-information-of-regions"><a class="markdownIt-Anchor" href="#how-does-pd-know-the-information-of-regions"></a> How does PD know the information of regions?</h2>
<ol>
<li>The PD needs the necessary information to decide on placement and split. This information is sent to the PD by the heartbeat from the region or the store to the PD.</li>
<li>The store will send a heartbeat to the PD periodically when the onSchedulerStoreHeartbeatTick is triggered by the ticker.
<ul>
<li>This heartbeat mainly tells the PD about the space information, e.g., disk capacity, used size, and available space.</li>
<li>The PD will update its knowledge about the given store according to the heartbeat.</li>
</ul>
</li>
<li>The region will send a heartbeat to the PD when something about the region is changed, e.g., peer joined or left, split.
<ul>
<li>This heartbeat mainly tells the PD about the region information, e.g., region metadata, peer identity, lagged peers, and the approximate size of this region.</li>
<li>The PD will justify the validation of this heartbeat by the RegionEpoch of it. The region information will updated if it is valid.</li>
</ul>
</li>
</ol>
<h2 id="how-does-pd-schedule-placement"><a class="markdownIt-Anchor" href="#how-does-pd-schedule-placement"></a> How does PD schedule placement?</h2>
<ol>
<li>The schedule decisions are made periodically. However, they are not sent to region leaders immediately. The operators are returned when the PD receives a heartbeat from the region leader.</li>
<li>Every PD server has a <code>RaftCluster</code> that stores the information of the entire cluster. It handles the heartbeats sent to PD.</li>
<li>Each <code>RaftCluster</code> has a <code>coordinator</code> to run schedulers in parallel and store generated operators in its <code>schedule.OperatorController</code>.</li>
<li>When a region heartbeat is processed, the <code>RaftCluster</code> would ask for the <code>schedule.OperatorController</code> to <code>Dispatch</code> operators to the region.</li>
<li>These operators are sent to leaders as Raft commands. Similar to commands from clients, they may not be committed.</li>
</ol>
<h2 id="what-are-the-schedulers"><a class="markdownIt-Anchor" href="#what-are-the-schedulers"></a> What are the schedulers?</h2>
<ol>
<li>They all implemented the <code>Scheduler</code> control that provides the <code>Schedule(opt.Cluster) *operator.Operator</code> interface to generate operators.</li>
<li>A new goroutine is created to perform the schedule when a new scheduler is added to the <code>coordinator</code>. If new operators are created, they will be appended to the <code>schedule.OperatorController</code> waiting for the next heartbeat from the target region.</li>
<li>One kind of scheduler is to transfer a leader when the current leader is no longer considered available.</li>
<li>Another scheduler is to move regions between stores to balance the storage usage of each store.</li>
</ol>
<h1 id="multi-raft"><a class="markdownIt-Anchor" href="#multi-raft"></a> Multi-Raft</h1>
<h2 id="how-to-split-regions"><a class="markdownIt-Anchor" href="#how-to-split-regions"></a> How to split regions?</h2>
<ol>
<li>Every peer periodically checks whether their region needs to be split by sending a <code>SplitCheckTask</code> to the <code>splitCheckHandler</code> of its store.
<ul>
<li>The checker will calculate the total size of the key-value pairs in this region. A split is initiated if the size is larger than <code>splitSize</code>.</li>
<li>The checker does not read through Raft. Instead, it directly reads from the DB engine file.</li>
<li>The checker will also notify the peer of the current size of its region it just calculated for the peer to update its information and tell the PD later.</li>
</ul>
</li>
<li>When a split key is generated, the checker will notify the peer to be prepared for splitting.
<ul>
<li>The peer would ask the PD to assign globally unique IDs to identify the new region and peers.</li>
<li>The PD will send the leader an <code>AdminRequest</code> that contains the <code>NewRegionId</code> and <code>NewPeerIds</code> to suggest a split.</li>
</ul>
</li>
<li>If the <code>AdminRequest</code> is committed, all peers of the split region will create a new peer of the new region in their store.
<ul>
<li>Notably, all data in the different regions of the same store are written into the same DB engine file.</li>
<li>There is no need to copy or move files when creating new peers. The only thing need to do is to set the new peers in the correct state.</li>
<li>The information on new peers must be updated in both the store and the PD.</li>
</ul>
</li>
</ol>
<h2 id="how-to-move-regions"><a class="markdownIt-Anchor" href="#how-to-move-regions"></a> How to move regions?</h2>
<ol>
<li>When we split the regions, no data is deleted from the store, which seems useless. However, splitting regions allows us to have finer-grained control. We can move regions to new stores later.</li>
<li>A move consists of adding a new peer and removing an existing peer.
<ul>
<li>When adding a new peer, it is in a lagged state. The leader will send a snapshot to bring it up to date.</li>
<li>When removing an existing peer, the data of its region will be removed from the store engine file.</li>
</ul>
</li>
<li>Similar to split, peer changing needs to sync with the store and the PD.</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://liyun-zhang.github.io/2024/03/12/OpenSource/TinyKV/MVCC-Transaction/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LiyunZhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LiyunZhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LiyunZhang">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/03/12/OpenSource/TinyKV/MVCC-Transaction/" class="post-title-link" itemprop="url">MVCC Transaction</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-03-12 15:44:46" itemprop="dateCreated datePublished" datetime="2024-03-12T15:44:46+08:00">2024-03-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-03-17 11:58:37" itemprop="dateModified" datetime="2024-03-17T11:58:37+08:00">2024-03-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Open-Source-Code/" itemprop="url" rel="index"><span itemprop="name">Open Source Code</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Open-Source-Code/TiKV-TinyKV/" itemprop="url" rel="index"><span itemprop="name">TiKV/TinyKV</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><ul class="markdownIt-TOC">
<li><a href="#how-does-the-mvcc-layer-record-operations">How does the MVCC layer record operations?</a></li>
<li><a href="#how-do-clients-manage-transactions">How do clients manage transactions?</a></li>
<li><a href="#how-to-perform-get-prewrite-and-scan">How to perform Get, Prewrite, and Scan?</a></li>
<li><a href="#how-to-perform-commit-and-rollback">How to perform commit and rollback?</a></li>
</ul>
</p>
<img src="/imgs/TiKV/mvcc.png">
<h1 id="how-does-the-mvcc-layer-record-operations"><a class="markdownIt-Anchor" href="#how-does-the-mvcc-layer-record-operations"></a> How does the MVCC layer record operations?</h1>
<ol>
<li>There are three column families: <code>default</code> to hold user values, <code>lock</code> to store locks and <code>write</code> to record changes.
<ul>
<li>The <code>lock</code> CF is accessed using the user key; it stores a serialized <code>Lock</code> data structure.</li>
<li>The <code>default</code> CF is accessed using the user key and the start timestamp of the transaction in which it was written; it stores the user value only.</li>
<li>The <code>write</code> CF is accessed using the user key and the commit timestamp of the transaction where it was written; it stores a <code>write</code> data structure.</li>
</ul>
</li>
<li>The key idea is that <code>default</code> CF stores all the written key-value pairs, including those uncommitted ones.</li>
<li>Whether a key-value pair is committed is determined by whether a record in the <code>write</code> CF contains the <code>StartTS</code> of the <code>default</code> CF.
<ul>
<li>All readings are done by first iterating over the <code>write</code> CF to find the visible entry according to the commit timestamps integrated into the key of <code>write</code> CF.</li>
<li>We want the <code>write</code> CF to be sorted by the time from the most recent to the earliest and grouped by keys. Hence, keys are encoded so that the ascending order of encoded keys is ordered first by user key (ascending), then by timestamp (descending).</li>
</ul>
</li>
</ol>
<h1 id="how-do-clients-manage-transactions"><a class="markdownIt-Anchor" href="#how-do-clients-manage-transactions"></a> How do clients manage transactions?</h1>
<ol>
<li>Each transaction is represented by a unique start timestamp provided by clients. All APIs provided to clients are executed through a <code>MvccTxn</code> structure to perform the MVCC operations.</li>
<li>Clients can issue as much <code>KvGet</code>, <code>KvPreWrite</code>, or <code>KvScan</code> as they want during a transaction.</li>
<li>After the operations they want have been executed, the transaction can be committed by <code>KvCommit</code>. If the commit fails, it is rollbacked by <code>KvBatchRollback</code>.</li>
<li>Clients can also use <code>KvCheckTxnStatus</code> to check the status of their transactions. If the time-to-live of any lock is expired, the transaction must be rollbacked.</li>
</ol>
<h1 id="how-to-perform-get-prewrite-and-scan"><a class="markdownIt-Anchor" href="#how-to-perform-get-prewrite-and-scan"></a> How to perform Get, Prewrite, and Scan?</h1>
<ol>
<li>In a <code>Get(key)</code>,
<ul>
<li>If the <code>key</code> is locked by an older transaction, we should not read it now because the modification of the older transaction may be visible in this current transaction.</li>
<li>If the <code>key</code> is locked by a younger transaction, it does not matter because the modification is not visible to us.</li>
<li>The MVCC layer gets values by checking the <code>write</code> CF to find the most recently committed write. Then, access the value of the key with the <code>StartTS</code> information provided by the write record from the <code>default</code> CF.</li>
</ul>
</li>
<li>In a <code>PreWrite(key, value)</code>,
<ul>
<li>This transaction must hold an exclusive lock, i.e., it must wait if either an older or a younger transaction held the lock.</li>
<li>Also, the most recent committed write must be before the start time of this transaction, i.e., there is no write committed to this key after this transaction is initiated.</li>
<li>During the <code>PreWrite</code>, value modifications are written into the <code>default</code> CF in the MVCC layer. However, due to missing records in the <code>write</code> CF, they are not visible in the <code>Get</code> operations.</li>
</ul>
</li>
<li>The <code>Scan</code> is similar to <code>Get</code>. It is done through a <code>Scanner</code> that uses an <code>engine_util.DBIterator</code> to iterator over the <code>write</code> CF.</li>
</ol>
<h1 id="how-to-perform-commit-and-rollback"><a class="markdownIt-Anchor" href="#how-to-perform-commit-and-rollback"></a> How to perform commit and rollback?</h1>
<ol>
<li>In a <code>KvCommit</code>,
<ul>
<li>Each modification must be assured that this transaction holds the exclusive lock.</li>
<li>Notably, this transaction may have already been committed or rollbacked due to the unreliable network.</li>
<li>During the commit, the modification records of <code>WriteKindPut</code> are written into the <code>write</code> CF so that the latter transactions can see the results.</li>
<li>Finally, all locks held by this transaction will be released when the commit succeeds.</li>
</ul>
</li>
<li>If the commit fails or the clients detect that the transaction is out of TTL for the lock of the primary key, <code>KvBatchRollback</code> will be issued.
<ul>
<li>The records of the kind <code>WriteKindRollback</code> of the modified keys are written into the <code>write</code> CF and the value of the <code>default</code> CF is required to be deleted.</li>
<li>Similar to <code>KvCommit</code>, there is a possibility that this transaction is already committed or rollbacked.</li>
</ul>
</li>
<li>When the client encounters a lock failure, it will issue a <code>KvResolveLock</code> to commit or rollback.
<ul>
<li><code>Lock</code> CF is iterated to find all keys locked by this transaction. Those are all keys to be resolved and will either be committed or rollbacked.</li>
</ul>
</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://liyun-zhang.github.io/2024/02/22/Courses/15445/00-Trade-offs-summary/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LiyunZhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LiyunZhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LiyunZhang">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/02/22/Courses/15445/00-Trade-offs-summary/" class="post-title-link" itemprop="url">00. Trade-offs summary</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-02-22 18:39:09" itemprop="dateCreated datePublished" datetime="2024-02-22T18:39:09+08:00">2024-02-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-03-15 15:07:34" itemprop="dateModified" datetime="2024-03-15T15:07:34+08:00">2024-03-15</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p></p>
<ol>
<li><strong>Database</strong> v.s. <strong>CSV files</strong>:
<ul>
<li>Database provided a better encapsulation representation that provides ensurence of data integrety, necessary operations and durability. Only SQL is exposed to the users.</li>
<li>CSV files requires used to write all operations, e.g. searching and writing, by themselves. It is enough for small amount of data.</li>
<li>Database can be easily used to manage complex or enormously large data which can be difficult for CSV files.</li>
</ul>
</li>
<li><strong>Disk-oriented DBMS</strong> v.s. <strong>OS memory mapping</strong>:
<ul>
<li>The basic idea is that DBMS always knows better than OS.</li>
<li>Transaction safety: OS can flush dirty pages at any time causing dirty data corrupt database.</li>
<li>Error handling: DBMS may isolate the error and handle it only in the storage layer.</li>
</ul>
</li>
<li></li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://liyun-zhang.github.io/2023/12/09/OpenSource/TinyKV/TinyKV-vs-Spanner/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LiyunZhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LiyunZhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LiyunZhang">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/12/09/OpenSource/TinyKV/TinyKV-vs-Spanner/" class="post-title-link" itemprop="url">TinyKV v.s. Spanner</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-12-09 17:38:00" itemprop="dateCreated datePublished" datetime="2023-12-09T17:38:00+08:00">2023-12-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-03-17 12:29:58" itemprop="dateModified" datetime="2024-03-17T12:29:58+08:00">2024-03-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Open-Source-Code/" itemprop="url" rel="index"><span itemprop="name">Open Source Code</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Open-Source-Code/TiKV-TinyKV/" itemprop="url" rel="index"><span itemprop="name">TiKV/TinyKV</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><ul class="markdownIt-TOC">
<li><a href="#organization">Organization</a>
<ul>
<li><a href="#what-is-the-structure-of-tinykv">What is the structure of TinyKV?</a></li>
<li><a href="#how-to-execute-a-command-from-a-client">How to execute a command from a client?</a></li>
</ul>
</li>
<li><a href="#time-representation">Time Representation</a>
<ul>
<li><a href="#how-does-raft-represent-time">How does Raft represent time?</a></li>
<li><a href="#what-events-are-scheduled-in-peers">What events are scheduled in peers?</a></li>
<li><a href="#how-do-transactions-represent-timestamps">How do transactions represent timestamps?</a></li>
</ul>
</li>
</ul>
</p>
<h1 id="organization"><a class="markdownIt-Anchor" href="#organization"></a> Organization</h1>
<h2 id="what-is-the-structure-of-tinykv"><a class="markdownIt-Anchor" href="#what-is-the-structure-of-tinykv"></a> What is the structure of TinyKV?</h2>
<ol>
<li>Each machine has a <code>Server</code> with a certain object that implements a <code>Storage</code> interface to store Key/Value pairs.
<ul>
<li>The <code>Storage</code> interface only requires the provision of <code>Read</code> and <code>Write</code> APIs. The way they implement these methods decided this <code>Server</code> can provide the service.</li>
<li>Suppose that <code>Storage</code> is simply using <code>badger.DB</code> that directly writes data, the <code>Server</code> only provides a standalone database service.</li>
<li>If that <code>Storage</code> is <code>RaftStorage</code> that completes these methods by interacting with Raft groups, it can provide a distributed fault-tolerance database.</li>
</ul>
</li>
<li>Inside <code>RaftStorage</code>, there is a <code>RaftStore</code> that controls all <code>peer</code>s. Each peer is a peer in a raft group.
<ul>
<li>When multi-raft is enabled, several peers in the same <code>RaftStore</code> may manage different shards.</li>
</ul>
</li>
<li>Overall, a <code>RaftStorage</code> is responsible for an entire key space. All peers in the same key space, though may be in charge of incontinuous shards, must communicate with clients through this <code>RaftStorage</code>.
<ul>
<li>If another key space exists, e.g., another database, a separate <code>RaftStorage</code> must be created.</li>
</ul>
</li>
</ol>
<h2 id="how-to-execute-a-command-from-a-client"><a class="markdownIt-Anchor" href="#how-to-execute-a-command-from-a-client"></a> How to execute a command from a client?</h2>
<ol>
<li>The following is a diagram of the execution flow.</li>
<li>Clients give commands through the APIs provided by the <code>Server</code>. Those APIs will execute <code>Read</code> or <code>Write</code> provided by <code>Storage</code>.</li>
<li><code>RaftStorage</code> will send a message of <code>raft_cmdpb.Request</code> to <code>RaftStore</code> through <code>RaftRouter</code>. The request contains <code>regionId</code> and <code>peerId</code> information for the router to locate the destination.</li>
<li>The <code>RaftRouter</code> will send the request to the <code>RaftWorker</code> of <code>RaftStore</code>. When the <code>RaftWorker</code> receives messages, it will initiate a <code>peerMsgHandler</code> for each message individually.
<ul>
<li><code>RaftWorker</code> will start the next <code>peerMsgHandler</code> until the last one is finished instead of creating goroutines to process them in parallel.</li>
<li>Raft peers will only receive commands and messages from <code>RaftWorker</code>. Hence, only one Raft thread in the entire <code>RaftStore</code> processes messages rather than handling them in parallel.</li>
</ul>
</li>
<li><code>peerMsgHandle</code> will ask <code>RaftGroup</code> to handle the message by <code>Step</code>.</li>
<li>After all read messages are handled, all peers that have received messages are asked to handle <code>raft.Ready</code> one be one. Applied commands will be executed; persisted states will be written into <code>PeerStorage</code>.</li>
</ol>
<img src="/imgs/TiKV/exec.png">
<h1 id="time-representation"><a class="markdownIt-Anchor" href="#time-representation"></a> Time Representation</h1>
<h2 id="how-does-raft-represent-time"><a class="markdownIt-Anchor" href="#how-does-raft-represent-time"></a> How does Raft represent time?</h2>
<ol>
<li>Instead of using a TrueTime API to represent time like Spanner, TinyKV uses a logical time to control workflows.</li>
<li></li>
<li>All peers in the same store should register on <code>tickDriver</code> so that it will know which peers it needs to send messages to when events are triggered.</li>
<li>Each store has a store ticker, while each peer has a peer ticker. The store ticker is the driver of the entire store; it represents the logical time of this machine. The peer tickers are simply for scheduling peer events.</li>
<li>When the store ticker received from <code>time.Tick(baseTickInterval)</code>,
<ul>
<li>A <code>MsgTypeTick</code> will be sent to all known peers. Each peer will check whether their schedule is up.</li>
<li>Then, the <code>tick</code> is increased by <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span> and <code>tickDriver</code> checks the storeâ€™s schedule. If a schedule is up, the driver will send a message of <code>MsgTypeStoreTick</code> to the store.</li>
</ul>
</li>
</ol>
<h2 id="what-events-are-scheduled-in-peers"><a class="markdownIt-Anchor" href="#what-events-are-scheduled-in-peers"></a> What events are scheduled in peers?</h2>
<ol>
<li>When the <code>tickDrive</code> of <code>RaftStore</code> sends a <code>MsgTypeTick</code> to <code>RaftWorker</code>, the <code>peerMsgHandler</code> will check several schedules.</li>
<li>When <code>PeerTickRaft</code> is up, the Raft node ticker is moved forward.</li>
<li>When <code>PeerTickRaftLogGC</code> is up, and existing applied entries are more than the limit, it will propose a Raft command with an administrator request to compact the Raft log to the applied index when this request is made.
<ul>
<li>The compaction is only executed when this request is committed.</li>
<li>The Raft node and peer storage modify their state according to the compact index and term. Then, a garbage collection task is sent to the <code>raftLogGCWorker</code>, which will remove compacted entries from <code>RaftDB</code>.</li>
</ul>
</li>
<li>When <code>PeerTickSchedulerHeartbeat</code> is up, a <code>SchedulerRegionHeartbeatTask</code> is sent to <code>schedulerWorker</code>.</li>
</ol>
<h2 id="how-do-transactions-represent-timestamps"><a class="markdownIt-Anchor" href="#how-do-transactions-represent-timestamps"></a> How do transactions represent timestamps?</h2>
<ol>
<li>The placement driver is also responsible for assigning client timestamps for transaction events.
<ul>
<li>The placement driver is another Raft group powered by etcd. Only the leader can assign timestamps. When the physical timestamp is changed, the leader will save a timestamp seconds later than the new one.</li>
<li>When a new leader is elected, it will read from the etcd files to sync its timestamp with the last saved timestamp. The new leader needs to wait until the time of the read timestamp comes before it can assign any new timestamp.</li>
<li>We can induct that the timestamp assigned by the PD group is unique and monotonously increasing. Therefore, the TiKV did not take the TrueTime API in Spanner.</li>
</ul>
</li>
<li>A transaction timestamp is an <code>uint64</code> that consists of two parts:
<ul>
<li>The high bits are the physical time with units of milliseconds. The lower bits are the logical time to distinguish the events in the same millisecond.</li>
<li>It is reset to zero every time the physical time is updated to prevent logical time from becoming too large.</li>
</ul>
</li>
<li>The server will check whether need to update the physical timestamp every <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>50</mn><mtext>Â </mtext><mi>m</mi><mi>s</mi></mrow><annotation encoding="application/x-tex">50\ ms</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">5</span><span class="mord">0</span><span class="mspace">Â </span><span class="mord mathnormal">m</span><span class="mord mathnormal">s</span></span></span></span>, instead of every millisecond.
<ul>
<li>The physical timestamp will sync with the current time when it has not been updated for over <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>150</mn><mtext>Â </mtext><mi>m</mi><mi>s</mi></mrow><annotation encoding="application/x-tex">150\ ms</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord">5</span><span class="mord">0</span><span class="mspace">Â </span><span class="mord mathnormal">m</span><span class="mord mathnormal">s</span></span></span></span>.</li>
<li>When used over half of the logical timestamp, the physical timestamp will add <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mtext>Â </mtext><mi>m</mi><mi>s</mi></mrow><annotation encoding="application/x-tex">1\ ms</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mspace">Â </span><span class="mord mathnormal">m</span><span class="mord mathnormal">s</span></span></span></span> and reset the logical timestamp.</li>
</ul>
</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://liyun-zhang.github.io/2023/11/24/OpenSource/TinyKV/Storage-Write-and-Read/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LiyunZhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LiyunZhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LiyunZhang">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/11/24/OpenSource/TinyKV/Storage-Write-and-Read/" class="post-title-link" itemprop="url">Storage: Write and Read</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-11-24 11:18:35" itemprop="dateCreated datePublished" datetime="2023-11-24T11:18:35+08:00">2023-11-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-03-17 12:21:20" itemprop="dateModified" datetime="2024-03-17T12:21:20+08:00">2024-03-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Open-Source-Code/" itemprop="url" rel="index"><span itemprop="name">Open Source Code</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Open-Source-Code/TiKV-TinyKV/" itemprop="url" rel="index"><span itemprop="name">TiKV/TinyKV</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><ul class="markdownIt-TOC">
<li><a href="#key-value-storage-storagestorage">Key-Value Storage (storage.Storage)</a>
<ul>
<li><a href="#interface">Interface</a></li>
<li><a href="#simple-example-project1-standalonekv">Simple example: Project1 StandaloneKV</a></li>
<li><a href="#raftstorage">RaftStorage</a></li>
</ul>
</li>
<li><a href="#raft-storage-raftstorage">Raft storage (raft.Storage)</a>
<ul>
<li><a href="#interface-2">Interface</a></li>
<li><a href="#simple-example-memstorage">Simple example: MemStorage</a></li>
<li><a href="#project-2b-peerstorage">Project 2B: PeerStorage</a>
<ul>
<li><a href="#basic-duties">Basic duties</a></li>
<li><a href="#snapshot-generation-and-application">Snapshot generation and application</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</p>
<h1 id="key-value-storage-storagestorage"><a class="markdownIt-Anchor" href="#key-value-storage-storagestorage"></a> Key-Value Storage (storage.Storage)</h1>
<ol>
<li>Each <code>Server</code> uses the KV storage interfaces <code>Write</code> and <code>Reader</code> to implement RPC interfaces like <code>RawGet</code>, <code>RawPut</code>, <code>RawDelete</code>, and <code>RawScan</code> (in <code>kv/storage/server/raw_api.go</code>) provided to clients for corresponding functions.</li>
<li>This higher-level abstract storage interface hides lower-level storage implementation from the servers and clients. How do we implement the interface changes in different scenarios?
<ul>
<li>In <code>kv/storage/mem_storage.go</code>, it is implemented as an in-memory standalone storage.</li>
<li>In <code>kv/storage/standalone_storage/standalone_storage.go</code>, it is implemented as BadgerDB.</li>
<li>In <code>kv/storage/raft_storage/raft_server.go</code>, it is implemented as a distributed storage based on Raft.</li>
</ul>
</li>
</ol>
<h2 id="interface"><a class="markdownIt-Anchor" href="#interface"></a> Interface</h2>
<ol>
<li>
<p>The storage interface must implement <code>Write</code> and <code>Reader</code>.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kv/storage/storage.go</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Storage <span class="keyword">interface</span> &#123;</span><br><span class="line">	Write(ctx *kvrpcpb.Context, batch []Modify) <span class="type">error</span></span><br><span class="line">	Reader(ctx *kvrpcpb.Context) (StorageReader, <span class="type">error</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><code>Write</code> receives a batch of modification requests. Each request can be a put request with a key-value pair or a delete request with only a key field.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kv/storage/modify.go</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Modify <span class="keyword">struct</span> &#123;</span><br><span class="line">	Data <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Put <span class="keyword">struct</span> &#123;</span><br><span class="line">	Key   []<span class="type">byte</span></span><br><span class="line">	Value []<span class="type">byte</span></span><br><span class="line">	Cf    <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Delete <span class="keyword">struct</span> &#123;</span><br><span class="line">	Key []<span class="type">byte</span></span><br><span class="line">	Cf  <span class="type">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>The <code>Reader</code> returns an API to get the value of a certain key or iterate over a column family.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kv/storage/storage.go</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> StorageReader <span class="keyword">interface</span> &#123;</span><br><span class="line">	<span class="comment">// When the key doesn&#x27;t exist, return nil for the value</span></span><br><span class="line">	GetCF(cf <span class="type">string</span>, key []<span class="type">byte</span>) ([]<span class="type">byte</span>, <span class="type">error</span>)</span><br><span class="line">	IterCF(cf <span class="type">string</span>) engine_util.DBIterator</span><br><span class="line">	Close()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>The <code>DBIterator</code> is another interface that provides APIs to iterate over the database.</p>
<ul>
<li><code>Item()</code> returns a pointer to the current key-value pair.</li>
<li><code>Valid()</code> returns false when iteration is done.</li>
<li><code>Next()</code> would advance the iterator by one.</li>
<li><code>Seek([]byte)</code> would seek the provided key if present. If absent, it would seek the next smallest key greater than provided.</li>
<li><code>Close()</code> would close the iterator.</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kv/util/engine_util/cf_iterator.go</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> DBIterator <span class="keyword">interface</span> &#123;</span><br><span class="line">	Item() DBItem</span><br><span class="line">	Valid() <span class="type">bool</span></span><br><span class="line">	Next()</span><br><span class="line">	Seek([]<span class="type">byte</span>)</span><br><span class="line">	Close()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>The access to <code>DBIterm</code> is an interface that provides methods to get or copy the keys and values.</p>
<ul>
<li><code>KeyCopy(dst []byte) byte</code> and <code>ValueCopy(dst []byte) ([byte, error])</code> returns a copy of the key or value of the item, writing it to the <code>dst</code> slice. If <code>nil</code> is passed, or the capacity of <code>dst</code> isnâ€™t sufficient, a new slice would be allocated and returned.</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> DBItem <span class="keyword">interface</span> &#123;</span><br><span class="line">	Key() []<span class="type">byte</span></span><br><span class="line">	KeyCopy(dst []<span class="type">byte</span>) []<span class="type">byte</span></span><br><span class="line">	Value() ([]<span class="type">byte</span>, <span class="type">error</span>)</span><br><span class="line">	ValueSize() <span class="type">int</span></span><br><span class="line">	ValueCopy(dst []<span class="type">byte</span>) ([]<span class="type">byte</span>, <span class="type">error</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>A <code>BadgerIterator</code> and <code>CFItem</code> is implemented that supports <code>DBIterator</code> and <code>DBItem</code>.</p>
<ul>
<li><code>func NewCFIterator(cf string, txn *badger.Txn) *BadgerIterator</code> can be used to create an iterator.</li>
<li>They are wrappers of <code>badger.Iterator</code> and <code>badger.Item</code> to support column family in <code>Valid</code> and <code>Seek</code> easier.</li>
<li>The column family prefix is stored inside and will be checked in <code>BadgerIterator.Valid</code> or removed in <code>CFItem.Key</code> and <code>CFItem.KeyCopy</code>.</li>
</ul>
</li>
</ol>
<h2 id="simple-example-project1-standalonekv"><a class="markdownIt-Anchor" href="#simple-example-project1-standalonekv"></a> Simple example: Project1 StandaloneKV</h2>
<ol>
<li>This project will help us learn how to write and read data with <code>BadgerDB</code> and how these interfaces are used.</li>
<li>Both writing and reading are handled through a badger transaction.
<ul>
<li>The BadgerDB transaction can use <code>Set</code> and <code>Delete</code> to process write requests, and it will be committed after all write requests are finished.</li>
<li>The <code>BadgerIterator</code> uses the <code>NewIterator</code> method of the transaction to create a <code>badger.Iterator</code>.</li>
<li>When the iterator is no longer needed, <code>badger.Iterator</code> will be closed and the transaction discarded until the reader is finished.</li>
</ul>
</li>
</ol>
<h2 id="raftstorage"><a class="markdownIt-Anchor" href="#raftstorage"></a> RaftStorage</h2>
<p>The code is in <code>kv/storage/raft_storage/raft_server.go</code>.</p>
<ol>
<li>In a multi-Raft scenario, a <code>Store</code> stands for an instance of tinykv-server, a <code>Peer</code> stands for a Raft node running on a Store, while a <code>Region</code> is a collection of Peers, also called a Raft group.</li>
<li>When starting a <code>RaftStorage</code>, it first starts a <code>rs.resolveWorker</code> and a <code>rs.snapWorker</code>. Then, a <code>Node</code> is started.
<ul>
<li>After a series of self-examinations, <code>Node</code> will start the core <code>Raftstore</code>.</li>
<li><code>Raftstore</code> first loads peers in this store. It scans the db engine, loads all regions and their peers from it, and registers them.</li>
<li>Then, it begins to start workers to get jobs done.
<ul>
<li>A <code>raftWorker</code> is used to execute Raft commands. Messages for all peers are received here, and it needs to transmit them to their destination.</li>
<li>A <code>storeWorker</code> is used to handle store commands.
<ul>
<li>One kind is <code>MsgTypeStoreStart</code>, which will be sent immediately after this worker is running.</li>
<li>Another kind is <code>MsgTypeStoreTick</code> to control the <code>tick()</code> on all peers in the same store. Another <code>tikerDriver</code> is used to generate this command.</li>
<li><code>MsgTypeStoreRaftMessage</code> can redirect a misplaced message.</li>
</ul>
</li>
<li>Other background threads, e.g., garbage collection or scheduler, are started as workers with different handlers.</li>
</ul>
</li>
</ul>
</li>
<li>A <code>RaftstoreRouter</code> is created together with <code>Raftstore</code>.
<ul>
<li>It has a <code>peerSender chan message.Msg</code> that will be used to communicate with <code>raftWorker</code> and another <code>storeSender chan&lt;- message.Msg</code> that will be read by the <code>storeWorker</code>.</li>
<li>It provides <code>Send</code>, <code>SendRaftMessage</code>, and <code>SendRaftCommand</code> for communication inside this store.</li>
</ul>
</li>
<li><code>Write</code> and <code>Reader</code> will generate a corresponding request of type <code>raft_cmdpb.RaftCmdRequest</code>.
<ul>
<li>The request is a proposal to the Raft group, and the result will only be returned when its request entry is applied.</li>
<li>It is sent through a <code>router</code>, i.e., ignoring <code>RawXXX</code>, <code>Write</code> and <code>Reader</code> receive commands from other servers or clients and forward them to peers.</li>
<li>Then, the command will be wrapped with a <code>Callback</code> that can be used to track the execution process of this command. When the <code>Callback</code> receives the done signal, it can return the response to the <code>Write</code> or <code>Reader</code>.</li>
</ul>
</li>
</ol>
<h1 id="raft-storage-raftstorage"><a class="markdownIt-Anchor" href="#raft-storage-raftstorage"></a> Raft storage (raft.Storage)</h1>
<p>This is the storage interface for Raft nodes to persist in their internal states. Unlike the KV storage interface above, this is only used when implementing a Raft node.</p>
<h2 id="interface-2"><a class="markdownIt-Anchor" href="#interface-2"></a> Interface</h2>
<ol>
<li>
<p>The interfaces required are all read-only functions. The writings are performed by upper applications.</p>
</li>
<li>
<p><code>InitialState()</code> returns the saved <code>HardState</code> and <code>ConfState</code> information.</p>
</li>
<li>
<p><code>Entries(lo, hi uint64)</code> returns a slice of log entries in the range <code>[lo,hi)</code>.</p>
<ul>
<li><code>MaxSize</code> limits the total size of the log entries returned, but it returns at least one entry, if any.</li>
</ul>
</li>
<li>
<p><code>Term(i uint64)</code> returns the term of entry <code>i</code>, which must be in the range <code>[FirstIndex()-1, LastIndex()]</code>.</p>
<ul>
<li>The term of the entry before <code>FirstIndex</code> is retained for matching purposes, even though the rest of that entry may not be available.</li>
</ul>
</li>
<li>
<p><code>LastIndex()</code> returns the index of the last entry in the log.</p>
</li>
<li>
<p><code>FirstIndex()</code> returns the index of the first log entry that is possibly available via <code>Entries</code> (older entries have been incorporated into the latest Snapshot; if storage only contains the dummy entry, the first log entry is unavailable).</p>
</li>
<li>
<p><code>Snapshot()</code> returns the most recent snapshot.</p>
<ul>
<li>If the snapshot is temporarily unavailable, it should return <code>ErrSnapshotTemporarilyUnavailable</code>, so the raft state machine knows Storage needs some time to prepare the snapshot and call Snapshot later.</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Storage <span class="keyword">interface</span> &#123;</span><br><span class="line">	InitialState() (pb.HardState, pb.ConfState, <span class="type">error</span>)</span><br><span class="line">	Entries(lo, hi <span class="type">uint64</span>) ([]pb.Entry, <span class="type">error</span>)</span><br><span class="line">	Term(i <span class="type">uint64</span>) (<span class="type">uint64</span>, <span class="type">error</span>)</span><br><span class="line">	LastIndex() (<span class="type">uint64</span>, <span class="type">error</span>)</span><br><span class="line">	FirstIndex() (<span class="type">uint64</span>, <span class="type">error</span>)</span><br><span class="line">	Snapshot() (pb.Snapshot, <span class="type">error</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="simple-example-memstorage"><a class="markdownIt-Anchor" href="#simple-example-memstorage"></a> Simple example: MemStorage</h2>
<ol>
<li>This is defined in <code>raft/storage.go</code>. Besides those read-only interfaces, <code>MemStorage</code> provides write methods for upper applications to change states.</li>
<li><code>SetHardState(st pb.HardState) error</code> changes the current <code>HardState</code> to the given one.</li>
<li><code>ApplySnapshot(snap pb.Snapshot) error</code> overwrites the contents of this Storage object with those of the given snapshot.
<ul>
<li>In this case, it overwrites the current snapshot and truncates <code>ents</code> with only a dummy entry.</li>
</ul>
</li>
<li><code>CreateSnapshot(i uint64, cs *pb.ConfState, data []byte) (pb.Snapshot, error)</code> makes a snapshot which can be used to reconstruct the state.
<ul>
<li>If any configuration changes have been made since the last compaction, the result of the last <code>ApplyConfChange</code> must be passed in.</li>
<li>The state machineâ€™s data is acquired by the upper application, not this method.</li>
</ul>
</li>
<li><code>Compact(compactIndex uint64) error</code> discards all log entries prior to <code>compactIndex</code>.
<ul>
<li>The application is responsible for not attempting to compact an index greater than <code>raftLog.applied</code>.</li>
</ul>
</li>
<li><code>Append(entries []pb.Entry) error</code> append the new entries to storage, i.e., persist Raft entries when this storage is writing to disk.</li>
</ol>
<h2 id="project-2b-peerstorage"><a class="markdownIt-Anchor" href="#project-2b-peerstorage"></a> Project 2B: PeerStorage</h2>
<h3 id="basic-duties"><a class="markdownIt-Anchor" href="#basic-duties"></a> Basic duties</h3>
<ol>
<li>A peer storage must maintain the persistence of both Key-Value pairs in this peer and its Raft logs.
<ul>
<li>The entries of Raft logs are stored with the key <code>LocalPrefix_RegionRaftPrefix_regionID_RaftLogSuffix_entry index</code>.</li>
</ul>
</li>
<li>After acquiring a value from <code>*badger.DB</code>, it can be transferred to the correct type with the <code>Unmarshal</code> provided by the <code>struct</code> generated from protobuf.</li>
<li><code>SaveReadyState</code> will be used by <code>peerMsgHandler.HandleRaftReady</code> to persist according to <code>Ready</code>. It needs to install a snapshot and update persisted new Raft log entries, including deleting the entries the new leader removed.</li>
<li>The Raft commands that manipulate key-value storages are executed through the engines provided by <code>PeerStorage</code>.</li>
</ol>
<h3 id="snapshot-generation-and-application"><a class="markdownIt-Anchor" href="#snapshot-generation-and-application"></a> Snapshot generation and application</h3>
<ol>
<li>
<p>The snapshot generation is an asynchronous process.</p>
<ul>
<li>
<p>When the Raft node requests a snapshot, <code>PeerStorage</code> sends a message of <code>RegionTaskGen</code> to <code>regionWorker</code> and sets its <code>snapState</code> to <code>SnapState_Generating</code> and the channel to receive a snapshot.</p>
</li>
<li>
<p>The snapshots are sent by a <code>snapRunner</code>, different from the ordinary entries. The snapshot will be sliced into chunks of size <code>snapChunkLen</code> and sent to the same <code>grpc.ClientStream</code>.</p>
</li>
</ul>
</li>
<li>
<p>The receiver will collect all data from the <code>grpc.ClientStream</code> and write them into the same snapshot file.</p>
<ul>
<li>The snapshot is first sent to Raft to check its validation. If valid, <code>PeerStorage</code> will apply it in the <code>HandleRaftReady</code> of the <code>peerMsgHandler</code>.</li>
<li>The <code>PeerStorage</code> sends a <code>RegionTaskApply</code> to <code>regionWorker</code>. The worker will clean up the range of this region and directly ingest the content of the snapshot file into the DB with <code>IngestExternalFiles</code>.</li>
</ul>
</li>
</ol>
<img src="/imgs/TiKV/Snapshot.png">

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://liyun-zhang.github.io/2023/10/30/OpenSource/BusTub/BusTub-Overview/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LiyunZhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LiyunZhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LiyunZhang">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/10/30/OpenSource/BusTub/BusTub-Overview/" class="post-title-link" itemprop="url">BusTub Overview</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-10-30 20:04:58" itemprop="dateCreated datePublished" datetime="2023-10-30T20:04:58+08:00">2023-10-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-03-18 18:05:26" itemprop="dateModified" datetime="2024-03-18T18:05:26+08:00">2024-03-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Open-Source-Code/" itemprop="url" rel="index"><span itemprop="name">Open Source Code</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Open-Source-Code/BusTub/" itemprop="url" rel="index"><span itemprop="name">BusTub</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><ul class="markdownIt-TOC">
<li><a href="#shell-execution">Shell Execution</a></li>
</ul>
</p>
<h1 id="shell-execution"><a class="markdownIt-Anchor" href="#shell-execution"></a> Shell Execution</h1>
<ol>
<li>The shell (in the <a target="_blank" rel="noopener" href="https://github.com/cmu-db/bustub/blob/master/tools/shell/shell.cpp">shell.cpp</a>) uses <code>linenoise</code> to read input lines until a line ending with <code>;</code> or beginning with <code>\</code>.
<ul>
<li><code>;</code> means the end of a query while <code>\</code> leads an internal meta-command.</li>
<li>The backbone of the DBMS is <code>bustub::BustubInstance</code> (in <a target="_blank" rel="noopener" href="https://github.com/cmu-db/bustub/blob/master/src/common/bustub_instance.cpp">bustub_instance.cpp</a>). It is initialized at the beginning of the shell.</li>
<li>After reading the complete query, execute it using <code>BustubInstance.ExecuteSql</code>. The result is writen in <code>bustub::FortTableWriter</code>.</li>
</ul>
</li>
<li>In <code>BustubInstance.ExecuteSqlTxn</code>:
<ul>
<li>First, determine whether this is an internal meta-command. If so, only execute the corresponding command and exit.</li>
<li>If this is a query, use <strong><code>bustub::Binder</code></strong> (in <a target="_blank" rel="noopener" href="https://github.com/cmu-db/bustub/blob/master/src/binder/binder.cpp#L45">binder.cpp</a>) to parse the query into an AST. Handle the output format according to the statement type using <code>HandlexxxStatement</code>.</li>
<li>Then <strong><code>bustub::Planner</code></strong> will plan the query execution according to the generated AST. And <strong><code>bustub::Optimizer</code></strong> will optimize the plan tree with certain rules.</li>
<li>Then, the plan will be executed by <strong><code>ExecutionEngine.Execute</code></strong> (in <a target="_blank" rel="noopener" href="https://github.com/cmu-db/bustub/blob/master/src/include/execution/execution_engine.h#L54">execution_engine.h</a>).</li>
<li>Finally, the result will be written in the shell with a writer.</li>
</ul>
</li>
<li>To provide easier format control, the <code>bustub::ResultWriter</code> provides interfaces for standard output.
<ul>
<li><code>BeginHeader</code>, <code>EndHeader</code>, <code>BeginRow</code>, <code>EndRow</code>, and <code>BeginTable</code>, <code>EndTable</code> to output pre-defined messages.</li>
<li><code>WriteCell</code> and <code>WriteHeaderCell</code> are used to output data and pre-defined separators.</li>
<li>Its sub-classes need to override these methods to perform as they want.
<ul>
<li><code>NoopWriter</code> does nothing in all these methods.</li>
<li><code>SimpleStreamWriter</code> will output simple, plain text.</li>
<li><code>HtmlWriter</code> will output the results in HTML code that can be shown in the browser.</li>
<li><code>FortTableWriter</code> uses <code>fort</code> to output table.</li>
</ul>
</li>
</ul>
</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/about/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/about/page/7/">7</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/about/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">LiyunZhang</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" rel="noopener" target="_blank">NexT.Mist</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>







  




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.7/katex.min.css" integrity="sha256-hLTCMFlKxdNgPXyWlSSxYN0ykJmxxq9Yt3MNfdRGWeA=" crossorigin="anonymous">



</body>
</html>

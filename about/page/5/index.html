<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"liyun-zhang.github.io","root":"/","images":"/images","scheme":"Mist","darkmode":true,"version":"8.17.0","exturl":false,"sidebar":{"position":"right","display":"hide","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="LiyunZhang">
<meta property="og:url" content="http://liyun-zhang.github.io/about/page/5/index.html">
<meta property="og:site_name" content="LiyunZhang">
<meta property="og:locale">
<meta property="article:author" content="LiyunZhang">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://liyun-zhang.github.io/about/page/5/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-Hans","comments":"","permalink":"","path":"about/page/5/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>LiyunZhang</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">LiyunZhang</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">LiyunZhang</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">66</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">11</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">31</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://liyun-zhang.github.io/2023/06/28/Courses/15445/06-Operator-Algorithms/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LiyunZhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LiyunZhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LiyunZhang">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/06/28/Courses/15445/06-Operator-Algorithms/" class="post-title-link" itemprop="url">06 Operator Algorithms</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-06-28 13:16:33" itemprop="dateCreated datePublished" datetime="2023-06-28T13:16:33+08:00">2023-06-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-03-16 14:50:53" itemprop="dateModified" datetime="2024-03-16T14:50:53+08:00">2024-03-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Open-Courses/" itemprop="url" rel="index"><span itemprop="name">Open Courses</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Open-Courses/CMU-15-445-645-Database-System/" itemprop="url" rel="index"><span itemprop="name">CMU 15-445/645 Database System</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><ul class="markdownIt-TOC">
<li><a href="#execute-queries">Execute queries</a>
<ul>
<li><a href="#how-are-queries-planned">How are queries planned?</a></li>
<li><a href="#what-is-the-assumption-of-algorithms-in-database-systems">What is the assumption of algorithms in database systems?</a></li>
</ul>
</li>
<li><a href="#sort">Sort</a>
<ul>
<li><a href="#what-implementation-should-we-use-to-execute-a-query-containing-an-order-by-with-a-limit">What implementation should we use to execute a query containing an ORDER BY with a LIMIT?</a></li>
<li><a href="#what-if-the-data-is-too-large-to-fit-in-memory-for-any-clause-including-order-by-with-a-limit">What if the data is too large to fit in memory? (for any clause including ORDER BY with a LIMIT)</a></li>
<li><a href="#how-to-perform-an-external-merge-sort">How to perform an external merge sort?</a></li>
<li><a href="#how-can-we-hide-the-disk-io">How can we hide the disk I/O?</a></li>
<li><a href="#how-can-we-optimize-comparison">How can we optimize comparison?</a></li>
<li><a href="#how-to-use-btree-for-sorting-since-it-is-sorted">How to use B+Tree for sorting since it is sorted?</a></li>
</ul>
</li>
<li><a href="#aggregations">Aggregations</a>
<ul>
<li><a href="#how-can-we-implement-aggregations">How can we implement aggregations?</a></li>
<li><a href="#how-to-do-hashing-when-spilling-data-onto-a-disk">How to do hashing when spilling data onto a disk?</a></li>
</ul>
</li>
<li><a href="#join">Join</a>
<ul>
<li><a href="#why-do-we-need-to-join">Why do we need to join?</a></li>
<li><a href="#what-are-join-algorithms-doing">What are join algorithms doing?</a></li>
<li><a href="#what-are-the-outputs-of-join-algorithms">What are the outputs of join algorithms?</a></li>
<li><a href="#how-can-we-measure-the-cost-of-join">How can we measure the cost of join?</a></li>
<li><a href="#join-algorithms">Join algorithms</a>
<ul>
<li><a href="#nested-loop-join">Nested loop join</a>
<ul>
<li><a href="#what-is-the-most-naive-algorithm">What is the most naive algorithm?</a></li>
<li><a href="#how-can-we-better-use-the-data-already-read-from-disk">How can we better use the data already read from disk?</a></li>
<li><a href="#how-can-we-take-advantage-of-more-buffer-space">How can we take advantage of more buffer space?</a></li>
<li><a href="#can-we-avoid-sequential-scans-by-using-an-index">Can we avoid sequential scans by using an index?</a></li>
</ul>
</li>
<li><a href="#sort-merge-join">Sort-merge join</a>
<ul>
<li><a href="#what-is-the-process-of-sort-merge-join">What is the process of sort-merge join?</a></li>
<li><a href="#how-do-the-two-cursors-move">How do the two cursors move?</a></li>
<li><a href="#when-is-sort-merge-join-useful">When is sort-merge join useful?</a></li>
</ul>
</li>
<li><a href="#hash-join">Hash join</a>
<ul>
<li><a href="#how-does-hash-join-work">How does hash join work?</a></li>
<li><a href="#how-big-of-a-table-can-we-hash-using-this-approach">How big of a table can we hash using this approach?</a></li>
<li><a href="#can-we-optimize-the-search-for-tuples-that-do-not-have-any-match">Can we optimize the search for tuples that do not have any match?</a></li>
<li><a href="#what-if-we-lack-the-memory-to-fit-the-entire-hash-table">What if we lack the memory to fit the entire hash table?</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</p>
<h1 id="execute-queries"><a class="markdownIt-Anchor" href="#execute-queries"></a> Execute queries</h1>
<h2 id="how-are-queries-planned"><a class="markdownIt-Anchor" href="#how-are-queries-planned"></a> How are queries planned?</h2>
<ol>
<li>The operators are arranged in an abstract syntax tree. Data flows from the leaves of the tree up towards the root.</li>
<li>The leaf nodes are access methods, e.g., scanning index and scanning table, feeding data up along its path to its parent node to do the processing.</li>
<li>The output of the root node is the result of the query.</li>
<li>This tree only describes a logical plan, i.e., instead of telling what implementation to use, it is just the logical flow we want. SQL only declares a logical plan, while the database system’s job is figuring out the optimal execution.</li>
</ol>
<h2 id="what-is-the-assumption-of-algorithms-in-database-systems"><a class="markdownIt-Anchor" href="#what-is-the-assumption-of-algorithms-in-database-systems"></a> What is the assumption of algorithms in database systems?</h2>
<ol>
<li>Just like it cannot assume that a table fits entirely in memory, a disk-oriented DBMS cannot assume that query results fit in memory.</li>
<li>We will use the buffer pool to implement algorithms that need to spill to disk.</li>
<li>We will also prefer algorithms that maximize the amount of sequential I/O.</li>
</ol>
<h1 id="sort"><a class="markdownIt-Anchor" href="#sort"></a> Sort</h1>
<h2 id="what-implementation-should-we-use-to-execute-a-query-containing-an-order-by-with-a-limit"><a class="markdownIt-Anchor" href="#what-implementation-should-we-use-to-execute-a-query-containing-an-order-by-with-a-limit"></a> What implementation should we use to execute a query containing an ORDER BY with a LIMIT?</h2>
<ol>
<li>The DBMS only needs to scan the data once to find the top-N elements.</li>
<li>The ideal scenario for heapsort is when the top-N elements fit in memory so that the DBMS only has to maintain an in-memory sorted priority queue while scanning the data.</li>
</ol>
<h2 id="what-if-the-data-is-too-large-to-fit-in-memory-for-any-clause-including-order-by-with-a-limit"><a class="markdownIt-Anchor" href="#what-if-the-data-is-too-large-to-fit-in-memory-for-any-clause-including-order-by-with-a-limit"></a> What if the data is too large to fit in memory? (for any clause including ORDER BY with a LIMIT)</h2>
<ol>
<li>We do not want to use quick sort in this scenario since data spilling to disk will cause too many random access.</li>
<li>We can use external merge sort that splits data into separate runs, sorts them individually, and then combines them into longer sorted runs.</li>
<li>A run is a list of key/value pairs.
<ul>
<li>Keys are the attribute(s) used to compare and compute the sort order.</li>
<li>Values have two choices: it can either be the actual tuple data (i.e., early materialization) or be the Record IDs (i.e., late materialization)
<ul>
<li>The advantage of early materialization is that it can produce results faster, while the disadvantage is that it needs to copy more data during the procedure.</li>
<li>The advantage of late materialization is that it can only fetch wanted data while it needs to find the actual data elsewhere (probably involving another disk I/O).</li>
</ul>
</li>
</ul>
</li>
</ol>
<h2 id="how-to-perform-an-external-merge-sort"><a class="markdownIt-Anchor" href="#how-to-perform-an-external-merge-sort"></a> How to perform an external merge sort?</h2>
<ol>
<li>Data is broken up into <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span> pages. The DBMS has a finite number of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi></mrow><annotation encoding="application/x-tex">B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span> buffer pool pages to hold input and output data.</li>
<li>In the first phase, sort chunks of data that fit in memory and then write back the sorted chunks to a file on disk.
<ul>
<li>In the first pass, we can read all <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi></mrow><annotation encoding="application/x-tex">B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span> pages of the table into memory, sort pages into runs, and write them back to disk.</li>
<li>Do not sort in the buffer since we do not wish other threads to see some partially sorted data, which may cause errors. Copy the data to somewhere else and copy it back to the buffer after it is sorted.</li>
</ul>
</li>
<li>In the second phase, combine sorted runs into larger chunks.
<ul>
<li>In the following passes, each pass use <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">B-1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span> pages for input and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span> page for output.</li>
<li>Recursively merge pairs of runs into runs <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">B-1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>-times as long.</li>
</ul>
</li>
<li>In general, the first pass creates <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">⌈</mo><mi>N</mi><mi mathvariant="normal">/</mi><mi>B</mi><mo stretchy="false">⌉</mo></mrow><annotation encoding="application/x-tex">\lceil N/B\rceil</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">⌈</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mord">/</span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mclose">⌉</span></span></span></span> sorted runs of size <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi></mrow><annotation encoding="application/x-tex">B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span> and the following passes are <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>B</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(B-1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span>-way merge.
<ul>
<li>The number of passes is <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mo>+</mo><mo stretchy="false">⌈</mo><msub><mo><mi>log</mi><mo>⁡</mo></mo><mrow><mi>B</mi><mo>−</mo><mn>1</mn></mrow></msub><mo stretchy="false">⌈</mo><mi>N</mi><mi mathvariant="normal">/</mi><mi>B</mi><mo stretchy="false">⌉</mo><mo stretchy="false">⌉</mo></mrow><annotation encoding="application/x-tex">1+\lceil\log_{B-1}\lceil N/B\rceil\rceil</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.052471em;vertical-align:-0.302471em;"></span><span class="mopen">⌈</span><span class="mop"><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.23419099999999998em;"><span style="top:-2.45586em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.302471em;"><span></span></span></span></span></span></span><span class="mopen">⌈</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mord">/</span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mclose">⌉</span><span class="mclose">⌉</span></span></span></span>.</li>
<li>The total I/O cost is <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn><mi>N</mi><mo>⋅</mo><mo stretchy="false">(</mo><mi>n</mi><mi>u</mi><mi>m</mi><mi>b</mi><mi>e</mi><mi>r</mi><mtext> </mtext><mi>o</mi><mi>f</mi><mtext> </mtext><mi>p</mi><mi>a</mi><mi>s</mi><mi>s</mi><mi>e</mi><mi>s</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">2N\cdot (number\ of\ passes)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord">2</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mord mathnormal">u</span><span class="mord mathnormal">m</span><span class="mord mathnormal">b</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mspace"> </span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mspace"> </span><span class="mord mathnormal">p</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">s</span><span class="mord mathnormal">e</span><span class="mord mathnormal">s</span><span class="mclose">)</span></span></span></span>.</li>
</ul>
</li>
<li>In a 2-way external merge sort, instead of sorting the <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi></mrow><annotation encoding="application/x-tex">B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span> pages into a run in the first pass, each page is sorted into a run.
<ul>
<li>So, the number of passes is <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mo>+</mo><mo stretchy="false">⌈</mo><msub><mo><mi>log</mi><mo>⁡</mo></mo><mn>2</mn></msub><mi>N</mi><mo stretchy="false">⌉</mo></mrow><annotation encoding="application/x-tex">1+\lceil\log_2N\rceil</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">⌈</span><span class="mop"><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.20696799999999996em;"><span style="top:-2.4558600000000004em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.24414em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mclose">⌉</span></span></span></span>.</li>
</ul>
</li>
</ol>
<h2 id="how-can-we-hide-the-disk-io"><a class="markdownIt-Anchor" href="#how-can-we-hide-the-disk-io"></a> How can we hide the disk I/O?</h2>
<ol>
<li>A typical setup is using <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>3</mn></mrow><annotation encoding="application/x-tex">3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">3</span></span></span></span> pages (<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn></mrow><annotation encoding="application/x-tex">2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">2</span></span></span></span> for input pages and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span> for output page). Even if we have more buffer space available (<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi><mo>&gt;</mo><mn>3</mn></mrow><annotation encoding="application/x-tex">B&gt;3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72243em;vertical-align:-0.0391em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">3</span></span></span></span>), it does not effectively utilize them if the worker must block disk I/O.</li>
<li>We can prefetch the next run in the background and store it in a second buffer while the system processes the current run.</li>
<li>This method continuously utilizes the disk to reduce the wait time for I/O requests at each step.</li>
</ol>
<h2 id="how-can-we-optimize-comparison"><a class="markdownIt-Anchor" href="#how-can-we-optimize-comparison"></a> How can we optimize comparison?</h2>
<ol>
<li>The first approach is code specialization.
<ul>
<li>Instead of providing a comparison function as a pointer to the sorting algorithm, create a hardcoded version of the sort that is specific to a key type.</li>
</ul>
</li>
<li>For string keys, the second approach is suffix truncation.
<ul>
<li>First, compare a binary prefix of keys instead of a slower string comparison.</li>
<li>Fallback to a slower version if prefixes are equal.</li>
</ul>
</li>
</ol>
<h2 id="how-to-use-btree-for-sorting-since-it-is-sorted"><a class="markdownIt-Anchor" href="#how-to-use-btree-for-sorting-since-it-is-sorted"></a> How to use B+Tree for sorting since it is sorted?</h2>
<ol>
<li>If the table that must be sorted already has a B+Tree index on the sort attribute(s), then we can use that to accelerate sorting.</li>
<li>Retrieve tuples in desired order by traversing the tree’s leaf pages.
<ul>
<li>For clustered B+Tree, this is always better than external sorting because there is no computational cost, and all disk access is sequential.</li>
<li>For non-clustered B+Tree, this is almost always a bad idea. In general, one I/O per data record.</li>
</ul>
</li>
</ol>
<h1 id="aggregations"><a class="markdownIt-Anchor" href="#aggregations"></a> Aggregations</h1>
<h2 id="how-can-we-implement-aggregations"><a class="markdownIt-Anchor" href="#how-can-we-implement-aggregations"></a> How can we implement aggregations?</h2>
<ol>
<li>The DBMS needs a way to find tuples with the same distinguishing attributes for grouping quickly.</li>
<li>We can use the aforementioned sorting algorithms for aggregations specified with an <code>ORDER BY</code> clause.</li>
<li>Hashing is a better alternative for queries that do not need the data to be ordered, e.g., forming groups in <code>GROUP BY</code> or removing duplicates in <code>DISTINCT</code>. Hashing can be computationally cheaper than sorting.
<ul>
<li>For each record, check whether there is an entry in the hash table. For <code>DISTINCT</code>, discard the duplicate. For <code>GROUP BY</code>, perform aggregate computation.</li>
</ul>
</li>
</ol>
<h2 id="how-to-do-hashing-when-spilling-data-onto-a-disk"><a class="markdownIt-Anchor" href="#how-to-do-hashing-when-spilling-data-onto-a-disk"></a> How to do hashing when spilling data onto a disk?</h2>
<ol>
<li>The first phase is partition. Divide tuples into buckets based on the hash key. Write them out to disk when they get full.
<ul>
<li>Use a hash function <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>h</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">h_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> to split tuples into partitions on the disk.</li>
<li>A partition is one or more pages that contain a set of keys with the same hash value.</li>
<li>Assume that we have <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi></mrow><annotation encoding="application/x-tex">B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span> buffers. We will use <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">B-1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span> buffers for the partitions and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span> buffer for the input data.</li>
</ul>
</li>
<li>The second phase is ReHash. Build an in-memory hash table for each partition and compute the aggregation.
<ul>
<li>For each partition on the disk, read it into memory and build an in-memory hash table based on a second hash function <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>h</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">h_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>.</li>
<li>Then, go through each bucket of this hash table to bring together matching tuples.</li>
<li>Each time, we can use <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">B-1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span> pages as input pages and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span> page as output page.
<ul>
<li>In each round, we can read in <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">B-1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span> partitions.</li>
<li>After each round is finished, we can clear the hash table since the next <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">B-1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span> partitions definitely won’t have the same keys as in the last round.</li>
</ul>
</li>
</ul>
</li>
<li>During the ReHash phase, store pairs of the form <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>G</mi><mi>r</mi><mi>o</mi><mi>u</mi><mi>p</mi><mi>K</mi><mi>e</mi><mi>y</mi><mo>→</mo><mi>R</mi><mi>u</mi><mi>n</mi><mi>n</mi><mi>i</mi><mi>n</mi><mi>g</mi><mi>V</mi><mi>a</mi><mi>l</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(GroupKey→RunningVal)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">G</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">o</span><span class="mord mathnormal">u</span><span class="mord mathnormal">p</span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord mathnormal">u</span><span class="mord mathnormal">n</span><span class="mord mathnormal">n</span><span class="mord mathnormal">i</span><span class="mord mathnormal">n</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mclose">)</span></span></span></span>.
<ul>
<li>When we want to insert a new tuple into the hash table if we find a matching <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>G</mi><mi>r</mi><mi>o</mi><mi>u</mi><mi>p</mi><mi>K</mi><mi>e</mi><mi>y</mi></mrow><annotation encoding="application/x-tex">GroupKey</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">G</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">o</span><span class="mord mathnormal">u</span><span class="mord mathnormal">p</span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span></span></span>, update the <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi><mi>u</mi><mi>n</mi><mi>n</mi><mi>i</mi><mi>n</mi><mi>g</mi><mi>V</mi><mi>a</mi><mi>l</mi></mrow><annotation encoding="application/x-tex">RunningVal</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord mathnormal">u</span><span class="mord mathnormal">n</span><span class="mord mathnormal">n</span><span class="mord mathnormal">i</span><span class="mord mathnormal">n</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span></span></span></span> appropriately. Else, insert a new <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>G</mi><mi>r</mi><mi>o</mi><mi>u</mi><mi>p</mi><mi>K</mi><mi>e</mi><mi>y</mi><mo>→</mo><mi>R</mi><mi>u</mi><mi>n</mi><mi>n</mi><mi>i</mi><mi>n</mi><mi>g</mi><mi>V</mi><mi>a</mi><mi>l</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(GroupKey→RunningVal)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">G</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">o</span><span class="mord mathnormal">u</span><span class="mord mathnormal">p</span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord mathnormal">u</span><span class="mord mathnormal">n</span><span class="mord mathnormal">n</span><span class="mord mathnormal">i</span><span class="mord mathnormal">n</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mclose">)</span></span></span></span>.</li>
<li>The running totals of different aggregation functions are as follows:
<ul>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mi>V</mi><mi>G</mi><mo stretchy="false">(</mo><mi>c</mi><mi>o</mi><mi>l</mi><mo stretchy="false">)</mo><mo>→</mo><mo stretchy="false">(</mo><mi>C</mi><mi>O</mi><mi>U</mi><mi>N</mi><mi>T</mi><mo separator="true">,</mo><mi>S</mi><mi>U</mi><mi>M</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">AVG(col)\rightarrow (COUNT,SUM)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">A</span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord mathnormal">G</span><span class="mopen">(</span><span class="mord mathnormal">c</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mclose">)</span></span></span></span></li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>U</mi><mi>M</mi><mo stretchy="false">(</mo><mi>c</mi><mi>o</mi><mi>l</mi><mo stretchy="false">)</mo><mo>→</mo><mo stretchy="false">(</mo><mi>S</mi><mi>U</mi><mi>M</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">SUM(col)\rightarrow(SUM)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mopen">(</span><span class="mord mathnormal">c</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mclose">)</span></span></span></span></li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>C</mi><mi>O</mi><mi>U</mi><mi>N</mi><mi>T</mi><mo stretchy="false">(</mo><mi>c</mi><mi>o</mi><mi>l</mi><mo stretchy="false">)</mo><mo>→</mo><mo stretchy="false">(</mo><mi>C</mi><mi>O</mi><mi>U</mi><mi>N</mi><mi>T</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">COUNT(col)\rightarrow(COUNT)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mopen">(</span><span class="mord mathnormal">c</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mclose">)</span></span></span></span></li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mi>I</mi><mi>N</mi><mo stretchy="false">(</mo><mi>c</mi><mi>o</mi><mi>l</mi><mo stretchy="false">)</mo><mo>→</mo><mo stretchy="false">(</mo><mi>M</mi><mi>I</mi><mi>N</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">MIN(col)\rightarrow(MIN)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mopen">(</span><span class="mord mathnormal">c</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mclose">)</span></span></span></span></li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mi>A</mi><mi>X</mi><mo stretchy="false">(</mo><mi>c</mi><mi>o</mi><mi>l</mi><mo stretchy="false">)</mo><mo>→</mo><mo stretchy="false">(</mo><mi>M</mi><mi>A</mi><mi>X</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">MAX(col)\rightarrow(MAX)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mord mathnormal">A</span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mopen">(</span><span class="mord mathnormal">c</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mord mathnormal">A</span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mclose">)</span></span></span></span></li>
</ul>
</li>
</ul>
</li>
</ol>
<h1 id="join"><a class="markdownIt-Anchor" href="#join"></a> Join</h1>
<h2 id="why-do-we-need-to-join"><a class="markdownIt-Anchor" href="#why-do-we-need-to-join"></a> Why do we need to join?</h2>
<ol>
<li>Tables are normalized in a relational database to avoid unnecessary repetition of information.</li>
<li>The join operator reconstructs the original tuples without any information loss.</li>
<li>Join is an important operator in both OLAP and OLTP systems. Especially for the OLAP system, joining could take up to <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>15</mn><mo>∼</mo><mn>50</mn><mi mathvariant="normal">%</mi></mrow><annotation encoding="application/x-tex">15\sim 50\%</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord">5</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∼</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.80556em;vertical-align:-0.05556em;"></span><span class="mord">5</span><span class="mord">0</span><span class="mord">%</span></span></span></span> of time.</li>
</ol>
<h2 id="what-are-join-algorithms-doing"><a class="markdownIt-Anchor" href="#what-are-join-algorithms-doing"></a> What are join algorithms doing?</h2>
<ol>
<li>The most important kind is binary joins using inner equijoin algorithms.
<ul>
<li>Binary means that the operator takes two tables as input.</li>
<li>Inner means it matches a certain tuple in the left table with another in the right.</li>
<li>Equijoin means that the condition of matching two tuples is the equivalence of some attributes.</li>
</ul>
</li>
<li>There are also other joins.
<ul>
<li>Multi-way joins take more than two tables as input, primarily in the research literature.</li>
<li>Besides equijoin, there could also be anti-join, non-equijoin, etc.</li>
</ul>
</li>
<li>Compared with cross-product, join is more efficient and can be carefully optimized.</li>
</ol>
<h2 id="what-are-the-outputs-of-join-algorithms"><a class="markdownIt-Anchor" href="#what-are-the-outputs-of-join-algorithms"></a> What are the outputs of join algorithms?</h2>
<ol>
<li>In <code>R JOIN S</code>, for tuple <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi><mo>∈</mo><mi>R</mi></mrow><annotation encoding="application/x-tex">r \in R</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span></span></span></span> and tuple <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mo>∈</mo><mi>S</mi></mrow><annotation encoding="application/x-tex">s \in S</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mord mathnormal">s</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span></span></span></span> that match on join attributes, concatenate <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi></mrow><annotation encoding="application/x-tex">r</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span></span> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi></mrow><annotation encoding="application/x-tex">s</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">s</span></span></span></span> together into a new tuple.</li>
<li>The output contents can vary depending on the query’s processing model, storage model, or data requirements.</li>
<li>Basically, there are two choices that are similar in terms of sort.
<ul>
<li>Early materialization
<ul>
<li>Copy the values for the attributes in outer and inner tuples into a new output tuple.</li>
<li>Subsequent query plan operators never need to return to the base tables to get more data.</li>
</ul>
</li>
<li>Late materialization
<ul>
<li>Only copy the join keys and the matching tuples’ Record IDs.</li>
<li>This is ideal for column stores because the DBMS does not copy data not needed for the query.</li>
</ul>
</li>
</ul>
</li>
</ol>
<h2 id="how-can-we-measure-the-cost-of-join"><a class="markdownIt-Anchor" href="#how-can-we-measure-the-cost-of-join"></a> How can we measure the cost of join?</h2>
<ol>
<li>We can measure the join cost by the number of I/Os to compute the join.</li>
<li>Output costs are ignored since they depend on the data.</li>
<li>In the following analysis, we assume there are <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi></mrow><annotation encoding="application/x-tex">m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">m</span></span></span></span> tuples stored in <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi></mrow><annotation encoding="application/x-tex">M</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span></span></span></span> pages in table <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi></mrow><annotation encoding="application/x-tex">R</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span></span></span></span>, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">n</span></span></span></span> tuples stored in <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span> pages in table <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi></mrow><annotation encoding="application/x-tex">S</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span></span></span></span>.</li>
</ol>
<h2 id="join-algorithms"><a class="markdownIt-Anchor" href="#join-algorithms"></a> Join algorithms</h2>
<h3 id="nested-loop-join"><a class="markdownIt-Anchor" href="#nested-loop-join"></a> Nested loop join</h3>
<h4 id="what-is-the-most-naive-algorithm"><a class="markdownIt-Anchor" href="#what-is-the-most-naive-algorithm"></a> What is the most naive algorithm?</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> <span class="built_in">tuple</span> r <span class="keyword">in</span> R:</span><br><span class="line">  <span class="keyword">for</span> <span class="built_in">tuple</span> s <span class="keyword">in</span> S:</span><br><span class="line">    emit, <span class="keyword">if</span> r <span class="keyword">and</span> s <span class="keyword">match</span></span><br></pre></td></tr></table></figure>
<ol>
<li>For <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi><mo>⋈</mo><mi>S</mi></mrow><annotation encoding="application/x-tex">R\bowtie S</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68833em;vertical-align:-0.005em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">⋈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span></span></span></span>, he left the table <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi></mrow><annotation encoding="application/x-tex">R</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span></span></span></span> in the outer loop is called the outer table, and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi></mrow><annotation encoding="application/x-tex">S</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span></span></span></span> is called the inner table.</li>
<li>For every tuple in <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi></mrow><annotation encoding="application/x-tex">R</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span></span></span></span>, it scans <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi></mrow><annotation encoding="application/x-tex">S</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span></span></span></span> once. The cost is <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mo>+</mo><mo stretchy="false">(</mo><mi>m</mi><mo>⋅</mo><mi>N</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">M+(m\cdot N)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mclose">)</span></span></span></span>.</li>
<li>If we use the smaller table with fewer tuples as the outer table, we can perform better since the number of pages is significantly smaller than the number of tuples.</li>
</ol>
<h4 id="how-can-we-better-use-the-data-already-read-from-disk"><a class="markdownIt-Anchor" href="#how-can-we-better-use-the-data-already-read-from-disk"></a> How can we better use the data already read from disk?</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> block B_R <span class="keyword">in</span> R:</span><br><span class="line">  <span class="keyword">for</span> block B_S <span class="keyword">in</span> S:</span><br><span class="line">    <span class="keyword">for</span> <span class="built_in">tuple</span> r <span class="keyword">in</span> B_R:</span><br><span class="line">      <span class="keyword">for</span> <span class="built_in">tuple</span> s <span class="keyword">in</span> B_S:</span><br><span class="line">        emit, <span class="keyword">if</span> r <span class="keyword">and</span> s <span class="keyword">match</span></span><br></pre></td></tr></table></figure>
<ol>
<li>For every read block <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>B</mi><mi>R</mi></msub></mrow><annotation encoding="application/x-tex">B_R</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.05017em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.00773em;">R</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>B</mi><mi>S</mi></msub></mrow><annotation encoding="application/x-tex">B_S</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.05017em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05764em;">S</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>, we try to compute as much as possible, i.e., pair all tuples in <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>B</mi><mi>R</mi></msub></mrow><annotation encoding="application/x-tex">B_R</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.05017em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.00773em;">R</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> with all tuples in <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>B</mi><mi>S</mi></msub></mrow><annotation encoding="application/x-tex">B_S</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.05017em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05764em;">S</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>.</li>
<li>Every block in R scans S once. The cost is <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mo>+</mo><mo stretchy="false">(</mo><mi>M</mi><mo>⋅</mo><mi>N</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">M+(M\cdot N)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mclose">)</span></span></span></span>.</li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mo>⋅</mo><mi>N</mi></mrow><annotation encoding="application/x-tex">M\cdot N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span> won’t be affected by the order of tables. However, the first term can be smaller if we let the smaller table with fewer pages be the outer table.</li>
</ol>
<h4 id="how-can-we-take-advantage-of-more-buffer-space"><a class="markdownIt-Anchor" href="#how-can-we-take-advantage-of-more-buffer-space"></a> How can we take advantage of more buffer space?</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> B-<span class="number">2</span> pages p_R <span class="keyword">in</span> R:</span><br><span class="line">  <span class="keyword">for</span> page p_S <span class="keyword">in</span> S:</span><br><span class="line">    <span class="keyword">for</span> <span class="built_in">tuple</span> r <span class="keyword">in</span> B_2 pages:</span><br><span class="line">      <span class="keyword">for</span> <span class="built_in">tuple</span> s <span class="keyword">in</span> p_S:</span><br><span class="line">        emit, <span class="keyword">if</span> r <span class="keyword">and</span> s <span class="keyword">match</span></span><br></pre></td></tr></table></figure>
<ol>
<li>Use <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi><mo>−</mo><mn>2</mn></mrow><annotation encoding="application/x-tex">B-2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">2</span></span></span></span> buffers for scanning the outer table. Use one buffer for the inner table and one buffer for storing<br />
output.</li>
<li>The cost is <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mo>+</mo><mo stretchy="false">(</mo><mo stretchy="false">⌈</mo><mi>M</mi><mi mathvariant="normal">/</mi><mo stretchy="false">(</mo><mi>B</mi><mo>−</mo><mn>2</mn><mo stretchy="false">)</mo><mo stretchy="false">⌉</mo><mo>⋅</mo><mi>N</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">M+(\lceil M/(B-2)\rceil\cdot N)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mopen">⌈</span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mord">/</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">2</span><span class="mclose">)</span><span class="mclose">⌉</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mclose">)</span></span></span></span>.</li>
<li>If the outer relation completely fits in memory, the cost is <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mo>+</mo><mi>N</mi></mrow><annotation encoding="application/x-tex">M+N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span>.</li>
</ol>
<h4 id="can-we-avoid-sequential-scans-by-using-an-index"><a class="markdownIt-Anchor" href="#can-we-avoid-sequential-scans-by-using-an-index"></a> Can we avoid sequential scans by using an index?</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> <span class="built_in">tuple</span> r <span class="keyword">in</span> R:</span><br><span class="line">  <span class="keyword">for</span> <span class="built_in">tuple</span> s <span class="keyword">in</span> Index(r_i = s_j):</span><br><span class="line">    emit, <span class="keyword">if</span> r <span class="keyword">and</span> s <span class="keyword">match</span></span><br></pre></td></tr></table></figure>
<p>Assume the cost of each index probe is some constant <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>C</mi></mrow><annotation encoding="application/x-tex">C</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span></span></span></span> per tuple. The cost is <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mo>+</mo><mo stretchy="false">(</mo><mi>m</mi><mo>⋅</mo><mi>C</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">M+(m\cdot C)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mclose">)</span></span></span></span></p>
<h3 id="sort-merge-join"><a class="markdownIt-Anchor" href="#sort-merge-join"></a> Sort-merge join</h3>
<h4 id="what-is-the-process-of-sort-merge-join"><a class="markdownIt-Anchor" href="#what-is-the-process-of-sort-merge-join"></a> What is the process of sort-merge join?</h4>
<ol>
<li>The first phase is to sort both tables using the join key(s).</li>
<li>In the second phase, we step through the two sorted tables with cursors and emit matching tuples.</li>
<li>The sort cost of the outer table is <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn><mi>M</mi><mo>⋅</mo><mo stretchy="false">(</mo><mn>1</mn><mo>+</mo><mo stretchy="false">⌈</mo><msub><mo><mi>log</mi><mo>⁡</mo></mo><mrow><mi>B</mi><mo>−</mo><mn>1</mn></mrow></msub><mo stretchy="false">⌈</mo><mi>M</mi><mi mathvariant="normal">/</mi><mi>B</mi><mo stretchy="false">⌉</mo><mo stretchy="false">⌉</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">2M\cdot(1+\lceil \log_{B-1}\lceil M/B\rceil\rceil)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord">2</span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.052471em;vertical-align:-0.302471em;"></span><span class="mopen">⌈</span><span class="mop"><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.23419099999999998em;"><span style="top:-2.45586em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.302471em;"><span></span></span></span></span></span></span><span class="mopen">⌈</span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mord">/</span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mclose">⌉</span><span class="mclose">⌉</span><span class="mclose">)</span></span></span></span> and the sort cost of the inner table is <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn><mi>N</mi><mo>⋅</mo><mo stretchy="false">(</mo><mn>1</mn><mo>+</mo><mo stretchy="false">⌈</mo><msub><mo><mi>log</mi><mo>⁡</mo></mo><mrow><mi>B</mi><mo>−</mo><mn>1</mn></mrow></msub><mo stretchy="false">⌈</mo><mi>N</mi><mi mathvariant="normal">/</mi><mi>B</mi><mo stretchy="false">⌉</mo><mo stretchy="false">⌉</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">2N\cdot (1+\lceil\log_{B-1}\lceil N/B \rceil \rceil)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord">2</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.052471em;vertical-align:-0.302471em;"></span><span class="mopen">⌈</span><span class="mop"><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.23419099999999998em;"><span style="top:-2.45586em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.302471em;"><span></span></span></span></span></span></span><span class="mopen">⌈</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mord">/</span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mclose">⌉</span><span class="mclose">⌉</span><span class="mclose">)</span></span></span></span>.</li>
<li>The merge cost is <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mo>+</mo><mi>N</mi></mrow><annotation encoding="application/x-tex">M+N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span>.
<ul>
<li>The worst case for the merging phase is when the join attribute of all the tuples in both relations contains the same value.</li>
</ul>
</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">sort R,S on join keys</span><br><span class="line">cursor_R points to R_sorted, cursor_S points to S_sorted</span><br><span class="line"><span class="keyword">while</span> cursor_R <span class="keyword">and</span> cursor_S:</span><br><span class="line">  <span class="keyword">if</span> cursor_R &gt; cursor_S:</span><br><span class="line">    increment cursor_S</span><br><span class="line">  <span class="keyword">if</span> cursor_R &lt; cursor_S:</span><br><span class="line">    increment cursor_R</span><br><span class="line">    possible backtrack cursor_S</span><br><span class="line">  <span class="keyword">elif</span> cursor_R <span class="keyword">and</span> surcor_s <span class="keyword">match</span>:</span><br><span class="line">    emit</span><br><span class="line">    increment cursor_s</span><br></pre></td></tr></table></figure>
<h4 id="how-do-the-two-cursors-move"><a class="markdownIt-Anchor" href="#how-do-the-two-cursors-move"></a> How do the two cursors move?</h4>
<ol>
<li>The cursor of the outer table will only move forward. Specifically, it will only move forward when we can ensure that we have matched the current tuple with all possible tuples, i.e., when we have a larger inner tuple.</li>
<li>The cursor of the inner table may move both forward and backward.
<ul>
<li>It moves forward when some later tuple in the inner table may match with the current tuple in an outer tuple, i.e., when an inner tuple is smaller than the outer tuple or when they match (there are possibly more matches in the following).</li>
<li>It moves backward when there might have been some missing matches in the past, i.e., when the outer cursor moves forward, the key is the same as the last one; we need to backtrack to the earliest tuple that matches the previous outer tuple.</li>
</ul>
</li>
</ol>
<h4 id="when-is-sort-merge-join-useful"><a class="markdownIt-Anchor" href="#when-is-sort-merge-join-useful"></a> When is sort-merge join useful?</h4>
<ol>
<li>We can save some cost when one or both tables are sorted using the join key.</li>
<li>When output must be sorted on the join key, if the join output is larger, we might use sort-merge join to produce sorted output directly.
<ul>
<li>If the output has a small amount, hash join might still be the better way.</li>
</ul>
</li>
</ol>
<h3 id="hash-join"><a class="markdownIt-Anchor" href="#hash-join"></a> Hash join</h3>
<h4 id="how-does-hash-join-work"><a class="markdownIt-Anchor" href="#how-does-hash-join-work"></a> How does hash join work?</h4>
<ol>
<li>
<p>The thought behind hash join is that:</p>
<ul>
<li>If tuple <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi><mo>∈</mo><mi>R</mi></mrow><annotation encoding="application/x-tex">r \in R</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span></span></span></span> and a tuple<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mo>∈</mo><mi>S</mi></mrow><annotation encoding="application/x-tex">s \in S</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mord mathnormal">s</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span></span></span></span> satisfy the join condition; they have the same value for the join attributes.</li>
<li>If that value is hashed to some partition <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.65952em;vertical-align:0em;"></span><span class="mord mathnormal">i</span></span></span></span>, the <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi></mrow><annotation encoding="application/x-tex">R</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span></span></span></span> tuple must be in <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>r</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">r_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> and the <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi></mrow><annotation encoding="application/x-tex">S</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span></span></span></span> tuple in <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>s</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">s_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>.</li>
<li>Therefore, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi></mrow><annotation encoding="application/x-tex">R</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span></span></span></span> tuples in <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>r</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">r_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> need only to be compared with <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi></mrow><annotation encoding="application/x-tex">S</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span></span></span></span> tuples in <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>s</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">s_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>.</li>
</ul>
</li>
<li>
<p>In the first phase (build), we scan the outer relation and populate a hash table using the hash function <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>h</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">h_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> on the join attributes.</p>
<p>In the second phase (probe), scan the inner relation and use <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>h</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">h_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> on each tuple, jump to a location in the hash table, and find a matching tuple.</p>
</li>
<li>
<p>The keys stored in the hash table are the attribute(s) on which the query is joining the tables. We always need the original key to verify that we have a correct match in case of hash collisions.</p>
<p>The values stored vary per implementation, which depends on what the operators above the join in the query plan expect as its input.</p>
</li>
<li>
<p>Assume that we have enough buffers, we need to read and write both tables with the cost of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn><mo stretchy="false">(</mo><mi>M</mi><mo>+</mo><mi>N</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">2(M+N)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">2</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mclose">)</span></span></span></span> in the partitioning phase, and read both tables with the cost of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mo>+</mo><mi>N</mi></mrow><annotation encoding="application/x-tex">M+N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span> in the probing phase.</p>
<ul>
<li>We can see that there is no constraint on the size of the inner table.</li>
</ul>
</li>
</ol>
<h4 id="how-big-of-a-table-can-we-hash-using-this-approach"><a class="markdownIt-Anchor" href="#how-big-of-a-table-can-we-hash-using-this-approach"></a> How big of a table can we hash using this approach?</h4>
<ol>
<li>In the first phase of building a hash table, we can use at most <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">B-1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span> spill partitions, leaving one page as an input buffer. When one partition is full, we should write it out on the disk and clear it.</li>
<li>total number of both the outer and inner table of each partition should be no more than <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi></mrow><annotation encoding="application/x-tex">B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span> blocks big so that in the second phase, we can store all tuples in the same partition in memory.</li>
<li>The total number of pages used is <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi><mo>⋅</mo><mo stretchy="false">(</mo><mi>B</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">B\cdot (B-1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span>. A hash table of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span> pages need about <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msqrt><mi>N</mi></msqrt></mrow><annotation encoding="application/x-tex">\sqrt{N}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.04em;vertical-align:-0.11333499999999996em;"></span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9266650000000001em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord" style="padding-left:0.833em;"><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span><span style="top:-2.886665em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg width='400em' height='1.08em' viewBox='0 0 400000 1080' preserveAspectRatio='xMinYMin slice'><path d='M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z'/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.11333499999999996em;"><span></span></span></span></span></span></span></span></span> buffers if the hash distribution is even.</li>
<li>When including the fudge factor <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo>&gt;</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">f&gt;1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span> when the hash distribution is skewed, we need <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi><mo>⋅</mo><msqrt><mrow><mi>f</mi><mo>⋅</mo><mi>N</mi></mrow></msqrt></mrow><annotation encoding="application/x-tex">B\cdot\sqrt{f\cdot N}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.04em;vertical-align:-0.20500000000000007em;"></span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.835em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord" style="padding-left:0.833em;"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span><span style="top:-2.795em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg width='400em' height='1.08em' viewBox='0 0 400000 1080' preserveAspectRatio='xMinYMin slice'><path d='M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z'/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.20500000000000007em;"><span></span></span></span></span></span></span></span></span>.</li>
</ol>
<h4 id="can-we-optimize-the-search-for-tuples-that-do-not-have-any-match"><a class="markdownIt-Anchor" href="#can-we-optimize-the-search-for-tuples-that-do-not-have-any-match"></a> Can we optimize the search for tuples that do not have any match?</h4>
<ol>
<li>We can create a Bloom filter during the build phase when the key will likely not exist in the hash table. This method is called Bloom filter or sideways information passing.</li>
<li>The Bloom filter is a probabilistic data structure (bitmap) that answers set membership queries.
<ul>
<li>False negatives will never occur, while false positives can sometimes occur.</li>
<li>To insert a key into the filter, we use <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> hash functions to set all <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> bits to <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>.</li>
<li>During the lookup of a key, the key may exist if all <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> bits hashed by the same <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> hash function are all <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>. The key definitely does not exist if one of the <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> bits is <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span>.</li>
</ul>
</li>
</ol>
<h4 id="what-if-we-lack-the-memory-to-fit-the-entire-hash-table"><a class="markdownIt-Anchor" href="#what-if-we-lack-the-memory-to-fit-the-entire-hash-table"></a> What if we lack the memory to fit the entire hash table?</h4>
<ol>
<li>We can use the recursive hash join (GRACE hash join).</li>
<li>Similar to the aforementioned algorithm, both tables should be hashed into the same number of buckets with the same hash function.</li>
<li>Perform regular hash join on each pair of matching buckets at the same level between two tables.</li>
<li>If the buckets do not fit in memory, use recursive partitioning to split the tables into chunks that will fit.
<ul>
<li>Build another hash table for <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mi>u</mi><mi>c</mi><mi>k</mi><mi>e</mi><msub><mi>t</mi><mrow><mi>R</mi><mo separator="true">,</mo><mi>i</mi></mrow></msub></mrow><annotation encoding="application/x-tex">bucket_{R,i}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.980548em;vertical-align:-0.286108em;"></span><span class="mord mathnormal">b</span><span class="mord mathnormal">u</span><span class="mord mathnormal">c</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord mathnormal">e</span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.328331em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.00773em;">R</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span> using hash function <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>h</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">h_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> (with <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>h</mi><mn>2</mn></msub><mo mathvariant="normal">≠</mo><msub><mi>h</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">h_2≠h_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel"><span class="mrel"><span class="mord vbox"><span class="thinbox"><span class="rlap"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="inner"><span class="mrel"></span></span><span class="fix"></span></span></span></span></span><span class="mrel">=</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>).</li>
<li>Then, probe it for each tuple of the other table’s bucket at that level.</li>
</ul>
</li>
<li><strong>Hybrid hash join</strong>: If the keys are skewed, the DBMS keeps the hot partition in-memory and immediately performs the comparison instead of spilling it to disk.</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://liyun-zhang.github.io/2023/06/27/OpenSource/BusTub/Project-1-Buffer-Pool/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LiyunZhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LiyunZhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LiyunZhang">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/06/27/OpenSource/BusTub/Project-1-Buffer-Pool/" class="post-title-link" itemprop="url">Project #1: Buffer Pool</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-06-27 15:29:31" itemprop="dateCreated datePublished" datetime="2023-06-27T15:29:31+08:00">2023-06-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-03-16 23:13:06" itemprop="dateModified" datetime="2024-03-16T23:13:06+08:00">2024-03-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Open-Source-Code/" itemprop="url" rel="index"><span itemprop="name">Open Source Code</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Open-Source-Code/BusTub/" itemprop="url" rel="index"><span itemprop="name">BusTub</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><ul class="markdownIt-TOC">
<li><a href="#task-1-lru-k-replacement-policy">Task #1 - LRU-K Replacement Policy</a></li>
<li><a href="#task-2-buffer-pool-manager">Task #2 - Buffer Pool Manager</a>
<ul>
<li><a href="#basic">Basic</a></li>
<li><a href="#leaderboard-optimization">Leaderboard optimization</a></li>
</ul>
</li>
<li><a href="#task-3-readwrite-page-guards">Task #3 - Read/Write Page Guards</a></li>
</ul>
</p>
<h1 id="task-1-lru-k-replacement-policy"><a class="markdownIt-Anchor" href="#task-1-lru-k-replacement-policy"></a> Task #1 - LRU-K Replacement Policy</h1>
<ol>
<li>
<p>Evict rule:</p>
<ul>
<li>When all evictable frames have more than <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span> access records, evict the one whose backward k-distance is maximum.</li>
<li>When some frames only have less than <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span> access records, evict the one with the earliest first access record among those less than <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span> frames.</li>
</ul>
</li>
<li>
<p>Comparison:</p>
<ul>
<li>When each frame is created or stored with a new page, push an access record of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span> to its history to represent <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>+</mo><mi>inf</mi><mo>⁡</mo></mrow><annotation encoding="application/x-tex">+\inf</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.77777em;vertical-align:-0.08333em;"></span><span class="mord">+</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop">in<span style="margin-right:0.07778em;">f</span></span></span></span></span>.</li>
<li>Each comparison uses the first two records in the list. If the first record (the earliest backward most k-distance) is the same, it must be <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span> causing a comparison of the second record, representing the true first access of that frame.</li>
<li>Remember to update the second comparison timestamp when the first time, find <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span> in the first timestamp.</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">size_t</span> k_timestamp = frame.second.<span class="built_in">GetKTimestamp</span>();</span><br><span class="line"><span class="type">size_t</span> sec_timestamp = frame.second.<span class="built_in">GetSecondTimestamp</span>();</span><br><span class="line"><span class="keyword">if</span> (k_timestamp &lt; cmp_k_timestamp) &#123;</span><br><span class="line">	victim = frame.first;</span><br><span class="line">	cmp_k_timestamp = k_timestamp;</span><br><span class="line">	<span class="keyword">if</span> (k_timestamp == <span class="number">0</span>) &#123;</span><br><span class="line">		cmp_sec_timestamp = sec_timestamp;</span><br><span class="line">	&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (k_timestamp == cmp_k_timestamp &amp;&amp; sec_timestamp &lt; cmp_sec_timestamp) &#123;</span><br><span class="line">	victim = frame.first;</span><br><span class="line">	cmp_sec_timestamp = sec_timestamp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>After successfully choosing a victim, we need to clear its history (leaving the <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span> as sentinel), set it to non-evictable, and reduce the current size of the replacer.</p>
</li>
</ol>
<h1 id="task-2-buffer-pool-manager"><a class="markdownIt-Anchor" href="#task-2-buffer-pool-manager"></a> Task #2 - Buffer Pool Manager</h1>
<h2 id="basic"><a class="markdownIt-Anchor" href="#basic"></a> Basic</h2>
<ol>
<li>
<p>When the page that is asked to fetch is already in the buffer pool, we still need to do several things:</p>
<ul>
<li>Set it to non-evictable.</li>
<li>Record its access in the replacer.</li>
<li>Increase its pin count.</li>
</ul>
</li>
<li>
<p>When the page is not in the buffer pool or creating a new page:</p>
<ul>
<li>First, we need to acquire a free frame.
<ul>
<li>Erase it from the page table when we are evicting one.</li>
<li>Write the content to disk when the old page is dirty.</li>
</ul>
</li>
<li>Then, similar to the other situation, we need to:
<ul>
<li>Set it to non-evictable</li>
<li>Record its access in the replacer.</li>
<li>Put it in the page table.</li>
<li>Set its pin count to <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span></li>
<li>Set <code>is_dirty_</code> to <code>false</code></li>
<li>Set its page ID to frame.</li>
</ul>
</li>
<li>Even in <code>NewPage</code>, the <code>is_dirty_</code> is false because it can directly “write” empty to file by increasing offset, which is done when a larger page ID is written. There is no need actually to write empty content.</li>
</ul>
</li>
<li>
<p>When setting <code>is_dirty_</code> in <code>Unpin</code>, if the page is already dirty, we should not set it to clean, no matter what we are told.</p>
</li>
</ol>
<h2 id="leaderboard-optimization"><a class="markdownIt-Anchor" href="#leaderboard-optimization"></a> Leaderboard optimization</h2>
<ol>
<li>Fine-grain lock
<ul>
<li>A coarse-grain lock is easier to program while sacrificing performance.</li>
<li>In fine-grain lock, a <code>core_latch_</code> is used to protect the core data of the buffer pool manager, i.e., <code>page_table_</code>, <code>free_list_</code>, <code>next_page_id_</code>). Each frame has its latch to protect its data, i.e., <code>pin_count_</code>, <code>is_dirty_</code>, <code>page_id_</code>.</li>
<li>Each function thread will, at most, grab the core_latch_ and one of the frame latches.</li>
<li>To avoid deadlock, each procedure is designed so that a thread will try to acquire a page latch only if it already has a <code>core_latch_</code> or it won’t want a core_latech later.</li>
<li>To obtain atomic when switching from <code>core_latch_</code> to a page latch, we must acquire the page latch before releasing the <code>core_latch_</code>.
<ul>
<li>If we release core_latch_ first, some other thread may change the frame we want to use (e.g., evict the frame, modify its metadata) before acquiring the frame latch.</li>
</ul>
</li>
</ul>
</li>
<li>Delay write-out:
<ul>
<li>Disk I/Os consume a large amount of time. So, we must avoid holding a lock while communicating with the disk.</li>
<li>When we need to write data into disk, instead of immediately calling the disk_manager_-&gt;WritePage, we create a temporary buffer in memory and copy data into the buffer. After all locks are released, we write that content in the buffer into a disk.</li>
<li>A similar thought is to delay reading data until all locks are released. However, <code>ReadData</code> is called in <code>FetchPage</code>, where we can only release the frame latch after the whole frame is ready for others to visit. Still, we can <code>ReadData</code> after <code>core_latch_</code> is released since the <code>core_latch_</code> could be the bottleneck of the manager.</li>
<li>However, there is a problem:
<ul>
<li>When a page is evicted, and only a short time later, that exact page is fetched again. Since all latches are released before writing dirty data to disk, there is a chance that FetchPage reads stale data from disk before the up-to-date data is written to disk.</li>
<li>My other thought is maintaining a list of page IDs in the writing buffer. If the page ID of <code>FetchPage</code> is in the list, copy data from the writing buffer and erase that page from the writing buffer.</li>
<li>The problem is that we need to guarantee the atomic between getting the writing content and writing it to disk. Otherwise, tricky concurrent operations may cause the written content to be wrong.</li>
<li>Hence, we cannot unlock the latches until we are sure the content is written, which also makes fine-grained latches meaningless, given that disk I/O is the key problem of performance.</li>
</ul>
</li>
</ul>
</li>
<li>Pre-fetch
<ul>
<li>To better suit the scan case, the buffer pool manager can pre-fetch several following pages when accessing three consecutive page IDs in a row.</li>
<li>Different from fetching pages through <code>FetchPage</code>, pre-fetched frames need to set <code>pin_count_</code> to <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span> and evictable.</li>
<li>Pre-fetch should not stall <code>FetchPage</code> from returning, so it must be run in a separate thread.</li>
<li>The problem is that pre-fetch must be an independent background thread. It won’t know whether the buffer pool manager is destroyed, which will cause a heap-use-after-free error.</li>
</ul>
</li>
</ol>
<h1 id="task-3-readwrite-page-guards"><a class="markdownIt-Anchor" href="#task-3-readwrite-page-guards"></a> Task #3 - Read/Write Page Guards</h1>
<ol>
<li>Any <code>PageGuard</code> will automatically unpin itself when it is deconstructed. But they don’t need to pin themselves since they are pinned before <code>PageGuard</code> is created when fetching or creating a page.</li>
<li>If a <code>Read/WritePageGuard</code> is acquired through <code>FetchPageRead</code> or <code>FetchPageWrite</code>, the latch is acquired inside these functions. However, the latch won’t be acquired automatically if a <code>PageGuard</code> is acquired through its construction function.</li>
<li>No matter how <code>Read/WritePageGuard</code> is acquired, the latch will always be released automatically when the <code>PageGuard</code> is deconstructed by a deconstructor or move operation.</li>
<li>In the move assignment, we must first drop the original page, copy from the right reference, and finally deconstruct the right reference.</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://liyun-zhang.github.io/2023/06/25/Courses/15445/05-Index-Concurrency/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LiyunZhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LiyunZhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LiyunZhang">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/06/25/Courses/15445/05-Index-Concurrency/" class="post-title-link" itemprop="url">05 Index Concurrency</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-06-25 00:40:22" itemprop="dateCreated datePublished" datetime="2023-06-25T00:40:22+08:00">2023-06-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-03-16 14:31:10" itemprop="dateModified" datetime="2024-03-16T14:31:10+08:00">2024-03-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Open-Courses/" itemprop="url" rel="index"><span itemprop="name">Open Courses</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Open-Courses/CMU-15-445-645-Database-System/" itemprop="url" rel="index"><span itemprop="name">CMU 15-445/645 Database System</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><ul class="markdownIt-TOC">
<li><a href="#concurrency-control">Concurrency control</a>
<ul>
<li><a href="#what-are-the-correctness-criteria-of-concurrency-control">What are the correctness criteria of concurrency control?</a></li>
<li><a href="#what-is-the-more-specific-difference-between-locks-and-latches">What is the more specific difference between locks and latches?</a></li>
<li><a href="#what-are-the-two-latch-modes">What are the two latch modes?</a></li>
<li><a href="#what-are-the-different-latch-implementations">What are the different latch implementations?</a></li>
</ul>
</li>
<li><a href="#latching-scheme">Latching scheme</a>
<ul>
<li><a href="#hash-table-latching">Hash table latching</a>
<ul>
<li><a href="#why-are-deadlocks-not-possible-in-the-hash-table">Why are deadlocks not possible in the hash table?</a></li>
<li><a href="#how-can-we-design-hash-table-latching">How can we design hash table latching?</a></li>
</ul>
</li>
<li><a href="#btree-latching">B+Tree latching</a>
<ul>
<li><a href="#what-should-we-use-latching-to-prevent">What should we use latching to prevent?</a></li>
<li><a href="#how-should-we-achieve-physical-correctness">How should we achieve physical correctness?</a></li>
<li><a href="#what-is-the-problem-with-the-aforementioned-strategy">What is the problem with the aforementioned strategy?</a></li>
<li><a href="#when-will-a-deadlock-occur">When will a deadlock occur?</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</p>
<h1 id="concurrency-control"><a class="markdownIt-Anchor" href="#concurrency-control"></a> Concurrency control</h1>
<h2 id="what-are-the-correctness-criteria-of-concurrency-control"><a class="markdownIt-Anchor" href="#what-are-the-correctness-criteria-of-concurrency-control"></a> What are the correctness criteria of concurrency control?</h2>
<ol>
<li>Logical Correctness:
<ul>
<li>Can a thread see the data that it is supposed to see? For example, correctly control data race.</li>
</ul>
</li>
<li>Physical Correctness:
<ul>
<li>Is the internal representation of the object sound? For example, fetching a ptr will point to the correct address, and it won’t be freed between fetching and accessing.</li>
</ul>
</li>
</ol>
<h2 id="what-is-the-more-specific-difference-between-locks-and-latches"><a class="markdownIt-Anchor" href="#what-is-the-more-specific-difference-between-locks-and-latches"></a> What is the more specific difference between locks and latches?</h2>
<ol>
<li>What are they used to separate? What are they protecting? How long will they be held?
<ul>
<li>Locks separate user transactions accessing the same tuples in database contents. Locks are held in the entire transaction.</li>
<li>Latches are used to separate threads accessing the same in-memory data structures. Latches are held in the critical section.</li>
</ul>
</li>
<li>How many modes do they have?
<ul>
<li>Locks have four modes: shared, exclusive, update, and intention.</li>
<li>Latches only have two modes: read and write.</li>
</ul>
</li>
<li>How do they solve deadlock?
<ul>
<li>Locks use detection and resolution by waits-for, timeout, or abort.</li>
<li>Latches can only avoid deadlock by code discipline.</li>
</ul>
</li>
<li>Where are they kept?
<ul>
<li>Locks are kept in Lock Manager, while latches are kept in the protected data structure.</li>
</ul>
</li>
</ol>
<h2 id="what-are-the-two-latch-modes"><a class="markdownIt-Anchor" href="#what-are-the-two-latch-modes"></a> What are the two latch modes?</h2>
<ol>
<li>
<p>Read mode means that Multiple threads can read the same object simultaneously.</p>
<ul>
<li>A thread can acquire the read latch if another thread has it in read mode.</li>
</ul>
</li>
<li>
<p>Write mode only allows one thread to access the object.</p>
<ul>
<li>A thread cannot acquire a write latch if another thread has it in any mode.</li>
</ul>
</li>
<li>
<p>In the compatibility matrix, only two read mode access is allowed.</p>
</li>
</ol>
<h2 id="what-are-the-different-latch-implementations"><a class="markdownIt-Anchor" href="#what-are-the-different-latch-implementations"></a> What are the different latch implementations?</h2>
<ol>
<li>The first is blocking OS Mutex.
<ul>
<li>It is simple to use.</li>
<li>It takes about <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>25</mn><mtext> </mtext><mi>n</mi><mi>s</mi></mrow><annotation encoding="application/x-tex">25\ ns</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">2</span><span class="mord">5</span><span class="mspace"> </span><span class="mord mathnormal">n</span><span class="mord mathnormal">s</span></span></span></span> per lock/unlock invocation, which means that it is non-scalable.
<ul>
<li><code>std::mutex</code> is slower than <code>pthread_mutex,</code> and <code>futex</code> is faster than both.</li>
</ul>
</li>
<li><code>futex</code> stands for fast userspace mutex.
<ul>
<li>It has a userspace spinlock and a heavy-weight OS latch.</li>
<li>Threads will first try to acquire the userspace lock. If success, then that is good.</li>
<li>But if failed, the thread will fall back to the OS latch. OS takes control of the thread and when to schedule it, and DBMS can do nothing with it. Also, <code>syscall</code> is expensive.</li>
</ul>
</li>
</ul>
</li>
<li>The second approach is reader-writer latches.
<ul>
<li>It allows for concurrent readers. Must manage read/write queues to avoid starvation.</li>
<li>It can be implemented on top of spinlock.</li>
<li>Still, <code>std::shared_mutex</code> is slower than <code>pthread_rwlock</code>.</li>
</ul>
</li>
</ol>
<h1 id="latching-scheme"><a class="markdownIt-Anchor" href="#latching-scheme"></a> Latching scheme</h1>
<h2 id="hash-table-latching"><a class="markdownIt-Anchor" href="#hash-table-latching"></a> Hash table latching</h2>
<h3 id="why-are-deadlocks-not-possible-in-the-hash-table"><a class="markdownIt-Anchor" href="#why-are-deadlocks-not-possible-in-the-hash-table"></a> Why are deadlocks not possible in the hash table?</h3>
<ol>
<li>All threads move in the same direction and only access a single page/slot at a time.
<ul>
<li>Hence, no loops are waiting in this scenario.</li>
</ul>
</li>
<li>To resize the table, take a global write latch on the entire table.</li>
</ol>
<h3 id="how-can-we-design-hash-table-latching"><a class="markdownIt-Anchor" href="#how-can-we-design-hash-table-latching"></a> How can we design hash table latching?</h3>
<ol>
<li>The coarser-grain approach is to use page latches.
<ul>
<li>Each page has a reader-writer latch that protects its entire contents.</li>
</ul>
</li>
<li>The finer-grain approach is to use slot latches.
<ul>
<li>Each slot has its latch.</li>
<li>It can use a single-mode latch to reduce meta-data and computational overhead.</li>
</ul>
</li>
</ol>
<h2 id="btree-latching"><a class="markdownIt-Anchor" href="#btree-latching"></a> B+Tree latching</h2>
<h3 id="what-should-we-use-latching-to-prevent"><a class="markdownIt-Anchor" href="#what-should-we-use-latching-to-prevent"></a> What should we use latching to prevent?</h3>
<ol>
<li>Threads are trying to modify the contents of a node at the same time. (This is logical correctness, i.e., data race)</li>
<li>One thread traverses the tree while another thread splits/merges nodes.
<ul>
<li>This is physical correctness. Splitting/merging will cause free pointers, nodes, or in-node entries.</li>
<li>This will also cause a problem with logical correctness, i.e., false negative.
<ul>
<li>If a thread gets the pointer of the node that possesses the key it wants, then before it accesses the node, the key is borrowed by a sibling, causing the thread to think the key does not exist.</li>
</ul>
</li>
</ul>
</li>
<li>When introducing sibling pointers, we may have a deadlock situation.</li>
</ol>
<h3 id="how-should-we-achieve-physical-correctness"><a class="markdownIt-Anchor" href="#how-should-we-achieve-physical-correctness"></a> How should we achieve physical correctness?</h3>
<ol>
<li>The most naive method is to hold all locks until the entire process is done. But its performance is a disaster.
<ul>
<li>We must release some latches when we are sure they are safe.</li>
<li>According to our goal, a node is safe when we know that it won’t be changed (split, merged, or redistributed) when updated.</li>
<li>We can know a child is safe when its child is not full on insertion or more than half-full on deletion, i.e., any later operations can be isolated on or below its level.</li>
</ul>
</li>
<li>For find operation, there won’t be any updates. Hence, we can always unlatch the parent when we acquire an R latch on the child.</li>
<li>We need to obtain W latches as required for insert or delete operations. Once a child is latched, check if it is safe.
<ul>
<li>If the child is safe, we can release all latches on ancestors. The latches should be released from top to bottom to perform better.</li>
</ul>
</li>
</ol>
<h3 id="what-is-the-problem-with-the-aforementioned-strategy"><a class="markdownIt-Anchor" href="#what-is-the-problem-with-the-aforementioned-strategy"></a> What is the problem with the aforementioned strategy?</h3>
<ol>
<li>Every insert/delete operation will take a write latch on the root, which makes the root a bottleneck with higher concurrency.</li>
<li>We can assume that most modifications to a B+Tree will not require a split or merge.</li>
<li>Hence, optimistically traverse the tree using read latches instead of assuming that there will be a split/merge as aforementioned. If the guess is wrong, repeat traversal with the pessimistic algorithm.</li>
<li>For insert/delete operations, set latches as if for search, get to leaf, and set W latch on leaf. If the leaf is unsafe, release all latches and restart the thread using the previous insert/delete protocol with write latches.</li>
</ol>
<h3 id="when-will-a-deadlock-occur"><a class="markdownIt-Anchor" href="#when-will-a-deadlock-occur"></a> When will a deadlock occur?</h3>
<ol>
<li>With sibling pointers, we may move from one leaf node to another where deadlock could occur.</li>
<li>Latches cannot detect deadlock, so the only solution is to kill one thread.</li>
<li>The leaf node sibling latch acquisition protocol must support a “no-wait” mode. The DBMS’s data structures must cope with failed latch acquisitions.</li>
<li>Though some scenarios do not have a deadlock, the waiting thread cannot know what the other thread is doing, which means it can only kill itself to avoid deadlock.</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://liyun-zhang.github.io/2023/06/24/Courses/15445/04-Data-Organization/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LiyunZhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LiyunZhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LiyunZhang">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/06/24/Courses/15445/04-Data-Organization/" class="post-title-link" itemprop="url">04 Data Organization</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-06-24 17:12:22" itemprop="dateCreated datePublished" datetime="2023-06-24T17:12:22+08:00">2023-06-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-03-16 14:17:41" itemprop="dateModified" datetime="2024-03-16T14:17:41+08:00">2024-03-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Open-Courses/" itemprop="url" rel="index"><span itemprop="name">Open Courses</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Open-Courses/CMU-15-445-645-Database-System/" itemprop="url" rel="index"><span itemprop="name">CMU 15-445/645 Database System</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><ul class="markdownIt-TOC">
<li><a href="#what-does-the-database-access-methods-layer-need-to-do">What does the database access methods layer need to do?</a></li>
<li><a href="#hash-table">Hash table</a>
<ul>
<li><a href="#how-is-the-naive-static-hash-table">How is the naive static hash table?</a></li>
<li><a href="#what-are-hash-functions">What are hash functions?</a></li>
<li><a href="#static-hashing-schemes">Static hashing schemes</a>
<ul>
<li><a href="#how-is-linear-probe-hashing">How is linear probe hashing?</a></li>
<li><a href="#how-to-solve-the-non-unique-keys-problem">How to solve the non-unique keys problem?</a></li>
<li><a href="#how-is-the-robin-hood-hashing">How is the Robin Hood hashing?</a></li>
<li><a href="#how-is-the-cuckoo-hashing">How is the cuckoo hashing?</a></li>
</ul>
</li>
<li><a href="#dynamic-hashing-schemes">Dynamic hashing schemes</a>
<ul>
<li><a href="#how-is-chained-hashing">How is chained hashing?</a></li>
<li><a href="#how-is-extendible-hashing">How is extendible hashing?</a></li>
<li><a href="#how-is-linear-hashing">How is linear hashing?</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#tree">Tree</a>
<ul>
<li><a href="#table-indexes">Table indexes</a>
<ul>
<li><a href="#what-do-table-indexes-do">What do table indexes do?</a></li>
<li><a href="#what-are-clustered-indexes">What are clustered indexes?</a></li>
</ul>
</li>
<li><a href="#basic-b-tree">Basic B+ Tree</a>
<ul>
<li><a href="#what-is-a-b-tree">What is a B+ Tree?</a></li>
<li><a href="#how-are-keyvalue-pairs-stored-in-each-node">How are key/value pairs stored in each node?</a></li>
<li><a href="#what-is-stored-in-the-leaf-node">What is stored in the leaf node?</a></li>
<li><a href="#what-are-the-pros-and-cons-of-b-tree-compared-with-btree">What are the pros and cons of B-Tree compared with B+Tree?</a></li>
<li><a href="#how-does-btree-insert-a-node">How does B+Tree insert a node?</a></li>
<li><a href="#how-does-btree-delete-a-node">How does B+Tree delete a node?</a></li>
</ul>
</li>
<li><a href="#btree-usage-and-design">B+Tree usage and design</a>
<ul>
<li><a href="#how-does-dbms-use-btree-in-the-selection-query">How does DBMS use B+Tree in the selection query?</a></li>
<li><a href="#how-to-handle-duplicate-keys">How to handle duplicate keys?</a></li>
<li><a href="#how-to-solve-redundant-page-jumps-when-sequential-access-leaf-nodes">How to solve redundant page jumps when sequential access leaf nodes?</a></li>
<li><a href="#how-to-choose-node-size">How to choose node size?</a></li>
<li><a href="#how-to-choose-a-merge-threshold">How to choose a merge threshold?</a></li>
<li><a href="#how-to-handle-variable-length-keys">How to handle variable length keys?</a></li>
<li><a href="#how-can-we-do-the-intra-node-search">How can we do the intra-node search?</a></li>
<li><a href="#how-can-we-optimize-space-usage">How can we optimize space usage?</a></li>
<li><a href="#how-can-we-optimize-consumed-time">How can we optimize consumed time?</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</p>
<h1 id="what-does-the-database-access-methods-layer-need-to-do"><a class="markdownIt-Anchor" href="#what-does-the-database-access-methods-layer-need-to-do"></a> What does the database access methods layer need to do?</h1>
<ol>
<li>
<p>Data Organization</p>
<ul>
<li>How do we layout data structure in memory/pages, and what information should be stored to support efficient access?</li>
<li>This layer will organize all kinds of data inside the database, e.g., internal meta-data, core data storage, temporary data structures, and table indexes.</li>
</ul>
</li>
<li>
<p>Concurrency</p>
<ul>
<li>How can multiple threads be enabled to access the data structure simultaneously without causing problems?</li>
</ul>
</li>
<li>
<p>There are two types of data structures: hash tables and trees.</p>
</li>
</ol>
<h1 id="hash-table"><a class="markdownIt-Anchor" href="#hash-table"></a> Hash table</h1>
<h2 id="how-is-the-naive-static-hash-table"><a class="markdownIt-Anchor" href="#how-is-the-naive-static-hash-table"></a> How is the naive static hash table?</h2>
<ol>
<li>
<p>A hash table implements an unordered associative array that maps keys to values.</p>
</li>
<li>
<p>For any input key, hash functions return an integer representation.</p>
</li>
<li>
<p>The space complexity is <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span>, the average time complexity is <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span></span></span></span> and the worst time complexity is <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span>.</p>
<ul>
<li>Databases need to be about constants. For time complexity, smaller constants can save much time in billions of operations.</li>
<li>The space will be several times larger than the number of keys.</li>
</ul>
</li>
<li>
<p>The naive static hash table assumes:</p>
<ul>
<li>The number of elements is known ahead of time and fixed.</li>
<li>Each key is unique.</li>
<li>We have the perfect hash function where two keys must have different hash values.</li>
</ul>
</li>
<li>
<p>These assumptions are not always satisfied.</p>
<ul>
<li>
<p>We need a dynamic hashing scheme to suit when the first assumption fails.</p>
</li>
<li>
<p>To suit when the last two assumptions failed, we need to design a more delicate hash function to reduce the collision rate and hashing scheme to handle collisions after hashing.</p>
<ul>
<li>
<p>The trade-off of the hash function is between being fast and collision rate.</p>
</li>
<li>
<p>The trade-off of the hashing scheme is between allocating a larger hash table and additional instructions to get/put keys.</p>
</li>
</ul>
</li>
</ul>
</li>
</ol>
<h2 id="what-are-hash-functions"><a class="markdownIt-Anchor" href="#what-are-hash-functions"></a> What are hash functions?</h2>
<ol>
<li>
<p>We do not want to use a cryptographic hash function for DBMS hash tables, e.g., SHA-2.</p>
<ul>
<li>Because this hashing is only used internally, we will never worry about leaking keys.</li>
<li>We want something that is fast and has a low collision rate.</li>
</ul>
</li>
<li>
<p>The commonly used hash functions are:</p>
<ul>
<li>CRC-64: Used in networking for error detection.</li>
<li>MurmurHash: Designed as a fast, general-purpose hash function.</li>
<li>Google CityHash: Designed to be faster for short keys (&lt;64 bytes).</li>
<li>Facebook XXHash: From the creator of zstd compression, the state-of-the-art.</li>
<li>Google Farmhash: A newer version of CityHash with better collision rates.</li>
</ul>
</li>
<li>
<p>Their speed comparison is as follows:</p>
<img src="/imgs/15445/Organization/hash_func.png" width="75%">
</li>
</ol>
<h2 id="static-hashing-schemes"><a class="markdownIt-Anchor" href="#static-hashing-schemes"></a> Static hashing schemes</h2>
<h3 id="how-is-linear-probe-hashing"><a class="markdownIt-Anchor" href="#how-is-linear-probe-hashing"></a> How is linear probe hashing?</h3>
<ol>
<li>A key-value pair is stored in the hashing table for all the schemes. The key is determining whether this is the key we want to find.</li>
<li>It resolves collisions by linearly searching for the next free slot in the table.</li>
<li>To determine whether an element is present, hash to a location in the index and scan for it. If an empty slot is found before the key, the element does not exist.</li>
<li>To delete an entry, there are two approaches:
<ul>
<li><strong>Movement</strong>: Rehash the remaining keys until find the first empty slot. Nobody does this.</li>
<li><strong>Tombstone</strong>: Set a marker to indicate that the entry in the slot is logically deleted. The slot can be reused for new keys. This may still need periodic garbage collection.</li>
</ul>
</li>
</ol>
<h3 id="how-to-solve-the-non-unique-keys-problem"><a class="markdownIt-Anchor" href="#how-to-solve-the-non-unique-keys-problem"></a> How to solve the non-unique keys problem?</h3>
<ol>
<li>The first choice is to store values in separate storage areas for each key, and the value of the hash table points to the area.</li>
<li>The second choice is storing duplicate key entries in the hash table.
<ul>
<li>Read would return the first key they found.</li>
<li>Deletes would remove all the keys or a specific key-value pair.</li>
</ul>
</li>
</ol>
<h3 id="how-is-the-robin-hood-hashing"><a class="markdownIt-Anchor" href="#how-is-the-robin-hood-hashing"></a> How is the Robin Hood hashing?</h3>
<ol>
<li>This variant of linear probe hashing steals slots from “rich” keys and gives them to “poor” keys.
<ul>
<li>Each key tracks the number of positions they are from where its optimal position (original hash value) is in the table.</li>
<li>The keys farther away from their optimal position are poorer, while the keys closer are richer.</li>
<li>On insert, a key takes the slot of another key if the first key is “richer” than the second key. And the second key will keep searching linearly until it finds another “richer” key.</li>
</ul>
</li>
<li>Stealing increases the number of writing operations compared with the linear probing scheme while reducing the time of the worst case.</li>
<li>This could have cascading/flooding problems where one inserts causes multiple “stealing.” Also, it does not consider the possibility of having hotkeys.</li>
</ol>
<h3 id="how-is-the-cuckoo-hashing"><a class="markdownIt-Anchor" href="#how-is-the-cuckoo-hashing"></a> How is the cuckoo hashing?</h3>
<ol>
<li>Use multiple hash tables with different hash function seeds to ensure they won’t hash to the same value.
<ul>
<li>On insert, check every table and pick anyone with a free slot.</li>
<li>If no table has a free slot, choose one victim, evict it, and then re-hash it to find a new location.</li>
</ul>
</li>
<li>Look-ups and deletions are always <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span></span></span></span> because only one location per hash table is checked.</li>
<li>There is a possibility of cascading. The worst case is an infinite cascading loop.
<ul>
<li>We can use extra code to detect if replacing is going in a loop. If so, we must double the hash table size with new hash functions and re-insert all keys.</li>
</ul>
</li>
</ol>
<h2 id="dynamic-hashing-schemes"><a class="markdownIt-Anchor" href="#dynamic-hashing-schemes"></a> Dynamic hashing schemes</h2>
<h3 id="how-is-chained-hashing"><a class="markdownIt-Anchor" href="#how-is-chained-hashing"></a> How is chained hashing?</h3>
<ol>
<li>It maintains a linked list of buckets for each slot in the hash table.</li>
<li>Resolve collisions by placing all elements with the same hash key into the same bucket.
<ul>
<li>To determine whether an element is present, hash to its bucket and scan for it.</li>
</ul>
</li>
<li>The problem is that the linked list can grow forever, causing the time spent on search to increase as the system runs.</li>
</ol>
<h3 id="how-is-extendible-hashing"><a class="markdownIt-Anchor" href="#how-is-extendible-hashing"></a> How is extendible hashing?</h3>
<ol>
<li>Multiple slot locations can point to the same bucket chain.</li>
<li>For the number of bits that need to be examined, there is a global and a local one.</li>
<li>It reshuffles bucket entries on split and increases the number of bits to examine when a list is full.
<ul>
<li>If there is only one slot pointing to this list, i.e., the global examining bits are the same as the local one,
<ul>
<li>The DBMS increases the global number, causing the size of the hashing table doubled.</li>
<li>Those lists with smaller local numbers will still set the pointers of corresponding new slots (with only the last global examining bit different) to themselves.</li>
<li>DBMS also increases the number of local examining bits on the fulled list. The keys in it will re-hash to their two new lists.</li>
</ul>
</li>
<li>If more than one slot is pointing to this list, i.e., the global examining bits are larger than the local one,
<ul>
<li>The DBMS only increases the local examining bits of the full list and does the re-hashing.</li>
</ul>
</li>
</ul>
</li>
</ol>
<h3 id="how-is-linear-hashing"><a class="markdownIt-Anchor" href="#how-is-linear-hashing"></a> How is linear hashing?</h3>
<ol>
<li>It is similar to extensible hashing. But the hash table maintains a pointer that tracks the next bucket to split.</li>
<li>When any bucket overflows, split the bucket at the pointer location.
<ul>
<li>When the split causes the number of slots in the hash table to double, it introduces a new hash function, taking modulo with the new hash table size.</li>
</ul>
</li>
<li>It uses multiple hashes to find the right bucket for a given key.
<ul>
<li>It always first uses the old hash function with a smaller modulus.</li>
<li>If this hash value is smaller than the split pointer, which means that this slot has already been split, DBMS needs to use the new hash function to find the true hash value.</li>
<li>Otherwise, this slot is not split, and the old hash value works fine.</li>
</ul>
</li>
<li>Splitting buckets based on the split pointer will eventually get to all overflowed buckets.
<ul>
<li>When the pointer reaches the last slot, delete the first hash function and return to the beginning.</li>
</ul>
</li>
<li>Deleting may cause the size of the hash table to shrink when it deletes the only entry in the second half of the hash table.
<ul>
<li>DMBS shrinks the size of the hash table and deletes the new hash function.</li>
</ul>
</li>
</ol>
<h1 id="tree"><a class="markdownIt-Anchor" href="#tree"></a> Tree</h1>
<h2 id="table-indexes"><a class="markdownIt-Anchor" href="#table-indexes"></a> Table indexes</h2>
<h3 id="what-do-table-indexes-do"><a class="markdownIt-Anchor" href="#what-do-table-indexes-do"></a> What do table indexes do?</h3>
<ol>
<li>A table index is a replica of a subset of a table’s attributes organized and sorted for efficient access using those attributes.</li>
<li>It is used in queries to find tuples with attributes that match certain values.</li>
<li>The DBMS ensures that the contents of the table and the index are logically synchronized.</li>
<li>The DBMS’s job is to figure out the best index(es) to execute each query.</li>
<li>There is a trade-off regarding the number of indexes to create per database, i.e., the lookup speed and synchronization overhead.
<ul>
<li>We need extra storage overhead to store the data structure and maintenance overhead to keep synchronization.</li>
</ul>
</li>
</ol>
<h3 id="what-are-clustered-indexes"><a class="markdownIt-Anchor" href="#what-are-clustered-indexes"></a> What are clustered indexes?</h3>
<ol>
<li>The table is stored in the sort order specified by the primary key.
<ul>
<li>It can be either heap- or index-organized storage.</li>
</ul>
</li>
<li>Some DBMSs always use a clustered index. If a table does not contain a primary key, the DBMS will<br />
automatically make a hidden primary key.</li>
<li>Other DBMSs cannot use them at all.</li>
</ol>
<h2 id="basic-b-tree"><a class="markdownIt-Anchor" href="#basic-b-tree"></a> Basic B+ Tree</h2>
<h3 id="what-is-a-b-tree"><a class="markdownIt-Anchor" href="#what-is-a-b-tree"></a> What is a B+ Tree?</h3>
<ol>
<li>A B+Tree is a self-balancing tree data structure that keeps data sorted and allows searches, sequential access, insertions, and deletions always in <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>log</mi><mo>⁡</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(\log n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span>.</li>
<li>A B+ tree is an M-way search tree.
<ul>
<li>It is perfectly balanced, i.e., every leaf node is at the same depth in the tree.</li>
<li>Every node other than the root is at least half-full, i.e., <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mi mathvariant="normal">/</mi><mn>2</mn><mo>−</mo><mn>1</mn><mo>≤</mo><mi>n</mi><mi>u</mi><mi>m</mi><mi>b</mi><mi>e</mi><mi>r</mi><mtext> </mtext><mi>o</mi><mi>f</mi><mtext> </mtext><mi>k</mi><mi>e</mi><mi>y</mi><mi>s</mi><mo>≤</mo><mi>M</mi><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">M/2-1 ≤ number\ of\ keys ≤ M-1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mord">/</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.78041em;vertical-align:-0.13597em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">n</span><span class="mord mathnormal">u</span><span class="mord mathnormal">m</span><span class="mord mathnormal">b</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mspace"> </span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mspace"> </span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mord mathnormal">s</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>.</li>
<li>Every inner node with <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> keys has <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">k+1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.77777em;vertical-align:-0.08333em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span> non-null children.</li>
</ul>
</li>
</ol>
<h3 id="how-are-keyvalue-pairs-stored-in-each-node"><a class="markdownIt-Anchor" href="#how-are-keyvalue-pairs-stored-in-each-node"></a> How are key/value pairs stored in each node?</h3>
<ol>
<li>Every B+Tree node is comprised of an array of key/value pairs.</li>
<li>The keys are derived from the attribute(s) on which the index is based.</li>
<li>The value stored in an inner node is a pointer to its corresponding children, while the value stored in a leaf node is its specific value.</li>
<li>There are two storage methods for the key-value pair.
<ul>
<li>One is to store them consecutively, i.e., each value is stored immediately after its key.</li>
<li>The other is to store them in the same place in two arrays, i.e., each value has the same index as its key.</li>
</ul>
</li>
<li>The arrays are (usually) kept in sorted key order.</li>
</ol>
<h3 id="what-is-stored-in-the-leaf-node"><a class="markdownIt-Anchor" href="#what-is-stored-in-the-leaf-node"></a> What is stored in the leaf node?</h3>
<ol>
<li>
<p>Each leaf node also has pointers that point to its siblings.</p>
</li>
<li>
<p>There are two approaches to store the values:</p>
<ul>
<li>The first approach is to store them with record IDs, a pointer to the page ID, and an offset of the tuple to which the index entry corresponds.</li>
<li>The second approach is to store them with tuple data, specifically primary keys.</li>
</ul>
</li>
<li>
<p>The pros of the second approach are that we do not need to access another address to fetch the contents when primary keys are all we want.</p>
<p>However, secondary indexes must store the Record ID as their value. Hence, if we want secondary indexes in the second approach, we must look up other tables to find the Record ID with the same primary keys.</p>
</li>
</ol>
<h3 id="what-are-the-pros-and-cons-of-b-tree-compared-with-btree"><a class="markdownIt-Anchor" href="#what-are-the-pros-and-cons-of-b-tree-compared-with-btree"></a> What are the pros and cons of B-Tree compared with B+Tree?</h3>
<ol>
<li>The main difference is that  B-Tree stores keys and values in all nodes in the tree, while B+Tree only stores values in leaf nodes. Inner nodes only guide the search process.</li>
<li>B-Tree is more space-efficient since each key only appears once in the tree.</li>
<li>However, B-Tree needs to jump between pages when we want sequential access keys, causing much more I/O.</li>
</ol>
<h3 id="how-does-btree-insert-a-node"><a class="markdownIt-Anchor" href="#how-does-btree-insert-a-node"></a> How does B+Tree insert a node?</h3>
<ol>
<li>Find correct leaf node L. Insert data entry into L in sorted order.</li>
<li>If L has enough space, then it is done.</li>
<li>Otherwise, split L keys into L and a new node L2. Insert the index entry pointing to L2 into the parent of L.
<ul>
<li>The parent of L may need to be rebalanced after this insertion.</li>
</ul>
</li>
</ol>
<h3 id="how-does-btree-delete-a-node"><a class="markdownIt-Anchor" href="#how-does-btree-delete-a-node"></a> How does B+Tree delete a node?</h3>
<ol>
<li>Start at the root and find leaf L, where the entry belongs. Remove the entry.</li>
<li>If L is at least half-full, then it is done.</li>
<li>If L has only M/2-1 entries,
<ul>
<li>First, try to re-distribute, borrowing from siblings.</li>
<li>If re-distribution fails, merge L and sibling and delete the entry (pointing to L or sibling) from the parent of L.
<ul>
<li>The parent of L may need a rebalance.</li>
</ul>
</li>
</ul>
</li>
</ol>
<h2 id="btree-usage-and-design"><a class="markdownIt-Anchor" href="#btree-usage-and-design"></a> B+Tree usage and design</h2>
<h3 id="how-does-dbms-use-btree-in-the-selection-query"><a class="markdownIt-Anchor" href="#how-does-dbms-use-btree-in-the-selection-query"></a> How does DBMS use B+Tree in the selection query?</h3>
<ol>
<li>
<p>When creating an index, a certain attribute order is specified to sort the tuple.</p>
<ul>
<li>
<p>When <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>A</mi><mn>1</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>A</mi><mi>n</mi></msub></mrow><annotation encoding="application/x-tex">A_1, \dots,A_n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> are specified, the B+Tree will store the corresponding <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">n</span></span></span></span> values in as keys in each node.</p>
</li>
<li>
<p>When <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mn>1</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>a</mi><mi>n</mi></msub></mrow><annotation encoding="application/x-tex">a_1, \dots,a_n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> are stored in one node, all nodes in its left sub-tree have <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>A</mi><mn>1</mn></msub><mo>≤</mo><msub><mi>a</mi><mn>1</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>A</mi><mi>n</mi></msub><mo>≤</mo><msub><mi>a</mi><mi>n</mi></msub></mrow><annotation encoding="application/x-tex">A_1≤a_1,\dots,A_n≤a_n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> while all nodes in its right sub-tree are only guaranteed with <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>A</mi><mn>1</mn></msub><mo>&gt;</mo><msub><mi>a</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">A_1 &gt; a_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>, i.e., the B+Tree is maintained with <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>A</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">A_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> as its primary sorting key.</p>
</li>
</ul>
</li>
<li>
<p>In a selection condition, we can easily select with certain conditions on <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>A</mi><mn>1</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>A</mi><mi>k</mi></msub><mtext> </mtext><mo stretchy="false">(</mo><mi>k</mi><mo>≤</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">A_1,\dots,A_k\ (k≤n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace"> </span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span>. Some DBMS also support conditions specified only on <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>A</mi><mi>k</mi></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>A</mi><mi>n</mi></msub></mrow><annotation encoding="application/x-tex">A_k, \dots,A_n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>, which requires DBMS to access all leaf nodes sequentially.</p>
</li>
<li>
<p>Compared with the hash table, B+Tree can better support selection without knowing the attributes to look for.</p>
</li>
</ol>
<h3 id="how-to-handle-duplicate-keys"><a class="markdownIt-Anchor" href="#how-to-handle-duplicate-keys"></a> How to handle duplicate keys?</h3>
<ol>
<li>The first approach is to add the tuple’s unique Record ID as part of the key to ensure all keys are unique.
<ul>
<li>The DBMS can still use partial keys to find tuples.</li>
</ul>
</li>
<li>The second approach is allowing leaf nodes to spill into overflow nodes containing duplicate keys.
<ul>
<li>Only duplicate keys of existing keys can overflow.</li>
<li>Overflow nodes also need to split or merge when splitting or merging nodes.</li>
<li>This is more complex to maintain and modify.</li>
</ul>
</li>
</ol>
<h3 id="how-to-solve-redundant-page-jumps-when-sequential-access-leaf-nodes"><a class="markdownIt-Anchor" href="#how-to-solve-redundant-page-jumps-when-sequential-access-leaf-nodes"></a> How to solve redundant page jumps when sequential access leaf nodes?</h3>
<ol>
<li>In a clustered B+Tree, nodes on the same page are in consecutive order.
<ul>
<li>We can traverse the left-most leaf page and retrieve tuples from all leaf pages.</li>
<li>This will always be better than sorting data for each query.</li>
</ul>
</li>
<li>In a non-clustered B+Tree, the DBMS can first figure out all the tuples it needs and then sort them based on their Page ID.</li>
</ol>
<h3 id="how-to-choose-node-size"><a class="markdownIt-Anchor" href="#how-to-choose-node-size"></a> How to choose node size?</h3>
<ol>
<li>The slower the storage device, the larger the optimal node size for a B+Tree.
<ul>
<li>HDD takes <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mtext> </mtext><mi>M</mi><mi>B</mi></mrow><annotation encoding="application/x-tex">1\ MB</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord">1</span><span class="mspace"> </span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span>, SSD usually takes <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>10</mn><mtext> </mtext><mi>K</mi><mi>B</mi></mrow><annotation encoding="application/x-tex">10\ KB</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord">0</span><span class="mspace"> </span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span>, in-memory nodes have <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>512</mn><mtext> </mtext><mi>B</mi></mrow><annotation encoding="application/x-tex">512\ B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord">5</span><span class="mord">1</span><span class="mord">2</span><span class="mspace"> </span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span>.</li>
</ul>
</li>
<li>Optimal sizes can vary depending on the workload. The trade-off is between leaf node scans and root-to-leaf traversals.
<ul>
<li>With a larger size, we can have more sequential reads in leaf node scans, but we need to read more data in root-to-leaf traversals.</li>
</ul>
</li>
</ol>
<h3 id="how-to-choose-a-merge-threshold"><a class="markdownIt-Anchor" href="#how-to-choose-a-merge-threshold"></a> How to choose a merge threshold?</h3>
<ol>
<li>Some DBMSs do not always merge nodes when they are half full.</li>
<li>Delaying a merge operation may reduce the amount of reorganization. They assume that the missing part will be filled soon.</li>
<li>Having smaller nodes exist and periodically rebuilding the entire tree may also be better.</li>
</ol>
<h3 id="how-to-handle-variable-length-keys"><a class="markdownIt-Anchor" href="#how-to-handle-variable-length-keys"></a> How to handle variable length keys?</h3>
<ol>
<li>The first approach is to store the keys as pointers to the tuple’s attribute.</li>
<li>The second approach is to allow variable-length nodes. It requires careful memory management.</li>
<li>The third approach is always to pad the key to the max length of the key type.</li>
<li>The last approach is a key map or indirection. It is similar to the in-node dictionary.</li>
</ol>
<h3 id="how-can-we-do-the-intra-node-search"><a class="markdownIt-Anchor" href="#how-can-we-do-the-intra-node-search"></a> How can we do the intra-node search?</h3>
<ol>
<li>The naive method is linear search. We can use SIMD to vectorize the process.</li>
<li>The second method is binary search, given that keys in a node are already sorted.</li>
<li>The third method is interpolation search.
<ul>
<li>This requires a known distribution of keys.</li>
<li>It jumps to the approximate location of the desired key based on known distribution.</li>
</ul>
</li>
</ol>
<h3 id="how-can-we-optimize-space-usage"><a class="markdownIt-Anchor" href="#how-can-we-optimize-space-usage"></a> How can we optimize space usage?</h3>
<ol>
<li>Prefix compression
<ul>
<li>Sorted keys in the same leaf node will likely have the same prefix.</li>
<li>Extract common prefixes and store only a unique suffix for each key.</li>
</ul>
</li>
<li>Deduplication
<ul>
<li>Non-unique indexes can end up storing multiple copies of the same key in leaf nodes.</li>
<li>Store the key once and then maintain a list of tuples with that key.</li>
</ul>
</li>
<li>Suffix truncation
<ul>
<li>The keys in the inner nodes are only used to “direct traffic.” We don’t need the entire key.</li>
<li>Store a minimum prefix needed to route probes into the index correctly.</li>
</ul>
</li>
</ol>
<h3 id="how-can-we-optimize-consumed-time"><a class="markdownIt-Anchor" href="#how-can-we-optimize-consumed-time"></a> How can we optimize consumed time?</h3>
<ol>
<li>Pointer swizzling
<ul>
<li>Nodes use page IDs to reference other nodes in the index. The DBMS must get the memory location from the page table during traversal.</li>
<li>If a page is pinned in the buffer pool, we can store raw pointers instead of page IDs. This avoids address lookups from the page table.</li>
</ul>
</li>
<li>Bulk insert
<ul>
<li>The fastest way to build a new B+Tree for an existing table is first to sort the keys and then build the index from the bottom up.</li>
</ul>
</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://liyun-zhang.github.io/2023/06/24/Courses/15445/03-Buffer-Pool-Manage/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LiyunZhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LiyunZhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LiyunZhang">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/06/24/Courses/15445/03-Buffer-Pool-Manage/" class="post-title-link" itemprop="url">03 Buffer Pool Manage</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-06-24 17:12:13" itemprop="dateCreated datePublished" datetime="2023-06-24T17:12:13+08:00">2023-06-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-03-16 13:58:29" itemprop="dateModified" datetime="2024-03-16T13:58:29+08:00">2024-03-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Open-Courses/" itemprop="url" rel="index"><span itemprop="name">Open Courses</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Open-Courses/CMU-15-445-645-Database-System/" itemprop="url" rel="index"><span itemprop="name">CMU 15-445/645 Database System</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><ul class="markdownIt-TOC">
<li><a href="#buffer-pool-manage">Buffer pool manage</a>
<ul>
<li><a href="#what-does-the-databse-storage-need-to-control">What does the databse storage need to control?</a></li>
<li><a href="#how-is-the-buffer-pool-organized">How is the buffer pool organized?</a></li>
<li><a href="#clarification-what-are-the-locks-and-latches-referenced-in-the-database">Clarification: What are the locks and latches referenced in the database?</a></li>
<li><a href="#how-can-we-optimize-performance-with-multiple-buffer-pools">How can we optimize performance with multiple buffer pools?</a></li>
<li><a href="#how-can-we-optimize-performance-with-pre-fetching">How can we optimize performance with pre-fetching?</a></li>
<li><a href="#how-can-we-optimize-performance-with-scan-sharing">How can we optimize performance with scan sharing?</a></li>
<li><a href="#how-can-we-optimize-performance-with-buffer-pool-bypass">How can we optimize performance with buffer pool bypass?</a></li>
<li><a href="#should-we-use-the-os-page-cache">Should we use the OS page cache?</a></li>
</ul>
</li>
<li><a href="#buffer-replacement-policies">Buffer replacement policies</a>
<ul>
<li><a href="#what-is-the-lru-least-recently-used-policy-and-clock-policy">What is the LRU (Least-Recently Used) policy and clock policy?</a></li>
<li><a href="#what-is-the-problem-with-lru-and-the-clock-and-how-can-it-be-alleviated">What is the problem with LRU and the clock, and how can it be alleviated?</a></li>
<li><a href="#how-do-we-deal-with-evicted-pages">How do we deal with evicted pages?</a></li>
</ul>
</li>
</ul>
</p>
<h1 id="buffer-pool-manage"><a class="markdownIt-Anchor" href="#buffer-pool-manage"></a> Buffer pool manage</h1>
<h2 id="what-does-the-databse-storage-need-to-control"><a class="markdownIt-Anchor" href="#what-does-the-databse-storage-need-to-control"></a> What does the databse storage need to control?</h2>
<ol>
<li>Spatial Control: Where to write pages on disk.
<ul>
<li>The goal is to keep pages that are used together often as physically close together as possible on disk.</li>
</ul>
</li>
<li>Temporal Control: When to read pages into memory and write them to disk.
<ul>
<li>The goal is to minimize the number of stalls from having to read data from a disk.</li>
</ul>
</li>
</ol>
<h2 id="how-is-the-buffer-pool-organized"><a class="markdownIt-Anchor" href="#how-is-the-buffer-pool-organized"></a> How is the buffer pool organized?</h2>
<ol>
<li>The memory region is organized as an array of fixed-size pages. An array entry is called a <strong>frame</strong>.
<ul>
<li>Pages are on disk, while frames are on memory.</li>
</ul>
</li>
<li>When the DBMS requests a page, an exact copy is placed into one of these frames.</li>
<li>The buffer pool manager needs to maintain a <strong>page table</strong> to track pages currently in memory.
<ul>
<li>The page table maps from page IDs to a copy of the page in buffer pool frames.
<ul>
<li>This in-memory data structure does not need to be stored on disk.</li>
</ul>
</li>
<li>The page directory maps from page IDs to page locations in the database files.
<ul>
<li>All changes must be recorded on disk to allow the DBMS to find on restart.</li>
</ul>
</li>
</ul>
</li>
<li>Some additional meta-data per page also need to be maintained:
<ul>
<li><strong>Dirty flag</strong>: Mark whether a page has been modified to show whether can safely evict this page.</li>
<li><strong>Pin/reference counter</strong>: Some queries use it to prevent the buffer pool manager from evicting this page. They unpinned this page after no longer using it.</li>
<li><strong>Latches</strong>: This can be used to pre-occupy an entry in the page table and release the latch after copying that page and updating the entry.</li>
<li>These meta-data can either be stored in a page or page table.</li>
</ul>
</li>
</ol>
<h2 id="clarification-what-are-the-locks-and-latches-referenced-in-the-database"><a class="markdownIt-Anchor" href="#clarification-what-are-the-locks-and-latches-referenced-in-the-database"></a> Clarification: What are the locks and latches referenced in the database?</h2>
<ol>
<li>Locks:
<ul>
<li>It protects the database’s logical contents from other transactions.</li>
<li>It is held for transaction duration. Need to be able to rollback changes.</li>
<li>Locks can be taken on a tuple or table but not on a page.</li>
</ul>
</li>
<li>Latches:
<ul>
<li>It protects the critical sections of the DBMS’s internal data structure from other threads.</li>
<li>It is held for operation duration. Do not need to be able to rollback changes.</li>
<li>This is similar to the mutex provided by OS.</li>
</ul>
</li>
</ol>
<h2 id="how-can-we-optimize-performance-with-multiple-buffer-pools"><a class="markdownIt-Anchor" href="#how-can-we-optimize-performance-with-multiple-buffer-pools"></a> How can we optimize performance with multiple buffer pools?</h2>
<ol>
<li>Advantages:
<ul>
<li>The different pools can have different eviction policies to improve locality.</li>
<li>Each time accessing the meta-data of each buffer pool needs to take a latch. Multiple buffer pools can reduce latch contention.</li>
</ul>
</li>
<li>The manager can use a per-database buffer pool, per-page type buffer pool, or per-index type buffer pool.</li>
<li>Managers decide which pool to store pages in two approaches:
<ul>
<li>The first is to embed an object identifier in record IDs and then maintain a mapping from objects to specific buffer pools.
<ul>
<li>This can be used to specify certain pages must be stored in a specific pool.</li>
</ul>
</li>
<li>The other is to hash the page ID to select which buffer pool to access.</li>
</ul>
</li>
</ol>
<h2 id="how-can-we-optimize-performance-with-pre-fetching"><a class="markdownIt-Anchor" href="#how-can-we-optimize-performance-with-pre-fetching"></a> How can we optimize performance with pre-fetching?</h2>
<ol>
<li>Pre-fetching can be easily used in two situations: sequential scans and index scans.</li>
<li>In sequential scans, when the manager fetches the first few consecutive pages, it can be inferred that the following consecutive pages will be used soon and pre-fetched into memory.</li>
<li>The query may not access consecutive pages in index scans, but DBMS sees the B+ tree structure and thus knows where the following indices are.</li>
</ol>
<h2 id="how-can-we-optimize-performance-with-scan-sharing"><a class="markdownIt-Anchor" href="#how-can-we-optimize-performance-with-scan-sharing"></a> How can we optimize performance with scan sharing?</h2>
<ol>
<li>It allows multiple queries to attach to a single cursor that scans a table.
<ul>
<li>The queries do not have to be the same.</li>
<li>They can also share intermediate results.</li>
</ul>
</li>
<li>If a query wants to scan a table and another query is already doing this, the DBMS will attach the second query’s cursor to the existing cursor.</li>
<li>After the earlier query is finished, the later query will return to read the pages the earlier one already read before the later one begins.</li>
<li>If the later query has a <code>LIMIT</code> clause without WHERE or ORDER BY clause, given that the relation is unordered, it may not need to read extra data if those scan-sharing data are enough to satisfy the <code>LIMIT</code> clause.</li>
</ol>
<h2 id="how-can-we-optimize-performance-with-buffer-pool-bypass"><a class="markdownIt-Anchor" href="#how-can-we-optimize-performance-with-buffer-pool-bypass"></a> How can we optimize performance with buffer pool bypass?</h2>
<ol>
<li>Sequential flooding: A query performs a sequential scan that reads every page.
<ul>
<li>This pollutes the buffer pool with pages that are read once and never again.</li>
</ul>
</li>
<li>Buffer pool bypass will not store fetched pages in the buffer pool. Insteach, the manager has a private pool where those pages will be stored temporarily and deleted once finished.</li>
<li>It works well if the operator needs to read a large sequence of contiguous pages on disk. It can also be used for temporary data (sorting, joins).</li>
</ol>
<h2 id="should-we-use-the-os-page-cache"><a class="markdownIt-Anchor" href="#should-we-use-the-os-page-cache"></a> Should we use the OS page cache?</h2>
<ol>
<li>Most disk operations go through the OS API. Unless the DBMS tells it not to, the OS maintains its filesystem cache.</li>
<li>Most DBMSs bypass the OS’s cache by using direct I/O (O_DIRECT).</li>
<li>The OS page cache can cause redundant copies of pages. OS and DBMS have different eviction policies, causing DBMS to lose control over file I/O.</li>
</ol>
<h1 id="buffer-replacement-policies"><a class="markdownIt-Anchor" href="#buffer-replacement-policies"></a> Buffer replacement policies</h1>
<h2 id="what-is-the-lru-least-recently-used-policy-and-clock-policy"><a class="markdownIt-Anchor" href="#what-is-the-lru-least-recently-used-policy-and-clock-policy"></a> What is the LRU (Least-Recently Used) policy and clock policy?</h2>
<ol>
<li>Managers maintain a single timestamp of when each page was last accessed.</li>
<li>When the DBMS needs to evict a page, select the one with the oldest timestamp.
<ul>
<li>It can keep the pages in sorted order to reduce the search time on eviction.</li>
</ul>
</li>
<li>An approximation of LRU that does not need a separate timestamp per page is the clock policy.
<ul>
<li>Each page has a reference bit. When a page is accessed, set it to <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>.</li>
<li>Organize the pages in a circular buffer with a “clock hand.”: Upon sweeping, check if a page’s bit is set<br />
to 1. If yes, set it to zero. If no, then evict.</li>
</ul>
</li>
</ol>
<h2 id="what-is-the-problem-with-lru-and-the-clock-and-how-can-it-be-alleviated"><a class="markdownIt-Anchor" href="#what-is-the-problem-with-lru-and-the-clock-and-how-can-it-be-alleviated"></a> What is the problem with LRU and the clock, and how can it be alleviated?</h2>
<ol>
<li>LRU and CLOCK replacement policies are susceptible to sequential flooding. In some workloads, the most recently used page is the most unneeded.</li>
<li><strong>LRU-K</strong> policy can alleviate the problem.
<ul>
<li>Track the history of the last K references to each page as timestamps and compute the average interval between subsequent accesses. And evict the one that will be accessed at the latest, according to the prediction.</li>
<li>In the implementation, the manager only needs to maintain a queue of size K. Pop out the oldest timestamp when a new timestamp arrives.</li>
</ul>
</li>
<li>Another policy is <strong>localization</strong>: The DBMS chooses which pages to evict on a per transaction/query basis, e.g., it allocates private frames to the query.</li>
<li><strong>Priority hints</strong>: The DBMS knows about the context of each page during query execution. It can provide hints to the buffer pool on whether a page is important.</li>
</ol>
<h2 id="how-do-we-deal-with-evicted-pages"><a class="markdownIt-Anchor" href="#how-do-we-deal-with-evicted-pages"></a> How do we deal with evicted pages?</h2>
<ol>
<li>Fast Path: If a page in the buffer pool is not dirty, the DBMS can drop it.</li>
<li>Slow Path: If a page is dirty, the DBMS must write back to disk to ensure its changes persist.
<ul>
<li>The DBMS can periodically walk through the page table and write dirty pages to disk.</li>
<li>When a dirty page is safely written, the DBMS can either evict the page or just unset the dirty flag.</li>
<li>Need to be careful that the system doesn’t write dirty pages before their log records are written.</li>
</ul>
</li>
<li>The Trade-off is between fast evictions versus dirty writing pages that will not be read again.</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://liyun-zhang.github.io/2023/06/24/Courses/15445/02-Storage/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LiyunZhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LiyunZhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LiyunZhang">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/06/24/Courses/15445/02-Storage/" class="post-title-link" itemprop="url">02 Storage</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-06-24 17:10:07" itemprop="dateCreated datePublished" datetime="2023-06-24T17:10:07+08:00">2023-06-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-03-16 12:28:09" itemprop="dateModified" datetime="2024-03-16T12:28:09+08:00">2024-03-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Open-Courses/" itemprop="url" rel="index"><span itemprop="name">Open Courses</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Open-Courses/CMU-15-445-645-Database-System/" itemprop="url" rel="index"><span itemprop="name">CMU 15-445/645 Database System</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><ul class="markdownIt-TOC">
<li><a href="#disk-based-architecture">Disk-based architecture</a>
<ul>
<li><a href="#what-are-the-storage-devices">What are the storage devices?</a></li>
<li><a href="#what-is-disk-oriented-dmbs">What is disk-oriented DMBS?</a></li>
<li><a href="#why-not-use-the-os-memory-mapping-virtual-memory">Why not use the OS memory mapping (virtual memory)?</a></li>
</ul>
</li>
<li><a href="#page-oriented-architecture">Page-oriented architecture</a>
<ul>
<li><a href="#file-storage">File storage</a>
<ul>
<li><a href="#how-does-dbms-store-files">How does DBMS store files?</a></li>
<li><a href="#how-does-dbms-manage-pages-in-files-on-disk">How does DBMS manage pages in files on disk?</a></li>
</ul>
</li>
<li><a href="#page-layout">Page layout</a>
<ul>
<li><a href="#what-is-stored-on-each-page">What is stored on each page?</a></li>
<li><a href="#how-to-organize-tuple-oriented-data">How to organize tuple-oriented data?</a></li>
<li><a href="#how-do-we-find-the-tuple-we-need-on-a-page">How do we find the tuple we need on a page?</a></li>
</ul>
</li>
<li><a href="#tuple-layout">Tuple layout</a>
<ul>
<li><a href="#what-is-stored-in-a-tuple">What is stored in a tuple?</a></li>
<li><a href="#what-is-denormalized-data">What is denormalized data?</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#log-structured-storage">Log-structured storage</a>
<ul>
<li><a href="#what-is-stored-in-log-structured-storage">What is stored in log-structured storage?</a></li>
<li><a href="#how-to-read-in-a-log-structured-storage">How to read in a log-structured storage?</a></li>
<li><a href="#how-to-solve-that-the-log-will-become-larger-and-larger">How to solve that the log will become larger and larger?</a></li>
</ul>
</li>
<li><a href="#tuple-storage">Tuple storage</a>
<ul>
<li><a href="#how-to-store-data-in-a-tuple">How to store data in a tuple?</a></li>
<li><a href="#what-are-supported-data-types">What are supported data types?</a></li>
</ul>
</li>
<li><a href="#data-storage-models">Data storage models</a>
<ul>
<li><a href="#what-kind-of-database-workloads-are-there">What kind of database workloads are there?</a></li>
<li><a href="#how-does-dbms-store-tuples">How does DBMS store tuples?</a></li>
<li><a href="#database-compression">Database compression</a>
<ul>
<li><a href="#why-do-we-need-database-compression-and-what-is-the-trade-off">Why do we need database compression, and what is the trade-off?</a></li>
<li><a href="#why-can-we-compress-data">Why can we compress data?</a></li>
<li><a href="#what-are-the-goals-of-compression">What are the goals of compression?</a></li>
<li><a href="#what-are-the-compression-granularities">What are the compression granularities?</a></li>
<li><a href="#what-is-naive-compression">What is naive compression?</a></li>
<li><a href="#how-can-we-do-better-with-the-high-level-meaning-or-semantics-of-the-data">How can we do better with the high-level meaning or semantics of the data?</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</p>
<h1 id="disk-based-architecture"><a class="markdownIt-Anchor" href="#disk-based-architecture"></a> Disk-based architecture</h1>
<h2 id="what-are-the-storage-devices"><a class="markdownIt-Anchor" href="#what-are-the-storage-devices"></a> What are the storage devices?</h2>
<ol>
<li>The first type is volatile memory: CPU registers, CPU caches, and DRAM.
<ul>
<li>They provide random access, and they are byte-addressable.</li>
</ul>
</li>
<li>The second type is the non-volatile disks: SSD, HDD, and network storage.
<ul>
<li>They only provide sequential access.
<ul>
<li>Random access on non-volatile storage is almost always much slower than sequential access.</li>
<li>DBMS will want to maximize sequential access.</li>
</ul>
</li>
<li>They are block-addressable.</li>
</ul>
</li>
<li>The access times of each storage are as follows:<br />
<img src="/imgs/15445/Storage/access_times.png" width="50%"></li>
</ol>
<h2 id="what-is-disk-oriented-dmbs"><a class="markdownIt-Anchor" href="#what-is-disk-oriented-dmbs"></a> What is disk-oriented DMBS?</h2>
<ol>
<li>The DBMS assumes that the primary storage location of the database is on a non-volatile disk.</li>
<li>DBMS manages a buffer pool in memory where directory and data pages are stored.</li>
<li>When the execution engine asks DBMS for a certain page:
<ul>
<li>If that page is not in memory already, DBMS will look up the directory first (if also not in memory, load from disk) to find the disk position of that page.</li>
<li>Then, DBMS will load that page from the disk and return a pointer to the buffer pool to the execution engine.</li>
</ul>
</li>
</ol>
<h2 id="why-not-use-the-os-memory-mapping-virtual-memory"><a class="markdownIt-Anchor" href="#why-not-use-the-os-memory-mapping-virtual-memory"></a> Why not use the OS memory mapping (virtual memory)?</h2>
<ol>
<li>Transaction safety: OS can flush dirty pages at any time, causing dirty data to corrupt the database. OS doesn’t know anything about transactions. Hence, it doesn’t care whether writing a page to disk is safe.</li>
<li>IO stalls: When a page miss happens, the thread will be stalled, and DBMS can do nothing about it.
<ul>
<li>Allowing multiple threads to access the <code>mmap</code> files to hide page fault stalls is good enough for read-only access. But it is complicated when there are multiple writers.</li>
</ul>
</li>
<li>Error handling: Any access can cause a <code>SIGBUS</code> that the DBMS must handle. However, DBMS may isolate and handle the error only in the storage layer.</li>
<li>Performance issues: Like OS data structure contention or TLB shootdowns.</li>
<li>In conclusion, DBMS always knows better than OS. Thus, DBMS almost always wants to control things and can do a better job than the OS.
<ul>
<li>Like how to flush dirty pages to disk in the correct order, provide specialized prefetching, better buffer replacement policy, and thread/process scheduling.</li>
</ul>
</li>
</ol>
<h1 id="page-oriented-architecture"><a class="markdownIt-Anchor" href="#page-oriented-architecture"></a> Page-oriented architecture</h1>
<h2 id="file-storage"><a class="markdownIt-Anchor" href="#file-storage"></a> File storage</h2>
<h3 id="how-does-dbms-store-files"><a class="markdownIt-Anchor" href="#how-does-dbms-store-files"></a> How does DBMS store files?</h3>
<ol>
<li>The DBMS stores a database as one or more files on disk, typically in a proprietary format.</li>
<li>The storage manager is responsible for maintaining a database’s files.
<ul>
<li>It organizes the files as a collection of pages.</li>
<li>It also tracks data read/written to pages and the available space.</li>
<li>Some do their scheduling for reads and writes to improve pages’ spatial and temporal locality.</li>
</ul>
</li>
<li>A database page is a fixed-size block of data.
<ul>
<li>Most systems do not mix page types, i.e., data on a page belong to the same table.</li>
<li>Some systems require a page to be self-contained, i.e., all metadata we need to interpret the page has to be contained in the page.</li>
<li>Hardware pages and OS pages are usually <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>4</mn><mtext> </mtext><mi>K</mi><mi>B</mi></mrow><annotation encoding="application/x-tex">4\ KB</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord">4</span><span class="mspace"> </span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span>. But database pages may be <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>512</mn><mtext> </mtext><mi>B</mi><mo>−</mo><mn>16</mn><mtext> </mtext><mi>K</mi><mi>B</mi></mrow><annotation encoding="application/x-tex">512\ B-16\ KB</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord">5</span><span class="mord">1</span><span class="mord">2</span><span class="mspace"> </span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord">6</span><span class="mspace"> </span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span> depending on DBMS and configuration.
<ul>
<li>A larger page size can increase sequential IO, issue fewer system calls, and have a smaller page table.</li>
<li>Smaller page sizes only need to maintain less memory when only a small amount of data is needed.</li>
</ul>
</li>
</ul>
</li>
</ol>
<h3 id="how-does-dbms-manage-pages-in-files-on-disk"><a class="markdownIt-Anchor" href="#how-does-dbms-manage-pages-in-files-on-disk"></a> How does DBMS manage pages in files on disk?</h3>
<ol>
<li>There are different ways to manage: Heap File Organization, Tree File Organization, Sequential / Sorted File Organization (ISAM), or Hashing File Organization.</li>
<li>A heap file is an unordered collection of pages with tuples stored in random order.</li>
<li>The DBMS maintains a directory in special pages that track the location of data pages in the database files.
<ul>
<li>Ensure that the directory pages are in sync with the data pages.</li>
<li>The directory also records meta-data about available space: the number of free slots per page and the list of free/empty pages.</li>
</ul>
</li>
</ol>
<h2 id="page-layout"><a class="markdownIt-Anchor" href="#page-layout"></a> Page layout</h2>
<h3 id="what-is-stored-on-each-page"><a class="markdownIt-Anchor" href="#what-is-stored-on-each-page"></a> What is stored on each page?</h3>
<ol>
<li>Every page contains a header of meta-data about the page’s contents.
<ul>
<li>Page Size</li>
<li>Checksum to check whether data is corrupted.</li>
<li>The DBMS version of the creator of this page is used to provide compatibility even when the DBMS update changes the page layout. With this, the data can be corrected and re-layout when the DBMS is updated.</li>
<li>Transaction Visibility</li>
<li>Compression Information</li>
</ul>
</li>
<li>The data in a page can be organized in tuple-oriented or log-structured.</li>
</ol>
<h3 id="how-to-organize-tuple-oriented-data"><a class="markdownIt-Anchor" href="#how-to-organize-tuple-oriented-data"></a> How to organize tuple-oriented data?</h3>
<ol>
<li>A naive strategy is to store the number of tuples in the header and append a new tuple to the end.
<ul>
<li>What if we delete a tuple?
<ul>
<li>How do we know there is available space?</li>
<li>What do we do to the following tuples? Do we move them forward, or leave them there?</li>
</ul>
</li>
<li>A more severe problem is what happens if we have a variable-length attribute.
<ul>
<li>How can we know the beginning and end of a tuple?</li>
</ul>
</li>
</ul>
</li>
<li>We store a slot array at the header in the slotted pages scheme.
<ul>
<li>The slot array maps “slots” to the tuples’ starting position offsets.</li>
<li>The header keeps track of the number of used slots and the offset of the starting location of the last slot used.</li>
<li>The space used to store tuples grows from tail to head, while the slot array grows from head to tail.</li>
<li>When a tuple is deleted, we must invalidate its value in a slot array where we can know available space.
<ul>
<li>As for its following tuples, we can either leave them as-is or compact the space.</li>
<li>As modification goes in memory, and deleting usually holds a lock, compacting the space can be fast, and there is no need to inform the rest of the system.</li>
</ul>
</li>
<li>
<img src="/imgs/15445/Storage/slot-array.png" width="25%">
</li>
</ul>
</li>
</ol>
<h3 id="how-do-we-find-the-tuple-we-need-on-a-page"><a class="markdownIt-Anchor" href="#how-do-we-find-the-tuple-we-need-on-a-page"></a> How do we find the tuple we need on a page?</h3>
<ol>
<li>Each tuple is assigned a unique record identifier.</li>
<li>The most commonly used is <code>page_id + offset/slot</code>.</li>
</ol>
<h2 id="tuple-layout"><a class="markdownIt-Anchor" href="#tuple-layout"></a> Tuple layout</h2>
<h3 id="what-is-stored-in-a-tuple"><a class="markdownIt-Anchor" href="#what-is-stored-in-a-tuple"></a> What is stored in a tuple?</h3>
<ol>
<li>A tuple is essentially a sequence of bytes. It’s the job of the DBMS to interpret those bytes into attribute types and values.</li>
<li>Each tuple is prefixed with a header containing meta-data, e.g., visibility info for concurrency control, Bit Map for NULL values.
<ul>
<li>We do not need to store meta-data about the schema.</li>
</ul>
</li>
<li>Attributes are typically stored in the order you specify when creating the table.</li>
</ol>
<h3 id="what-is-denormalized-data"><a class="markdownIt-Anchor" href="#what-is-denormalized-data"></a> What is denormalized data?</h3>
<ol>
<li>DBMS can physically denormalize (pre-join) related tuples and store them together on the same page.
<ul>
<li>For two tables, one table has an attribute referenced to another table, DBMS can store the tuples and their referenced tuples in the same slot.</li>
<li>
<img src="/imgs/15445/Storage/denorm_declare.png" width="25%">
</li>
<li>
<img src="/imgs/15445/Storage/denorm_diagram.png" width="25%">
</li>
</ul>
</li>
<li>This can potentially reduce the amount of I/O for common workload patterns and make updates more expensive.</li>
</ol>
<h1 id="log-structured-storage"><a class="markdownIt-Anchor" href="#log-structured-storage"></a> Log-structured storage</h1>
<h2 id="what-is-stored-in-log-structured-storage"><a class="markdownIt-Anchor" href="#what-is-stored-in-log-structured-storage"></a> What is stored in log-structured storage?</h2>
<ol>
<li>DBMS stores log records that contain changes to tuples (PUT, DELETE).
<ul>
<li>Each log record must contain the tuple’s unique identifier. In this case, the identifier is not <code>page_id + offset/slot</code> mentioned above since the page doesn’t exist in this scheme.</li>
</ul>
</li>
<li>As the application changes the database, the DBMS appends log records to the end of the file without checking previous log records.</li>
<li>When the page gets full, the DBMS writes it out of the disk and fills the next page with records.
<ul>
<li>All on-disk pages are immutable.</li>
<li>All disk writes are sequential.</li>
</ul>
</li>
</ol>
<h2 id="how-to-read-in-a-log-structured-storage"><a class="markdownIt-Anchor" href="#how-to-read-in-a-log-structured-storage"></a> How to read in a log-structured storage?</h2>
<ol>
<li>To read a tuple with a given ID, the DBMS finds the newest log record corresponding to that ID. It needs to scan the log from newest to oldest.
<ul>
<li>DBMS can maintain an index that maps a tuple ID to the newest log record to optimize the linear scan.</li>
</ul>
</li>
<li>If the log record is in memory, just read it. If the log record is on a disk page, retrieve it.</li>
</ol>
<h2 id="how-to-solve-that-the-log-will-become-larger-and-larger"><a class="markdownIt-Anchor" href="#how-to-solve-that-the-log-will-become-larger-and-larger"></a> How to solve that the log will become larger and larger?</h2>
<ol>
<li>The DBMS can periodically compact pages to reduce wasted space.
<ul>
<li>It can take two continuous pages and scan from newest to oldest, leaving one newest log for each tuple.</li>
</ul>
</li>
<li>The DBMS can sort the page based on ID order to improve future look-up efficiency.
<ul>
<li>This sorted table is called a <strong>Sorted String Table</strong>, <strong>SSTable</strong>.</li>
<li>After a page is compacted, the DBMS does need to maintain the temporal ordering of records within the page since each tuple ID is guaranteed to appear at most once on the page.</li>
</ul>
</li>
<li>There are two strategies to choose which pages to compact:
<ul>
<li>The Universal compaction chooses any two continuous pages.</li>
<li>The level compaction chooses two continuous pages on the same level and compacts them into the next level.</li>
</ul>
</li>
<li>The downside of compaction is write-amplification caused by duplicate writing to the newest record of a tuple, and compacting itself is expensive.</li>
</ol>
<h1 id="tuple-storage"><a class="markdownIt-Anchor" href="#tuple-storage"></a> Tuple storage</h1>
<h2 id="how-to-store-data-in-a-tuple"><a class="markdownIt-Anchor" href="#how-to-store-data-in-a-tuple"></a> How to store data in a tuple?</h2>
<ol>
<li>A tuple is essentially a sequence of bytes. It’s the job of the DBMS to interpret those bytes into attribute types and values.</li>
<li>The DBMS’s catalogs contain the schema information about tables that the system uses to figure out the tuple’s layout.
<ul>
<li>A DBMS stores meta-data about databases in its internal catalogs.
<ul>
<li>Tables, columns, indexes, views</li>
<li>Users, permissions</li>
<li>Internal statistics</li>
</ul>
</li>
</ul>
</li>
</ol>
<h2 id="what-are-supported-data-types"><a class="markdownIt-Anchor" href="#what-are-supported-data-types"></a> What are supported data types?</h2>
<ol>
<li>The basic types are supported: <code>INTEGER</code>/<code>BIGINT</code>/<code>SMALLINT</code>/<code>TINYINT</code>, <code>FLOAT</code>/<code>REAL</code>, <code>VARCHAR</code>/<code>VARBINARY</code>/<code>TEXT</code>/<code>BLOB</code>, <code>TIME</code>/<code>DATE</code>/<code>TIMESTAMP</code>.</li>
<li>Since IEEE 754 floating points may be inaccurate, fixed-point decimals are also supported as <code>NUMERIC</code>/<code>DECIMAL</code>. But their execution is way slower than floating points.</li>
<li>Most DBMSs don’t allow a tuple to exceed the size of a single page.
<ul>
<li>The DBMS uses separate overflow storage pages to store values that are larger than a page.</li>
<li>Some systems allow you to store a large value in an external file. And treat the data as a BLOB type. Then, the DBMS cannot manipulate the contents of an external file.
<ul>
<li>No durability protections. No transaction protections.</li>
<li>They are outside of DBMS. Hence, we cannot update it through DBMS either.</li>
</ul>
</li>
</ul>
</li>
</ol>
<h1 id="data-storage-models"><a class="markdownIt-Anchor" href="#data-storage-models"></a> Data storage models</h1>
<h2 id="what-kind-of-database-workloads-are-there"><a class="markdownIt-Anchor" href="#what-kind-of-database-workloads-are-there"></a> What kind of database workloads are there?</h2>
<ol>
<li>On-Line Transaction Processing (OLTP): In this situation, commands are fast operations that only read/update a small amount of data each time. The data accessed in a query is related to a single entity in the database.</li>
<li>On-Line Analytical Processing (OLAP): Here, commands are complex queries that read a lot of data to compute aggregates, i.e., they will execute complex writes and complex reads.</li>
<li>Hybrid Transaction + Analytical Processing: OLTP + OLAP together on the same database instance.</li>
</ol>
<h2 id="how-does-dbms-store-tuples"><a class="markdownIt-Anchor" href="#how-does-dbms-store-tuples"></a> How does DBMS store tuples?</h2>
<ol>
<li><strong>N-ary storage model</strong> (<strong>row storage</strong>): The DBMS contiguously stores all attributes for a single tuple on a page.
<ul>
<li>This model is ideal for OLTP workloads where queries operate only on an individual entity and insert-heavy workloads.</li>
<li>The advantage is fast inserts, updates, and deletes. It is also suitable for queries that need the entire tuple.</li>
<li>However, it is not good for scanning large portions of the table and a subset of the attributes.</li>
</ul>
</li>
<li><strong>Decomposition storage model</strong> (<strong>DSM</strong>, <strong>Column storage</strong>): The DBMS stores the values of a single attribute for all tuples contiguously on a page.
<ul>
<li>This model is ideal for OLAP workloads where read-only queries perform large scans over a subset of the table’s attributes.</li>
<li>DBMS can identify tuples in two choices:
<ul>
<li>The first is using fixed-length offsets when each value is the same length for an attribute. It does not require each attribute to have the same length. This is the most used scheme.</li>
<li>The second is using embedded tuple IDs. Each value is stored in a column with its tuple ID.</li>
</ul>
</li>
<li>The advantage of DSM is that it reduces the amount wasted I/O because the DBMS only reads the data it needs and provides better query processing and data compression.</li>
<li>The disadvantage is that it is slow for point queries, inserts, updates, and deletes because of tuple splitting/stitching.</li>
</ul>
</li>
</ol>
<h2 id="database-compression"><a class="markdownIt-Anchor" href="#database-compression"></a> Database compression</h2>
<h3 id="why-do-we-need-database-compression-and-what-is-the-trade-off"><a class="markdownIt-Anchor" href="#why-do-we-need-database-compression-and-what-is-the-trade-off"></a> Why do we need database compression, and what is the trade-off?</h3>
<ol>
<li>I/O is the main bottleneck if the DBMS fetches data from the disk during query execution.</li>
<li>The DBMS can compress pages to increase the utility of the data moved per I/O operation.</li>
<li>The fundamental trade-off is between speed and compression ratio.
<ul>
<li>Compressing and decompressing will take higher CPU costs to get a better compression ratio. But it can reduce DRAM requirements.</li>
<li>Some engines work with compressed data, which can reduce CPU costs.</li>
</ul>
</li>
</ol>
<h3 id="why-can-we-compress-data"><a class="markdownIt-Anchor" href="#why-can-we-compress-data"></a> Why can we compress data?</h3>
<ol>
<li>Data sets tend to have highly skewed distributions for attribute values.</li>
<li>Data sets tend to have a high correlation between attributes of the same tuple.</li>
</ol>
<h3 id="what-are-the-goals-of-compression"><a class="markdownIt-Anchor" href="#what-are-the-goals-of-compression"></a> What are the goals of compression?</h3>
<ol>
<li>It must produce fixed-length values. The only exception is var-length data stored in a separate pool.</li>
<li>Late materialization: Postpone decompression for as long as possible during query execution.</li>
<li>It must be a lossless scheme.
<ul>
<li>When a DBMS uses compression, it is always lossless because people don’t like losing data.</li>
<li>Any lossy compression must be performed at the application level.</li>
</ul>
</li>
</ol>
<h3 id="what-are-the-compression-granularities"><a class="markdownIt-Anchor" href="#what-are-the-compression-granularities"></a> What are the compression granularities?</h3>
<ol>
<li>Block-level: Compression is performed on a block of tuples for the same table.</li>
<li>Tuple-level: Compression is performed on the contents of the entire tuple (NSM-only).</li>
<li>Attribute-level: Compression is performed on a single attribute within one tuple (overflow). It can target multiple attributes for the same tuple.</li>
<li>Column-level: Compression is performed on multiple values for one or more attributes stored for multiple tuples (DSM-only).</li>
</ol>
<h3 id="what-is-naive-compression"><a class="markdownIt-Anchor" href="#what-is-naive-compression"></a> What is naive compression?</h3>
<ol>
<li>Naive means that the data system does not understand the bits after compression.</li>
<li>We can compress data using a general-purpose algorithm. The scope of compression is only based on the data provided as input.</li>
<li>In disk, each page stores the compressed data and the modification log of this page.</li>
<li>When DBMS reads a page into the buffer pool
<ul>
<li>It won’t decompress until queries need to return the whole tuple.</li>
<li>Every update will only append an entry in the mod log. Hence no need to decompress data when only updating tuples. The only thing we need to know in updating is which page this tuple is.</li>
<li>DBMS will decompress the page and apply changes when the mod log is full.</li>
</ul>
</li>
</ol>
<h3 id="how-can-we-do-better-with-the-high-level-meaning-or-semantics-of-the-data"><a class="markdownIt-Anchor" href="#how-can-we-do-better-with-the-high-level-meaning-or-semantics-of-the-data"></a> How can we do better with the high-level meaning or semantics of the data?</h3>
<ol>
<li>This is performed on the column level.</li>
<li>Run-length encoding:
<ul>
<li>Compress runs of continuous same value in a single column into triplets <code>(value, offset, length) </code>.
<ul>
<li><code>Value</code> is the value of the attribute.</li>
<li><code>Offset</code> is the start position in the column segment of the continuous save value run.</li>
<li><code>Length</code> is the number of elements in the run.</li>
</ul>
</li>
<li>It requires the columns to be sorted intelligently to maximize compression opportunities.</li>
</ul>
</li>
<li>Bit-packing encoding:
<ul>
<li>When values for an attribute are always less than the value’s declared largest size, store them as a smaller data type.</li>
<li>Mostly, encoding uses a special marker to indicate when a value exceeds the largest size and maintains a look-up table to store them.</li>
</ul>
</li>
<li>Bitmap encoding:
<ul>
<li>Store a separate bitmap for <strong>each unique value</strong> for an attribute where an offset in the vector corresponds to a tuple.</li>
<li>When reading, DBMS needs looks into the bits in the tuple to find which bit is <code>1</code> to know which value is stored in this attribute of this tuple.</li>
<li>We need to store the value for each bitmap. So, the total space required is the total length of possible values, and the number of bits is the same as the number of tuples for each value.</li>
</ul>
</li>
<li>Delta encoding:
<ul>
<li>Recording the difference between this tuple and its last tuple.</li>
<li>Store base value in-line or in a separate look-up table.</li>
<li>Combine with RLE to get even better compression ratios.</li>
</ul>
</li>
<li>Incremental encoding:
<ul>
<li>Delta encoding is for numbers, while incremental encoding is for strings.</li>
<li>It stores the length of common prefixes between this tuple and its last tuple and the extra suffixes of this tuple.</li>
<li>When there is no common prefix, the length is <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span>. It performed better when we sorted tuples according to the strings.</li>
</ul>
</li>
<li>Dictionary compression (most widely used):
<ul>
<li>Build a data structure that maps variable-length values to a smaller integer identifier. And replace those values with their corresponding identifier in the dictionary data structure.</li>
<li>A dictionary is required to support fast encoding, decoding, and a range of queries.</li>
<li>The hash function can not be used due to key confliction, and decoding cannot be provided.</li>
<li>When the dictionary encodes values in a certain order (e.g., alphabetic order), the execution engine can be optimized to do some queries only access the dictionary, especially for those <code>DISTINCT</code> queries.</li>
</ul>
</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://liyun-zhang.github.io/2023/06/24/Courses/15445/01-Relational-Model/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LiyunZhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LiyunZhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LiyunZhang">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/06/24/Courses/15445/01-Relational-Model/" class="post-title-link" itemprop="url">01 Relational Model</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-06-24 15:14:56" itemprop="dateCreated datePublished" datetime="2023-06-24T15:14:56+08:00">2023-06-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-03-16 12:05:06" itemprop="dateModified" datetime="2024-03-16T12:05:06+08:00">2024-03-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Open-Courses/" itemprop="url" rel="index"><span itemprop="name">Open Courses</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Open-Courses/CMU-15-445-645-Database-System/" itemprop="url" rel="index"><span itemprop="name">CMU 15-445/645 Database System</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><ul class="markdownIt-TOC">
<li><a href="#database">Database</a>
<ul>
<li><a href="#why-shouldnt-we-store-the-database-in-a-flat-file-like-csv-which-we-manage-ourselves-in-our-application-code">Why shouldn’t we store the database in a flat file like CSV, which we manage ourselves in our application code?</a></li>
<li><a href="#what-do-dbms-and-data-models-do">What do DBMS and data models do?</a></li>
<li><a href="#what-kinds-of-data-models-are-there">What kinds of data models are there?</a></li>
<li><a href="#how-does-the-document-data-model-store-data">How does the document data model store data?</a></li>
</ul>
</li>
<li><a href="#relational-model">Relational model</a>
<ul>
<li><a href="#how-are-data-stored">How are data stored?</a></li>
<li><a href="#what-are-primary-keys-and-foreign-keys">What are primary keys and foreign keys?</a></li>
<li><a href="#what-is-supported-in-relational-algebra">What is supported in relational algebra?</a></li>
</ul>
</li>
<li><a href="#morden-sql">Morden SQL</a>
<ul>
<li><a href="#what-is-provided-in-a-relational-language">What is provided in a relational language?</a></li>
<li><a href="#aggregations-and-group-by">Aggregations and Group By</a>
<ul>
<li><a href="#what-are-aggregations">What are aggregations?</a></li>
<li><a href="#how-to-output-other-columns-with-aggregations">How to output other columns with aggregations?</a></li>
</ul>
</li>
<li><a href="#what-string-operations-are-supported">What string operations are supported?</a></li>
<li><a href="#output">Output</a>
<ul>
<li><a href="#where-can-we-redirect-outputs">Where can we redirect outputs?</a></li>
<li><a href="#how-can-we-control-the-outputs">How can we control the outputs?</a></li>
</ul>
</li>
<li><a href="#what-if-we-need-a-temporary-relation-in-a-query">What if we need a temporary relation in a query?</a></li>
<li><a href="#how-do-window-functions-work">How do window functions work?</a></li>
</ul>
</li>
</ul>
</p>
<h1 id="database"><a class="markdownIt-Anchor" href="#database"></a> Database</h1>
<h2 id="why-shouldnt-we-store-the-database-in-a-flat-file-like-csv-which-we-manage-ourselves-in-our-application-code"><a class="markdownIt-Anchor" href="#why-shouldnt-we-store-the-database-in-a-flat-file-like-csv-which-we-manage-ourselves-in-our-application-code"></a> Why shouldn’t we store the database in a flat file like CSV, which we manage ourselves in our application code?</h2>
<ol>
<li>The first concern is data integrity:
<ul>
<li>How to ensure that the data makes sense to the design schema?</li>
<li>How to prevent invalid data and malicious attacks?</li>
<li>The management of deleting some entries causing deleting entries in other databases is a pain.</li>
</ul>
</li>
<li>Another problem is implementation:
<ul>
<li>How to find a record?</li>
<li>How to share a database between applications?</li>
<li>How to handle concurrent writes?</li>
</ul>
</li>
<li>Also concerned about durability:
<ul>
<li>What if the machine crashed?</li>
<li>How to replicate the database?</li>
</ul>
</li>
</ol>
<h2 id="what-do-dbms-and-data-models-do"><a class="markdownIt-Anchor" href="#what-do-dbms-and-data-models-do"></a> What do DBMS and data models do?</h2>
<ol>
<li>DBMS supports the definition, creation, querying, update, and administration of databases in accordance with some data model.
<ul>
<li>The physical storage is left up to the DBMS implementation.</li>
<li>Programmers access data through high-level language, and DBMS figures out the best execution strategy.</li>
</ul>
</li>
<li>A data model is a collection of concepts describing the data in a database.
<ul>
<li>A schema describes a particular collection of data using a given data model.</li>
</ul>
</li>
</ol>
<h2 id="what-kinds-of-data-models-are-there"><a class="markdownIt-Anchor" href="#what-kinds-of-data-models-are-there"></a> What kinds of data models are there?</h2>
<ol>
<li>The most used is the Relational model.</li>
<li>One class called NoSQL:
<ul>
<li>Key/Value</li>
<li>Graph</li>
<li>Document / Object</li>
<li>Wide-Column / Column-family</li>
</ul>
</li>
<li>For machine learning, there are Array / Matrix / Vectors.</li>
<li>The obsolete or legacy ones are:
<ul>
<li>Hierarchical</li>
<li>Network</li>
<li>Multi-Value</li>
</ul>
</li>
</ol>
<h2 id="how-does-the-document-data-model-store-data"><a class="markdownIt-Anchor" href="#how-does-the-document-data-model-store-data"></a> How does the document data model store data?</h2>
<ol>
<li>It embeds data hierarchy into a single object like JSON, XML, etc.</li>
<li>The problem is similar to the aforementioned store database in a flat file like CSV.</li>
</ol>
<h1 id="relational-model"><a class="markdownIt-Anchor" href="#relational-model"></a> Relational model</h1>
<h2 id="how-are-data-stored"><a class="markdownIt-Anchor" href="#how-are-data-stored"></a> How are data stored?</h2>
<ol>
<li>Data are stored in simple data structures called relations.</li>
<li>A relation is an <strong>unordered set</strong> that contains the relationship of attributes that represent entities.
<ul>
<li>A n-ary relation is a table with n columns.</li>
</ul>
</li>
<li>A tuple is a set of attribute values (domain) in the relation.
<ul>
<li>NULL is a member of every domain if allowed.</li>
</ul>
</li>
</ol>
<h2 id="what-are-primary-keys-and-foreign-keys"><a class="markdownIt-Anchor" href="#what-are-primary-keys-and-foreign-keys"></a> What are primary keys and foreign keys?</h2>
<ol>
<li>A relation’s primary key uniquely identifies a single tuple.
<ul>
<li>In defining a relation, primary keys are usually marked with an underline.</li>
</ul>
</li>
<li>A foreign key specifies that an attribute from one relation must map to a tuple in another.
<ul>
<li>Normally, foreign keys must be primary keys in another relation.</li>
</ul>
</li>
</ol>
<h2 id="what-is-supported-in-relational-algebra"><a class="markdownIt-Anchor" href="#what-is-supported-in-relational-algebra"></a> What is supported in relational algebra?</h2>
<ol>
<li>Select: <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>σ</mi><mrow><mi>p</mi><mi>r</mi><mi>e</mi><mi>d</mi><mi>i</mi><mi>c</mi><mi>a</mi><mi>t</mi><mi>e</mi></mrow></msub><mo stretchy="false">(</mo><mi>R</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\sigma_{predicate}(R)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight">c</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">e</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mclose">)</span></span></span></span>
<ul>
<li>Choose a subset of the tuples from a relation that satisfies the selection predicate.<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> R</span><br><span class="line"> <span class="keyword">WHERE</span> predicate;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li>Projection: <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="normal">Π</mi><mrow><msub><mi>A</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>A</mi><mn>2</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>A</mi><mi>n</mi></msub></mrow></msub><mo stretchy="false">(</mo><mi>R</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\Pi_{A_1,A_2,\dots,A_n}(R)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord">Π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.328331em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31731428571428577em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mpunct mtight">,</span><span class="mord mtight"><span class="mord mathnormal mtight">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31731428571428577em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mpunct mtight">,</span><span class="minner mtight">…</span><span class="mpunct mtight">,</span><span class="mord mtight"><span class="mord mathnormal mtight">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.16454285714285719em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mclose">)</span></span></span></span>
<ul>
<li>Generate a relation with tuples that contain only the specified attributes.</li>
<li>It can be used to rearrange attributes’ ordering and manipulate the values.<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> A1, A2, ..., An <span class="keyword">FROM</span> R;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li>Union: <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi><mo>∪</mo><mi>S</mi></mrow><annotation encoding="application/x-tex">R\cup S</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∪</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span></span></span></span>
<ul>
<li>Two relations must have identical attributes.</li>
<li>The result may be duplicated if some tuples appear in both relations.<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> R) <span class="keyword">UNION</span> <span class="keyword">ALL</span> (<span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> S);</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li>Intersection: <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi><mo>∩</mo><mi>S</mi></mrow><annotation encoding="application/x-tex">R\cap S</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∩</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span></span></span></span>
<ul>
<li>Two relations must have the same attributes.<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> R) <span class="keyword">INTERSECT</span> (<span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> S);</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li>Difference: <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi><mo>−</mo><mi>S</mi></mrow><annotation encoding="application/x-tex">R-S</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span></span></span></span>
<ul>
<li>Two relations must have identical attributes.<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> R) <span class="keyword">EXCEPT</span> (<span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> S);</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li>Product: <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi><mo>×</mo><mi>S</mi></mrow><annotation encoding="application/x-tex">R\times S</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span></span></span></span>
<ul>
<li>Generate a relation that contains all possible combinations of tuples from the input relations, i.e., Cartesian product.<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> R <span class="keyword">CROSS</span> <span class="keyword">JOIN</span> S;</span><br><span class="line"># <span class="keyword">Or</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> R, S;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li>Join: <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi><mo>⋈</mo><mi>S</mi></mrow><annotation encoding="application/x-tex">R\bowtie S</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68833em;vertical-align:-0.005em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">⋈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span></span></span></span>
<ul>
<li>The difference between join and intersection is that join can match attributes’ names automatically, while intersection requires that two relations have the same attribute order.</li>
<li>It does product first, then compare attributes.<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> R <span class="keyword">NATURAL</span> <span class="keyword">JOIN</span> S;</span><br><span class="line"># <span class="keyword">Or</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> R <span class="keyword">JOIN</span> S <span class="keyword">USING</span> (A1, A2, ..., An);</span><br></pre></td></tr></table></figure>
</li>
<li>In the broad sense, join can have a predicate <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi><msub><mo>⋈</mo><mrow><mi>p</mi><mi>r</mi><mi>e</mi><mi>d</mi><mi>i</mi><mi>c</mi><mi>a</mi><mi>t</mi><mi>e</mi></mrow></msub><mi>S</mi></mrow><annotation encoding="application/x-tex">R\bowtie_{predicate}S</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.969438em;vertical-align:-0.286108em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel"><span class="mrel">⋈</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight">c</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">e</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span></span></span></span> which is the same as <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>σ</mi><mrow><mi>p</mi><mi>r</mi><mi>e</mi><mi>d</mi><mi>i</mi><mi>c</mi><mi>a</mi><mi>t</mi><mi>e</mi></mrow></msub><mo stretchy="false">(</mo><mi>R</mi><mo>×</mo><mi>S</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\sigma_{predicate}(R\times S)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight">c</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">e</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mclose">)</span></span></span></span>.</li>
</ul>
</li>
<li>Different orders of steps can have the same result with varying amounts of computation.
<ul>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi><mo>⋈</mo><mo stretchy="false">(</mo><msub><mi>σ</mi><mrow><mi>p</mi><mi>r</mi><mi>e</mi><mi>d</mi><mi>i</mi><mi>c</mi><mi>a</mi><mi>t</mi><mi>e</mi></mrow></msub><mo stretchy="false">(</mo><mi>S</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">R\bowtie(\sigma_{predicate}(S))</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68833em;vertical-align:-0.005em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">⋈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight">c</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">e</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mclose">)</span><span class="mclose">)</span></span></span></span> is much more efficient than <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>σ</mi><mrow><mi>p</mi><mi>r</mi><mi>e</mi><mi>d</mi><mi>i</mi><mi>c</mi><mi>a</mi><mi>t</mi><mi>e</mi></mrow></msub><mo stretchy="false">(</mo><mi>R</mi><mo>⋈</mo><mi>S</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\sigma_{predicate}(R\bowtie S)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight">c</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">e</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">⋈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mclose">)</span></span></span></span>.</li>
</ul>
</li>
</ol>
<h1 id="morden-sql"><a class="markdownIt-Anchor" href="#morden-sql"></a> Morden SQL</h1>
<h2 id="what-is-provided-in-a-relational-language"><a class="markdownIt-Anchor" href="#what-is-provided-in-a-relational-language"></a> What is provided in a relational language?</h2>
<ol>
<li>Data Manipulation Language (DML)</li>
<li>Data Definition Language (DDL)</li>
<li>Data Control Language (DCL)</li>
<li>Also, view definition, integrity, and referential constraints, transactions.</li>
</ol>
<h2 id="aggregations-and-group-by"><a class="markdownIt-Anchor" href="#aggregations-and-group-by"></a> Aggregations and Group By</h2>
<h3 id="what-are-aggregations"><a class="markdownIt-Anchor" href="#what-are-aggregations"></a> What are aggregations?</h3>
<ol>
<li>They are functions that return a single value from a bag of tuples.</li>
<li><code>AVG(col)</code>, <code>MIN(col)</code>, <code>MAX(col)</code>, <code>SUM(col)</code>, <code>COUNT(col)</code>
<ul>
<li>For <code>COUNT</code>, the passed argument does not matter since it only returns the number of rows.</li>
</ul>
</li>
<li>Aggregate functions can almost only be used in the <code>SELECT</code> output list.</li>
<li><code>COUNT</code>, <code>SUM</code>, and <code>AVG</code> support <code>DISTINCT</code>.
<ul>
<li>In this case, the columns passed to <code>COUNT</code> matters.</li>
</ul>
</li>
<li>The output of other columns outside of an aggregate is undefined.
<ul>
<li>Aggregations create a new relation with a different number of tuples.</li>
<li>If we directly ask for other columns, the number of tuples won’t match the output of aggregations.</li>
<li>We don’t know the relation between the output of aggregations and values from other columns (some languages may allow this but with chaotic order).</li>
</ul>
</li>
<li>We also cannot filter output tuples based on aggregation column names.
<ul>
<li>Since <code>SELECT</code> happens at last, when <code>WHERE</code> or <code>HAVING </code> is calculated, the aggregation columns haven’t been calculated yet.</li>
</ul>
</li>
</ol>
<h3 id="how-to-output-other-columns-with-aggregations"><a class="markdownIt-Anchor" href="#how-to-output-other-columns-with-aggregations"></a> How to output other columns with aggregations?</h3>
<ol>
<li><code>GROUP BY</code> projects tuples into subsets and calculates aggregates against each subset.</li>
<li>Non-aggregated values in the SELECT output clause must appear in the <code>GROUP BY</code> clause.</li>
<li>With group-by, each aggregation output has the same values in those grouped columns. So <code>SELECT</code> knows their relation.</li>
<li><code>HAVING</code> like a <code>WHERE</code> clause for a <code>GROUP BY</code>.
<ul>
<li>It can filter results based on aggregation computation. But it also shouldn’t use the column names of aggregation in <code>SELECT</code>.</li>
<li>Instead, it should directly use the aggregation function. Although the execution engine knows these two are the same and doesn’t do the repeat calculation.</li>
</ul>
</li>
</ol>
<h2 id="what-string-operations-are-supported"><a class="markdownIt-Anchor" href="#what-string-operations-are-supported"></a> What string operations are supported?</h2>
<ol>
<li>Predicate of string matching can be done with <code>=</code>
<ul>
<li>Some DBMSs are case-sensitive, while others are not.</li>
<li>We can also use <code>LIKE</code> to match with string-match operators.
<ul>
<li><code>%</code> matches any substring (including empty strings)</li>
<li><code>_</code> match any one character.</li>
</ul>
</li>
</ul>
</li>
<li>Other string functions are provided:
<ul>
<li><code>UPPER</code> and <code>LOWER</code></li>
<li><code>SUBSTRING(str, start_index, end_index)</code></li>
</ul>
</li>
<li>Different languages have different ways to concatenate strings: <code>str1 || str2</code>, <code>str1 + str2</code> or <code>CONCAT(str1, str2)</code>.</li>
</ol>
<h2 id="output"><a class="markdownIt-Anchor" href="#output"></a> Output</h2>
<h3 id="where-can-we-redirect-outputs"><a class="markdownIt-Anchor" href="#where-can-we-redirect-outputs"></a> Where can we redirect outputs?</h3>
<ol>
<li>We can store query results in another table.
<ul>
<li>That table must not already be defined.</li>
<li>It will have the same number of columns and types as the input.</li>
</ul>
</li>
<li>We can also insert tuples from a query into another table.
<ul>
<li>The inner select must generate the same columns as the target table.</li>
<li>DMBSs have different options/syntax on what to do with integrity violations.</li>
</ul>
</li>
</ol>
<h3 id="how-can-we-control-the-outputs"><a class="markdownIt-Anchor" href="#how-can-we-control-the-outputs"></a> How can we control the outputs?</h3>
<ol>
<li>We can order the output tuples by the values in one or more of their columns with <code>ORDER BY &lt;column*&gt; [ASC|DESC]</code>.</li>
<li>We can also limit the number of tuples returned in output with <code>LIMIT &lt;count&gt; [OFFSET &lt;count2&gt;]</code>.
<ul>
<li>Although this limits the number of outputs, its execution may still need to compute the whole relation, e.g., to output the top-10 largest numbers, it still needs to sort all numbers.</li>
</ul>
</li>
</ol>
<h2 id="what-if-we-need-a-temporary-relation-in-a-query"><a class="markdownIt-Anchor" href="#what-if-we-need-a-temporary-relation-in-a-query"></a> What if we need a temporary relation in a query?</h2>
<ol>
<li>The first solution is nested queries.
<ul>
<li>Inner queries can appear almost anywhere in a query.</li>
<li>In the WHERE clause, we can perform a predicate between the tuples from the current relation and the result of the subqueries.
<ul>
<li><code>ALL</code> must satisfy expressions for all rows in the subquery.</li>
<li><code>ANY</code> must satisfy the expression for at least one row in the subquery.</li>
<li><code>IN</code> is equivalent to <code>=ANY()</code>.</li>
<li><code>EXISTS</code> returns true if the relation is not empty.</li>
<li><code>NOT</code></li>
</ul>
</li>
</ul>
</li>
<li>Another choice is a common table expression using <code>WITH cteName AS (query)</code>.
<ul>
<li>It also supports bind/alias output columns to names <code>WITH cteName (col1, ..., coln) AS (query)</code></li>
<li>In the next query, we can reference this temporary relation with <code>cteName</code>.</li>
<li>We can enable recursive calculation using <code>WITH RECURSIVE</code>.</li>
</ul>
</li>
</ol>
<h2 id="how-do-window-functions-work"><a class="markdownIt-Anchor" href="#how-do-window-functions-work"></a> How do window functions work?</h2>
<ol>
<li>Window functions perform a sliding calculation across a set of related tuples.</li>
<li>Like an aggregation, they only appear in the <code>SELECT</code> clause. However, tuples are not grouped into a single output tuples. Instead, the number of rows of the output is the same as the input.</li>
<li>In the SELECT clause, the syntax of the window functions is <code>FUNC-NAME(...) OVER(...)</code>.
<ul>
<li>The <code>FUNC-NAME</code> can be aggregation functions or special functions (<code>ROW_NUMBER</code> and <code>RANK</code>)
<ul>
<li><code>ROW_NUMBER</code> assigns the number of the current rows in a certain order.</li>
<li><code>RANK</code> assigns the order position of the current row.</li>
<li>When two rows tie, <code>RANK</code> will assign the same number to them and skip the next number, while ROW_NUMBER will assign a different number.</li>
</ul>
</li>
<li>The <code>OVER</code> parameter controls how to slice up data.
<ul>
<li>It controls how to group tuples when computing the window function with <code>PARTITION BY</code>.</li>
<li>It also controls the computing order with <code>ORDER BY ... [ASC|DESC]</code>.</li>
</ul>
</li>
</ul>
</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://liyun-zhang.github.io/2023/03/27/OpenSource/6.824/Lab-4-ShardKV/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LiyunZhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LiyunZhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LiyunZhang">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/03/27/OpenSource/6.824/Lab-4-ShardKV/" class="post-title-link" itemprop="url">Lab 4: ShardKV</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-03-27 14:35:51" itemprop="dateCreated datePublished" datetime="2023-03-27T14:35:51+08:00">2023-03-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-03-17 11:28:55" itemprop="dateModified" datetime="2024-03-17T11:28:55+08:00">2024-03-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Open-Source-Code/" itemprop="url" rel="index"><span itemprop="name">Open Source Code</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Open-Source-Code/6-824/" itemprop="url" rel="index"><span itemprop="name">6.824</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><ul class="markdownIt-TOC">
<li><a href="#how-to-shard-key-value-pairs">How to shard key-value pairs?</a></li>
<li><a href="#how-to-install-a-new-configuration">How to install a new configuration?</a></li>
<li><a href="#how-to-reduce-the-pauses-for-clients-when-installing-new-configurations">How to reduce the pauses for clients when installing new configurations?</a></li>
<li><a href="#how-does-garbage-collect-past-configurations">How does garbage collect past configurations?</a></li>
</ul>
</p>
<h1 id="how-to-shard-key-value-pairs"><a class="markdownIt-Anchor" href="#how-to-shard-key-value-pairs"></a> How to shard key-value pairs?</h1>
<ol>
<li>The total number of shards is fixed to be <code>NShards</code>. The keys are mapped into shards by a hash function mod by <code>NShards</code>.</li>
<li>Each KV group in the cluster needs to be responsible for some shards. An additional Raft group named Shard Controller is responsible for the cluster configurations.
<ul>
<li>Each KV group would acquire the latest configuration from the Shard Controller.</li>
<li>When a new configuration is found, it will be proposed to the Raft group. It is installed until it has been committed.</li>
</ul>
</li>
<li>Administrators can modify the configuration of the Raft groups in the cluster by giving commands to the Shard Controllers. <code>Leave</code>, <code>Join</code>, and <code>Move</code> are provided.
<ul>
<li>When a command comes from administrators, a Raft entry is proposed. A new configuration will only be created when that entry is committed.</li>
<li>When creating new configurations, <code>Leave</code> and <code>Join</code> will try to rebalance the distribution of shards as evenly as possible or move as few shards as possible.</li>
</ul>
</li>
</ol>
<h1 id="how-to-install-a-new-configuration"><a class="markdownIt-Anchor" href="#how-to-install-a-new-configuration"></a> How to install a new configuration?</h1>
<ol>
<li>For the shards in the last config, not in the new config, we cannot simply discard them. When we give up a shard, some other group must be responsible for it, and they do not have it now. Therefore, we need to transmit the data to them.
<ul>
<li>One way is to push the data to the new owner of the shards. However, they may not be online now; they are partitioned from this node, or they may not have installed this new configuration, causing waste RPC flows.</li>
<li>Another way is to keep all data from past configurations and separate them from the current configuration data, waiting for other nodes to pull the shards they want.</li>
</ul>
</li>
<li>We must acquire the shards in the new configuration and not in the last configuration from somewhere.
<ul>
<li>As aforementioned, when a new configuration is installed, this peer will issue an RPC to pull the missing shards from other groups.</li>
<li>To avoid that the target host of missing shards only executes part of commands of the last config causing missing values, a host is allowed to transmit shards only if it has installed the next configuration of the requested configuration.</li>
</ul>
</li>
<li>The executed index records also need to be separated between configurations to prevent lagged groups from rejecting to execute commands from clients.</li>
<li>When installing a new configuration from a snapshot, remember to initiate the goroutines to fetch the missing shards from the snapshot.</li>
</ol>
<h1 id="how-to-reduce-the-pauses-for-clients-when-installing-new-configurations"><a class="markdownIt-Anchor" href="#how-to-reduce-the-pauses-for-clients-when-installing-new-configurations"></a> How to reduce the pauses for clients when installing new configurations?</h1>
<ol>
<li>In the naive schema, we must wait until all shards are received before executing any client commands. However, receiving all shards could take a long time.</li>
<li>Executing the commands that only need the received shards is reasonable, even if some shards remain missing.</li>
<li>We can add a data structure to record the state of each shard in a configuration. If the state is received, we can execute the commands on that shard.</li>
<li>To execute the commands in commit order, we will still be stalled by the commands requesting missing shards.</li>
<li>Nevertheless, this schema can push the process forward as much as possible and parallel executing commands of received shards and waiting for missing shards.</li>
</ol>
<h1 id="how-does-garbage-collect-past-configurations"><a class="markdownIt-Anchor" href="#how-does-garbage-collect-past-configurations"></a> How does garbage collect past configurations?</h1>
<ol>
<li>In the naive schema, the redundant data would grow larger and larger since we cannot delete data from past configurations.</li>
<li>We can notice that a shard in the past configuration can be deleted when it is received by the group that needs to request it.
<ul>
<li>A peer can ask the corresponding peers whether they have received the shards. Similar to why we do not push shards, it will waste a lot of RPC flows.</li>
<li>When a peer receives a shard, whether requesting from another group or installing a snapshot, it will inform the groups that host shards from the previous configuration.</li>
<li>The shard can be deleted from the host of the last configuration when all peers who host a shard in the next configuration have received it.</li>
</ul>
</li>
<li>A garbage collection goroutine is initiated when the next configuration is installed.</li>
<li>A snapshot must persist before informing other groups of receiving shards to prevent recovery from a snapshot without shards while the host has already deleted due to received acknowledgment.</li>
<li>When a shard can be deleted, snapshot installation becomes more tricky.
<ul>
<li>We should not copy the deleted shards and deleted configurations from the snapshot. We can also delete the shads that are deleted in the snapshot.</li>
<li>When a new configuration is created from a snapshot, a garbage collection of the former configuration needs to be started.</li>
</ul>
</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://liyun-zhang.github.io/2023/03/27/OpenSource/6.824/Lab-3-Fault-tolerant-Key-Value-Service/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LiyunZhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LiyunZhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LiyunZhang">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/03/27/OpenSource/6.824/Lab-3-Fault-tolerant-Key-Value-Service/" class="post-title-link" itemprop="url">Lab 3: Fault-tolerant Key/Value Service</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-03-27 14:35:11" itemprop="dateCreated datePublished" datetime="2023-03-27T14:35:11+08:00">2023-03-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-03-17 11:28:16" itemprop="dateModified" datetime="2024-03-17T11:28:16+08:00">2024-03-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Open-Source-Code/" itemprop="url" rel="index"><span itemprop="name">Open Source Code</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Open-Source-Code/6-824/" itemprop="url" rel="index"><span itemprop="name">6.824</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><ul class="markdownIt-TOC">
<li><a href="#how-does-the-keyvalue-server-execute-a-command-from-the-clerk">How does the Key/Value server execute a command from the clerk?</a>
<ul>
<li><a href="#how-can-we-take-advantage-of-follower-nodes">How can we take advantage of follower nodes?</a></li>
</ul>
</li>
<li><a href="#how-can-we-prevent-re-execution-of-an-executed-command">How can we prevent re-execution of an executed command?</a></li>
<li><a href="#how-many-kinds-of-errors-could-occur-when-a-client-issues-a-command">How many kinds of errors could occur when a client issues a command?</a></li>
<li><a href="#what-should-be-stored-in-a-snapshot">What should be stored in a snapshot?</a></li>
<li><a href="#what-needs-to-be-done-to-recover-the-state-after-a-crash">What needs to be done to recover the state after a crash?</a></li>
<li><a href="#execution-speed-of-get-operation">Execution speed of Get operation:</a></li>
<li><a href="#execution-speed-of-putappend-operation">Execution speed of PutAppend operation:</a></li>
</ul>
</p>
<h1 id="how-does-the-keyvalue-server-execute-a-command-from-the-clerk"><a class="markdownIt-Anchor" href="#how-does-the-keyvalue-server-execute-a-command-from-the-clerk"></a> How does the Key/Value server execute a command from the clerk?</h1>
<ol>
<li>It will call the <code>Start()</code> function of its associated Raft server. It can safely execute the command until the Raft server commits that command.</li>
<li>Only the KV server associated with the leader Raft server can successfully use Start() to append commands to logs.</li>
<li>However, there could be a situation in which the network is partitioned, and the clerk connects to a partition leader whose log entry can never be successfully committed. So, we need to set a timeout for each command. The clerk should be informed to find another server if it cannot be committed in time.</li>
</ol>
<h2 id="how-can-we-take-advantage-of-follower-nodes"><a class="markdownIt-Anchor" href="#how-can-we-take-advantage-of-follower-nodes"></a> How can we take advantage of follower nodes?</h2>
<ol>
<li>
<p>To achieve linearizability, there is no chance for the follower to improve the performance of the Put/Append operation. However, we can allow them to handle read-only requests to enhance the cluster’s throughput.</p>
</li>
<li>
<p>The key idea is to make the follower know it is up-to-date to handle the read. To confirm that, we must consult the leader of the current commit index.</p>
</li>
<li>
<p>A case is a partitioned follower and leader when another true leader connects to the majority.</p>
<ul>
<li>The solution is that the leader must check whether it is a legitimate leader before authorizing the followers to execute the read.</li>
</ul>
</li>
<li>
<p>The whole process is as follows:</p>
<ul>
<li>When a follower received a read from the client, it would consult the leader for a <code>readIndex</code>.</li>
<li>The leader then needs to send heartbeats to all peers in the group to ensure it is still the leader.</li>
<li>When the leader receives from the majority, the current commit index can be returned to the follower as <code>readIndex</code>.</li>
<li>The follower can execute the read request if it has at least applied up to <code>readIndex</code>.</li>
</ul>
</li>
<li>
<p>In the Raft protocol, a leader can only commit the entries appended in its term. Similarly, a leader can only grant <code>ReadIndex</code>, pointing to an entry in its term. Or the result of the reading may become unlinearizable.</p>
<ul>
<li>
<p>Consider that a leader committed an index of <em>x</em> and granted a ReadIndex of <em>x</em> to its associated KV server. So, the KV server returned the result up to index <em>x</em>.</p>
</li>
<li>
<p>But it crashed before sending a commit message to other followers. Then, a new leader is elected who receives a request for ReadIndex. It does not know anything about committing entry <em>x</em>, thus granting a ReadIndex lower than <em>x</em>.</p>
</li>
<li>
<p>Hence, the read will return a result unseeing the execution result of the entry of index x, which violates the linearizability scheme.</p>
</li>
<li>
<p>So, the solution is to append an empty entry to the log if the leader hasn’t appended any entry in its term.</p>
</li>
</ul>
</li>
</ol>
<h1 id="how-can-we-prevent-re-execution-of-an-executed-command"><a class="markdownIt-Anchor" href="#how-can-we-prevent-re-execution-of-an-executed-command"></a> How can we prevent re-execution of an executed command?</h1>
<ol>
<li>Each clerk needs to maintain a monotonically increasing index to mark the command it issued.</li>
<li>Each Key/Value server needs to track the highest index executed for each clerk.</li>
<li>When a Key/Value server receives a new command, it compares the new command’s index with that clerk’s highest executed index. If the command’s index is lower, it can know that this is an executed command and return the result directly.</li>
</ol>
<h1 id="how-many-kinds-of-errors-could-occur-when-a-client-issues-a-command"><a class="markdownIt-Anchor" href="#how-many-kinds-of-errors-could-occur-when-a-client-issues-a-command"></a> How many kinds of errors could occur when a client issues a command?</h1>
<ol>
<li>For read-only operations, there could be a key error.</li>
<li>Except for the read-only operation with follower read, the client may connect to a follower who cannot append a command.</li>
<li>The client may connect to a server in a minority partition of servers.
<ul>
<li>The PutAppend command is appended to the log but cannot commit.</li>
<li>For the read-only operation with follower read, it connects to its leader, but its leader cannot receive a majority response. Hence, it cannot acquire a ReadIndex.</li>
</ul>
</li>
<li>For read-only operations with follower read,
<ul>
<li>The KV Server is associated with a leader, and its leader sets a higher commit index when communicating with the majority. But the Raft leader crashed before committing that entry, leaving the KV server waiting to apply as up-to-date as the ReadIndex.</li>
<li>The client may connect to a partition without a leader and, hence, cannot acquire ReadIndex.</li>
</ul>
</li>
</ol>
<h1 id="what-should-be-stored-in-a-snapshot"><a class="markdownIt-Anchor" href="#what-should-be-stored-in-a-snapshot"></a> What should be stored in a snapshot?</h1>
<ol>
<li>Of course, we need to store the state of all key-value pairs.</li>
<li>We must also store the last index executed for each client so far to recognize duplicated commands even after a crash.</li>
<li>The index of the last applied entry is also stored to prevent the first command after recovery is a read-only operation.</li>
</ol>
<h1 id="what-needs-to-be-done-to-recover-the-state-after-a-crash"><a class="markdownIt-Anchor" href="#what-needs-to-be-done-to-recover-the-state-after-a-crash"></a> What needs to be done to recover the state after a crash?</h1>
<ol>
<li>First, we need to install the latest snapshot persisted.</li>
<li>But that is not enough if only the KV server crashes while the associated Raft server is still running since there might still be some committed entries not included in the snapshot yet applied before the crash. The KV server needs to acquire those committed entries to truly bring itself back to the state right before the crash.</li>
</ol>
<h1 id="execution-speed-of-get-operation"><a class="markdownIt-Anchor" href="#execution-speed-of-get-operation"></a> Execution speed of Get operation:</h1>
<ol>
<li>When running the test without enabling snapshot:
<ul>
<li>The time spent for each operation of the un-optimized implementation will become slower as the number of operations grows. This is because each Raft server’s log becomes larger and slower to persist.</li>
<li>When executing the Get operation, the log of optimized implementation won’t increase. Hence, it won’t slow down the execution.</li>
<li>When executing <em>3000</em> Get operations, the un-optimized implementation needs about <em>50 ms/op</em>, while the optimized implementation only needs <em>1.7 ms/op</em>, about 29 times the speedup.</li>
</ul>
</li>
<li>When running the test enabling snapshot:
<ul>
<li>The time spent on the un-optimized implementation has become stable since the log size has become stable. However, when only executing the Get operation, the optimized implementation does not need the benefit of trimming logs.</li>
<li>When executing <em>3000</em> Get operations, the un-optimized implementation needs about <em>14.7 ms/op</em>, while the optimized implementation is still <em>1.7 ms/op</em>, about <em>8.6</em> times speedup.</li>
<li>I think that the speedup of the optimized read-only scheme comes from two parts: follower concurrency that increased the total bandwidth between clients and servers and the persisting time saved by eliminating Get operation entries from logs.</li>
</ul>
</li>
</ol>
<h1 id="execution-speed-of-putappend-operation"><a class="markdownIt-Anchor" href="#execution-speed-of-putappend-operation"></a> Execution speed of PutAppend operation:</h1>
<ol>
<li>When executing <em>1000</em> Put operations without enabling snapshots, both implementations need about <em>29.5 ms/op</em>. Executing Append operations needs about the same amount of time.</li>
<li>When executing <em>1000</em> Put operations enabling snapshot, both implementations need about <em>13.9 ms/op</em>. Executing Append operations needs about the same amount of time.</li>
<li>Thus, with snapshot enabled, it can achieve about <em>2.1</em> times speedup. I think the speedup mainly comes from the persisting time saved by shrinking the log.</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://liyun-zhang.github.io/2023/03/26/OpenSource/6.824/Lab-2-Raft/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LiyunZhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LiyunZhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LiyunZhang">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/03/26/OpenSource/6.824/Lab-2-Raft/" class="post-title-link" itemprop="url">Lab 2: Raft</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-03-26 13:57:11" itemprop="dateCreated datePublished" datetime="2023-03-26T13:57:11+08:00">2023-03-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-03-17 11:28:50" itemprop="dateModified" datetime="2024-03-17T11:28:50+08:00">2024-03-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Open-Source-Code/" itemprop="url" rel="index"><span itemprop="name">Open Source Code</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Open-Source-Code/6-824/" itemprop="url" rel="index"><span itemprop="name">6.824</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><ul class="markdownIt-TOC">
<li><a href="#leader-election">Leader election</a>
<ul>
<li><a href="#how-to-count-the-votes-a-candidate-gets">How to count the votes a candidate gets?</a></li>
<li><a href="#how-does-each-server-initial-an-election">How does each server initial an election?</a></li>
<li><a href="#how-can-we-prevent-partitioned-followers-from-ending-up-in-a-high-term">How can we prevent partitioned followers from ending up in a high term?</a></li>
</ul>
</li>
<li><a href="#log-replication">Log Replication</a>
<ul>
<li><a href="#how-does-the-leader-send-log-entries-to-followers">How does the leader send log entries to followers?</a></li>
<li><a href="#how-to-optimize-the-consistency-check-protocol">How to optimize the consistency check protocol?</a></li>
<li><a href="#how-should-a-follower-accept-log-entries-after-passing-all-consistency-checks">How should a follower accept log entries after passing all consistency checks?</a></li>
<li><a href="#how-will-each-server-commit-an-index">How will each server commit an index?</a></li>
<li><a href="#how-does-the-leader-check-which-entries-can-be-committed">How does the leader check which entries can be committed?</a></li>
<li><a href="#what-is-the-constraint-of-committing-uncommitted-entries-of-earlier-terms">What is the constraint of committing uncommitted entries of earlier terms?</a></li>
</ul>
</li>
<li><a href="#persistence">Persistence</a>
<ul>
<li><a href="#when-a-server-restarts-what-information-should-it-restore">When a server restarts, what information should it restore?**</a></li>
<li><a href="#when-will-invoke-persist">When will invoke persist()?</a></li>
</ul>
</li>
<li><a href="#log-compaction">Log compaction</a>
<ul>
<li><a href="#how-to-deal-with-those-deleted-entries-when-a-server-restarts">How to deal with those deleted entries when a server restarts?</a></li>
<li><a href="#how-to-take-a-snapshot">How to take a snapshot?</a></li>
<li><a href="#how-to-install-a-snapshot">How to install a snapshot?</a></li>
</ul>
</li>
</ul>
</p>
<h1 id="leader-election"><a class="markdownIt-Anchor" href="#leader-election"></a> Leader election</h1>
<h2 id="how-to-count-the-votes-a-candidate-gets"><a class="markdownIt-Anchor" href="#how-to-count-the-votes-a-candidate-gets"></a> How to count the votes a candidate gets?</h2>
<ol>
<li>The candidate begins a new goroutine to request votes from each server.</li>
<li>Use a shared variable to track how many votes the candidate has gotten. After this vote, each goroutine monitors that the candidate has gotten enough votes to become a leader independently.</li>
<li>When each goroutine receives a reply from other peers, it needs to check whether the reply is still in the same term as the term where it is now and whether it is still a candidate.
<ul>
<li>Only checking its state is insufficient. The check of the term is in case delayed replies arrive in the future election initialed by this server.</li>
</ul>
</li>
<li>My initial thought
<ul>
<li>The election goroutine will monitor the process of votes instead of the request goroutines.</li>
<li>Then the check loop in the election goroutine needs to sleep after each time it fails. Or the election would be hard to converge.</li>
<li>I GUESS that the reason is the for-loop never ends and takes too many resources, causing the CPU to not schedule the RequestVote goroutine and later election goroutines in time.</li>
</ul>
</li>
</ol>
<h2 id="how-does-each-server-initial-an-election"><a class="markdownIt-Anchor" href="#how-does-each-server-initial-an-election"></a> How does each server initial an election?</h2>
<ol>
<li>A timestamp records the last time heard from a leader or candidate. And <code>electionTimeout</code> is set randomly at the startup and beginning of the election.
<ul>
<li>Each time the server wants to change its state into a follower, it must reset the timestamp before switching, or it may trigger a new election due to the stale timestamp.</li>
<li>When the replied term is larger than the term of sending <code>AppendEntries</code>, the leader should know that itself is out-of-date. But before any further settings, it should check whether the replied term is larger than the term where it is now to prevent this being a stale reply processed with a stale term, causing currectTerm to decrease.</li>
</ul>
</li>
<li><code>ticker()</code> will check periodically whether the time since the timestamp is larger than the <code>electionTimeout</code> and if so, a new election is initiated.
<ul>
<li>When the checking is failed, this goroutine should sleep for a short time. However, it cannot simply sleep as long as <code>electionTimeout</code> because the next sleep may be shorter than <code>electionTimeout</code>.</li>
</ul>
</li>
<li>Another way is to set the <code>electionTimeout </code> when checking the condition instead of fixing the electionTimeout`` between two elections.
<ul>
<li>But this will cause multiple peers to initiate an election in a short gap. In addition to the unreliable network and the burden of scheduling goroutines, the <code>RequestVote()</code> may not be executed by others immediately, causing severe brain split and re-elections.</li>
<li>The reason, I GUESS, is that it only needs one short sleep time to kick off the election. And with a new random sleep time every <code>CHECKTIMEOUT</code> ms, there is a greater probability that one sleep time is short, which shortens the <code>electionTimeout</code> I want.</li>
</ul>
</li>
</ol>
<h2 id="how-can-we-prevent-partitioned-followers-from-ending-up-in-a-high-term"><a class="markdownIt-Anchor" href="#how-can-we-prevent-partitioned-followers-from-ending-up-in-a-high-term"></a> How can we prevent partitioned followers from ending up in a high term?</h2>
<ol>
<li>The problem is that when a follower is partitioned, it cannot receive from the leader. It will try to be elected to be the leader. Yet, because it cannot connect to the majority of its peers, it can never succeed, causing it to keep increasing its term.</li>
<li>To solve the problem, we need to make a peer realize that it has no chance to be elected to be the leader and gives up increasing their term.
<ul>
<li>Before truly increasing its term, we can ask it to simulate the election, i.e., pre-vote.</li>
<li>During the pre-vote, the candidate will send the same data as the true election, and other peers will reply whether they will vote for a candidate.</li>
<li>An actual election is initiated until a peer has received a pre-vote from the majority.</li>
</ul>
</li>
<li>The difference between a pre-vote and an actual election:
<ul>
<li>The pre-vote can grant votes to different peers in the same term.</li>
<li>The pre-vote will not cause voters to increase the term and become followers.</li>
<li>The pre-vote happens before increasing the term.</li>
</ul>
</li>
<li>The disadvantage of the pre-vote is that it requires an extra round of RPC for an election.
<ul>
<li>This cost is significantly unacceptable when the network is too unreliable, causing many elections.</li>
<li>When the network is more stable, the elections are rare, and it can prevent partitioned followers from interrupting the current term.</li>
</ul>
</li>
</ol>
<h1 id="log-replication"><a class="markdownIt-Anchor" href="#log-replication"></a> Log Replication</h1>
<h2 id="how-does-the-leader-send-log-entries-to-followers"><a class="markdownIt-Anchor" href="#how-does-the-leader-send-log-entries-to-followers"></a> How does the leader send log entries to followers?</h2>
<ol>
<li><code>nextIndex</code> is the lowest index of entries missed by each peer known by the leader.</li>
<li>There are two situations for sending log entries: the first is when there are some un-replicated entries for some followers, and the second is the heartbeat message.
<ul>
<li><code>SyncLogWithFollower(x int)</code> is implemented to check whether server x has some missing entries.</li>
<li><code>Heartbeat()</code> is implemented to send a heartbeat message.</li>
<li><code>SendEntriesOnceTo(x int)</code> is implemented actually to send log entries to server x.</li>
<li>The <code>SyncLogWIthFollower()</code> goroutine for each server and the <code>Heartbeat()</code> goroutine is initiated when the server is elected leader.</li>
</ul>
</li>
<li>The difference between <code>SyncLogWithFollower()</code> and <code>Heartbeat()</code>
<ul>
<li><code>SyncLogWithFollower()</code> sends entries only when there are missing entries in server x. But <code>Heartbeat()</code> always sends entries even when there are no missing entries, in which case an empty log is sent.</li>
<li>The check cycle in <code>SyncLogWithFollower()</code> is way shorter than the sending cycle in <code>Heartbeat()</code> to ensure the missing entries can be replicated as soon as possible.</li>
</ul>
</li>
<li>When <code>SyncLogWithFollower()</code> calls <code>SendEntriesOnceTo()</code>, it cannot create a goroutine.
<ul>
<li>Because the check cycle in <code>SyncLogWithFollower()</code> is quite short, if the <code>SyncLogWithFollower()</code> goroutine keeps being scheduled, the <code>SendEntriesOnceTo()</code> cannot send entries to the follower. Thus, the <code>SyncLogWithFollower()</code> goroutine keeps creating too many <code>SendEntriesOnceTo()</code> goroutine.</li>
</ul>
</li>
<li>My initial thought
<ul>
<li>Start a <code>SendEntriesOnceTo()</code> goroutine for every follower after <code>Start()</code> has added a new log entry to the leader’s logs instead of using <code>SyncLogWithFollower()</code> goroutine.</li>
<li>But concurrent Start() may cause multiple <code>SendEntriesOnceTo()</code> goroutines to send the same RPC to the same follower.</li>
</ul>
</li>
</ol>
<h2 id="how-to-optimize-the-consistency-check-protocol"><a class="markdownIt-Anchor" href="#how-to-optimize-the-consistency-check-protocol"></a> How to optimize the consistency check protocol?</h2>
<ol>
<li>Additional AppenEntries RPC results for fast rollback:
<ul>
<li><code>Xterm</code>: the term of the conflicting entry.</li>
<li><code>Xindex</code>: the first index in <code>Xterm</code>.</li>
<li><code>Xlen</code>: the length of the log</li>
</ul>
</li>
<li>Fast rollback implementation:
<ul>
<li>If the leader doesn’t have <code>Xterm</code>, then every entry of Xterm in the follower’s log will cause conflict. Hence, the <code>nextIndex</code> can back up to <code>Xindex</code>.</li>
<li>If the leader has <code>Xterm</code>, the matching entry in the leader’s log must have a term no larger than <code>Xterm</code>. Hence, the <code>nextIndex</code> should go back to the next entry of the last Xterm in the leader’s log.</li>
<li>If the follower’s conflict is due to empty in <code>prevLogTerm</code>, then <code>Xterm</code> is set to <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">-1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">−</span><span class="mord">1</span></span></span></span>, and the leader should back up to <code>Xlen</code>.</li>
</ul>
</li>
</ol>
<h2 id="how-should-a-follower-accept-log-entries-after-passing-all-consistency-checks"><a class="markdownIt-Anchor" href="#how-should-a-follower-accept-log-entries-after-passing-all-consistency-checks"></a> How should a follower accept log entries after passing all consistency checks?</h2>
<ol>
<li>The <code>nextIndex</code> and <code>logs</code> of the leader can be updated by different goroutines of <code>SendEntriesOnce()</code> and <code>Start()</code>. So it is possible that <code>args.Entries</code> are chosen through a stale <code>nextIndex</code> and an up-to-date <code>log</code> or even a stale <code>nextIndex</code> and a stale <code>log</code>.</li>
<li>If the <code>nextIndex</code> is stale while the <code>log</code> is up-to-date, i.e., there are some entries after the nextIndex is already replicated by the follower.
<ul>
<li>Then we need to drop those replicated entries, but not all, since there could still be some new entries.</li>
<li>We need to drop those entries with the same index and the same term according to the Log Matching property and append only those different entries.</li>
<li>I didn’t consider the case of <code>nextIndex</code> being larger than the follower’s replicated indices. Transmission won’t succeed, and a fast backup will be triggered.</li>
</ul>
</li>
<li>If both the <code>nextIndex</code> and <code>logs</code> are stale, it is similar to the former situation since the only additional problem is that it cannot be brought up-to-date by one <code>AppendEntries</code>.</li>
</ol>
<h2 id="how-will-each-server-commit-an-index"><a class="markdownIt-Anchor" href="#how-will-each-server-commit-an-index"></a> How will each server commit an index?</h2>
<ol>
<li><code>commitIndex</code> is the highest index of entries that can commit now. This is included in the <code>AppendEntries</code> arguments from leader to followers.</li>
<li><code>lastApplied</code> is the highest index of committed entries. If <code>lastApplied</code> is no larger than <code>commitIndex</code>, a server can commit the entry next to <code>lastApplied</code>.</li>
<li>Followers cannot modify <code>commitIndex</code> before the logs are synchronized since there may be some entries that need to be wiped out by the leader.</li>
</ol>
<h2 id="how-does-the-leader-check-which-entries-can-be-committed"><a class="markdownIt-Anchor" href="#how-does-the-leader-check-which-entries-can-be-committed"></a> How does the leader check which entries can be committed?</h2>
<ol>
<li>My solution
<ul>
<li><code>matchIndex</code> tracks the highest indices of entries replicated by each peer.</li>
<li>When a group of entries that ends with index <code>i</code> is accepted by one peer, the leader first sets the corresponding <code>matchIndex</code> to <code>i</code>.</li>
<li>Then, check whether a majority of <code>matchIndex</code> is larger than <code>i</code>. If so, the leader can commit at least until <code>i</code>, or it won’t commit any entry.</li>
</ul>
</li>
<li>Improvement
<ul>
<li>When a lagged peer replicated a lot of entries, it may be insufficient to commit the last entry it replicated. It could be sufficient to commit some earlier entries.</li>
<li>We only need to commit the k-th largest index in <code>matchIndex</code>.</li>
</ul>
</li>
<li>My initial thought
<ul>
<li>Track the replication state of each entry instead of each peer.</li>
<li>However, the entries are a lot more than peers, causing higher time complexity to maintain when a lot of entries are by peers.</li>
</ul>
</li>
</ol>
<h2 id="what-is-the-constraint-of-committing-uncommitted-entries-of-earlier-terms"><a class="markdownIt-Anchor" href="#what-is-the-constraint-of-committing-uncommitted-entries-of-earlier-terms"></a> What is the constraint of committing uncommitted entries of earlier terms?</h2>
<ol>
<li>A constraint on commit entries is that each leader can only commit entries added to the term. And by committing such entries, they also commit all entries before it. Hence, the entries of earlier terms are committed indirectly.</li>
<li>But there is a corner case where a leader doesn’t receive any entry at the beginning of its term, causing those uncommitted entries of earlier terms not to be committed.</li>
<li>My solution is that when a server becomes the leader, it will add an empty entry, and by this empty entry, those uncommitted entries can be committed.</li>
<li>However, the test system of 6.824 didn’t consider this case. This implementation will cause all tests to fail.</li>
</ol>
<h1 id="persistence"><a class="markdownIt-Anchor" href="#persistence"></a> Persistence</h1>
<h2 id="when-a-server-restarts-what-information-should-it-restore"><a class="markdownIt-Anchor" href="#when-a-server-restarts-what-information-should-it-restore"></a> When a server restarts, what information should it restore?**</h2>
<ol>
<li>Naturally, it must restore its <code>currentTerm</code>, <code>votedFor</code>, and <code>logs</code> from the persisted state.</li>
<li>Then, it needs to set its <code>lastLogIndex</code> and <code>lastLogTerm</code> appropriately.</li>
<li>The <code>lastApplied</code>, <code>commitIndex</code>, and <code>lastIncludedIndex</code> will be set to the index of the sentinel entry.
<ul>
<li>Because the current state is the same state executed until the sentinel entry.</li>
<li>In the future, if the server finds that other peers have committed later entries, it needs to re-execute those entries to achieve the same state.</li>
</ul>
</li>
<li>It should update its <code>lastApplied</code> to the last committed entry according to the commit state in each log entry.</li>
</ol>
<h2 id="when-will-invoke-persist"><a class="markdownIt-Anchor" href="#when-will-invoke-persist"></a> When will invoke persist()?</h2>
<ol>
<li><code>persist()</code> is called only when <code>rf.currentTerm</code>, <code>rf.votedFor</code>, or <code>rf.logs</code> is changed.</li>
<li>When they’re changed, the <code>rf.mu</code> lock must be held by the caller of <code>persist()</code>. I won’t release the lock until the <code>persist()</code> is finished to store the states as soon as possible.</li>
<li>Modifying the three variables several times before communicating with outside or releasing the lock is possible. In that case, we use a variable to mark whether persist is needed instead of really calling <code>persist()</code> each time. And only call the <code>persist()</code> at the end.</li>
</ol>
<h1 id="log-compaction"><a class="markdownIt-Anchor" href="#log-compaction"></a> Log compaction</h1>
<h2 id="how-to-deal-with-those-deleted-entries-when-a-server-restarts"><a class="markdownIt-Anchor" href="#how-to-deal-with-those-deleted-entries-when-a-server-restarts"></a> How to deal with those deleted entries when a server restarts?</h2>
<ol>
<li>When a server restores its state from <code>readPersist()</code>, we want it to re-execute those persisted logs.</li>
<li>But we don’t need to re-execute those deleted entries since we can get to the state of the last deleted log by restoring the snapshot without execution.</li>
<li>The effect is the same as we have committed those missing entries. So, we also need to modify the <code>lastApplied</code> and <code>commitIndex</code> to the last deleted log index before re-executing.</li>
</ol>
<h2 id="how-to-take-a-snapshot"><a class="markdownIt-Anchor" href="#how-to-take-a-snapshot"></a> How to take a snapshot?</h2>
<ol>
<li>In this lab, the snapshot is naive. It simply stores all the log entries.</li>
<li>Hence, the server must set <code>lastIncludedIndex</code> and <code>lastIncludedTerm</code> appropriately, and all the snapshotted entries must be removed.</li>
<li>Also, if the log is empty after removal, we need to insert the sentinel entry back into the entry. Its command is still unimportant.</li>
</ol>
<h2 id="how-to-install-a-snapshot"><a class="markdownIt-Anchor" href="#how-to-install-a-snapshot"></a> How to install a snapshot?</h2>
<ol>
<li>The snapshot data only contains commands in log entries, so we need to recover the log entries with the snapshot.
<ul>
<li>Their indices and commands are easy to understand.</li>
<li>We only know the <code>lastIncludedterm</code>. Also, the leader has already committed to these entries. Thus, no matter what happens, these entries will not be overwritten, and no <code>AppendEntry</code> will need to compare with these entries except for the last one. Hence, for convenience, I set all their terms to the <code>LastIncludedTerm</code>.</li>
<li>As aforementioned, these entries are already reflected in the snapshot. Thus, there is no need to re-commit them again.</li>
</ul>
</li>
<li>Then, we need to determine whether the snapshot contains new information.
<ul>
<li><code>FirstUncover</code> indicates the first entry in <code>logs</code> that is more up-to-date than the last entry in the snapshot.
<ul>
<li>If the snapshot contains new information not already in the recipient’s log, then <code>firstUncover == len(rf.logs)</code>.</li>
<li>If the snapshot describes a prefix of its log, then <code>firstUncover &lt; len(rf.logs)</code>, we only need to delete the former entries.</li>
</ul>
</li>
<li>I thought that maybe I needed to compare the <code>lastLogIndex</code> in the server and the <code>LastIncludedIndex</code> in the snapshot, but this is insufficient.
<ul>
<li>Some servers need to discard the last few entries from earlier leaders, yet they are not in the current leader’s logs.</li>
<li>We need to remove the entries whose term is smaller than the <code>LastIncludedTerm</code> of the snapshot and whose index is larger than the <code>LastIncludedIndex</code>.</li>
</ul>
</li>
</ul>
</li>
<li>If the snapshot contains new information
<ul>
<li>We will discard all log entries and insert a new sentinel entry with an index equal to <code>LastIncludedIndex</code> and a term equal to <code>LastIncludedTerm</code>.</li>
<li>Then <code>commitIndex</code> and <code>lastApplied</code> need to be updated to <code>LastIncludedIndex</code> since we won’t re-execute those new entries in the snapshot.</li>
<li>It needs to be persisted.</li>
</ul>
</li>
<li>If the snapshot describes only a prefix of logs, then discard the covered entries. But don’t discard those covered yet uncommitted entries, and leave one entry as a dummy entry.</li>
<li>If PrevLog is already trimmed, we should find the entry with the same index as the sentinel. Make it the new <code>PrevLog</code>, and only accept the entries following it.</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="Previous page" aria-label="Previous page" href="/about/page/4/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/about/">1</a><span class="space">&hellip;</span><a class="page-number" href="/about/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/about/page/6/">6</a><a class="page-number" href="/about/page/7/">7</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/about/page/6/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">LiyunZhang</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" rel="noopener" target="_blank">NexT.Mist</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>







  




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.7/katex.min.css" integrity="sha256-hLTCMFlKxdNgPXyWlSSxYN0ykJmxxq9Yt3MNfdRGWeA=" crossorigin="anonymous">



</body>
</html>

<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"liyun-zhang.github.io","root":"/","images":"/images","scheme":"Mist","darkmode":true,"version":"8.17.0","exturl":false,"sidebar":{"position":"right","display":"hide","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="LiyunZhang">
<meta property="og:url" content="http://liyun-zhang.github.io/about/page/5/index.html">
<meta property="og:site_name" content="LiyunZhang">
<meta property="og:locale">
<meta property="article:author" content="LiyunZhang">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://liyun-zhang.github.io/about/page/5/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-Hans","comments":"","permalink":"","path":"about/page/5/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>LiyunZhang</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">LiyunZhang</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">LiyunZhang</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">63</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">29</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://liyun-zhang.github.io/2023/06/24/Courses/15445/04-Data-Organization/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LiyunZhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LiyunZhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LiyunZhang">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/06/24/Courses/15445/04-Data-Organization/" class="post-title-link" itemprop="url">04 Data Organization</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-06-24 17:12:22" itemprop="dateCreated datePublished" datetime="2023-06-24T17:12:22+08:00">2023-06-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-09-26 14:00:28" itemprop="dateModified" datetime="2023-09-26T14:00:28+08:00">2023-09-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Open-Courses/" itemprop="url" rel="index"><span itemprop="name">Open Courses</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Open-Courses/CMU-15-445-645-Database-System/" itemprop="url" rel="index"><span itemprop="name">CMU 15-445/645 Database System</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><ul class="markdownIt-TOC">
<li><a href="#what-does-the-database-access-methods-layer-need-to-do">What does the database access methods layer need to do?</a></li>
<li><a href="#hash-table">Hash table</a>
<ul>
<li><a href="#how-is-the-naive-static-hash-table">How is the naive static hash table?</a></li>
<li><a href="#what-are-hash-functions">What are hash functions?</a></li>
<li><a href="#static-hashing-schemes">Static hashing schemes</a>
<ul>
<li><a href="#how-is-linear-probe-hashing">How is linear probe hashing?</a></li>
<li><a href="#how-to-solve-the-non-unique-keys-problem">How to solve the non-unique keys problem?</a></li>
<li><a href="#how-is-the-robin-hood-hashing">How is the robin hood hashing?</a></li>
<li><a href="#how-is-the-cuckoo-hashing">How is the cuckoo hashing?</a></li>
</ul>
</li>
<li><a href="#dynamic-hashing-schemes">Dynamic hashing schemes</a>
<ul>
<li><a href="#how-is-chained-hashing">How is chained hashing?</a></li>
<li><a href="#how-is-extendible-hashing">How is extendible hashing?</a></li>
<li><a href="#how-is-linear-hashing">How is linear hashing?</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#tree">Tree</a>
<ul>
<li><a href="#table-indexes">Table indexes</a>
<ul>
<li><a href="#what-does-table-indexs-do">What does table indexs do?</a></li>
<li><a href="#what-is-clustered-indexes">What is clustered indexes?</a></li>
</ul>
</li>
<li><a href="#basic-b-tree">Basic B+ Tree</a>
<ul>
<li><a href="#what-is-a-b-tree">What is a B+ Tree?</a></li>
<li><a href="#how-is-keyvalue-pairs-stored-in-each-node">How is key/value pairs stored in each node?</a></li>
<li><a href="#what-is-stored-is-leaf-node">What is stored is leaf node?</a></li>
<li><a href="#what-is-the-pros-and-cons-of-b-tree-compare-with-btree">What is the pros and cons of B-Tree compare with B+Tree?</a></li>
<li><a href="#how-does-btree-insert-a-node">How does B+Tree insert a node?</a></li>
<li><a href="#how-does-btree-delete-a-node">How does B+Tree delete a node?</a></li>
</ul>
</li>
<li><a href="#btree-usage-and-design">B+Tree usage and design</a>
<ul>
<li><a href="#how-does-dbms-use-btree-in-selection-query">How does DBMS use B+Tree in selection query?</a></li>
<li><a href="#how-to-handle-duplicate-keys">How to handle duplicate keys?</a></li>
<li><a href="#how-to-solve-redundant-page-jump-when-sequential-access-leaf-nodes">How to solve redundant page jump when sequential access leaf nodes?</a></li>
<li><a href="#how-to-choose-node-size">How to choose node size?</a></li>
<li><a href="#how-to-choose-merge-threshold">How to choose merge threshold?</a></li>
<li><a href="#how-to-handle-variable-length-keys">How to handle variable length keys?</a></li>
<li><a href="#how-can-we-do-the-intra-node-search">How can we do the intra-node search?</a></li>
<li><a href="#how-can-we-optimize-space-usage">How can we optimize space usage?</a></li>
<li><a href="#how-can-we-optimize-consumed-time">How can we optimize consumed time?</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</p>
<h1 id="what-does-the-database-access-methods-layer-need-to-do"><a class="markdownIt-Anchor" href="#what-does-the-database-access-methods-layer-need-to-do"></a> What does the database access methods layer need to do?</h1>
<ol>
<li>
<p>Data Organization</p>
<ul>
<li>How we layout data structure in memory/pages and what information to store to support efficient access.</li>
<li>This layer will in charge of the organization of all kinds of data inside database, e.g. internal meta-data, core data storage, temporary data structures, table indexes.</li>
</ul>
</li>
<li>
<p>Concurrency</p>
<ul>
<li>How to enable multiple threads to access the data structure at the same time without causing problems.</li>
</ul>
</li>
<li>
<p>There are two types of data structure: hash tables and trees.</p>
</li>
</ol>
<h1 id="hash-table"><a class="markdownIt-Anchor" href="#hash-table"></a> Hash table</h1>
<h2 id="how-is-the-naive-static-hash-table"><a class="markdownIt-Anchor" href="#how-is-the-naive-static-hash-table"></a> How is the naive static hash table?</h2>
<ol>
<li>
<p>A hash table implements an unordered associative array that maps keys to values.</p>
</li>
<li>
<p>For any input key, hash functions return an integer representation of that key.</p>
</li>
<li>
<p>The space complexity is <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span>, the average time complexity is <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span></span></span></span> and the worst time complexity is <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span>.</p>
<ul>
<li>Databases need to are about constants. For time complexity, smaller constants can save much time in billions of operations.</li>
<li>The space will be several times larger than the number of keys.</li>
</ul>
</li>
<li>
<p>The naive static hash table assumes:</p>
<ul>
<li>The number of elements is known ahead of time and fixed.</li>
<li>Each key is unique.</li>
<li>We have the perfect hash function where two different keys must have different hash values.</li>
</ul>
</li>
<li>
<p>These assumptions is not always satisfied.</p>
<ul>
<li>
<p>To suit when the first assumption failed, we need dynamic hashing scheme.</p>
</li>
<li>
<p>To suit when the last two assumptions failed, we need to design more delicate hash function to reduce collision rate and hashing scheme to handle collisions after hashing.</p>
<ul>
<li>
<p>The trade-off of hash function is between being fast and collision rate.</p>
</li>
<li>
<p>The trade-off of hashing scheme is between allocating a larger hash table and additional instructions to get/put keys.</p>
</li>
</ul>
</li>
</ul>
</li>
</ol>
<h2 id="what-are-hash-functions"><a class="markdownIt-Anchor" href="#what-are-hash-functions"></a> What are hash functions?</h2>
<ol>
<li>
<p>We do not want to use a cryptographic hash function for DBMS hash tables, e.g., SHA-2.</p>
<ul>
<li>Because this hashing is only using internally, we will never worry about leaking keys.</li>
<li>We want something that is fast and has a low collision rate.</li>
</ul>
</li>
<li>
<p>The commonly used hash functions are:</p>
<ul>
<li>CRC-64: Used in networking for error detection.</li>
<li>MurmurHash: Designed as a fast, general-purpose hash function.</li>
<li>Google CityHash: Designed to be faster for short keys (&lt;64 bytes).</li>
<li>Facebook XXHash: From the creator of zstd compression, which is the state-of-the-art.</li>
<li>Google Farmhash: Newer version of CityHash with better collision rates.</li>
</ul>
</li>
<li>
<p>Their speed comparison is as followed:</p>
<img src="/imgs/15445/Organization/hash_func.png" width="75%">
</li>
</ol>
<h2 id="static-hashing-schemes"><a class="markdownIt-Anchor" href="#static-hashing-schemes"></a> Static hashing schemes</h2>
<h3 id="how-is-linear-probe-hashing"><a class="markdownIt-Anchor" href="#how-is-linear-probe-hashing"></a> How is linear probe hashing?</h3>
<ol>
<li>As all the following schemes, a key-value paire is stored in hashing table. The key is to determin whether this is actually the key we want to find.</li>
<li>It resolve collisions by linearly searching for the next free slot in the table.</li>
<li>To determine whether an element is present, hash to a location in the index and scan for it. If find an empty slot before the key, then the element does not exists.</li>
<li>To delete an entry, there are two approaches:
<ul>
<li><strong>Movement</strong>: Rehash rest of the keys until find the first empty slot. Nobody actually does this.</li>
<li><strong>Tombstone</strong>: Set a marker to indicate that the entry in the slot is logically deleted. The slot can be reused for new keys. This may still need periodic garbage collection.</li>
</ul>
</li>
</ol>
<h3 id="how-to-solve-the-non-unique-keys-problem"><a class="markdownIt-Anchor" href="#how-to-solve-the-non-unique-keys-problem"></a> How to solve the non-unique keys problem?</h3>
<ol>
<li>The first choise is to store values in separate storage area for each key and the value of hash table points to the area.</li>
<li>The second choise is to store duplicate keys entries together in the hash table.
<ul>
<li>Read would return the first key they found.</li>
<li>Deletes would remove all the keys or a specific key-value pair.</li>
</ul>
</li>
</ol>
<h3 id="how-is-the-robin-hood-hashing"><a class="markdownIt-Anchor" href="#how-is-the-robin-hood-hashing"></a> How is the robin hood hashing?</h3>
<ol>
<li>This is a variant of linear probe hashing that steals slots from “rich” keys and give them to “poor” keys.
<ul>
<li>Each key tracks the number of positions they are from where its optimal position (original hash value) in the table.</li>
<li>The keys farther away from its optimal position is poorer while the keys closer is richer.</li>
<li>On insert, a key takes the slot of another key if the first key is “richer” than the second key. And the second key will keep searching linearly until it found another “richer” key.</li>
</ul>
</li>
<li>Stealing increases the number of writing operation compare with the linear probing scheme while may reduce the time of worst case.</li>
<li>This could have cascading/flooding problem where one insert causing multiple “stealing”. Also it does not consider the possibility of hot keys.</li>
</ol>
<h3 id="how-is-the-cuckoo-hashing"><a class="markdownIt-Anchor" href="#how-is-the-cuckoo-hashing"></a> How is the cuckoo hashing?</h3>
<ol>
<li>Use multiple hash tables with different hash function seeds to ensure they won’t hash to the same value.
<ul>
<li>On insert, check every table and pick anyone that has a free slot.</li>
<li>If no table has a free slot, choose one victim, evict it and then re-hash it find a new location.</li>
</ul>
</li>
<li>Look-ups and deletions are always <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span></span></span></span> because only one location per hash table is checked.</li>
<li>There is a possibility of cascading. The worst case is an infinite cascading loop.
<ul>
<li>We can use extra code to detect if replacing is going in a loop. If so, we need to double the hash table size with new hash functions and re-insert all keys.</li>
</ul>
</li>
</ol>
<h2 id="dynamic-hashing-schemes"><a class="markdownIt-Anchor" href="#dynamic-hashing-schemes"></a> Dynamic hashing schemes</h2>
<h3 id="how-is-chained-hashing"><a class="markdownIt-Anchor" href="#how-is-chained-hashing"></a> How is chained hashing?</h3>
<ol>
<li>It maintains a linked list of buckets for each slot in the hash table.</li>
<li>Resolve collisions by placing all elements with the same hash key into the same bucket.
<ul>
<li>To determine whether an element is present, hash to its bucket and scan for it.</li>
</ul>
</li>
<li>The problem is that the linked list can grow forever causing the time spent on search increases as the system runs.</li>
</ol>
<h3 id="how-is-extendible-hashing"><a class="markdownIt-Anchor" href="#how-is-extendible-hashing"></a> How is extendible hashing?</h3>
<ol>
<li>Multiple slot locations can point to the same bucket chain.</li>
<li>For the number of bits needs to examine, there is a global one and a local one.</li>
<li>It reshuffle bucket entries on split and increase the number of bits to examine when a list is full.
<ul>
<li>If there is only one slot pointing to this list, i.e. the global examining bits is the same as the local one,
<ul>
<li>The DBMS increases the global number causing the size of hashing table doubled.</li>
<li>Those lists with smaller local number will set the pointers of corresponding new slots (with only the last global examining bit different) still to themselves.</li>
<li>DBMS also increases the local examining bits of the fulled list. The keys in it will re-hash to their two new lists.</li>
</ul>
</li>
<li>If there are more than one slots pointing to this list, i.e. the global examning bits is larger the the local one,
<ul>
<li>The DBMS only increases the local examining bits of the fulled list and do the re-hashing.</li>
</ul>
</li>
</ul>
</li>
</ol>
<h3 id="how-is-linear-hashing"><a class="markdownIt-Anchor" href="#how-is-linear-hashing"></a> How is linear hashing?</h3>
<ol>
<li>It is similar to extensible hashing. But the hash table maintains a pointer that tracks the next bucket to split.</li>
<li>When any bucket overflows, split the bucket at the pointer location.
<ul>
<li>When the split causing the number of slots in hash table doubled, it introduces a new hash function taking modulo with the new hash table size.</li>
</ul>
</li>
<li>It uses multiple hashes to find the right bucket for a given key.
<ul>
<li>It always first use the old hash function with smaller modulus.</li>
<li>If this hash value is smaller than the split pointer, which means that this slot has already been splitted, DBMS need to use the new hash function to find the true hash value.</li>
<li>Otherwise, this slot is not splitted and the old hash value works fine.</li>
</ul>
</li>
<li>Splitting buckets based on the split pointer will eventually get to all overflowed buckets.
<ul>
<li>When the pointer reaches the last slot, delete the first hash function and move back to beginning.</li>
</ul>
</li>
<li>Deleting may cause the size of hash table to shrink when it deleted the only entry in the second half of the hash table.
<ul>
<li>DMBS shrinks the size of hash table and deletes the new hash function.</li>
</ul>
</li>
</ol>
<h1 id="tree"><a class="markdownIt-Anchor" href="#tree"></a> Tree</h1>
<h2 id="table-indexes"><a class="markdownIt-Anchor" href="#table-indexes"></a> Table indexes</h2>
<h3 id="what-does-table-indexs-do"><a class="markdownIt-Anchor" href="#what-does-table-indexs-do"></a> What does table indexs do?</h3>
<ol>
<li>A table index is a replica of a subset of a table’s attributes that are organized and/or sorted for efficient access using those attributes.</li>
<li>It is used in queries to find tuples with attributes matches certain values.</li>
<li>The DBMS ensures that the contents of the table and the index are logically synchronized.</li>
<li>It is the DBMS’s job to figure out the best index(es) to use to execute each query.</li>
<li>There is a trade-off regarding the number of indexes to create per database, i.e. the lookup speed and synchronization overhead.
<ul>
<li>We need extra storage overhead to store the data structure and maintenance overhead to keep synchronization.</li>
</ul>
</li>
</ol>
<h3 id="what-is-clustered-indexes"><a class="markdownIt-Anchor" href="#what-is-clustered-indexes"></a> What is clustered indexes?</h3>
<ol>
<li>The table is stored in the sort order specified by the primary key.
<ul>
<li>It can be either heap- or index-organized storage.</li>
</ul>
</li>
<li>Some DBMSs always use a clustered index. If a table does not contain a primary key, the DBMS will<br />
automatically make a hidden primary key.</li>
<li>Other DBMSs cannot use them at all.</li>
</ol>
<h2 id="basic-b-tree"><a class="markdownIt-Anchor" href="#basic-b-tree"></a> Basic B+ Tree</h2>
<h3 id="what-is-a-b-tree"><a class="markdownIt-Anchor" href="#what-is-a-b-tree"></a> What is a B+ Tree?</h3>
<ol>
<li>A B+Tree is a self-balancing tree data structure that keeps data sorted and allows searches, sequential access, insertions, and deletions always in <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>log</mi><mo>⁡</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(\log n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span>.</li>
<li>A B+Tree is an M-way search tree.
<ul>
<li>It is perfectly balanced, i.e. every leaf node is at the same depth in the tree.</li>
<li>Every node other than the root is at least half-full, i.e. <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mi mathvariant="normal">/</mi><mn>2</mn><mo>−</mo><mn>1</mn><mo>≤</mo><mi>n</mi><mi>u</mi><mi>m</mi><mi>b</mi><mi>e</mi><mi>r</mi><mtext> </mtext><mi>o</mi><mi>f</mi><mtext> </mtext><mi>k</mi><mi>e</mi><mi>y</mi><mi>s</mi><mo>≤</mo><mi>M</mi><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">M/2-1 ≤ number\ of\ keys ≤ M-1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mord">/</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.78041em;vertical-align:-0.13597em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">n</span><span class="mord mathnormal">u</span><span class="mord mathnormal">m</span><span class="mord mathnormal">b</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mspace"> </span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mspace"> </span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mord mathnormal">s</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>.</li>
<li>Every inner node with <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> keys has <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">k+1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.77777em;vertical-align:-0.08333em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span> non-null children.</li>
</ul>
</li>
</ol>
<h3 id="how-is-keyvalue-pairs-stored-in-each-node"><a class="markdownIt-Anchor" href="#how-is-keyvalue-pairs-stored-in-each-node"></a> How is key/value pairs stored in each node?</h3>
<ol>
<li>Every B+Tree node is comprised of an array of key/value pairs.</li>
<li>The keys are derived from the attribute(s) that the index is based on.</li>
<li>The value stored in a inner node is a pointer to its corresponding children while the value stored in a leaf node is its specific value.</li>
<li>There are two storage methods for the key-value pair.
<ul>
<li>One is to store them consecutively, i.e. each value is stored immediately after its key.</li>
<li>The other is to store them in the same place in two arrays, i.e. each value has the same index as its key.</li>
</ul>
</li>
<li>The arrays are (usually) kept in sorted key order.</li>
</ol>
<h3 id="what-is-stored-is-leaf-node"><a class="markdownIt-Anchor" href="#what-is-stored-is-leaf-node"></a> What is stored is leaf node?</h3>
<ol>
<li>
<p>Each leaf node also has pointers points to its siblings.</p>
</li>
<li>
<p>There are two approaches to store the values:</p>
<ul>
<li>The first approach is to store them with record IDs which is a pointer to the page ID and offset of the tuple to which the index entry corresponds.</li>
<li>The second approach is to store them with tuple data, specifically primary keys.</li>
</ul>
</li>
<li>
<p>The pros of the second approach is that we do not need to access another address to fetch the contents when primary keys are all we want.</p>
<p>But seondary indexs must store the Record ID as their values. Hence if we want secondary indexs in second approach, we need to lookup another tables to find the Record ID with the same primary keys.</p>
</li>
</ol>
<h3 id="what-is-the-pros-and-cons-of-b-tree-compare-with-btree"><a class="markdownIt-Anchor" href="#what-is-the-pros-and-cons-of-b-tree-compare-with-btree"></a> What is the pros and cons of B-Tree compare with B+Tree?</h3>
<ol>
<li>The main difference is that  B-Tree stored keys and values in all nodes in the tree while B+Tree only stores values in leaf nodes. Inner nodes only guide the search process.</li>
<li>B-Tree is more space-efficient, since each key only appears once in the tree.</li>
<li>However, when we want to sequential access keys, B-Tree needs to jump between pages causing much more I/O.</li>
</ol>
<h3 id="how-does-btree-insert-a-node"><a class="markdownIt-Anchor" href="#how-does-btree-insert-a-node"></a> How does B+Tree insert a node?</h3>
<ol>
<li>Find correct leaf node L. Insert data entry into L in sorted order.</li>
<li>If L has enough space, then it is done.</li>
<li>Otherwise, split L keys into L and a new node L2. Insert index entry pointing to L2 into parent of L.
<ul>
<li>The parent of L may need rebalance after this insertion.</li>
</ul>
</li>
</ol>
<h3 id="how-does-btree-delete-a-node"><a class="markdownIt-Anchor" href="#how-does-btree-delete-a-node"></a> How does B+Tree delete a node?</h3>
<ol>
<li>Start at root, find leaf L where entry belongs. Remove the entry.</li>
<li>If L is at least half-full, then it is done.</li>
<li>If L has only M/2-1 entries,
<ul>
<li>First try to re-distribute, borrowing from sibling.</li>
<li>If re-distribution fails, merge L and sibling and delete entry (pointing to L or sibling) from parent of L.
<ul>
<li>The parent of L may need rebalance .</li>
</ul>
</li>
</ul>
</li>
</ol>
<h2 id="btree-usage-and-design"><a class="markdownIt-Anchor" href="#btree-usage-and-design"></a> B+Tree usage and design</h2>
<h3 id="how-does-dbms-use-btree-in-selection-query"><a class="markdownIt-Anchor" href="#how-does-dbms-use-btree-in-selection-query"></a> How does DBMS use B+Tree in selection query?</h3>
<ol>
<li>
<p>When creating an index, a certain order of attributes are specified to sort the tuple.</p>
<ul>
<li>
<p>When <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>A</mi><mn>1</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>A</mi><mi>n</mi></msub></mrow><annotation encoding="application/x-tex">A_1, \dots,A_n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> are specified, the B+Tree will store corresponding <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">n</span></span></span></span> values in as keys in each node.</p>
</li>
<li>
<p>When <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mn>1</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>a</mi><mi>n</mi></msub></mrow><annotation encoding="application/x-tex">a_1, \dots,a_n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> are stored in one node, all nodes in its left sub-tree have <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>A</mi><mn>1</mn></msub><mo>≤</mo><msub><mi>a</mi><mn>1</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>A</mi><mi>n</mi></msub><mo>≤</mo><msub><mi>a</mi><mi>n</mi></msub></mrow><annotation encoding="application/x-tex">A_1≤a_1,\dots,A_n≤a_n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> while all nodes in its right sub-tree only guarenteed with <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>A</mi><mn>1</mn></msub><mo>&gt;</mo><msub><mi>a</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">A_1 &gt; a_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>, i.e. the B+Tree is maintained with <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>A</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">A_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> as its primary sorting key.</p>
</li>
</ul>
</li>
<li>
<p>In a selection condition, we can easily select with certain condition on <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>A</mi><mn>1</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>A</mi><mi>k</mi></msub><mtext> </mtext><mo stretchy="false">(</mo><mi>k</mi><mo>≤</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">A_1,\dots,A_k\ (k≤n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace"> </span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span>. Some DBMS also support conditions specified only on <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>A</mi><mi>k</mi></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>A</mi><mi>n</mi></msub></mrow><annotation encoding="application/x-tex">A_k, \dots,A_n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>, which requires DBMS sequentially access all leaf nodes.</p>
</li>
<li>
<p>Compared with hash table, B+Tree can better support selection without a knowing attributes to lookup for.</p>
</li>
</ol>
<h3 id="how-to-handle-duplicate-keys"><a class="markdownIt-Anchor" href="#how-to-handle-duplicate-keys"></a> How to handle duplicate keys?</h3>
<ol>
<li>The first approach is to add the tuple’s unique Record ID as part of the key to ensure that all keys are unique.
<ul>
<li>The DBMS can still use partial keys to find tuples.</li>
</ul>
</li>
<li>The second approach is to allow leaf nodes to spill into overflow nodes that contain the duplicate keys.
<ul>
<li>Only duplicate keys of existing keys can overflow.</li>
<li>When split or merge nodes, overflow nodes also need to split or merge.</li>
<li>This is more complex to maintain and modify.</li>
</ul>
</li>
</ol>
<h3 id="how-to-solve-redundant-page-jump-when-sequential-access-leaf-nodes"><a class="markdownIt-Anchor" href="#how-to-solve-redundant-page-jump-when-sequential-access-leaf-nodes"></a> How to solve redundant page jump when sequential access leaf nodes?</h3>
<ol>
<li>In a clustered B+Tree, nodes in the same page are in consecutive order.
<ul>
<li>We can traverse to the left-most leaf page and then retrieve tuples from all leaf pages.</li>
<li>This will always be better than sorting data for each query.</li>
</ul>
</li>
<li>In a non-clustered B+Tree, the DBMS can first figure out all the tuples that it needs and then sort them based on their Page ID.</li>
</ol>
<h3 id="how-to-choose-node-size"><a class="markdownIt-Anchor" href="#how-to-choose-node-size"></a> How to choose node size?</h3>
<ol>
<li>The slower the storage device, the larger the optimal node size for a B+Tree.
<ul>
<li>HDD takes <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mtext> </mtext><mi>M</mi><mi>B</mi></mrow><annotation encoding="application/x-tex">1\ MB</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord">1</span><span class="mspace"> </span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span>, SSD usually takes <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>10</mn><mtext> </mtext><mi>K</mi><mi>B</mi></mrow><annotation encoding="application/x-tex">10\ KB</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord">0</span><span class="mspace"> </span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span>, in-memory nodes have <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>512</mn><mtext> </mtext><mi>B</mi></mrow><annotation encoding="application/x-tex">512\ B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord">5</span><span class="mord">1</span><span class="mord">2</span><span class="mspace"> </span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span>.</li>
</ul>
</li>
<li>Optimal sizes can vary depending on the workload. The trade off is between leaf node scans and root-to-leaf traversals.
<ul>
<li>With larger size, we can have more sequential reads in leaf node scans, but we need to read more data in root-to-leaf traversals.</li>
</ul>
</li>
</ol>
<h3 id="how-to-choose-merge-threshold"><a class="markdownIt-Anchor" href="#how-to-choose-merge-threshold"></a> How to choose merge threshold?</h3>
<ol>
<li>Some DBMSs do not always merge nodes when they are half full.</li>
<li>Delaying a merge operation may reduce the amount of reorganization. They assume that the missing part will be filled soon.</li>
<li>It may also be better to just let smaller nodes exist and then periodically rebuild entire tree.</li>
</ol>
<h3 id="how-to-handle-variable-length-keys"><a class="markdownIt-Anchor" href="#how-to-handle-variable-length-keys"></a> How to handle variable length keys?</h3>
<ol>
<li>The first approach is to store the keys as pointers to the tuple’s attribute.</li>
<li>The second approach is to allow variable-length nodes. It requires careful memory management.</li>
<li>The third approach is always to pad the key to be max length of the key type.</li>
<li>The last approach is key map or indirection. It is similar to the in-node dictionary.</li>
</ol>
<h3 id="how-can-we-do-the-intra-node-search"><a class="markdownIt-Anchor" href="#how-can-we-do-the-intra-node-search"></a> How can we do the intra-node search?</h3>
<ol>
<li>The naive method is linear search. We can use SIMD to vectorize the process.</li>
<li>The second method is binary search given that keys in a node are already sorted.</li>
<li>The third method is interpolation search.
<ul>
<li>This requires known distribution of keys.</li>
<li>It jumps to approximate location of desired key based on known distribution.</li>
</ul>
</li>
</ol>
<h3 id="how-can-we-optimize-space-usage"><a class="markdownIt-Anchor" href="#how-can-we-optimize-space-usage"></a> How can we optimize space usage?</h3>
<ol>
<li>Prefix compression
<ul>
<li>Sorted keys in the same leaf node are likely to have the same prefix.</li>
<li>Extract common prefix and store only unique suffix for each key.</li>
</ul>
</li>
<li>Deduplication
<ul>
<li>Non-unique indexes can end up storing multiple copies of the same key in leaf nodes.</li>
<li>Store the key once and then maintain a list of tuples with that key.</li>
</ul>
</li>
<li>Suffix truncation
<ul>
<li>The keys in the inner nodes are only used to “direct traffic”. We don’t need the entire key.</li>
<li>Store a minimum prefix that is needed to correctly route probes into the index.</li>
</ul>
</li>
</ol>
<h3 id="how-can-we-optimize-consumed-time"><a class="markdownIt-Anchor" href="#how-can-we-optimize-consumed-time"></a> How can we optimize consumed time?</h3>
<ol>
<li>Pointer swizzling
<ul>
<li>Nodes use page ids to reference other nodes in the index. The DBMS must get the memory location from the page table during traversal.</li>
<li>If a page is pinned in the buffer pool, then we can store raw pointers instead of page IDs. This avoids address lookups from the page table.</li>
</ul>
</li>
<li>Bulk insert
<ul>
<li>The fastest way to build a new B+Tree for an existing table is to first sort the keys and then build the index from the bottom up.</li>
</ul>
</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://liyun-zhang.github.io/2023/06/24/Courses/15445/03-Buffer-Pool-Manage/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LiyunZhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LiyunZhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LiyunZhang">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/06/24/Courses/15445/03-Buffer-Pool-Manage/" class="post-title-link" itemprop="url">03 Buffer Pool Manage</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-06-24 17:12:13" itemprop="dateCreated datePublished" datetime="2023-06-24T17:12:13+08:00">2023-06-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-09-26 14:00:23" itemprop="dateModified" datetime="2023-09-26T14:00:23+08:00">2023-09-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Open-Courses/" itemprop="url" rel="index"><span itemprop="name">Open Courses</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Open-Courses/CMU-15-445-645-Database-System/" itemprop="url" rel="index"><span itemprop="name">CMU 15-445/645 Database System</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><ul class="markdownIt-TOC">
<li><a href="#buffer-pool-manage">Buffer pool manage</a>
<ul>
<li><a href="#what-does-databse-storage-need-to-control">What does databse storage need to control?</a></li>
<li><a href="#how-is-buffer-pool-organized">How is buffer pool organized?</a></li>
<li><a href="#clarification-what-is-the-locks-and-latches-referenced-in-database">Clarification: What is the locks and latches referenced in database?</a></li>
<li><a href="#how-can-we-optimize-performance-with-multiple-buffer-pools">How can we optimize performance with multiple buffer pools?</a></li>
<li><a href="#how-can-we-optimize-performance-with-pre-fetching">How can we optimize performance with pre-fetching?</a></li>
<li><a href="#how-can-we-optimize-performance-with-scan-sharing">How can we optimize performance with scan sharing?</a></li>
<li><a href="#how-can-we-optimize-performance-with-buffer-pool-bypass">How can we optimize performance with buffer pool bypass?</a></li>
<li><a href="#should-we-use-os-page-cache">Should we use OS page cache?</a></li>
</ul>
</li>
<li><a href="#buffer-replacement-policies">Buffer replacement policies</a>
<ul>
<li><a href="#what-is-lru-least-recently-used-policy-and-clock-policy">What is LRU (Least-Recently Used) policy and clock policy?</a></li>
<li><a href="#what-is-the-problem-of-lru-and-clock-how-to-alleviate">What is the problem of LRU and clock, how to alleviate?</a></li>
<li><a href="#how-do-we-deal-with-evicted-pages">How do we deal with evicted pages?</a></li>
</ul>
</li>
</ul>
</p>
<h1 id="buffer-pool-manage"><a class="markdownIt-Anchor" href="#buffer-pool-manage"></a> Buffer pool manage</h1>
<h2 id="what-does-databse-storage-need-to-control"><a class="markdownIt-Anchor" href="#what-does-databse-storage-need-to-control"></a> What does databse storage need to control?</h2>
<ol>
<li>Spatial Control: Where to write pages on disk.
<ul>
<li>The goal is to keep pages that are used together often as physically close together as possible on disk.</li>
</ul>
</li>
<li>Temporal Control: When to read pages into memory, and when to write them to disk.
<ul>
<li>The goal is to minimize the number of stalls from having to read data from disk.</li>
</ul>
</li>
</ol>
<h2 id="how-is-buffer-pool-organized"><a class="markdownIt-Anchor" href="#how-is-buffer-pool-organized"></a> How is buffer pool organized?</h2>
<ol>
<li>Memory region organized as an array of fixed-size pages. An array entry is called a <strong>frame</strong>.
<ul>
<li>Pages are in disk while frames are in memory.</li>
</ul>
</li>
<li>When the DBMS requests a page, an exact copy is placed into one of these frames.</li>
<li>The buffer pool manager need to maintain a <strong>page table</strong> to keep track of pages that are currently in memory.
<ul>
<li>The page table is the mapping from page ids to a copy of the page in buffer pool frames.
<ul>
<li>This is an in-memory data structure that does not need to be stored on disk.</li>
</ul>
</li>
<li>The page directory is the mapping from page ids to page locations in the database files.
<ul>
<li>All changes must be recorded on disk to allow the DBMS to find on restart.</li>
</ul>
</li>
</ul>
</li>
<li>Some additional meta-data per page also need to be maintained:
<ul>
<li><strong>Dirty flag</strong>: Mark whether a page has been modified. Used to know whether can safely evict this page.</li>
<li><strong>Pin/reference counter</strong>: Some query use it to prevent buffer pool manager from evicting this page. They unpin this page after no-longer use it.</li>
<li><strong>Latches</strong>: Can be used to pre-occupy an entry in page table, and release the latch after copied that page and updated the entry.</li>
<li>These meta-data can either be stored in page or page table.</li>
</ul>
</li>
</ol>
<h2 id="clarification-what-is-the-locks-and-latches-referenced-in-database"><a class="markdownIt-Anchor" href="#clarification-what-is-the-locks-and-latches-referenced-in-database"></a> Clarification: What is the locks and latches referenced in database?</h2>
<ol>
<li>Locks:
<ul>
<li>It protects the database’s logical contents from other transactions.</li>
<li>It is held for transaction duration. Need to be able to rollback changes.</li>
<li>Locks can be taken on a tuple or table, but not on a page.</li>
</ul>
</li>
<li>Latches:
<ul>
<li>It protects the critical sections of the DBMS’s internal data structure from other threads.</li>
<li>It is held for operation duration. Do not need to be able to rollback changes.</li>
<li>This is similar to the mutex provided by OS.</li>
</ul>
</li>
</ol>
<h2 id="how-can-we-optimize-performance-with-multiple-buffer-pools"><a class="markdownIt-Anchor" href="#how-can-we-optimize-performance-with-multiple-buffer-pools"></a> How can we optimize performance with multiple buffer pools?</h2>
<ol>
<li>Advantages:
<ul>
<li>Different pool can have different evict policy to improve locality.</li>
<li>Each time accessing meta-data of each buffer pool need to take a latch. Multiple buffer pool can reduce latch contention.</li>
</ul>
</li>
<li>The manager can use per-database buffer pool, per-page type buffer pool or per-index type buffer pool.</li>
<li>Manger decide which pool to store pages in two approaches:
<ul>
<li>The first is to embed an object identifier in record ids and then maintain a mapping from objects to specific buffer pools.
<ul>
<li>This can be used to specify certain pages must be stored in specific pool.</li>
</ul>
</li>
<li>The other is to hash the page id to select which buffer pool to access.</li>
</ul>
</li>
</ol>
<h2 id="how-can-we-optimize-performance-with-pre-fetching"><a class="markdownIt-Anchor" href="#how-can-we-optimize-performance-with-pre-fetching"></a> How can we optimize performance with pre-fetching?</h2>
<ol>
<li>Pre-fetching can be easily used in two situations: sequential scans and index scans.</li>
<li>In sequential scans, when manager fetched the first few consecutive pages, it can infer that the next consecutive pages will be used soon and pre-fetch them into memory.</li>
<li>In index scans, the query may not access consecutive pages, but DBMS sees the B+ tree structure, and thus knows the where are the following indices.</li>
</ol>
<h2 id="how-can-we-optimize-performance-with-scan-sharing"><a class="markdownIt-Anchor" href="#how-can-we-optimize-performance-with-scan-sharing"></a> How can we optimize performance with scan sharing?</h2>
<ol>
<li>It allows multiple queries to attach to a single cursor that scans a table.
<ul>
<li>The queries do not have to be the same.</li>
<li>They can also share intermediate results.</li>
</ul>
</li>
<li>If a query wants to scan a table and another query is already doing this, then the DBMS will attach the second query’s cursor to the existing cursor.</li>
<li>After the ealier query finished, the later query will return to read the pages the earlier one already read before the later one begins.</li>
<li>If the later query has a <code>LIMIT</code> clause with out <code>WHERE</code> or <code>ORDER BY</code> clause, given that the relation is unordered, it may do not need to read extra data if those scan sharing data is enough to satisfy the <code>LIMIT</code> clause.</li>
</ol>
<h2 id="how-can-we-optimize-performance-with-buffer-pool-bypass"><a class="markdownIt-Anchor" href="#how-can-we-optimize-performance-with-buffer-pool-bypass"></a> How can we optimize performance with buffer pool bypass?</h2>
<ol>
<li>Sequential flooding: A query performs a sequential scan that reads every page.
<ul>
<li>This pollutes the buffer pool with pages that are read once and then never again.</li>
</ul>
</li>
<li>Buffer pool bypass will not store fetched pages in the buffer pool. Insteach, the manager has a private pool where those pages will be stored temporarily and deleted once finished.</li>
<li>It works well if operator needs to read a large sequence of pages that are contiguous on disk. It can also be used for temporary data (sorting, joins).</li>
</ol>
<h2 id="should-we-use-os-page-cache"><a class="markdownIt-Anchor" href="#should-we-use-os-page-cache"></a> Should we use OS page cache?</h2>
<ol>
<li>Most disk operations go through the OS API. Unless the DBMS tells it not to, the OS maintains its own filesystem cache.</li>
<li>Most DBMSs use direct I/O (<code>O_DIRECT</code>) to bypass the OS’s cache.</li>
<li>The OS page cache can cause redundant copies of pages. OS and DBMS have different eviction policies causing DBMS Loss of control over file I/O.</li>
</ol>
<h1 id="buffer-replacement-policies"><a class="markdownIt-Anchor" href="#buffer-replacement-policies"></a> Buffer replacement policies</h1>
<h2 id="what-is-lru-least-recently-used-policy-and-clock-policy"><a class="markdownIt-Anchor" href="#what-is-lru-least-recently-used-policy-and-clock-policy"></a> What is LRU (Least-Recently Used) policy and clock policy?</h2>
<ol>
<li>Manager maintain a single timestamp of when each page was last accessed.</li>
<li>When the DBMS needs to evict a page, select the one with the oldest timestamp.
<ul>
<li>It can keep the pages in sorted order to reduce the search time on eviction.</li>
</ul>
</li>
<li>An approximation of LRU that does not need a separate timestamp per page is clock policy.
<ul>
<li>Each page has a reference bit. When a page is accessed, set to <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>.</li>
<li>Organize the pages in a circular buffer with a “clock hand”: Upon sweeping, check if a page’s bit is set<br />
to 1. If yes, set to zero. If no, then evict.</li>
</ul>
</li>
</ol>
<h2 id="what-is-the-problem-of-lru-and-clock-how-to-alleviate"><a class="markdownIt-Anchor" href="#what-is-the-problem-of-lru-and-clock-how-to-alleviate"></a> What is the problem of LRU and clock, how to alleviate?</h2>
<ol>
<li>LRU and CLOCK replacement policies are susceptible to sequential flooding. And in some workloads the most recently used page is the most unneeded page.</li>
<li><strong>LRU-K</strong> policy can alleviate the problem.
<ul>
<li>Track the history of last K references to each page as timestamps and compute the average interval between subsequent accesses. And evict the one that will be accessed latest according to the prediction.</li>
<li>In the implementation, the manager only need to maintain a queue of size K. Pop out the oldest timestamp when a new timestamp arrives.</li>
</ul>
</li>
<li>Another policy is <strong>localization</strong>: The DBMS chooses which pages to evict on a per transaction/query basis, e.g. it allocate private frames to the query.</li>
<li><strong>Priority hints</strong>: The DBMS knows about the context of each page during query execution. It can provide hints to the buffer pool on whether a page is important or not.</li>
</ol>
<h2 id="how-do-we-deal-with-evicted-pages"><a class="markdownIt-Anchor" href="#how-do-we-deal-with-evicted-pages"></a> How do we deal with evicted pages?</h2>
<ol>
<li>Fast Path: If a page in the buffer pool is not dirty, then the DBMS can simply drop it.</li>
<li>Slow Path: If a page is dirty, then the DBMS must write back to disk to ensure that its changes are persisted.
<ul>
<li>The DBMS can periodically walk through the page table and write dirty pages to disk.</li>
<li>When a dirty page is safely written, the DBMS can either evict the page or just unset the dirty flag.</li>
<li>Need to be careful that the system doesn’t write dirty pages before their log records are written.</li>
</ul>
</li>
<li>The Trade-off is between fast evictions versus dirty writing pages that will not be read again in the future.</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://liyun-zhang.github.io/2023/06/24/Courses/15445/02-Storage/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LiyunZhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LiyunZhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LiyunZhang">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/06/24/Courses/15445/02-Storage/" class="post-title-link" itemprop="url">02 Storage</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-06-24 17:10:07" itemprop="dateCreated datePublished" datetime="2023-06-24T17:10:07+08:00">2023-06-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-02-23 00:05:25" itemprop="dateModified" datetime="2024-02-23T00:05:25+08:00">2024-02-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Open-Courses/" itemprop="url" rel="index"><span itemprop="name">Open Courses</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Open-Courses/CMU-15-445-645-Database-System/" itemprop="url" rel="index"><span itemprop="name">CMU 15-445/645 Database System</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><ul class="markdownIt-TOC">
<li><a href="#disk-based-architecture">Disk-based architecture</a>
<ul>
<li><a href="#what-are-the-storage-devices">What are the storage devices?</a></li>
<li><a href="#what-is-disk-oriented-dmbs">What is disk-oriented DMBS?</a></li>
<li><a href="#why-not-use-the-os-memory-mapping-virtual-memory">Why not use the OS memory mapping (virtual memory)?</a></li>
</ul>
</li>
<li><a href="#page-oriented-architecture">Page-oriented architecture</a>
<ul>
<li><a href="#file-storage">File storage</a>
<ul>
<li><a href="#how-does-dbms-store-files">How does DBMS store files?</a></li>
<li><a href="#how-does-dbms-manage-pages-in-files-on-disk">How does DBMS manage pages in files on disk?</a></li>
</ul>
</li>
<li><a href="#page-layout">Page layout</a>
<ul>
<li><a href="#what-is-stored-in-each-page">What is stored in each page?</a></li>
<li><a href="#how-to-organize-tuple-oriented-data">How to organize tuple-oriented data?</a></li>
<li><a href="#how-do-we-find-the-tuple-we-need-in-a-page">How do we find the tuple we need in a page?</a></li>
</ul>
</li>
<li><a href="#tuple-layout">Tuple layout</a>
<ul>
<li><a href="#what-is-stored-in-a-tuple">What is stored in a tuple?</a></li>
<li><a href="#what-is-denormalized-data">What is denormalized data?</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#log-structured-storage">Log-structured storage</a>
<ul>
<li><a href="#what-is-stored-in-log-structured-storage">What is stored in log-structured storage?</a></li>
<li><a href="#how-to-read-in-a-log-structured-storage">How to read in a log-structured storage?</a></li>
<li><a href="#how-to-solve-that-the-log-will-become-larger-and-larger">How to solve that the log will become larger and larger?</a></li>
</ul>
</li>
<li><a href="#tuple-storage">Tuple storage</a>
<ul>
<li><a href="#how-to-store-data-in-a-tuple">How to store data in a tuple?</a></li>
<li><a href="#what-are-supported-data-types">What are supported data types?</a></li>
</ul>
</li>
<li><a href="#data-storage-models">Data storage models</a>
<ul>
<li><a href="#what-kind-of-database-workloads-are-there">What kind of database workloads are there?</a></li>
<li><a href="#how-does-dbms-store-tuples">How does DBMS store tuples?</a></li>
<li><a href="#database-compression">Database compression</a>
<ul>
<li><a href="#why-do-we-need-database-compression-and-what-is-the-trade-off">Why do we need database compression and what is the trade-off?</a></li>
<li><a href="#why-can-we-compress-data">Why can we compress data?</a></li>
<li><a href="#what-is-the-goals-of-compression">What is the goals of compression?</a></li>
<li><a href="#what-are-the-compression-granularities">What are the compression granularities?</a></li>
<li><a href="#what-is-the-naive-compression">What is the naive compression?</a></li>
<li><a href="#how-can-we-do-better-with-the-high-level-meaning-or-semantics-of-the-data">How can we do better with the high-level meaning or semantics of the data?</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</p>
<h1 id="disk-based-architecture"><a class="markdownIt-Anchor" href="#disk-based-architecture"></a> Disk-based architecture</h1>
<h2 id="what-are-the-storage-devices"><a class="markdownIt-Anchor" href="#what-are-the-storage-devices"></a> What are the storage devices?</h2>
<ol>
<li>The first type is the volatile memory: CPU registers, CPU caches and DRAM
<ul>
<li>They provide random access and they are byte-addressable.</li>
</ul>
</li>
<li>The second type is the non-volatile disks: SSD, HDD and network storage.
<ul>
<li>They only provide sequential access.
<ul>
<li>Random access on non-volatile storage is almost always much slower than sequential access.</li>
<li>DBMS will want to maximize sequential access.</li>
</ul>
</li>
<li>They are block-addressable.</li>
</ul>
</li>
<li>The access times of each storage is as followed:<br />
<img src="/imgs/15445/Storage/access_times.png" width="50%"></li>
</ol>
<h2 id="what-is-disk-oriented-dmbs"><a class="markdownIt-Anchor" href="#what-is-disk-oriented-dmbs"></a> What is disk-oriented DMBS?</h2>
<ol>
<li>The DBMS assumes that the primary storage location of the database is on non-volatile disk.</li>
<li>DBMS manages a buffer pool in memory where directory and data pages are stored.</li>
<li>When execution engine asks DBMS for a certain page:
<ul>
<li>If that page is not in memory already, DBMS will look up directory first (if also not in memory, load from disk) to find the disk position of that page.</li>
<li>Then DBMS will load that page from disk and return a pointer to the buffer pool to execution engine.</li>
</ul>
</li>
</ol>
<h2 id="why-not-use-the-os-memory-mapping-virtual-memory"><a class="markdownIt-Anchor" href="#why-not-use-the-os-memory-mapping-virtual-memory"></a> Why not use the OS memory mapping (virtual memory)?</h2>
<ol>
<li>Transaction safety: OS can flush dirty pages at any time causing dirty data corrupt database. OS doesn’t know anything about transaction, hence it doesn’t care whether it is safe to write a page to disk.</li>
<li>IO stalls: When a page miss happens, the thread will be stalled and DBMS can do nothing about it.
<ul>
<li>Allowing multiple threads to access the <code>mmap</code> files to hide page fault stalls is good enough for read-only access. But it is complicated when there are multiple writers.</li>
</ul>
</li>
<li>Error handling: Any access can cause a <code>SIGBUS</code> that the DBMS must handle. However, DBMS may isolate the error and handle it only in the storage layer.</li>
<li>Performance issues: Like OS data structure contention or TLB shootdowns.</li>
<li>In conclusion, DBMS always knows better than OS. Thus DBMS almost always wants to control things itself and can do a better job than the OS.
<ul>
<li>Like how to flush dirty pages to disk in the correct order, provide specialized prefetching, better buffer replacement policy and thread/process scheduling.</li>
</ul>
</li>
</ol>
<h1 id="page-oriented-architecture"><a class="markdownIt-Anchor" href="#page-oriented-architecture"></a> Page-oriented architecture</h1>
<h2 id="file-storage"><a class="markdownIt-Anchor" href="#file-storage"></a> File storage</h2>
<h3 id="how-does-dbms-store-files"><a class="markdownIt-Anchor" href="#how-does-dbms-store-files"></a> How does DBMS store files?</h3>
<ol>
<li>The DBMS stores a database as one or more files on disk typically in a proprietary format.</li>
<li>The storage manager is responsible for maintaining a database’s files.
<ul>
<li>It organizes the files as a collection of pages.</li>
<li>It also tracks data read/written to pages and the available space.</li>
<li>Some do their own scheduling for reads and writes to improve spatial and temporal locality of pages.</li>
</ul>
</li>
<li>A database page is a fixed-size block of data.
<ul>
<li>Most systems do not mix page types, i.e. data in a page belong to the same table.</li>
<li>Some systems require a page to be self-contained, i.e. all metadata we need to interpret the page has to be contained in the page in itself.</li>
<li>Hardware pages and OS pages are usually <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>4</mn><mtext> </mtext><mi>K</mi><mi>B</mi></mrow><annotation encoding="application/x-tex">4\ KB</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord">4</span><span class="mspace"> </span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span>. But database pages may be <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>512</mn><mtext> </mtext><mi>B</mi><mo>−</mo><mn>16</mn><mtext> </mtext><mi>K</mi><mi>B</mi></mrow><annotation encoding="application/x-tex">512\ B-16\ KB</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord">5</span><span class="mord">1</span><span class="mord">2</span><span class="mspace"> </span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord">6</span><span class="mspace"> </span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span> depending on DBMS and configuration.
<ul>
<li>Larger page size can increase sequential IO, issue less system call and have a smaller page table.</li>
<li>Smaller page size only need to maintain less memory when only need small amout of data.</li>
</ul>
</li>
</ul>
</li>
</ol>
<h3 id="how-does-dbms-manage-pages-in-files-on-disk"><a class="markdownIt-Anchor" href="#how-does-dbms-manage-pages-in-files-on-disk"></a> How does DBMS manage pages in files on disk?</h3>
<ol>
<li>There are different ways to manage: Heap File Organization, Tree File Organization, Sequential / Sorted File Organization (ISAM), or Hashing File Organization.</li>
<li>A heap file is an unordered collection of pages with tuples that are stored in random order.</li>
<li>The DBMS maintains directory in special pages that tracks the location of data pages in the database files.
<ul>
<li>Must make sure that the directory pages are in sync with the data pages.</li>
<li>The directory also records meta-data about available space: the number of free slots per page and list of free / empty pages.</li>
</ul>
</li>
</ol>
<h2 id="page-layout"><a class="markdownIt-Anchor" href="#page-layout"></a> Page layout</h2>
<h3 id="what-is-stored-in-each-page"><a class="markdownIt-Anchor" href="#what-is-stored-in-each-page"></a> What is stored in each page?</h3>
<ol>
<li>Every page contains a header of meta-data about the page’s contents.
<ul>
<li>Page Size</li>
<li>Checksum to check whether data is corrupted</li>
<li>DBMS version of creator of this page, to provide compatibility even when DBMS update changed the page layout. With this, when DBMS is updated, it can correct re-layout the data.</li>
<li>Transaction Visibility</li>
<li>Compression Information</li>
</ul>
</li>
<li>The data in a page can be organize in tuple-oriented or log-structured.</li>
</ol>
<h3 id="how-to-organize-tuple-oriented-data"><a class="markdownIt-Anchor" href="#how-to-organize-tuple-oriented-data"></a> How to organize tuple-oriented data?</h3>
<ol>
<li>A naive strategy is to store the number of tuples in the header, and just append a new tuple to the end.
<ul>
<li>What if we delete a tuple?
<ul>
<li>How do we know there are available space?</li>
<li>What do we do to the following tuples? Do we move them forward, or just leave them there?</li>
</ul>
</li>
<li>More serious problem is what happens if we have a variable-length attribute?
<ul>
<li>How can we know the begin and end of a tuple?</li>
</ul>
</li>
</ul>
</li>
<li>In the slotted pages scheme, we store a <strong>slot array</strong> at the header.
<ul>
<li>The slot array maps “slots” to the tuples’ starting position offsets.</li>
<li>The header keeps track of the number of used slots and the offset of the starting location of the last slot used.</li>
<li>The space used to store tuples grows from tail to head, while the slot array grows from head to tail.</li>
<li>When a tuple is deleted, we need to invalidate its value in slot array where we can know available space.
<ul>
<li>As for its following tuples, we can either leave them as be, or compact the space.</li>
<li>As modification goes in memory, and deleting is usually holding a lock, compact the space can be fast and there is no need to inform rest of the system.</li>
</ul>
</li>
<li>
<img src="/imgs/15445/Storage/slot-array.png" width="25%">
</li>
</ul>
</li>
</ol>
<h3 id="how-do-we-find-the-tuple-we-need-in-a-page"><a class="markdownIt-Anchor" href="#how-do-we-find-the-tuple-we-need-in-a-page"></a> How do we find the tuple we need in a page?</h3>
<ol>
<li>Each tuple is assigned a unique record identifier.</li>
<li>Most commonly used is <code>page_id + offset/slot</code>.</li>
</ol>
<h2 id="tuple-layout"><a class="markdownIt-Anchor" href="#tuple-layout"></a> Tuple layout</h2>
<h3 id="what-is-stored-in-a-tuple"><a class="markdownIt-Anchor" href="#what-is-stored-in-a-tuple"></a> What is stored in a tuple?</h3>
<ol>
<li>A tuple is essentially a sequence of bytes. It’s the job of the DBMS to interpret those bytes into attribute types and values.</li>
<li>Each tuple is prefixed with a header that contains meta-data about it, e.g visibility info for concurrency control, Bit Map for NULL values.
<ul>
<li>We do not need to store meta-data about the schema.</li>
</ul>
</li>
<li>Attributes are typically stored in the order that you specify them when you create the table.</li>
</ol>
<h3 id="what-is-denormalized-data"><a class="markdownIt-Anchor" href="#what-is-denormalized-data"></a> What is denormalized data?</h3>
<ol>
<li>DBMS can physically denormalize (pre-join) related tuples and store them together in the same page.
<ul>
<li>For two tables, one table has an attribute referenced to another table, DBMS can store the tuples and thier referenced tuples in the same slot.</li>
<li>
<img src="/imgs/15445/Storage/denorm_declare.png" width="25%">
</li>
<li>
<img src="/imgs/15445/Storage/denorm_diagram.png" width="25%">
</li>
</ul>
</li>
<li>This can potentially reduces the amount of I/O for common workload patterns but also make updates more expensive.</li>
</ol>
<h1 id="log-structured-storage"><a class="markdownIt-Anchor" href="#log-structured-storage"></a> Log-structured storage</h1>
<h2 id="what-is-stored-in-log-structured-storage"><a class="markdownIt-Anchor" href="#what-is-stored-in-log-structured-storage"></a> What is stored in log-structured storage?</h2>
<ol>
<li>DBMS stores log records that contain changes to tuples (PUT, DELETE).
<ul>
<li>Each log record must contain the tuple’s unique identifier. In this case, the identifier is not <code>page_id + offset/slot</code> metioned above since page doesn’t exists in this scheme.</li>
</ul>
</li>
<li>As the application makes changes to the database, the DBMS appends log records to the end of the file without checking previous log records.</li>
<li>When the page gets full, the DBMS writes it out disk and starts filling up the next page with records.
<ul>
<li>All on-disk pages are immutable.</li>
<li>All disk writes are sequential.</li>
</ul>
</li>
</ol>
<h2 id="how-to-read-in-a-log-structured-storage"><a class="markdownIt-Anchor" href="#how-to-read-in-a-log-structured-storage"></a> How to read in a log-structured storage?</h2>
<ol>
<li>To read a tuple with a given id, the DBMS finds the newest log record corresponding to that id. It needs to scan log from newest to oldest.
<ul>
<li>To optimize the linear scan, DBMS can maintain an index that maps a tuple id to the newest log record.</li>
</ul>
</li>
<li>If log record is in-memory, just read it. If log record is on a disk page, retrieve it.</li>
</ol>
<h2 id="how-to-solve-that-the-log-will-become-larger-and-larger"><a class="markdownIt-Anchor" href="#how-to-solve-that-the-log-will-become-larger-and-larger"></a> How to solve that the log will become larger and larger?</h2>
<ol>
<li>The DBMS can periodically compact pages to reduce wasted space.
<ul>
<li>It can take two continuous pages and scan from newest to oldest leaving one newest log for each tuple.</li>
</ul>
</li>
<li>The DBMS can sort the page based on id order to improve efficiency of future look-ups.
<ul>
<li>This sorted table is called <strong>Sorted String Tables</strong>, <strong>SSTables</strong>.</li>
<li>After a page is compacted, the DBMS does need to maintain temporal ordering of records within the page since each tuple id is guaranteed to appear at most once in the page.</li>
</ul>
</li>
<li>There are two strategy to choose which pages to compact:
<ul>
<li>The Universal compaction chooses any two continuous pages.</li>
<li>The level compaction chooses two continuous pages in the same level, and compacts them into next level.</li>
</ul>
</li>
<li>The downsides of compaction is write-amplification caused by duplicate writing to the newest record of a tuple, and also compacting itself is expensive.</li>
</ol>
<h1 id="tuple-storage"><a class="markdownIt-Anchor" href="#tuple-storage"></a> Tuple storage</h1>
<h2 id="how-to-store-data-in-a-tuple"><a class="markdownIt-Anchor" href="#how-to-store-data-in-a-tuple"></a> How to store data in a tuple?</h2>
<ol>
<li>A tuple is essentially a sequence of bytes. It’s the job of the DBMS to interpret those bytes into attribute types and values.</li>
<li>The DBMS’s catalogs contain the schema information about tables that the system uses to figure out the tuple’s layout.
<ul>
<li>A DBMS stores meta-data about databases in its internal catalogs.
<ul>
<li>Tables, columns, indexes, views</li>
<li>Users, permissions</li>
<li>Internal statistics</li>
</ul>
</li>
</ul>
</li>
</ol>
<h2 id="what-are-supported-data-types"><a class="markdownIt-Anchor" href="#what-are-supported-data-types"></a> What are supported data types?</h2>
<ol>
<li>The basic types are supported: <code>INTEGER</code>/<code>BIGINT</code>/<code>SMALLINT</code>/<code>TINYINT</code>, <code>FLOAT</code>/<code>REAL</code>, <code>VARCHAR</code>/<code>VARBINARY</code>/<code>TEXT</code>/<code>BLOB</code>, <code>TIME</code>/<code>DATE</code>/<code>TIMESTAMP</code>.</li>
<li>Since IEEE 754 floating points may be inaccurate, fixed-point decimals are also supported as <code>NUMERIC</code>/<code>DECIMAL</code>. But their execution is way slower than floating points.</li>
<li>Most DBMSs don’t allow a tuple to exceed the size of a single page.
<ul>
<li>To store values that are larger than a page, the DBMS uses separate <strong>overflow</strong> storage pages.</li>
<li>Some systems allow you to store a really large value in an external file. And treat the data as a BLOB type. Then the DBMS cannot manipulate the contents of an external file.
<ul>
<li>No durability protections. No transaaction protections.</li>
<li>They are outside of DBMS, hence we cannot update it through DBMS either.</li>
</ul>
</li>
</ul>
</li>
</ol>
<h1 id="data-storage-models"><a class="markdownIt-Anchor" href="#data-storage-models"></a> Data storage models</h1>
<h2 id="what-kind-of-database-workloads-are-there"><a class="markdownIt-Anchor" href="#what-kind-of-database-workloads-are-there"></a> What kind of database workloads are there?</h2>
<ol>
<li>On-Line Transaction Processing (OLTP): In this situation, commands are fast operations that only read/update a small amount of data each time. The data accessed in a query is related to a single entity in the database.</li>
<li>On-Line Analytical Processing (OLAP): Here, commands are complex queries that read a lot of data to compute aggregates, i.e. it will execute complex writes and complex reads.</li>
<li>Hybrid Transaction + Analytical Processing: OLTP + OLAP together on the same database instance.</li>
</ol>
<h2 id="how-does-dbms-store-tuples"><a class="markdownIt-Anchor" href="#how-does-dbms-store-tuples"></a> How does DBMS store tuples?</h2>
<ol>
<li><strong>N-ary storage model</strong> (<strong>row storage</strong>): The DBMS stores all attributes for a single tuple contiguously in a page.
<ul>
<li>This model is ideal for OLTP workloads where queries tend to operate only on an individual entity and insert-heavy workloads.</li>
<li>The advantage is fast inserts, updates, and deletes. It is also good for queries that need the entire tuple.</li>
<li>However, it is not good for scanning large portions of the table and/or a subset of the attributes.</li>
</ul>
</li>
<li><strong>Decomposition storage model</strong> (<strong>DSM</strong>, <strong>Column storage</strong>): The DBMS stores the values of a single attribute for all tuples contiguously in a page.
<ul>
<li>This model is ideal for OLAP workloads where read-only queries perform large scans over a subset of the table’s attributes.</li>
<li>DBMS can identify tuple in two choices:
<ul>
<li>The first is using fixed-length offsets when each value is the same length for an attribute. It does not require each attributes to have the same length. This is the most used scheme.</li>
<li>The second is using embedded tuple ids. Each value is stored with its tuple id in a column.</li>
</ul>
</li>
<li>The advantages of DSM is that it reduces the amount wasted I/O because the DBMS only reads the data that it needs, and provides better query processing and data compression.</li>
<li>The disadvantage is that it is slow for point queries, inserts, updates, and deletes because of tuple splitting/stitching.</li>
</ul>
</li>
</ol>
<h2 id="database-compression"><a class="markdownIt-Anchor" href="#database-compression"></a> Database compression</h2>
<h3 id="why-do-we-need-database-compression-and-what-is-the-trade-off"><a class="markdownIt-Anchor" href="#why-do-we-need-database-compression-and-what-is-the-trade-off"></a> Why do we need database compression and what is the trade-off?</h3>
<ol>
<li>I/O is the main bottleneck if the DBMS fetches data from disk during query execution.</li>
<li>The DBMS can compress pages to increase the utility of the data moved per I/O operation.</li>
<li>The key trade-off is between speed and compression ratio.
<ul>
<li>To get a better compression ratio, it will take a higher CPU costs to both compress and decompress. But it can reduces DRAM requirements.</li>
<li>Some engines may work with compressed data, which can reduce CPU costs.</li>
</ul>
</li>
</ol>
<h3 id="why-can-we-compress-data"><a class="markdownIt-Anchor" href="#why-can-we-compress-data"></a> Why can we compress data?</h3>
<ol>
<li>Data sets tend to have highly skewed distributions for attribute values.</li>
<li>Data sets tend to have high correlation between attributes of the same tuple.</li>
</ol>
<h3 id="what-is-the-goals-of-compression"><a class="markdownIt-Anchor" href="#what-is-the-goals-of-compression"></a> What is the goals of compression?</h3>
<ol>
<li>It must produce fixed-length values. The only exception is var-length data stored in separate pool.</li>
<li>Late materialization: Postpone decompression for as long as possible during query execution.</li>
<li>It must be a lossless scheme.
<ul>
<li>When a DBMS uses compression, it is always lossless because people don’t like losing data.</li>
<li>Any kind of lossy compression must be performed at the application level.</li>
</ul>
</li>
</ol>
<h3 id="what-are-the-compression-granularities"><a class="markdownIt-Anchor" href="#what-are-the-compression-granularities"></a> What are the compression granularities?</h3>
<ol>
<li>Block-level: Compression is performed on a block of tuples for the same table.</li>
<li>Tuple-level: Compression is performed on the contents of the entire tuple (NSM-only).</li>
<li>Attribute-level: Compression is performed on a single attribute within one tuple (overflow). It can target multiple attributes for the same tuple.</li>
<li>Column-level: Compression is performed on multiple values for one or more attributes stored for multiple tuples (DSM-only).</li>
</ol>
<h3 id="what-is-the-naive-compression"><a class="markdownIt-Anchor" href="#what-is-the-naive-compression"></a> What is the naive compression?</h3>
<ol>
<li>Naive means that data system does not understand the bits after compression.</li>
<li>We can compress data using a general-purpose algorithm. The scope of compression is only based on the data provided as input.</li>
<li>In disk, each page not only stores the compressed data, also stores the modification log of this page.</li>
<li>When DBMS read a page into the buffer pool
<ul>
<li>It won’t decompress until queries actually need to return the whole tuple back.</li>
<li>Every update will only append an entry in the mod log. Hence no need to decompress data when only updating tuples. This only thing we need to know in updating is which page this tuple is.</li>
<li>When mod log is full, DBMS will decompress page and apply changes.</li>
</ul>
</li>
</ol>
<h3 id="how-can-we-do-better-with-the-high-level-meaning-or-semantics-of-the-data"><a class="markdownIt-Anchor" href="#how-can-we-do-better-with-the-high-level-meaning-or-semantics-of-the-data"></a> How can we do better with the high-level meaning or semantics of the data?</h3>
<ol>
<li>This is performed on column-level.</li>
<li>Run-length encoding:
<ul>
<li>Compress runs of continuous same value in a single column into triplets: <code>(value, offset, length) </code>.
<ul>
<li><code>Value</code> is the value of the attribute.</li>
<li><code>Offset</code> is the start position in the column segment of the continuous save value run.</li>
<li><code>Length</code> is the number of elements in the run.</li>
</ul>
</li>
<li>It requires the columns to be sorted intelligently to maximize compression opportunities.</li>
</ul>
</li>
<li>Bit-packing encoding:
<ul>
<li>When values for an attribute are always less than the value’s declared largest size, store them as smaller data type.</li>
<li><strong>Mostly encoding</strong> uses a special marker to indicate when a value exceeds largest size and maintains a look-up table to store them.</li>
</ul>
</li>
<li>Bitmap encoding:
<ul>
<li>Store a separate bitmap for <strong>each unique value</strong> for an attribute where an offset in the vector corresponds to a tuple.</li>
<li>When reading, DBMS need to look into the bits in the tuple to find which bit is <code>1</code> to know which value is stored in this attribute of this tuple.</li>
<li>We need to store the value for each bitmap. So the total space needed is the total length of possible values and the number of bits same as the number of tuples for each value.</li>
</ul>
</li>
<li>Delta encoding:
<ul>
<li>Recording the difference between this tuple and its last tuple.</li>
<li>Store base value in-line or in a separate look-up table.</li>
<li>Combine with RLE to get even better compression ratios.</li>
</ul>
</li>
<li>Incremental encoding:
<ul>
<li>Delta encoding is for numbers, while incremental encoding is for string.</li>
<li>It stores the length of common prefixes between this tuples and its last tuple and the extra suffixes of this tuple.</li>
<li>When there is no common prefix, the length is <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span>. It performs better when we sorted tuples according to the strings.</li>
</ul>
</li>
<li>Dictionary compression (most widely used):
<ul>
<li>Build a data structure that maps variable-length values to a smaller integer identifier. And replace those values with their corresponding identifier in the dictionary data structure.</li>
<li>The dictionary is required to support fast encoding , decoding and range queries.</li>
<li>Hash function can not be used due to key confliction and unable to provide deoding.</li>
<li>When the dictionary encode values in certain order (e.g. alphabetic order), the execution engine can be optimized to do some queries only access dictionary, especially for those <code>DISTINCT</code> queries.</li>
</ul>
</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://liyun-zhang.github.io/2023/06/24/Courses/15445/01-Relational-Model/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LiyunZhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LiyunZhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LiyunZhang">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/06/24/Courses/15445/01-Relational-Model/" class="post-title-link" itemprop="url">01 Relational Model</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-06-24 15:14:56" itemprop="dateCreated datePublished" datetime="2023-06-24T15:14:56+08:00">2023-06-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-02-22 19:06:48" itemprop="dateModified" datetime="2024-02-22T19:06:48+08:00">2024-02-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Open-Courses/" itemprop="url" rel="index"><span itemprop="name">Open Courses</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Open-Courses/CMU-15-445-645-Database-System/" itemprop="url" rel="index"><span itemprop="name">CMU 15-445/645 Database System</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><ul class="markdownIt-TOC">
<li><a href="#database">Database</a>
<ul>
<li><a href="#why-shouldnt-we-just-store-database-in-a-flat-file-like-csv-that-we-manage-ourselve-in-our-application-code">Why shouldn’t we just store database in a flat file like CSV that we manage ourselve in our application code?</a></li>
<li><a href="#what-does-dbms-and-data-models-do">What does DBMS and data models do?</a></li>
<li><a href="#what-kinds-of-data-models-are-there">What kinds of data models are there?</a></li>
<li><a href="#how-does-document-data-model-store-data">How does document data model store data?</a></li>
</ul>
</li>
<li><a href="#relational-model">Relational model</a>
<ul>
<li><a href="#how-are-data-stored">How are data stored?</a></li>
<li><a href="#what-is-primary-keys-and-foreign-keys">What is primary keys and foreign keys?</a></li>
<li><a href="#what-is-supported-in-relational-algebra">What is supported in relational algebra?</a></li>
</ul>
</li>
<li><a href="#morden-sql">Morden SQL</a>
<ul>
<li><a href="#what-is-provided-in-a-relational-language">What is provided in a relational language?</a></li>
<li><a href="#aggregations-and-group-by">Aggregations and Group By</a>
<ul>
<li><a href="#what-are-aggregations">What are aggregations?</a></li>
<li><a href="#how-to-output-other-columns-with-aggregations">How to output other columns with aggregations?</a></li>
</ul>
</li>
<li><a href="#what-string-operations-are-supported">What string operations are supported?</a></li>
<li><a href="#output">Output</a>
<ul>
<li><a href="#where-can-we-redirect-outputs">Where can we redirect outputs?</a></li>
<li><a href="#how-can-we-control-the-outputs">How can we control the outputs?</a></li>
</ul>
</li>
<li><a href="#what-if-we-need-temporary-relation-in-a-query">What if we need temporary relation in a query?</a></li>
<li><a href="#how-does-window-functions-work">How does window functions work?</a></li>
</ul>
</li>
</ul>
</p>
<h1 id="database"><a class="markdownIt-Anchor" href="#database"></a> Database</h1>
<h2 id="why-shouldnt-we-just-store-database-in-a-flat-file-like-csv-that-we-manage-ourselve-in-our-application-code"><a class="markdownIt-Anchor" href="#why-shouldnt-we-just-store-database-in-a-flat-file-like-csv-that-we-manage-ourselve-in-our-application-code"></a> Why shouldn’t we just store database in a flat file like CSV that we manage ourselve in our application code?</h2>
<ol>
<li>The first concern is data integrity:
<ul>
<li>How to ensure that the data is make sense to the design schema?</li>
<li>How to prevent invalid data and malicious attack?</li>
<li>And the management of deleting some entries causing deleting entries in other databases is pain.</li>
</ul>
</li>
<li>Another problem is implementation:
<ul>
<li>How to find a record?</li>
<li>How to share database between applications?</li>
<li>How to handle concurrent writes?</li>
</ul>
</li>
<li>Also concerned about durability:
<ul>
<li>What if machine crashed?</li>
<li>How to replicate database?</li>
</ul>
</li>
</ol>
<h2 id="what-does-dbms-and-data-models-do"><a class="markdownIt-Anchor" href="#what-does-dbms-and-data-models-do"></a> What does DBMS and data models do?</h2>
<ol>
<li>DBMS supports the definition, creation, querying, update, and administration of databases in accordance with some data model.
<ul>
<li>The physical storage is left up to the DBMS implementation.</li>
<li>Programmers access data through high-level language, DBMS figures out best execution strategy.</li>
</ul>
</li>
<li>A data model is a collection of concepts for describing the data in a database.
<ul>
<li>A schema is a description of a particular collection of data using a given data model.</li>
</ul>
</li>
</ol>
<h2 id="what-kinds-of-data-models-are-there"><a class="markdownIt-Anchor" href="#what-kinds-of-data-models-are-there"></a> What kinds of data models are there?</h2>
<ol>
<li>The most used is Relational model.</li>
<li>One class called NoSQL:
<ul>
<li>Key/Value</li>
<li>Graph</li>
<li>Document / Object</li>
<li>Wide-Column / Column-family</li>
</ul>
</li>
<li>For machine learning, there are Array / Matrix / Vectors</li>
<li>The obsolete or legacy ones are:
<ul>
<li>Hierarchical</li>
<li>Network</li>
<li>Multi-Value</li>
</ul>
</li>
</ol>
<h2 id="how-does-document-data-model-store-data"><a class="markdownIt-Anchor" href="#how-does-document-data-model-store-data"></a> How does document data model store data?</h2>
<ol>
<li>It embeds data hierarchy into a single object like JSON, or XML, etc.</li>
<li>The problem is similar with the aforementioned store database in a flat file like CSV.</li>
</ol>
<h1 id="relational-model"><a class="markdownIt-Anchor" href="#relational-model"></a> Relational model</h1>
<h2 id="how-are-data-stored"><a class="markdownIt-Anchor" href="#how-are-data-stored"></a> How are data stored?</h2>
<ol>
<li>Data are stored in simple data structures called relations.</li>
<li>A relation is an <strong>unordered set</strong> that contain the relationship of attributes that represent entities.
<ul>
<li>A n-ary relation is  a table with n columns.</li>
</ul>
</li>
<li>A tuple is a set of attribute values (domain) in the relation.
<ul>
<li>NULL is a member of every domain, if allowed.</li>
</ul>
</li>
</ol>
<h2 id="what-is-primary-keys-and-foreign-keys"><a class="markdownIt-Anchor" href="#what-is-primary-keys-and-foreign-keys"></a> What is primary keys and foreign keys?</h2>
<ol>
<li>A relation’s primary key uniquely identifies a single tuple.
<ul>
<li>In the definition of a relation, primary keys are usually marked with underline.</li>
</ul>
</li>
<li>A foreign key specifies that an attribute from one relation has to map to a tuple in another relation.
<ul>
<li>Normally, foreign keys must be primary keys in another relation.</li>
</ul>
</li>
</ol>
<h2 id="what-is-supported-in-relational-algebra"><a class="markdownIt-Anchor" href="#what-is-supported-in-relational-algebra"></a> What is supported in relational algebra?</h2>
<ol>
<li>Select: <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>σ</mi><mrow><mi>p</mi><mi>r</mi><mi>e</mi><mi>d</mi><mi>i</mi><mi>c</mi><mi>a</mi><mi>t</mi><mi>e</mi></mrow></msub><mo stretchy="false">(</mo><mi>R</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\sigma_{predicate}(R)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight">c</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">e</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mclose">)</span></span></span></span>
<ul>
<li>Choose a subset of the tuples from a relation that satisfies the selection predicate.<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> R</span><br><span class="line"> <span class="keyword">WHERE</span> predicate;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li>Projection: <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="normal">Π</mi><mrow><msub><mi>A</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>A</mi><mn>2</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>A</mi><mi>n</mi></msub></mrow></msub><mo stretchy="false">(</mo><mi>R</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\Pi_{A_1,A_2,\dots,A_n}(R)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord">Π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.328331em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31731428571428577em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mpunct mtight">,</span><span class="mord mtight"><span class="mord mathnormal mtight">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31731428571428577em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mpunct mtight">,</span><span class="minner mtight">…</span><span class="mpunct mtight">,</span><span class="mord mtight"><span class="mord mathnormal mtight">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.16454285714285719em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mclose">)</span></span></span></span>
<ul>
<li>Generate a relation with tuples that contains only the specified attributes</li>
<li>It can be used to rearrange attributes’ ordering and manipulate the values.<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> A1, A2, ..., An <span class="keyword">FROM</span> R;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li>Union: <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi><mo>∪</mo><mi>S</mi></mrow><annotation encoding="application/x-tex">R\cup S</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∪</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span></span></span></span>
<ul>
<li>Two relations must have same attributes.</li>
<li>The result may be duplicated if some tuples appeared in both relations.<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> R) <span class="keyword">UNION</span> <span class="keyword">ALL</span> (<span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> S);</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li>Intersection: <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi><mo>∩</mo><mi>S</mi></mrow><annotation encoding="application/x-tex">R\cap S</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∩</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span></span></span></span>
<ul>
<li>Two relations must have same attributes.<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> R) <span class="keyword">INTERSECT</span> (<span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> S);</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li>Difference: <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi><mo>−</mo><mi>S</mi></mrow><annotation encoding="application/x-tex">R-S</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span></span></span></span>
<ul>
<li>Two relations must have same attributes.<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> R) <span class="keyword">EXCEPT</span> (<span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> S);</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li>Product: <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi><mo>×</mo><mi>S</mi></mrow><annotation encoding="application/x-tex">R\times S</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span></span></span></span>
<ul>
<li>Generate a relation that contains all possible combinations of tuple from the input relations, i.e. Cartesian product.<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> R <span class="keyword">CROSS</span> <span class="keyword">JOIN</span> S;</span><br><span class="line"># <span class="keyword">Or</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> R, S;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li>Join: <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi><mo>⋈</mo><mi>S</mi></mrow><annotation encoding="application/x-tex">R\bowtie S</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68833em;vertical-align:-0.005em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">⋈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span></span></span></span>
<ul>
<li>The difference between join and intersection is that join can match attributes’ name automatically, while intersetion requires that two relations have the same attribute order.</li>
<li>It does product first, then compare attributes.<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> R <span class="keyword">NATURAL</span> <span class="keyword">JOIN</span> S;</span><br><span class="line"># <span class="keyword">Or</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> R <span class="keyword">JOIN</span> S <span class="keyword">USING</span> (A1, A2, ..., An);</span><br></pre></td></tr></table></figure>
</li>
<li>In the broad sense, join can have predicate <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi><msub><mo>⋈</mo><mrow><mi>p</mi><mi>r</mi><mi>e</mi><mi>d</mi><mi>i</mi><mi>c</mi><mi>a</mi><mi>t</mi><mi>e</mi></mrow></msub><mi>S</mi></mrow><annotation encoding="application/x-tex">R\bowtie_{predicate}S</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.969438em;vertical-align:-0.286108em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel"><span class="mrel">⋈</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight">c</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">e</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span></span></span></span> which is the same as <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>σ</mi><mrow><mi>p</mi><mi>r</mi><mi>e</mi><mi>d</mi><mi>i</mi><mi>c</mi><mi>a</mi><mi>t</mi><mi>e</mi></mrow></msub><mo stretchy="false">(</mo><mi>R</mi><mo>×</mo><mi>S</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\sigma_{predicate}(R\times S)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight">c</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">e</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mclose">)</span></span></span></span>.</li>
</ul>
</li>
<li>It is obvious that different order of steps can have the same result with different amout of computation.
<ul>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi><mo>⋈</mo><mo stretchy="false">(</mo><msub><mi>σ</mi><mrow><mi>p</mi><mi>r</mi><mi>e</mi><mi>d</mi><mi>i</mi><mi>c</mi><mi>a</mi><mi>t</mi><mi>e</mi></mrow></msub><mo stretchy="false">(</mo><mi>S</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">R\bowtie(\sigma_{predicate}(S))</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68833em;vertical-align:-0.005em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">⋈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight">c</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">e</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mclose">)</span><span class="mclose">)</span></span></span></span> is much efficient than <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>σ</mi><mrow><mi>p</mi><mi>r</mi><mi>e</mi><mi>d</mi><mi>i</mi><mi>c</mi><mi>a</mi><mi>t</mi><mi>e</mi></mrow></msub><mo stretchy="false">(</mo><mi>R</mi><mo>⋈</mo><mi>S</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\sigma_{predicate}(R\bowtie S)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight">c</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">e</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">⋈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mclose">)</span></span></span></span>.</li>
</ul>
</li>
</ol>
<h1 id="morden-sql"><a class="markdownIt-Anchor" href="#morden-sql"></a> Morden SQL</h1>
<h2 id="what-is-provided-in-a-relational-language"><a class="markdownIt-Anchor" href="#what-is-provided-in-a-relational-language"></a> What is provided in a relational language?</h2>
<ol>
<li>Data Manipulation Language (DML)</li>
<li>Data Definition Language (DDL)</li>
<li>Data Control Language (DCL)</li>
<li>Also view definition, integrity and referential constraints, transactions.</li>
</ol>
<h2 id="aggregations-and-group-by"><a class="markdownIt-Anchor" href="#aggregations-and-group-by"></a> Aggregations and Group By</h2>
<h3 id="what-are-aggregations"><a class="markdownIt-Anchor" href="#what-are-aggregations"></a> What are aggregations?</h3>
<ol>
<li>They are functions that return a single value from a bag of tuples.</li>
<li><code>AVG(col)</code>, <code>MIN(col)</code>, <code>MAX(col)</code>, <code>SUM(col)</code>, <code>COUNT(col)</code>
<ul>
<li>For <code>COUNT</code>, the passed argument actual does not mater since it only returns the number of rows.</li>
</ul>
</li>
<li>Aggregate functions can almost only be used in the <code>SELECT</code> output list.</li>
<li><code>COUNT</code>, <code>SUM</code>, <code>AVG</code> support <code>DISTINCT</code>.
<ul>
<li>In this case, the columns passed to <code>COUNT</code> matters.</li>
</ul>
</li>
<li>Output of other columns outside of an aggregate is undefined.
<ul>
<li>Aggregations actually create a new relation with different number of tuples.</li>
<li>If we directly ask for other colmns, the number of tuples won’t match with output of aggregations</li>
<li>And we don’t know the relation between output of aggregations and values from other columns (some language may allow this but with chaos order).</li>
</ul>
</li>
<li>We also cannot filter output tuples with the result of aggregation column names.
<ul>
<li>Since <code>SELECT</code> happens a last, when <code>WHERE</code> or <code>HAVING </code> is calculated, the aggregation columns haven’t been calculated yet.</li>
</ul>
</li>
</ol>
<h3 id="how-to-output-other-columns-with-aggregations"><a class="markdownIt-Anchor" href="#how-to-output-other-columns-with-aggregations"></a> How to output other columns with aggregations?</h3>
<ol>
<li><code>GROUP BY</code> projects tuples into subsets and calculate aggregates against each subset.</li>
<li>Non-aggregated valuese in <code>SELECT</code> output clause must appear in <code>GROUP BY</code> clause.</li>
<li>With group-by, each aggregation output has the same values in those grouped columns. So <code>SELECT</code> knows their relation.</li>
<li><code>HAVING</code> like a <code>WHERE</code> clause for a <code>GROUP BY</code>.
<ul>
<li>It can filter results based on aggregation computation. But it also shouldn’t use the columns names of aggregation in <code>SELECT</code>.</li>
<li>Instead, it should directly use aggregation function. Although the execution engine knows that these two are the same and don’t do the repeat calculation.</li>
</ul>
</li>
</ol>
<h2 id="what-string-operations-are-supported"><a class="markdownIt-Anchor" href="#what-string-operations-are-supported"></a> What string operations are supported?</h2>
<ol>
<li>Predicate of string matching can be done with <code>=</code>
<ul>
<li>Some DBMSs are case sensitive while others are not.</li>
<li>We can also use <code>LIKE</code> to match with string-match operators.
<ul>
<li><code>%</code> matches any substring (including empty strings)</li>
<li><code>_</code> match any one character.</li>
</ul>
</li>
</ul>
</li>
<li>Other string functions are provided:
<ul>
<li><code>UPPER</code> and <code>LOWER</code></li>
<li><code>SUBSTRING(str, start_index, end_index)</code></li>
</ul>
</li>
<li>Different language has different ways to concatenate strings: <code>str1 || str2</code>, <code>str1 + str2</code> or <code>CONCAT(str1, str2)</code>.</li>
</ol>
<h2 id="output"><a class="markdownIt-Anchor" href="#output"></a> Output</h2>
<h3 id="where-can-we-redirect-outputs"><a class="markdownIt-Anchor" href="#where-can-we-redirect-outputs"></a> Where can we redirect outputs?</h3>
<ol>
<li>We can store query restuls in another table.
<ul>
<li>That table must not already be defined.</li>
<li>It will have the same number of columns with the same types as the input.</li>
</ul>
</li>
<li>We can also insert tuples from query into another table.
<ul>
<li>The inner select must generate the same columns as the target table.</li>
<li>DMBSs have diferent options/syntax on what to do with integrity violations.</li>
</ul>
</li>
</ol>
<h3 id="how-can-we-control-the-outputs"><a class="markdownIt-Anchor" href="#how-can-we-control-the-outputs"></a> How can we control the outputs?</h3>
<ol>
<li>We can order the output tuples by the values in one or more of their columns with <code>ORDER BY &lt;column*&gt; [ASC|DESC]</code>.</li>
<li>We can also limit the number of tuples returned in output with <code>LIMIT &lt;count&gt; [OFFSET &lt;count2&gt;]</code>.
<ul>
<li>Although this limits the number of output, its execution may still need to compute the whole relation, e.g. to output the top-10 largest numbers still need to sort all numbers.</li>
</ul>
</li>
</ol>
<h2 id="what-if-we-need-temporary-relation-in-a-query"><a class="markdownIt-Anchor" href="#what-if-we-need-temporary-relation-in-a-query"></a> What if we need temporary relation in a query?</h2>
<ol>
<li>The first solution is nested queries.
<ul>
<li>Inner queries can appear almost anywhere in query.</li>
<li>In <code>WHERE</code> clause, we can perform predicate between the tuples from current relation and result of subqueries.
<ul>
<li><code>ALL</code> must satisfy expression for all rows in the subquery.</li>
<li><code>ANY</code> must satisfy expression for at least one row in the subquery.</li>
<li><code>IN</code> is equivalent to <code>=ANY()</code>.</li>
<li><code>EXISTS</code> returns true if the relation is not empty.</li>
<li><code>NOT</code></li>
</ul>
</li>
</ul>
</li>
<li>Another choice is common table expression using <code>WITH cteName AS (query)</code>.
<ul>
<li>It also supports bind/alias output columns to names <code>WITH cteName (col1, ..., coln) AS (query)</code></li>
<li>In the next one query, we can reference this temporary relation with <code>cteName</code>.</li>
<li>We can enable recursive calculation using <code>WITH RECURSIVE</code>.</li>
</ul>
</li>
</ol>
<h2 id="how-does-window-functions-work"><a class="markdownIt-Anchor" href="#how-does-window-functions-work"></a> How does window functions work?</h2>
<ol>
<li>Window functions perform a sliding calculation across a set of tuples that are related.</li>
<li>Like an aggregation, they only appear in <code>SELECT</code> clause. But tuples are not grouped into a single output tuples. Instead, the number of rows of the output is the same as input.</li>
<li>In <code>SELECT</code> clause, window functions syntax is <code>FUNC-NAME(...) OVER(...)</code>.
<ul>
<li>The <code>FUNC-NAME</code> can be aggregation functions or special functions (<code>ROW_NUMBER</code> and <code>RANK</code>)
<ul>
<li><code>ROW_NUMBER</code> assigns the nuber of current row in certain order.</li>
<li><code>RANK</code> assigns the order position of the current row.</li>
<li>When two rows tie, <code>RANK</code> will assign the same number to them and skip the next number while <code>ROW_NUMBER</code> will assign different number.</li>
</ul>
</li>
<li>The <code>OVER</code> paramater controls how to slice up data.
<ul>
<li>It controls how to group together tuples when computing the window function with <code>PARTITION BY</code>.</li>
<li>It also controls the order of computing with <code>ORDER BY ... [ASC|DESC]</code>.</li>
</ul>
</li>
</ul>
</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://liyun-zhang.github.io/2023/03/27/OpenSource/6.824/Lab-4-ShardKV/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LiyunZhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LiyunZhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LiyunZhang">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/03/27/OpenSource/6.824/Lab-4-ShardKV/" class="post-title-link" itemprop="url">Lab 4: ShardKV</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-03-27 14:35:51" itemprop="dateCreated datePublished" datetime="2023-03-27T14:35:51+08:00">2023-03-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-03-15 14:38:25" itemprop="dateModified" datetime="2024-03-15T14:38:25+08:00">2024-03-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Open-Source-Code/" itemprop="url" rel="index"><span itemprop="name">Open Source Code</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Open-Source-Code/6-824/" itemprop="url" rel="index"><span itemprop="name">6.824</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><ul class="markdownIt-TOC">
<li><a href="#how-to-shard-key-value-pairs">How to shard key-value pairs?</a></li>
<li><a href="#how-to-install-new-configuration">How to install new configuration?</a></li>
<li><a href="#how-to-reduce-the-pauses-for-clients-when-installing-new-configurations">How to reduce the pauses for clients when installing new configurations?</a></li>
<li><a href="#how-to-garbage-collect-past-configurations">How to garbage collect past configurations?</a></li>
</ul>
</p>
<h1 id="how-to-shard-key-value-pairs"><a class="markdownIt-Anchor" href="#how-to-shard-key-value-pairs"></a> How to shard key-value pairs?</h1>
<ol>
<li>The total number of shards are fixed to be <code>NShards</code>. The keys are mapped into shards by a hash function mod by <code>NShards</code>.</li>
<li>Each KV group in the cluster needs to be responsible for some shards. An additional Raft group named Shard Controller is responsible for the configurations for the cluster.
<ul>
<li>Each KV group would acquire latest configuration from Shard Controller.</li>
<li>When a new configuration is found, it will be proposed to the Raft group. It is installed until it has been committed.</li>
</ul>
</li>
<li>The configuration of the Raft groups in the cluster can be modified by administrators through giving commands to the Shard Controllers. <code>Leave</code>, <code>Join</code> and <code>Move</code> are provided.
<ul>
<li>When a command comes from administrators, a Raft entry is proposed. New configuration will only be created when that entry is committed.</li>
<li>When creating new configurations, <code>Leave</code> and <code>Join</code> will try to rebalance the distribution of shards as evenly as possible or try to move as less shards as possible.</li>
</ul>
</li>
</ol>
<h1 id="how-to-install-new-configuration"><a class="markdownIt-Anchor" href="#how-to-install-new-configuration"></a> How to install new configuration?</h1>
<ol>
<li>For the shards in the last config not in the new config, we cannot simply discard it. When we give up a shard, some other group must be responsible for it and they do not have it now. Therefore, we need to transmit the data to them.
<ul>
<li>One way is that we can push the data to the new owner of the shards. However, they may not be online now, they are partitioned from this node or they may have not installed this new configuration causing waste RPC flows.</li>
<li>Another way is to keep all data from past configurations and separate them from the data of current configuration waiting other nodes to pull the shards they want.</li>
</ul>
</li>
<li>For the shards in the new config not in the last config, we must acquire it from somewhere.
<ul>
<li>As aforementioned, when a new config is installed, this peer will issue RPC to pull the missing shards from other groups.</li>
<li>To avoid that the target host of missing shards only execute part of commands of last config causing missing values, a host is allowed to transmit shards only if it has installed the next configuration of the requested configuration.</li>
</ul>
</li>
<li>The executed index records also need to be separated between configurations to prevent lagged groups reject to execute commands from clients.</li>
<li>When installing a new configuration from snapshot, remember to instiate the goroutines to fetch the missing shards from the snapshot.</li>
</ol>
<h1 id="how-to-reduce-the-pauses-for-clients-when-installing-new-configurations"><a class="markdownIt-Anchor" href="#how-to-reduce-the-pauses-for-clients-when-installing-new-configurations"></a> How to reduce the pauses for clients when installing new configurations?</h1>
<ol>
<li>In the naive schema, we need to wait until all shards received before executing any client commands. However, receiving all shards could take a long time.</li>
<li>It is reasonable to execute the commands that only need the received shards even if some shards remain missing.</li>
<li>We can add a data structure to record the state of each shards in a configuration. If the state is received, we can execute the commands on that shard.</li>
<li>To execute the commands in commit order, we still will be stalled by the commands requesting missing shards.</li>
<li>Nevertheless, this schema can push the process forward as much as possible and parallel excuting commands of received shards and waiting for missing shards.</li>
</ol>
<h1 id="how-to-garbage-collect-past-configurations"><a class="markdownIt-Anchor" href="#how-to-garbage-collect-past-configurations"></a> How to garbage collect past configurations?</h1>
<ol>
<li>In the naive schema, the redundent data would grow larger and larger since we cannot delete data of past configurations.</li>
<li>We can notice that a shard in the past configuration can be deleted when it is received by the group that need to request for it.
<ul>
<li>A peer can ask the corresponding peers whether they have received the shards. Similar with the reasons we do not push shards, it will waste a lot of RPC flows.</li>
<li>When a peer received a shard, no matter through requesting from another group or installing a snapshot, it will inform the groups that host shards from last configuration.</li>
<li>The shard can be deleted from the host of the last configuration, when all peers host a shard in the next configuration have received it.</li>
</ul>
</li>
<li>A garbage collection goroutine is initiated when the next configuration is installed.</li>
<li>A snapshot must be persisted before informing other groups of receiving shards to prevent recovering from snapshot without shards while the host already deleted due to received acknowledge.</li>
<li>When a shard can be deleted, snapshot installing becomes more tricky.
<ul>
<li>We should not copy the deleted shards and deleted configurations from the snapshot. And we can delete the shads that are deleted in the snapshot.</li>
<li>When a new configuration is created from snapshot, a garbage collection of former configuration needs to be started.</li>
</ul>
</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://liyun-zhang.github.io/2023/03/27/OpenSource/6.824/Lab-3-Fault-tolerant-Key-Value-Service/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LiyunZhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LiyunZhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LiyunZhang">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/03/27/OpenSource/6.824/Lab-3-Fault-tolerant-Key-Value-Service/" class="post-title-link" itemprop="url">Lab 3: Fault-tolerant Key/Value Service</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-03-27 14:35:11" itemprop="dateCreated datePublished" datetime="2023-03-27T14:35:11+08:00">2023-03-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-03-15 14:38:20" itemprop="dateModified" datetime="2024-03-15T14:38:20+08:00">2024-03-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Open-Source-Code/" itemprop="url" rel="index"><span itemprop="name">Open Source Code</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Open-Source-Code/6-824/" itemprop="url" rel="index"><span itemprop="name">6.824</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><ul class="markdownIt-TOC">
<li><a href="#how-does-keyvalue-server-execute-command-from-clerk">How does Key/Value server execute command from clerk?</a></li>
<li><a href="#can-clerk-read-from-follower">Can clerk read from follower?</a></li>
<li><a href="#how-can-we-prevent-re-execution-of-an-executed-command">How can we prevent re-execution of an executed command?</a></li>
<li><a href="#how-many-kind-of-error-could-occur-when-client-issues-a-command">How many kind of error could occur when client issues a command?</a></li>
<li><a href="#what-should-be-stored-in-a-snapshot">What should be stored in a snapshot?</a></li>
<li><a href="#what-need-to-do-to-recover-the-state-after-crashed">What need to do to recover the state after crashed?</a></li>
<li><a href="#execution-speed-of-get-operation">Execution speed of Get operation:</a></li>
<li><a href="#execution-speed-of-putappend-operation">Execution speed of PutAppend operation:</a></li>
</ul>
</p>
<h1 id="how-does-keyvalue-server-execute-command-from-clerk"><a class="markdownIt-Anchor" href="#how-does-keyvalue-server-execute-command-from-clerk"></a> How does Key/Value server execute command from clerk?</h1>
<ol>
<li>It will call the <code>Start()</code> function of its associated Raft server. It can safely execute the command until the Raft server commits that command.</li>
<li>Only the KV server associated with leader Raft server can successfully use <code>Start()</code> to append command to logs.</li>
<li>But there could be a situation that the network is partitioned, and the clerk connects to a partition leader whose log entry can never be successfully committed. So we need to set a timeout for each command, if it cannot commit in time, the clerk should be informed to find another server.</li>
</ol>
<h1 id="can-clerk-read-from-follower"><a class="markdownIt-Anchor" href="#can-clerk-read-from-follower"></a> Can clerk read from follower?</h1>
<ol>
<li>In the design described above, clerks can only read or write through the leader, which can make leader the bottleneck of the whole system.</li>
<li>With another design, read-only operation can be executed through followers, thus providing a speedup for the Get operation.
<ul>
<li>When a KV server received a Get operation request, it will request ReadIndex from the Raft leader server.</li>
<li>Then the raft leader server need to broadcast heartbeat to all followers to confirm that it is still the rightful leader.</li>
<li>When it heard from a majority followers, it can reply its last CommitIndex as the ReadIndex.</li>
<li>Then the KV server can execute the Get operation after it has applied at least as up-to-date as the ReadIndex.</li>
</ul>
</li>
<li>In the Raft protocol, a leader can only commit the entries appended in its term. Similarly, a leader can only grant ReadIndex pointing to an entry of its term. Or the result of read may become unlinearizable.
<ul>
<li>Consider the case that a leader committed index of <em>x</em>, and granted a ReadIndex of <em>x</em> to its associated KV server. So the KV server returned the result up to index <em>x</em>. But it crashed before sending commit message to other followers. Then a new leader is elected who received a request for ReadIndex. It does not know anything about committing entry <em>x</em>, thus granting a ReadIndex lower than <em>x</em>. Hence the read will return a result unseeing the execution result of entry of index <em>x</em>, which is violated with the linearizablility scheme.</li>
<li>So the solution is to append an empty entry to the log if the leader hasn’t appended any entry in its term.</li>
</ul>
</li>
</ol>
<h1 id="how-can-we-prevent-re-execution-of-an-executed-command"><a class="markdownIt-Anchor" href="#how-can-we-prevent-re-execution-of-an-executed-command"></a> How can we prevent re-execution of an executed command?</h1>
<ol>
<li>Each clerk needs to maintain a monotonically increasing index to mark the command it issued.</li>
<li>Each Key/Value server needs to track the highest index it has executed for each clerk.</li>
<li>When a Key/Value server receives a new command, it compares the index of the new command with the highest executed index of that clerk. If the command’s index is lower, it can know that this is an executed command, and return the result directly.</li>
</ol>
<h1 id="how-many-kind-of-error-could-occur-when-client-issues-a-command"><a class="markdownIt-Anchor" href="#how-many-kind-of-error-could-occur-when-client-issues-a-command"></a> How many kind of error could occur when client issues a command?</h1>
<ol>
<li>For read-only operation, there could be a key error.</li>
<li>Except for the read-only operation with follower read, the client may connect to a follower who cannot append a command.</li>
<li>The client may connect to a server in a minority parition of servers.
<ul>
<li>The PutAppend command is appended to the log but cannot commit.</li>
<li>For the read-only operation with follower read, it connects to its leader, but its leader cannot receive majority response. Hence it cannot acquire a ReadIndex.</li>
</ul>
</li>
<li>For read-only operation with follower read,
<ul>
<li>The KV Server is associated with a leader, and its leader set a higher commit index when communicating with majority. But the Raft leader crashed before commit that entry, leaving the KV server keep waiting to apply as up-to-date as the ReadIndex.</li>
<li>The client may connect to a partition without leader, hence cannot acquire ReadIndex.</li>
</ul>
</li>
</ol>
<h1 id="what-should-be-stored-in-a-snapshot"><a class="markdownIt-Anchor" href="#what-should-be-stored-in-a-snapshot"></a> What should be stored in a snapshot?</h1>
<ol>
<li>Of course, we need to store the state of all key-value pairs.</li>
<li>We also need to store the last index executed for each client so far, in order to be able to recognize duplicated commands even after crashed.</li>
<li>The index of last applied entry is also stored to prevent that the first command after recovery is a read-only operation.</li>
</ol>
<h1 id="what-need-to-do-to-recover-the-state-after-crashed"><a class="markdownIt-Anchor" href="#what-need-to-do-to-recover-the-state-after-crashed"></a> What need to do to recover the state after crashed?</h1>
<ol>
<li>First, we need to install the latest snapshot persisted.</li>
<li>But that is not enough if only the KV server is crashed while the associated Raft server is still running since there might still have some committed entries which is not included in the snapshot, yet applied before crash. The KV server needs to acquire those committed entries to truely bring itself back to the state right before crash.</li>
</ol>
<h1 id="execution-speed-of-get-operation"><a class="markdownIt-Anchor" href="#execution-speed-of-get-operation"></a> Execution speed of Get operation:</h1>
<ol>
<li>When running test without enabling snapshot:
<ul>
<li>The time spent for each operation of the un-optimzied implementation will become slower as the number of operation grows. This is because the log of each Raft server becomes larger and larger and becomes slower to persist.</li>
<li>When executing the Get operation, the log of optimized implementation won’t increase. Hence it won’t slow down the execution.</li>
<li>When executing <em>3000</em> Get operations, the un-optimized implementation needs about <em>50 ms/op</em>, while the optimized implementation only needs <em>1.7 ms/op</em>, which is about <em>29</em> times speedup.</li>
</ul>
</li>
<li>When running test enabling snapshot:
<ul>
<li>The time spent for the un-optimized implementation becomes stable since the log size is now stable. However, when only executing the Get operation, the oprimized implementation does not need the benefit of trimming logs.</li>
<li>When executing <em>3000</em> Get operations, the un-optimized imlementation need about <em>14.7 ms/op</em>, while the optimized imlementation is still <em>1.7 ms/op</em>, which is about <em>8.6</em> times speedup.</li>
<li>I think that the speedup of optimized read-only scheme comes from two parts: follower concurrency that increased the total bandwidth between clients and servers, and the persisting time saved by eliminating Get operation entries from logs.</li>
</ul>
</li>
</ol>
<h1 id="execution-speed-of-putappend-operation"><a class="markdownIt-Anchor" href="#execution-speed-of-putappend-operation"></a> Execution speed of PutAppend operation:</h1>
<ol>
<li>When executing <em>1000</em> Put operations without enabling snapshot, both implementations needs about <em>29.5 ms/op</em>. Executing Append operations needs about the same amount of time.</li>
<li>When executing <em>1000</em> Put operations enabling snapshot, both implementations needs about <em>13.9 ms/op</em>. Executing Append operations needs about the same amount of time.</li>
<li>Thus, with snapshot enabled, it can achieve about <em>2.1</em> times speedup. I think the speedup mainly comes from the persisting time saved by shrinking log.</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://liyun-zhang.github.io/2023/03/26/OpenSource/6.824/Lab-2-Raft/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LiyunZhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LiyunZhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LiyunZhang">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/03/26/OpenSource/6.824/Lab-2-Raft/" class="post-title-link" itemprop="url">Lab 2: Raft</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-03-26 13:57:11" itemprop="dateCreated datePublished" datetime="2023-03-26T13:57:11+08:00">2023-03-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-03-15 14:39:56" itemprop="dateModified" datetime="2024-03-15T14:39:56+08:00">2024-03-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Open-Source-Code/" itemprop="url" rel="index"><span itemprop="name">Open Source Code</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Open-Source-Code/6-824/" itemprop="url" rel="index"><span itemprop="name">6.824</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><ul class="markdownIt-TOC">
<li><a href="#leader-election">Leader election</a>
<ul>
<li><a href="#how-to-count-the-votes-a-candidate-gets">How to count the votes a candidate gets?</a></li>
<li><a href="#how-to-does-each-server-initial-an-election">How to does each server initial an election?</a></li>
</ul>
</li>
<li><a href="#log-replication">Log Replication</a>
<ul>
<li><a href="#how-does-the-leader-sending-log-entries-to-followers">How does the leader sending log entries to followers?</a></li>
<li><a href="#how-to-optimize-the-consistency-check-protocol">How to optimize the consistency check protocol?</a></li>
<li><a href="#how-should-a-follower-accept-log-entries-after-passing-all-consistency-check">How should a follower accept log entries after passing all consistency check?</a></li>
<li><a href="#how-will-each-server-commit-index">How will each server commit index?</a></li>
<li><a href="#how-do-the-leader-check-which-entries-can-be-committed">How do the leader check which entries can be committed?</a></li>
<li><a href="#what-is-the-constraint-of-committing-uncommitted-entries-of-earlier-terms">What is the constraint of committing uncommitted entries of earlier terms?</a></li>
</ul>
</li>
<li><a href="#persistence">Persistence</a>
<ul>
<li><a href="#when-will-persist-be-called">When will persist() be called?</a></li>
<li><a href="#when-a-server-restarts-what-information-should-it-restore">When a server restarts, what information should it restore?**</a></li>
<li><a href="#how-to-invoke-persist">How to invoke persist()?</a></li>
</ul>
</li>
<li><a href="#log-compaction">Log compaction</a>
<ul>
<li><a href="#how-to-deal-with-those-deleted-entries-when-a-server-restarts">How to deal with those deleted entries when a server restarts?</a></li>
<li><a href="#how-to-take-a-snapshot">How to take a snapshot?</a></li>
<li><a href="#how-to-install-a-snapshot">How to install a snapshot?</a></li>
</ul>
</li>
<li><a href="#optimizations">Optimizations</a>
<ul>
<li><a href="#how-can-we-take-advantage-of-follower-nodes">How can we take advantage of follower nodes?</a></li>
<li><a href="#how-can-we-prevent-partitioned-followers-end-up-in-a-high-term">How can we prevent partitioned followers end up in a high term?</a></li>
</ul>
</li>
</ul>
</p>
<h1 id="leader-election"><a class="markdownIt-Anchor" href="#leader-election"></a> Leader election</h1>
<h2 id="how-to-count-the-votes-a-candidate-gets"><a class="markdownIt-Anchor" href="#how-to-count-the-votes-a-candidate-gets"></a> How to count the votes a candidate gets?</h2>
<ol>
<li>The candidate begins a new goroutine to request vote from each server.</li>
<li>Use a shared variable to track how many votes has the candidate gotten. Each goroutine monitor that after this vote, has the candidate gotten enough votes to become a leader independently.</li>
<li>When each goroutine received reply from other peers, it needs to check whether the reply is still in the same term as the term where it is now and whether it is still a candidate.
<ul>
<li>Only check its state is insufficient. The check of term is to prevent delayed replies arrives in the future election initialed by this server.</li>
</ul>
</li>
<li>My initial thought
<ul>
<li>The election goroutine will monitor the process of votes instead of the request goroutines.</li>
<li>Then the check loop in election goroutine need to sleep after each time it failed. Or the election would be hard to converge.</li>
<li>I GUESS that the reason is the for-loop never ends and takes too many resources, causing the CPU cannot schedule those RequestVote goroutine and later eletion goroutine in time.</li>
</ul>
</li>
</ol>
<h2 id="how-to-does-each-server-initial-an-election"><a class="markdownIt-Anchor" href="#how-to-does-each-server-initial-an-election"></a> How to does each server initial an election?</h2>
<ol>
<li>A timestamp is used to record the last time heard from leader or candidate. And <code>electionTimeout</code> is set randomly in startup and beginning of election.
<ul>
<li>Each time the server wants to change its state into follower, it needs to reset timestamp before switch state, or it may trigger a new election due to the stale timeStamp.</li>
<li>When the replied term is larger than the term of sending <code>AppendEntries</code>, the leader should known that itself is out-of-date. But before any further settings, it should check that whether the replied term is larger than the term where it is now to prevent this is a stale reply processed with a stale term, causing <code>currectTerm</code> decreasing.</li>
</ul>
</li>
<li><code>ticker()</code> will check whether the time since timestamp is larger than the <code>electionTimeout</code> periodically, and if so, an new election is initiated.
<ul>
<li>When the checking is failed, this goroutine should sleep for a short time. But it cannot simply sleep as long as <code>electionTimeout</code>, because the next sleep may be shorter then <code>electionTimeout</code>.</li>
</ul>
</li>
<li>Another way is to set the <code>electionTimeout </code> when checking the condition instead of fixed <code>electionTimeout</code> between two elections.
<ul>
<li>But this will cause multiple peers initiate election in short gap. In addition to the unreliable network and the burden of scheduling goroutines, the <code>RequestVote()</code> may not be executed by others immediately and causing severe split brain and re-elections.</li>
<li>The reason, I GUESS, is that it only need one short sleep time to kick off election. And with a new random sleep time every <code>CHECKTIMEOUT</code> ms, there is a greater probability that one sleep time is short and it actually shortened the <code>electionTimeout</code> I want.</li>
</ul>
</li>
</ol>
<h1 id="log-replication"><a class="markdownIt-Anchor" href="#log-replication"></a> Log Replication</h1>
<h2 id="how-does-the-leader-sending-log-entries-to-followers"><a class="markdownIt-Anchor" href="#how-does-the-leader-sending-log-entries-to-followers"></a> How does the leader sending log entries to followers?</h2>
<ol>
<li><code>nextIndex</code> is the lowest indices of entries missed by each peers known by leader.</li>
<li>There are two situations of sending log entries: the first is when there are some un-replicated entries for some follower, and the second is the heartbeat message.
<ul>
<li><code>SyncLogWithFollower(x int)</code> is implemented to check whether server x has some missing entries.</li>
<li><code>Heartbeat()</code> is implemented to send heartbeat message.</li>
<li><code>SendEntriesOnceTo(x int)</code> is implemented to actually send log entries to server x.</li>
<li>The <code>SyncLogWIthFollower()</code> goroutine for each server and the <code>Heartbeat()</code> goroutine is initiated when the server is elected to be leader.</li>
</ul>
</li>
<li>The difference between <code>SyncLogWithFollower()</code> and <code>Heartbeat()</code>
<ul>
<li><code>SyncLogWithFollower()</code> sends entries only when there are missing entries in server x. But <code>Heartbeat()</code> always sends entries even when there is no missing entries in which case an empty log is sent.</li>
<li>The check cycle in <code>SyncLogWithFollower()</code> is way more short than the sending cycle in <code>Heartbeat()</code> to ensure the missing entries can be replicated as soon as possible.</li>
</ul>
</li>
<li>When <code>SyncLogWithFollower()</code> calls <code>SendEntriesOnceTo()</code>, it cannot create a goroutine.
<ul>
<li>Because the check cycle in <code>SyncLogWithFollower()</code> is quite short, if the <code>SyncLogWithFollower()</code> goroutine keeps being scheduled, the <code>SendEntriesOnceTo()</code> cannot send entries to follower. And thus <code>SyncLogWithFollower()</code> goroutine keeps creating too many <code>SendEntriesOnceTo()</code> goroutine.</li>
</ul>
</li>
<li>My initial thought
<ul>
<li>Start a <code>SendEntriesOnceTo()</code> goroutine for every follower after <code>Start()</code> has added a new log entry to leader’s logs instead of using <code>SyncLogWithFollower()</code> goroutine.</li>
<li>But when there are concurrent <code>Start()</code>, this may cause mulitple <code>SendEntriesOnceTo()</code> goroutine sending the same RPC to the same follower.</li>
</ul>
</li>
</ol>
<h2 id="how-to-optimize-the-consistency-check-protocol"><a class="markdownIt-Anchor" href="#how-to-optimize-the-consistency-check-protocol"></a> How to optimize the consistency check protocol?</h2>
<ol>
<li>Additional AppenEntries RPC results for fast roll back:
<ul>
<li><code>Xterm</code>: the term of the conflicting entry.</li>
<li><code>Xindex</code>: the first index that is in <code>Xterm</code>.</li>
<li><code>Xlen</code>: the length of log</li>
</ul>
</li>
<li>Fast roll back implementation:
<ul>
<li>If the leader doesn’t have <code>Xterm</code>, then every entries of <code>Xterm</code> in follower’s log will causing conflict. Hence the <code>nextIndex</code> can backup to <code>Xindex</code>.</li>
<li>If the leader has <code>Xterm</code>, the matching entry in leader’s log must have a term no larger than <code>Xterm</code>. Hence, the <code>nextIndex</code> should backup to the next entry of the last <code>Xterm</code> in leader’s log.</li>
<li>If the follower’s conflicting is due to empty in <code>prevLogTerm</code>, then <code>Xterm</code> is set to <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">-1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">−</span><span class="mord">1</span></span></span></span>, and leader should backup to <code>Xlen</code>.</li>
</ul>
</li>
</ol>
<h2 id="how-should-a-follower-accept-log-entries-after-passing-all-consistency-check"><a class="markdownIt-Anchor" href="#how-should-a-follower-accept-log-entries-after-passing-all-consistency-check"></a> How should a follower accept log entries after passing all consistency check?</h2>
<ol>
<li>The <code>nextIndex</code> and <code>logs</code> of the leader can be updated by different goroutines of <code>SendEntriesOnce()</code> and <code>Start()</code>. So it is possible that <code>args.Entries</code> are chosen through a stale <code>nextIndex</code> and an up-to-date <code>log</code>, or even a stale <code>nextIndex</code> and a stale <code>log</code>.</li>
<li>If the <code>nextIndex</code> is stale while the <code>log</code> is up-to-date, i.e. there are some entries after the <code>nextIndex</code> is already replicated by follower.
<ul>
<li>Then we need to drop those replicated entries but not all the entries since there still could have some new entries.</li>
<li>We need to drop those entries with the same index and the same term according to the Log Matching property and append only those different entries.</li>
<li>I didn’t consider the case of <code>nextIndex</code> being larger than the follower’s replicated indices. Since in this case, transmission won’tsuccess and a fast backup will be triggered.</li>
</ul>
</li>
<li>If both the <code>nextIndex</code> and <code>logs</code> are stale, it is similar to the former situation, since the only additional problem is that it cannot be brought up-to-date by one <code>AppendEntries</code>.</li>
</ol>
<h2 id="how-will-each-server-commit-index"><a class="markdownIt-Anchor" href="#how-will-each-server-commit-index"></a> How will each server commit index?</h2>
<ol>
<li><code>commitIndex</code> is the highest index of entries that can commit now. This is included in the <code>AppendEntries</code> arguments from leader to followers.</li>
<li><code>lastApplied</code> is the highest index of entries that is committed. If <code>lastApplied</code> no larger than <code>commitIndex</code>, then a server can commit the entry next to <code>lastApplied</code>.</li>
<li>Followers cannot modify <code>commitIndex</code> before the logs are synchronized, since there may have some entries need to wipe out by the leader.</li>
</ol>
<h2 id="how-do-the-leader-check-which-entries-can-be-committed"><a class="markdownIt-Anchor" href="#how-do-the-leader-check-which-entries-can-be-committed"></a> How do the leader check which entries can be committed?</h2>
<ol>
<li>My solution
<ul>
<li><code>matchIndex</code> is used to track the highest indices of entries replicated by each peers.</li>
<li>When a group of entries that ends with index <code>i</code> is accepted by one peer, the leader first set the corresponding <code>matchIndex</code> to <code>i</code>.</li>
<li>Than check whether a majority of <code>matchIndex</code> is larger than <code>i</code>. If so, than the leader can commit at least until <code>i</code>. Or, it won’t commit any entry.</li>
</ul>
</li>
<li>Improvement
<ul>
<li>When a lagged peer replicated a lot of entries, it may be insufficient to commit the last entry it replicated. But it could be sufficient to commit some earlier entries.</li>
<li>We only need to commit the k-th largest index in <code>matchIndex</code>.</li>
</ul>
</li>
<li>My initial thought
<ul>
<li>Track the replication state of each entry instead each peer.</li>
<li>But the entries are a lot more than peers causing higher time complexity to maintain when a lot of entries are by peers.</li>
</ul>
</li>
</ol>
<h2 id="what-is-the-constraint-of-committing-uncommitted-entries-of-earlier-terms"><a class="markdownIt-Anchor" href="#what-is-the-constraint-of-committing-uncommitted-entries-of-earlier-terms"></a> What is the constraint of committing uncommitted entries of earlier terms?</h2>
<ol>
<li>A constraint on commit entries is that each leader can only commit entries added in its term. And by committing such entries, they also commit all entries before it. Hence the entries of earlier terms are committed indirectly.</li>
<li>But there is a corner case that a leader doesn’t receive any entry at the beginning of its term. And those uncommitted entries of earlier terms cannot be committed until the leader received its first entry.</li>
<li>My solution is that when a server becomes the leader, it will add an empty entry, and by this empty entry, those uncomitted entries can be committed.</li>
<li>But the test system of 6.824 didn’t consider this case. This implementation will cause all tests failed.</li>
</ol>
<h1 id="persistence"><a class="markdownIt-Anchor" href="#persistence"></a> Persistence</h1>
<h2 id="when-will-persist-be-called"><a class="markdownIt-Anchor" href="#when-will-persist-be-called"></a> When will persist() be called?</h2>
<ol>
<li><code>persist()</code> is called only when <code>rf.currentTerm</code>, <code>rf.votedFor</code> or <code>rf.logs</code> is changed. And when they’re changed, the <code>rf.mu</code> lock must be hold by the caller of <code>persist()</code>.</li>
<li>In order to make the states stored as soon as possible, I won’t release the lock util <code>persist()</code> is finished.</li>
</ol>
<h2 id="when-a-server-restarts-what-information-should-it-restore"><a class="markdownIt-Anchor" href="#when-a-server-restarts-what-information-should-it-restore"></a> When a server restarts, what information should it restore?**</h2>
<ol>
<li>Naturally, it need to restore its <code>currentTerm</code>, <code>votedFor</code> and <code>logs</code> from the persisted state.</li>
<li>Then it need to set its <code>lastLogIndex</code> and <code>lastLogTerm</code> appropriately.</li>
<li>The <code>lastApplied</code>, <code>commitIndex</code> and <code>lastIncludedIndex</code> will be set to the index of the sentinel entry.
<ul>
<li>Because the current state is the same state executed until the sentinel entry.</li>
<li>In the future, if the server finds that other peers have committed later entries, it need to re-execute those entries to achieve the same state.</li>
</ul>
</li>
<li>It should update its <code>lastApplied</code> to the last committed entry according to the commit state in each log entry.</li>
</ol>
<h2 id="how-to-invoke-persist"><a class="markdownIt-Anchor" href="#how-to-invoke-persist"></a> How to invoke persist()?</h2>
<ol>
<li><code>persist()</code> is called only when <code>rf.currentTerm</code>, <code>rf.votedFor</code> or <code>rf.logs</code> is changed.</li>
<li>When they’re changed, the <code>rf.mu</code> lock must be hold by the caller of <code>persist()</code>. In order to make the states stored as soon as possible, I won’t release the lock util <code>persist()</code> is finished.</li>
<li>If it is possible to modify the three variables several times before communicate with outside, or release the lock, we just use a variable to mark whether need to persist, instead of really call <code>persist()</code> each time. And only call the <code>persist()</code> at the end.</li>
</ol>
<h1 id="log-compaction"><a class="markdownIt-Anchor" href="#log-compaction"></a> Log compaction</h1>
<h2 id="how-to-deal-with-those-deleted-entries-when-a-server-restarts"><a class="markdownIt-Anchor" href="#how-to-deal-with-those-deleted-entries-when-a-server-restarts"></a> How to deal with those deleted entries when a server restarts?</h2>
<ol>
<li>When a server restores its state from <code>readPersist()</code>, we want it to re-execute those persisted logs.</li>
<li>But we don’t require to re-execute those deleted entries since we can get to the state of last deleted log by restore snapshot without execution.</li>
<li>The effect is the same as we have committed those missing entries. So we also need to modify the <code>lastApplied</code> and <code>commitIndex</code> to the last deleted log index before re-executing.</li>
</ol>
<h2 id="how-to-take-a-snapshot"><a class="markdownIt-Anchor" href="#how-to-take-a-snapshot"></a> How to take a snapshot?</h2>
<ol>
<li>In this lab, the snapshot is naive. It simply stores all the log entries.</li>
<li>Hence, the server just need to set <code>lastIncludedIndex</code> and <code>lastIncludedTerm</code> appropriately, and remove all the snapshotted entries.</li>
<li>Also, if the log is empty after removal, we need to insert the sentinel entry back to the entry. Its command is still unimportant.</li>
</ol>
<h2 id="how-to-install-a-snapshot"><a class="markdownIt-Anchor" href="#how-to-install-a-snapshot"></a> How to install a snapshot?</h2>
<ol>
<li>The snapshot data only contain commands in log entries, so we need to recover the log entries with the snapshot.
<ul>
<li>Their indices and commands are easy to understand.</li>
<li>We only know the <code>lastIncludedterm</code>. Also these entries are already committed in leader. Thus no matter what will happen in the future, these entries will not be overwriten and no <code>AppendEntry</code> will need to compare with these entries except for the last one. Hence for convenient, I set all their terms to the <code>LastIncludedTerm</code>.</li>
<li>As aforementioned, these entries are already reflected in the snapshot. Thus, there is no need to re-commit them again.</li>
</ul>
</li>
<li>Then we need to determine whether the snapshot contains new information.
<ul>
<li><code>FirstUncover</code> is to indicate the first entry in <code>logs</code> that is more up-to-date than the last entry in snapshot.
<ul>
<li>If the snapshot contains new information not already in the recipient’s log, then <code>firstUncover == len(rf.logs)</code>.</li>
<li>If the snapshot describes a prefix of its log, then <code>firstUncover &lt; len(rf.logs)</code>, then we only need to delete the former entries.</li>
</ul>
</li>
<li>I thought that maybe I just need to compare <code>lastLogIndex</code> in server and <code>LastIncludedIndex</code> of snapshot, but this is not sufficient.
<ul>
<li>Because some server need to discard the last few entries from ealier leaders, yet not in the logs of the current leader.</li>
<li>We need to remove the entries whose term is smaller than the <code>LastIncludedTerm</code> of snapshot while whose index is larger than <code>LastIncludedIndex</code> of snapshot.</li>
</ul>
</li>
</ul>
</li>
<li>If the snapshot contains new information
<ul>
<li>We will discard the whole log entries, and insert a new sentinel entry with index equals to <code>LastIncludedIndex</code> and term equals to <code>LastIncludedTerm</code>.</li>
<li>Then <code>commitIndex</code> and <code>lastApplied</code> need to be updated to <code>LastIncludedIndex</code> since we won’t re-execute those new entries in snapshot.</li>
<li>It need to be persisted.</li>
</ul>
</li>
<li>If the snapshot describes only a prefix of logs, then discard the covered entries. But don’t discard those covered, yet uncommitted entries and need to leave one entry as sentinel.</li>
<li>If PrevLog is already trimmed, we should find the entry with the same index as the sentinel. And make it the new PrevLog, only accept the entries following it.</li>
</ol>
<h1 id="optimizations"><a class="markdownIt-Anchor" href="#optimizations"></a> Optimizations</h1>
<h2 id="how-can-we-take-advantage-of-follower-nodes"><a class="markdownIt-Anchor" href="#how-can-we-take-advantage-of-follower-nodes"></a> How can we take advantage of follower nodes?</h2>
<ol>
<li>To achieve linearizability, there is no chance for follower to improve the performance of Put/Append operation. However, we can allow thtem to handle read-only request to improve the throughput of the cluster.</li>
<li>The key idea is to make the follower know that it is up-to-date to handle the read. To confirm that, we must consult the leader of the current commit index.</li>
<li>A case is that a partitioned follower and leader when there exists another true leader that connects to majority.
<ul>
<li>The solution is that the leader must check whether it still is a legistical leader before authorize follower to execute read.</li>
</ul>
</li>
<li>The whole process is as followed:
<ul>
<li>When a follower received a read from client, it would consult the leader for a <code>readIndex</code>.</li>
<li>The leader then need to send heartbeats to all peers in its group to make sure that it is still the leader.</li>
<li>When the leader received from majority, it can return the current commit index to the follower as the <code>readIndex</code>.</li>
<li>The follower can execute the read request as long as it has as least applied up to <code>readIndex</code>.</li>
</ul>
</li>
<li>Another case is that a new leader missed the latest commit index causing returning a smaller index than the true commit index.
<ul>
<li>The leader must be restricted to grant <code>readIndex</code> that points to an entry appended in its term.</li>
</ul>
</li>
</ol>
<h2 id="how-can-we-prevent-partitioned-followers-end-up-in-a-high-term"><a class="markdownIt-Anchor" href="#how-can-we-prevent-partitioned-followers-end-up-in-a-high-term"></a> How can we prevent partitioned followers end up in a high term?</h2>
<ol>
<li>The problem is that when a follower is partitioned, it cannot receive from the leader. It will try to be elected  to be the leader. Yet, due to it cannot connect to majority of the peers, it can never success causing it keeps to increase its term.</li>
<li>To solve the problem, we need to make a peer realise that it has no chance to be elected to be the leader and gives up increasing its term.
<ul>
<li>Before truely increasing its term, we can ask it to run a simulation of the election, i.e. pre-vote.</li>
<li>During the pre-vote, candidate will send the same data as the true election and other peers will reply that whether they will vote for candidate.</li>
<li>An actual election is initiated until a peer has received pre-vote from majority.</li>
</ul>
</li>
<li>The difference between a pre-vote and an actual election:
<ul>
<li>The pre-vote can grant votes to different peers in the same term.</li>
<li>The pre-vote will not causing voters increasing term and becoming follower.</li>
<li>The pre-vote happens before increasing the term.</li>
</ul>
</li>
<li>The disadvantage of pre-vote is that it makes an election requires an extra round of RPC.
<ul>
<li>This cost is significantly unacceptable when the network is too unreliable causing many elections.</li>
<li>When the network is more stable, election is rare and it can prevent partitioned follower interupting the current term.</li>
</ul>
</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://liyun-zhang.github.io/2022/07/24/Courses/CS149/16-Heterogeneous-Parallelism-and-Hardware-Specialization/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LiyunZhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LiyunZhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LiyunZhang">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/07/24/Courses/CS149/16-Heterogeneous-Parallelism-and-Hardware-Specialization/" class="post-title-link" itemprop="url">16. Heterogeneous Parallelism and Hardware Specialization</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-07-24 15:20:29" itemprop="dateCreated datePublished" datetime="2022-07-24T15:20:29+08:00">2022-07-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-02-09 12:58:16" itemprop="dateModified" datetime="2024-02-09T12:58:16+08:00">2024-02-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Open-Courses/" itemprop="url" rel="index"><span itemprop="name">Open Courses</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Open-Courses/CMU-15-418-Stanford-CS149-Parallel-Computing/" itemprop="url" rel="index"><span itemprop="name">CMU 15-418 / Stanford CS149 Parallel Computing</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <ol>
<li>Amdahl’s law in terms of resource limits: <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>p</mi><mi>e</mi><mi>e</mi><mi>d</mi><mi>u</mi><mi>p</mi><mo stretchy="false">(</mo><mi>f</mi><mo separator="true">,</mo><mi>n</mi><mo separator="true">,</mo><mi>r</mi><mo stretchy="false">)</mo><mo>=</mo><mfrac><mn>1</mn><mrow><mfrac><mrow><mn>1</mn><mo>−</mo><mi>f</mi></mrow><mrow><mi>p</mi><mi>e</mi><mi>r</mi><mi>f</mi><mo stretchy="false">(</mo><mi>r</mi><mo stretchy="false">)</mo></mrow></mfrac><mo>+</mo><mfrac><mi>f</mi><mrow><mi>p</mi><mi>e</mi><mi>r</mi><mi>f</mi><mo stretchy="false">(</mo><mi>r</mi><mo stretchy="false">)</mo><mo>⋅</mo><mfrac><mi>n</mi><mi>r</mi></mfrac></mrow></mfrac></mrow></mfrac></mrow><annotation encoding="application/x-tex">speedup(f, n, r)=\frac{1}{\frac{1-f}{perf(r)}+\frac{f}{perf(r)\cdot\frac{n}{r}}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">s</span><span class="mord mathnormal">p</span><span class="mord mathnormal">e</span><span class="mord mathnormal">e</span><span class="mord mathnormal">d</span><span class="mord mathnormal">u</span><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">n</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.877228em;vertical-align:-1.03212em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.845108em;"><span style="top:-2.51911em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mopen nulldelimiter sizing reset-size3 size6"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9584142857142857em;"><span style="top:-2.640785714285714em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span><span class="mopen mtight">(</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mclose mtight">)</span></span></span></span><span style="top:-3.2255000000000003em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line mtight" style="border-bottom-width:0.049em;"></span></span><span style="top:-3.4623857142857144em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mbin mtight">−</span><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.5377857142857143em;"><span></span></span></span></span></span><span class="mclose nulldelimiter sizing reset-size3 size6"></span></span><span class="mbin mtight">+</span><span class="mord mtight"><span class="mopen nulldelimiter sizing reset-size3 size6"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9584142857142857em;"><span style="top:-2.5925285714285713em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span><span class="mopen mtight">(</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mclose mtight">)</span><span class="mbin mtight">⋅</span><span class="mord mtight"><span class="mopen nulldelimiter sizing reset-size1 size6"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8175600000000001em;"><span style="top:-2.468em;"><span class="pstrut" style="height:3em;"></span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span><span style="top:-3.2255000000000003em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line mtight" style="border-bottom-width:0.049em;"></span></span><span style="top:-3.387em;"><span class="pstrut" style="height:3em;"></span><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.532em;"><span></span></span></span></span></span><span class="mclose nulldelimiter sizing reset-size1 size6"></span></span></span></span></span><span style="top:-3.2255000000000003em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line mtight" style="border-bottom-width:0.049em;"></span></span><span style="top:-3.4623857142857144em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.7874714285714286em;"><span></span></span></span></span></span><span class="mclose nulldelimiter sizing reset-size3 size6"></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.03212em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span>. Here, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo>=</mo></mrow><annotation encoding="application/x-tex">f =</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span></span></span></span> fraction of program that is parallelizable, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>=</mo></mrow><annotation encoding="application/x-tex">n =</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span></span></span></span> total processing resources, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi><mo>=</mo></mrow><annotation encoding="application/x-tex">r =</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span></span></span></span> resources dedicated to each processing core, each of the <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mi>n</mi><mi>r</mi></mfrac></mrow><annotation encoding="application/x-tex">\frac{n}{r}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.040392em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.695392em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span> cores has sequential performance <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mi>e</mi><mi>r</mi><mi>f</mi><mo stretchy="false">(</mo><mi>r</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">perf(r)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">p</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mclose">)</span></span></span></span>.</li>
<li>If a processor has one <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mi>e</mi><mi>r</mi><mi>f</mi><mo stretchy="false">(</mo><mi>r</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">perf(r)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">p</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mclose">)</span></span></span></span> core and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>−</mo><mi>r</mi></mrow><annotation encoding="application/x-tex">n-r</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span></span> <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mi>e</mi><mi>r</mi><mi>f</mi><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">perf(1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">p</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span></span></span></span> cores, its <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>p</mi><mi>e</mi><mi>e</mi><mi>d</mi><mi>u</mi><mi>p</mi><mo stretchy="false">(</mo><mi>f</mi><mo separator="true">,</mo><mi>n</mi><mo separator="true">,</mo><mi>r</mi><mo stretchy="false">)</mo><mo>=</mo><mfrac><mn>1</mn><mrow><mfrac><mrow><mn>1</mn><mo>−</mo><mi>f</mi></mrow><mrow><mi>p</mi><mi>e</mi><mi>r</mi><mi>f</mi><mo stretchy="false">(</mo><mi>r</mi><mo stretchy="false">)</mo></mrow></mfrac><mo>+</mo><mfrac><mi>f</mi><mrow><mi>p</mi><mi>e</mi><mi>r</mi><mi>f</mi><mo stretchy="false">(</mo><mi>r</mi><mo stretchy="false">)</mo><mo>+</mo><mo stretchy="false">(</mo><mi>n</mi><mo>−</mo><mi>r</mi><mo stretchy="false">)</mo><mi>p</mi><mi>e</mi><mi>r</mi><mi>f</mi><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></mfrac></mrow></mfrac></mrow><annotation encoding="application/x-tex">speedup(f, n, r)=\frac{1}{\frac{1-f}{perf(r)}+\frac{f}{perf(r)+(n-r)perf(1)}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">s</span><span class="mord mathnormal">p</span><span class="mord mathnormal">e</span><span class="mord mathnormal">e</span><span class="mord mathnormal">d</span><span class="mord mathnormal">u</span><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">n</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.702448em;vertical-align:-0.8573399999999999em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.845108em;"><span style="top:-2.5191100000000004em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mopen nulldelimiter sizing reset-size3 size6"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9584142857142857em;"><span style="top:-2.640785714285714em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span><span class="mopen mtight">(</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mclose mtight">)</span></span></span></span><span style="top:-3.2255000000000003em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line mtight" style="border-bottom-width:0.049em;"></span></span><span style="top:-3.4623857142857144em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mbin mtight">−</span><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.5377857142857143em;"><span></span></span></span></span></span><span class="mclose nulldelimiter sizing reset-size3 size6"></span></span><span class="mbin mtight">+</span><span class="mord mtight"><span class="mopen nulldelimiter sizing reset-size3 size6"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9584142857142857em;"><span style="top:-2.640785714285714em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span><span class="mopen mtight">(</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mclose mtight">)</span><span class="mbin mtight">+</span><span class="mopen mtight">(</span><span class="mord mathnormal mtight">n</span><span class="mbin mtight">−</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mclose mtight">)</span><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span><span class="mopen mtight">(</span><span class="mord mtight">1</span><span class="mclose mtight">)</span></span></span></span><span style="top:-3.2255000000000003em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line mtight" style="border-bottom-width:0.049em;"></span></span><span style="top:-3.4623857142857144em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.5377857142857143em;"><span></span></span></span></span></span><span class="mclose nulldelimiter sizing reset-size3 size6"></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.8573399999999999em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span>.</li>
<li>Most “real world” applications have complex workload characteristics. The most efficient processor is a heterogeneous mixture of resources, namely use the most efficient tool for the job.</li>
<li>Supercomputers are energy constrained due to shear scale and overall cost to operate (power for machine and for cooling)<br />
Datacenters are energy constrained to reduce cost of cooling and reduce physical space requirements.<br />
Mobile devices are energy constrained due to limited battery life and heat dissipation.</li>
<li>Challenge of heterogeneous for system designer: what is the right mixture of resources to meet performance, cost, and energy goals?<br />
Too few throughput oriented resources would lower peak throughput for parallel workloads. Too few sequential processing resources make the overall system limited by sequential part of workload. How much chip area should be dedicated to a specific function. (these resources are taken away from general-purpose processing) Work balance must be anticipated at chip design time</li>
<li>Challenge to software developer: how to map programs onto a heterogeneous collection of resources?<br />
Wish to design algorithms that decompose well into components that each map well to different processing components of the machine. The scheduling problem is more complex on a heterogeneous system. Available mixture of resources can dictate choice of algorithm. Software portability and maintenance nightmare.</li>
<li>Reducing energy consumption should use specialized processing and move less data.</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://liyun-zhang.github.io/2022/07/21/Courses/CS149/15-Transactional-Memory/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LiyunZhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LiyunZhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LiyunZhang">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/07/21/Courses/CS149/15-Transactional-Memory/" class="post-title-link" itemprop="url">15. Transactional Memory</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-07-21 22:53:19" itemprop="dateCreated datePublished" datetime="2022-07-21T22:53:19+08:00">2022-07-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-02-09 12:58:11" itemprop="dateModified" datetime="2024-02-09T12:58:11+08:00">2024-02-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Open-Courses/" itemprop="url" rel="index"><span itemprop="name">Open Courses</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Open-Courses/CMU-15-418-Stanford-CS149-Parallel-Computing/" itemprop="url" rel="index"><span itemprop="name">CMU 15-418 / Stanford CS149 Parallel Computing</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="transactional-memory"><a class="markdownIt-Anchor" href="#transactional-memory"></a> Transactional memory</h1>
<ol>
<li>The declarative programming is that programmer states what to do, not how to do it. System implements synchronization as necessary to ensure atomicity.</li>
<li>In transaction memory, atomic construct is declarative, which means that programmer states what to do, not how to do it. System implements synchronization as necessary to ensure atomicity.<br />
System could implement <code>atomic&#123;&#125;</code> using a lock. But programmer has no explicit use or management of locks.<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Traditional method</span></span><br><span class="line"><span class="built_in">lock</span>(mutex);</span><br><span class="line"><span class="comment">//critical code</span></span><br><span class="line"><span class="built_in">unlock</span>(mutex);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Transaction memory</span></span><br><span class="line">atomic &#123;</span><br><span class="line">  <span class="comment">// critical code</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>Memory transaction is an atomic and isolated sequence of memory accesses inspired by database transactions.<br />
Atomicity requires that upon transaction commit, all memory writes in transaction take effect at once, and on transaction abort, none of the writes appear to take effect as if transaction never happened.<br />
Isolation means that no other processor can observe writes before transaction commits.<br />
Serializability is that transactions appear to commit in a single serial order, but the exact order of commits is not guaranteed by semantics of transaction.</li>
<li>Load-linked, store conditional (LL/SC) is a light version of transactional memory. It has a pair of corresponding instructions (not a single atomic instruction)<br />
<code>load_linked(x)</code>: load value from address<br />
<code>store_conditional(x, value)</code>: store value to x, if x hasn’t been written to since<br />
corresponding LL</li>
<li>Two read operations won’t cause true contention. In TM, we can allow the parallelism between two read operations. But serialization must be ensured when at least one write operation occurs.</li>
<li>Transactional memory system is also responsible for processing exceptions decreasing the complexity of programmers from using <code>try-catch</code> statement to manually catching exceptions.<br />
When an exception inside the atomic block is occurred, transaction is aborted and memory updates are undone.</li>
<li>Transactional memory system needs composible locks.<br />
Composing lock-based code can be tricky, which requires system-wide policies to get correct and system-wide policies can break software modularity.<br />
The following code can end up in a deadlock. TM system should be able to compose the two synchronizations together to avoid the possible deadlock. Programmer can use an <code>atomic&#123;&#125;</code> to correctly represent the two <code>synchronizaed&#123;&#125;</code> structure.<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">function</span><span class="params">(A, B)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">synchronized</span>(A)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">synchronized</span>(B)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">// critical code</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// thread 0</span></span><br><span class="line"><span class="built_in">function</span>(x, y);</span><br><span class="line"></span><br><span class="line"><span class="comment">//thread 1</span></span><br><span class="line"><span class="built_in">function</span>(y, x);</span><br></pre></td></tr></table></figure>
</li>
<li><code>Atomic&#123;&#125;</code> is not the same as <code>lock()/unlock()</code>. Atomic is a high-level declaration of atomicity, which does not specify implementation of atomicity. Lock is a low-level blocking primitive that does not provide atomicity or isolation on its own.<br />
Locks can be used to implement anatomicblock. Also, locks can be used for purposes beyond atomicity, namely we cannot replace all uses of locks with atomic regions.<br />
Atomic eliminates many data races, but programming with atomic blocks can still suffer from atomicity violations.</li>
<li>Atomicity violation due to programmer error: Logically atomic code sequence is erroneously separated into two atomic blocks.</li>
</ol>
<h1 id="implementing-transactional-memory"><a class="markdownIt-Anchor" href="#implementing-transactional-memory"></a> Implementing transactional memory</h1>
<h2 id="data-versioning"><a class="markdownIt-Anchor" href="#data-versioning"></a> Data versioning</h2>
<ol>
<li>Data versioning manages uncommitted (new) and previously committed (old) versions of data for concurrent transactions. This is used to allow transaction abort.</li>
<li>Eager versioning updates memory immediately, maintains “undo log” in case of abort.<br />
When a write happens, the old value is pushed into the undo log and write the new value to memory.<br />
When a transaction is aborted, we can search the undo log to recover the corresponding state.<br />
When the transaction is committed, we can discard the undo log of those committed contents.</li>
<li>Lazy versioning is a deferred update, namely it logs memory updates in transaction write buffer, flushes buffer on commit.<br />
When a write happens, the new value is pushed into the write buffer and we don’t write the new value to memory.<br />
When a transaction is aborted, we simply discard the write buffer, and there is no need to modify the memory since we haven’t written anything to it yet.<br />
When a transaction is committed, we write the data in write buffer to memory and discard the write buffer.</li>
<li>Eager versioning is faster in commit, since data is already in memory. But it is slower in aborts and has fault tolerance issues (crash in middle of transaction). It write to memory immediately, hoping transaction won’t abort, but deal with aborts when you have to.</li>
<li>Lazy versioning is faster in abort, which just clears log, has no fault tolerance issues. But it is slower in commits. It only write to memory when you have to.</li>
</ol>
<h2 id="conflict-detection-and-resolution"><a class="markdownIt-Anchor" href="#conflict-detection-and-resolution"></a> Conflict detection and resolution</h2>
<ol>
<li>This is to decide when to abort. It must detect and handle conflicts, read-write conflict and write-write conflict, between transactions. System must track a transaction’s read set and write set.</li>
<li>Pessimistic detection checks for conflicts during loads or stores. A hardware implementation will check for conflicts through coherence actions.<br />
The philosophy is that “I suspect conflicts might happen, so let’s always check to see if one has occurred after each memory operation… if I’m going to have to roll back, might as well do it now to avoid wasted work.”</li>
<li>Contention manager decides to stall or abort transaction when a conflict is detected. When a conflict is detected before executing (early detection), it can be stalled. When a conflict is detected after executed, then it can only restart.<br />
When the conflict is caused by two writes, it may raise a livelock, if both threads restart before the other one has finished.</li>
<li>Optimistic detection detects conflicts when a transaction attempts to commit. Hardware validates write set using coherence actions and gets exclusive access for cache lines in write set.<br />
The intuition is that “Let’s hope for the best and sort out all the conflicts only when the transaction tries to commit”<br />
On a conflict, it gives priority to committing transaction. Other transactions may abort later on. On conflicts between committing transactions, use contention manager to decide priority. Optimistic detection won’t cause livelock.</li>
<li>We can use optimistic and pessimistic schemes together. Several STM systems use optimistic for reads and pessimistic for writes.</li>
<li>Pessimistic conflict detection (“eager”) can detect conflicts early, and thus undo less work, turn some aborts to stalls. It has no forward progress guarantees, more aborts in some cases. Also, it requires fine-grained communication to check on each load/store.<br />
Bad: detection on critical path</li>
<li>Optimistic conflict detection (“lazy” or “commit”) has forward progress guarantees. It requires bulk communication and conflict detection. It detects conflicts late, can still have fairness problems.</li>
<li>Conflict detection granularity<br />
Object granularity is software-based techniques. It reduces overhead of time and space, and is close to programmer’s reasoning. But there might have false sharing on large objects.<br />
Machine word granularity can minimize false sharing, but increases overhead of time and space.<br />
Cache-line granularity is a compromise between object and word.</li>
</ol>
<h2 id="hardware-transactional-memory"><a class="markdownIt-Anchor" href="#hardware-transactional-memory"></a> Hardware transactional memory</h2>
<ol>
<li>Data versioning is implemented in caches. Cache the write buffer or the undo log. And add new cache line metadata to track transaction read set and write set.<br />
Conflict detection is implemented through cache coherence protocol. Coherence lookups detect conflicts between transactions. It works with snooping and directory coherence.</li>
<li>Register checkpoint must also be taken at transaction begin to restore execution context state on abort.</li>
<li>Cache lines needs extra bits to track read set and write set.<br />
<strong>R bit</strong> indicates data read by transaction and is set on loads, while <strong>W bit</strong> indicates data written by transaction and is set on stores. R/W bits gang-cleared on transaction commit or abort.<br />
R/W bits can be at word or cache-line granularity.<br />
For eager versioning, need a 2nd cache write for undo log.</li>
<li>Coherence requests check R/W bits to detect conflicts.<br />
Observing shared request to W-word is a read-write conflict.<br />
Observing exclusive (intent to write) request to R-word is a write-read conflict.<br />
Observing exclusive (intent to write) request to W-word is a write-write conflict.</li>
<li>Fast two-phase commit<br />
Validate: request RdX access to write set lines (if needed)<br />
Commit: gang-reset R and W bits, turns write set data to valid (dirty) data.</li>
<li>Fast conflict detection and abort<br />
Check: lookup exclusive requests in the read set and write set<br />
Abort: invalidate write set, gang-reset R and W bits, restore to register checkpoint</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://liyun-zhang.github.io/2022/07/17/Courses/CS149/14-Fine-grained-Synchronization-and-Lock-free-Programming/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LiyunZhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LiyunZhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LiyunZhang">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/07/17/Courses/CS149/14-Fine-grained-Synchronization-and-Lock-free-Programming/" class="post-title-link" itemprop="url">14. Fine-grained Synchronization and Lock-free Programming</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-07-17 11:22:54" itemprop="dateCreated datePublished" datetime="2022-07-17T11:22:54+08:00">2022-07-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-02-09 12:58:04" itemprop="dateModified" datetime="2024-02-09T12:58:04+08:00">2024-02-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Open-Courses/" itemprop="url" rel="index"><span itemprop="name">Open Courses</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Open-Courses/CMU-15-418-Stanford-CS149-Parallel-Computing/" itemprop="url" rel="index"><span itemprop="name">CMU 15-418 / Stanford CS149 Parallel Computing</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="fine-grained-synchronization-and-fine-grained-lock"><a class="markdownIt-Anchor" href="#fine-grained-synchronization-and-fine-grained-lock"></a> Fine-grained synchronization and fine-grained lock</h1>
<ol>
<li>Data structures are often larger than a single memory location. One solution is to protect the structure with a single lock.<br />
It is relatively simple to implement correct mutual exclusion for data structure operations. But the operations on the data structure are serialized, which may limit parallel application performance.</li>
<li>Another solution is “hand-over-hand” locking. We set a lock for each elements in the data structure. Each threads only keeps as less as lock they need, and every time a thread move forward, it unlock the locks they don’t need any more and lock the locks they need now.</li>
<li>The goal of fine-grained lock is to enable parallelism in data structure operations by Reducing contention for global data structure lock.<br />
It is tricky to ensure correctness (how to determine when mutual exclusion is required, how to avoid deadlock or livelock).</li>
<li>It has an overhead of taking a lock each traversal step. There are extra instructions and traversal now involves memory writes. Also, it has extra storage cost, namely a lock per node.</li>
<li>C++11 has an <code>atomic&lt;T&gt;</code>. It provides atomic read, write, read-modify-write of entire objects. Atomicity may be implemented by mutex or efficiently by processor-supported atomic instructions if <code>T</code> is a basic type.<br />
It also provides memory ordering semantics for operations before and after atomic operations.</li>
</ol>
<h1 id="lock-free-programming"><a class="markdownIt-Anchor" href="#lock-free-programming"></a> Lock-free programming</h1>
<ol>
<li>
<p>Single reader, single writer bounded queue: Only two threads (one producer, one consumer) accessing queue at the same time</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Queue</span> &#123;</span><br><span class="line">  <span class="type">int</span> data[N];</span><br><span class="line">  <span class="type">unsigned</span> head; <span class="comment">// head of queue</span></span><br><span class="line">  <span class="type">unsigned</span> tail; <span class="comment">// next free element</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">init</span><span class="params">(Queue* q)</span> </span>&#123;</span><br><span class="line">  q-&gt;head = q-&gt;tail = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// return false if queue is full</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">push</span><span class="params">(Queue* q, <span class="type">int</span> value)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// queue is full if tail is element before head</span></span><br><span class="line">  <span class="keyword">if</span> (q-&gt;tail == <span class="built_in">MOD_N</span>(q-&gt;head - <span class="number">1</span>))</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  q.data[q-&gt;tail] = value;</span><br><span class="line">  q-&gt;tail = <span class="built_in">MOD_N</span>(q-&gt;tail + <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// returns false if queue is empty</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">pop</span><span class="params">(Queue* q, <span class="type">int</span>* value)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// if not empty</span></span><br><span class="line">  <span class="keyword">if</span> (q-&gt;head != q-&gt;tail) &#123;</span><br><span class="line">    *value = q-&gt;data[q-&gt;head];</span><br><span class="line">    q-&gt;head = <span class="built_in">MOD_N</span>(q-&gt;head + <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>Single reader, single writer unbounded queue: Only push modifies <code>tail</code> and <code>reclaim</code>; only pop modifies <code>head</code>.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Node</span> &#123;</span><br><span class="line">  Node* next;</span><br><span class="line">  <span class="type">int</span> value;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Queue</span> &#123;</span><br><span class="line">  Node* head;    <span class="comment">// the element before head of queue</span></span><br><span class="line">  Node* tail;    <span class="comment">// the last element added</span></span><br><span class="line">  Node* reclaim; <span class="comment">// the head of undeleted nodes</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">init</span><span class="params">(Queue* q)</span> </span>&#123;</span><br><span class="line">  q-&gt;head = q-&gt;tail = q-&gt;reclaim = <span class="keyword">new</span> Node;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">push</span><span class="params">(Queue* q, <span class="type">int</span> value)</span> </span>&#123;</span><br><span class="line">  Node* n = <span class="keyword">new</span> Node;</span><br><span class="line">  n-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">  n-&gt;value = value;</span><br><span class="line">  q-&gt;tail-&gt;next = n;</span><br><span class="line">  q-&gt;tail = q-&gt;tail-&gt;next;</span><br><span class="line">  <span class="comment">// delete all nodes between reclaim and head</span></span><br><span class="line">  <span class="keyword">while</span> (q-&gt;reclaim != q-&gt;head) &#123;</span><br><span class="line">    Node* tmp = q-&gt;reclaim;</span><br><span class="line">    q-&gt;reclaim = q-&gt;reclaim-&gt;next;</span><br><span class="line">    <span class="keyword">delete</span> tmp;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// returns false if queue is empty</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">pop</span><span class="params">(Queue* q, <span class="type">int</span>* value)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (q-&gt;head != q-&gt;tail) &#123;</span><br><span class="line">    *value = q-&gt;head-&gt;next-&gt;value;</span><br><span class="line">    q-&gt;head = q-&gt;head-&gt;next;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>Lock-free stack: the main idea is that as long as no other thread has modified the stack, a thread’s modification can proceed. The <code>compare_and_swap</code> operation is atomic, but doesn’t need to hold any other lock on data structure.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Node</span> &#123;</span><br><span class="line">  Node* next;</span><br><span class="line">  <span class="type">int</span> value;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Stack</span> &#123;</span><br><span class="line">  Node* top;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">init</span><span class="params">(Stack* s)</span> </span>&#123;</span><br><span class="line">  s-&gt;top = <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">push</span><span class="params">(Stack* s, Node* n)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">    Node* old_top = s-&gt;top;</span><br><span class="line">    n-&gt;next = old_top;</span><br><span class="line">    <span class="comment">// Check whether the current top is the old top, </span></span><br><span class="line">    <span class="comment">// if true, set the current top to n; or get a new top</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">compare_and_swap</span>(&amp;s-&gt;top, old_top, n) == old_top)</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Node* <span class="title">pop</span><span class="params">(Stack* s)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">    Node* old_top = s-&gt;top;</span><br><span class="line">    <span class="keyword">if</span> (old_top == <span class="literal">NULL</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    Node* new_top = old_top-&gt;next;</span><br><span class="line">    <span class="comment">// if the top is still the old top, return old top and set to new top</span></span><br><span class="line">    <span class="comment">// or get a new top</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">compare_and_swap</span>(&amp;s-&gt;top, old_top, new_top) == old_top)</span><br><span class="line">      <span class="keyword">return</span> old_top;  <span class="comment">// Assume that consumer then recycles old_top</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>The above push operation is fine, but the pop operation may have some error.<br />
After thread0 stored the <code>old_top</code>, if thread1 pops the <code>old_top</code> out, modifies the stack, and pushes the <code>old_top</code> into stack again, then the <code>compare_and_swap</code> operation of thread0 will pass. Namely, thread0 cannot realize that the stack has already been modified.</p>
</li>
<li>
<p>One solution is adding a <code>pop_counter</code> to check whether other pop operations happened.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Node</span> &#123;</span><br><span class="line">  Node* next;</span><br><span class="line">  <span class="type">int</span> value;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Stack</span> &#123;</span><br><span class="line">  Node* top;</span><br><span class="line">  <span class="type">int</span> pop_count;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">init</span><span class="params">(Stack* s)</span> </span>&#123;</span><br><span class="line">  s-&gt;top = <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">push</span><span class="params">(Stack* s, Node* n)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">    Node* old_top = s-&gt;top;</span><br><span class="line">    n-&gt;next = old_top;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">compare_and_swap</span>(&amp;s-&gt;top, old_top, n) == old_top)</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Node* <span class="title">pop</span><span class="params">(Stack* s)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">    <span class="type">int</span> pop_count = s-&gt;pop_count;</span><br><span class="line">    Node* top = s-&gt;top;</span><br><span class="line">    <span class="keyword">if</span> (top == <span class="literal">NULL</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    Node* new_top = top-&gt;next;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">double_compare_and_swap</span>(&amp;s-&gt;top, top, new_top,</span><br><span class="line">                                &amp;s-&gt;pop_count, pop_count, pop_count+<span class="number">1</span>))</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">return</span> top;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>Another solution of ABA problem is hazard pointers. The ABA problem is caused by the reuse of the <code>old_top</code>. We can use the hazard pointers to track all <code>old_top</code>s, and ode cannot be recycled or reused if matches any hazard pointer.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Node</span> &#123;</span><br><span class="line">  Node* next;</span><br><span class="line">  <span class="type">int</span> value;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Stack</span> &#123;</span><br><span class="line">  Node* top;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Node *hazard[NUM_THREADS];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">init</span><span class="params">(Stack* s)</span> </span>&#123;</span><br><span class="line">  s-&gt;top = <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">push</span><span class="params">(Stack* s, Node* n)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">    Node* old_top = s-&gt;top;</span><br><span class="line">    n-&gt;next = old_top;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">compare_and_swap</span>(&amp;s-&gt;top, old_top, n) == old_top)</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Node* <span class="title">pop</span><span class="params">(Stack* s)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">    hazard[t] = s-&gt;top;</span><br><span class="line">    Node* top = hazard[t];</span><br><span class="line">    <span class="keyword">if</span> (top == <span class="literal">NULL</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    Node* new_top = top-&gt;next;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">compare_and_swap</span>(&amp;s-&gt;top, top, new_top))</span><br><span class="line">      <span class="keyword">return</span> top;  <span class="comment">// Caller must clear hazard[t] when it’s done with top</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>Lock-free linked list insertion: assumes the only operation on the list is insert. Supporting lock-free deletion significantly complicates data-structure.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Node</span> &#123;</span><br><span class="line">  <span class="type">int</span> value;</span><br><span class="line">  Node* next;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">List</span> &#123;</span><br><span class="line">  Node* head;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// insert new node after specified node</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">insert_after</span><span class="params">(List* list, Node* after, <span class="type">int</span> value)</span> </span>&#123;</span><br><span class="line">  Node* n = <span class="keyword">new</span> Node;</span><br><span class="line">  n-&gt;value = value;</span><br><span class="line">  <span class="comment">// assume case of insert into empty list handled</span></span><br><span class="line">  <span class="comment">// here (keep code on slide simple for class discussion)</span></span><br><span class="line">  Node* prev = list-&gt;head;</span><br><span class="line">  <span class="keyword">while</span> (prev-&gt;next) &#123;</span><br><span class="line">    <span class="keyword">if</span> (prev == after) &#123;</span><br><span class="line">      <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        Node* old_next = prev-&gt;next;</span><br><span class="line">        n-&gt;next = old_next;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">compare_and_swap</span>(&amp;prev-&gt;next, old_next, n) == old_next)</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    prev = prev-&gt;next;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>If only your program is using the machine, well written code with locks can be as fast (or faster) than lock-free code.<br />
But there are situations where code with locks can suffer from tricky performance problems. Like multi-programmed situations where page faults, pre-emption, etc. can occur while thread is in a critical section</p>
</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="Previous page" aria-label="Previous page" href="/about/page/4/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/about/">1</a><span class="space">&hellip;</span><a class="page-number" href="/about/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/about/page/6/">6</a><a class="page-number" href="/about/page/7/">7</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/about/page/6/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">LiyunZhang</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" rel="noopener" target="_blank">NexT.Mist</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>







  




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.7/katex.min.css" integrity="sha256-hLTCMFlKxdNgPXyWlSSxYN0ykJmxxq9Yt3MNfdRGWeA=" crossorigin="anonymous">



</body>
</html>

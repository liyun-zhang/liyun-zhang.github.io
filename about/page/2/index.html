<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"liyun-zhang.github.io","root":"/","images":"/images","scheme":"Mist","darkmode":true,"version":"8.17.0","exturl":false,"sidebar":{"position":"right","display":"hide","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="LiyunZhang">
<meta property="og:url" content="http://liyun-zhang.github.io/about/page/2/index.html">
<meta property="og:site_name" content="LiyunZhang">
<meta property="og:locale">
<meta property="article:author" content="LiyunZhang">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://liyun-zhang.github.io/about/page/2/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-Hans","comments":"","permalink":"","path":"about/page/2/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>LiyunZhang</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">LiyunZhang</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">LiyunZhang</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">62</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">29</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://liyun-zhang.github.io/2023/09/27/Paper/Sys4AI/SiloD/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LiyunZhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LiyunZhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LiyunZhang">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/09/27/Paper/Sys4AI/SiloD/" class="post-title-link" itemprop="url">SiloD</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-09-27 15:46:11" itemprop="dateCreated datePublished" datetime="2023-09-27T15:46:11+08:00">2023-09-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-03-16 00:49:52" itemprop="dateModified" datetime="2024-03-16T00:49:52+08:00">2024-03-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Paper-Notebook/" itemprop="url" rel="index"><span itemprop="name">Paper Notebook</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Paper-Notebook/Sys4AI/" itemprop="url" rel="index"><span itemprop="name">Sys4AI</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Paper: <a target="_blank" rel="noopener" href="https://dl.acm.org/doi/abs/10.1145/3552326.3567499">SiloD: A Co-design of Caching and Scheduling for Deep Learning Clusters</a></p>
<p><ul class="markdownIt-TOC">
<li><a href="#background">Background</a>
<ul>
<li><a href="#how-to-separate-storage-and-computing-in-dl-training">How to separate storage and computing in DL training?</a></li>
<li><a href="#how-to-leverage-the-cache-subsystem-for-dl-training">How to leverage the cache subsystem for DL training?</a></li>
<li><a href="#how-to-cache-data-for-dl-training">How to cache data for DL training?</a></li>
<li><a href="#what-is-the-problem-of-static-allocation">What is the problem of static allocation?</a></li>
</ul>
</li>
<li><a href="#purpose">Purpose</a></li>
<li><a href="#model">Model</a>
<ul>
<li><a href="#what-does-silod-do">What does SiloD do?</a></li>
<li><a href="#how-does-silod-estimate-performance">How does SiloD estimate performance?</a></li>
<li><a href="#how-to-integrate-silod-with-the-existing-scheduler">How to integrate SiloD with the existing scheduler?</a></li>
<li><a href="#how-to-use-silod-without-modifying-the-existing-scheduler">How to use SiloD without modifying the existing scheduler?</a></li>
<li><a href="#how-does-silod-allocate-resources">How does SiloD allocate resources?</a></li>
<li><a href="#how-to-handle-delayed-data-access-and-irregular-data-access">How to handle delayed data access and irregular data access?</a></li>
<li><a href="#how-does-silod-support-fault-tolerance">How does SiloD support fault tolerance?</a></li>
</ul>
</li>
<li><a href="#evaluation">Evaluation</a></li>
</ul>
</p>
<h1 id="background"><a class="markdownIt-Anchor" href="#background"></a> Background</h1>
<h2 id="how-to-separate-storage-and-computing-in-dl-training"><a class="markdownIt-Anchor" href="#how-to-separate-storage-and-computing-in-dl-training"></a> How to separate storage and computing in DL training?</h2>
<ol>
<li>Separate storage and computing. The training is executed on a compute cluster equipped with GPUs/TPUs while reading data from a separate cluster that hosts the storage service.</li>
<li>When submitting a DL job, users can specify the storage account and the location of the desired dataset, and the job can directly load the data through remote IO.</li>
<li>The remote IO between compute and storage services could become a bottleneck. The worst case is to read the entire training dataset remotely in each epoch.</li>
<li>Despite being highly diverse for different training jobs, the data access and the computation pattern are both highly stable and predictable within each individual job.</li>
</ol>
<h2 id="how-to-leverage-the-cache-subsystem-for-dl-training"><a class="markdownIt-Anchor" href="#how-to-leverage-the-cache-subsystem-for-dl-training"></a> How to leverage the cache subsystem for DL training?</h2>
<ol>
<li>Leverage local disks of GPU servers, instead of the small cache memory in traditional systems, to cache a subset of data to reduce the demands to remote IO.</li>
<li>The first type of cache subsystem is built into a data-loading library.
<ul>
<li>The cache is built with the processes of a training job and is statically allocated.</li>
<li>DL training jobs have diverse demands on cache and remote IO. An isolated cache with a static allocation can neither satisfy nor exploit such diversity.</li>
</ul>
</li>
<li>The second type of cache subsystem is distributed cache, which consolidates the local storage of all cluster servers into a large storage pool shared by all jobs.
<ul>
<li>Modern GPU cluster usually has a high-speed storage fabric (separate from the InfiniBand network used for distributed training) that supports accessing data from peer servers as fast as a local disk.</li>
<li>A distributed cache across the local cluster can generally satisfy the IO demands of training jobs.</li>
</ul>
</li>
</ol>
<h2 id="how-to-cache-data-for-dl-training"><a class="markdownIt-Anchor" href="#how-to-cache-data-for-dl-training"></a> How to cache data for DL training?</h2>
<ol>
<li>
<p>Due to the random-and-exactly-once data access pattern, uniform caching is optimal for a single training job.</p>
</li>
<li>
<p>In uniform caching, accessed data items are cached until the cache capacity is reached and will not be evicted after that. There is no eviction unless the cache capacity is reduced.</p>
<ul>
<li>Other cache eviction policies like LRU (Least-Recently-Used) may evict useful items, leading to the thrashing issue.</li>
<li>In uniform caching, part of the dataset stays on the local disk permanently and can be used in each epoch.</li>
<li>LRU will only reserve data used recently, and they won’t be used in the near future.</li>
</ul>
</li>
<li>
<p>Notably, the cached data are evenly distributed in each batch instead of caching some batches entirely.</p>
<ul>
<li>Each data item has a unique ID. The missed data items are fetched from the remote storage. Because each epoch shuffles the data loading order, the expected cache hit ratio is uniform for all items.</li>
<li>In this way, we can improve the performance of the data-loading pipeline.</li>
</ul>
</li>
<li>
<p>For deep learning training, uniform caching leads to a constant and predictable cache hit ratio w.r.t. the cache capacity regardless of which items are being cached.</p>
<img src="/imgs/Sys4ai/SiloD/cache.png" width="50%">
</li>
</ol>
<h2 id="what-is-the-problem-of-static-allocation"><a class="markdownIt-Anchor" href="#what-is-the-problem-of-static-allocation"></a> What is the problem of static allocation?</h2>
<ol>
<li>When there are multiple jobs in a cluster, uniform caching transforms the cache management from a cache eviction problem to a cache space allocation problem.</li>
<li>The job’s cache efficiency is the amount of remote IO (in MB/s) saved per GB of cache allocated.</li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>𝑓</mi><mo>∗</mo></msup></mrow><annotation encoding="application/x-tex">𝑓^\ast</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.688696em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span></span></span></span> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi></mrow><annotation encoding="application/x-tex">d</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">d</span></span></span></span> are the IO demand to achieve the ideal training speed and the dataset size, respectively. A job’s cache efficiency is <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><msup><mi>𝑓</mi><mo>∗</mo></msup><mi>d</mi></mfrac></mrow><annotation encoding="application/x-tex">\frac{𝑓^\ast}{d}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.325448em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.980448em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.446108em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7633428571428571em;"><span style="top:-2.931em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span>.</li>
<li>The cache efficiency of different datasets can vary largely. A static cache allocation could not take advantage of the diverse cache-efficiency of DL jobs.</li>
</ol>
<h1 id="purpose"><a class="markdownIt-Anchor" href="#purpose"></a> Purpose</h1>
<ol>
<li>Issue:
<ul>
<li>Existing deep learning schedulers do not manage storage resources and thus fail to consider the diverse caching effects across different training jobs.</li>
<li>State-of-the-art deep learning schedulers focus on arbitrating compute resources (e.g., GPUs and CPUs) with different optimization objectives like job completion time (JCT), fairness, or cluster utilization.</li>
</ul>
</li>
<li>Challenge:
<ul>
<li>Deep learning schedulers have diverse scheduling objectives. An ad-hoc solution to every scheduling policy increases design complexity and is hard to scale.</li>
<li>Deep learning training exhibits highly diverse performance patterns: different jobs impose different cache and IO demands. This further complicates the system design.</li>
<li>Even deep learning-aware cache systems could exhibit poor performance because of caching policies that ignore scheduling impacts.</li>
</ul>
</li>
<li>Contribution:
<ul>
<li>Co-design the cluster scheduler and the cache subsystems for deep learning training.</li>
<li>The job performance estimator is enhanced.
<ul>
<li>To help different schedulers jointly consider the impact of storage and compute resource allocation while preserving their respective scheduling objectives.</li>
<li>SiloD derives a unified way of performance estimation by further leveraging the pipelined execution of data loading and computation.</li>
<li>SiloD can augment different state-of-the-art deep learning schedulers to jointly perform cache and remote IO allocation while preserving the original objectives of these scheduling policies.</li>
</ul>
</li>
</ul>
</li>
</ol>
<h1 id="model"><a class="markdownIt-Anchor" href="#model"></a> Model</h1>
<h2 id="what-does-silod-do"><a class="markdownIt-Anchor" href="#what-does-silod-do"></a> What does SiloD do?</h2>
<ol>
<li>SiloD allocates compute and cache-related resources jointly to training jobs. SiloD treats cache and remote IO as first-class citizens.
<ul>
<li>Existing multi-resource schedulers can treat storage resources as yet another resource type whose impact has already been captured by the performance estimator.</li>
</ul>
</li>
<li>The scheduling problem can be generally abstracted as allocating cluster resources defined in <code>totalResource</code> to jobs with the help of a performance estimator <code>perf(j, R)</code>.</li>
<li>SiloD further enhances the estimator <code>perf</code> with <code>SiloDPerf</code> to estimate the joint impact of computing and storage resources.
<ul>
<li>The SiloD-augmented performance estimator transforms a joint performance estimation into a two-step process.</li>
<li>It first estimates whether data loading will become the bottleneck of the entire training.</li>
<li>If so, SiloD will use <code>IOPerf</code>, a performance estimator we introduced, to analyze the impact of storage and estimate job performance under the IO bottleneck.</li>
</ul>
</li>
</ol>
<h2 id="how-does-silod-estimate-performance"><a class="markdownIt-Anchor" href="#how-does-silod-estimate-performance"></a> How does SiloD estimate performance?</h2>
<ol>
<li>The end-to-end throughput is then determined by the bottleneck stage, i.e., <code>SiloDPerf</code><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>=</mo><mi>m</mi><mi>i</mi><mi>n</mi><mo stretchy="false">{</mo><msup><mi>f</mi><mo>∗</mo></msup><mo separator="true">,</mo><mi>f</mi><mo stretchy="false">}</mo></mrow><annotation encoding="application/x-tex">=min\{f^\ast,f\}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.36687em;vertical-align:0em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">m</span><span class="mord mathnormal">i</span><span class="mord mathnormal">n</span><span class="mopen">{</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.688696em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mclose">}</span></span></span></span>.
<ul>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>f</mi><mo>∗</mo></msup></mrow><annotation encoding="application/x-tex">f^\ast</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.688696em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span></span></span></span> is a job’s computation throughput when IO is not the bottleneck, i.e., <code>perf</code>, the original estimator used by an existing scheduler.</li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi></mrow><annotation encoding="application/x-tex">f</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span></span></span></span> is the throughput of data loading, i.e., <code>IOPerf</code>, which is the estimator for IO given some cache allocation.</li>
</ul>
</li>
<li>A job’s remote IO demand can be calculated as <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mo>=</mo><mi>f</mi><mo>⋅</mo><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><mfrac><mi>c</mi><mi>d</mi></mfrac><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">b=f\cdot (1-\frac{c}{d})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.095em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.695392em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose">)</span></span></span></span>.
<ul>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>𝑐</mi></mrow><annotation encoding="application/x-tex">𝑐</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">c</span></span></span></span> is the allocated cache space and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>𝑑</mi></mrow><annotation encoding="application/x-tex">𝑑</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">d</span></span></span></span> the size of the training dataset. The expected cache hit ratio of a job is <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mi>c</mi><mi>d</mi></mfrac></mrow><annotation encoding="application/x-tex">\frac{c}{d}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.040392em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.695392em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span>.</li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>𝑏</mi></mrow><annotation encoding="application/x-tex">𝑏</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">b</span></span></span></span> is the remote IO demand of a job, which equals the data loading throughput multiplied by the cache miss ratio.</li>
</ul>
</li>
<li>A job’s IO throughput 𝑓 (i.e., <code>IOPerf</code>) can be estimated by <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo>=</mo><mfrac><mi>b</mi><mrow><mn>1</mn><mo>−</mo><mi>c</mi><mi mathvariant="normal">/</mi><mi>d</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">f=\frac{b}{1-c/d}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.400108em;vertical-align:-0.52em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8801079999999999em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mbin mtight">−</span><span class="mord mathnormal mtight">c</span><span class="mord mtight">/</span><span class="mord mathnormal mtight">d</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">b</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.52em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span>.</li>
<li>When a job is fetching data at its ideal throughput (i.e., <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo>=</mo><msup><mi>f</mi><mo>∗</mo></msup></mrow><annotation encoding="application/x-tex">f = f^\ast</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.688696em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span></span></span></span>), its cache efficiency is exactly the negative derivative of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi></mrow><annotation encoding="application/x-tex">b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">b</span></span></span></span>, i.e., cache Efficiency<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>=</mo><mo>−</mo><mfrac><mrow><mi mathvariant="normal">∂</mi><mi>b</mi></mrow><mrow><mi mathvariant="normal">∂</mi><mi>c</mi></mrow></mfrac><mo>=</mo><mfrac><msup><mi>f</mi><mo>∗</mo></msup><mi>d</mi></mfrac></mrow><annotation encoding="application/x-tex">=-\frac{\partial b}{\partial c}=\frac{f^\ast}{d}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.36687em;vertical-align:0em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.2251079999999999em;vertical-align:-0.345em;"></span><span class="mord">−</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8801079999999999em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em;">∂</span><span class="mord mathnormal mtight">c</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em;">∂</span><span class="mord mathnormal mtight">b</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.325448em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.980448em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.446108em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7633428571428571em;"><span style="top:-2.931em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span>.
<ul>
<li>The different computation throughput <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>f</mi><mo>∗</mo></msup></mrow><annotation encoding="application/x-tex">f^\ast</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.688696em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span></span></span></span> of different neural models and dataset size <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi></mrow><annotation encoding="application/x-tex">d</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">d</span></span></span></span> is the source of the heterogeneity.</li>
</ul>
</li>
<li>The policy assumes the ideal throughput of a job <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>𝑓</mi><mo>∗</mo></msup></mrow><annotation encoding="application/x-tex">𝑓^\ast</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.688696em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span></span></span></span> (when IO is not a bottleneck) can be profiled offline.</li>
</ol>
<h2 id="how-to-integrate-silod-with-the-existing-scheduler"><a class="markdownIt-Anchor" href="#how-to-integrate-silod-with-the-existing-scheduler"></a> How to integrate SiloD with the existing scheduler?</h2>
<ol>
<li>In Shortest Job First (SJF), each job will have a performance score defined as its weighted sum of resource demand of all resource types multiplied by its duration.
<ul>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>c</mi><mi>o</mi><mi>r</mi><mi>e</mi><mo>=</mo><mstyle scriptlevel="0" displaystyle="true"><munder><mo><mi>min</mi><mo>⁡</mo></mo><mi>R</mi></munder><munder><mo>∑</mo><mi>t</mi></munder><msub><mi>w</mi><mi>t</mi></msub><mo>⋅</mo><msub><mi>R</mi><mi>t</mi></msub><mo>⋅</mo><mo stretchy="false">(</mo><mfrac><mrow><mi>j</mi><mi mathvariant="normal">.</mi><mi>n</mi><mi>u</mi><mi>m</mi><mi>S</mi><mi>t</mi><mi>e</mi><mi>p</mi><mi>s</mi><mo>⋅</mo><mi>j</mi><mi mathvariant="normal">.</mi><mi>s</mi><mi>t</mi><mi>e</mi><mi>p</mi><mi>D</mi><mi>a</mi><mi>t</mi><mi>a</mi><mi>S</mi><mi>i</mi><mi>z</mi><mi>e</mi></mrow><mrow><mi>p</mi><mi>e</mi><mi>r</mi><mi>f</mi><mo stretchy="false">(</mo><mi>j</mi><mo separator="true">,</mo><mi mathvariant="bold">R</mi><mo stretchy="false">)</mo></mrow></mfrac><mo stretchy="false">)</mo></mstyle></mrow><annotation encoding="application/x-tex">score=\displaystyle\min_{R}\sum_{t}w_t\cdot R_t\cdot (\frac{j.numSteps\cdot j.stepDataSize}{perf(j,\bold{R})})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">s</span><span class="mord mathnormal">c</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">e</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.3000100000000003em;vertical-align:-1.250005em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.66786em;"><span style="top:-2.355669em;margin-left:0em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.00773em;">R</span></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span><span class="mop">min</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.744331em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.050005em;"><span style="top:-1.8999949999999999em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span style="top:-3.0500049999999996em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.250005em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.02691em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.00773em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:2.2963299999999998em;vertical-align:-0.936em;"></span><span class="mopen">(</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3603299999999998em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathbf">R</span></span><span class="mclose">)</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mord">.</span><span class="mord mathnormal">n</span><span class="mord mathnormal">u</span><span class="mord mathnormal">m</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal">p</span><span class="mord mathnormal">s</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mord">.</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal">p</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mord mathnormal">a</span><span class="mord mathnormal">t</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mord mathnormal">e</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose">)</span></span></span></span></li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>w</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">w_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.02691em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> is the weight of the <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi></mrow><annotation encoding="application/x-tex">t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.61508em;vertical-align:0em;"></span><span class="mord mathnormal">t</span></span></span></span>-th resource type, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">R</mi></mrow><annotation encoding="application/x-tex">\bold{R}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">R</span></span></span></span></span> is a vector of allocation of all resource types, and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>R</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">R_{t}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.00773em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> is the allocation of the <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi></mrow><annotation encoding="application/x-tex">t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.61508em;vertical-align:0em;"></span><span class="mord mathnormal">t</span></span></span></span>-th resource type in <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">R</mi></mrow><annotation encoding="application/x-tex">\bold{R}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">R</span></span></span></span></span>, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>𝑗</mi><mi mathvariant="normal">.</mi><mi>n</mi><mi>u</mi><mi>m</mi><mi>S</mi><mi>t</mi><mi>e</mi><mi>p</mi><mi>s</mi></mrow><annotation encoding="application/x-tex">𝑗.numSteps</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mord">.</span><span class="mord mathnormal">n</span><span class="mord mathnormal">u</span><span class="mord mathnormal">m</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal">p</span><span class="mord mathnormal">s</span></span></span></span> is the total number of steps and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>𝑗</mi><mi mathvariant="normal">.</mi><mi>s</mi><mi>t</mi><mi>e</mi><mi>p</mi><mi>D</mi><mi>a</mi><mi>t</mi><mi>a</mi><mi>S</mi><mi>i</mi><mi>z</mi><mi>e</mi></mrow><annotation encoding="application/x-tex">𝑗.stepDataSize</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mord">.</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal">p</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mord mathnormal">a</span><span class="mord mathnormal">t</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mord mathnormal">e</span></span></span></span> is the size of data consumed per step of the job <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi></mrow><annotation encoding="application/x-tex">j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.85396em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span>.</li>
<li>The jobs with the least score will be scheduled first by the multi-resource SJF policy.</li>
</ul>
</li>
<li>The vanilla programming in Gavel’s max-min fairness is <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle scriptlevel="0" displaystyle="true"><munder><mo><mi>max</mi><mo>⁡</mo></mo><mi>R</mi></munder><munder><mo><mi>min</mi><mo>⁡</mo></mo><mi>j</mi></munder><mfrac><mrow><mi>p</mi><mi>e</mi><mi>r</mi><mi>f</mi><mo stretchy="false">(</mo><mi>j</mi><mo separator="true">,</mo><mi>R</mi><mo stretchy="false">[</mo><mi>j</mi><mo stretchy="false">]</mo><mo stretchy="false">)</mo></mrow><mrow><mi>p</mi><mi>e</mi><mi>r</mi><mi>f</mi><mo stretchy="false">(</mo><mi>j</mi><mo separator="true">,</mo><msup><mi>R</mi><mrow><mi>e</mi><mi>q</mi><mi>u</mi><mi>a</mi><mi>l</mi></mrow></msup><mo stretchy="false">)</mo></mrow></mfrac><mo separator="true">,</mo><mi>s</mi><mi mathvariant="normal">.</mi><mi>t</mi><mi mathvariant="normal">.</mi><mi>S</mi><mi>u</mi><mi>m</mi><mo stretchy="false">(</mo><mi>R</mi><mo stretchy="false">)</mo><mo>≤</mo><mi>t</mi><mi>o</mi><mi>t</mi><mi>a</mi><mi>l</mi><mi>R</mi><mi>e</mi><mi>s</mi><mi>o</mi><mi>u</mi><mi>r</mi><mi>c</mi><mi>e</mi></mstyle></mrow><annotation encoding="application/x-tex">\displaystyle\max_{R}\min_{j}\frac{perf(j,R[j])}{perf(j,R^{equal})},s.t. Sum(R)≤totalResource</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.363em;vertical-align:-0.936em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.43055999999999983em;"><span style="top:-2.355669em;margin-left:0em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.00773em;">R</span></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span><span class="mop">max</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.7443310000000001em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.66786em;"><span style="top:-2.3723360000000002em;margin-left:0em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span><span class="mop">min</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.863772em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7751079999999999em;"><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mclose">]</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">s</span><span class="mord">.</span><span class="mord mathnormal">t</span><span class="mord">.</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mord mathnormal">u</span><span class="mord mathnormal">m</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">o</span><span class="mord mathnormal">t</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord mathnormal">e</span><span class="mord mathnormal">s</span><span class="mord mathnormal">o</span><span class="mord mathnormal">u</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">c</span><span class="mord mathnormal">e</span></span></span></span>.
<ul>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>𝑅</mi><mo stretchy="false">[</mo><mi>𝑗</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">𝑅[𝑗]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mclose">]</span></span></span></span> is the resource allocated to the job <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi></mrow><annotation encoding="application/x-tex">j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.85396em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>R</mi><mrow><mi>e</mi><mi>q</mi><mi>u</mi><mi>a</mi><mi>l</mi></mrow></msup></mrow><annotation encoding="application/x-tex">R^{equal}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8491079999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span></span></span></span></span></span></span></span> is the equal resource division among all jobs.</li>
<li>The max-min fairness objective maximizes the job with the least performance improvement over the equal resource division.</li>
</ul>
</li>
<li>When integrate SiloD, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">R</mi></mrow><annotation encoding="application/x-tex">\bold{R}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">R</span></span></span></span></span> includes cache and remote IO as another two types of resources in addition to compute resources and the performance estimator function <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mi>e</mi><mi>r</mi><mi>f</mi><mo stretchy="false">(</mo><mi>j</mi><mo separator="true">,</mo><mi mathvariant="bold">R</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">perf(j,\bold{R})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">p</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathbf">R</span></span><span class="mclose">)</span></span></span></span> is replaced by <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>i</mi><mi>l</mi><mi>o</mi><mi>D</mi><mi>P</mi><mi>e</mi><mi>r</mi><mi>f</mi><mo stretchy="false">(</mo><mi>j</mi><mo separator="true">,</mo><mi mathvariant="bold">R</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">SiloDPerf(j,\bold{R})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathbf">R</span></span><span class="mclose">)</span></span></span></span>.</li>
</ol>
<h2 id="how-to-use-silod-without-modifying-the-existing-scheduler"><a class="markdownIt-Anchor" href="#how-to-use-silod-without-modifying-the-existing-scheduler"></a> How to use SiloD without modifying the existing scheduler?</h2>
<ol>
<li>The greedy policy minimizes the remote IO consumption in a best-effort manner so that the impact of IO on original scheduling objectives can be minimized.</li>
<li>It can be done by allocating more cache to the most cache-efficient jobs.</li>
<li>Each job first calculates its cache efficiency. The datasets with the highest cache efficiency are first cached until the cache space is full.<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> job j <span class="keyword">in</span> <span class="keyword">all</span> jobs do</span><br><span class="line">  j.CacheEfficiency <span class="operator">=</span> j.fStar <span class="operator">/</span> j.datasetSize</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> job j <span class="keyword">in</span> descending <span class="keyword">order</span> <span class="keyword">of</span> j.CacheEfficiency do</span><br><span class="line">  alloc.Cache[j] <span class="operator">=</span> <span class="built_in">min</span>(j.datasetSize, totalCache)</span><br><span class="line">  totalCache <span class="operator">-</span><span class="operator">=</span> alloc.Cache[j]</span><br><span class="line"> </span><br><span class="line"><span class="keyword">return</span> alloc</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="how-does-silod-allocate-resources"><a class="markdownIt-Anchor" href="#how-does-silod-allocate-resources"></a> How does SiloD allocate resources?</h2>
<ol>
<li>SiloD Data Manager serves in the storage layer to enforce the allocations made by the scheduler.
<ul>
<li>A cluster scheduler uses the interface to allocate cache and remote IO to two types of entities: jobs and datasets.
<ul>
<li>Remote IO is allocated to jobs directly, while cache is allocated to datasets and the associated jobs indirectly.</li>
<li>Multiple jobs can transparently share the same cache space for the same dataset. In contrast, since jobs using the same dataset still read data items in a different order, remote IO is exclusive to each job.</li>
<li>The cache consumption is charged once for each dataset instead of every job. The cache efficiency is defined at the dataset-level, which is the sum of all jobs’ cache efficiency using the same dataset.</li>
<li>The remote IO allocation is equally distributed to each job worker for distributed data-parallel training.</li>
</ul>
</li>
<li>The SiloD data manager sets up FUSE (Filesystem in USErspace) clients, which are co-located with training tasks to manage the cache, throttle remote IO, and maintain the metadata of datasets on each server.</li>
</ul>
</li>
<li>SiloD Scheduler extends the responsibility of the compute-only resource scheduler from job scheduling to compute-storage joint allocation.<br />
<img src="/imgs/Sys4ai/SiloD/structure.png" width="50%"></li>
</ol>
<h2 id="how-to-handle-delayed-data-access-and-irregular-data-access"><a class="markdownIt-Anchor" href="#how-to-handle-delayed-data-access-and-irregular-data-access"></a> How to handle delayed data access and irregular data access?</h2>
<ol>
<li>Since DL training reads each data item exactly once per epoch, any newly cached data items will never be reaccessed until the next epoch.
<ul>
<li>Even though the newly cached item consumes the cache space, it does not help to reduce the remote IO until the next epoch. Therefore, an accurate estimation of job performance should be made using an effective cache size.</li>
<li>However, since multiple jobs may use the same dataset, it is unknown beforehand if a newly cached item by one job is effective or not for other jobs.</li>
<li>The delayed effectiveness only has a limited impact, lasting for at most one epoch for newly cached items. A DL job usually trains a model for tens of epochs, thus most of the time, the cached data are effective.</li>
<li>SiloD also supports fine-grained management for policies to inspect the effective cache size and the instantaneous remote IO demand by maintaining a bitset for each job to track its accessed items.</li>
</ul>
</li>
<li>When a cluster is mixed with regular jobs satisfying SiloD’s assumptions and irregular jobs, we partition the cache and remote IO into two parts for all regular and irregular jobs, respectively.
<ul>
<li>Allocate resources to the regular jobs in the first partition still using <code>SiloDPerf</code>.</li>
<li>The irregular jobs in the second partition fall back to the original scheduling policy and estimator and share the cache and remote IO within the partition.</li>
<li>In this way, the regular DL jobs can still benefit from exploiting the heterogeneous cache efficiency without being impacted by potential anomalies due to the mis-estimation of irregular jobs.</li>
</ul>
</li>
</ol>
<h2 id="how-does-silod-support-fault-tolerance"><a class="markdownIt-Anchor" href="#how-does-silod-support-fault-tolerance"></a> How does SiloD support fault tolerance?</h2>
<ol>
<li>The allocation of remote IO and cache is stored in “pod annotation” for the pods of each job, which is kept reliably by Kubernetes.</li>
<li>For the job with multiple pods, the remote IO allocation is proportionally divided into each pod, and the cache allocation is the same for all pods.</li>
<li>When SiloD Data Manager recovers from crashes, it reconstructs the status by collecting pod information.</li>
<li>The cache content on each server is stored on a local disk and thus can be reliably restored when the server restarts.</li>
<li>SiloD does not add stateful information to the cluster scheduler; thus, their fault tolerance is handled using their original approach.</li>
</ol>
<h1 id="evaluation"><a class="markdownIt-Anchor" href="#evaluation"></a> Evaluation</h1>
<ol>
<li>First, the author showed the evidence of the issues:
<ul>
<li>
<p>They presented the increasing dataset size and the GPU performance as indirect evidence of remote IO bottleneck.<br />
<img src="/imgs/Sys4ai/SiloD/indirect.png" width="50%"></p>
</li>
<li>
<p>Then, the required remote IO to reach the optimal speed for GPU is calculated, and the GPU cluster’s aggregate IO demand is profiled to prove that remote IO without cache is slowing down the training prosedure.<br />
<img src="/imgs/Sys4ai/SiloD/optimal.png" width="25%"><br />
<img src="/imgs/Sys4ai/SiloD/demand.png" width="25%"></p>
</li>
<li>
<p>When discussing the design for the cache subsystem, the author also provided the sub-optimal evidence of the current scheduler without knowing the cache subsystem.<br />
<img src="/imgs/Sys4ai/SiloD/quiver.png" width="50%"></p>
</li>
</ul>
</li>
<li>When further exploring the cache efficiency, the author showed the variance between different datasets and effective cache size.<br />
<img src="/imgs/Sys4ai/SiloD/variance.png" width="35%" /> <img src="/imgs/Sys4ai/SiloD/effective.png" width="35%" /></li>
<li>To evaluate SiloD in a large-scale cluster of fast V100 GPUs with a lower cost, the authors design an approach to accelerating the training on a K80 GPU cluster to investigate the data loading performance of running the same trace in a V100 GPU cluster.
<ul>
<li>In the experiment, they first profile the training speed of selected models on real V100 GPUs.</li>
<li>Then, execute the same model on K80 GPUs by processing the same training pipeline of data loading, preprocessing, and model aggregation but replacing the model execution (forward pass and backward pass) with “<code>sleep()</code>” for the profiled duration from V100.</li>
<li>Since deep learning training usually has a very stable mini-batch duration, the IO behavior in accelerated K80 GPUs is almost the same as real training of V100 GPUs.</li>
</ul>
</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://liyun-zhang.github.io/2023/09/26/Paper/Distributed/COPS/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LiyunZhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LiyunZhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LiyunZhang">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/09/26/Paper/Distributed/COPS/" class="post-title-link" itemprop="url">COPS</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-09-26 13:54:58" itemprop="dateCreated datePublished" datetime="2023-09-26T13:54:58+08:00">2023-09-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-03-15 19:00:41" itemprop="dateModified" datetime="2024-03-15T19:00:41+08:00">2024-03-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Paper-Notebook/" itemprop="url" rel="index"><span itemprop="name">Paper Notebook</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Paper-Notebook/Distributed-System/" itemprop="url" rel="index"><span itemprop="name">Distributed System</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Paper: <a target="_blank" rel="noopener" href="http://nil.csail.mit.edu/6.824/2020/papers/cops.pdf">Don’t Settle for Eventual: Scalable Causal Consistency for Wide-Area Storage with COPS</a></p>
<p><ul class="markdownIt-TOC">
<li><a href="#purpose">Purpose</a></li>
<li><a href="#model">Model</a>
<ul>
<li><a href="#alps-systems">ALPS systems</a>
<ul>
<li><a href="#what-are-the-desirable-properties-of-alps-systems">What are the desirable properties of ALPS systems?</a></li>
<li><a href="#what-is-the-problem-of-linearizability">What is the problem of linearizability?</a></li>
</ul>
</li>
<li><a href="#causal-consistency">Causal+ consistency</a>
<ul>
<li><a href="#what-is-causal-consistency">What is causal consistency?</a></li>
<li><a href="#how-to-handle-conflicts">How to handle conflicts?</a></li>
<li><a href="#how-to-decide-which-write-is-the-last-write">How to decide which write is the last write?</a></li>
<li><a href="#what-are-other-consistency-models">What are other consistency models?</a></li>
<li><a href="#how-is-causal-ensured-in-cops">How is causal+ ensured in COPS?</a></li>
<li><a href="#why-previous-systems-cannot-provide-scalability">Why previous systems cannot provide scalability?</a></li>
</ul>
</li>
<li><a href="#cops-system">COPS system</a>
<ul>
<li><a href="#what-are-the-components-of-cops">What are the components of COPS?</a></li>
<li><a href="#what-consistency-is-achieved-in-cops">What consistency is achieved in COPS?</a></li>
<li><a href="#key-value-store">Key-value store</a>
<ul>
<li><a href="#what-is-stored-in-cops-storage">What is stored in COPS storage?</a></li>
<li><a href="#how-does-cops-support-scalability-in-kv-storage">How does COPS support scalability in KV-storage?</a></li>
</ul>
</li>
<li><a href="#client-library">Client library</a>
<ul>
<li><a href="#what-is-provided-in-the-client-api">What is provided in the client API?</a></li>
<li><a href="#what-is-the-context-in-the-library">What is the context in the library?</a></li>
<li><a href="#what-does-cops-gt-store-in-context">What does COPS-GT store in context?</a></li>
<li><a href="#what-are-the-concerns-of-the-cops-gt-context">What are the concerns of the COPS-GT context?</a></li>
<li><a href="#what-does-cops-store-in-context">What does COPS store in context?</a></li>
<li><a href="#how-does-cops-or-cops-gt-write-to-the-local-cluster">How does COPS (or COPS-GT) write to the local cluster?</a></li>
<li><a href="#how-to-replica-writes-between-clusters">How to replica writes between clusters?</a></li>
<li><a href="#how-to-read-values-in-cops">How to read values in COPS?</a></li>
<li><a href="#why-does-cops-gt-need-to-provide-get_trans-what-is-wrong-with-the-get-interface">Why does COPS-GT need to provide get_trans? What is wrong with the get interface?</a></li>
<li><a href="#how-does-get_trans-work">How does get_trans work?</a></li>
</ul>
</li>
<li><a href="#garbage-collection">Garbage collection</a>
<ul>
<li><a href="#how-does-cops-gt-collect-version-garbage">How does COPS-GT collect version garbage?</a></li>
<li><a href="#how-does-cops-gt-collect-dependency-garbage">How does COPS-GT collect dependency garbage?</a></li>
<li><a href="#how-does-cops-collect-client-metadata-garbage">How does COPS collect client metadata garbage?</a></li>
</ul>
</li>
<li><a href="#fault-tolerance">Fault tolerance</a>
<ul>
<li><a href="#how-does-cops-handle-client-failures">How does COPS handle client failures?</a></li>
<li><a href="#how-does-cops-handle-key-value-node-failures">How does COPS handle key-value node failures?</a></li>
<li><a href="#what-will-happen-when-the-datacenter-fails">What will happen when the datacenter fails?</a></li>
<li><a href="#how-does-cops-with-conflict-detection-cops-cd-detect-conflict">How does COPS with conflict detection (COPS-CD) detect conflict?</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</p>
<h1 id="purpose"><a class="markdownIt-Anchor" href="#purpose"></a> Purpose</h1>
<ol>
<li>Issues
<ul>
<li>Systems often sacrifice strong consistency to achieve these goals, exposing inconsistencies to their clients and necessitating complex application logic.</li>
<li>The author referred to systems with these four properties—Availability, low Latency, partition tolerance, and high Scalability—as ALPS systems.</li>
<li>Eventual consistent systems may expose versions that are out of order.</li>
</ul>
</li>
<li>Contribution:
<ul>
<li>The author identified and defined a consistency model—causal consistency with convergent conflict handling, or causal+ —the strongest achieved under ALPS systems.
<ul>
<li>The convergent conflict handling component of causal+ consistency ensures that replicas never permanently diverge and that conflicting updates to the same key are dealt with identically at all sites.</li>
<li>When combined with causal consistency, this property ensures that clients see only progressively newer versions of keys.</li>
</ul>
</li>
<li>The scalability of the Clusters of Order-Preserving Servers (COPS) system can enforce causal dependencies between keys stored across an entire cluster rather than a single server like previous systems.</li>
<li>In COPS-GT, the author introduced get transactions to obtain a consistent view of multiple keys without locking or blocking.</li>
</ul>
</li>
</ol>
<h1 id="model"><a class="markdownIt-Anchor" href="#model"></a> Model</h1>
<h2 id="alps-systems"><a class="markdownIt-Anchor" href="#alps-systems"></a> ALPS systems</h2>
<h3 id="what-are-the-desirable-properties-of-alps-systems"><a class="markdownIt-Anchor" href="#what-are-the-desirable-properties-of-alps-systems"></a> What are the desirable properties of ALPS systems?</h3>
<ol>
<li><strong>Availability</strong>:
<ul>
<li>All operations issued to the data store are completed successfully.</li>
<li>No operation can block indefinitely or return an error signifying that data is unavailable.</li>
</ul>
</li>
<li><strong>Low Latency</strong>: Client operations complete “quickly.”
<ul>
<li>Commercial service-level objectives suggest an average performance of a few milliseconds and a worse-case performance (i.e., 99.9th percentile) of 10s or 100s milliseconds.</li>
</ul>
</li>
<li><strong>Partition Tolerance</strong>: The data store continues to operate under network partitions.</li>
<li><strong>High Scalability</strong>: The data store scales out linearly. Adding N resources to the system increases aggregate throughput and storage capacity by <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>N</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(N)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mclose">)</span></span></span></span>.</li>
<li><strong>Stronger Consistency</strong>:
<ul>
<li>Linearizability dictates that operations appear to take effect across the entire system at a single instance between the invocation and completion of the operation.</li>
<li>Eventual consistency models not only might subsequent reads not reflect the latest value, but reads across multiple objects might reflect an incoherent mix of old and new values.</li>
</ul>
</li>
</ol>
<h3 id="what-is-the-problem-of-linearizability"><a class="markdownIt-Anchor" href="#what-is-the-problem-of-linearizability"></a> What is the problem of linearizability?</h3>
<ol>
<li>The CAP Theorem proves that a shared-data system with availability and partition tolerance cannot achieve linearizability.</li>
<li>Low latency—defined as latency less than the maximum wide area delay between replicas—has also been proven incompatible with linearizability and sequential consistency.</li>
</ol>
<h2 id="causal-consistency"><a class="markdownIt-Anchor" href="#causal-consistency"></a> Causal+ consistency</h2>
<h3 id="what-is-causal-consistency"><a class="markdownIt-Anchor" href="#what-is-causal-consistency"></a> What is causal consistency?</h3>
<ol>
<li>Values are stored and retrieved from logical replicas, each hosting the entire key space.</li>
<li>The potential causality between operations denoted by <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>⇝</mo></mrow><annotation encoding="application/x-tex">\leadsto</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.37788em;vertical-align:0em;"></span><span class="mrel amsrm">⇝</span></span></span></span>:
<ul>
<li><strong>Execution Thread</strong>: If <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi></mrow><annotation encoding="application/x-tex">a</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">a</span></span></span></span> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi></mrow><annotation encoding="application/x-tex">b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">b</span></span></span></span> are two operations in a single thread of execution, then <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mo>⇝</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">a \leadsto b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel amsrm">⇝</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">b</span></span></span></span> if operation <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi></mrow><annotation encoding="application/x-tex">a</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">a</span></span></span></span> happens before operation <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi></mrow><annotation encoding="application/x-tex">b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">b</span></span></span></span>.</li>
<li><strong>Gets From</strong>: If <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi></mrow><annotation encoding="application/x-tex">a</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">a</span></span></span></span> is a put operation and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi></mrow><annotation encoding="application/x-tex">b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">b</span></span></span></span> is a get operation that returns the value written by <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi></mrow><annotation encoding="application/x-tex">a</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">a</span></span></span></span>, then <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mo>⇝</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">a \leadsto b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel amsrm">⇝</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">b</span></span></span></span>.</li>
<li><strong>Transitivity</strong>: For operations <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi></mrow><annotation encoding="application/x-tex">a</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">a</span></span></span></span>, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi></mrow><annotation encoding="application/x-tex">b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">b</span></span></span></span>, and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi></mrow><annotation encoding="application/x-tex">c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">c</span></span></span></span>, if <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mo>⇝</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">a \leadsto b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel amsrm">⇝</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">b</span></span></span></span> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mo>⇝</mo><mi>c</mi></mrow><annotation encoding="application/x-tex">b \leadsto c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel amsrm">⇝</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">c</span></span></span></span>, then <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mo>⇝</mo><mi>c</mi></mrow><annotation encoding="application/x-tex">a \leadsto c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel amsrm">⇝</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">c</span></span></span></span>.</li>
</ul>
</li>
<li>Causal consistency requires that values returned from get operations at a replica are consistent with the order defined by <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>⇝</mo></mrow><annotation encoding="application/x-tex">\leadsto</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.37788em;vertical-align:0em;"></span><span class="mrel amsrm">⇝</span></span></span></span> (causality).
<ul>
<li>The operation that writes a value must appear after all operations that causally precede it.</li>
<li>If <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mo>⇝̸</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">a \not\leadsto b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel"><span class="mord vbox"><span class="thinbox"><span class="rlap"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="inner"><span class="mrel"></span></span><span class="fix"></span></span></span></span></span></span><span class="base"><span class="strut" style="height:0.37788em;vertical-align:0em;"></span><span class="mrel amsrm">⇝</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">b</span></span></span></span> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mo>⇝̸</mo><mi>a</mi></mrow><annotation encoding="application/x-tex">b \not\leadsto a</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel"><span class="mord vbox"><span class="thinbox"><span class="rlap"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="inner"><span class="mrel"></span></span><span class="fix"></span></span></span></span></span></span><span class="base"><span class="strut" style="height:0.37788em;vertical-align:0em;"></span><span class="mrel amsrm">⇝</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">a</span></span></span></span>, then <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi></mrow><annotation encoding="application/x-tex">a</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">a</span></span></span></span> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi></mrow><annotation encoding="application/x-tex">b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">b</span></span></span></span> are concurrent. Causal consistency does not order concurrent operations.</li>
</ul>
</li>
</ol>
<h3 id="how-to-handle-conflicts"><a class="markdownIt-Anchor" href="#how-to-handle-conflicts"></a> How to handle conflicts?</h3>
<ol>
<li>If <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi></mrow><annotation encoding="application/x-tex">a</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">a</span></span></span></span> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi></mrow><annotation encoding="application/x-tex">b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">b</span></span></span></span> are both put to the same key, then they are in conflict.
<ul>
<li>Conflicts are unordered by causal consistency and allow replicas to diverge forever.</li>
<li>Conflicts may represent an exceptional condition that requires special handling.</li>
</ul>
</li>
<li>Convergent conflict handling requires that all conflicting puts be handled in the same manner at all replicas, using a handler function <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi></mrow><annotation encoding="application/x-tex">h</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">h</span></span></span></span>.
<ul>
<li>This handler function <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi></mrow><annotation encoding="application/x-tex">h</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">h</span></span></span></span> must be <strong>associative</strong> and <strong>commutative</strong> so that replicas can handle conflicting writes in the order they receive them and that the results of these handlings will converge.
<ul>
<li>The last-writer-wins rule (Thomas’s write rule) is one of the conflicting writes that occurred later and was overwritten by the “earlier” write.</li>
<li>The default COPS system avoids conflict detection using a last-writer-wins strategy. The “last” write is determined by comparing version numbers.</li>
<li>Another way is to mark them as conflicting and require resolution through other means.</li>
</ul>
</li>
</ul>
</li>
<li>All potential forms of convergent conflict handling avoid the first issue by ensuring replicas reach the same result after exchanging operations.</li>
<li>The second conflict issue is only avoided using more explicit conflict resolution procedures.
<ul>
<li>These explicit procedures provide greater application flexibility but require additional programmer complexity and performance overhead.</li>
</ul>
</li>
</ol>
<h3 id="how-to-decide-which-write-is-the-last-write"><a class="markdownIt-Anchor" href="#how-to-decide-which-write-is-the-last-write"></a> How to decide which write is the last write?</h3>
<ol>
<li>It uses a last-write-win strategy. So the problem is how to decide which write is the last.</li>
<li>The decision is made by attaching each put’s current wall-clock time as the version number.
<ul>
<li>Local shard server assigns <code>version number (v#) = time</code> when it receives client <code>put()</code></li>
<li>Remote datacenter receives <code>put(k, -, v#)</code>
<ul>
<li>If <code>v#</code> is larger than the version of the currently stored value for k, it replaces the current value with a new value and updates <code>v#</code>.</li>
<li>Otherwise, it just ignores new values.</li>
</ul>
</li>
</ul>
</li>
<li>If two <code>put(k)</code> happen simultaneously at different datacenters, we can break the tie with a unique ID in the low bits of <code>v#</code>.</li>
<li>COPS uses Lamport clocks to assign <code>v#</code>
<ul>
<li>Each server implements a “Lamport clock” or “logical clock.”
<ul>
<li><code>Tmax = highest v# seen</code> (from self and others)</li>
<li><code>T = max(Tmax + 1, wall-clock time)</code></li>
</ul>
</li>
</ul>
</li>
<li>In the naive strategy, if one datacenter’s (or server’s) clock is fast by an hour, it will cause that datacenter’s values to win. In the worst case, it prevents any other update for an hour.
<ul>
<li>However, in  COPS, if some server has a fast clock, everyone who sees a version from that server will advance their Lamport clock.</li>
</ul>
</li>
</ol>
<h3 id="what-are-other-consistency-models"><a class="markdownIt-Anchor" href="#what-are-other-consistency-models"></a> What are other consistency models?</h3>
<ol>
<li>
<p>Linearizability (or strong consistency) maintains a global, real-time ordering.</p>
</li>
<li>
<p>Sequential consistency ensures at least a global ordering.</p>
</li>
<li>
<p>Causal consistency ensures partial orderings between dependent operations.</p>
</li>
<li>
<p>FIFO (PRAM) consistency only preserves the partial ordering of an execution thread, not between threads.</p>
</li>
<li>
<p>Per-key sequential consistency ensures that, for each key, all operations have a global order.</p>
</li>
<li>
<p>Eventual consistency is a “catch-all” term used today, suggesting eventual convergence with some agreement.</p>
</li>
<li>
<p>The strength of those models is as shown below:</p>
<img src="/imgs/Distributed/COPS/models.png" width="50%">
</li>
</ol>
<h3 id="how-is-causal-ensured-in-cops"><a class="markdownIt-Anchor" href="#how-is-causal-ensured-in-cops"></a> How is causal+ ensured in COPS?</h3>
<ol>
<li>
<p><strong>Progressing property</strong></p>
<ul>
<li>
<p>Different values a key has are referred to as the versions of a key, which are denoted <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi><mi>e</mi><msub><mi>y</mi><mrow><mi>v</mi><mi>e</mi><mi>r</mi><mi>s</mi><mi>i</mi><mi>o</mi><mi>n</mi></mrow></msub></mrow><annotation encoding="application/x-tex">key_{version}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord mathnormal">e</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>.</p>
</li>
<li>
<p>In COPS, versions are assigned in a manner that ensures that if <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mi>i</mi></msub><mo>⇝</mo><msub><mi>y</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">x_i \leadsto y_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel amsrm">⇝</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.716668em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span> then <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mo>&lt;</mo><mi>j</mi></mrow><annotation encoding="application/x-tex">i &lt; j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69862em;vertical-align:-0.0391em;"></span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.85396em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span>.</p>
</li>
<li>
<p>Once a replica in COPS returns the version <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.65952em;vertical-align:0em;"></span><span class="mord mathnormal">i</span></span></span></span> of a key, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">x_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>, causal+ consistency ensures it will then only return that version or a causally later version.</p>
</li>
<li>
<p>The handling of a conflict is causally later than the conflicting puts it resolves.</p>
<ul>
<li>
<p>Assume a replica first returns <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">x_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> and then <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mi>k</mi></msub></mrow><annotation encoding="application/x-tex">x_k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>, where <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mo mathvariant="normal">≠</mo><mi>k</mi></mrow><annotation encoding="application/x-tex">i \ne k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel"><span class="mrel"><span class="mord vbox"><span class="thinbox"><span class="rlap"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="inner"><span class="mrel"></span></span><span class="fix"></span></span></span></span></span><span class="mrel">=</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mi>i</mi></msub><mo>⇝̸</mo><msub><mi>x</mi><mi>k</mi></msub></mrow><annotation encoding="application/x-tex">x_i \not\leadsto x_k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel"><span class="mord vbox"><span class="thinbox"><span class="rlap"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="inner"><span class="mrel"></span></span><span class="fix"></span></span></span></span></span></span><span class="base"><span class="strut" style="height:0.37788em;vertical-align:0em;"></span><span class="mrel amsrm">⇝</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>.</p>
</li>
<li>
<p>Causal consistency ensures that if <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mi>k</mi></msub></mrow><annotation encoding="application/x-tex">x_k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> is returned after <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">x_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>, then <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mi>k</mi></msub><mo>⇝̸</mo><msub><mi>x</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">x_k \not\leadsto x_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel"><span class="mord vbox"><span class="thinbox"><span class="rlap"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="inner"><span class="mrel"></span></span><span class="fix"></span></span></span></span></span></span><span class="base"><span class="strut" style="height:0.37788em;vertical-align:0em;"></span><span class="mrel amsrm">⇝</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>, and so <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">x_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mi>k</mi></msub></mrow><annotation encoding="application/x-tex">x_k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> conflict.</p>
</li>
<li>
<p>But, if <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">x_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mi>k</mi></msub></mrow><annotation encoding="application/x-tex">x_k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> conflict, then convergent conflict handling ensures that as soon as both are present at a replica, their handling <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo separator="true">,</mo><msub><mi>x</mi><mi>k</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">h(x_i,x_k)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">h</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>, which is causally after both will be returned instead of either <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">x_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> or <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mi>k</mi></msub></mrow><annotation encoding="application/x-tex">x_k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>, which contradicts our assumption.</p>
</li>
</ul>
</li>
<li>
<p>Thus, each replica in COPS always returns non-decreasing versions of a key.</p>
</li>
</ul>
</li>
<li>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">y_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.716668em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span> depends on <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">x_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> if and only if <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mi>u</mi><mi>t</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo stretchy="false">)</mo><mo>⇝</mo><mi>p</mi><mi>u</mi><mi>t</mi><mo stretchy="false">(</mo><msub><mi>y</mi><mi>j</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">put(x_i) \leadsto put(y_j)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">p</span><span class="mord mathnormal">u</span><span class="mord mathnormal">t</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel amsrm">⇝</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mord mathnormal">p</span><span class="mord mathnormal">u</span><span class="mord mathnormal">t</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>.</p>
<ul>
<li>These dependencies are, in essence, the reverse of the causal ordering of writes.</li>
<li>COPS provides causal+ consistency during replication by writing a version only after writing all of its dependencies.</li>
</ul>
</li>
</ol>
<h3 id="why-previous-systems-cannot-provide-scalability"><a class="markdownIt-Anchor" href="#why-previous-systems-cannot-provide-scalability"></a> Why previous systems cannot provide scalability?</h3>
<ol>
<li>
<p>They all use a form of log serialization and exchange.</p>
<ul>
<li>
<p>All operations at a logical replica are written to a single log in serialized order, commonly marked with a version vector.</p>
</li>
<li>
<p>Log-exchange-based serialization inhibits replica scalability, as it relies on a single serialization point in each replica to establish order.</p>
</li>
<li>
<p>Either causal dependencies between keys are limited to the set of keys stored on one node, or a single node (or replicated state machine) must provide a commit ordering and log for all operations across a cluster.</p>
</li>
</ul>
</li>
<li>
<p>In COPS, nodes in each datacenter are responsible for different partitions of the keyspace, but the system can track and enforce dependencies between keys stored on other nodes.</p>
<ul>
<li>COPS explicitly encodes dependencies in metadata associated with each key’s version.</li>
<li>When keys are replicated remotely, the receiving datacenter performs dependency checks before committing the incoming version.</li>
</ul>
</li>
</ol>
<h2 id="cops-system"><a class="markdownIt-Anchor" href="#cops-system"></a> COPS system</h2>
<h3 id="what-are-the-components-of-cops"><a class="markdownIt-Anchor" href="#what-are-the-components-of-cops"></a> What are the components of COPS?</h3>
<ol>
<li>Key-value store
<ul>
<li>Each key-value pair has associated metadata.
<ul>
<li>In COPS, this metadata is a version number.</li>
<li>In COPS-GT, it is both a version number and a list of dependencies (other keys and their respective versions).</li>
</ul>
</li>
<li>The key-value store exports three additional operations as part of its key-value interface: <code>get_by_version</code>, <code>put_after</code>, and <code>dep_check</code>.</li>
<li>For COPS-GT, the system keeps around old versions of key-value pairs, not just the most recent put, to ensure that it can provide get transactions.</li>
</ul>
</li>
<li>Client library
<ul>
<li>The client library exports two main operations to applications: reads via <code>get</code> (in COPS) or <code>get_trans</code> (in COPS-GT) and writes via <code>put</code>.</li>
<li>The client library also maintains a state of a client’s current dependencies through a <code>context</code> parameter in the client library API.</li>
</ul>
</li>
<li>A client of COPS is an application that uses the COPS client library to call directly into the COPS key-value store.</li>
<li>Clients communicate only with their local COPS cluster running in the same datacenter.</li>
</ol>
<h3 id="what-consistency-is-achieved-in-cops"><a class="markdownIt-Anchor" href="#what-consistency-is-achieved-in-cops"></a> What consistency is achieved in COPS?</h3>
<ol>
<li>Each local COPS cluster is a linearizable (strongly consistent) key-value store.
<ul>
<li>Linearizable systems can be implemented scalably by partitioning the keyspace into N linearizable partitions.</li>
<li>The composability of linearizability ensures that the resulting system remains linearizable.</li>
<li>Linearizability is acceptable locally because we expect very low latency and no partitions within a cluster.</li>
</ul>
</li>
<li>Replication between COPS clusters happens asynchronously to ensure low latency for client operations and availability in the face of external partitions.</li>
<li>The COPS design strives to provide causal+ consistency with resource and performance overhead similar to existing eventual consistent systems.
<ul>
<li>COPS and COPS-GT need to minimize the overhead of consistency-preserving replication
<ul>
<li>A naive implementation, however, would require checks on all of a value’s dependencies.</li>
</ul>
</li>
<li>COPS-GT needs to minimize space requirements</li>
<li>COPS-GT needs to ensure fast <code>get_trans</code> operations
<ul>
<li>A naive algorithm could block and take an unbounded number of get rounds to complete.</li>
</ul>
</li>
</ul>
</li>
</ol>
<h3 id="key-value-store"><a class="markdownIt-Anchor" href="#key-value-store"></a> Key-value store</h3>
<h4 id="what-is-stored-in-cops-storage"><a class="markdownIt-Anchor" href="#what-is-stored-in-cops-storage"></a> What is stored in COPS storage?</h4>
<ol>
<li>COPS must track the versions of written values and their dependencies in the case of COPS-GT.</li>
<li>In COPS, the system stores each key’s most recent version number and value.</li>
<li>In COPS-GT, the system maps each key to a list of version entries consisting of <code>&lt;version, value, deps&gt;</code>.
<ul>
<li>The <code>deps</code> field lists the version’s zero or more dependencies; each dependency is a <code>&lt;key, version&gt;</code> pair.</li>
</ul>
</li>
</ol>
<h4 id="how-does-cops-support-scalability-in-kv-storage"><a class="markdownIt-Anchor" href="#how-does-cops-support-scalability-in-kv-storage"></a> How does COPS support scalability in KV-storage?</h4>
<ol>
<li>It partitions the keyspace across a cluster’s nodes using consistent hashing.</li>
<li>Every key stored in COPS has one primary node in each cluster.
<ul>
<li>The set of primary nodes for a key across all clusters is the <strong>equivalent nodes</strong> for that key.</li>
<li>After a write completes locally, the primary node places it in a replication queue, sending it asynchronously to remote equivalent nodes.</li>
<li>Those nodes, in turn, wait until the value’s dependencies are satisfied in their local cluster before locally committing the value.</li>
<li>This dependency-checking mechanism ensures that writes happen in a causally consistent order and reads never block.</li>
</ul>
</li>
<li>In practice, COPS’s consistent hashing assigns each node responsibility for a few different key ranges.
<ul>
<li>Key ranges may have different sizes and node mappings in different datacenters.</li>
<li>The number of equivalent nodes with which a given node must communicate is proportional to the number of datacenters (i.e., communication is not all-to-all between nodes in different datacenters).</li>
</ul>
</li>
</ol>
<h3 id="client-library"><a class="markdownIt-Anchor" href="#client-library"></a> Client library</h3>
<h4 id="what-is-provided-in-the-client-api"><a class="markdownIt-Anchor" href="#what-is-provided-in-the-client-api"></a> What is provided in the client API?</h4>
<ol>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mi>t</mi><mi>x</mi><mi mathvariant="normal">_</mi><mi>i</mi><mi>d</mi><mo>←</mo><mi>c</mi><mi>r</mi><mi>e</mi><mi>a</mi><mi>t</mi><mi>e</mi><mi>C</mi><mi>o</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>x</mi><mi>t</mi><mo stretchy="false">(</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">ctx\_id\leftarrow createContext()</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.00444em;vertical-align:-0.31em;"></span><span class="mord mathnormal">c</span><span class="mord mathnormal">t</span><span class="mord mathnormal">x</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">i</span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">←</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">c</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">e</span><span class="mord mathnormal">a</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal">x</span><span class="mord mathnormal">t</span><span class="mopen">(</span><span class="mclose">)</span></span></span></span></li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mi>o</mi><mi>o</mi><mi>l</mi><mo>←</mo><mi>d</mi><mi>e</mi><mi>l</mi><mi>e</mi><mi>t</mi><mi>e</mi><mi>C</mi><mi>o</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>x</mi><mi>t</mi><mo stretchy="false">(</mo><mi>c</mi><mi>t</mi><mi>x</mi><mi mathvariant="normal">_</mi><mi>i</mi><mi>d</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">bool\leftarrow deleteContext(ctx\_id)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">b</span><span class="mord mathnormal">o</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">←</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.06em;vertical-align:-0.31em;"></span><span class="mord mathnormal">d</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal">x</span><span class="mord mathnormal">t</span><span class="mopen">(</span><span class="mord mathnormal">c</span><span class="mord mathnormal">t</span><span class="mord mathnormal">x</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">i</span><span class="mord mathnormal">d</span><span class="mclose">)</span></span></span></span></li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mi>o</mi><mi>o</mi><mi>l</mi><mo>←</mo><mi>p</mi><mi>u</mi><mi>t</mi><mo stretchy="false">(</mo><mi>k</mi><mi>e</mi><mi>y</mi><mo separator="true">,</mo><mi>v</mi><mi>a</mi><mi>l</mi><mi>u</mi><mi>e</mi><mo separator="true">,</mo><mi>c</mi><mi>t</mi><mi>x</mi><mi mathvariant="normal">_</mi><mi>i</mi><mi>d</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">bool\leftarrow put(key,value,ctx\_id)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">b</span><span class="mord mathnormal">o</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">←</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.06em;vertical-align:-0.31em;"></span><span class="mord mathnormal">p</span><span class="mord mathnormal">u</span><span class="mord mathnormal">t</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">u</span><span class="mord mathnormal">e</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">c</span><span class="mord mathnormal">t</span><span class="mord mathnormal">x</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">i</span><span class="mord mathnormal">d</span><span class="mclose">)</span></span></span></span></li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>v</mi><mi>a</mi><mi>l</mi><mi>u</mi><mi>e</mi><mo>←</mo><mi>g</mi><mi>e</mi><mi>t</mi><mo stretchy="false">(</mo><mi>k</mi><mi>e</mi><mi>y</mi><mo separator="true">,</mo><mi>c</mi><mi>t</mi><mi>x</mi><mi mathvariant="normal">_</mi><mi>i</mi><mi>d</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">value\leftarrow get(key,ctx\_id)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">u</span><span class="mord mathnormal">e</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">←</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.06em;vertical-align:-0.31em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal">e</span><span class="mord mathnormal">t</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">c</span><span class="mord mathnormal">t</span><span class="mord mathnormal">x</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">i</span><span class="mord mathnormal">d</span><span class="mclose">)</span></span></span></span> for COPS, or <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">⟨</mo><mi>v</mi><mi>a</mi><mi>l</mi><mi>u</mi><mi>e</mi><mi>s</mi><mo stretchy="false">⟩</mo><mo>←</mo><mi>g</mi><mi>e</mi><mi>t</mi><mi mathvariant="normal">_</mi><mi>t</mi><mi>r</mi><mi>a</mi><mi>n</mi><mi>s</mi><mo stretchy="false">(</mo><mo stretchy="false">⟨</mo><mi>k</mi><mi>e</mi><mi>y</mi><mi>s</mi><mo stretchy="false">⟩</mo><mo separator="true">,</mo><mi>c</mi><mi>t</mi><mi>x</mi><mi mathvariant="normal">_</mi><mi>i</mi><mi>d</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\langle values\rangle\leftarrow get\_trans(\langle keys\rangle,ctx\_id)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">⟨</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">u</span><span class="mord mathnormal">e</span><span class="mord mathnormal">s</span><span class="mclose">⟩</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">←</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.06em;vertical-align:-0.31em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal">e</span><span class="mord mathnormal">t</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">a</span><span class="mord mathnormal">n</span><span class="mord mathnormal">s</span><span class="mopen">(</span><span class="mopen">⟨</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mord mathnormal">s</span><span class="mclose">⟩</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">c</span><span class="mord mathnormal">t</span><span class="mord mathnormal">x</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">i</span><span class="mord mathnormal">d</span><span class="mclose">)</span></span></span></span> for COPS-GT
<ul>
<li>COPS-GT provides <code>get_trans</code>, which returns a consistent view of multiple key-value pairs in a single call.</li>
</ul>
</li>
</ol>
<h4 id="what-is-the-context-in-the-library"><a class="markdownIt-Anchor" href="#what-is-the-context-in-the-library"></a> What is the context in the library?</h4>
<ol>
<li>All functions take a context argument, which the library uses internally to track causal dependencies across each client’s operations.</li>
<li>The context defines the causal+ “thread of execution.” A single process may contain many separate threads of execution.</li>
<li>By separating different threads of execution, COPS avoids false dependencies that would result from intermixing them.</li>
</ol>
<h4 id="what-does-cops-gt-store-in-context"><a class="markdownIt-Anchor" href="#what-does-cops-gt-store-in-context"></a> What does COPS-GT store in context?</h4>
<ol>
<li>
<p>The client library in COPS-GT stores the client’s context in a table of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">⟨</mo><mi>k</mi><mi>e</mi><mi>y</mi><mo separator="true">,</mo><mi>v</mi><mi>e</mi><mi>r</mi><mi>s</mi><mi>i</mi><mi>o</mi><mi>n</mi><mo separator="true">,</mo><mi>d</mi><mi>e</mi><mi>p</mi><mi>s</mi><mo stretchy="false">⟩</mo></mrow><annotation encoding="application/x-tex">\langle key, version, deps\rangle</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">⟨</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">d</span><span class="mord mathnormal">e</span><span class="mord mathnormal">p</span><span class="mord mathnormal">s</span><span class="mclose">⟩</span></span></span></span> entries.</p>
<ul>
<li>Clients reference their context using a context ID (<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mi>t</mi><mi>x</mi><mi mathvariant="normal">_</mi><mi>i</mi><mi>d</mi></mrow><annotation encoding="application/x-tex">ctx\_id</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.00444em;vertical-align:-0.31em;"></span><span class="mord mathnormal">c</span><span class="mord mathnormal">t</span><span class="mord mathnormal">x</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">i</span><span class="mord mathnormal">d</span></span></span></span>) in the API.</li>
</ul>
</li>
<li>
<p>When a client gets a key from the data store, the library adds it and its causal dependencies to the context.</p>
</li>
<li>
<p>When a client puts a value, the library sets the put’s dependencies to the most recent version of each key in the current context.</p>
<ul>
<li>A successful put into the data store returns the version number v assigned to the written value.</li>
<li>The client library then adds this new entry, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">⟨</mo><mi>k</mi><mi>e</mi><mi>y</mi><mo separator="true">,</mo><mi>v</mi><mo separator="true">,</mo><mi>D</mi><mo stretchy="false">⟩</mo></mrow><annotation encoding="application/x-tex">\langle key, v, D\rangle</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">⟨</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mclose">⟩</span></span></span></span>, to the context.</li>
</ul>
</li>
</ol>
<h4 id="what-are-the-concerns-of-the-cops-gt-context"><a class="markdownIt-Anchor" href="#what-are-the-concerns-of-the-cops-gt-context"></a> What are the concerns of the COPS-GT context?</h4>
<ol>
<li>The context, therefore, includes all values previously read or written in the client’s session and all of those dependencies.</li>
<li>State requirements for storing these dependencies in the client library and the data store.
<ul>
<li>COPS-GT provides garbage collection to mitigate the client and data-store state required to track dependencies.</li>
</ul>
</li>
<li>Several potential checks must be performed to ensure causal consistency when replicating writes between clusters.
<ul>
<li>The dependencies that must be checked are termed the nearest dependencies.
<ul>
<li>If the storage node commits a node, determining its direct dependencies are committed, it can infer that all former dependencies are also committed.</li>
<li>Hence, each dependency check only needs to check nodes within <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span> step in the graph of causal dependencies.</li>
</ul>
</li>
<li>The nearest dependencies are sufficient for the key-value store to provide causal+ consistency.</li>
<li>The full dependency list is only needed to provide <code>get_trans</code> operations in COPS-GT.</li>
</ul>
</li>
</ol>
<h4 id="what-does-cops-store-in-context"><a class="markdownIt-Anchor" href="#what-does-cops-store-in-context"></a> What does COPS store in context?</h4>
<ol>
<li>It does not store or even retrieve the dependencies of any value it gets
<ul>
<li>The retrieved value is nearer than any of its dependencies, rendering them unnecessary.</li>
<li>The COPS client library stores only <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">⟨</mo><mi>k</mi><mi>e</mi><mi>y</mi><mo separator="true">,</mo><mi>v</mi><mi>e</mi><mi>r</mi><mi>s</mi><mi>i</mi><mi>o</mi><mi>n</mi><mo stretchy="false">⟩</mo></mrow><annotation encoding="application/x-tex">\langle key, version\rangle</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">⟨</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mclose">⟩</span></span></span></span> entries.</li>
</ul>
</li>
<li>For a get operation, the retrieved <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">⟨</mo><mi>k</mi><mi>e</mi><mi>y</mi><mo separator="true">,</mo><mi>v</mi><mi>e</mi><mi>r</mi><mi>s</mi><mi>i</mi><mi>o</mi><mi>n</mi><mo stretchy="false">⟩</mo></mrow><annotation encoding="application/x-tex">\langle key, version\rangle</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">⟨</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mclose">⟩</span></span></span></span> is added to the context.</li>
<li>For a put operation, the library uses the current context as the nearest dependencies, clears the context, and then repopulates it with only this put.
<ul>
<li>This put depends on all previous key-version pairs and thus is nearer than them.</li>
</ul>
</li>
</ol>
<h4 id="how-does-cops-or-cops-gt-write-to-the-local-cluster"><a class="markdownIt-Anchor" href="#how-does-cops-or-cops-gt-write-to-the-local-cluster"></a> How does COPS (or COPS-GT) write to the local cluster?</h4>
<ol>
<li>All writes in COPS first go to the client’s local cluster and then propagate asynchronously to remote clusters.</li>
<li>The key-value store exports a single API call to provide both operations: <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">⟨</mo><mi>b</mi><mi>o</mi><mi>o</mi><mi>l</mi><mo separator="true">,</mo><mi>v</mi><mi>e</mi><mi>r</mi><mi>s</mi><mo stretchy="false">⟩</mo><mo>←</mo><mi>p</mi><mi>u</mi><mi>t</mi><mi mathvariant="normal">_</mi><mi>a</mi><mi>f</mi><mi>t</mi><mi>e</mi><mi>r</mi><mo stretchy="false">(</mo><mi>k</mi><mi>e</mi><mi>y</mi><mo separator="true">,</mo><mi>v</mi><mi>a</mi><mi>l</mi><mo separator="true">,</mo><mo stretchy="false">[</mo><mi>d</mi><mi>e</mi><mi>p</mi><mi>s</mi><mo stretchy="false">]</mo><mo separator="true">,</mo><mi>n</mi><mi>e</mi><mi>a</mi><mi>r</mi><mi>e</mi><mi>s</mi><mi>t</mi><mo separator="true">,</mo><mi>v</mi><mi>e</mi><mi>r</mi><mi>s</mi><mo>=</mo><mi mathvariant="normal">∅</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\langle bool,vers\rangle \leftarrow put\_after(key,val,[deps],nearest,vers=\empty)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">⟨</span><span class="mord mathnormal">b</span><span class="mord mathnormal">o</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">s</span><span class="mclose">⟩</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">←</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.06em;vertical-align:-0.31em;"></span><span class="mord mathnormal">p</span><span class="mord mathnormal">u</span><span class="mord mathnormal">t</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">[</span><span class="mord mathnormal">d</span><span class="mord mathnormal">e</span><span class="mord mathnormal">p</span><span class="mord mathnormal">s</span><span class="mclose">]</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">n</span><span class="mord mathnormal">e</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">e</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">s</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">∅</span><span class="mclose">)</span></span></span></span></li>
<li>When a client calls <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mi>u</mi><mi>t</mi><mo stretchy="false">(</mo><mi>k</mi><mi>e</mi><mi>y</mi><mo separator="true">,</mo><mi>v</mi><mi>a</mi><mi>l</mi><mo separator="true">,</mo><mi>c</mi><mi>t</mi><mi>x</mi><mi mathvariant="normal">_</mi><mi>i</mi><mi>d</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">put (key,val,ctx\_id)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.06em;vertical-align:-0.31em;"></span><span class="mord mathnormal">p</span><span class="mord mathnormal">u</span><span class="mord mathnormal">t</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">c</span><span class="mord mathnormal">t</span><span class="mord mathnormal">x</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">i</span><span class="mord mathnormal">d</span><span class="mclose">)</span></span></span></span>,
<ul>
<li>The library computes the complete set of dependencies <code>deps</code> and identifies some of those dependency tuples as the value’s nearest ones.</li>
<li>The library then calls put after without the version argument (i.e., it sets <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>v</mi><mi>e</mi><mi>r</mi><mi>s</mi><mi>i</mi><mi>o</mi><mi>n</mi><mo>=</mo><mi mathvariant="normal">∅</mi></mrow><annotation encoding="application/x-tex">version=\empty</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.65952em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.80556em;vertical-align:-0.05556em;"></span><span class="mord">∅</span></span></span></span>).</li>
<li>The library includes <code>deps</code> in the put_after call in COPS-GT because dependencies must be stored with the value.</li>
<li>In COPS, the library only needs to include the nearest and does not include <code>deps</code>.</li>
</ul>
</li>
<li>The key’s primary storage node in the local cluster assigns the key a version number and returns it to the client library.</li>
<li>Each client is restricted to a single outstanding put; this is necessary because later puts must know the version numbers of earlier puts so that they may depend on them.</li>
<li>The put-after operation ensures that val is committed to each cluster only after all of the entries in its dependency list have been written.
<ul>
<li>This property is automatically held in the client’s local cluster, as the local store provides linearizability.</li>
<li>If <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi></mrow><annotation encoding="application/x-tex">y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span></span></span> depends on <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">x</span></span></span></span>, then <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mi>u</mi><mi>t</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">put(x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">p</span><span class="mord mathnormal">u</span><span class="mord mathnormal">t</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span> must have been committed before <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mi>u</mi><mi>t</mi><mo stretchy="false">(</mo><mi>y</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">put(y)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">p</span><span class="mord mathnormal">u</span><span class="mord mathnormal">t</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mclose">)</span></span></span></span> was issued.</li>
</ul>
</li>
</ol>
<h4 id="how-to-replica-writes-between-clusters"><a class="markdownIt-Anchor" href="#how-to-replica-writes-between-clusters"></a> How to replica writes between clusters?</h4>
<ol>
<li>After a write commits locally, the primary storage node asynchronously replicates that writes to its equivalent nodes in different clusters using a stream of <code>put_after</code> operations.
<ul>
<li>The primary node includes the key’s version number in the put-after the call.</li>
<li>The <code>deps</code> argument is included in COPS-GT and not included in COPS.</li>
</ul>
</li>
<li>It requires the remote nodes receiving updates to commit an update only after its dependencies have been committed to the same cluster.
<ul>
<li>A node that receives a put-after a request from another cluster must determine if the value’s nearest dependencies have already been satisfied locally.</li>
<li>It does so by issuing a check to the local nodes responsible for those dependencies: <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mi>o</mi><mi>o</mi><mi>l</mi><mo>←</mo><mi>d</mi><mi>e</mi><mi>p</mi><mi mathvariant="normal">_</mi><mi>c</mi><mi>h</mi><mi>e</mi><mi>c</mi><mi>k</mi><mo stretchy="false">(</mo><mi>k</mi><mi>e</mi><mi>y</mi><mo separator="true">,</mo><mi>v</mi><mi>e</mi><mi>r</mi><mi>s</mi><mi>i</mi><mi>o</mi><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">bool\leftarrow dep\_check(key, version)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">b</span><span class="mord mathnormal">o</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">←</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.06em;vertical-align:-0.31em;"></span><span class="mord mathnormal">d</span><span class="mord mathnormal">e</span><span class="mord mathnormal">p</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">c</span><span class="mord mathnormal">h</span><span class="mord mathnormal">e</span><span class="mord mathnormal">c</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span></li>
<li>The way that nearest dependencies are computed ensures that all dependencies have been satisfied before the value is committed, ensuring causal consistency.</li>
</ul>
</li>
</ol>
<h4 id="how-to-read-values-in-cops"><a class="markdownIt-Anchor" href="#how-to-read-values-in-cops"></a> How to read values in COPS?</h4>
<ol>
<li>Reads are satisfied in the local cluster.</li>
<li>The library issues a read to the node responsible for the key in the local cluster: <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">⟨</mo><mi>v</mi><mi>a</mi><mi>l</mi><mi>u</mi><mi>e</mi><mo separator="true">,</mo><mi>v</mi><mi>e</mi><mi>r</mi><mi>s</mi><mi>i</mi><mi>o</mi><mi>n</mi><mo separator="true">,</mo><mi>d</mi><mi>e</mi><mi>p</mi><mi>s</mi><mo stretchy="false">⟩</mo><mo>←</mo><mi>g</mi><mi>e</mi><mi>t</mi><mi mathvariant="normal">_</mi><mi>b</mi><mi>y</mi><mi mathvariant="normal">_</mi><mi>v</mi><mi>e</mi><mi>r</mi><mi>s</mi><mi>i</mi><mi>o</mi><mi>n</mi><mo stretchy="false">(</mo><mi>k</mi><mi>e</mi><mi>y</mi><mo separator="true">,</mo><mi>v</mi><mi>e</mi><mi>r</mi><mi>s</mi><mi>i</mi><mi>o</mi><mi>n</mi><mo>=</mo><mi>L</mi><mi>A</mi><mi>T</mi><mi>E</mi><mi>S</mi><mi>T</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\langle value, version,deps\rangle\leftarrow get\_by\_version(key,version=LATEST)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">⟨</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">u</span><span class="mord mathnormal">e</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">d</span><span class="mord mathnormal">e</span><span class="mord mathnormal">p</span><span class="mord mathnormal">s</span><span class="mclose">⟩</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">←</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.06em;vertical-align:-0.31em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal">e</span><span class="mord mathnormal">t</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">b</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">L</span><span class="mord mathnormal">A</span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mclose">)</span></span></span></span></li>
<li>This read can request either the latest version of the key or a specific older one. Requesting a particular version is necessary to enable get transactions.</li>
<li>Upon receiving a response, the client library adds the <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">⟨</mo><mi>k</mi><mi>e</mi><mi>y</mi><mo separator="true">,</mo><mi>v</mi><mi>e</mi><mi>r</mi><mi>s</mi><mi>i</mi><mi>o</mi><mi>n</mi><mo separator="true">,</mo><mo stretchy="false">[</mo><mi>d</mi><mi>e</mi><mi>p</mi><mi>s</mi><mo stretchy="false">]</mo><mo stretchy="false">⟩</mo></mrow><annotation encoding="application/x-tex">\langle key,version,[deps]\rangle</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">⟨</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">[</span><span class="mord mathnormal">d</span><span class="mord mathnormal">e</span><span class="mord mathnormal">p</span><span class="mord mathnormal">s</span><span class="mclose">]</span><span class="mclose">⟩</span></span></span></span> tuple to the client context and returns value to the calling code.</li>
<li>The <code>deps</code> are stored only in COPS-GT, not in COPS.</li>
</ol>
<h4 id="why-does-cops-gt-need-to-provide-get_trans-what-is-wrong-with-the-get-interface"><a class="markdownIt-Anchor" href="#why-does-cops-gt-need-to-provide-get_trans-what-is-wrong-with-the-get-interface"></a> Why does COPS-GT need to provide get_trans? What is wrong with the get interface?</h4>
<ol>
<li>Reading a set of dependent keys using a single-key get interface cannot ensure causal+ consistency, even though the data store itself is causal+ consistent.</li>
<li>It may have a “time-to-check-to-time-to-use” race condition, i.e., check operation and usage is not an atomic operation.</li>
<li>The standard way to achieve such a guarantee is to read and write all related keys in a transaction.
<ul>
<li>This requires a single serialization point for all grouped keys, which COPS avoids for greater scalability and simplicity.</li>
</ul>
</li>
</ol>
<h4 id="how-does-get_trans-work"><a class="markdownIt-Anchor" href="#how-does-get_trans-work"></a> How does get_trans work?</h4>
<ol>
<li>
<p>To retrieve multiple values in a causal+ consistent manner, client calls get trans with the desired set of keys.</p>
</li>
<li>
<p>In the first round, the library issues <code>n</code> concurrent <code>get_by_version</code> operations to the local cluster, one for each key the client listed in <code>get_trans</code>.</p>
<ul>
<li>
<p>Because COPS-GT commits writes locally, the local data store guarantees that these explicitly listed keys’ dependencies are satisfied.</p>
</li>
<li>
<p>All listed keys have been written locally, and their reads will immediately be returned.</p>
</li>
<li>
<p>Each <code>get_by_version</code> operation returns a <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">⟨</mo><mi>v</mi><mi>a</mi><mi>l</mi><mi>u</mi><mi>e</mi><mo separator="true">,</mo><mi>v</mi><mi>e</mi><mi>r</mi><mi>s</mi><mi>i</mi><mi>o</mi><mi>n</mi><mo separator="true">,</mo><mi>d</mi><mi>e</mi><mi>p</mi><mi>s</mi><mo stretchy="false">⟩</mo></mrow><annotation encoding="application/x-tex">\langle value, version, deps\rangle</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">⟨</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">u</span><span class="mord mathnormal">e</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">d</span><span class="mord mathnormal">e</span><span class="mord mathnormal">p</span><span class="mord mathnormal">s</span><span class="mclose">⟩</span></span></span></span> tuple, where <code>deps</code> is a list of keys and versions.</p>
</li>
</ul>
</li>
<li>
<p>The client library then examines every dependency entry <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">⟨</mo><mi>k</mi><mi>e</mi><mi>y</mi><mo separator="true">,</mo><mi>v</mi><mi>e</mi><mi>r</mi><mi>s</mi><mi>i</mi><mi>o</mi><mi>n</mi><mo stretchy="false">⟩</mo></mrow><annotation encoding="application/x-tex">\langle key, version\rangle</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">⟨</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mclose">⟩</span></span></span></span>.</p>
<ul>
<li>The causal dependencies for that result are satisfied if either the client did not request the dependent key or it did, the version it retrieved was <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>≥</mo></mrow><annotation encoding="application/x-tex">≥</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7719400000000001em;vertical-align:-0.13597em;"></span><span class="mrel">≥</span></span></span></span> the version in the dependency list.</li>
</ul>
</li>
<li>
<p>For all keys that are not satisfied, the library issues a second round of concurrent get by version operations.</p>
<ul>
<li>The version requested will be the newest version seen in any dependency list from the first round.</li>
<li>These versions satisfy all causal dependencies from the first round because they are <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>≥</mo></mrow><annotation encoding="application/x-tex">≥</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7719400000000001em;vertical-align:-0.13597em;"></span><span class="mrel">≥</span></span></span></span> the needed versions.</li>
<li>Because dependencies are transitive and these second-round versions depend on versions retrieved in the first round, they do not introduce any new dependencies that must be satisfied.</li>
</ul>
</li>
<li>
<p>The second round happens only when the client must read newer versions than those retrieved in the first round.</p>
<ul>
<li>This case occurs only if keys involved in the get transaction are updated during the first round.</li>
</ul>
</li>
</ol>
<h3 id="garbage-collection"><a class="markdownIt-Anchor" href="#garbage-collection"></a> Garbage collection</h3>
<h4 id="how-does-cops-gt-collect-version-garbage"><a class="markdownIt-Anchor" href="#how-does-cops-gt-collect-version-garbage"></a> How does COPS-GT collect version garbage?</h4>
<ol>
<li>The <code>get_trans</code> algorithm limits the number of versions needed to complete a get transaction.
<ul>
<li>COPS-GT limits the total running time of get trans through a configurable parameter, <code>trans_time</code>.</li>
<li>If the timeout fires, the client library will restart the get trans call and satisfy the transaction with newer versions of the keys.</li>
</ul>
</li>
<li>After a new version of a key is written, COPS-GT only needs to keep the old version around for <code>trans_time</code> plus a small delta for clock skew.</li>
<li>The space overhead is bounded by the number of old versions created within the <code>trans_time</code>.
<ul>
<li>This number is determined by the maximum write throughput that the node can sustain.</li>
<li>This overhead is per-machine and does not grow with the cluster size or the number of datacenters.</li>
</ul>
</li>
</ol>
<h4 id="how-does-cops-gt-collect-dependency-garbage"><a class="markdownIt-Anchor" href="#how-does-cops-gt-collect-dependency-garbage"></a> How does COPS-GT collect dependency garbage?</h4>
<ol>
<li>COPS-GT can garbage collect these dependencies once the versions associated with old dependencies are no longer needed for correctness in get transaction operations.</li>
<li>After <code>trans_time</code> seconds after a value has been committed in all datacenters, COPS-GT can clean a value’s dependencies.
<ul>
<li>To clean dependencies, each remote datacenter notifies the originating datacenter when the write has been committed and the timeout period has elapsed.</li>
<li>Once all datacenters have confirmed, the originating datacenter cleans its dependencies and informs the others to do likewise.</li>
</ul>
</li>
<li>To minimize bandwidth devoted to cleaning dependencies, a replica only notifies the originating datacenter if this version of a key is the newest after <code>trans_time</code> seconds
<ul>
<li>If it is not, there is no need to collect the dependencies because the entire version will be collected.</li>
</ul>
</li>
<li>Under regular operation, dependencies are garbage collected after <code>trans_time</code> plus a round-trip time.</li>
<li>During a partition, dependencies on the most recent versions of keys cannot be collected.</li>
</ol>
<h4 id="how-does-cops-collect-client-metadata-garbage"><a class="markdownIt-Anchor" href="#how-does-cops-collect-client-metadata-garbage"></a> How does COPS collect client metadata garbage?</h4>
<ol>
<li>The COPS client library tracks all operations during a client session (single thread of execution) using the <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mi>t</mi><mi>x</mi><mi mathvariant="normal">_</mi><mi>i</mi><mi>d</mi></mrow><annotation encoding="application/x-tex">ctx\_id</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.00444em;vertical-align:-0.31em;"></span><span class="mord mathnormal">c</span><span class="mord mathnormal">t</span><span class="mord mathnormal">x</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">i</span><span class="mord mathnormal">d</span></span></span></span> passed with all operations.
<ul>
<li>In both systems, each get since the last put adds another nearest dependency.</li>
<li>Additionally, in COPS-GT, all new values and their dependencies are returned in get trans operations, and all put operations add normal dependencies.</li>
</ul>
</li>
<li>Clients need to track dependencies only until they are guaranteed to be satisfied everywhere.</li>
<li>Once a <code>put_after</code> commits successfully to all datacenters, COPS flags that key version as <em>never-depend</em> to indicate that clients need not express a dependence upon it.
<ul>
<li>The client library will immediately remove a never-depend item from the list of dependencies in the client context.</li>
<li>Anything that a never-depend key depended on must have been flagged never-depend, so it too can be garbage collected from the context.</li>
</ul>
</li>
<li>The COPS storage nodes remove unnecessary dependencies from <code>put_after</code> operations.
<ul>
<li>When a node receives a <code>put_after</code>, it checks each item in the dependency list and removes items with version numbers older than a global checkpoint time.</li>
</ul>
</li>
</ol>
<h3 id="fault-tolerance"><a class="markdownIt-Anchor" href="#fault-tolerance"></a> Fault tolerance</h3>
<h4 id="how-does-cops-handle-client-failures"><a class="markdownIt-Anchor" href="#how-does-cops-handle-client-failures"></a> How does COPS handle client failures?</h4>
<ol>
<li>From the storage system’s perspective, if a client fails, it simply stops issuing new requests; no recovery is necessary.</li>
<li>From a client’s perspective, COPS’s dependency tracking makes it easier to handle failures of other clients by ensuring properties such as referential integrity.</li>
</ol>
<h4 id="how-does-cops-handle-key-value-node-failures"><a class="markdownIt-Anchor" href="#how-does-cops-handle-key-value-node-failures"></a> How does COPS handle key-value node failures?</h4>
<ol>
<li>
<p>COPS can use any underlying fault-tolerant linearizable key-value store.</p>
<ul>
<li>The author uses chain replication within a cluster to mask node failures.</li>
</ul>
</li>
<li>
<p>Dependency garbage collection follows a similar pattern of interlocking chains.</p>
<p>Version garbage is collected locally on each node and can operate as in the single-node case.</p>
<p>The global checkpoint time calculation for client metadata garbage collection operates normally, with each tail updating its corresponding key range minimums.</p>
</li>
</ol>
<h4 id="what-will-happen-when-the-datacenter-fails"><a class="markdownIt-Anchor" href="#what-will-happen-when-the-datacenter-fails"></a> What will happen when the datacenter fails?</h4>
<ol>
<li>Any put-after operations that originated in the failed datacenter but were not yet copied out will be lost.</li>
<li>The storage required for replication queues in the active datacenters will grow.
<ul>
<li>They will be unable to send put-after operations to the failed datacenter, and thus, COPS will be unable to garbage collect those dependencies.</li>
<li>Solutions: Allow the queues to grow if the partition is likely to heal soon, or reconfigure COPS to no longer use the failed datacenter.</li>
</ul>
</li>
</ol>
<h4 id="how-does-cops-with-conflict-detection-cops-cd-detect-conflict"><a class="markdownIt-Anchor" href="#how-does-cops-with-conflict-detection-cops-cd-detect-conflict"></a> How does COPS with conflict detection (COPS-CD) detect conflict?</h4>
<ol>
<li>All put operations carry with them previous version metadata.
<ul>
<li>It indicates the most recent previous version of the key that was visible at the local cluster at the time of the write.</li>
</ul>
</li>
<li>All put operations now have an implicit dependency on the previous version.
<ul>
<li>This ensures that a new version will only be written after its previous version.</li>
</ul>
</li>
<li>COPS-CD has an applicationspecified convergent conflict handler invoked when a conflict is detected.
<ul>
<li>A put operation <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mi>e</mi><mi>w</mi></mrow><annotation encoding="application/x-tex">new</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">n</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span></span></span></span> to a key (with the previous version <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mi>r</mi><mi>e</mi><mi>v</mi></mrow><annotation encoding="application/x-tex">prev</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">p</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span></span></span></span>) conflicts with the key’s current visible version <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mi>u</mi><mi>r</mi><mi>r</mi></mrow><annotation encoding="application/x-tex">curr</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">c</span><span class="mord mathnormal">u</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span></span>: <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mi>r</mi><mi>e</mi><mi>v</mi><mo mathvariant="normal">≠</mo><mi>c</mi><mi>u</mi><mi>r</mi><mi>r</mi></mrow><annotation encoding="application/x-tex">prev \neq curr</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">p</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel"><span class="mrel"><span class="mord vbox"><span class="thinbox"><span class="rlap"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="inner"><span class="mrel"></span></span><span class="fix"></span></span></span></span></span><span class="mrel">=</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">c</span><span class="mord mathnormal">u</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span></span> if and only if <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mi>e</mi><mi>w</mi></mrow><annotation encoding="application/x-tex">new</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">n</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span></span></span></span> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mi>u</mi><mi>r</mi><mi>r</mi></mrow><annotation encoding="application/x-tex">curr</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">c</span><span class="mord mathnormal">u</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span></span> conflict.</li>
</ul>
</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://liyun-zhang.github.io/2023/09/26/Paper/Distributed/Memcache/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LiyunZhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LiyunZhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LiyunZhang">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/09/26/Paper/Distributed/Memcache/" class="post-title-link" itemprop="url">Memcache</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-09-26 13:52:21" itemprop="dateCreated datePublished" datetime="2023-09-26T13:52:21+08:00">2023-09-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-03-15 20:21:54" itemprop="dateModified" datetime="2024-03-15T20:21:54+08:00">2024-03-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Paper-Notebook/" itemprop="url" rel="index"><span itemprop="name">Paper Notebook</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Paper-Notebook/Distributed-System/" itemprop="url" rel="index"><span itemprop="name">Distributed System</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Paper: <a target="_blank" rel="noopener" href="http://nil.csail.mit.edu/6.824/2020/papers/memcache-fb.pdf">Scaling Memcache at Facebook</a></p>
<p><ul class="markdownIt-TOC">
<li><a href="#purpose">Purpose</a></li>
<li><a href="#model">Model</a>
<ul>
<li><a href="#overview">Overview</a>
<ul>
<li><a href="#how-are-queries-carried-out-with-memcache">How are queries carried out with memcache?</a></li>
<li><a href="#how-does-writing-carry-out-with-memcache">How does writing carry out with memcache?</a></li>
<li><a href="#what-are-the-stages-of-problems-when-users-increase">What are the stages of problems when users increase?</a></li>
<li><a href="#what-are-the-consistent-requirements">What are the consistent requirements?</a></li>
</ul>
</li>
<li><a href="#in-a-cluster-latency-and-load">In a cluster: latency and load</a>
<ul>
<li><a href="#how-do-clients-communicate-with-memcached-servers">How do clients communicate with memcached servers?</a></li>
<li><a href="#how-to-handle-incast-congestion">How to handle incast congestion?</a></li>
<li><a href="#how-to-prevent-stale-sets-problem">How to prevent stale sets problem?</a></li>
<li><a href="#how-to-prevent-thundering-herds">How to prevent thundering herds?</a></li>
<li><a href="#how-to-prevent-hit-rates-from-decreasing-caused-by-different-client-access-patterns">How to prevent hit rates from decreasing caused by different client access patterns?</a></li>
<li><a href="#how-to-handle-a-small-number-of-memcache-servers-inaccessible-due-to-network-or-server-failure">How to handle a small number of memcache servers inaccessible due to network or server failure?</a></li>
</ul>
</li>
<li><a href="#in-a-region-replication">In a region: replication</a>
<ul>
<li><a href="#what-is-the-problem-of-scaling-memcache">What is the problem of scaling memcache?</a></li>
<li><a href="#how-to-mitigate-the-poor-hit-rates-when-a-cold-cluster-starts-up">How to mitigate the poor hit rates when a cold cluster starts up?</a></li>
<li><a href="#how-to-solve-the-race-in-cold-cluster-warmup-caused-by-an-update-in-the-cold-cluster">How to solve the race in cold cluster warmup caused by an update in the cold cluster?</a></li>
</ul>
</li>
<li><a href="#across-regions-consistency">Across regions: consistency</a>
<ul>
<li><a href="#how-to-execute-a-write-operation">How to execute a write operation?</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</p>
<h1 id="purpose"><a class="markdownIt-Anchor" href="#purpose"></a> Purpose</h1>
<ol>
<li>
<p>Issues:</p>
<ul>
<li>Users consume an order of magnitude more content than they create.
<ul>
<li>This behavior results in a workload dominated by fetching data and suggests that caching can have significant advantages.</li>
</ul>
</li>
<li>Read operations fetch data from a variety of sources.
<ul>
<li>This heterogeneity requires a flexible caching strategy to store data from disparate sources.</li>
</ul>
</li>
</ul>
</li>
<li>
<p>What is the requirement of a social network’s infrastructure?</p>
<ul>
<li>
<p>Allow near real-time communication.</p>
</li>
<li>
<p>Aggregate content on-the-fly from multiple sources</p>
</li>
<li>
<p>Be able to access and update very popular shared content.</p>
</li>
<li>
<p>Scale to process millions of user requests per second</p>
</li>
</ul>
</li>
<li>
<p>Memcached is an open-source implementation of an in-memory hash table, which provides low-latency access to a shared storage pool at a low cost.</p>
</li>
<li>
<p>Findings:</p>
<ul>
<li>While qualities like performance, efficiency, fault tolerance, and consistency are important at all scales and specific sizes, some qualities require more effort than others.</li>
<li>The importance of finding an optimal communication schedule increases as the number of servers increases and networking becomes the bottleneck.</li>
</ul>
</li>
</ol>
<h1 id="model"><a class="markdownIt-Anchor" href="#model"></a> Model</h1>
<h2 id="overview"><a class="markdownIt-Anchor" href="#overview"></a> Overview</h2>
<h3 id="how-are-queries-carried-out-with-memcache"><a class="markdownIt-Anchor" href="#how-are-queries-carried-out-with-memcache"></a> How are queries carried out with memcache?</h3>
<ol>
<li>When a web server needs data, it first requests the value from memcache by providing a string key.</li>
<li>If the item that the key addresses is not cached, the web server retrieves the data from the database or other backend service and populates the cache with the key-value pair.</li>
</ol>
<img src="/imgs/Distributed/Memcache/read.png" width="30%">
<h3 id="how-does-writing-carry-out-with-memcache"><a class="markdownIt-Anchor" href="#how-does-writing-carry-out-with-memcache"></a> How does writing carry out with memcache?</h3>
<ol>
<li>The web server issues SQL statements to the database for write requests and then sends a delete request to memcache that invalidates stale data.</li>
<li>We delete cached data instead of updating it because deletes are idempotent.
<ul>
<li>Considering two concurrent writes, there is no guarantee that the update operation will be in the same order as the database updates.</li>
<li>If database updates write A first, then write B while the Memcache set write B first then write A, the Memcache would be inconsistent with the database.</li>
</ul>
</li>
</ol>
<img src="/imgs/Distributed/Memcache/write.png" width="30%">
<h3 id="what-are-the-stages-of-problems-when-users-increase"><a class="markdownIt-Anchor" href="#what-are-the-stages-of-problems-when-users-increase"></a> What are the stages of problems when users increase?</h3>
<ol>
<li>Initially, there were few users; the service could be provided with a single server running both scripts and the database.</li>
<li>As the number of users grows, the first problem is usually that the server runs out of CPU to execute scripts.
<ul>
<li>Hence, the solution is to use multiple servers to run scripts and another server to run the database.</li>
</ul>
</li>
<li>If the number of users keeps growing, the next problem is that the database runs out of steam.
<ul>
<li>The solution usually uses a distributed sharding database system. This is when all those consistent problems come.</li>
</ul>
</li>
<li>However, the MySQL cannot process reads and writes fast. And if some keys are the hot zone, no matter how delicate we shard, there is only one group for that key.
<ul>
<li>Facebook uses Memcache to solve this situation when Memcache servers absorb most read requests; only a few are exposed to database servers.</li>
</ul>
</li>
</ol>
<h3 id="what-are-the-consistent-requirements"><a class="markdownIt-Anchor" href="#what-are-the-consistent-requirements"></a> What are the consistent requirements?</h3>
<ol>
<li>When users only read data, they can barely notice the stale data for a few seconds, but not too long, like data from yesterday.</li>
<li>When users change something, if they immediately try to read it, they should see the data they changed. There should not be any stale in this case.</li>
</ol>
<h2 id="in-a-cluster-latency-and-load"><a class="markdownIt-Anchor" href="#in-a-cluster-latency-and-load"></a> In a cluster: latency and load</h2>
<h3 id="how-do-clients-communicate-with-memcached-servers"><a class="markdownIt-Anchor" href="#how-do-clients-communicate-with-memcached-servers"></a> How do clients communicate with memcached servers?</h3>
<ol>
<li>Client logic is provided as two components: a library that can be embedded into applications or a standalone proxy named <em>mcrouter</em>.
<ul>
<li>This proxy presents a Memcached server interface and routes the requests/replies to/from other servers.</li>
</ul>
</li>
<li><code>Get</code> requests relies on UDP to reduce latency and overhead.
<ul>
<li>Each thread in the web server is allowed to communicate with <em>Memcached</em> servers directly, bypassing <em>mcrouter</em> without establishing and maintaining a connection, thereby reducing the overhead.</li>
<li>The UDP implementation detects packets that are dropped or received out of order (using sequence numbers) and treats them as errors on the client side. It does not provide any mechanism to try to recover from them.</li>
</ul>
</li>
<li>For reliability, clients perform <code>set</code> and <code>delete</code> operations over TCP through an instance of <em>mcrouter</em> running on the same machine as the web server.
<ul>
<li>For operations where we need to confirm a state change (<code>update</code>s and <code>delete</code>s), TCP alleviates the need to add a retry mechanism to our UDP implementation.</li>
</ul>
</li>
</ol>
<h3 id="how-to-handle-incast-congestion"><a class="markdownIt-Anchor" href="#how-to-handle-incast-congestion"></a> How to handle incast congestion?</h3>
<ol>
<li>Web servers must routinely communicate with many memcached servers to satisfy user requests.
<ul>
<li>As a result, all web servers communicate with every memcached server in a short period.</li>
<li>This all-to-all communication pattern can cause incast congestion or allow a single server to become the bottleneck for many web servers.</li>
</ul>
</li>
<li>Memcache clients implement flow control mechanisms to limit incast congestion.
<ul>
<li>Clients use a sliding window mechanism to control the number of outstanding requests.</li>
<li>The size of this sliding window grows slowly upon a successful request and shrinks when a request goes unanswered.</li>
<li>With lower window sizes, the application will have to dispatch more groups of memcache requests serially, increasing the duration of the web request.</li>
<li>As the window size gets too large, the number of simultaneous memcache requests causes incast congestion.</li>
</ul>
</li>
</ol>
<h3 id="how-to-prevent-stale-sets-problem"><a class="markdownIt-Anchor" href="#how-to-prevent-stale-sets-problem"></a> How to prevent stale sets problem?</h3>
<ol>
<li>A stale set occurs when a web server sets a value in <em>memcache</em> that does not reflect the latest value that should be cached.
<ul>
<li>For example, when server A tried to read an entry <code>get(k)</code> and missed, it read a value <code>v1</code> from the database. But before its <code>set(k, v1)</code> is executed, another server updated <code>k=v2</code> and executed <code>delete(k)</code>.</li>
<li>The problem is that after <code>delete(k)</code> is executed, there is no mechanism to prevent the stale <code>set(k, v1)</code> from being executed. Hence, a stale entry will be left in the <em>memcache</em> for an indefinite long time.</li>
</ul>
</li>
<li>A memcached instance gives a lease to a client to set data back into the cache when that client experiences a cache miss.
<ul>
<li>The lease is a 64-bit token bound to the specific key the client originally requested.</li>
<li>The client provides the lease token when setting the value in the cache.</li>
<li>Verification can fail if Memcached has invalidated the lease token due to receiving a delete request for that item.</li>
</ul>
</li>
</ol>
<h3 id="how-to-prevent-thundering-herds"><a class="markdownIt-Anchor" href="#how-to-prevent-thundering-herds"></a> How to prevent thundering herds?</h3>
<ol>
<li>A thundering herd happens when a specific key undergoes heavy read and write activity.
<ul>
<li>If one client updates the database and deletes a key, many clients get() but miss, causing them to try to fetch from the database and all <code>set()</code>.</li>
</ul>
</li>
<li>Each memcached server regulates the rate at which it returns lease tokens.
<ul>
<li>Each memcached server only returns a lease token every period.</li>
<li>Other cache misses during that period will receive a special notification telling the client to wait a short time.</li>
<li>Return a lease every period instead of only returning to the first cache miss to prevent the first client from acquiring data from the database.</li>
</ul>
</li>
</ol>
<h3 id="how-to-prevent-hit-rates-from-decreasing-caused-by-different-client-access-patterns"><a class="markdownIt-Anchor" href="#how-to-prevent-hit-rates-from-decreasing-caused-by-different-client-access-patterns"></a> How to prevent hit rates from decreasing caused by different client access patterns?</h3>
<ol>
<li>A cluster’s memcached servers are partitioned into separate pools.
<ul>
<li>One pool (named <em>wildcard</em>) is designated as the default.</li>
<li>Separate pools are provided for keys whose residence in wildcard is problematic.</li>
</ul>
</li>
<li>Within some pools, replication can be used to improve the latency and efficiency.
<ul>
<li>Choose to replicate a category of keys within a pool when
<ul>
<li>The application routinely fetches many keys simultaneously.</li>
<li>The entire data set fits in one or two Memcached servers.</li>
<li>The request rate is much higher than what a single server can manage.</li>
</ul>
</li>
<li>Favor replication in this instance over further dividing the key space due to the following reasons:
<ul>
<li>The difference in memcached overhead for retrieving 100 keys per request instead of 1 key is small.</li>
<li>Replicating can reduce the requests that need to be processed by each server while dividing the key space can only reduce the keys retrieved from each server and increase the number of requests.</li>
</ul>
</li>
</ul>
</li>
</ol>
<h3 id="how-to-handle-a-small-number-of-memcache-servers-inaccessible-due-to-network-or-server-failure"><a class="markdownIt-Anchor" href="#how-to-handle-a-small-number-of-memcache-servers-inaccessible-due-to-network-or-server-failure"></a> How to handle a small number of memcache servers inaccessible due to network or server failure?</h3>
<ol>
<li>
<p>For small outages, it relies on an automated remediation system.</p>
<ul>
<li>These actions are not instant and can take up to a few minutes.</li>
<li>This duration is long enough to cause the aforementioned cascading failures.</li>
</ul>
</li>
<li>
<p>A small set of machines, named <em>Gutter</em>, takes over the responsibilities of a few failed servers.</p>
<ul>
<li>
<p>Gutter accounts for approximately 1% of the memcached servers in a cluster.</p>
</li>
<li>
<p>When a Memcached client receives no response to its get request, the client assumes the server has failed and issues the request again to a special Gutter pool.</p>
</li>
<li>
<p>If this second request misses, the client will insert the appropriate key-value pair into the Gutter machine after querying the database.</p>
</li>
<li>
<p>Entries in the Gutter expire quickly to obviate Gutter invalidations.</p>
</li>
<li>
<p>Gutter limits the load on backend services at the cost of slightly stale data.</p>
</li>
</ul>
</li>
<li>
<p>This design differs from an approach in which a client rehashes keys among the remaining memcached servers.</p>
<ul>
<li>The server that becomes responsible for this hot key might also become overloaded. By shunting load to idle servers, we limit that risk.</li>
</ul>
</li>
</ol>
<h2 id="in-a-region-replication"><a class="markdownIt-Anchor" href="#in-a-region-replication"></a> In a region: replication</h2>
<h3 id="what-is-the-problem-of-scaling-memcache"><a class="markdownIt-Anchor" href="#what-is-the-problem-of-scaling-memcache"></a> What is the problem of scaling memcache?</h3>
<ol>
<li>
<p>In communication traffic:</p>
<ul>
<li>
<p>Highly requested items will only become more popular as more web servers are added to cope with increased user traffic.</p>
</li>
<li>
<p>Incast congestion also worsens as the number of memcached servers increases.</p>
</li>
<li>
<p>Split web and Memcached servers into multiple <em>frontend</em> clusters.</p>
</li>
<li>
<p>These clusters, along with a storage cluster that contains the databases, define a region.</p>
</li>
</ul>
</li>
<li>
<p>The number of invalidations will increase.</p>
<ul>
<li>The storage cluster is responsible for invalidating cached data to keep frontend clusters consistent with the authoritative versions.</li>
<li>As an optimization, a web server that modifies data also sends invalidations to its cluster to provide read-after-write semantics for a single user request and reduce the time stale data is present in its local cache.</li>
<li>Also, batch invalidations can reduce packet rates.</li>
</ul>
</li>
<li>
<p>If users’ requests are randomly routed to all available frontend clusters, the cached data will be roughly the same across all the frontend clusters.</p>
<ul>
<li>
<p>Over-replicating the data can be memory inefficient, especially for large, rarely accessed items.</p>
</li>
<li>
<p>Reduce the number of replicas by having multiple frontend clusters share the same set of memcached servers called a regional pool.</p>
</li>
</ul>
</li>
</ol>
<h3 id="how-to-mitigate-the-poor-hit-rates-when-a-cold-cluster-starts-up"><a class="markdownIt-Anchor" href="#how-to-mitigate-the-poor-hit-rates-when-a-cold-cluster-starts-up"></a> How to mitigate the poor hit rates when a cold cluster starts up?</h3>
<ol>
<li>When we bring a new cluster online, an existing one fails, or perform scheduled maintenance; the caches will have very poor hit rates, diminishing the ability to insulate backend services.</li>
<li>A system called Cold Cluster Warmup mitigates this by allowing clients in the “cold cluster” (i.e., the frontend cluster that has an empty cache) to retrieve data from the “warm cluster” (i.e., a cluster that has caches with normal hit rates) rather than the persistent storage.</li>
<li>Cold clusters can be brought back to full capacity in a few hours instead of a few days with this system.</li>
<li>The cold cluster warmup is turned off once the cold cluster’s hit rate stabilizes and the benefits diminish.</li>
</ol>
<h3 id="how-to-solve-the-race-in-cold-cluster-warmup-caused-by-an-update-in-the-cold-cluster"><a class="markdownIt-Anchor" href="#how-to-solve-the-race-in-cold-cluster-warmup-caused-by-an-update-in-the-cold-cluster"></a> How to solve the race in cold cluster warmup caused by an update in the cold cluster?</h3>
<ol>
<li>If a client in the cold cluster does a database update, and a subsequent request from another client retrieves the stale value from the warm cluster before the warm cluster has received the invalidation, that item will be indefinitely inconsistent in the cold cluster.</li>
<li>Memcached deletes support nonzero hold-off times that reject add operations for the specified hold-off time.
<ul>
<li>By default, all deletes to the cold cluster are issued with a two-second hold-off.</li>
<li>When a miss is detected in the cold cluster, the client re-requests the key from the warm cluster and adds it to the cold cluster.</li>
<li>The failure of the add indicates that newer data is available on the database, and thus, the client will refetch the value from the databases.</li>
</ul>
</li>
</ol>
<h2 id="across-regions-consistency"><a class="markdownIt-Anchor" href="#across-regions-consistency"></a> Across regions: consistency</h2>
<h3 id="how-to-execute-a-write-operation"><a class="markdownIt-Anchor" href="#how-to-execute-a-write-operation"></a> How to execute a write operation?</h3>
<ol>
<li>
<p>Of many regions, one region is designated to hold the master databases, and the other regions contain read-only replicas.</p>
</li>
<li>
<p>For writes from a master region:</p>
<ul>
<li>
<p>The storage cluster of each region will send invalidations after they have replicated data.</p>
</li>
<li>
<p>It avoids a race condition in which an invalidation arrives before the data has been replicated from the master region.</p>
</li>
</ul>
</li>
<li>
<p>For writes from a non-master region:</p>
<ul>
<li>The user’s next request could be confused about whether his recent change is missing.</li>
<li>Employ a remote marker mechanism to minimize the probability of reading stale data.
<ul>
<li>The marker indicates that data in the local replica database are potentially stale, and the query should be redirected to the master region.</li>
</ul>
</li>
<li>When a web server wishes to update data that affects a key <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span>, that server
<ul>
<li>sets a remote marker <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>r</mi><mi>k</mi></msub></mrow><annotation encoding="application/x-tex">r_k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> in the region</li>
<li>performs the write to the master embedding <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>r</mi><mi>k</mi></msub></mrow><annotation encoding="application/x-tex">r_k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> to be invalidated in the SQL statement</li>
<li>deletes <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> in the local cluster</li>
</ul>
</li>
<li>On a subsequent request for <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span>,
<ul>
<li>A web server will be unable to find the cached data.</li>
<li>Check whether <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>r</mi><mi>k</mi></msub></mrow><annotation encoding="application/x-tex">r_k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> exists</li>
<li>Direct its query to the master or local region depending on the presence of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>r</mi><mi>k</mi></msub></mrow><annotation encoding="application/x-tex">r_k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>.</li>
</ul>
</li>
<li>The remote markers are implemented by using a regional pool.</li>
<li>This mechanism may reveal stale information during concurrent modifications to the same key as one operation may delete a remote marker that should remain present for another in-flight operation.</li>
</ul>
</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://liyun-zhang.github.io/2023/09/26/Paper/Distributed/Spark/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LiyunZhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LiyunZhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LiyunZhang">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/09/26/Paper/Distributed/Spark/" class="post-title-link" itemprop="url">Spark</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-09-26 13:50:52" itemprop="dateCreated datePublished" datetime="2023-09-26T13:50:52+08:00">2023-09-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-03-15 21:29:05" itemprop="dateModified" datetime="2024-03-15T21:29:05+08:00">2024-03-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Paper-Notebook/" itemprop="url" rel="index"><span itemprop="name">Paper Notebook</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Paper-Notebook/Distributed-System/" itemprop="url" rel="index"><span itemprop="name">Distributed System</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Paper: <a target="_blank" rel="noopener" href="http://nil.csail.mit.edu/6.824/2020/papers/zaharia-spark.pdf">Resilient Distributed Datasets: A Fault-Tolerant Abstraction for In-Memory Cluster Computing</a></p>
<p><ul class="markdownIt-TOC">
<li><a href="#purpose">Purpose</a></li>
<li><a href="#model">Model</a>
<ul>
<li><a href="#rdds">RDDs</a>
<ul>
<li><a href="#what-is-rdd">What is RDD?</a></li>
<li><a href="#what-are-the-advantages-of-the-rdd-model-compared-with-distributed-shared-memory-dsm">What are the advantages of the RDD model compared with distributed shared memory (DSM)?</a></li>
<li><a href="#what-kind-of-applications-are-suited-for-rdds">What kind of applications are suited for RDDs?</a></li>
</ul>
</li>
<li><a href="#spark">Spark</a>
<ul>
<li><a href="#what-is-the-runtime-of-spark">What is the runtime of Spark?</a></li>
<li><a href="#what-is-the-spark-programming-interface-of-rdds">What is the Spark programming interface of RDDs?</a></li>
<li><a href="#what-rdd-operations-are-supported-in-spark">What RDD operations are supported in Spark?</a></li>
<li><a href="#what-is-the-common-interface-of-each-rdd">What is the common interface of each RDD?</a></li>
<li><a href="#what-is-the-interface-that-represents-dependencies-between-rdds">What is the interface that represents dependencies between RDDs?</a></li>
</ul>
</li>
<li><a href="#implementation">Implementation</a>
<ul>
<li><a href="#how-does-spark-schedule-computations">How does Spark schedule computations?</a></li>
<li><a href="#how-does-spark-handle-task-failures">How does Spark handle task failures?</a></li>
<li><a href="#how-does-spark-manage-the-storage-of-persistent-rdds">How does Spark manage the storage of persistent RDDs?</a></li>
<li><a href="#how-does-spark-evict-rdds-when-run-out-of-memory">How does Spark evict RDDs when run out of memory?</a></li>
<li><a href="#when-will-checkpointing-be-useful">When will checkpointing be useful?</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#experiment">Experiment</a></li>
</ul>
</p>
<h1 id="purpose"><a class="markdownIt-Anchor" href="#purpose"></a> Purpose</h1>
<ol>
<li>
<p>Contribution:</p>
<ul>
<li>Present Resilient Distributed Datasets (RDDs), a distributed memory abstraction, lets programmers perform in-memory computations on large clusters fault-tolerantly.</li>
<li>RDDs provide an interface based on coarse-grained transformations (e.g., map, filter, and join) that apply the same operation to many data items.</li>
</ul>
</li>
<li>
<p>Issues:</p>
<ul>
<li>
<p>Current computing frameworks handle two types of applications inefficiently: iterative algorithms and interactive data mining tools.</p>
</li>
<li>
<p>Current frameworks lack abstractions for leveraging distributed memory.</p>
<ul>
<li>In most current frameworks, the only way to reuse data between computations is to write it to an external stable storage system.</li>
<li>This makes them inefficient for those that reuse intermediate results across multiple computations.</li>
<li>This incurs substantial overheads due to data replication, disk I/O, and serialization.</li>
</ul>
</li>
<li>
<p>Some specialized frameworks have been developed for some applications that require data reuse. However, they do not provide abstractions for more general reuse.</p>
</li>
<li>
<p>Both replicating the data across machines and logging updates across machines are expensive for data-intensive workloads.</p>
</li>
</ul>
</li>
</ol>
<h1 id="model"><a class="markdownIt-Anchor" href="#model"></a> Model</h1>
<h2 id="rdds"><a class="markdownIt-Anchor" href="#rdds"></a> RDDs</h2>
<h3 id="what-is-rdd"><a class="markdownIt-Anchor" href="#what-is-rdd"></a> What is RDD?</h3>
<ol>
<li>An RDD is a read-only, partitioned collection of records.
<ul>
<li>Although individual RDDs are immutable, it is possible to implement mutable states with multiple RDDs representing multiple dataset versions.</li>
</ul>
</li>
<li>RDDs can only be created through deterministic operations on either data in stable storage or other RDDs.
<ul>
<li>These operations are called transformations to differentiate them from other operations on RDDs.</li>
</ul>
</li>
<li>An RDD has enough information about how it was derived from other datasets (its lineage) to compute its partitions from data in stable storage.
<ul>
<li>A program cannot reference an RDD that it cannot reconstruct after a failure.</li>
<li>RDDs do not need to be materialized at all times.</li>
</ul>
</li>
<li>Users can control two other aspects of RDDs: persistence and partitioning.
<ul>
<li>Users can indicate which RDDs they will reuse and choose a storage strategy.</li>
<li>They can also ask that an RDD’s elements be partitioned across machines based on a key in each record.</li>
</ul>
</li>
</ol>
<h3 id="what-are-the-advantages-of-the-rdd-model-compared-with-distributed-shared-memory-dsm"><a class="markdownIt-Anchor" href="#what-are-the-advantages-of-the-rdd-model-compared-with-distributed-shared-memory-dsm"></a> What are the advantages of the RDD model compared with distributed shared memory (DSM)?</h3>
<ol>
<li>
<p>The main difference between RDDs and DSM is that RDDs can only be created (“written”) through coarse-grained transformations, while DSM allows reads and writes to each memory location.</p>
<ul>
<li>This restricts RDDs to applications that perform bulk writes but allows for more efficient fault tolerance.</li>
<li>RDDs do not need to incur the overhead of checkpointing, as they can be recovered using lineage.</li>
<li>Only the lost partitions of an RDD need to be recomputed upon failure, and they can be recomputed in parallel on different nodes without having to roll back the whole program.</li>
</ul>
</li>
<li>
<p>RDDs’ immutable nature lets a system mitigate slow nodes (stragglers) by running backup copies of slow tasks, as in MapReduce.</p>
<ul>
<li>Backup tasks would be challenging to implement with DSM, as the two copies of a task would access the same memory locations and interfere with each other’s updates.</li>
</ul>
</li>
<li>
<p>In bulk operations on RDDs, a runtime can schedule tasks based on data locality to improve performance.</p>
</li>
<li>
<p>RDDs degrade gracefully when there is not enough memory to store them as long as they are only used in scan-based operations.</p>
<p>Partitions that do not fit in RAM can be stored on disk and provide performance similar to current data-parallel systems.</p>
</li>
</ol>
<h3 id="what-kind-of-applications-are-suited-for-rdds"><a class="markdownIt-Anchor" href="#what-kind-of-applications-are-suited-for-rdds"></a> What kind of applications are suited for RDDs?</h3>
<ol>
<li>RDDs are best suited for batch applications that apply the same operation to all dataset elements.
<ul>
<li>RDDs can efficiently remember each transformation as one step in a lineage graph and recover lost partitions without logging large amounts of data.</li>
</ul>
</li>
<li>RDDs would be less suitable for applications that make asynchronous fine-grained updates to shared states.</li>
</ol>
<h2 id="spark"><a class="markdownIt-Anchor" href="#spark"></a> Spark</h2>
<h3 id="what-is-the-runtime-of-spark"><a class="markdownIt-Anchor" href="#what-is-the-runtime-of-spark"></a> What is the runtime of Spark?</h3>
<ol>
<li>Developers write a <strong>driver</strong> program that connects to a cluster of <strong>workers</strong>.
<ul>
<li>The driver defines one or more RDDs and invokes actions on them.</li>
<li>Spark code on the driver also tracks the RDDs’ lineage.</li>
</ul>
</li>
<li>The workers are long-lived processes that can store RDD partitions in RAM across operations.</li>
</ol>
<img src="/imgs/Distributed/Spark/runtime.png" width="30%">
<h3 id="what-is-the-spark-programming-interface-of-rdds"><a class="markdownIt-Anchor" href="#what-is-the-spark-programming-interface-of-rdds"></a> What is the Spark programming interface of RDDs?</h3>
<ol>
<li>Each dataset is represented as an object, and transformations are invoked using methods for these objects.</li>
<li>Programmers start by defining one or more RDDs through transformations on data in stable storage.
<ul>
<li>They can then use these RDDs in actions, which are operations that return a value to the application or export data to a storage system.</li>
</ul>
</li>
<li>Programmers can call a <code>persist()</code> method to indicate which RDDs they want to reuse in future operations.
<ul>
<li>Spark keeps persistent RDDs in memory by default but can spill them to disk without enough RAM.</li>
<li>Users can set a persistence priority on each RDD to specify which in-memory data should spill to disk first.</li>
<li>The user can call <code>persist</code> with a <code>RELIABLE</code> flag to reliably replicate some of the versions of RDDs to reduce fault recovery times.</li>
</ul>
</li>
</ol>
<h3 id="what-rdd-operations-are-supported-in-spark"><a class="markdownIt-Anchor" href="#what-rdd-operations-are-supported-in-spark"></a> What RDD operations are supported in Spark?</h3>
<ol>
<li>Users provide arguments to RDD operations by passing closures (function literals).</li>
<li>RDDs themselves are statically typed objects parametrized by an element type.</li>
<li>Transformations are <strong>lazy</strong> operations that define a new RDD.
<ul>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi><mi>a</mi><mi>p</mi><mo stretchy="false">(</mo><mi>f</mi><mo>:</mo><mi>T</mi><mo>⇒</mo><mi>U</mi><mo stretchy="false">)</mo><mo>:</mo><mi>R</mi><mi>D</mi><mi>D</mi><mo stretchy="false">[</mo><mi>T</mi><mo stretchy="false">]</mo><mo>⇒</mo><mi>R</mi><mi>D</mi><mi>D</mi><mo stretchy="false">[</mo><mi>U</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">map(f: T\Rightarrow U): RDD[T]\Rightarrow RDD[U]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">m</span><span class="mord mathnormal">a</span><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">⇒</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">⇒</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="mclose">]</span></span></span></span></li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mi>i</mi><mi>l</mi><mi>t</mi><mi>e</mi><mi>r</mi><mo stretchy="false">(</mo><mi>f</mi><mo>:</mo><mi>T</mi><mo>⇒</mo><mi>B</mi><mi>o</mi><mi>o</mi><mi>l</mi><mo stretchy="false">)</mo><mo>:</mo><mi>R</mi><mi>D</mi><mi>D</mi><mo stretchy="false">[</mo><mi>T</mi><mo stretchy="false">]</mo><mo>⇒</mo><mi>R</mi><mi>D</mi><mi>D</mi><mo stretchy="false">[</mo><mi>T</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">filter(f: T\Rightarrow Bool): RDD[T]\Rightarrow RDD[T]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">⇒</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mord mathnormal">o</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">⇒</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mclose">]</span></span></span></span></li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mi>l</mi><mi>a</mi><mi>t</mi><mi>M</mi><mi>a</mi><mi>p</mi><mo stretchy="false">(</mo><mi>f</mi><mo>:</mo><mi>T</mi><mo>⇒</mo><mi>S</mi><mi>e</mi><mi>q</mi><mo stretchy="false">[</mo><mi>U</mi><mo stretchy="false">]</mo><mo stretchy="false">)</mo><mo>:</mo><mi>R</mi><mi>D</mi><mi>D</mi><mo stretchy="false">[</mo><mi>T</mi><mo stretchy="false">]</mo><mo>⇒</mo><mi>R</mi><mi>D</mi><mi>D</mi><mo stretchy="false">[</mo><mi>U</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">flatMap(f: T\Rightarrow Seq[U]): RDD[T]\Rightarrow RDD[U]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">a</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mord mathnormal">a</span><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">⇒</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="mclose">]</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">⇒</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="mclose">]</span></span></span></span></li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>a</mi><mi>m</mi><mi>p</mi><mi>l</mi><mi>e</mi><mo stretchy="false">(</mo><mi>f</mi><mi>r</mi><mi>a</mi><mi>c</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi><mo>:</mo><mi>F</mi><mi>l</mi><mi>o</mi><mi>a</mi><mi>t</mi><mo stretchy="false">)</mo><mo>:</mo><mi>R</mi><mi>D</mi><mi>D</mi><mo stretchy="false">[</mo><mi>T</mi><mo stretchy="false">]</mo><mo>⇒</mo><mi>R</mi><mi>D</mi><mi>D</mi><mo stretchy="false">[</mo><mi>T</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">sample(fraction: Float): RDD[T]\Rightarrow RDD[T]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">s</span><span class="mord mathnormal">a</span><span class="mord mathnormal">m</span><span class="mord mathnormal">p</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">a</span><span class="mord mathnormal">c</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">F</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">o</span><span class="mord mathnormal">a</span><span class="mord mathnormal">t</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">⇒</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mclose">]</span></span></span></span> (Deterministic sampling)</li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>g</mi><mi>r</mi><mi>o</mi><mi>u</mi><mi>p</mi><mi>B</mi><mi>y</mi><mi>K</mi><mi>e</mi><mi>y</mi><mo stretchy="false">(</mo><mo stretchy="false">)</mo><mo>:</mo><mi>R</mi><mi>D</mi><mi>D</mi><mo stretchy="false">[</mo><mo stretchy="false">(</mo><mi>K</mi><mo separator="true">,</mo><mi>V</mi><mo stretchy="false">)</mo><mo stretchy="false">]</mo><mo>⇒</mo><mi>R</mi><mi>D</mi><mi>D</mi><mo stretchy="false">[</mo><mo stretchy="false">(</mo><mi>K</mi><mo separator="true">,</mo><mi>S</mi><mi>e</mi><mi>q</mi><mo stretchy="false">[</mo><mi>V</mi><mo stretchy="false">]</mo><mo stretchy="false">)</mo><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">groupByKey(): RDD[(K,V)]\Rightarrow RDD[(K,Seq[V])]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">o</span><span class="mord mathnormal">u</span><span class="mord mathnormal">p</span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mopen">(</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mopen">[</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mclose">)</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">⇒</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mopen">[</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mclose">]</span><span class="mclose">)</span><span class="mclose">]</span></span></span></span></li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi><mi>e</mi><mi>d</mi><mi>u</mi><mi>c</mi><mi>e</mi><mi>B</mi><mi>y</mi><mi>K</mi><mi>e</mi><mi>y</mi><mo stretchy="false">(</mo><mi>f</mi><mo>:</mo><mo stretchy="false">(</mo><mi>V</mi><mo separator="true">,</mo><mi>V</mi><mo stretchy="false">)</mo><mo>⇒</mo><mi>V</mi><mo stretchy="false">)</mo><mo>:</mo><mi>R</mi><mi>D</mi><mi>D</mi><mo stretchy="false">[</mo><mo stretchy="false">(</mo><mi>K</mi><mo separator="true">,</mo><mi>V</mi><mo stretchy="false">)</mo><mo stretchy="false">]</mo><mo>⇒</mo><mi>R</mi><mi>D</mi><mi>D</mi><mo stretchy="false">[</mo><mo stretchy="false">(</mo><mi>K</mi><mo separator="true">,</mo><mi>V</mi><mo stretchy="false">)</mo><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">reduceByKey(f:(V,V)\Rightarrow V): RDD[(K,V)]\Rightarrow RDD[(K,V)]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">e</span><span class="mord mathnormal">d</span><span class="mord mathnormal">u</span><span class="mord mathnormal">c</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">⇒</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mopen">[</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mclose">)</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">⇒</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mopen">[</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mclose">)</span><span class="mclose">]</span></span></span></span></li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>u</mi><mi>n</mi><mi>i</mi><mi>o</mi><mi>n</mi><mo stretchy="false">(</mo><mo stretchy="false">)</mo><mo>:</mo><mo stretchy="false">(</mo><mi>R</mi><mi>D</mi><mi>D</mi><mo stretchy="false">[</mo><mi>T</mi><mo stretchy="false">]</mo><mo separator="true">,</mo><mi>R</mi><mi>D</mi><mi>D</mi><mo stretchy="false">[</mo><mi>T</mi><mo stretchy="false">]</mo><mo stretchy="false">)</mo><mo>⇒</mo><mi>R</mi><mi>D</mi><mi>D</mi><mo stretchy="false">[</mo><mi>T</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">union(): (RDD[T],RDD[T])\Rightarrow RDD[T]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">u</span><span class="mord mathnormal">n</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mopen">(</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mclose">]</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mclose">]</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">⇒</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mclose">]</span></span></span></span></li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi><mi>o</mi><mi>i</mi><mi>n</mi><mo stretchy="false">(</mo><mo stretchy="false">)</mo><mo>:</mo><mo stretchy="false">(</mo><mi>R</mi><mi>D</mi><mi>D</mi><mo stretchy="false">[</mo><mo stretchy="false">(</mo><mi>K</mi><mo separator="true">,</mo><mi>V</mi><mo stretchy="false">)</mo><mo stretchy="false">]</mo><mo separator="true">,</mo><mi>R</mi><mi>D</mi><mi>D</mi><mo stretchy="false">[</mo><mo stretchy="false">(</mo><mi>K</mi><mo separator="true">,</mo><mi>W</mi><mo stretchy="false">)</mo><mo stretchy="false">]</mo><mo stretchy="false">)</mo><mo>⇒</mo><mi>R</mi><mi>D</mi><mi>D</mi><mo stretchy="false">[</mo><mo stretchy="false">(</mo><mi>K</mi><mo separator="true">,</mo><mo stretchy="false">(</mo><mi>V</mi><mo separator="true">,</mo><mi>W</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">join():(RDD[(K,V)],RDD[(K,W)])\Rightarrow RDD[(K,(V,W))]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mord mathnormal">o</span><span class="mord mathnormal">i</span><span class="mord mathnormal">n</span><span class="mopen">(</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mopen">[</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mclose">)</span><span class="mclose">]</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mopen">[</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mclose">)</span><span class="mclose">]</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">⇒</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mopen">[</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mclose">)</span><span class="mclose">)</span><span class="mclose">]</span></span></span></span></li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mi>o</mi><mi>g</mi><mi>r</mi><mi>o</mi><mi>u</mi><mi>p</mi><mo stretchy="false">(</mo><mo stretchy="false">)</mo><mo>:</mo><mo stretchy="false">(</mo><mi>R</mi><mi>D</mi><mi>D</mi><mo stretchy="false">[</mo><mo stretchy="false">(</mo><mi>K</mi><mo separator="true">,</mo><mi>V</mi><mo stretchy="false">)</mo><mo stretchy="false">]</mo><mo separator="true">,</mo><mi>R</mi><mi>D</mi><mi>D</mi><mo stretchy="false">[</mo><mo stretchy="false">(</mo><mi>K</mi><mo separator="true">,</mo><mi>W</mi><mo stretchy="false">)</mo><mo stretchy="false">]</mo><mo stretchy="false">)</mo><mo>⇒</mo><mi>R</mi><mi>D</mi><mi>D</mi><mo stretchy="false">[</mo><mo stretchy="false">(</mo><mi>K</mi><mo separator="true">,</mo><mo stretchy="false">(</mo><mi>S</mi><mi>e</mi><mi>q</mi><mo stretchy="false">[</mo><mi>V</mi><mo stretchy="false">]</mo><mo separator="true">,</mo><mi>S</mi><mi>e</mi><mi>q</mi><mo stretchy="false">[</mo><mi>W</mi><mo stretchy="false">]</mo><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">cogroup():(RDD[(K,V)],RDD[(K,W)])\Rightarrow RDD[(K,(Seq[V],Seq[W]))]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">c</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">o</span><span class="mord mathnormal">u</span><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mopen">[</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mclose">)</span><span class="mclose">]</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mopen">[</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mclose">)</span><span class="mclose">]</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">⇒</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mopen">[</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mclose">]</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mclose">]</span><span class="mclose">)</span><span class="mclose">)</span><span class="mclose">]</span></span></span></span></li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mi>r</mi><mi>o</mi><mi>s</mi><mi>s</mi><mi>P</mi><mi>r</mi><mi>o</mi><mi>d</mi><mi>u</mi><mi>c</mi><mi>t</mi><mo stretchy="false">(</mo><mo stretchy="false">)</mo><mo>:</mo><mo stretchy="false">(</mo><mi>R</mi><mi>D</mi><mi>D</mi><mo stretchy="false">[</mo><mi>T</mi><mo stretchy="false">]</mo><mo separator="true">,</mo><mi>R</mi><mi>D</mi><mi>D</mi><mo stretchy="false">[</mo><mi>U</mi><mo stretchy="false">]</mo><mo stretchy="false">)</mo><mo>⇒</mo><mi>R</mi><mi>D</mi><mi>D</mi><mo stretchy="false">[</mo><mo stretchy="false">(</mo><mi>T</mi><mo separator="true">,</mo><mi>U</mi><mo stretchy="false">)</mo><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">crossProduct():(RDD[T],RDD[U])\Rightarrow RDD[(T,U)]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">c</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">o</span><span class="mord mathnormal">s</span><span class="mord mathnormal">s</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">o</span><span class="mord mathnormal">d</span><span class="mord mathnormal">u</span><span class="mord mathnormal">c</span><span class="mord mathnormal">t</span><span class="mopen">(</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mclose">]</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="mclose">]</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">⇒</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mopen">[</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="mclose">)</span><span class="mclose">]</span></span></span></span></li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi><mi>a</mi><mi>p</mi><mi>V</mi><mi>a</mi><mi>l</mi><mi>u</mi><mi>e</mi><mi>s</mi><mo stretchy="false">(</mo><mi>f</mi><mo>:</mo><mi>V</mi><mo>⇒</mo><mi>W</mi><mo stretchy="false">)</mo><mo>:</mo><mi>R</mi><mi>D</mi><mi>D</mi><mo stretchy="false">[</mo><mo stretchy="false">(</mo><mi>K</mi><mo separator="true">,</mo><mi>V</mi><mo stretchy="false">)</mo><mo stretchy="false">]</mo><mo>⇒</mo><mi>R</mi><mi>D</mi><mi>D</mi><mo stretchy="false">[</mo><mo stretchy="false">(</mo><mi>K</mi><mo separator="true">,</mo><mi>W</mi><mo stretchy="false">)</mo><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">mapValues(f:V\Rightarrow W):RDD[(K,V)]\Rightarrow RDD[(K,W)]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">m</span><span class="mord mathnormal">a</span><span class="mord mathnormal">p</span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">u</span><span class="mord mathnormal">e</span><span class="mord mathnormal">s</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">⇒</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mopen">[</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mclose">)</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">⇒</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mopen">[</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mclose">)</span><span class="mclose">]</span></span></span></span> (Preserves partitioning)</li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>o</mi><mi>r</mi><mi>t</mi><mo stretchy="false">(</mo><mi>c</mi><mo>:</mo><mi>C</mi><mi>o</mi><mi>m</mi><mi>p</mi><mi>a</mi><mi>r</mi><mi>a</mi><mi>t</mi><mi>o</mi><mi>r</mi><mo stretchy="false">[</mo><mi>K</mi><mo stretchy="false">]</mo><mo stretchy="false">)</mo><mo>:</mo><mi>R</mi><mi>D</mi><mi>D</mi><mo stretchy="false">[</mo><mo stretchy="false">(</mo><mi>K</mi><mo separator="true">,</mo><mi>V</mi><mo stretchy="false">)</mo><mo stretchy="false">]</mo><mo>⇒</mo><mi>R</mi><mi>D</mi><mi>D</mi><mo stretchy="false">[</mo><mo stretchy="false">(</mo><mi>K</mi><mo separator="true">,</mo><mi>V</mi><mo stretchy="false">)</mo><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">sort(c:Comparator[K]):RDD[(K,V)]\Rightarrow RDD[(K,V)]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">s</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">t</span><span class="mopen">(</span><span class="mord mathnormal">c</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mord mathnormal">o</span><span class="mord mathnormal">m</span><span class="mord mathnormal">p</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">a</span><span class="mord mathnormal">t</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mclose">]</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mopen">[</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mclose">)</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">⇒</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mopen">[</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mclose">)</span><span class="mclose">]</span></span></span></span></li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mi>a</mi><mi>r</mi><mi>t</mi><mi>i</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi><mi>B</mi><mi>y</mi><mo stretchy="false">(</mo><mi>p</mi><mo>:</mo><mi>P</mi><mi>a</mi><mi>r</mi><mi>t</mi><mi>i</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi><mi>e</mi><mi>r</mi><mo stretchy="false">[</mo><mi>K</mi><mo stretchy="false">]</mo><mo stretchy="false">)</mo><mo>:</mo><mi>R</mi><mi>D</mi><mi>D</mi><mo stretchy="false">[</mo><mo stretchy="false">(</mo><mi>K</mi><mo separator="true">,</mo><mi>V</mi><mo stretchy="false">)</mo><mo stretchy="false">]</mo><mo>⇒</mo><mi>R</mi><mi>D</mi><mi>D</mi><mo stretchy="false">[</mo><mo stretchy="false">(</mo><mi>K</mi><mo separator="true">,</mo><mi>V</mi><mo stretchy="false">)</mo><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">partitionBy(p:Partitioner[K]):RDD[(K,V)]\Rightarrow RDD[(K,V)]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">p</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mopen">(</span><span class="mord mathnormal">p</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mclose">]</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mopen">[</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mclose">)</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">⇒</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mopen">[</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mclose">)</span><span class="mclose">]</span></span></span></span></li>
</ul>
</li>
<li>Actions launch a computation to return a value to the program or write data to external storage.
<ul>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mi>o</mi><mi>u</mi><mi>n</mi><mi>t</mi><mo stretchy="false">(</mo><mo stretchy="false">)</mo><mo>:</mo><mi>R</mi><mi>D</mi><mi>D</mi><mo stretchy="false">[</mo><mi>T</mi><mo stretchy="false">]</mo><mo>⇒</mo><mi>L</mi><mi>o</mi><mi>n</mi><mi>g</mi><mo>:</mo></mrow><annotation encoding="application/x-tex">count(): RDD[T]\Rightarrow Long:</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">c</span><span class="mord mathnormal">o</span><span class="mord mathnormal">u</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span><span class="mopen">(</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">⇒</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">L</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span></span></span></span> Returns the number of elements in the dataset</li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mi>o</mi><mi>l</mi><mi>l</mi><mi>e</mi><mi>c</mi><mi>t</mi><mo stretchy="false">(</mo><mo stretchy="false">)</mo><mo>:</mo><mi>R</mi><mi>D</mi><mi>D</mi><mo stretchy="false">[</mo><mi>T</mi><mo stretchy="false">]</mo><mo>⇒</mo><mi>S</mi><mi>e</mi><mi>q</mi><mo stretchy="false">[</mo><mi>T</mi><mo stretchy="false">]</mo><mo>:</mo></mrow><annotation encoding="application/x-tex">collect(): RDD[T]\Rightarrow Seq[T]:</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">c</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mord mathnormal">c</span><span class="mord mathnormal">t</span><span class="mopen">(</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">⇒</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span></span></span></span> Returns the elements themselves</li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi><mi>e</mi><mi>d</mi><mi>u</mi><mi>c</mi><mi>e</mi><mo stretchy="false">(</mo><mi>f</mi><mo>:</mo><mo stretchy="false">(</mo><mi>T</mi><mo separator="true">,</mo><mi>T</mi><mo stretchy="false">)</mo><mo>⇒</mo><mi>T</mi><mo stretchy="false">)</mo><mo>:</mo><mi>R</mi><mi>D</mi><mi>D</mi><mo stretchy="false">[</mo><mi>T</mi><mo stretchy="false">]</mo><mo>⇒</mo><mi>T</mi></mrow><annotation encoding="application/x-tex">reduce(f:(T,T)\Rightarrow T): RDD[T]\Rightarrow T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">e</span><span class="mord mathnormal">d</span><span class="mord mathnormal">u</span><span class="mord mathnormal">c</span><span class="mord mathnormal">e</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">⇒</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">⇒</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span></span></span></span></li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><mi>o</mi><mi>o</mi><mi>k</mi><mi>u</mi><mi>p</mi><mo stretchy="false">(</mo><mi>k</mi><mo>:</mo><mi>K</mi><mo stretchy="false">)</mo><mo>:</mo><mi>R</mi><mi>D</mi><mi>D</mi><mo stretchy="false">[</mo><mo stretchy="false">(</mo><mi>K</mi><mo separator="true">,</mo><mi>V</mi><mo stretchy="false">)</mo><mo stretchy="false">]</mo><mo>⇒</mo><mi>S</mi><mi>e</mi><mi>q</mi><mo stretchy="false">[</mo><mi>V</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">lookup(k:K):RDD[(K,V)]\Rightarrow Seq[V]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">o</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord mathnormal">u</span><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mopen">[</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mclose">)</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">⇒</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mclose">]</span></span></span></span> (On hash/range partitioned RDDs)</li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>a</mi><mi>v</mi><mi>e</mi><mo stretchy="false">(</mo><mi>p</mi><mi>a</mi><mi>t</mi><mi>h</mi><mo>:</mo><mi>S</mi><mi>t</mi><mi>r</mi><mi>i</mi><mi>n</mi><mi>g</mi><mo stretchy="false">)</mo><mo>:</mo></mrow><annotation encoding="application/x-tex">save(path:String):</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">s</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">e</span><span class="mopen">(</span><span class="mord mathnormal">p</span><span class="mord mathnormal">a</span><span class="mord mathnormal">t</span><span class="mord mathnormal">h</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">n</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span></span></span></span> Outputs RDD to a storage system</li>
</ul>
</li>
</ol>
<h3 id="what-is-the-common-interface-of-each-rdd"><a class="markdownIt-Anchor" href="#what-is-the-common-interface-of-each-rdd"></a> What is the common interface of each RDD?</h3>
<ol>
<li>A set of partitions, which are atomic pieces of the dataset
<ul>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mi>a</mi><mi>r</mi><mi>t</mi><mi>i</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi><mi>e</mi><mi>r</mi><mo stretchy="false">(</mo><mo stretchy="false">)</mo><mo>:</mo></mrow><annotation encoding="application/x-tex">partitioner():</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">p</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mopen">(</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span></span></span></span> Return metadata specifying whether the RDD is hash/range partitioned.</li>
</ul>
</li>
<li>A set of dependencies on parent RDDs
<ul>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mi>e</mi><mi>p</mi><mi>e</mi><mi>n</mi><mi>d</mi><mi>e</mi><mi>n</mi><mi>c</mi><mi>i</mi><mi>e</mi><mi>s</mi><mo stretchy="false">(</mo><mo stretchy="false">)</mo><mo>:</mo></mrow><annotation encoding="application/x-tex">dependencies():</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">d</span><span class="mord mathnormal">e</span><span class="mord mathnormal">p</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord mathnormal">d</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord mathnormal">c</span><span class="mord mathnormal">i</span><span class="mord mathnormal">e</span><span class="mord mathnormal">s</span><span class="mopen">(</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span></span></span></span> Return a list of dependencies.</li>
</ul>
</li>
<li>A function for computing the dataset based on its parents
<ul>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mi>t</mi><mi>e</mi><mi>r</mi><mi>a</mi><mi>t</mi><mi>o</mi><mi>r</mi><mo stretchy="false">(</mo><mi>p</mi><mo separator="true">,</mo><mi>p</mi><mi>a</mi><mi>r</mi><mi>e</mi><mi>n</mi><mi>t</mi><mi>I</mi><mi>t</mi><mi>e</mi><mi>r</mi><mi>s</mi><mo stretchy="false">)</mo><mo>:</mo></mrow><annotation encoding="application/x-tex">iterator(p, parentIters):</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">i</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">a</span><span class="mord mathnormal">t</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mopen">(</span><span class="mord mathnormal">p</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">p</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">s</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span></span></span></span> Compute the elements of partition p given iterators for its parent partitions.</li>
</ul>
</li>
<li>Metadata about its partitioning scheme and data placement
<ul>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mi>a</mi><mi>r</mi><mi>t</mi><mi>i</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi><mi>s</mi><mo stretchy="false">(</mo><mo stretchy="false">)</mo><mo>:</mo></mrow><annotation encoding="application/x-tex">partitions():</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">p</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord mathnormal">s</span><span class="mopen">(</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span></span></span></span> Return a list of Partition objects.</li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mi>r</mi><mi>e</mi><mi>f</mi><mi>e</mi><mi>r</mi><mi>r</mi><mi>e</mi><mi>d</mi><mi>L</mi><mi>o</mi><mi>c</mi><mi>a</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi><mi>s</mi><mo stretchy="false">(</mo><mi>p</mi><mo stretchy="false">)</mo><mo>:</mo></mrow><annotation encoding="application/x-tex">preferredLocations(p):</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">p</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">e</span><span class="mord mathnormal">d</span><span class="mord mathnormal">L</span><span class="mord mathnormal">o</span><span class="mord mathnormal">c</span><span class="mord mathnormal">a</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord mathnormal">s</span><span class="mopen">(</span><span class="mord mathnormal">p</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span></span></span></span> List nodes where the partition <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">p</span></span></span></span> can be accessed faster due to data locality</li>
</ul>
</li>
</ol>
<h3 id="what-is-the-interface-that-represents-dependencies-between-rdds"><a class="markdownIt-Anchor" href="#what-is-the-interface-that-represents-dependencies-between-rdds"></a> What is the interface that represents dependencies between RDDs?</h3>
<ol>
<li>
<p>Classify dependencies into two types:</p>
<ul>
<li>Narrow dependencies: each partition of the parent RDD is used by at most one partition of the child RDD.</li>
<li>Wide dependencies: multiple child partitions may depend on it.</li>
</ul>
</li>
<li>
<p>Narrow dependencies allow pipelined execution on one cluster node, which can compute all the parent partitions.</p>
<p>Wide dependencies require data from all parent partitions to be available and shuffled across the nodes using a MapReduce-like operation.</p>
</li>
<li>
<p>Recovery after a node failure is more efficient with a narrow dependency, as only the lost parent partitions need to be recomputed, and they can be recomputed in parallel on different nodes.</p>
<p>In a lineage graph with wide dependencies, a single failed node might cause the loss of some partition from all the ancestors of an RDD, requiring a complete re-execution.</p>
</li>
</ol>
<h2 id="implementation"><a class="markdownIt-Anchor" href="#implementation"></a> Implementation</h2>
<h3 id="how-does-spark-schedule-computations"><a class="markdownIt-Anchor" href="#how-does-spark-schedule-computations"></a> How does Spark schedule computations?</h3>
<ol>
<li>
<p>Whenever a user runs an action on an RDD, the scheduler examines that RDD’s lineage graph to build a DAG of stages to execute.</p>
<ul>
<li>
<p>Each stage contains as many pipelined transformations with narrow dependencies as possible.</p>
</li>
<li>
<p>The boundaries of the stages are the shuffle operations required for wide dependencies or any already computed partitions that can short-circuit the computation of a parent RDD.</p>
</li>
</ul>
</li>
<li>
<p>The scheduler then launches tasks to compute missing partitions from each stage until the target RDD is computed.</p>
<ul>
<li>The scheduler assigns tasks to machines based on data locality using delay scheduling.</li>
<li>If a task needs to process a partition available in memory on a node, we send it to that node.</li>
<li>Otherwise, if a task processes a partition for which the containing RDD provides preferred locations (e.g., an HDFS file), we send it to those.</li>
</ul>
</li>
</ol>
<h3 id="how-does-spark-handle-task-failures"><a class="markdownIt-Anchor" href="#how-does-spark-handle-task-failures"></a> How does Spark handle task failures?</h3>
<ol>
<li>
<p>For wide dependencies, it is possible that those alive workers have long passed the wide-dependent points and already discard intermediate results, causing the stage to become unavailable. In that case, all the dependencies must be re-calculated, which is costly.</p>
</li>
<li>
<p>Hence, intermediate records are materialized on the nodes holding parent partitions to simplify fault recovery.</p>
<ul>
<li>
<p>If a task fails, it will be re-run on another node if its stage’s parents are still available.</p>
</li>
<li>
<p>If some stages have become unavailable, a limited number of tasks to compute the missing partitions are resubmitted in parallel.</p>
</li>
</ul>
</li>
</ol>
<h3 id="how-does-spark-manage-the-storage-of-persistent-rdds"><a class="markdownIt-Anchor" href="#how-does-spark-manage-the-storage-of-persistent-rdds"></a> How does Spark manage the storage of persistent RDDs?</h3>
<ol>
<li>In-memory storage as deserialized Java objects
<ul>
<li>It provides the fastest performance because the Java VM can access each RDD element natively.</li>
</ul>
</li>
<li>In-memory storage as serialized data
<ul>
<li>It lets users choose a more memory-efficient representation than Java object graphs when space is limited, at the cost of lower performance.</li>
</ul>
</li>
<li>On-disk storage
<ul>
<li>It is useful for RDDs that are too large to keep in RAM but costly to recompute on each use.</li>
</ul>
</li>
</ol>
<h3 id="how-does-spark-evict-rdds-when-run-out-of-memory"><a class="markdownIt-Anchor" href="#how-does-spark-evict-rdds-when-run-out-of-memory"></a> How does Spark evict RDDs when run out of memory?</h3>
<ol>
<li>The LRU eviction policy is used at the RDD level.</li>
<li>Unless the LRU RDD is the same RDD as the one with the new partition.
<ul>
<li>The old partition is kept in memory to prevent cycling partitions from the same RDD in and out.</li>
<li>This is important because most operations will run tasks over an entire RDD, so it is likely that the partition already in memory will be needed in the future.</li>
</ul>
</li>
</ol>
<h3 id="when-will-checkpointing-be-useful"><a class="markdownIt-Anchor" href="#when-will-checkpointing-be-useful"></a> When will checkpointing be useful?</h3>
<ol>
<li>Checkpointing is useful for RDDs with long lineage graphs containing wide dependencies.
<ul>
<li>A node failure in the cluster may result in the loss of some slice of data from each parent RDD, requiring a full recomputation.</li>
</ul>
</li>
<li>Checkpointing may never be worthwhile for RDDs with narrow dependencies on data in stable storage.
<ul>
<li>If a node fails, lost partitions from these RDDs can be recomputed in parallel on other nodes at a fraction of the cost of replicating the whole RDD.</li>
</ul>
</li>
<li>The read-only nature of RDDs makes them simpler to checkpoint than general shared memory.
<ul>
<li>Consistency is not a concern. RDDs can be written in the background without program pauses or distributed snapshot schemes.</li>
</ul>
</li>
</ol>
<h1 id="experiment"><a class="markdownIt-Anchor" href="#experiment"></a> Experiment</h1>
<ol>
<li>
<p>The main contribution of this paper is improving the performance of iterative applications; hence, the author measured the speedup of Spark against Hadoop.</p>
<ul>
<li>
<p>One scene of iterative applications is machine learning applications. The author chose k-means and logistic regression to measure performance.</p>
<ul>
<li>The iteration time of k-means is dominated by computation.</li>
<li>Logistic regression is less compute-intensive and thus more sensitive to time spent in deserialization and I/O.</li>
<li>The time consumed should be reported for the first iteration and subsequent iterations separately as follows:</li>
</ul>
<img src="/imgs/Distributed/Spark/ml-base.png" width="50%">
</li>
<li>
<p>Another scene is the PageRank algorithm.</p>
</li>
</ul>
</li>
<li>
<p>Hadoop ran slower due to several factors.</p>
<ul>
<li>Minimum overhead of the Hadoop software stack
<ul>
<li>It can be measured by running no-op Hadoop jobs.</li>
</ul>
</li>
<li>The overhead of HDFS while serving data
<ul>
<li>HDFS performed multiple memory copies and a checksum to serve each block.</li>
<li>This can be seen by comparing the time it takes to access in-memory HDFS and local files.</li>
</ul>
</li>
<li>Deserialization cost to convert binary records to usable in-memory Java objects.
<ul>
<li>This can be seen by comparing the time of access to text and binary input.</li>
</ul>
</li>
</ul>
<img src="/imgs/Distributed/Spark/hadoop.png" width=50%>
</li>
<li>
<p>Scalability is another metric. The result of a machine learning algorithm is as shown below:</p>
<img src="/imgs/Distributed/Spark/ml-scale.png" width="50%">
</li>
<li>
<p>Another important metric of the systems is failure fault recovery.</p>
<ul>
<li>The author measured the time consumed in each iteration while a node failed at the start of 6th iteration.</li>
</ul>
<img src="/imgs/Distributed/Spark/fault-recovery.png" width="50%">
</li>
<li>
<p>Given that Spark assumes that most RDDs will be stored in memory, the author also measured the performance when memory is limited.</p>
<ul>
<li>The performance degrades gracefully with less space.</li>
</ul>
<img src="/imgs/Distributed/Spark/mem-lim.png" width=50%>
</li>
<li>
<p>Given that Spark provides an interactive interpreter, the author also measured the response time thes of those queries.</p>
</li>
<li>
<p>To prove that RDD can support a broad class of applications, the author showed how to use RDDs to express existing programming models (e.g., MapReduce, SQL, Pregel)</p>
</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://liyun-zhang.github.io/2023/09/26/Paper/Distributed/Spanner/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LiyunZhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LiyunZhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LiyunZhang">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/09/26/Paper/Distributed/Spanner/" class="post-title-link" itemprop="url">Spanner</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-09-26 13:47:51" itemprop="dateCreated datePublished" datetime="2023-09-26T13:47:51+08:00">2023-09-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-03-15 15:58:33" itemprop="dateModified" datetime="2024-03-15T15:58:33+08:00">2024-03-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Paper-Notebook/" itemprop="url" rel="index"><span itemprop="name">Paper Notebook</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Paper-Notebook/Distributed-System/" itemprop="url" rel="index"><span itemprop="name">Distributed System</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Paper: <a target="_blank" rel="noopener" href="http://nil.csail.mit.edu/6.824/2020/papers/spanner.pdf">Spanner: Google’s Globally-Distributed Database</a></p>
<p><ul class="markdownIt-TOC">
<li><a href="#abstract">Abstract</a></li>
<li><a href="#purpose">Purpose</a></li>
<li><a href="#model">Model</a>
<ul>
<li><a href="#structure-of-implementation">Structure of implementation</a>
<ul>
<li><a href="#what-is-the-overview-of-the-spanner-server-organization">What is the overview of the Spanner server organization?</a></li>
<li><a href="#what-are-the-zones-in-spanner">What are the zones in Spanner?</a></li>
<li><a href="#software-stack">Software stack</a>
<ul>
<li><a href="#how-does-spanner-manage-key-value-pairs">How does Spanner manage key-value pairs?</a></li>
<li><a href="#how-does-spanner-support-replication">How does Spanner support replication?</a></li>
<li><a href="#how-does-spanner-manage-the-lock-table">How does Spanner manage the lock table?</a></li>
<li><a href="#how-does-spanner-manage-transactions">How does Spanner manage transactions?</a></li>
</ul>
</li>
<li><a href="#data-management">Data management</a>
<ul>
<li><a href="#how-does-spanner-manage-data-placement">How does Spanner manage data placement?</a></li>
<li><a href="#when-would-spanner-move-a-directory">When would Spanner move a directory?</a></li>
<li><a href="#how-does-spanner-move-a-directory">How does Spanner move a directory?</a></li>
<li><a href="#how-do-applications-specify-the-placement-of-data">How do applications specify the placement of data?</a></li>
<li><a href="#what-is-the-data-model-of-spanner">What is the data model of Spanner?</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#truetime-api">TrueTime API</a>
<ul>
<li><a href="#how-does-truetime-api-represent-time">How does TrueTime API represent time?</a></li>
<li><a href="#how-is-truetime-api-implemented">How is TrueTime API implemented?</a></li>
<li><a href="#what-do-time-masters-need-to-do">What do time masters need to do?</a></li>
<li><a href="#what-do-daemons-need-to-do">What do daemons need to do?</a></li>
</ul>
</li>
<li><a href="#concurrency-control">Concurrency control</a>
<ul>
<li><a href="#how-does-spanner-manage-paxos-leader-leases">How does Spanner manage Paxos leader leases?</a></li>
<li><a href="#read-write-transactions">Read-write transactions</a>
<ul>
<li><a href="#how-does-spanner-assign-timestamps-to-rw-transactions">How does Spanner assign timestamps to RW transactions?</a></li>
<li><a href="#how-does-spanner-enforce-external-consistency-invariant">How does Spanner enforce external-consistency invariant?</a></li>
<li><a href="#how-does-spanner-handle-reads-within-rw-transactions">How does Spanner handle reads within RW transactions?</a></li>
<li><a href="#how-does-the-client-drive-a-two-phase-commit">How does the client drive a two-phase commit?</a></li>
<li><a href="#how-to-perform-the-two-phase-commit">How to perform the two-phase commit?</a></li>
</ul>
</li>
<li><a href="#read-only-transactions">Read-only transactions</a>
<ul>
<li><a href="#what-kinds-of-ro-transactions-does-spanner-provide">What kinds of RO transactions does Spanner provide?</a></li>
<li><a href="#how-does-the-spanner-server-read-given-its-timestamp">How does the Spanner server read, given its timestamp?</a></li>
<li><a href="#how-to-optimize-for-the-safe-read-timestamp">How to optimize for the safe read timestamp?</a></li>
<li><a href="#how-to-perform-ro-transactions">How to perform RO transactions?</a></li>
<li><a href="#how-does-spanner-assign-timestamps-to-ro-transactions">How does Spanner assign timestamps to RO transactions?</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#evaluation">Evaluation</a></li>
</ul>
</p>
<h1 id="abstract"><a class="markdownIt-Anchor" href="#abstract"></a> Abstract</h1>
<ol>
<li><strong>Main idea</strong>: Spanner is a semi-relational database that supports MVCC. The TrueTime API is designed to solve the problem of clock skew. All timestamps are represented as an interval, and events are ordered by definitely before or after.</li>
<li><strong>Key findings</strong>: The absolute time of invoking <code>time.Now()</code> is ensured to be contained in the <code>TTInterval</code>. Due to the bias introduced by the clock skew, we must wait until we are sure that a former event has been passed before processing the next event. This could cost transactions waiting for the order determination.</li>
<li><strong>The system</strong>: The database is built upon key-value storage powered by a consensus algorithm to provide strong linearizability. The transaction actions are based on the TrueTime API to solve the problem of clock skew when deployed globally.</li>
<li><strong>Evaluation</strong>: Latency and throughput are chosen as the performance metrics, while different replicas and scalability scenarios are measured.</li>
</ol>
<h1 id="purpose"><a class="markdownIt-Anchor" href="#purpose"></a> Purpose</h1>
<ol>
<li>
<p>Spanner’s primary focus is managing cross-datacenter replicated data.</p>
</li>
<li>
<p>Problems of Bigtable:</p>
<ul>
<li>
<p>Bigtable can be difficult for those with complex, evolving schemas or those who want strong consistency in the presence of wide-area replication.</p>
</li>
<li>
<p>Many applications at Google have chosen to use Megastore because of its semi-relational data model and support for synchronous replication despite its relatively poor write throughput.</p>
</li>
</ul>
</li>
<li>
<p>Spanner new features:</p>
<ul>
<li>
<p>Spanner has evolved from a Bigtable-like versioned key-value store into a temporal multi-version database.</p>
</li>
<li>
<p>Data is stored in schematized semi-relational tables.</p>
<ul>
<li>Data is versioned, and each version is automatically timestamped with its commit time.</li>
<li>Old versions of data are subject to configurable garbage-collection policies.</li>
<li>Applications can read data at old timestamps.</li>
</ul>
</li>
</ul>
</li>
<li>
<p>Spanner assigns globally meaningful commit timestamps to transactions.</p>
<ul>
<li>If a transaction <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">T_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> commits before another transaction <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">T_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> starts, then <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">T_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>’s commit timestamp is smaller than <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">T_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>’s.</li>
<li>Spanner provides externally consistent reads and writes and globally consistent reads across the database at a timestamp.</li>
</ul>
</li>
</ol>
<h1 id="model"><a class="markdownIt-Anchor" href="#model"></a> Model</h1>
<h2 id="structure-of-implementation"><a class="markdownIt-Anchor" href="#structure-of-implementation"></a> Structure of implementation</h2>
<h3 id="what-is-the-overview-of-the-spanner-server-organization"><a class="markdownIt-Anchor" href="#what-is-the-overview-of-the-spanner-server-organization"></a> What is the overview of the Spanner server organization?</h3>
<ol>
<li>A Spanner deployment is called a universe.</li>
<li>Spanner is organized as a set of zones.
<ul>
<li>A zone has one zonemaster and between one hundred and several thousand spanservers.</li>
<li>The zonemaster assigns data to spanservers; the spanservers serve data to clients.</li>
<li>Clients use the per-zone location proxies to locate the spanservers assigned to serve their data.</li>
</ul>
</li>
<li>The universe master is primarily a console that displays status information about all the zones for interactive debugging.</li>
<li>The placement driver handles the automated movement of data across zones on the timescale of minutes.
<ul>
<li>The placement driver periodically communicates with the spanservers to find data that needs to be moved to meet updated replication constraints or balance the load.</li>
</ul>
</li>
<li>The universe master and the placement driver are currently singletons.</li>
</ol>
<img src="/imgs/Distributed/Spanner/structure.png" width="50%">
<h3 id="what-are-the-zones-in-spanner"><a class="markdownIt-Anchor" href="#what-are-the-zones-in-spanner"></a> What are the zones in Spanner?</h3>
<ol>
<li>Each zone is the rough analog of a deployment of Bigtable servers.</li>
<li>Zones are the unit of administrative deployment. The set of zones is also the set of locations across which data can be replicated.</li>
<li>Zones can be added to or removed from a running system as new datacenters are brought into service and old ones are turned off, respectively.</li>
<li>Zones are also the unit of physical isolation. There may be one or more zones in a datacenter.</li>
</ol>
<h3 id="software-stack"><a class="markdownIt-Anchor" href="#software-stack"></a> Software stack</h3>
<img src="/imgs/Distributed/Spanner/software.png" width=50%>
<h4 id="how-does-spanner-manage-key-value-pairs"><a class="markdownIt-Anchor" href="#how-does-spanner-manage-key-value-pairs"></a> How does Spanner manage key-value pairs?</h4>
<ol>
<li>At the bottom, each spanserver is responsible for between 100 and 1000 instances of a data structure called a tablet.</li>
<li>A tablet is similar to Bigtable’s tablet abstraction, which implements a bag of the following mappings: <code>(key: string, timestamp: int64) → string</code>.</li>
<li>Unlike Bigtable, Spanner assigns timestamps to data, which is more like a multi-version database than a key-value store.</li>
<li>A tablet’s state is stored in a set of B-tree-like files and a write-ahead log, all on a distributed file system called Colossus.</li>
</ol>
<h4 id="how-does-spanner-support-replication"><a class="markdownIt-Anchor" href="#how-does-spanner-support-replication"></a> How does Spanner support replication?</h4>
<ol>
<li>Each spanserver implements a single Paxos state machine on top of each tablet.
<ul>
<li>Its Paxos implementation supports long-lived leaders with time-based leader leases, whose length defaults to 10 seconds.</li>
<li>The implementation logs every Paxos write twice: once in the tablet’s and once in the Paxos’ log. (made out of expediency, to be remedied eventually)</li>
<li>The implementation of Paxos is pipelined to improve Spanner’s throughput in the presence of WAN latencies, but Paxos applies the writes in order.</li>
</ul>
</li>
<li>The Paxos state machines implement a consistently replicated bag of mappings.
<ul>
<li>Each state machine stores its metadata and logs in its corresponding tablet.</li>
<li>Writes must initiate the Paxos protocol at the leader; reads access state directly from the underlying tablet at any sufficiently up-to-date replica.</li>
</ul>
</li>
</ol>
<h4 id="how-does-spanner-manage-the-lock-table"><a class="markdownIt-Anchor" href="#how-does-spanner-manage-the-lock-table"></a> How does Spanner manage the lock table?</h4>
<ol>
<li>At every replica that is a leader, each spanserver implements a lock table to implement concurrency control.</li>
<li>The lock table contains the state for two-phase locking: it maps ranges of keys to lock states.</li>
<li>Having a long-lived Paxos leader is critical to efficiently managing the lock table.</li>
</ol>
<h4 id="how-does-spanner-manage-transactions"><a class="markdownIt-Anchor" href="#how-does-spanner-manage-transactions"></a> How does Spanner manage transactions?</h4>
<ol>
<li>
<p>At every replica that is a leader, each spanserver also implements a transaction manager to support distributed transactions.</p>
<ul>
<li>The transaction manager is used to implement a <strong>participant leader</strong>; the other replicas in the group will be referred to as <strong>participant slaves</strong>.</li>
</ul>
</li>
<li>
<p>A transaction involving only one Paxos group can bypass the transaction manager, since the lock table and Paxos together provide transactionality.</p>
</li>
<li>
<p>If a transaction involves more than one Paxos group, those groups’ leaders coordinate to perform a two-phase commit.</p>
<ul>
<li>
<p>One of the participant groups is chosen as the coordinator: the participant leader of that group will be referred to as the <strong>coordinator leader</strong>, and the slaves of that group as <strong>coordinator slaves</strong>.</p>
</li>
<li>
<p>The state of each transaction manager is stored in the underlying Paxos group.</p>
</li>
</ul>
</li>
</ol>
<h3 id="data-management"><a class="markdownIt-Anchor" href="#data-management"></a> Data management</h3>
<h4 id="how-does-spanner-manage-data-placement"><a class="markdownIt-Anchor" href="#how-does-spanner-manage-data-placement"></a> How does Spanner manage data placement?</h4>
<ol>
<li>A <strong>directory</strong> is a set of contiguous keys that share a common prefix.
<ul>
<li>A directory is the unit of data placement. All data in a directory has the same replication configuration.</li>
<li>Directories can be moved while client operations are ongoing.</li>
<li>A Paxos group may contain multiple directories, i.e., a Spanner tablet is a container that may encapsulate multiple partitions of the row space.</li>
</ul>
</li>
<li>Spanner will shard a directory into multiple fragments if it grows too large.
<ul>
<li>Fragments may be served from different Paxos groups.</li>
<li><code>Movedir</code> moves fragments, and not whole directories, between groups.</li>
</ul>
</li>
</ol>
<h4 id="when-would-spanner-move-a-directory"><a class="markdownIt-Anchor" href="#when-would-spanner-move-a-directory"></a> When would Spanner move a directory?</h4>
<ol>
<li>To shed load from a Paxos group.</li>
<li>To put directories that are frequently accessed together into the same group.</li>
<li>To move a directory into a group that is closer to its accessors.</li>
</ol>
<h4 id="how-does-spanner-move-a-directory"><a class="markdownIt-Anchor" href="#how-does-spanner-move-a-directory"></a> How does Spanner move a directory?</h4>
<ol>
<li>Movedir is not implemented as a single transaction to avoid blocking ongoing reads and writes on a bulky data move.</li>
<li>Instead, <code>movedir</code> registers that it is starting to move data and moves the data in the background.</li>
<li>When it has moved all but a nominal amount of the data, it uses a transaction to atomically move that nominal amount and update the metadata for the two Paxos groups.</li>
</ol>
<h4 id="how-do-applications-specify-the-placement-of-data"><a class="markdownIt-Anchor" href="#how-do-applications-specify-the-placement-of-data"></a> How do applications specify the placement of data?</h4>
<ol>
<li>A directory is also the smallest unit whose geographic replication properties can be specified by an application.</li>
<li>Administrators control two dimensions: the number and types of replicas, and the geographic placement of those replicas.
<ul>
<li>They create a menu of named options in these two dimensions.</li>
</ul>
</li>
<li>An application controls how data is replicated by tagging each database and individual directories with a combination of those options.</li>
</ol>
<h4 id="what-is-the-data-model-of-spanner"><a class="markdownIt-Anchor" href="#what-is-the-data-model-of-spanner"></a> What is the data model of Spanner?</h4>
<ol>
<li>
<p>Spanner exposes the following set of data features to applications.</p>
<ul>
<li>A data model based on schematized semi-relational tables</li>
<li>A query language</li>
<li>General purpose transactions</li>
</ul>
</li>
<li>
<p>The application data model is layered on top of the directory-bucketed key-value mappings supported by the implementation.</p>
<ul>
<li>
<p>An application creates one or more databases in a universe.</p>
</li>
<li>
<p>Each database can contain an unlimited number of schematized tables.</p>
</li>
<li>
<p>Tables look like relational-database tables, with rows, columns, and versioned values.</p>
</li>
</ul>
</li>
<li>
<p>Every table must have an ordered set of one or more primary-key columns.</p>
<ul>
<li>The primary keys form the name of a row, and each table defines a mapping from the primary-key columns to the non-primary-key columns.</li>
<li>A row has existence only if some value (even if it is NULL) is defined for the row’s keys.</li>
</ul>
</li>
<li>
<p>Clients must partition every Spanner database into one or more tables in a hierarchical order.</p>
<ul>
<li>Each row in a directory table with key K and all of the rows in descendant tables that start with K in lexicographic order form a directory.</li>
</ul>
</li>
</ol>
<h2 id="truetime-api"><a class="markdownIt-Anchor" href="#truetime-api"></a> TrueTime API</h2>
<h3 id="how-does-truetime-api-represent-time"><a class="markdownIt-Anchor" href="#how-does-truetime-api-represent-time"></a> How does TrueTime API represent time?</h3>
<ol>
<li>
<p>TrueTime explicitly represents time as a <code>TTinterval</code>, an interval with bounded time uncertainty. The endpoints of a <code>TTinterval</code> are of type <code>TTstamp</code>.</p>
</li>
<li>
<p>The <code>TT.now()</code> method returns a <code>TTinterval</code>: <code>[earliest, latest]</code> that is guaranteed to contain the absolute time during which <code>TT.now()</code> was invoked.</p>
<ul>
<li>Denote the absolute time of an event e by the function <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>t</mi><mrow><mi>a</mi><mi>b</mi><mi>s</mi></mrow></msub><mo stretchy="false">(</mo><mi>e</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">t_{abs}(e)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">b</span><span class="mord mathnormal mtight">s</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">e</span><span class="mclose">)</span></span></span></span>.</li>
<li>TrueTime guarantees that for an invocation <code>tt = TT.now()</code>, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mi>t</mi><mi mathvariant="normal">.</mi><mi>e</mi><mi>a</mi><mi>r</mi><mi>l</mi><mi>i</mi><mi>e</mi><mi>s</mi><mi>t</mi><mo>≤</mo><msub><mi>t</mi><mrow><mi>a</mi><mi>b</mi><mi>s</mi></mrow></msub><mo stretchy="false">(</mo><msub><mi>e</mi><mrow><mi>n</mi><mi>o</mi><mi>w</mi></mrow></msub><mo stretchy="false">)</mo><mo>≤</mo><mi>t</mi><mi>t</mi><mi mathvariant="normal">.</mi><mi>l</mi><mi>a</mi><mi>t</mi><mi>e</mi><mi>s</mi><mi>t</mi></mrow><annotation encoding="application/x-tex">tt.earliest ≤ t_{abs}(e_{now}) ≤ tt.latest</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83041em;vertical-align:-0.13597em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">t</span><span class="mord">.</span><span class="mord mathnormal">e</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">i</span><span class="mord mathnormal">e</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">b</span><span class="mord mathnormal mtight">s</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">t</span><span class="mord">.</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">a</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span></span></span></span>, where <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>e</mi><mrow><mi>n</mi><mi>o</mi><mi>w</mi></mrow></msub></mrow><annotation encoding="application/x-tex">e_{now}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> is the invocation event.</li>
</ul>
</li>
<li>
<p><code>TT.after(t)</code> returns <code>true</code> if t has definitely passed.</p>
<p><code>TT.before(t)</code> returns <code>true</code> if t has definitely not arrived.</p>
</li>
</ol>
<h3 id="how-is-truetime-api-implemented"><a class="markdownIt-Anchor" href="#how-is-truetime-api-implemented"></a> How is TrueTime API implemented?</h3>
<ol>
<li>TrueTime is implemented by a set of <strong>time master</strong> machines per datacenter and a <strong>timeslave daemon</strong> per machine.</li>
<li>The majority of masters have GPS receivers with dedicated antennas.
<ul>
<li>These masters are separated physically to reduce the effects of antenna failures, radio interference, and spoofing.</li>
</ul>
</li>
<li>The remaining masters (which we refer to as <strong>Armageddon masters</strong>) are equipped with atomic clocks.</li>
</ol>
<h3 id="what-do-time-masters-need-to-do"><a class="markdownIt-Anchor" href="#what-do-time-masters-need-to-do"></a> What do time masters need to do?</h3>
<ol>
<li>
<p>All masters’ time references are regularly compared against each other.</p>
</li>
<li>
<p>Each master also cross-checks the rate at which its reference advances time against its local clock and evicts itself if there is substantial divergence.</p>
</li>
<li>
<p>Between synchronizations,</p>
<ul>
<li>
<p>Armageddon masters advertise a slowly increasing time uncertainty derived from conservatively applied worst-case clock drift.</p>
</li>
<li>
<p>GPS masters advertise uncertainty that is typically close to zero.</p>
</li>
</ul>
</li>
</ol>
<h3 id="what-do-daemons-need-to-do"><a class="markdownIt-Anchor" href="#what-do-daemons-need-to-do"></a> What do daemons need to do?</h3>
<ol>
<li>Every daemon polls a variety of masters to reduce vulnerability to errors from any one master.
<ul>
<li>Some are GPS masters chosen from nearby datacenters.</li>
<li>The rest are GPS masters from farther datacenters and some Armageddon masters.</li>
</ul>
</li>
<li>Daemons apply a variant of Marzullo’s algorithm to detect and reject liars, and synchronize the local machine clocks to the non-liars.</li>
<li>To protect against broken local clocks, machines that exhibit frequency excursions larger than the worst-case bound derived from component specifications and operating environment are evicted.</li>
<li>Between synchronizations,
<ul>
<li>A daemon advertises a slowly increasing time uncertainty. <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ϵ</mi></mrow><annotation encoding="application/x-tex">\epsilon</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">ϵ</span></span></span></span> is derived from conservatively applied worst-case local clock drift.</li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ϵ</mi></mrow><annotation encoding="application/x-tex">\epsilon</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">ϵ</span></span></span></span> also depends on time-master uncertainty and communication delays to the time masters.</li>
</ul>
</li>
</ol>
<h2 id="concurrency-control"><a class="markdownIt-Anchor" href="#concurrency-control"></a> Concurrency control</h2>
<h3 id="how-does-spanner-manage-paxos-leader-leases"><a class="markdownIt-Anchor" href="#how-does-spanner-manage-paxos-leader-leases"></a> How does Spanner manage Paxos leader leases?</h3>
<ol>
<li>Spanner depends on the <strong>disjointness invariant</strong>: for each Paxos group, each Paxos leader’s lease interval is disjoint from every other leader’s.</li>
<li>The Spanner implementation permits a Paxos leader to abdicate by releasing its slaves from their lease votes.
<ul>
<li>To preserve the disjointness invariant, Spanner constrains when abdication is permissible.</li>
<li>Define <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>s</mi><mrow><mi>m</mi><mi>a</mi><mi>x</mi></mrow></msub></mrow><annotation encoding="application/x-tex">s_{max}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">x</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> to be the maximum timestamp used by a leader. Before abdicating, a leader must wait until <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>T</mi><mi>T</mi><mi mathvariant="normal">.</mi><mi>a</mi><mi>f</mi><mi>t</mi><mi>e</mi><mi>r</mi><mo stretchy="false">(</mo><msub><mi>s</mi><mrow><mi>m</mi><mi>a</mi><mi>x</mi></mrow></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">TT.after(s_{max})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord">.</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">x</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> is true.</li>
</ul>
</li>
</ol>
<h3 id="read-write-transactions"><a class="markdownIt-Anchor" href="#read-write-transactions"></a> Read-write transactions</h3>
<h4 id="how-does-spanner-assign-timestamps-to-rw-transactions"><a class="markdownIt-Anchor" href="#how-does-spanner-assign-timestamps-to-rw-transactions"></a> How does Spanner assign timestamps to RW transactions?</h4>
<ol>
<li>For a given transaction, Spanner assigns the timestamp Paxos assigns to the Paxos write representing the transaction commit.</li>
<li><strong>Monotonicity invariant</strong>: within each Paxos group, Spanner assigns timestamps to Paxos writes in monotonically increasing order, even across leaders.
<ul>
<li>This invariance is enforced across leaders by using the disjointness invariant: a leader must only assign timestamps within the interval of its leader lease.</li>
<li>Whenever a timestamp <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi></mrow><annotation encoding="application/x-tex">s</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">s</span></span></span></span> is assigned, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>s</mi><mrow><mi>m</mi><mi>a</mi><mi>x</mi></mrow></msub></mrow><annotation encoding="application/x-tex">s_{max}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">x</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> is advanced to s to preserve disjointness.</li>
</ul>
</li>
</ol>
<h4 id="how-does-spanner-enforce-external-consistency-invariant"><a class="markdownIt-Anchor" href="#how-does-spanner-enforce-external-consistency-invariant"></a> How does Spanner enforce external-consistency invariant?</h4>
<ol>
<li>
<p><strong>External-consistency invariant</strong>: if the start of a transaction <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">T_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> occurs after the commit of a transaction <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">T_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>, then the commit timestamp of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">T_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> must be greater than the commit timestamp of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">T_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>.</p>
</li>
<li>
<p>Define the start and commit events for a transaction <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">T_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> by <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>e</mi><mi>i</mi><mrow><mi>s</mi><mi>t</mi><mi>a</mi><mi>r</mi><mi>t</mi></mrow></msubsup></mrow><annotation encoding="application/x-tex">e^{start}_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.05222em;vertical-align:-0.258664em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7935559999999999em;"><span style="top:-2.441336em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.258664em;"><span></span></span></span></span></span></span></span></span></span> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>e</mi><mi>i</mi><mrow><mi>c</mi><mi>o</mi><mi>m</mi><mi>m</mi><mi>i</mi><mi>t</mi></mrow></msubsup></mrow><annotation encoding="application/x-tex">e^{commit}_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0833279999999998em;vertical-align:-0.258664em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.824664em;"><span style="top:-2.441336em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.258664em;"><span></span></span></span></span></span></span></span></span></span> ; and the commit timestamp of a transaction <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">T_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> by <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>s</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">s_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>. The invariant becomes <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>t</mi><mrow><mi>a</mi><mi>b</mi><mi>s</mi></mrow></msub><mo stretchy="false">(</mo><msubsup><mi>e</mi><mn>1</mn><mrow><mi>c</mi><mi>o</mi><mi>m</mi><mi>m</mi><mi>i</mi><mi>t</mi></mrow></msubsup><mo stretchy="false">)</mo><mo>&lt;</mo><msub><mi>t</mi><mrow><mi>a</mi><mi>b</mi><mi>s</mi></mrow></msub><mo stretchy="false">(</mo><msubsup><mi>e</mi><mn>2</mn><mrow><mi>s</mi><mi>t</mi><mi>a</mi><mi>r</mi><mi>t</mi></mrow></msubsup><mo stretchy="false">)</mo><mo>⇒</mo><msub><mi>s</mi><mn>1</mn></msub><mo>&lt;</mo><msub><mi>s</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">t_{abs}(e^{commit}_1 ) &lt; t_{abs}(e^{start}_2 ) \Rightarrow s_1 &lt; s_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0746639999999998em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">b</span><span class="mord mathnormal mtight">s</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.824664em;"><span style="top:-2.4518920000000004em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.24810799999999997em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.043556em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">b</span><span class="mord mathnormal mtight">s</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7935559999999999em;"><span style="top:-2.4518920000000004em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.24810799999999997em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">⇒</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.6891em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>.</p>
</li>
<li>
<p>Define the arrival event of the commit request at the coordinator leader for a write <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">T_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> to be <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>e</mi><mi>i</mi><mrow><mi>s</mi><mi>e</mi><mi>r</mi><mi>v</mi><mi>e</mi><mi>r</mi></mrow></msubsup></mrow><annotation encoding="application/x-tex">e^{server}_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.923056em;vertical-align:-0.258664em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-2.441336em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.258664em;"><span></span></span></span></span></span></span></span></span></span>.</p>
</li>
<li>
<p>The protocol for executing transactions and assigning timestamps obeys two rules.</p>
<ul>
<li><strong>Start</strong>: The coordinator leader for a write <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">T_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> assigns a commit timestamp <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>s</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">s_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> no less than the value of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>T</mi><mi>T</mi><mi mathvariant="normal">.</mi><mi>n</mi><mi>o</mi><mi>w</mi><mo stretchy="false">(</mo><mo stretchy="false">)</mo><mi mathvariant="normal">.</mi><mi>l</mi><mi>a</mi><mi>t</mi><mi>e</mi><mi>s</mi><mi>t</mi></mrow><annotation encoding="application/x-tex">TT.now().latest</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord">.</span><span class="mord mathnormal">n</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mopen">(</span><span class="mclose">)</span><span class="mord">.</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">a</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span></span></span></span>, computed after <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>e</mi><mi>i</mi><mrow><mi>s</mi><mi>e</mi><mi>r</mi><mi>v</mi><mi>e</mi><mi>r</mi></mrow></msubsup></mrow><annotation encoding="application/x-tex">e^{server}_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.923056em;vertical-align:-0.258664em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-2.441336em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.258664em;"><span></span></span></span></span></span></span></span></span></span> .</li>
<li><strong>Commit Wait</strong>: The coordinator leader ensures that clients cannot see any data committed by <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">T_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> until <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>T</mi><mi>T</mi><mi mathvariant="normal">.</mi><mi>a</mi><mi>f</mi><mi>t</mi><mi>e</mi><mi>r</mi><mo stretchy="false">(</mo><msub><mi>s</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">TT.after(s_i)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord">.</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> is true.
<ul>
<li>Commit wait ensures that <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>s</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">s_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> is less than the absolute commit time of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">T_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>, or <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>s</mi><mi>i</mi></msub><mo>&lt;</mo><msub><mi>t</mi><mrow><mi>a</mi><mi>b</mi><mi>s</mi></mrow></msub><mo stretchy="false">(</mo><msubsup><mi>e</mi><mi>i</mi><mrow><mi>c</mi><mi>o</mi><mi>m</mi><mi>m</mi><mi>i</mi><mi>t</mi></mrow></msubsup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">s_i &lt; t_{abs}(e^{commit}_i )</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6891em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.0833279999999998em;vertical-align:-0.258664em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">b</span><span class="mord mathnormal mtight">s</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.824664em;"><span style="top:-2.441336em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.258664em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>.</li>
</ul>
</li>
</ul>
</li>
<li>
<p>Proof:</p>
<img src="/imgs/Distributed/Spanner/ec_invariant.png" width="50%">
</li>
</ol>
<h4 id="how-does-spanner-handle-reads-within-rw-transactions"><a class="markdownIt-Anchor" href="#how-does-spanner-handle-reads-within-rw-transactions"></a> How does Spanner handle reads within RW transactions?</h4>
<ol>
<li>Reads in a transaction do not see the effects of the transaction’s writes.
<ul>
<li>Writes that occur in a transaction are buffered at the client until committed.</li>
<li>A read returns the timestamps of any data read, and uncommitted writes still need to be assigned timestamps.</li>
</ul>
</li>
<li>Reads within read-write transactions use wound-wait to avoid deadlocks.
<ul>
<li>If an older transaction requests for a resource held by a younger transaction, then an older transaction forces a younger transaction to kill the transaction and release the resource.
<ul>
<li>The younger transaction is restarted with a minute delay but with the same timestamp.</li>
</ul>
</li>
<li>If the younger transaction requests a resource that an older one holds, the younger transaction is asked to wait until the older one releases it.</li>
</ul>
</li>
</ol>
<h4 id="how-does-the-client-drive-a-two-phase-commit"><a class="markdownIt-Anchor" href="#how-does-the-client-drive-a-two-phase-commit"></a> How does the client drive a two-phase commit?</h4>
<ol>
<li>The client issues reads to the leader replica of the appropriate group, which acquires read locks and then reads the most recent data.</li>
<li>While a client transaction remains open, it sends keepalive messages to prevent participant leaders from timing out its transaction.</li>
<li>A two-phase commit begins when a client has completed all reads and buffered all writes.
<ul>
<li>The client chooses a coordinator group.</li>
<li>Then it sends a commit message to each participant’s leader with the identity of the coordinator and any buffered writes.</li>
</ul>
</li>
<li>Having the client drive a two-phase commit avoids sending data twice across wide-area links.</li>
</ol>
<h4 id="how-to-perform-the-two-phase-commit"><a class="markdownIt-Anchor" href="#how-to-perform-the-two-phase-commit"></a> How to perform the two-phase commit?</h4>
<ol>
<li>A non-coordinator-participant leader,
<ul>
<li>It first acquires write locks.</li>
<li>It then chooses a prepared timestamp that must be larger than any timestamps assigned to previous transactions and logs a prepared record through Paxos.</li>
<li>Each participant then notifies the coordinator of the prepared timestamp.</li>
</ul>
</li>
<li>The coordinator leader,
<ul>
<li>It also first acquires write locks but skips the preparation phase.</li>
<li>After hearing from other participant leaders, a timestamp for the entire transaction is chosen.</li>
<li>The commit timestamp <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi></mrow><annotation encoding="application/x-tex">s</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">s</span></span></span></span> must be
<ul>
<li>Greater or equal to all prepare timestamps,</li>
<li>Greater than <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>T</mi><mi>T</mi><mi mathvariant="normal">.</mi><mi>n</mi><mi>o</mi><mi>w</mi><mo stretchy="false">(</mo><mo stretchy="false">)</mo><mi mathvariant="normal">.</mi><mi>l</mi><mi>a</mi><mi>t</mi><mi>e</mi><mi>s</mi><mi>t</mi></mrow><annotation encoding="application/x-tex">TT.now().latest</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord">.</span><span class="mord mathnormal">n</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mopen">(</span><span class="mclose">)</span><span class="mord">.</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">a</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span></span></span></span> at the time the coordinator received its commit message,</li>
<li>Greater than any timestamps the leader has assigned to previous transactions.</li>
<li>The coordinator leader logs a commit record through Paxos, or an abort if it timed out while waiting on the other participants.</li>
</ul>
</li>
</ul>
</li>
<li>Before allowing any coordinator replica to apply the commit record, the coordinator leader waits until <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>T</mi><mi>T</mi><mi mathvariant="normal">.</mi><mi>a</mi><mi>f</mi><mi>t</mi><mi>e</mi><mi>r</mi><mo stretchy="false">(</mo><mi>s</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">TT.after(s)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord">.</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mopen">(</span><span class="mord mathnormal">s</span><span class="mclose">)</span></span></span></span>.
<ul>
<li>This wait is typically overlapped with Paxos communication.</li>
</ul>
</li>
<li>After the commit wait, the coordinator sends the commit timestamp to the client and all other participant leaders.</li>
<li>Each participant leader logs the transaction’s outcome through Paxos. All participants apply at the same timestamp and then release locks.</li>
</ol>
<h3 id="read-only-transactions"><a class="markdownIt-Anchor" href="#read-only-transactions"></a> Read-only transactions</h3>
<h4 id="what-kinds-of-ro-transactions-does-spanner-provide"><a class="markdownIt-Anchor" href="#what-kinds-of-ro-transactions-does-spanner-provide"></a> What kinds of RO transactions does Spanner provide?</h4>
<ol>
<li>A read-only transaction is a transaction that has the performance benefits of snapshot isolation.
<ul>
<li>Reads in a read-only transaction execute at a system-chosen timestamp without locking, so incoming writes are not blocked.</li>
</ul>
</li>
<li>A snapshot read is a read in the past that executes without locking.
<ul>
<li>A client can specify a timestamp for a snapshot read.</li>
<li>Or they can provide an upper bound on the desired timestamp’s staleness and let Spanner choose a timestamp.</li>
</ul>
</li>
<li>For both read-only transactions and snapshot reads
<ul>
<li>The execution of the reads in a read-only transaction can proceed on any sufficiently up-to-date replica.</li>
<li>Commit is inevitable once a timestamp has been chosen unless the data has been garbage collected.
<ul>
<li>Clients can avoid buffering results inside a retry loop.</li>
<li>When a server fails, clients can internally continue the query on a different server by repeating the timestamp and the current read position.</li>
</ul>
</li>
</ul>
</li>
</ol>
<h4 id="how-does-the-spanner-server-read-given-its-timestamp"><a class="markdownIt-Anchor" href="#how-does-the-spanner-server-read-given-its-timestamp"></a> How does the Spanner server read, given its timestamp?</h4>
<ol>
<li>Every replica tracks a value called safe time <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>t</mi><mrow><mi>s</mi><mi>a</mi><mi>f</mi><mi>e</mi></mrow></msub></mrow><annotation encoding="application/x-tex">t_{safe}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9011879999999999em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span><span class="mord mathnormal mtight">e</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span> which is the maximum timestamp at which a replica is up-to-date.</li>
<li>Each Paxos state machine has a safe time <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>t</mi><mrow><mi>s</mi><mi>a</mi><mi>f</mi><mi>e</mi></mrow><mrow><mi>P</mi><mi>a</mi><mi>x</mi><mi>o</mi><mi>s</mi></mrow></msubsup></mrow><annotation encoding="application/x-tex">t^{Paxos}_{safe}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2605469999999999em;vertical-align:-0.4192159999999999em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-2.4168920000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span><span class="mord mathnormal mtight">e</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">P</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">x</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">s</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4192159999999999em;"><span></span></span></span></span></span></span></span></span></span>.
<ul>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>t</mi><mrow><mi>s</mi><mi>a</mi><mi>f</mi><mi>e</mi></mrow><mrow><mi>P</mi><mi>a</mi><mi>x</mi><mi>o</mi><mi>s</mi></mrow></msubsup></mrow><annotation encoding="application/x-tex">t^{Paxos}_{safe}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2605469999999999em;vertical-align:-0.4192159999999999em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-2.4168920000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span><span class="mord mathnormal mtight">e</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">P</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">x</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">s</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4192159999999999em;"><span></span></span></span></span></span></span></span></span></span> is the timestamp of the highest-applied Paxos write.</li>
<li>Because timestamps increase monotonically and writes are applied in order, writes will no longer occur at or below <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>t</mi><mrow><mi>s</mi><mi>a</mi><mi>f</mi><mi>e</mi></mrow><mrow><mi>P</mi><mi>a</mi><mi>x</mi><mi>o</mi><mi>s</mi></mrow></msubsup></mrow><annotation encoding="application/x-tex">t^{Paxos}_{safe}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2605469999999999em;vertical-align:-0.4192159999999999em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-2.4168920000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span><span class="mord mathnormal mtight">e</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">P</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">x</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">s</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4192159999999999em;"><span></span></span></span></span></span></span></span></span></span> concerning Paxos.</li>
</ul>
</li>
<li>Each transaction manager has a safe time <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>t</mi><mrow><mi>s</mi><mi>a</mi><mi>f</mi><mi>e</mi></mrow><mrow><mi>T</mi><mi>M</mi></mrow></msubsup></mrow><annotation encoding="application/x-tex">t^{TM}_{safe}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2605469999999999em;vertical-align:-0.4192159999999999em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-2.4168920000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span><span class="mord mathnormal mtight">e</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span><span class="mord mathnormal mtight" style="margin-right:0.10903em;">M</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4192159999999999em;"><span></span></span></span></span></span></span></span></span></span>.
<ul>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>t</mi><mrow><mi>s</mi><mi>a</mi><mi>f</mi><mi>e</mi></mrow><mrow><mi>T</mi><mi>M</mi></mrow></msubsup></mrow><annotation encoding="application/x-tex">t^{TM}_{safe}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2605469999999999em;vertical-align:-0.4192159999999999em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-2.4168920000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span><span class="mord mathnormal mtight">e</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span><span class="mord mathnormal mtight" style="margin-right:0.10903em;">M</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4192159999999999em;"><span></span></span></span></span></span></span></span></span></span> is <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">∞</mi></mrow><annotation encoding="application/x-tex">\infty</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord">∞</span></span></span></span> at a replica if there are zero prepared (but not committed) transactions, i.e., transactions between the two phases of a two-phase commit.</li>
<li>If there are any such transactions, then the state affected by those transactions is indeterminate.
<ul>
<li>A participant replica has yet to determine whether such transactions will be committed.</li>
<li>The commit protocol ensures that every participant knows a lower bound on a prepared transaction’s timestamp.</li>
<li>Every participant leader (for a group <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>g</mi></mrow><annotation encoding="application/x-tex">g</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span></span></span></span>) for a transaction <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">T_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> assigns a prepared timestamp <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>s</mi><mrow><mi>i</mi><mo separator="true">,</mo><mi>g</mi></mrow><mrow><mi>p</mi><mi>r</mi><mi>e</mi><mi>p</mi><mi>a</mi><mi>r</mi><mi>e</mi></mrow></msubsup></mrow><annotation encoding="application/x-tex">s^{prepare}_{i,g}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1952720000000001em;vertical-align:-0.412972em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7823em;"><span style="top:-2.4231360000000004em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span></span></span></span><span style="top:-3.1809080000000005em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mord mathnormal mtight">e</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.412972em;"><span></span></span></span></span></span></span></span></span></span> to its prepared record.</li>
<li>The coordinator leader ensures that the transaction’s commit timestamp <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>s</mi><mi>i</mi></msub><mo>≥</mo><msubsup><mi>s</mi><mrow><mi>i</mi><mo separator="true">,</mo><mi>g</mi></mrow><mrow><mi>p</mi><mi>r</mi><mi>e</mi><mi>p</mi><mi>a</mi><mi>r</mi><mi>e</mi></mrow></msubsup></mrow><annotation encoding="application/x-tex">s_i ≥ s^{prepare}_{i,g}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7859700000000001em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≥</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.1952720000000001em;vertical-align:-0.412972em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7823em;"><span style="top:-2.4231360000000004em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span></span></span></span><span style="top:-3.1809080000000005em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mord mathnormal mtight">e</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.412972em;"><span></span></span></span></span></span></span></span></span></span> over participant groups <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>g</mi></mrow><annotation encoding="application/x-tex">g</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span></span></span></span>.</li>
<li>For every replica in a group <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>g</mi></mrow><annotation encoding="application/x-tex">g</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span></span></span></span>, overall transactions <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">T_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> prepared at <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>g</mi></mrow><annotation encoding="application/x-tex">g</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span></span></span></span>, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>t</mi><mrow><mi>s</mi><mi>a</mi><mi>f</mi><mi>e</mi></mrow><mrow><mi>T</mi><mi>M</mi></mrow></msubsup><mo>=</mo><mi>m</mi><mi>i</mi><msub><mi>n</mi><mi>i</mi></msub><mo stretchy="false">(</mo><msubsup><mi>s</mi><mrow><mi>i</mi><mo separator="true">,</mo><mi>g</mi></mrow><mrow><mi>p</mi><mi>r</mi><mi>e</mi><mi>p</mi><mi>a</mi><mi>r</mi><mi>e</mi></mrow></msubsup><mo stretchy="false">)</mo><mtext>−</mtext><mn>1</mn></mrow><annotation encoding="application/x-tex">t^{TM}_{safe} = min_i(s^{prepare}_{i,g}) − 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2605469999999999em;vertical-align:-0.4192159999999999em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-2.4168920000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span><span class="mord mathnormal mtight">e</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span><span class="mord mathnormal mtight" style="margin-right:0.10903em;">M</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4192159999999999em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.1952720000000001em;vertical-align:-0.412972em;"></span><span class="mord mathnormal">m</span><span class="mord mathnormal">i</span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7823em;"><span style="top:-2.4231360000000004em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span></span></span></span><span style="top:-3.1809080000000005em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mord mathnormal mtight">e</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.412972em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mord">−</span><span class="mord">1</span></span></span></span> overall transactions prepared at <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>g</mi></mrow><annotation encoding="application/x-tex">g</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span></span></span></span>.</li>
</ul>
</li>
</ul>
</li>
<li>Define <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>t</mi><mrow><mi>s</mi><mi>a</mi><mi>f</mi><mi>e</mi></mrow></msub><mo>=</mo><mi>m</mi><mi>i</mi><mi>n</mi><mo stretchy="false">(</mo><msubsup><mi>t</mi><mrow><mi>s</mi><mi>a</mi><mi>f</mi><mi>e</mi></mrow><mrow><mi>P</mi><mi>a</mi><mi>x</mi><mi>o</mi><mi>s</mi></mrow></msubsup><mo separator="true">,</mo><msubsup><mi>t</mi><mrow><mi>s</mi><mi>a</mi><mi>f</mi><mi>e</mi></mrow><mrow><mi>T</mi><mi>M</mi></mrow></msubsup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">t_{safe} = min(t^{Paxos}_{safe} , t^{TM}_{safe})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9011879999999999em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span><span class="mord mathnormal mtight">e</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.2605469999999999em;vertical-align:-0.4192159999999999em;"></span><span class="mord mathnormal">m</span><span class="mord mathnormal">i</span><span class="mord mathnormal">n</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-2.4168920000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span><span class="mord mathnormal mtight">e</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">P</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">x</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">s</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4192159999999999em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-2.4168920000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span><span class="mord mathnormal mtight">e</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span><span class="mord mathnormal mtight" style="margin-right:0.10903em;">M</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4192159999999999em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>. A replica can satisfy a read at a timestamp <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi></mrow><annotation encoding="application/x-tex">t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.61508em;vertical-align:0em;"></span><span class="mord mathnormal">t</span></span></span></span> if <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mo>≤</mo><msub><mi>t</mi><mrow><mi>s</mi><mi>a</mi><mi>f</mi><mi>e</mi></mrow></msub></mrow><annotation encoding="application/x-tex">t ≤ t_{safe}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7719400000000001em;vertical-align:-0.13597em;"></span><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.9011879999999999em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span><span class="mord mathnormal mtight">e</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span>.</li>
</ol>
<h4 id="how-to-optimize-for-the-safe-read-timestamp"><a class="markdownIt-Anchor" href="#how-to-optimize-for-the-safe-read-timestamp"></a> How to optimize for the safe read timestamp?</h4>
<ol>
<li>
<p>No reads can occur at timestamps later than <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>t</mi><mrow><mi>s</mi><mi>a</mi><mi>f</mi><mi>e</mi></mrow><mrow><mi>T</mi><mi>M</mi></mrow></msubsup></mrow><annotation encoding="application/x-tex">t^{TM}_{safe}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2605469999999999em;vertical-align:-0.4192159999999999em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-2.4168920000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span><span class="mord mathnormal mtight">e</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span><span class="mord mathnormal mtight" style="margin-right:0.10903em;">M</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4192159999999999em;"><span></span></span></span></span></span></span></span></span></span>, even if the reads do not conflict with the transaction.</p>
<ul>
<li>
<p>This can be removed by augmenting <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>t</mi><mrow><mi>s</mi><mi>a</mi><mi>f</mi><mi>e</mi></mrow><mrow><mi>T</mi><mi>M</mi></mrow></msubsup></mrow><annotation encoding="application/x-tex">t^{TM}_{safe}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2605469999999999em;vertical-align:-0.4192159999999999em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-2.4168920000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span><span class="mord mathnormal mtight">e</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span><span class="mord mathnormal mtight" style="margin-right:0.10903em;">M</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4192159999999999em;"><span></span></span></span></span></span></span></span></span></span> with a fine-grained mapping from key ranges to prepared transaction timestamps.</p>
</li>
<li>
<p>This information can be stored in the lock table, which maps key ranges to lock metadata.</p>
</li>
<li>
<p>When a read arrives, it only needs to be checked against the fine-grained safe time for key ranges with which the read conflicts.</p>
</li>
</ul>
</li>
<li>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>t</mi><mrow><mi>s</mi><mi>a</mi><mi>f</mi><mi>e</mi></mrow><mrow><mi>P</mi><mi>a</mi><mi>x</mi><mi>o</mi><mi>s</mi></mrow></msubsup></mrow><annotation encoding="application/x-tex">t^{Paxos}_{safe}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2605469999999999em;vertical-align:-0.4192159999999999em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-2.4168920000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span><span class="mord mathnormal mtight">e</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">P</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">x</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">s</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4192159999999999em;"><span></span></span></span></span></span></span></span></span></span> cannot advance in the absence of Paxos writes. A snapshot read at <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi></mrow><annotation encoding="application/x-tex">t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.61508em;vertical-align:0em;"></span><span class="mord mathnormal">t</span></span></span></span> cannot execute at Paxos groups whose last write happened before <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi></mrow><annotation encoding="application/x-tex">t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.61508em;vertical-align:0em;"></span><span class="mord mathnormal">t</span></span></span></span>.</p>
<ul>
<li>Spanner addresses this problem by taking advantage of the disjointness of leader-lease intervals.</li>
<li>Each Paxos leader advances <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>t</mi><mrow><mi>s</mi><mi>a</mi><mi>f</mi><mi>e</mi></mrow><mrow><mi>P</mi><mi>a</mi><mi>x</mi><mi>o</mi><mi>s</mi></mrow></msubsup></mrow><annotation encoding="application/x-tex">t^{Paxos}_{safe}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2605469999999999em;vertical-align:-0.4192159999999999em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-2.4168920000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span><span class="mord mathnormal mtight">e</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">P</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">x</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">s</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4192159999999999em;"><span></span></span></span></span></span></span></span></span></span> by keeping a threshold above which future writes’ timestamps will occur.
<ul>
<li>It maintains a mapping <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mi>i</mi><mi>n</mi><mi>N</mi><mi>e</mi><mi>x</mi><mi>t</mi><mi>T</mi><mi>S</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">MinNextTS(n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mord mathnormal">i</span><span class="mord mathnormal">n</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mord mathnormal">e</span><span class="mord mathnormal">x</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span> from Paxos sequence number <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">n</span></span></span></span> to the minimum timestamp that may be assigned to the Paxos sequence number <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">n + 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>.</li>
<li>A replica can advance <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>t</mi><mrow><mi>s</mi><mi>a</mi><mi>f</mi><mi>e</mi></mrow><mrow><mi>P</mi><mi>a</mi><mi>x</mi><mi>o</mi><mi>s</mi></mrow></msubsup></mrow><annotation encoding="application/x-tex">t^{Paxos}_{safe}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2605469999999999em;vertical-align:-0.4192159999999999em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-2.4168920000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span><span class="mord mathnormal mtight">e</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">P</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">x</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">s</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4192159999999999em;"><span></span></span></span></span></span></span></span></span></span> to <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mi>i</mi><mi>n</mi><mi>N</mi><mi>e</mi><mi>x</mi><mi>t</mi><mi>T</mi><mi>S</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo><mtext>−</mtext><mn>1</mn></mrow><annotation encoding="application/x-tex">MinNextTS(n) − 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mord mathnormal">i</span><span class="mord mathnormal">n</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mord mathnormal">e</span><span class="mord mathnormal">x</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mclose">)</span><span class="mord">−</span><span class="mord">1</span></span></span></span> when it has been applied through <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">n</span></span></span></span>.</li>
</ul>
</li>
<li>A single leader can enforce its <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mi>i</mi><mi>n</mi><mi>N</mi><mi>e</mi><mi>x</mi><mi>t</mi><mi>T</mi><mi>S</mi><mo stretchy="false">(</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">MinNextTS()</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mord mathnormal">i</span><span class="mord mathnormal">n</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mord mathnormal">e</span><span class="mord mathnormal">x</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mopen">(</span><span class="mclose">)</span></span></span></span> promises easily.
<ul>
<li>The timestamps promised by <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mi>i</mi><mi>n</mi><mi>N</mi><mi>e</mi><mi>x</mi><mi>t</mi><mi>T</mi><mi>S</mi><mo stretchy="false">(</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">MinNextTS()</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mord mathnormal">i</span><span class="mord mathnormal">n</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mord mathnormal">e</span><span class="mord mathnormal">x</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mopen">(</span><span class="mclose">)</span></span></span></span> lie within a leader’s lease, the disjointness invariant enforces <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mi>i</mi><mi>n</mi><mi>N</mi><mi>e</mi><mi>x</mi><mi>t</mi><mi>T</mi><mi>S</mi><mo stretchy="false">(</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">MinNextTS()</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mord mathnormal">i</span><span class="mord mathnormal">n</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mord mathnormal">e</span><span class="mord mathnormal">x</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mopen">(</span><span class="mclose">)</span></span></span></span> promises across leaders.</li>
<li>If a leader wishes to advance MinNextTS() beyond the end of its leader lease, it must first extend its lease.</li>
</ul>
</li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>s</mi><mrow><mi>m</mi><mi>a</mi><mi>x</mi></mrow></msub></mrow><annotation encoding="application/x-tex">s_{max}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">x</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> is always advanced to the highest value in <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mi>i</mi><mi>n</mi><mi>N</mi><mi>e</mi><mi>x</mi><mi>t</mi><mi>T</mi><mi>S</mi><mo stretchy="false">(</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">MinNextTS()</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mord mathnormal">i</span><span class="mord mathnormal">n</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mord mathnormal">e</span><span class="mord mathnormal">x</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mopen">(</span><span class="mclose">)</span></span></span></span> to preserve disjointness.</li>
</ul>
</li>
</ol>
<h4 id="how-to-perform-ro-transactions"><a class="markdownIt-Anchor" href="#how-to-perform-ro-transactions"></a> How to perform RO transactions?</h4>
<ol>
<li>A read-only transaction executes in two phases.
<ul>
<li>Assign a timestamp <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>s</mi><mrow><mi>r</mi><mi>e</mi><mi>a</mi><mi>d</mi></mrow></msub></mrow><annotation encoding="application/x-tex">s_{read}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">d</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></li>
<li>Then execute the transaction’s reads as snapshot reads at <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>s</mi><mrow><mi>r</mi><mi>e</mi><mi>a</mi><mi>d</mi></mrow></msub></mrow><annotation encoding="application/x-tex">s_{read}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">d</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>.</li>
<li>The snapshot reads can execute at any sufficiently up-to-date replicas.</li>
</ul>
</li>
<li>The simple assignment of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>s</mi><mrow><mi>r</mi><mi>e</mi><mi>a</mi><mi>d</mi></mrow></msub><mo>=</mo><mi>T</mi><mi>T</mi><mi mathvariant="normal">.</mi><mi>n</mi><mi>o</mi><mi>w</mi><mo stretchy="false">(</mo><mo stretchy="false">)</mo><mi mathvariant="normal">.</mi><mi>l</mi><mi>a</mi><mi>t</mi><mi>e</mi><mi>s</mi><mi>t</mi></mrow><annotation encoding="application/x-tex">s_{read} = TT.now().latest</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">d</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord">.</span><span class="mord mathnormal">n</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mopen">(</span><span class="mclose">)</span><span class="mord">.</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">a</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span></span></span></span>
<ul>
<li>At any time after a transaction starts, it preserves external consistency by an argument analogous to that presented for writes.</li>
<li>Such a timestamp may require the execution of the data reads at <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>s</mi><mrow><mi>r</mi><mi>e</mi><mi>a</mi><mi>d</mi></mrow></msub></mrow><annotation encoding="application/x-tex">s_{read}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">d</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> to block if <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>t</mi><mrow><mi>s</mi><mi>a</mi><mi>f</mi><mi>e</mi></mrow></msub></mrow><annotation encoding="application/x-tex">t_{safe}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9011879999999999em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span><span class="mord mathnormal mtight">e</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span> has not advanced sufficiently.</li>
</ul>
</li>
<li>To reduce the chances of blocking, Spanner should assign the oldest timestamp that preserves external consistency.</li>
</ol>
<h4 id="how-does-spanner-assign-timestamps-to-ro-transactions"><a class="markdownIt-Anchor" href="#how-does-spanner-assign-timestamps-to-ro-transactions"></a> How does Spanner assign timestamps to RO transactions?</h4>
<ol>
<li>Assigning a timestamp requires a negotiation phase between all Paxos groups involved in the reads.</li>
<li>Spanner requires a scope expression for every read-only transaction, which summarizes the keys the entire transaction will read.</li>
<li>If a single Paxos group serves the scope’s values
<ul>
<li>The client issues the read-only transaction to that group’s leader. That leader assigns <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>s</mi><mrow><mi>r</mi><mi>e</mi><mi>a</mi><mi>d</mi></mrow></msub></mrow><annotation encoding="application/x-tex">s_{read}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">d</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> and executes the read.</li>
<li>Define <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mi>a</mi><mi>s</mi><mi>t</mi><mi>T</mi><mi>S</mi><mo stretchy="false">(</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">LastTS()</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">L</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mopen">(</span><span class="mclose">)</span></span></span></span> to be the timestamp of the last committed to write at a Paxos group.</li>
<li>If there are no prepared transactions, the assignment <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>s</mi><mrow><mi>r</mi><mi>e</mi><mi>a</mi><mi>d</mi></mrow></msub><mo>=</mo><mi>L</mi><mi>a</mi><mi>s</mi><mi>t</mi><mi>T</mi><mi>S</mi><mo stretchy="false">(</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">s_{read} = LastTS()</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">d</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">L</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mopen">(</span><span class="mclose">)</span></span></span></span> trivially satisfies external consistency: the transaction will see the result of the last write and be ordered after it.</li>
</ul>
</li>
<li>If multiple Paxos groups serve the scope’s values
<ul>
<li>The most complicated option is to do a round of communication with all of the groups’s leaders to negotiate <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>s</mi><mrow><mi>r</mi><mi>e</mi><mi>a</mi><mi>d</mi></mrow></msub></mrow><annotation encoding="application/x-tex">s_{read}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">d</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> based on <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mi>a</mi><mi>s</mi><mi>t</mi><mi>T</mi><mi>S</mi><mo stretchy="false">(</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">LastTS()</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">L</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mopen">(</span><span class="mclose">)</span></span></span></span>.</li>
<li>A more straightforward choice is that the client avoids a negotiation round and has its reads executed at <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>s</mi><mrow><mi>r</mi><mi>e</mi><mi>a</mi><mi>d</mi></mrow></msub><mo>=</mo><mi>T</mi><mi>T</mi><mi mathvariant="normal">.</mi><mi>n</mi><mi>o</mi><mi>w</mi><mo stretchy="false">(</mo><mo stretchy="false">)</mo><mi mathvariant="normal">.</mi><mi>l</mi><mi>a</mi><mi>t</mi><mi>e</mi><mi>s</mi><mi>t</mi></mrow><annotation encoding="application/x-tex">s_{read} = TT.now().latest</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">d</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord">.</span><span class="mord mathnormal">n</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mopen">(</span><span class="mclose">)</span><span class="mord">.</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">a</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span></span></span></span>.</li>
</ul>
</li>
<li>If a transaction has just been committed, a non-conflicting read-only transaction must still be assigned <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>s</mi><mrow><mi>r</mi><mi>e</mi><mi>a</mi><mi>d</mi></mrow></msub></mrow><annotation encoding="application/x-tex">s_{read}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">d</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> to follow that transaction.
<ul>
<li>This weakness can be remedied by augmenting <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mi>a</mi><mi>s</mi><mi>t</mi><mi>T</mi><mi>S</mi><mo stretchy="false">(</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">LastTS()</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">L</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mopen">(</span><span class="mclose">)</span></span></span></span> with a fine-grained mapping from key ranges to commit timestamps in the lock table.</li>
<li>When a read-only transaction arrives, its timestamp can be assigned by taking the maximum value of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mi>a</mi><mi>s</mi><mi>t</mi><mi>T</mi><mi>S</mi><mo stretchy="false">(</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">LastTS()</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">L</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mopen">(</span><span class="mclose">)</span></span></span></span> for the key ranges with which the transaction conflicts unless there is a conflicting prepared transaction.</li>
</ul>
</li>
</ol>
<h1 id="evaluation"><a class="markdownIt-Anchor" href="#evaluation"></a> Evaluation</h1>
<ol>
<li>
<p>For the performance experiment, the author tested for the two common benchmarks: latency and throughput.</p>
<ul>
<li>
<p>For the latency experiments, clients issued sufficiently few operations to avoid queuing at the servers.</p>
</li>
<li>
<p>For the throughput experiments, clients issued enough operations to saturate the servers’ CPUs.</p>
</li>
<li>
<p>The result is as shown below. 1D means one replica with commit wait disabled.</p>
</li>
<li>
<p>As the number of replicas increases,</p>
<ul>
<li>The latency stays roughly constant with less standard deviation because Paxos executes in parallel at a group’s replicas. Hence, the latency to achieve a quorum becomes less sensitive to slowness at one slave replica.</li>
</ul>
<img src="/imgs/Distributed/Spanner/performance.png" width="75%">
</li>
</ul>
</li>
<li>
<p>The author also tested the scalability of the two-phase commit.</p>
<img src="/imgs/Distributed/Spanner/2pc.png" width=50%>
</li>
<li>
<p>The availability after server failure is another important metric.</p>
<ul>
<li>
<p>Non-leader killing does not affect read throughput.</p>
</li>
<li>
<p>Killing leaders while giving time to handoff leadership to a different zone has a minor effect around <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>3</mn><mo>−</mo><mn>4</mn><mi mathvariant="normal">%</mi></mrow><annotation encoding="application/x-tex">3-4\%</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">3</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.80556em;vertical-align:-0.05556em;"></span><span class="mord">4</span><span class="mord">%</span></span></span></span>.</p>
</li>
<li>
<p>Killing leaders with no warning has a severe effect: the rate of completion drops almost to <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span>.</p>
<img src="/imgs/Distributed/Spanner/availability.png" width="50%">
</li>
</ul>
</li>
<li>
<p>The uncertainty of TrueTime would affect Spanner’s reliability.</p>
</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://liyun-zhang.github.io/2023/09/26/Paper/Distributed/2-Phase-Commit/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LiyunZhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LiyunZhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LiyunZhang">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/09/26/Paper/Distributed/2-Phase-Commit/" class="post-title-link" itemprop="url">2-Phase Commit</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-09-26 13:45:59" itemprop="dateCreated datePublished" datetime="2023-09-26T13:45:59+08:00">2023-09-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-03-15 16:54:46" itemprop="dateModified" datetime="2024-03-15T16:54:46+08:00">2024-03-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Paper-Notebook/" itemprop="url" rel="index"><span itemprop="name">Paper Notebook</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Paper-Notebook/Distributed-System/" itemprop="url" rel="index"><span itemprop="name">Distributed System</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><ul class="markdownIt-TOC">
<li><a href="#before-or-after-atomicity">Before-or-After Atomicity</a>
<ul>
<li><a href="#what-is-before-or-after-atomicity">What is before-or-after atomicity?</a></li>
<li><a href="#what-is-the-problem-of-before-or-after-atomicity">What is the problem of before-or-after atomicity?</a></li>
<li><a href="#what-kind-of-coordination-is-correct">What kind of coordination is correct?</a></li>
</ul>
</li>
<li><a href="#locking-disciplines">Locking disciplines</a>
<ul>
<li><a href="#simple-locking">Simple locking</a>
<ul>
<li><a href="#what-are-the-rules-of-simple-locking">What are the rules of simple locking?</a></li>
<li><a href="#what-is-the-lock-point-and-lock-set-of-a-transaction">What is the lock point and lock set of a transaction?</a></li>
<li><a href="#how-can-we-implement-a-lock-manager">How can we implement a lock manager?</a></li>
<li><a href="#how-to-argue-the-correctness-of-simple-locking">How to argue the correctness of simple locking?</a></li>
</ul>
</li>
<li><a href="#two-phase-locking">Two-phase locking</a>
<ul>
<li><a href="#what-are-the-rules-of-two-phase-locking">What are the rules of two-phase locking?</a></li>
<li><a href="#how-can-we-implement-the-lock-manager">How can we implement the lock manager?</a></li>
<li><a href="#how-do-locks-interact-with-log-based-recovery">How do locks interact with log-based recovery?</a></li>
</ul>
</li>
<li><a href="#distributed-two-phase-commit">Distributed two-phase commit</a>
<ul>
<li><a href="#what-is-correct-in-multi-site-transactions">What is correct in multi-site transactions?</a></li>
<li><a href="#what-is-the-problem-of-multi-site-transactions">What is the problem of multi-site transactions?</a></li>
<li><a href="#what-are-the-steps-of-the-distributed-two-phase-commit-protocol">What are the steps of the distributed two-phase commit protocol?</a></li>
<li><a href="#how-to-handle-the-lost-delayed-or-duplicated-message-problem">How to handle the lost, delayed, or duplicated message problem?</a></li>
<li><a href="#how-does-a-worker-site-recover-from-crashes">How does a worker site recover from crashes?</a></li>
<li><a href="#how-can-we-optimize-the-protocol">How can we optimize the protocol?</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</p>
<h1 id="before-or-after-atomicity"><a class="markdownIt-Anchor" href="#before-or-after-atomicity"></a> Before-or-After Atomicity</h1>
<h2 id="what-is-before-or-after-atomicity"><a class="markdownIt-Anchor" href="#what-is-before-or-after-atomicity"></a> What is before-or-after atomicity?</h2>
<ol>
<li>
<p>The before-or-after property states that several actions that concurrently operate on the same data should not interfere with one another.</p>
</li>
<li>
<p>Concurrent actions have the before-or-after property if their effect from the point of view of their invokers is the same as if the actions occurred either completely before or completely after one another.</p>
</li>
</ol>
<h2 id="what-is-the-problem-of-before-or-after-atomicity"><a class="markdownIt-Anchor" href="#what-is-the-problem-of-before-or-after-atomicity"></a> What is the problem of before-or-after atomicity?</h2>
<ol>
<li>The programmer does not necessarily know the identities of all the other actions that might touch the shared vari­able.</li>
<li>This lack of knowledge can make coordinating actions by explicit program steps problematic.</li>
<li>Instead, the programmer needs an automatic, implicit mechanism that ensures proper handling of every shared variable.</li>
</ol>
<h2 id="what-kind-of-coordination-is-correct"><a class="markdownIt-Anchor" href="#what-kind-of-coordination-is-correct"></a> What kind of coordination is correct?</h2>
<ol>
<li>Coordination among concurrent actions can be considered correct if every result is guaranteed to be one that could have been obtained by some purely serial application of those same actions.</li>
<li>As long as the intermediate states are not visible above the implementing layer, and the system is guaranteed to end up in one of the acceptable final states, we can declare the coordination correct.</li>
</ol>
<h1 id="locking-disciplines"><a class="markdownIt-Anchor" href="#locking-disciplines"></a> Locking disciplines</h1>
<h2 id="simple-locking"><a class="markdownIt-Anchor" href="#simple-locking"></a> Simple locking</h2>
<h3 id="what-are-the-rules-of-simple-locking"><a class="markdownIt-Anchor" href="#what-are-the-rules-of-simple-locking"></a> What are the rules of simple locking?</h3>
<ol>
<li>Each transaction must acquire a lock for every shared data object it intends to read or write before doing any actual reading and writing.</li>
<li>It may release its locks only after the transaction installs its last update and commits or completely restores the data and aborts.</li>
<li>Applications that discover which objects need to be read by reading other shared data objects have no alter­ native but to lock every object that they might need to read.</li>
</ol>
<h3 id="what-is-the-lock-point-and-lock-set-of-a-transaction"><a class="markdownIt-Anchor" href="#what-is-the-lock-point-and-lock-set-of-a-transaction"></a> What is the lock point and lock set of a transaction?</h3>
<ol>
<li><em>Lock point</em>: the first instant at which it acquired all its locks.</li>
<li><em>Lock set</em>: The collection of locks it has acquired when it reaches its lock point.</li>
</ol>
<h3 id="how-can-we-implement-a-lock-manager"><a class="markdownIt-Anchor" href="#how-can-we-implement-a-lock-manager"></a> How can we implement a lock manager?</h3>
<ol>
<li>
<p>Acquire locks</p>
<ul>
<li>
<p>Each transaction supplies its intended lock set as an argu­ment to the <strong>begin_transaction</strong> operation, which acquires all locks of the lock set, if necessary, waiting for them to become available.</p>
<ul>
<li>Interpose itself on all calls to read data and log changes, and verify that they refer to variables in the lock set.</li>
</ul>
</li>
</ul>
</li>
<li>
<p>Release locks</p>
<ul>
<li>Intercept the call to <em>commit</em> or <em>abort</em> (or, if the application uses roll-forward recovery, to log an <em>END</em> record), at which time it auto­matically releases all of the locks of the lock set.</li>
</ul>
</li>
</ol>
<h3 id="how-to-argue-the-correctness-of-simple-locking"><a class="markdownIt-Anchor" href="#how-to-argue-the-correctness-of-simple-locking"></a> How to argue the correctness of simple locking?</h3>
<ol>
<li>Imagine that an all-seeing outside observer maintains an ordered list to which it adds each transaction identifier as soon as the transaction reaches its lock point and removes it from the list when it begins to release its locks.</li>
<li>Each transaction has agreed not to read or write anything until that transaction has been added to the observer’s list.</li>
<li>Since no data object can appear in the lock sets of two transactions, no data object in any transaction’s lock set appears in the lock set of the transaction preceding it in the list and by induction to any transaction earlier in the list.</li>
<li>Thus, all of this transaction’s input values are the same as they will be when the preceding transaction in the list commits or aborts.</li>
<li>The same argument applies to the transaction before the preceding one, so all inputs to any trans­ action are identical to the inputs that would be available if all the transactions ahead of it in the list ran serially, in the order of the list.</li>
<li>Thus, the simple locking discipline ensures that this transaction runs completely after the preceding one and completely before the next.</li>
<li>Concurrent transactions will produce results as if they had been serialized in the order that they reached their lock points.</li>
</ol>
<h2 id="two-phase-locking"><a class="markdownIt-Anchor" href="#two-phase-locking"></a> Two-phase locking</h2>
<h3 id="what-are-the-rules-of-two-phase-locking"><a class="markdownIt-Anchor" href="#what-are-the-rules-of-two-phase-locking"></a> What are the rules of two-phase locking?</h3>
<ol>
<li>It avoids the requirement that a transaction must know which locks to acquire in advance.</li>
<li>The two-phase locking discipline allows a transaction to acquire locks as it proceeds, and the trans­ action may read or write a data object as soon as it acquires a lock on that object.</li>
<li>The primary constraint is that the transaction may not release any locks until it passes its lock point.</li>
<li>The transaction can release a lock on an object that it only reads after it reaches its lock point if it will never need to read that object again, even to abort.</li>
</ol>
<h3 id="how-can-we-implement-the-lock-manager"><a class="markdownIt-Anchor" href="#how-can-we-implement-the-lock-manager"></a> How can we implement the lock manager?</h3>
<ol>
<li>Intercept all calls to read and write data; it acquires a lock (perhaps having to wait) on the first use of each shared variable.</li>
<li>As with simple locking, it then holds the locks until it intercepts the call to <em>commit</em>, <em>abort</em>, or log the <em>END</em> record of the transaction, at which time it releases them all at once.</li>
</ol>
<h3 id="how-do-locks-interact-with-log-based-recovery"><a class="markdownIt-Anchor" href="#how-do-locks-interact-with-log-based-recovery"></a> How do locks interact with log-based recovery?</h3>
<ol>
<li>
<p>Whether locks themselves are data objects for which changes should be logged?</p>
<ul>
<li>
<p>After crash recovery, there should be no pending transactions because the recovery procedure should have rolled back any pending transactions at the time of the crash, and recov­ery does not allow any new transactions to begin until it completes.</p>
</li>
<li>
<p>Since locks exist only to coordinate pending transactions, it would be an error if locks were still set when crash recovery is complete.</p>
</li>
<li>
<p>Locks belong in vol­atile storage, where they will automatically disappear on a crash, rather than in non­-volatile storage, where the recovery procedure would have to hunt them down to release them.</p>
</li>
</ul>
</li>
<li>
<p>Will the log-based recovery algorithm construct a correct system state?</p>
<ul>
<li>The incomplete transactions at the instant of the crash had nonoverlapping lock sets when the lock values vanished.</li>
<li>Those actions can safely be redone or undone without con­ cern for before-or-after atomicity during recovery.</li>
<li>The locks created a particular transaction serialization, and the log captured that serialization.</li>
<li>Since <em>RECOVER</em> performs <em>UNDO</em> actions in reverse order as specified in the log, and it per­ forms <em>REDO</em> actions in forward order, again as specified in the log, <em>RECOVER</em> reconstructs exactly that same serialization.</li>
</ul>
</li>
</ol>
<h2 id="distributed-two-phase-commit"><a class="markdownIt-Anchor" href="#distributed-two-phase-commit"></a> Distributed two-phase commit</h2>
<h3 id="what-is-correct-in-multi-site-transactions"><a class="markdownIt-Anchor" href="#what-is-correct-in-multi-site-transactions"></a> What is correct in multi-site transactions?</h3>
<ol>
<li>Correctness of the multiple-site ato­micity protocol will be achieved if all the sites commit or if all the sites abort.</li>
<li>It fails if some sites commit their part of a multiple-site transaction while others abort their part of that same transaction.</li>
</ol>
<h3 id="what-is-the-problem-of-multi-site-transactions"><a class="markdownIt-Anchor" href="#what-is-the-problem-of-multi-site-transactions"></a> What is the problem of multi-site transactions?</h3>
<ol>
<li>The coordinator has created a higher-layer transaction, and each worker is to perform a transaction nested in the higher-layer transaction.</li>
<li>The complication is that the coordinator and workers cannot reliably communicate.</li>
<li>The problem thus reduces to constructing a reliable distributed version of the two-phase commit protocol. We can do that by applying persistent senders and duplicate suppression.</li>
</ol>
<h3 id="what-are-the-steps-of-the-distributed-two-phase-commit-protocol"><a class="markdownIt-Anchor" href="#what-are-the-steps-of-the-distributed-two-phase-commit-protocol"></a> What are the steps of the distributed two-phase commit protocol?</h3>
<ol>
<li>
<p>Beginning</p>
<ul>
<li>
<p>The coordinator creates a top-layer outcome record for the overall transaction.</p>
</li>
<li>
<p>It persistently sends the content of sub-transactions to each site, referring to the same transaction, respectively.</p>
</li>
<li>
<p>Upon receiving a request, a worker site checks for duplicates and then creates a transaction of its own. Still, it makes the transaction nested, with its superior being the coordinator’s original transaction.</p>
</li>
<li>
<p>Then, the worker site does the pre-commit part of the requested action, reporting back to the coordinator that this has gone well.</p>
</li>
</ul>
</li>
<li>
<p>Two-phase commit</p>
<ul>
<li>Phase one:
<ul>
<li>Upon collecting a complete set of such responses, the coordinator then moves to the two-phase commit part of the transaction by sending <code>PREPARE</code> messages to each worker site.</li>
<li>Upon receiving this message, each worker site commits—but only tentatively—or aborts.</li>
<li>Having created durable tentative versions (or logged to journal storage its planned updates) and having recorded an outcome record saying that it is <code>PREPARED</code> either to commit or abort, worker sites persistently send a response to the coordinator of commit or abort.</li>
<li>If all workers send PREPARED messages, phase one of the two-phase commit is complete.</li>
<li>Suppose any worker responds with an abort message or doesn’t respond at all. In that case, the coordinator can abort the entire transaction or try a different worker site to carry out that component transaction.</li>
</ul>
</li>
<li>Phase two:
<ul>
<li>The coordinator commits the entire transaction by marking its outcome record as <code>COMMITTED</code>.</li>
<li>It sends a completion message back to each worker site.</li>
<li>Upon receiving such a message, each worker site changes its state from <code>PREPARED</code> to <code>COM­MITTED</code>, performs any needed post-commit actions, and exits.</li>
</ul>
</li>
</ul>
</li>
</ol>
<h3 id="how-to-handle-the-lost-delayed-or-duplicated-message-problem"><a class="markdownIt-Anchor" href="#how-to-handle-the-lost-delayed-or-duplicated-message-problem"></a> How to handle the lost, delayed, or duplicated message problem?</h3>
<ol>
<li>Suppose the coordinator doesn’t receive a response to a ready message of some sub-transaction request from one or more of the workers in a reasonable time. In that case, she resends the message to the non-responding workers as often as necessary to elicit a response.</li>
<li>If a worker site receives a duplicate request of <code>PREPARE</code> from the coordinator, its persistent sender sends back a duplicate of the <code>PREPARED</code> or <code>ABORTED</code> response.</li>
<li>If the coordinator goes down before the coordinator sends the final COMMITTED message in phase two, all of the workers must wait until it recovers; in this protocol, the coordinator is a single point of failure.</li>
<li>The coordinator must remem­ ber, reliably and for an indefinite time, the outcome of this transaction.
<ul>
<li>If a completion message does not arrive in a reasonable period, the persistent sender at the worker site will resend its <code>PREPARED</code> message.</li>
<li>Whenever the coordinator receives a duplicate <code>PREPARED</code> message, it simply sends back the current state of the outcome record for the named transaction.</li>
</ul>
</li>
</ol>
<h3 id="how-does-a-worker-site-recover-from-crashes"><a class="markdownIt-Anchor" href="#how-does-a-worker-site-recover-from-crashes"></a> How does a worker site recover from crashes?</h3>
<ol>
<li>It must classify any <code>PREPARED</code> transaction as a tentative win­ner that it should restore to the <code>PREPARED</code> state.</li>
<li>If the worker uses locks for before-or-after atomicity, the recovery procedure must reacquire any locks the PREPARED transaction held at the time of the failure.</li>
<li>The recovery procedure must restart the persistent sender to learn the current status of the higher-layer transaction.</li>
<li>If the worker site uses version histories, only the last step, restarting the persistent sender, is required.</li>
<li>Other servers will commit if the worker site crashes after sending PREPARED before receiving COMMIT. So we want server recovery as <code>PREPARED</code>. So before sending <code>PREPARED</code>, servers need to make their log durable.</li>
</ol>
<h3 id="how-can-we-optimize-the-protocol"><a class="markdownIt-Anchor" href="#how-can-we-optimize-the-protocol"></a> How can we optimize the protocol?</h3>
<ol>
<li>The initial RPC request and response could also carry the PREPARE and PREPARED messages.
<ul>
<li>Once a worker sends a <code>PREPARED</code> message, it loses the ability to abort unilaterally, and it must remain on the knife edge, awaiting instructions from the coordinator.</li>
<li>To minimize this wait, delaying the PREPARE/PREPARED message pair is usually preferable until the coordinator knows that the other workers seem to be in a position to do their parts.</li>
</ul>
</li>
<li>Have a fourth acknowl­edgment message from the worker sites to the coordinator.
<ul>
<li>Once all acknowledgments are in, the coordinator can then safely discard its outcome record since every worker site is known to have gotten the word.</li>
</ul>
</li>
<li>Presumed commit: The coordi­nator answers any inquiry about a non-existent outcome record by sending a <code>COMMITTED</code> response.
<ul>
<li>The coordinator commits by destroying the out­come record, so a fourth acknowledgment message from every worker is unnecessary.</li>
<li>The coor­dinator can persistently ask for acknowledgment of aborted transactions and discard the outcome record after all these acknowledgments are in.</li>
</ul>
</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://liyun-zhang.github.io/2023/09/26/Paper/Distributed/Aurora/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LiyunZhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LiyunZhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LiyunZhang">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/09/26/Paper/Distributed/Aurora/" class="post-title-link" itemprop="url">Aurora</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-09-26 13:28:51" itemprop="dateCreated datePublished" datetime="2023-09-26T13:28:51+08:00">2023-09-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-03-15 17:08:34" itemprop="dateModified" datetime="2024-03-15T17:08:34+08:00">2024-03-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Paper-Notebook/" itemprop="url" rel="index"><span itemprop="name">Paper Notebook</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Paper-Notebook/Distributed-System/" itemprop="url" rel="index"><span itemprop="name">Distributed System</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Paper: <a target="_blank" rel="noopener" href="http://nil.csail.mit.edu/6.824/2020/papers/aurora.pdf">Amazon Aurora: Design Considerations for High Throughput Cloud-Native Relational Databases</a></p>
<p><ul class="markdownIt-TOC">
<li><a href="#purpose">Purpose</a></li>
<li><a href="#model">Model</a>
<ul>
<li><a href="#background-conceptions-of-aws">Background conceptions of AWS</a></li>
<li><a href="#durability-at-scale">Durability at scale</a>
<ul>
<li><a href="#how-does-aurora-tolerate-failures">How does Aurora tolerate failures?</a></li>
<li><a href="#how-does-aurora-shrink-the-window-of-vulnerability">How does Aurora shrink the window of vulnerability?</a></li>
<li><a href="#what-are-the-problems-of-the-io-volume-of-mirrored-mysql">What are the problems of the I/O volume of mirrored MySQL?</a></li>
<li><a href="#how-does-aurora-reduce-network-traffic">How does Aurora reduce network traffic?</a></li>
<li><a href="#logs">Logs</a></li>
<li><a href="#how-does-aurora-decide-what-is-completed-and-what-is-durable">How does Aurora decide what is completed and what is durable?</a></li>
<li><a href="#how-does-the-database-and-storage-interact">How does the database and storage interact?</a></li>
<li><a href="#how-does-the-database-write-data">How does the database write data?</a></li>
<li><a href="#how-does-the-database-commit-transactions">How does the database commit transactions?</a></li>
<li><a href="#where-does-the-database-read">Where does the database read?</a></li>
<li><a href="#how-does-the-database-read">How does the database read?</a></li>
<li><a href="#how-does-the-database-replicate">How does the database replicate?</a></li>
<li><a href="#how-does-the-database-perform-undo-and-redo">How does the database perform undo and redo?</a></li>
<li><a href="#how-does-the-database-reestablish-the-runtime-state">How does the database reestablish the runtime state?</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</p>
<h1 id="purpose"><a class="markdownIt-Anchor" href="#purpose"></a> Purpose</h1>
<ol>
<li>Aurora is a relational database service for OLTP workloads.</li>
<li>Issue:
<ul>
<li>In modern distributed cloud services, resilience and scalability are increasingly achieved by decoupling computing from storage and replicating storage across multiple nodes.</li>
<li>The central constraint in high throughput data processing has moved from computing and storage to the network.</li>
</ul>
</li>
<li>Contribution:
<ul>
<li>Build storage as an independent fault-tolerant and self-healing service across multiple datacenters.
<ul>
<li>Protect the database from performance variance and transient or permanent failures at either the networking or storage tiers.</li>
</ul>
</li>
<li>Only write redo log records to storage.
<ul>
<li>Reduce network IOPS by an order of magnitude.</li>
<li>When the bottleneck is removed, the system’s scalability is greatly improved. And they can aggressively optimize numerous other points of contention.</li>
</ul>
</li>
<li>Move some of the most complex and critical functions (backup and redo recovery) from one-time expensive operations in the database engine to continuous asynchronous operations amortized across a large distributed fleet.
<ul>
<li>This yields near-instant crash recovery without checkpointing and inexpensive backups that do not interfere with foreground processing.</li>
</ul>
</li>
<li>Also, it achieves consensus on a durable state across numerous storage nodes using an efficient asynchronous scheme, avoiding expensive and chatty recovery protocols.</li>
</ul>
</li>
</ol>
<h1 id="model"><a class="markdownIt-Anchor" href="#model"></a> Model</h1>
<h2 id="background-conceptions-of-aws"><a class="markdownIt-Anchor" href="#background-conceptions-of-aws"></a> Background conceptions of AWS</h2>
<h2 id="durability-at-scale"><a class="markdownIt-Anchor" href="#durability-at-scale"></a> Durability at scale</h2>
<h3 id="how-does-aurora-tolerate-failures"><a class="markdownIt-Anchor" href="#how-does-aurora-tolerate-failures"></a> How does Aurora tolerate failures?</h3>
<ol>
<li>It uses a quorum-based voting protocol. The ordinary quorum voting protocol is as follows:
<ul>
<li>If each of the <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi></mrow><annotation encoding="application/x-tex">V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span> copies of a replicated data item are assigned a vote; a read must obtain a quorum of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>V</mi><mi>r</mi></msub></mrow><annotation encoding="application/x-tex">V_r</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.22222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> votes, while a writer must obtain a quorum of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>V</mi><mi>w</mi></msub></mrow><annotation encoding="application/x-tex">V_w</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.22222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> votes.</li>
<li>Each read must be aware of the most recent write, formulated as <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>V</mi><mi>r</mi></msub><mo>+</mo><msub><mi>V</mi><mi>w</mi></msub><mo>&gt;</mo><mi>V</mi></mrow><annotation encoding="application/x-tex">V_r + V_w &gt; V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.22222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.22222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span>.</li>
<li>Each write must be aware of the most recent write to avoid conflicting writes, formulated as <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>V</mi><mi>w</mi></msub><mo>&gt;</mo><mi>V</mi><mi mathvariant="normal">/</mi><mn>2</mn></mrow><annotation encoding="application/x-tex">V_w &gt; V/2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.22222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord">/</span><span class="mord">2</span></span></span></span>.</li>
</ul>
</li>
<li>The failure of each Availability Zone (AZ) is independent.
<ul>
<li>For a common setting <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi><mo>=</mo><mn>3</mn></mrow><annotation encoding="application/x-tex">V=3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">3</span></span></span></span>, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>V</mi><mi>r</mi></msub><mo>=</mo><mn>2</mn></mrow><annotation encoding="application/x-tex">V_r=2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.22222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">2</span></span></span></span>, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>V</mi><mi>w</mi></msub><mo>=</mo><mn>2</mn></mrow><annotation encoding="application/x-tex">V_w=2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.22222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">2</span></span></span></span>, we can set <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>3</mn></mrow><annotation encoding="application/x-tex">3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">3</span></span></span></span> replicas in different AZs to be tolerant to large-scale events in addition to the smaller individual failures.</li>
<li>However, the failure of an AZ will break the quorum for any of the replicas that concurrently have failures in another AZ.</li>
<li>While the individual failures of replicas in each of the AZs are uncorrelated, the failure of an AZ is a correlated failure of all disks and nodes in that AZ.</li>
</ul>
</li>
<li>Quorum protocol of Aurora:
<ul>
<li>Replicate each data item <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>6</mn></mrow><annotation encoding="application/x-tex">6</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">6</span></span></span></span> ways across <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>3</mn></mrow><annotation encoding="application/x-tex">3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">3</span></span></span></span> AZs with <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn></mrow><annotation encoding="application/x-tex">2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">2</span></span></span></span> copies of each item in each AZ.</li>
<li>Use a quorum model with <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>6</mn></mrow><annotation encoding="application/x-tex">6</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">6</span></span></span></span> votes (<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi><mo>=</mo><mn>6</mn></mrow><annotation encoding="application/x-tex">V = 6</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">6</span></span></span></span>), a write quorum of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>4</mn><mi mathvariant="normal">/</mi><mn>6</mn></mrow><annotation encoding="application/x-tex">4/6</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">4</span><span class="mord">/</span><span class="mord">6</span></span></span></span> (<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>V</mi><mi>w</mi></msub><mo>=</mo><mn>4</mn></mrow><annotation encoding="application/x-tex">V_w = 4</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.22222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">4</span></span></span></span>), and a read quorum of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>3</mn><mi mathvariant="normal">/</mi><mn>6</mn></mrow><annotation encoding="application/x-tex">3/6</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">3</span><span class="mord">/</span><span class="mord">6</span></span></span></span> (<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>V</mi><mi>r</mi></msub><mo>=</mo><mn>3</mn></mrow><annotation encoding="application/x-tex">V_r = 3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.22222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">3</span></span></span></span>).</li>
<li>It can lose a single AZ and one additional node (<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mi>Z</mi><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">AZ+1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathnormal">A</span><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>) without losing read availability, and lose any two nodes, including a single AZ failure, and maintain write availability.</li>
</ul>
</li>
</ol>
<h3 id="how-does-aurora-shrink-the-window-of-vulnerability"><a class="markdownIt-Anchor" href="#how-does-aurora-shrink-the-window-of-vulnerability"></a> How does Aurora shrink the window of vulnerability?</h3>
<ol>
<li>To provide sufficient durability in this model, one must ensure the probability of a double fault on uncorrelated failures, represented by Mean Time to Failure (MTTF), is sufficiently low over the time it takes to repair one of these failures, Mean Time to Repair (MTTR).</li>
<li>It is difficult, past a point, to reduce the probability of MTTF on independent failures.</li>
<li>Focus on reducing MTTR.
<ul>
<li>Partition the database volume into small fixed-size segments, currently <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>10</mn></mrow><annotation encoding="application/x-tex">10</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord">0</span></span></span></span>GB in size.
<ul>
<li>These are each replicated <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>6</mn></mrow><annotation encoding="application/x-tex">6</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">6</span></span></span></span> ways into Protection Groups (PGs) so that each PG consists of six  segments organized across <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>3</mn></mrow><annotation encoding="application/x-tex">3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">3</span></span></span></span> AZs, with two segments in each AZ.</li>
<li>A storage volume is a concatenated set of PGs, physically implemented using a large fleet of storage nodes that are provisioned as virtual hosts with attached SSDs using Amazon Elastic Compute Cloud (EC2).</li>
<li>The PGs that constitute a volume are allocated as the volume grows.</li>
</ul>
</li>
<li>Segments are now units of independent background noise failure and repair. The system monitors and automatically repairs faults as part of service.</li>
</ul>
</li>
</ol>
<h3 id="what-are-the-problems-of-the-io-volume-of-mirrored-mysql"><a class="markdownIt-Anchor" href="#what-are-the-problems-of-the-io-volume-of-mirrored-mysql"></a> What are the problems of the I/O volume of mirrored MySQL?</h3>
<img src="/imgs/Distributed/Aurora/MySQL.png" width="50%">
<ol>
<li>The engine needs to write various types of data:
<ul>
<li>The redo log, the binary (statement) log that is archived to Amazon Simple Storage Service (S3) to support point-in-time restores</li>
<li>The modified data pages, a second temporary write of the data page (double-write) to prevent torn pages, and finally, the metadata (FRM) files.</li>
</ul>
</li>
<li>Steps 1, 3, and 5 are sequential and synchronous.
<ul>
<li>Latency is additive because many writes are sequential.</li>
<li>Even on asynchronous writes, one must wait for the slowest operation, leaving the system at the mercy of outliers.</li>
<li>From a distributed system perspective, this model has a 4/4 write quorum and is vulnerable to failures and outlier performance.</li>
</ul>
</li>
<li>User operations resulting from OLTP applications cause many different types of writes often representing the same information in multiple ways.</li>
</ol>
<h3 id="how-does-aurora-reduce-network-traffic"><a class="markdownIt-Anchor" href="#how-does-aurora-reduce-network-traffic"></a> How does Aurora reduce network traffic?</h3>
<ol>
<li>
<p>The only writes that cross the network are redo log records. The log applicator is pushed to the storage tier, where it can generate database pages in the background or on demand.</p>
</li>
<li>
<p>Generating each page from the complete chain of its modifications from the beginning of time is prohibitively expensive.</p>
<ul>
<li>Continually materialize database pages in the background to avoid regenerating them from scratch on demand every time.</li>
<li>As far as the engine is concerned, the log is the database, and any pages that the storage system materializes are simply a cache of log applications.</li>
</ul>
</li>
<li>
<p>The primary only writes log records to the storage service and streams those log records and metadata updates to the replica instances.</p>
<img src="/imgs/Distributed/Aurora/NetworkIO.png" width=50%>
</li>
<li>
<p>The storage node involves the following steps:</p>
<ul>
<li>(1) receive the log record and add it to an in-memory queue</li>
<li>(2) persist record on disk and acknowledge</li>
<li>(3) organize records and identify gaps in the log since some batches may be lost</li>
<li>(4) gossip with peers to fill in gaps</li>
<li>(5) coalesce log records into new data pages</li>
<li>(6) periodically stage log and new pages to S3</li>
<li>(7) periodically garbage collect old versions</li>
<li>(8) periodically validate CRC codes on pages</li>
<li>Each step above is asynchronous; only steps (1) and (2) are in the foreground path, potentially impacting latency.</li>
</ul>
<img src="/imgs/Distributed/Aurora/StorageNode.png" width="50%">
</li>
</ol>
<h3 id="logs"><a class="markdownIt-Anchor" href="#logs"></a> Logs</h3>
<h3 id="how-does-aurora-decide-what-is-completed-and-what-is-durable"><a class="markdownIt-Anchor" href="#how-does-aurora-decide-what-is-completed-and-what-is-durable"></a> How does Aurora decide what is completed and what is durable?</h3>
<ol>
<li>At a high level, The system maintains points of consistency and durability and continually advances them as it receives acknowledgments for outstanding storage requests.</li>
<li>The logic for tracking and undoing partially completed transactions is kept in the database engine, just as if written on simple disks.<br />
Upon restart, before the database can access the storage volume, the storage service makes its recovery, focusing not on user-level transactions but on ensuring that the database sees a uniform view of storage despite its distributed nature.</li>
<li>Completeness:
<ul>
<li><em>Log Sequence Number (LSN)</em>: Each log record has an associated LSN, a monotonically increasing value generated by the database.</li>
<li><em>Volume Complete LSN (VCL)</em>: The storage service determines the highest LSN to guarantee the availability of all prior log records.</li>
<li>Every log record with an LSN larger than the VCL during storage recovery must be truncated.</li>
</ul>
</li>
<li>Durability:
<ul>
<li><em>Consistency Point LSNs (CPL)</em>: The database can further constrain a subset of points that are allowable for truncation by tagging log records</li>
<li><em>Volume Durable LSN (VDL)</em>: the highest CPL smaller than or equal to VCL and truncate all log records with LSN greater than the VDL.</li>
<li>A CPL delineates some limited storage system transactions that must be accepted in order.</li>
</ul>
</li>
</ol>
<h3 id="how-does-the-database-and-storage-interact"><a class="markdownIt-Anchor" href="#how-does-the-database-and-storage-interact"></a> How does the database and storage interact?</h3>
<ol>
<li>Each database-level transaction is broken up into multiple mini-transactions (MTRs) ordered and must be performed atomically.</li>
<li>Each mini-transaction comprises multiple contiguous log records (as many as needed).</li>
<li>The final log record in a mini-transaction is a CPL.</li>
<li>On recovery, the database talks to the storage service to establish the durable point of each PG and uses that to establish the VDL. Then, commands are issued to truncate the log records above VDL.</li>
</ol>
<h3 id="how-does-the-database-write-data"><a class="markdownIt-Anchor" href="#how-does-the-database-write-data"></a> How does the database write data?</h3>
<ol>
<li>Database view:
<ul>
<li>As the database receives acknowledgments to establish the write quorum for each batch of log records, it advances the current VDL.</li>
<li>The database allocates a unique ordered LSN for each redo log record of each transaction that is no greater than the sum of the current VDL and the LSN Allocation Limit (LAL).</li>
<li>This limit ensures the database does not get too far ahead of the storage system and introduces back pressure that can throttle the incoming writes if the storage or network cannot keep up.</li>
</ul>
</li>
<li>PG view:
<ul>
<li>Each segment of each PG only sees a subset of log records in the volume that affects the pages residing on that segment.</li>
<li>Each log record contains a backlink that identifies the previous log record for that PG to track the point of completeness of the log records that have reached each segment.</li>
<li><em>Segment Complete LSN (SCL)</em>: Identifies the greatest LSN below which all log records of the PG have been received and established through backlinks.</li>
<li>The SCL is used by the storage nodes when they gossip with each other to find and exchange log records that they are missing.</li>
</ul>
</li>
</ol>
<h3 id="how-does-the-database-commit-transactions"><a class="markdownIt-Anchor" href="#how-does-the-database-commit-transactions"></a> How does the database commit transactions?</h3>
<ol>
<li>When a client commits a transaction, the thread handling the commit request sets the transaction aside by recording its “commit LSN” as part of a separate list of transactions waiting on commit and moves on to perform other work.</li>
<li>Completing a commit only if the latest VDL is greater than or equal to the transaction’s commit LSN.</li>
<li>As the VDL advances, the database identifies qualifying transactions waiting to be committed and uses a dedicated thread to send commit acknowledgments to wait clients.</li>
</ol>
<h3 id="where-does-the-database-read"><a class="markdownIt-Anchor" href="#where-does-the-database-read"></a> Where does the database read?</h3>
<ol>
<li>Pages are served from the buffer cache, resulting in a storage IO request if the page is not in the cache.</li>
<li>While the Aurora database does not write out pages on cache eviction (or anywhere else), it enforces a similar guarantee: a page in the buffer cache must always be of the latest version.
<ul>
<li><em>Page LSN</em>: identify the log record associated with the latest change to the page</li>
<li>Evict a page from the cache only if its page LSN is greater than or equal to the VDL.</li>
<li>Hence, all changes in the page have been hardened in the log, and on a cache miss, it is sufficient to request a version of the page as of the current VDL to get its latest durable version.</li>
</ul>
</li>
</ol>
<h3 id="how-does-the-database-read"><a class="markdownIt-Anchor" href="#how-does-the-database-read"></a> How does the database read?</h3>
<ol>
<li>When reading a page from a disk, the database establishes a read-point, representing the VDL when the request was issued.</li>
<li>The database can then select a completed storage node with respect to the read point, knowing that it will, therefore, receive an up-to-date version.</li>
<li>Protection Group Min Read Point LSN (PGMRPL): represents that all the log records of the PG below it are unnecessary.
<ul>
<li>If there are read replicas, the writer gossips with them to establish the per-PG Minimum Read Point LSN across all nodes.</li>
<li>A storage node segment guarantees that there will be no read page requests with a read point lower than the PGMRPL.</li>
<li>Each storage node is aware of the PGMRPL from the database and can, therefore, advance the materialized pages on disk by coalescing the older log records and then safely garbage collecting them.</li>
</ul>
</li>
</ol>
<h3 id="how-does-the-database-replicate"><a class="markdownIt-Anchor" href="#how-does-the-database-replicate"></a> How does the database replicate?</h3>
<ol>
<li>A single writer and up to 15 read replicas can all mount a shared storage volume.</li>
<li>To minimize lag, the log stream generated by the writer and sent to the storage nodes is also sent to all read replicas.</li>
<li>The database consumes this log stream in the reader by considering each log record in turn.
<ul>
<li>If the log record refers to a page in the reader’s buffer cache, it uses the log applicator to apply the specified redo operation to the page in the cache.</li>
<li>Otherwise, it simply discards the log record.</li>
<li>The replicas consume log records asynchronously from the writer’s perspective, which acknowledges user commits independent of the replica.</li>
<li>The only log records that will be applied are those whose LSN is less than or equal to the VDL.<br />
The log records that are part of a single mini-transaction are applied atomically in the replica’s cache to ensure that the replica sees a consistent view of all database objects.</li>
</ul>
</li>
</ol>
<h3 id="how-does-the-database-perform-undo-and-redo"><a class="markdownIt-Anchor" href="#how-does-the-database-perform-undo-and-redo"></a> How does the database perform undo and redo?</h3>
<ol>
<li>The same redo log applicator is used in the forward processing path and on recovery, where it operates synchronously and in the foreground while the database is offline.</li>
<li>The redo log applicator is decoupled from the database and operates on storage nodes, in parallel, and all the time in the background. Once the database starts up, it performs volume recovery in collaboration with the storage service.</li>
<li>Undo recovery can happen when the database is online after the system builds the list of these in-flight transactions from the undo segments.</li>
</ol>
<h3 id="how-does-the-database-reestablish-the-runtime-state"><a class="markdownIt-Anchor" href="#how-does-the-database-reestablish-the-runtime-state"></a> How does the database reestablish the runtime state?</h3>
<ol>
<li>It contacts, for each PG, a read quorum of segments, which is sufficient to guarantee the discovery of any data that could have reached a write quorum.</li>
<li>Once the database has established a read quorum for every PG, it can recalculate the VDL above which data is truncated by generating a truncation range that annuls every log record after the new VDL, up to and including an end LSN, which the database can prove is at least as high as the highest possible outstanding log record that could ever have been seen.</li>
<li>The database infers this upper bound because it allocates LSNs and limits how far allocation can occur above VDL (the 10 million limit described earlier).</li>
<li>The truncation ranges are versioned with epoch numbers and written durably to the storage service so that there is no confusion over the durability of truncations in case recovery is interrupted and restarted.</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://liyun-zhang.github.io/2023/09/26/Paper/Distributed/CRAQ/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LiyunZhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LiyunZhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LiyunZhang">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/09/26/Paper/Distributed/CRAQ/" class="post-title-link" itemprop="url">CRAQ</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-09-26 13:20:23" itemprop="dateCreated datePublished" datetime="2023-09-26T13:20:23+08:00">2023-09-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-03-15 19:14:13" itemprop="dateModified" datetime="2024-03-15T19:14:13+08:00">2024-03-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Paper-Notebook/" itemprop="url" rel="index"><span itemprop="name">Paper Notebook</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Paper-Notebook/Distributed-System/" itemprop="url" rel="index"><span itemprop="name">Distributed System</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Paper: <a target="_blank" rel="noopener" href="http://nil.csail.mit.edu/6.824/2020/papers/craq.pdf">Object Storage on CRAQ High-throughput chain replication for read-mostly workloads</a></p>
<p><ul class="markdownIt-TOC">
<li><a href="#purpose">Purpose</a></li>
<li><a href="#model">Model</a>
<ul>
<li><a href="#related">Related</a>
<ul>
<li><a href="#what-is-object-based-storage">What is object-based storage?</a></li>
<li><a href="#what-are-strong-consistency-and-eventual-consistency">What are strong consistency and eventual consistency?</a></li>
<li><a href="#chain-replication">Chain replication</a>
<ul>
<li><a href="#what-is-chain-replication">What is chain replication?</a></li>
<li><a href="#what-is-the-problem-of-basic-chain-replication">What is the problem of basic chain replication?</a></li>
<li><a href="#how-does-cr-handle-client-requests">How does CR handle client requests?</a></li>
<li><a href="#why-can-cr-not-provide-a-read-from-intermediate-nodes">Why can CR not provide a read from intermediate nodes?</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#craq-system-model">CRAQ System Model</a>
<ul>
<li><a href="#how-does-craq-handle-write-requests">How does CRAQ handle write requests?</a></li>
<li><a href="#how-does-craq-handle-read-requests-to-guarantee-strong-consistency">How does CRAQ handle read requests to guarantee strong consistency?</a></li>
<li><a href="#in-what-scenarios-does-craq-outperform-basic-cr">In what scenarios does CRAQ outperform basic CR?</a></li>
<li><a href="#how-does-craq-support-eventual-consistency">How does CRAQ support eventual consistency?</a></li>
<li><a href="#how-does-craq-recover-from-failure">How does CRAQ recover from failure?</a></li>
<li><a href="#how-does-craq-manage-configuration">How does CRAQ manage configuration?</a></li>
<li><a href="#how-does-craq-handle-transient-failure-eg-partition-failure">How does CRAQ handle transient failure (e.g., partition failure)?</a></li>
<li><a href="#how-should-craq-choose-nodes-within-a-datacenter">How should CRAQ choose nodes within a Datacenter?</a></li>
<li><a href="#how-does-craq-support-the-mini-transaction-of-single-key-operations">How does CRAQ support the mini-transaction of single-key operations?</a></li>
<li><a href="#how-does-craq-lower-write-latency-with-multicast">How does CRAQ lower write latency with multicast?</a></li>
<li><a href="#how-does-craq-use-zookeeper-to-manage-configuration">How does CRAQ use ZooKeeper to manage configuration?</a></li>
<li><a href="#how-do-nodes-communicate-with-each-other">How do nodes communicate with each other?</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#evaluation">Evaluation</a></li>
</ul>
</p>
<h1 id="purpose"><a class="markdownIt-Anchor" href="#purpose"></a> Purpose</h1>
<ol>
<li>Issue: many commercially deployed systems sacrifice stronger consistency properties in the desire for greater availability and higher throughput.</li>
<li>Contribution:
<ul>
<li>This system is an improvement on Chain Replication and maintains strong consistency while significantly improving read throughput by enabling any chain node to handle read operations.
<ul>
<li>By distributing the load across all object replicas, CRAQ scales linearly with chain size without increasing consistency coordination.</li>
</ul>
</li>
<li>CRAQ’s design naturally supports eventual consistency among read operations for lower-latency reads during write contention and degradation to read-only behavior during transient partitions.
<ul>
<li>CRAQ allows applications to specify the maximum staleness acceptable for read operations.</li>
</ul>
</li>
<li>Leveraging these load-balancing properties, we describe a wide-area system design for building CRAQ chains across geographically diverse clusters that preserve strong locality properties.</li>
</ul>
</li>
</ol>
<h1 id="model"><a class="markdownIt-Anchor" href="#model"></a> Model</h1>
<h2 id="related"><a class="markdownIt-Anchor" href="#related"></a> Related</h2>
<h3 id="what-is-object-based-storage"><a class="markdownIt-Anchor" href="#what-is-object-based-storage"></a> What is object-based storage?</h3>
<ol>
<li>Object-based storage: Supported by key-value databases, data is presented to applications as entire units.</li>
<li>Object stores support two basic primitives: read (or query) operations return the data block stored under an object name, and write (or update) operations change the state of a single object.</li>
<li>Object stores are better suited for flat namespaces, such as in key-value databases, than hierarchical directory structures, where file systems are better.</li>
<li>Object stores simplify the process of supporting whole-object modifications.<br />
Typically only need to reason about ordering modifications to a specific object, as opposed to the entire storage system.<br />
Significantly cheaper to provide consistency guarantees per object instead of across all operations and objects.</li>
</ol>
<h3 id="what-are-strong-consistency-and-eventual-consistency"><a class="markdownIt-Anchor" href="#what-are-strong-consistency-and-eventual-consistency"></a> What are strong consistency and eventual consistency?</h3>
<ol>
<li>
<p>Strong consistency guarantees that all read and write operations to an object are executed sequentially and that a read to an object always sees the latest written value.</p>
</li>
<li>
<p>Eventual consistency implies that</p>
<ul>
<li>
<p>Writes to an object are still applied in sequential order on all nodes, but eventual consistent reads to different nodes can return stale data for some period of inconsistency.</p>
</li>
<li>
<p>However, read operations will never return an older version than the latest committed write.</p>
</li>
<li>
<p>A client will also see monotonic read consistency if it maintains a session with a particular node.</p>
</li>
</ul>
</li>
<li>
<p>The Eventual consistency is still different from the guarantees from ZooKeeper or Raft. In ZooKeeper or Raft, clients only see monotonic read consistency even if they cross sessions with other servers.</p>
</li>
</ol>
<h3 id="chain-replication"><a class="markdownIt-Anchor" href="#chain-replication"></a> Chain replication</h3>
<h4 id="what-is-chain-replication"><a class="markdownIt-Anchor" href="#what-is-chain-replication"></a> What is chain replication?</h4>
<ol>
<li>It organizes all nodes storing an object in a chain, where the chain tail handles all read requests, and the chain head handles all write requests,  as shown below:<br />
<img src="/imgs/Distributed/CRAQ/basicCR.png" alt="" /></li>
<li>Writes propagate down the chain before the client is acknowledged, thus providing a simple ordering of all object operations and strong consistency at the tail.</li>
<li>The lack of complex or multi-round protocols yields simplicity, good throughput, and easy recovery.</li>
</ol>
<h4 id="what-is-the-problem-of-basic-chain-replication"><a class="markdownIt-Anchor" href="#what-is-the-problem-of-basic-chain-replication"></a> What is the problem of basic chain replication?</h4>
<ol>
<li>All reads for an object must go to the same node, leading to potential hotspots.</li>
<li>Multiple chains can be constructed across a cluster of nodes for better load balancing via consistent hashing or a more centralized directory approach.</li>
<li>However, these algorithms might still find load imbalances if particular objects are disproportionally popular.<br />
All reads to a chain may then be handled by a potentially distant node, namely the chain’s tail.</li>
</ol>
<h4 id="how-does-cr-handle-client-requests"><a class="markdownIt-Anchor" href="#how-does-cr-handle-client-requests"></a> How does CR handle client requests?</h4>
<ol>
<li>The <em>head</em> of the chain handles all write operations from clients.
<ul>
<li>When a node receives a write operation, it is propagated to the next node in the chain.</li>
<li>Once the write reaches the tail node, it has been applied to all replicas in the chain and is considered committed.</li>
<li>When the tail commits the write, a reply is sent to the client. The CR paper describes the tail sending a message directly to the client.</li>
</ul>
</li>
<li>The tail node handles all read operations so that a read can return only committed values.</li>
<li>The simple topology of CR makes write operations cheaper than other protocols, offering strong consistency.<br />
Multiple concurrent writes can be pipelined down the chain, with transmission costs equally spread over all nodes.</li>
</ol>
<h4 id="why-can-cr-not-provide-a-read-from-intermediate-nodes"><a class="markdownIt-Anchor" href="#why-can-cr-not-provide-a-read-from-intermediate-nodes"></a> Why can CR not provide a read from intermediate nodes?</h4>
<ol>
<li>The reading result can violate the strong consistency.</li>
<li>Concurrent reads to different nodes and can see different writes as they are in the process of propagating down the chain.</li>
</ol>
<h2 id="craq-system-model"><a class="markdownIt-Anchor" href="#craq-system-model"></a> CRAQ System Model</h2>
<h3 id="how-does-craq-handle-write-requests"><a class="markdownIt-Anchor" href="#how-does-craq-handle-write-requests"></a> How does CRAQ handle write requests?</h3>
<ol>
<li>A node in CRAQ can store multiple versions of an object, each including a monotonically increasing version number and an additional attribute, whether the version is clean or dirty. All versions are initially marked as clean.</li>
<li>When a node receives a new version of an object via a write being propagated down the chain, the node appends this latest version to its list for the object.
<ul>
<li>If the node is not the tail, it marks the version as dirty and propagates the write to its successor.</li>
<li>Otherwise, if the node is the tail, it marks the version as clean, at which time we call the object version (write) as committed.</li>
<li>The tail node can then notify all other nodes of the commit by sending an acknowledgment backward through the chain.</li>
</ul>
</li>
<li>When an acknowledgment message for an object version arrives at a node, the node marks the object version as clean. The node can then delete all prior versions of the object.</li>
<li>If the node has precisely one version for an object, the object is implicitly in the clean state; otherwise, the object is dirty, and the properly ordered version must be retrieved from the chain tail.</li>
</ol>
<h3 id="how-does-craq-handle-read-requests-to-guarantee-strong-consistency"><a class="markdownIt-Anchor" href="#how-does-craq-handle-read-requests-to-guarantee-strong-consistency"></a> How does CRAQ handle read requests to guarantee strong consistency?</h3>
<ol>
<li>When a node receives a read request for an object, the node returns this value if the latest known version of the requested object is clean.</li>
<li>If the latest version number of the object requested is dirty, the node contacts the tail and asks for the tail’s last committed version number (a version query). The node then returns that version of the object.</li>
<li>The tail could commit a new version between when it replies to the version request and when the intermediate node sends a reply to the client.<br />
This does not violate strong consistency, as read operations are serialized concerning the tail.</li>
</ol>
<p><img src="/imgs/Distributed/CRAQ/read.png" alt="" /></p>
<h3 id="in-what-scenarios-does-craq-outperform-basic-cr"><a class="markdownIt-Anchor" href="#in-what-scenarios-does-craq-outperform-basic-cr"></a> In what scenarios does CRAQ outperform basic CR?</h3>
<ol>
<li>In read-mostly workloads, most of the read requests are handled solely by the C − 1 non-tail nodes (as clean reads), and thus, throughput in these scenarios scales linearly with chain size C.</li>
<li>In write-heavy workloads, most read requests to non-tail nodes are dirty. But these version queries are lighter-weight than full reads, allowing the tail to process them much faster before it becomes saturated.</li>
</ol>
<h3 id="how-does-craq-support-eventual-consistency"><a class="markdownIt-Anchor" href="#how-does-craq-support-eventual-consistency"></a> How does CRAQ support eventual consistency?</h3>
<ol>
<li>
<p>It allows read operations to a chain node to return the newest known object version.</p>
</li>
<li>
<p>It can also support eventual consistency with maximum-bounded inconsistency.</p>
<ul>
<li>The limit imposed can be based on time (relative to a node’s local clock) or absolute version numbers.</li>
</ul>
</li>
<li>
<p>If the chain is still available, this inconsistency is due to the returned version being newer than the last committed one.</p>
<p>If the system is partitioned and the node cannot participate in writes, the version may be older than the current committed one.</p>
</li>
</ol>
<h3 id="how-does-craq-recover-from-failure"><a class="markdownIt-Anchor" href="#how-does-craq-recover-from-failure"></a> How does CRAQ recover from failure?</h3>
<ol>
<li>Each chain node needs to know its predecessor and successor, as well as the chain head and tail.</li>
<li>When a head fails, its immediate successor takes over as the new chain head; likewise, the tail’s predecessor takes over when the tail fails.</li>
<li>If an intermediate node fails, drop it from the chain; the predecessor may need to re-send recent writes since the write request pipeline may have been broken from the failure server.</li>
</ol>
<h3 id="how-does-craq-manage-configuration"><a class="markdownIt-Anchor" href="#how-does-craq-manage-configuration"></a> How does CRAQ manage configuration?</h3>
<ol>
<li>An object’s identifier consists of a chain identifier and a key identifier.</li>
<li>Applications can specify their requirements in multiple ways:
<ul>
<li>Implicit Datacenters &amp; Global Chain Size <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">{</mo><mi>n</mi><mi>u</mi><mi>m</mi><mi mathvariant="normal">_</mi><mi>d</mi><mi>a</mi><mi>t</mi><mi>a</mi><mi>c</mi><mi>e</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi><mi>s</mi><mo separator="true">,</mo><mi>c</mi><mi>h</mi><mi>a</mi><mi>i</mi><mi>n</mi><mi mathvariant="normal">_</mi><mi>s</mi><mi>i</mi><mi>z</mi><mi>e</mi><mo stretchy="false">}</mo></mrow><annotation encoding="application/x-tex">\{num\_datacenters, chain\_size\}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.06em;vertical-align:-0.31em;"></span><span class="mopen">{</span><span class="mord mathnormal">n</span><span class="mord mathnormal">u</span><span class="mord mathnormal">m</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">d</span><span class="mord mathnormal">a</span><span class="mord mathnormal">t</span><span class="mord mathnormal">a</span><span class="mord mathnormal">c</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">c</span><span class="mord mathnormal">h</span><span class="mord mathnormal">a</span><span class="mord mathnormal">i</span><span class="mord mathnormal">n</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mord mathnormal">e</span><span class="mclose">}</span></span></span></span>.
<ul>
<li>Consistent hashing is used with unique datacenter identifiers to determine which datacenters store the chain.</li>
</ul>
</li>
<li>Explicit Datacenters &amp; Global Chain Size <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">{</mo><mi>c</mi><mi>h</mi><mi>a</mi><mi>i</mi><mi>n</mi><mi mathvariant="normal">_</mi><mi>s</mi><mi>i</mi><mi>z</mi><mi>e</mi><mo separator="true">,</mo><mi>d</mi><msub><mi>c</mi><mn>1</mn></msub><mo separator="true">,</mo><mi>d</mi><msub><mi>c</mi><mn>2</mn></msub><mo separator="true">,</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mo separator="true">,</mo><mi>d</mi><msub><mi>c</mi><mi>N</mi></msub><mo stretchy="false">}</mo></mrow><annotation encoding="application/x-tex">\{chain\_size, dc_1, dc_2, ..., dc_N\}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.06em;vertical-align:-0.31em;"></span><span class="mopen">{</span><span class="mord mathnormal">c</span><span class="mord mathnormal">h</span><span class="mord mathnormal">a</span><span class="mord mathnormal">i</span><span class="mord mathnormal">n</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mord mathnormal">e</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">d</span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">d</span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">.</span><span class="mord">.</span><span class="mord">.</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">d</span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">}</span></span></span></span>
<ul>
<li>The order of the chain is the same as specified with the head within <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><msub><mi>c</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">dc_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord mathnormal">d</span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> and tail within <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><msub><mi>c</mi><mi>N</mi></msub></mrow><annotation encoding="application/x-tex">dc_N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord mathnormal">d</span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>.</li>
<li>Consistent hashing is used on the chain identifier to determine which nodes within a datacenter store objects are assigned to the chain.</li>
<li>Each datacenter <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><msub><mi>c</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">dc_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord mathnormal">d</span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> has a node which connects to the tail of datacenter <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><msub><mi>c</mi><mrow><mi>i</mi><mtext>−</mtext><mn>1</mn></mrow></msub></mrow><annotation encoding="application/x-tex">dc_{i−1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.902771em;vertical-align:-0.208331em;"></span><span class="mord mathnormal">d</span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mord mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.208331em;"><span></span></span></span></span></span></span></span></span></span> and a node that connects to the head of datacenter <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><msub><mi>c</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow></msub></mrow><annotation encoding="application/x-tex">dc_{i+1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.902771em;vertical-align:-0.208331em;"></span><span class="mord mathnormal">d</span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.208331em;"><span></span></span></span></span></span></span></span></span></span>.</li>
<li><code>chain_size</code> being <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span> indicates that the chain should use all nodes within each datacenter.</li>
</ul>
</li>
<li>Explicit Datacenter Chain Sizes <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">{</mo><mi>d</mi><msub><mi>c</mi><mn>1</mn></msub><mo separator="true">,</mo><mi>c</mi><mi>h</mi><mi>a</mi><mi>i</mi><mi>n</mi><mi mathvariant="normal">_</mi><mi>s</mi><mi>i</mi><mi>z</mi><msub><mi>e</mi><mn>1</mn></msub><mo separator="true">,</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mo separator="true">,</mo><mi>d</mi><msub><mi>c</mi><mi>N</mi></msub><mo separator="true">,</mo><mi>c</mi><mi>h</mi><mi>a</mi><mi>i</mi><mi>n</mi><mi mathvariant="normal">_</mi><mi>s</mi><mi>i</mi><mi>z</mi><msub><mi>e</mi><mi>N</mi></msub><mo stretchy="false">}</mo></mrow><annotation encoding="application/x-tex">\{dc_1, chain\_size_1, ..., dc_N, chain\_size_N\}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.06em;vertical-align:-0.31em;"></span><span class="mopen">{</span><span class="mord mathnormal">d</span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">c</span><span class="mord mathnormal">h</span><span class="mord mathnormal">a</span><span class="mord mathnormal">i</span><span class="mord mathnormal">n</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">.</span><span class="mord">.</span><span class="mord">.</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">d</span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">c</span><span class="mord mathnormal">h</span><span class="mord mathnormal">a</span><span class="mord mathnormal">i</span><span class="mord mathnormal">n</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">}</span></span></span></span>
<ul>
<li>This allows for non-uniformity in chain load balancing.</li>
<li>The chain nodes within each datacenter are chosen in the same manner as the previous method and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mi>h</mi><mi>a</mi><mi>i</mi><mi>n</mi><mi mathvariant="normal">_</mi><mi>s</mi><mi>i</mi><mi>z</mi><msub><mi>e</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">chain\_size_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.00444em;vertical-align:-0.31em;"></span><span class="mord mathnormal">c</span><span class="mord mathnormal">h</span><span class="mord mathnormal">a</span><span class="mord mathnormal">i</span><span class="mord mathnormal">n</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> can also be set to <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span>.</li>
</ul>
</li>
</ul>
</li>
</ol>
<h3 id="how-does-craq-handle-transient-failure-eg-partition-failure"><a class="markdownIt-Anchor" href="#how-does-craq-handle-transient-failure-eg-partition-failure"></a> How does CRAQ handle transient failure (e.g., partition failure)?</h3>
<ol>
<li>In methods 2 and 3 above, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><msub><mi>c</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">dc_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord mathnormal">d</span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> can be set as a master datacenter.
<ul>
<li>If a datacenter is the master for a chain, writes to the chain will only be accepted by that datacenter during transient failures.</li>
</ul>
</li>
<li>When a master is not defined,
<ul>
<li>Writes will only continue in a partition if the partition contains a majority of the nodes in the global chain.</li>
<li>The minority partition will become read-only for maximum bounded inconsistent read operations.</li>
</ul>
</li>
</ol>
<h3 id="how-should-craq-choose-nodes-within-a-datacenter"><a class="markdownIt-Anchor" href="#how-should-craq-choose-nodes-within-a-datacenter"></a> How should CRAQ choose nodes within a Datacenter?</h3>
<ol>
<li>In CRAQ’s current implementation, we place chains within a datacenter using consistent hashing, mapping potentially many chain identifiers to a single head node.</li>
<li>Another approach is to use the membership management service as a directory service in assigning and storing randomized chain membership, i.e., each chain can include some random set of server nodes.
<ul>
<li>This approach improves the potential for parallel system recovery.</li>
<li>However, it would increase centralization and state and require storing more metadata information in the coordination service.</li>
</ul>
</li>
</ol>
<h3 id="how-does-craq-support-the-mini-transaction-of-single-key-operations"><a class="markdownIt-Anchor" href="#how-does-craq-support-the-mini-transaction-of-single-key-operations"></a> How does CRAQ support the mini-transaction of single-key operations?</h3>
<ol>
<li>For Prepend/Append and Increment/Decrement operations,
<ul>
<li>The head of the chain storing the key’s object can apply the operation to the latest version of the object, even if the latest version is dirty, and then propagate a full replacement write down the chain.</li>
<li>The head can buffer the requests and batch the updates if these operations are frequent. These enhancements would be much more expensive using a traditional two-phase-commit protocol.</li>
</ul>
</li>
<li>For the test-and-set operation,
<ul>
<li>The head of the chain checks if its most recent committed version number equals the version number specified in the operation.</li>
<li>If there are no outstanding uncommitted versions of the object, the head accepts the operation and propagates an update down the chain.</li>
<li>If there are outstanding writes, we reject the test-and-set operation, and clients are careful to back off their request rate if continuously rejected.</li>
</ul>
</li>
<li>The optimistic two-phase protocol must only be implemented with the chain heads, not all involved nodes.
<ul>
<li>The chain heads can lock any keys involved in the mini-transaction until it is fully committed.</li>
<li>It reduces the write throughput of CRAQ as writes to the same object can no longer be pipelined.</li>
</ul>
</li>
</ol>
<h3 id="how-does-craq-lower-write-latency-with-multicast"><a class="markdownIt-Anchor" href="#how-does-craq-lower-write-latency-with-multicast"></a> How does CRAQ lower write latency with multicast?</h3>
<ol>
<li>This would be a network-layer multicast protocol within a datacenter, while application-layer multicast protocols may be better suited for wide-area chains.</li>
<li>No ordering or reliability guarantees are required from these multicast protocols.</li>
<li>The actual value can be multicast to the entire chain. Then, only a small metadata message needs to be propagated down the chain to ensure that all replicas have received a write before the tail.</li>
<li>Suppose a node does not receive the multicast for any reason. In that case, the node can fetch the object from its predecessor after receiving the write commit message and before further propagating the commit message.</li>
<li>When the tail receives a propagated write request, a multicast acknowledgment message can be sent to the multicast group instead of propagating it backward along the chain.</li>
</ol>
<h3 id="how-does-craq-use-zookeeper-to-manage-configuration"><a class="markdownIt-Anchor" href="#how-does-craq-use-zookeeper-to-manage-configuration"></a> How does CRAQ use ZooKeeper to manage configuration?</h3>
<ol>
<li>
<p>During initialization, a CRAQ node creates an ephemeral file in <code>/nodes/dc_name/node_id</code>.</p>
<ul>
<li>
<p>The content of the file contains the node’s IP address and port number.</p>
</li>
<li>
<p>CRAQ nodes can query <code>/nodes/dc_name</code> to determine the membership list for its datacenter. They create a watch on the children’s <code>/nodes/dc_name</code> list.</p>
</li>
</ul>
</li>
<li>
<p>When a CRAQ node receives a request to create a new chain, a file is created in <code>/chains/chain_id</code>.</p>
<ul>
<li>The chain’s placement strategy determines the file’s contents but only includes this chain configuration information, not the list of a chain’s current nodes.</li>
<li>Instead of letting nodes register their membership for each chain they belong to (<em>i.e.</em>, chain metadata explicitly names the chain’s current members), any node participating in the chain will query the chain file and place a watch on it.</li>
<li>This is based on the assumption that the number of chains will generally be at least an order of magnitude larger than the number of nodes in the system, or that chain dynamism may be significantly greater than nodes joining or leaving the system.</li>
</ul>
</li>
</ol>
<h3 id="how-do-nodes-communicate-with-each-other"><a class="markdownIt-Anchor" href="#how-do-nodes-communicate-with-each-other"></a> How do nodes communicate with each other?</h3>
<ol>
<li>The nodes within each datacenter organize themselves into a one-hop DHT using the identifiers generated when joining the system.
<ul>
<li>A node’s chain predecessor and successor, the head node, and the tail node are defined as its predecessor and successor in the DHT ring.</li>
</ul>
</li>
<li>All RPC-based communication between nodes, or between nodes and clients, is over TCP connections.
<ul>
<li>Each node maintains a pool of connected TCP connections with its chain’s predecessor, successor, and tail.</li>
<li>For chains that span multiple datacenters, the last node of one datacenter maintains a connection to the first node of its successor datacenter.</li>
<li>Any node that maintains a connection to a node outside of its datacenter must also place a watch on the node list of the external datacenter.</li>
</ul>
</li>
</ol>
<h1 id="evaluation"><a class="markdownIt-Anchor" href="#evaluation"></a> Evaluation</h1>
<ol>
<li>
<p>The main contribution is that it supports reading from intermediate nodes. So, the author measured the read throughput of CRAQ and compared it with basic CR.</p>
<p><img src="/imgs/Distributed/CRAQ/4.png" alt="" /><img src="/imgs/Distributed/CRAQ/6.png" alt="" /></p>
</li>
<li>
<p>The author also tested the factors affecting read throughput, i.e., the number of clients, nodes, and writes.</p>
<p><img src="/imgs/Distributed/CRAQ/5.png" alt="" /><img src="/imgs/Distributed/CRAQ/7.png" alt="" /></p>
</li>
<li>
<p>Another important test in a distributed system is how long it takes to recover and how it performs during the failure.</p>
<p><img src="/imgs/Distributed/CRAQ/10-13.png" alt="" /></p>
</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://liyun-zhang.github.io/2023/09/26/Paper/Distributed/Zookeeper/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LiyunZhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LiyunZhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LiyunZhang">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/09/26/Paper/Distributed/Zookeeper/" class="post-title-link" itemprop="url">Zookeeper</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-09-26 13:16:26" itemprop="dateCreated datePublished" datetime="2023-09-26T13:16:26+08:00">2023-09-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-03-15 22:10:02" itemprop="dateModified" datetime="2024-03-15T22:10:02+08:00">2024-03-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Paper-Notebook/" itemprop="url" rel="index"><span itemprop="name">Paper Notebook</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Paper-Notebook/Distributed-System/" itemprop="url" rel="index"><span itemprop="name">Distributed System</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Paper: <a target="_blank" rel="noopener" href="http://nil.csail.mit.edu/6.824/2020/papers/zookeeper.pdf">ZooKeeper: Wait-free coordination for Internet-scale systems</a></p>
<p><ul class="markdownIt-TOC">
<li><a href="#purpose">Purpose</a></li>
<li><a href="#model">Model</a>
<ul>
<li><a href="#zookeeper-service-overview">ZooKeeper service overview</a>
<ul>
<li><a href="#how-does-the-client-interact-with-the-zookeeper-server">How does the client interact with the ZooKeeper server?</a></li>
<li><a href="#what-are-the-flags-of-znodes">What are the flags of znodes?</a></li>
<li><a href="#what-are-the-differences-between-znodes-and-files-in-a-file-system">What are the differences between znodes and files in a file system?</a></li>
<li><a href="#what-does-zookeeper-guarantee">What does ZooKeeper guarantee?</a></li>
<li><a href="#how-to-change-the-configuration">How to change the configuration?</a></li>
<li><a href="#how-should-a-client-read-configurations">How should a client read configurations?</a></li>
</ul>
</li>
<li><a href="#implement-primitives">Implement primitives</a>
<ul>
<li><a href="#how-does-zookeeper-manage-configuration">How does ZooKeeper manage configuration?</a></li>
<li><a href="#how-does-zookeeper-manage-rendezvous">How does ZooKeeper manage rendezvous?</a></li>
<li><a href="#how-does-zookeeper-manage-group-membership">How does ZooKeeper manage group membership?</a></li>
<li><a href="#how-does-zookeeper-manage-mini-transactions">How does ZooKeeper manage mini-transactions?</a></li>
<li><a href="#how-does-zookeeper-implement-simple-locks">How does ZooKeeper implement simple locks?</a></li>
<li><a href="#how-does-zookeeper-implement-simple-locks-without-herd-effect">How does ZooKeeper implement simple locks without herd effect?</a></li>
<li><a href="#how-does-zookeeper-implement-readwrite-locks">How does ZooKeeper implement Read/Write locks?</a></li>
<li><a href="#what-is-the-difference-between-zookeeper-locks-and-thread-mutex-locks">What is the difference between ZooKeeper locks and thread mutex locks?</a></li>
<li><a href="#how-does-zookeeper-implement-a-double-barrier">How does ZooKeeper implement a double barrier?</a></li>
</ul>
</li>
<li><a href="#implementation-of-zookeeper">Implementation of ZooKeeper</a>
<ul>
<li><a href="#how-does-zookeeper-serve-requests">How does ZooKeeper serve requests?</a></li>
<li><a href="#how-does-zookeeper-manage-the-database">How does ZooKeeper manage the database?</a></li>
<li><a href="#how-does-the-request-processor-handle-write-requests">How does the request processor handle write requests?</a></li>
<li><a href="#how-do-servers-reach-an-agreement">How do servers reach an agreement?</a></li>
<li><a href="#how-does-zookeeper-take-a-snapshot">How does ZooKeeper take a snapshot?</a></li>
<li><a href="#how-does-zookeeper-handle-sync">How does ZooKeeper handle sync()</a></li>
<li><a href="#how-does-zookeeper-ensure-to-serve-data-at-least-as-updated-as-the-last-server-served-that-data">How does ZooKeeper ensure to serve data at least as updated as the last server served that data?</a></li>
<li><a href="#how-to-detect-client-session-failures">How to detect client session failures?</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#evaluation-and-results">Evaluation and results</a></li>
</ul>
</p>
<h1 id="purpose"><a class="markdownIt-Anchor" href="#purpose"></a> Purpose</h1>
<ol>
<li>Contribution
<ul>
<li>Moved away from implementing specific primitives on the server side
<ul>
<li>Opted for exposing an API that enables application developers to implement their primitives.</li>
<li>It enables new primitives without requiring changes to the service core.</li>
</ul>
</li>
<li>Moved away from blocking primitives.
<ul>
<li>Manipulate simple wait-free data objects organized hierarchically as in file systems.</li>
</ul>
</li>
<li>Provide a per-client guarantee of FIFO execution of requests and linearizability for all writes.
<ul>
<li>Read requests are satisfied by local servers.</li>
</ul>
</li>
</ul>
</li>
<li>Features
<ul>
<li>Provide a simple and high-performance kernel for building more complex coordination primitives at the client.</li>
<li>Incorporate elements from group messaging, shared registers, and distributed lock services in a replicated centralized service.</li>
<li>It has the wait-free aspects of shared registers with an event-driven mechanism.</li>
<li>A simple pipelined architecture allows us to have hundreds or thousands of requests outstanding while still achieving low latency.</li>
<li>With asynchronous operations, a client can have multiple outstanding operations simultaneously.</li>
<li>Enables caching data on the client side with ZooKeeper watches to avoid the problem of delayed updates caused by slow or faulty clients.</li>
</ul>
</li>
</ol>
<h1 id="model"><a class="markdownIt-Anchor" href="#model"></a> Model</h1>
<h2 id="zookeeper-service-overview"><a class="markdownIt-Anchor" href="#zookeeper-service-overview"></a> ZooKeeper service overview</h2>
<p>Znode: an in-memory data node in the ZooKeeper data<br />
Data tree: a hierarchical namespace to organize znodes</p>
<h3 id="how-does-the-client-interact-with-the-zookeeper-server"><a class="markdownIt-Anchor" href="#how-does-the-client-interact-with-the-zookeeper-server"></a> How does the client interact with the ZooKeeper server?</h3>
<ol>
<li>
<p>Clients submit requests to ZooKeeper through a client API using a ZooKeeper client library.</p>
<ul>
<li><code>create(path, data, flags)</code>: returns the name of the new znode</li>
<li><code>delete(path, version)</code>: Deletes the znode path if that znode is at the expected version.</li>
<li><code>exists(path, watch)</code>: The watch flag enables a client to set a watch on the znode.</li>
<li><code>getData(path, watch)</code>: Returns the data and meta-data, such as version information, associated with the znode. ZooKeeper does not set the watch if the znode does not exist.</li>
<li><code>setData(path, data, version)</code>: Writes data[] to znode path if the version number is the current znode version.</li>
<li><code>getChildren(path, watch)</code></li>
<li><code>sync(path)</code>: Waits for all updates pending at the start of the operation to propagate to the server the client is connected to. The path is currently ignored.</li>
</ul>
</li>
<li>
<p>All methods have synchronous and asynchronous versions available through the API.</p>
</li>
<li>
<p>If the actual version number of the znode does not match the expected version number the update fails with an unexpected version error.<br />
If the version number is −1, it does not perform version checking.</p>
</li>
<li>
<p>The client library also manages the network connections between the client and ZooKeeper servers.</p>
</li>
</ol>
<h3 id="what-are-the-flags-of-znodes"><a class="markdownIt-Anchor" href="#what-are-the-flags-of-znodes"></a> What are the flags of znodes?</h3>
<ol>
<li><em>Regular</em>: Clients manipulate regular znodes by creating and deleting them explicitly</li>
<li><em>Ephemeral</em>: Clients create such znodes, and they either delete them explicitly or let the system remove them automatically when the session that makes them terminates</li>
<li><em>Sequential</em>: Those znodes in the same parent znode have a monotonically increasing counter appended to their name. The newer znode has a larger sequence value.</li>
<li><em>Watch</em>
<ul>
<li>A read operation with a watch flag set completes normally, except the server promises to notify the client when the information returned has changed.</li>
<li>Watches are one-time triggers associated with a session; they are unregistered once triggered, or the session closes.</li>
<li>Watches indicate a change has happened but do not provide the change.</li>
<li>Session events, such as connection loss events, are also sent to watch callbacks so that clients know that watch events may be delayed.</li>
</ul>
</li>
</ol>
<h3 id="what-are-the-differences-between-znodes-and-files-in-a-file-system"><a class="markdownIt-Anchor" href="#what-are-the-differences-between-znodes-and-files-in-a-file-system"></a> What are the differences between znodes and files in a file system?</h3>
<ol>
<li>
<p>Znodes map to abstractions of the client application, typically corresponding to meta-data used for coordination purposes.</p>
</li>
<li>
<p>Znodes allow clients to store information that can be used for meta-data or configuration in a distributed computation, such as the leadership of a replica group, which can be stored in a known location.</p>
</li>
<li>
<p>ZooKeeper does not use handles to access znodes. Instead, each request includes the full path on which the znode is being operated.</p>
<ul>
<li>
<p>It simplifies the API (no <code>open()</code> or <code>close()</code> methods)</p>
</li>
<li>
<p>It also eliminates the extra state that the server would need to maintain.</p>
</li>
</ul>
</li>
</ol>
<h3 id="what-does-zookeeper-guarantee"><a class="markdownIt-Anchor" href="#what-does-zookeeper-guarantee"></a> What does ZooKeeper guarantee?</h3>
<ol>
<li>
<p>This definition of its linearizability is called A-linearizability (asynchronous linearizability), which allows a client to have multiple outstanding operations.</p>
<ul>
<li>
<p><em>Linearizable writes</em>: all requests that update the state of ZooKeeper are serializable and respect precedence.</p>
</li>
<li>
<p><em>FIFO client order</em>: all requests from a given client are executed in the order that the client sent them.</p>
</li>
</ul>
</li>
<li>
<p>A-linearizability can guarantee no specific order for outstanding operations of the same client or a FIFO order.</p>
</li>
<li>
<p>A system that satisfies A-linearizability also satisfies linearizability. Because only update requests are A-linearizable, ZooKeeper processes read requests locally at each replica.</p>
</li>
</ol>
<h3 id="how-to-change-the-configuration"><a class="markdownIt-Anchor" href="#how-to-change-the-configuration"></a> How to change the configuration?</h3>
<ol>
<li>
<p>Two requirements:</p>
<ul>
<li>As the new leader starts making changes, we do not want other processes to start using the configuration that is being changed.</li>
<li>If the new leader dies before the configuration has been fully updated, we do not want the processes to use this partial configuration.</li>
</ul>
</li>
<li>
<p>The new leader can designate a path as the ready znode; other processes will only use the configuration when that znode exists.</p>
<ul>
<li>The new leader changes the configuration by deleting ready, updating the configuration znodes, and creating ready.</li>
<li>Given the FIFO client order guarantee, these changes can be pipelined and issued asynchronously to update the configuration state quickly.</li>
</ul>
</li>
</ol>
<h3 id="how-should-a-client-read-configurations"><a class="markdownIt-Anchor" href="#how-should-a-client-read-configurations"></a> How should a client read configurations?</h3>
<ol>
<li>
<p>If a client sees the ready exists before the new leader starts to make a change, it could read the partial configuration in progress and cannot notice anything.</p>
<ul>
<li>The client needs to set the watch flag when they check the existence of the ready znode.</li>
<li>Then, it will see a notification informing the client of the change before it can read any of the new configurations.</li>
</ul>
</li>
<li>
<p>If A changes the shared configuration in ZooKeeper and tells B of the change through the shared communication channel, B would expect to see the change when it re-reads the configuration.</p>
<ul>
<li>If B’s ZooKeeper replica is slightly behind A’s, the new configuration may not be visible.</li>
<li>B can ensure it sees the most up-to-date information by issuing a write before re-reading the configuration.</li>
<li><code>sync</code> causes a server to apply all pending write requests before processing the read without the overhead of a full write.</li>
</ul>
</li>
</ol>
<h2 id="implement-primitives"><a class="markdownIt-Anchor" href="#implement-primitives"></a> Implement primitives</h2>
<h3 id="how-does-zookeeper-manage-configuration"><a class="markdownIt-Anchor" href="#how-does-zookeeper-manage-configuration"></a> How does ZooKeeper manage configuration?</h3>
<ol>
<li>Configuration is stored in a znode, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>z</mi><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">z_c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.04398em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>.</li>
<li>Processes start up with the full pathname of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>z</mi><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">z_c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.04398em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>. Starting processes obtain their configuration by reading zc with the watch flag set to true.</li>
<li>If the configuration in <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>z</mi><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">z_c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.04398em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> is ever updated, the processes are notified, and the new configuration is read, again setting the watch flag to true.</li>
</ol>
<h3 id="how-does-zookeeper-manage-rendezvous"><a class="markdownIt-Anchor" href="#how-does-zookeeper-manage-rendezvous"></a> How does ZooKeeper manage rendezvous?</h3>
<ol>
<li>Use a rendezvous znode, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>z</mi><mi>r</mi></msub></mrow><annotation encoding="application/x-tex">z_r</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.04398em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>, which is a node created by the client.</li>
<li>The client passes the full pathname of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>z</mi><mi>r</mi></msub></mrow><annotation encoding="application/x-tex">z_r</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.04398em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> as a startup parameter of the master and worker processes.</li>
<li>When the master starts, it fills in <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>z</mi><mi>r</mi></msub></mrow><annotation encoding="application/x-tex">z_r</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.04398em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> with information about addresses and ports it is using.</li>
<li>When workers start, they read <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>z</mi><mi>r</mi></msub></mrow><annotation encoding="application/x-tex">z_r</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.04398em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> with the watch set to true.
<ul>
<li>If <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>z</mi><mi>r</mi></msub></mrow><annotation encoding="application/x-tex">z_r</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.04398em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> has not been filled in yet, the worker waits to be notified when <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>z</mi><mi>r</mi></msub></mrow><annotation encoding="application/x-tex">z_r</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.04398em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> is updated.</li>
<li>If <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>z</mi><mi>r</mi></msub></mrow><annotation encoding="application/x-tex">z_r</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.04398em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> is an ephemeral node, master and worker processes can watch for <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>z</mi><mi>r</mi></msub></mrow><annotation encoding="application/x-tex">z_r</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.04398em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> to be deleted and cleaned up when the client ends.</li>
</ul>
</li>
</ol>
<h3 id="how-does-zookeeper-manage-group-membership"><a class="markdownIt-Anchor" href="#how-does-zookeeper-manage-group-membership"></a> How does ZooKeeper manage group membership?</h3>
<ol>
<li>
<p>Designate a znode, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>z</mi><mi>g</mi></msub></mrow><annotation encoding="application/x-tex">z_g</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.716668em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:-0.04398em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span> to represent the group.</p>
</li>
<li>
<p>When a process member of the group starts, it creates an <code>ephemeral</code> child znode under <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>z</mi><mi>g</mi></msub></mrow><annotation encoding="application/x-tex">z_g</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.716668em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:-0.04398em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span>. Processes may put process information in the data of the child znode.</p>
</li>
<li>
<p>If each process has a unique name or identifier, that name is used as the name of the child znode; otherwise, the process creates the znode with the <code>SEQUENTIAL</code> flag to obtain a unique name assignment.</p>
</li>
</ol>
<h3 id="how-does-zookeeper-manage-mini-transactions"><a class="markdownIt-Anchor" href="#how-does-zookeeper-manage-mini-transactions"></a> How does ZooKeeper manage mini-transactions?</h3>
<ol>
<li>In a mini-transaction, we want the <code>getData</code> and <code>setData</code> to be atomic.</li>
<li>ZooKeeper can support mini-transactions using version numbers.</li>
</ol>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> <span class="literal">true</span>:</span><br><span class="line">	X, v = <span class="title function_ invoke__">getData</span>(K)</span><br><span class="line">  <span class="keyword">if</span> <span class="title function_ invoke__">setData</span>(K, X+<span class="number">1</span>, v):</span><br><span class="line">		<span class="keyword">break</span></span><br></pre></td></tr></table></figure>
<h3 id="how-does-zookeeper-implement-simple-locks"><a class="markdownIt-Anchor" href="#how-does-zookeeper-implement-simple-locks"></a> How does ZooKeeper implement simple locks?</h3>
<ol>
<li>
<p>The lock is represented by a znode. To acquire a lock, a client tries to create the designated znode with the <code>EPHEMERAL</code> flag.</p>
</li>
<li>
<p>If the creation succeeds, the client holds the lock. Otherwise, the client can read the znode with the watch flag set to be notified if the current leader dies.</p>
</li>
<li>
<p>A client releases the lock when it dies or explicitly deletes the znode.</p>
</li>
<li>
<p>Other clients waiting for a lock try again to acquire one once they observe the znode being deleted.</p>
</li>
</ol>
<h3 id="how-does-zookeeper-implement-simple-locks-without-herd-effect"><a class="markdownIt-Anchor" href="#how-does-zookeeper-implement-simple-locks-without-herd-effect"></a> How does ZooKeeper implement simple locks without herd effect?</h3>
<ol>
<li>
<p>Herd effect of simple locks: If many clients are waiting to acquire a lock, they will all vie for it when it is released, even though only one client can.</p>
</li>
<li>
<p>Define a lock znode l to implement such locks. Line up all the clients requesting the lock, and each obtains the lock to request arrival.</p>
<ul>
<li>Use the <code>SEQUENTIAL</code> flag to order the client’s attempt to acquire the lock with respect to all other attempts.</li>
<li>The client holds the lock if the client’s znode has the lowest sequence number.</li>
<li>Otherwise, the client waits for deletion of the znode that either has the lock or will receive the lock before this client’s znode.</li>
</ul>
</li>
<li>
<p>By only watching the znode that precedes the client’s znode, the herd effect can be avoided by only waking up one process when a lock is released or a lock request is abandoned.</p>
</li>
<li>
<p>Once the znode being watched by the client goes away, the client must check if it now holds the lock.</p>
<ul>
<li>The previous lock request may have been abandoned and there is a znode with a lower sequence number still waiting for or holding the lock.</li>
</ul>
</li>
<li>
<p>Releasing a lock is as simple as deleting the znode n that represents the lock request.</p>
</li>
<li>
<p>By browsing the ZooKeeper data, we can see the amount of lock contention, break locks, and debug locking problems.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Lock</span></span><br><span class="line">n = create(l + “/lock-”, EPHEMERAL|SEQUENTIAL)</span><br><span class="line">C = getChildren(l, <span class="literal">false</span>)</span><br><span class="line"><span class="keyword">if</span> n is lowest znode in C, <span class="built_in">exit</span></span><br><span class="line">p = znode in C ordered just before n</span><br><span class="line"><span class="keyword">if</span> exists(p, <span class="literal">true</span>) wait <span class="keyword">for</span> watch event</span><br><span class="line"><span class="keyword">goto</span> <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Unlock</span></span><br><span class="line">delete(n)</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="how-does-zookeeper-implement-readwrite-locks"><a class="markdownIt-Anchor" href="#how-does-zookeeper-implement-readwrite-locks"></a> How does ZooKeeper implement Read/Write locks?</h3>
<ol>
<li>
<p>The write locks are similar to simple ones since they are all exclusive.</p>
</li>
<li>
<p>Since read locks may be shared, and only earlier write lock znodes prevent the client from obtaining a read lock, read locks only need to check that no lower write znode.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Write lock</span></span><br><span class="line">n = create(l + “/write-”, EPHEMERAL|SEQUENTIAL)</span><br><span class="line">C = getChildren(l, <span class="literal">false</span>)</span><br><span class="line"><span class="keyword">if</span> n is lowest znode in C, <span class="built_in">exit</span></span><br><span class="line">p = znode in C ordered just before n</span><br><span class="line"><span class="keyword">if</span> exists(p, <span class="literal">true</span>) wait <span class="keyword">for</span> event</span><br><span class="line"><span class="keyword">goto</span> <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Read Lock</span></span><br><span class="line">n = create(l + “/read-”, EPHEMERAL|SEQUENTIAL)</span><br><span class="line">C = getChildren(l, <span class="literal">false</span>)</span><br><span class="line"><span class="keyword">if</span> no write znodes lower than n in C, <span class="built_in">exit</span></span><br><span class="line">p = write znode in C ordered just before n</span><br><span class="line"><span class="keyword">if</span> exists(p, <span class="literal">true</span>) wait <span class="keyword">for</span> event</span><br><span class="line"><span class="keyword">goto</span> <span class="number">3</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="what-is-the-difference-between-zookeeper-locks-and-thread-mutex-locks"><a class="markdownIt-Anchor" href="#what-is-the-difference-between-zookeeper-locks-and-thread-mutex-locks"></a> What is the difference between ZooKeeper locks and thread mutex locks?</h3>
<ol>
<li>In ZooKeeper lock, the system automatically releases the locks if the lock holder fails. So, locks do not enforce the atomicity of other activities.</li>
<li>To make writes atomic, use the “ready” trick or mini-transactions.</li>
<li>For the master/leader election, a new leader must inspect the state and clean up.</li>
<li>Or use soft locks like MapReduce for performance but not correctness. Only one worker will do each task, which is OK to be done twice.</li>
</ol>
<h3 id="how-does-zookeeper-implement-a-double-barrier"><a class="markdownIt-Anchor" href="#how-does-zookeeper-implement-a-double-barrier"></a> How does ZooKeeper implement a double barrier?</h3>
<ol>
<li>Double barriers enable clients to synchronize a computation’s beginning and end.
<ul>
<li>Enter barrier: At the beginning, a client must wait until the number of waiting clients exceeds the threshold before executing the computation.</li>
<li>Leave barrier: At the end, a client must wait until the number of finished clients exceeds the threshold before it can exit.</li>
</ul>
</li>
<li>Represent a barrier in ZooKeeper with a znode, referred to as <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi></mrow><annotation encoding="application/x-tex">b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">b</span></span></span></span>.</li>
<li>Every process <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">p</span></span></span></span> registers with <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi></mrow><annotation encoding="application/x-tex">b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">b</span></span></span></span> on entry by creating a znode as a child of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi></mrow><annotation encoding="application/x-tex">b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">b</span></span></span></span>, and unregisters when it is ready to leave by removing the child.
<ul>
<li>Processes can enter the barrier when the number of child znodes of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi></mrow><annotation encoding="application/x-tex">b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">b</span></span></span></span> exceeds the barrier threshold.</li>
<li>Processes can leave the barrier when all of the processes have removed their children.</li>
</ul>
</li>
<li>We use watches to wait for enter and exit conditions to be satisfied efficiently.
<ul>
<li>To enter, processes watch for a ready child, created by the process that causes the number of children to exceed the barrier threshold.</li>
<li>To leave, processes watch for a particular child to disappear and only check the exit condition once that znode has been removed.</li>
</ul>
</li>
</ol>
<h2 id="implementation-of-zookeeper"><a class="markdownIt-Anchor" href="#implementation-of-zookeeper"></a> Implementation of ZooKeeper</h2>
<h3 id="how-does-zookeeper-serve-requests"><a class="markdownIt-Anchor" href="#how-does-zookeeper-serve-requests"></a> How does ZooKeeper serve requests?</h3>
<ol>
<li>Upon receiving a request, a server prepares it for execution in the request processor.</li>
<li>If a write request requires coordination among the servers, they use atomic broadcast to reach an agreement. Finally, servers commit changes to the ZooKeeper database that are fully replicated across all ensemble servers.
<ul>
<li>When a server processes a write request, it sends and clears notifications relative to any watch corresponding to that update.</li>
<li>Only the server that a client is connected to tracks and triggers notifications for that client.</li>
<li>Servers process writes in order and does not concurrently process other writes or reads. This ensures a strict succession of notifications.</li>
</ul>
</li>
<li>In the case of read requests, a server reads the state of the local database and generates a response to the request.
<ul>
<li>Each read request is processed and tagged with a <em>zxid</em> that corresponds to the last transaction seen by the server.</li>
<li><em>Zxid</em> defines the partial order of the read requests concerning the write requests.</li>
<li>For applications that require ZooKeeper not to serve stale data, they can call <code>sync()</code> followed by the read operation.</li>
</ul>
</li>
</ol>
<h3 id="how-does-zookeeper-manage-the-database"><a class="markdownIt-Anchor" href="#how-does-zookeeper-manage-the-database"></a> How does ZooKeeper manage the database?</h3>
<ol>
<li>The replicated database is an in-memory database containing the entire data tree.</li>
<li>Each znode in the tree stores a maximum of 1MB of data by default, but this maximum value is a configuration parameter that can be changed in specific cases.</li>
<li>For recoverability,
<ul>
<li>Efficiently log updates to disk, and we force writes to be on the disk media before they are applied to the in-memory database.</li>
<li>A replay log (a write-ahead log) of committed operations is kept and periodically generates snapshots of the in-memory database.</li>
</ul>
</li>
</ol>
<h3 id="how-does-the-request-processor-handle-write-requests"><a class="markdownIt-Anchor" href="#how-does-the-request-processor-handle-write-requests"></a> How does the request processor handle write requests?</h3>
<ol>
<li>When the leader receives a write request, it calculates the state of the system when the write is applied and transforms it into a transaction that captures this new state.</li>
<li>The future state must be calculated because there may be outstanding transactions that have not yet been applied to the database.</li>
</ol>
<h3 id="how-do-servers-reach-an-agreement"><a class="markdownIt-Anchor" href="#how-do-servers-reach-an-agreement"></a> How do servers reach an agreement?</h3>
<ol>
<li>All requests that update ZooKeeper state are forwarded to the leader.</li>
<li>The leader executes the request and broadcasts the change to the ZooKeeper state through Zab.
<ul>
<li>Zab uses, by default, simple majority quorums to decide on a proposal, so Zab and ZooKeeper can only work if a majority of servers are correct.</li>
<li>Zab guarantees that changes broadcast by a leader are delivered in the order they were sent. All changes from previous leaders are delivered to an established leader before it broadcasts them.</li>
<li>Because idempotent transactions are used, multiple delivery is acceptable as long as they are delivered in order.</li>
<li>ZooKeeper requires Zab to redeliver at least all messages delivered after the last snapshot starts.</li>
</ul>
</li>
<li>The server that receives the client request responds to the client when it delivers the corresponding state change.</li>
<li>Use TCP for transport so message order is maintained by the network.</li>
</ol>
<h3 id="how-does-zookeeper-take-a-snapshot"><a class="markdownIt-Anchor" href="#how-does-zookeeper-take-a-snapshot"></a> How does ZooKeeper take a snapshot?</h3>
<ol>
<li>ZooKeeper snapshots are called fuzzy snapshots since we do not lock the ZooKeeper state to take the snapshot.<br />
Instead, we do a depth first scan of the tree atomically reading each znode’s data and meta-data and writing them to disk.</li>
<li>Since the resulting fuzzy snapshot may have applied some subset of the state changes delivered during the snapshot generation, the result may not correspond to the state of ZooKeeper at any time.</li>
<li>However, since state changes are idempotent, we can apply them twice as long as we apply the state changes in order.</li>
</ol>
<h3 id="how-does-zookeeper-handle-sync"><a class="markdownIt-Anchor" href="#how-does-zookeeper-handle-sync"></a> How does ZooKeeper handle sync()</h3>
<ol>
<li>It does not need to atomically broadcast sync as using a leader-based algorithm, and it simply places the <code>sync</code> operation at the end of the queue of requests between the leader and the server executing the call to sync.</li>
<li>The follower must be sure that the leader is still the leader.
<ul>
<li>If pending transactions are committed, then the server does not suspect the leader.</li>
<li>If the pending queue is empty, the leader must issue a null transaction to commit and order the <code>sync</code> after that transaction.</li>
<li>Hence, no extra broadcast traffic is generated when the leader is under load.</li>
<li>Timeouts are set so leaders realize they are not leaders before followers abandon them, so it does not issue the null transaction.</li>
</ul>
</li>
</ol>
<h3 id="how-does-zookeeper-ensure-to-serve-data-at-least-as-updated-as-the-last-server-served-that-data"><a class="markdownIt-Anchor" href="#how-does-zookeeper-ensure-to-serve-data-at-least-as-updated-as-the-last-server-served-that-data"></a> How does ZooKeeper ensure to serve data at least as updated as the last server served that data?</h3>
<ol>
<li>Check the client’s last zxid against its last zxid.</li>
<li>If the client has a more recent view than the server, the server does not reestablish the session with the client until the server has caught up.</li>
</ol>
<h3 id="how-to-detect-client-session-failures"><a class="markdownIt-Anchor" href="#how-to-detect-client-session-failures"></a> How to detect client session failures?</h3>
<ol>
<li>The leader determines that there has been a failure if no other server receives anything from a client session within the session timeout.</li>
<li>If the client sends requests frequently enough, then sending any other message is unnecessary.<br />
Otherwise, the client sends heartbeat messages during periods of low activity.</li>
<li>If the client cannot communicate with a server to send a request or heartbeat, it connects to a different ZooKeeper server to re-establish its session.</li>
<li>To prevent the session from timing out, the ZooKeeper client library sends a heartbeat after the session has been idle for <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi mathvariant="normal">/</mi><mn>3</mn></mrow><annotation encoding="application/x-tex">s/3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">s</span><span class="mord">/</span><span class="mord">3</span></span></span></span> ms and switch to a new server if it has not heard from a server for <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn><mi>s</mi><mi mathvariant="normal">/</mi><mn>3</mn></mrow><annotation encoding="application/x-tex">2s/3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">2</span><span class="mord mathnormal">s</span><span class="mord">/</span><span class="mord">3</span></span></span></span> ms, where <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi></mrow><annotation encoding="application/x-tex">s</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">s</span></span></span></span> is the session timeout in milliseconds.</li>
</ol>
<h1 id="evaluation-and-results"><a class="markdownIt-Anchor" href="#evaluation-and-results"></a> Evaluation and results</h1>
<ol>
<li>
<p>To show the system’s scalability, the author varied the number of servers that make up the ZooKeeper service but always kept the number of clients the same.</p>
<p>The throughput performance of a saturated system varies as the ratio of reads to writes is shown below.</p>
<img src="/imgs/Distributed/ZooKeeper/Throughput.png">
</li>
<li>
<p>There are two reasons why write requests take longer than read requests.</p>
<ul>
<li>First, write requests must go through atomic broadcast, which requires extra processing and adds latency to requests.</li>
<li>The other reason for the longer processing of write requests is that servers must ensure that transactions are logged to a non-volatile store before sending acknowledgments back to the leader.</li>
</ul>
</li>
<li>
<p>The atomic broadcast protocol does most of the system’s work and thus limits the performance of ZooKeeper more than any other component.</p>
<p>To benchmark its performance, the author simulates clients by generating transactions directly at the leader, so there are no client connections, requests, or replies.</p>
<p>The result is as shown below:</p>
<img src="/imgs/Distributed/ZooKeeper/AtomicBroadcast.png">
</li>
<li>
<p>The author also tested the system’s throughput when different failure events occurred.</p>
<p>The events are ① Failure and recovery of a follower; ② Failure and recovery of a different follower; ③ Failure of the leader; ④Failure of two followers (a, b) in the first two marks, and recovery at the third mark ©; ⑤ Failure of the leader; ⑥Recovery of the leader.</p>
<img src="/imgs/Distributed/ZooKeeper/Failures.png">
</li>
<li>
<p>To assess the latency of requests, the author creates a worker process that sends a create, waits for it to finish, sends an asynchronous delete of the new node, and then starts the next create.</p>
<p>Then, the throughput can be calculated by dividing the number of create requests completed by the total time it took all the workers to complete them.</p>
<img src="/imgs/Distributed/ZooKeeper/Latency.png">
</li>
<li>
<p>The author also measured the performance of primitives implemented with ZooKeeper. They measured the performance of barriers.</p>
<p>The time to process all barriers increases roughly linearly with the number of barriers, showing that concurrent access to the same part of the data tree did not produce any unexpected delay.</p>
<p>Latency increases proportionally to the number of clients. This is a consequence of not saturating the ZooKeeper service due to clients waiting on other clients.</p>
<img src="/imgs/Distributed/ZooKeeper/Barrier.png">
</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://liyun-zhang.github.io/2023/09/26/Paper/Distributed/Raft/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LiyunZhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LiyunZhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LiyunZhang">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/09/26/Paper/Distributed/Raft/" class="post-title-link" itemprop="url">Raft</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-09-26 13:14:13" itemprop="dateCreated datePublished" datetime="2023-09-26T13:14:13+08:00">2023-09-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-03-15 20:56:17" itemprop="dateModified" datetime="2024-03-15T20:56:17+08:00">2024-03-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Paper-Notebook/" itemprop="url" rel="index"><span itemprop="name">Paper Notebook</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Paper-Notebook/Distributed-System/" itemprop="url" rel="index"><span itemprop="name">Distributed System</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Paper: <a target="_blank" rel="noopener" href="http://nil.csail.mit.edu/6.824/2020/papers/raft-extended.pdf">In Search of an Understandable Consensus Algorithm</a></p>
<p><ul class="markdownIt-TOC">
<li><a href="#abstract">Abstract</a></li>
<li><a href="#purpose">Purpose</a></li>
<li><a href="#model">Model</a>
<ul>
<li><a href="#basics">Basics</a>
<ul>
<li><a href="#how-does-raft-implement-consensus-overall">How does Raft implement consensus overall?</a></li>
<li><a href="#what-are-the-states-of-each-server">What are the states of each server?</a></li>
<li><a href="#how-to-divide-the-terms">How to divide the terms?</a></li>
<li><a href="#how-do-terms-change">How do terms change?</a></li>
<li><a href="#how-does-raft-handle-follower-and-candidate-crashes">How does Raft handle follower and candidate crashes?</a></li>
<li><a href="#states-stored-on-servers">States stored on servers</a></li>
</ul>
</li>
<li><a href="#leader-election">Leader election</a>
<ul>
<li><a href="#how-do-the-servers-state-transit">How do the servers state transit?</a></li>
<li><a href="#how-to-elect-a-leader">How to elect a leader?</a></li>
<li><a href="#how-is-the-election-held">How is the election held?</a></li>
<li><a href="#how-to-determine-that-a-server-loses-the-election">How to determine that a server loses the election?</a></li>
<li><a href="#how-to-handle-a-split-vote">How to handle a split vote?</a></li>
<li><a href="#how-to-ensure-that-the-leader-of-any-given-term-contains-all-of-the-entries-committed-in-previous-terms">How to ensure that the leader of any given term contains all of the entries committed in previous terms?</a></li>
<li><a href="#what-are-the-limitations-of-broadcast-time-and-election-timeout">What are the limitations of broadcast time and election timeout?</a></li>
<li><a href="#requestvote-rpc">RequestVote RPC</a></li>
</ul>
</li>
<li><a href="#log-replication">Log replication</a>
<ul>
<li><a href="#how-are-client-requests-handled">How are client requests handled?</a></li>
<li><a href="#what-is-stored-in-a-log-entry">What is stored in a log entry?</a></li>
<li><a href="#how-to-apply-a-log-entry-to-the-state-machines">How to apply a log entry to the state machines?</a></li>
<li><a href="#how-to-determine-the-consistency-between-logs">How to determine the consistency between logs?</a></li>
<li><a href="#how-to-check-the-consistency-in-appendentries-rpcs">How to check the consistency in AppendEntries RPCs?</a></li>
<li><a href="#what-kinds-of-inconsistency-may-incur">What kinds of inconsistency may incur?</a></li>
<li><a href="#how-does-the-leader-handle-follower-inconsistencies">How does the leader handle follower inconsistencies?</a></li>
<li><a href="#how-does-appendentries-rpc-perform-a-consistency-check">How does AppendEntries RPC perform a consistency check?</a></li>
<li><a href="#how-to-handle-uncommitted-entries-from-previous-leaders">How to handle uncommitted entries from previous leaders?</a></li>
<li><a href="#appendentries-rpc">AppendEntries RPC</a></li>
</ul>
</li>
<li><a href="#log-compaction">Log compaction</a>
<ul>
<li><a href="#how-does-raft-compact-logs">How does Raft compact logs?</a></li>
<li><a href="#how-to-handle-the-appendentries-that-require-compated-entries">How to handle the AppendEntries that require compated entries?</a></li>
<li><a href="#how-to-install-the-snapshot-from-the-leader">How to install the snapshot from the leader?</a></li>
<li><a href="#when-should-a-server-take-a-snapshot">When should a server take a snapshot?</a></li>
<li><a href="#how-can-the-delays-of-normal-operations-caused-by-a-snapshot-be-reduced">How can the delays of normal operations caused by a snapshot be reduced?</a></li>
<li><a href="#installsnapshot-rpc">InstallSnapshot RPC</a></li>
</ul>
</li>
<li><a href="#client-interaction">Client interaction</a>
<ul>
<li><a href="#how-does-the-client-find-the-cluster-leader">How does the client find the cluster leader?</a></li>
<li><a href="#how-to-prevent-raft-from-executing-a-command-multiple-times">How to prevent Raft from executing a command multiple times?</a></li>
<li><a href="#how-to-prevent-returning-stale-data-to-a-read-only-operation">How to prevent returning stale data to a read-only operation?</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#experiments-and-results">Experiments and results</a></li>
<li><a href="#reproduce-and-unmentioned-parts">Reproduce and unmentioned parts</a></li>
</ul>
</p>
<h1 id="abstract"><a class="markdownIt-Anchor" href="#abstract"></a> Abstract</h1>
<ol>
<li><strong>Main idea</strong>: Understandability also matters for an algorithm to be implemented and deployed. Separate leader election and log replication parts in consensus to increase understandability. Linearizability is provided by restricting entries accepted by followers, and client commands are executed only once.</li>
<li><strong>Key findings</strong>: The key to the correctness of the system is that committed entries are durable in all nodes. We can easily induct it based on the Log Matching property and Leader Append-Only property. Another corner case is that leaders commit entries of previous terms only by committing entries from its term.</li>
<li><strong>The system</strong>: The elected leaders are restricted to be at least as up-to-date as majority nodes and only leaders can append entries from clients.</li>
<li><strong>Evaluation</strong>: The authors evaluated the understandability against Paxos, and the performance of elected leaders is measured.</li>
</ol>
<h1 id="purpose"><a class="markdownIt-Anchor" href="#purpose"></a> Purpose</h1>
<ol>
<li>Enhance the understandability of Paxos.
<ul>
<li>Raft separates the critical consensus elements, such as leader election, log replication, and safety.</li>
<li>It enforces a stronger coherency to reduce the number of states that must be considered.</li>
</ul>
</li>
<li>Novel features: strong leader, leader election, membership changes.</li>
<li><strong>What are the common properties of consensus algorithms?</strong>
<ul>
<li>Safety: never returning an incorrect result under all non-Byzantine conditions, including network delays, partitions, packet loss, duplication, and reordering.</li>
<li>Available as long as the majority of the servers are operational and can communicate with each other and with clients.</li>
<li>They do not depend on timing to ensure the consistency of the logs: faulty clocks and extreme message delays can, at worst, cause availability problems.</li>
<li>A command can be completed as soon as a majority of the cluster has responded to a single round of remote procedure calls; a minority of slow servers need not impact overall system performance.</li>
</ul>
</li>
</ol>
<h1 id="model"><a class="markdownIt-Anchor" href="#model"></a> Model</h1>
<h2 id="basics"><a class="markdownIt-Anchor" href="#basics"></a> Basics</h2>
<h3 id="how-does-raft-implement-consensus-overall"><a class="markdownIt-Anchor" href="#how-does-raft-implement-consensus-overall"></a> How does Raft implement consensus overall?</h3>
<ol>
<li>First, a distinguished leader is elected, and then the leader is responsible for managing the replicated log.</li>
<li>The leader accepts log entries from clients, replicates them on other servers, and tells servers when it is safe to apply them to their state machines.</li>
<li>A leader can fail or become disconnected from the other servers, in which case a new leader is elected.</li>
</ol>
<h3 id="what-are-the-states-of-each-server"><a class="markdownIt-Anchor" href="#what-are-the-states-of-each-server"></a> What are the states of each server?</h3>
<ol>
<li>Each server is in one of three states at any given time: leader, follower, or candidate.</li>
<li>In normal operation, there is exactly one leader, and all other servers are followers.</li>
<li>Followers are passive: they issue no requests on their own but respond to requests from leaders and candidates.</li>
<li>The leader handles all client requests. If a client contacts a follower, the follower redirects it to the leader.</li>
<li>The candidate is used to elect a new leader.</li>
</ol>
<h3 id="how-to-divide-the-terms"><a class="markdownIt-Anchor" href="#how-to-divide-the-terms"></a> How to divide the terms?</h3>
<ol>
<li>Terms are numbered with consecutive integers. Each election begins a new term.</li>
<li>If an election results in a split vote, the term will end with no leader; a new term with a new election will begin shortly.</li>
<li>Terms act as a logical clock in Raft, allowing servers to detect obsolete information, such as stale leaders.</li>
</ol>
<h3 id="how-do-terms-change"><a class="markdownIt-Anchor" href="#how-do-terms-change"></a> How do terms change?</h3>
<ol>
<li>Each server stores a current term number, which increases monotonically over time.</li>
<li>Current terms are exchanged whenever servers communicate; if one server’s term is smaller than the other’s, it updates its current term to the larger value.</li>
<li>If a candidate or leader discovers its term is outdated, it immediately reverts to a follower state.</li>
<li>The request is rejected if a server receives a request with a stale term number.</li>
</ol>
<h3 id="how-does-raft-handle-follower-and-candidate-crashes"><a class="markdownIt-Anchor" href="#how-does-raft-handle-follower-and-candidate-crashes"></a> How does Raft handle follower and candidate crashes?</h3>
<ol>
<li>If a follower or candidate crashes, then future <code>RequestVote</code> and <code>AppendEntries</code> RPCs sent to it will fail. Raft handles these failures by retrying indefinitely.</li>
<li>If a server crashes after completing an RPC but before responding, it will receive the same RPC again after it restarts. Raft RPCs are idempotent, i.e., servers will ignore the RPCs that are already handled, so this causes no harm.</li>
</ol>
<h3 id="states-stored-on-servers"><a class="markdownIt-Anchor" href="#states-stored-on-servers"></a> States stored on servers</h3>
<ol>
<li>Persistent state on all servers: These states must be updated on stable storage before responding to RPCs, i.e., communicating with outside.
<ul>
<li><code>currentTerm</code>: The latest term server has seen (initialized to 0 on first boot, increases monotonically)</li>
<li><code>votedFor</code>: the candidate that received the vote in the current term (or <code>null</code> if none)</li>
<li><code>log[]</code>: log entries</li>
</ul>
</li>
<li>Volatile state on all servers:
<ul>
<li><code>commitIndex</code>: index of highest log entry known to be committed (initialized to 0, increases monotonically)</li>
<li><code>lastApplied</code>: index of highest log entry applied to state machine (initialized to 0, increases monotonically)</li>
</ul>
</li>
<li>Volatile state on leaders: These states need to be reinitialized after the election
<ul>
<li><code>nextIndex[]</code>: for each server, the index of the next log entry to send to that server (initialized to leader last log index + 1)</li>
<li><code>matchIndex[]</code>: for each server, the index of the highest log entry known to be replicated on the server (initialized to 0, increases monotonically)</li>
</ul>
</li>
</ol>
<h2 id="leader-election"><a class="markdownIt-Anchor" href="#leader-election"></a> Leader election</h2>
<h3 id="how-do-the-servers-state-transit"><a class="markdownIt-Anchor" href="#how-do-the-servers-state-transit"></a> How do the servers state transit?</h3>
<ol>
<li>When servers start up, they begin as followers. A server remains in a follower state if it receives valid RPCs from a leader or candidate.</li>
<li>Leaders send periodic heartbeats (<code>AppendEntries</code> RPCs with no log entries) to all followers to maintain their authority.</li>
<li>Suppose a follower receives no communication over a period called the election timeout. In that case, it assumes there is no viable leader and becomes a candidate to initiate a new election.</li>
<li>A candidate who receives votes from a majority of the entire cluster becomes the new leader.<br />
<img src="/imgs/Distributed/Raft/01.png" alt="" /></li>
</ol>
<h3 id="how-to-elect-a-leader"><a class="markdownIt-Anchor" href="#how-to-elect-a-leader"></a> How to elect a leader?</h3>
<ol>
<li>To begin an election, a follower increments its current term and transitions to the candidate state.</li>
<li>It then votes for itself and issues <code>RequestVote</code> RPCs parallel to each other cluster server.</li>
<li>The candidate continues in this state until one of three things happens.
<ul>
<li>It wins the election.</li>
<li>Another server establishes itself as the leader.</li>
<li>A period of time goes by with no winner.</li>
</ul>
</li>
</ol>
<h3 id="how-is-the-election-held"><a class="markdownIt-Anchor" href="#how-is-the-election-held"></a> How is the election held?</h3>
<ol>
<li>Each server will vote for at most one candidate in a given term on a first-come-first-served basis to ensure that one candidate can win the election for a particular term.</li>
<li>A candidate wins an election if it receives votes from a majority of the servers in the whole cluster for the same term.</li>
<li>Once a candidate wins an election, it becomes the leader. It then sends heartbeat messages to all other servers to establish its authority and prevent new elections.</li>
</ol>
<h3 id="how-to-determine-that-a-server-loses-the-election"><a class="markdownIt-Anchor" href="#how-to-determine-that-a-server-loses-the-election"></a> How to determine that a server loses the election?</h3>
<ol>
<li>A candidate may receive an <code>AppendEntries</code> RPC from another server claiming to be the leader.</li>
<li>If the leader’s term is at least as large as the candidate’s current term, the candidate recognizes the leader as legitimate and returns to the follower state.</li>
<li>If the term in the RPC is smaller than the candidate’s current term, then the candidate rejects the RPC and continues in the candidate state.</li>
</ol>
<h3 id="how-to-handle-a-split-vote"><a class="markdownIt-Anchor" href="#how-to-handle-a-split-vote"></a> How to handle a split vote?</h3>
<ol>
<li>If many followers become candidates simultaneously, votes could be split so that no candidate obtains a majority.</li>
<li>Each candidate will time out and start a new election by incrementing their term and initiating another round of RequestVote RPCs.</li>
<li>Raft uses randomized election timeouts to ensure that split votes are rare and resolved quickly.
<ul>
<li>Election timeouts are chosen randomly from a fixed interval at the start of an election, and it waits for that timeout to elapse before starting the next election.</li>
<li>In most cases, only a single server will time out; it wins the election and sends heartbeats before any other servers time out.</li>
</ul>
</li>
</ol>
<h3 id="how-to-ensure-that-the-leader-of-any-given-term-contains-all-of-the-entries-committed-in-previous-terms"><a class="markdownIt-Anchor" href="#how-to-ensure-that-the-leader-of-any-given-term-contains-all-of-the-entries-committed-in-previous-terms"></a> How to ensure that the leader of any given term contains all of the entries committed in previous terms?</h3>
<ol>
<li>A candidate must contact a majority of the cluster to be elected, meaning that every committed entry must be present in at least one of those servers.</li>
<li>If the candidate’s log is at least as up-to-date as any others in that majority, it will hold all the committed entries.</li>
<li>In the <code>RequestVote</code> RPC, the voter denies voting if its log is more up-to-date than the candidate’s.</li>
<li>Raft determines which of the two logs is more up-to-date by comparing the index and term of the last log entries.
<ul>
<li>If the logs have last entries with different terms, then the log with the later term is more up-to-date.</li>
<li>If the logs end with the same term, the longer log is more up-to-date.</li>
</ul>
</li>
</ol>
<h3 id="what-are-the-limitations-of-broadcast-time-and-election-timeout"><a class="markdownIt-Anchor" href="#what-are-the-limitations-of-broadcast-time-and-election-timeout"></a> What are the limitations of broadcast time and election timeout?</h3>
<ol>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mi>r</mi><mi>o</mi><mi>a</mi><mi>d</mi><mi>c</mi><mi>a</mi><mi>s</mi><mi>t</mi><mi>T</mi><mi>i</mi><mi>m</mi><mi>e</mi><mo>≪</mo><mi>e</mi><mi>l</mi><mi>e</mi><mi>c</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi><mi>T</mi><mi>i</mi><mi>m</mi><mi>e</mi><mi>o</mi><mi>u</mi><mi>t</mi><mo>≪</mo><mi>M</mi><mi>T</mi><mi>B</mi><mi>F</mi></mrow><annotation encoding="application/x-tex">broadcastTime\ll electionTimeout\ll MTBF</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.73354em;vertical-align:-0.0391em;"></span><span class="mord mathnormal">b</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">o</span><span class="mord mathnormal">a</span><span class="mord mathnormal">d</span><span class="mord mathnormal">c</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord mathnormal">i</span><span class="mord mathnormal">m</span><span class="mord mathnormal">e</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≪</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.73354em;vertical-align:-0.0391em;"></span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mord mathnormal">c</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord mathnormal">i</span><span class="mord mathnormal">m</span><span class="mord mathnormal">e</span><span class="mord mathnormal">o</span><span class="mord mathnormal">u</span><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≪</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mord mathnormal" style="margin-right:0.13889em;">F</span></span></span></span></li>
<li>BbroadcastTime is the average time it takes a server to send RPCs in parallel to every server in the cluster and receive their responses. <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>e</mi><mi>l</mi><mi>e</mi><mi>c</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi><mi>T</mi><mi>i</mi><mi>m</mi><mi>e</mi><mi>o</mi><mi>u</mi><mi>t</mi></mrow><annotation encoding="application/x-tex">electionTimeout</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mord mathnormal">c</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord mathnormal">i</span><span class="mord mathnormal">m</span><span class="mord mathnormal">e</span><span class="mord mathnormal">o</span><span class="mord mathnormal">u</span><span class="mord mathnormal">t</span></span></span></span> is the election timeout. MTBF is the average time between failures for a single server.</li>
<li>The broadcast time should be an order of magnitude less than the election timeout so leaders can reliably send the heartbeat messages required to keep followers from starting elections.</li>
<li>The election timeout should be a few orders of magnitude less than MTBF so that the system makes steady progress.</li>
</ol>
<h3 id="requestvote-rpc"><a class="markdownIt-Anchor" href="#requestvote-rpc"></a> RequestVote RPC</h3>
<ol>
<li>Candidates invoke this to gather votes.</li>
<li>Arguments:
<ul>
<li><code>term</code>: candidate’s term</li>
<li><code>candidateId</code>: candidate requesting a vote</li>
<li><code>lastLogIndex</code>: index of candidate’s last log entry</li>
<li><code>lastLogTerm</code>: term of candidate’s last log entry</li>
</ul>
</li>
<li>Results:
<ul>
<li><code>term</code>: currentTerm, for candidate to update itself</li>
<li><code>voteGranted</code>: true means the candidate received a vote</li>
</ul>
</li>
<li>Receiver implementation:
<ul>
<li>Reply <code>false</code> if <code>term &lt; currentTerm</code></li>
<li>If votedFor is <code>null</code> or <code>candidateId</code>, and the candidate’s log is at least as up-to-date as the receiver’s log, grant vote</li>
</ul>
</li>
</ol>
<h2 id="log-replication"><a class="markdownIt-Anchor" href="#log-replication"></a> Log replication</h2>
<h3 id="how-are-client-requests-handled"><a class="markdownIt-Anchor" href="#how-are-client-requests-handled"></a> How are client requests handled?</h3>
<ol>
<li>Each client request contains a command to be executed by the replicated state machines.</li>
<li>The leader appends the command to its log as a new entry, then issues <code>AppendEntries</code> RPCs parallel to each other server to replicate the entry.</li>
<li>When the entry has been safely replicated, the leader applies the entry to its state machine and returns the result of that execution to the client.</li>
<li>Suppose followers crash or run slowly or network packets are lost. In that case, the leader retries <code>AppendEntries</code> RPCs indefinitely (even after it has responded to the client) until all followers eventually store all log entries.</li>
</ol>
<h3 id="what-is-stored-in-a-log-entry"><a class="markdownIt-Anchor" href="#what-is-stored-in-a-log-entry"></a> What is stored in a log entry?</h3>
<ol>
<li>A command for state machine</li>
<li>A term number when the leader received entry.</li>
<li>An index to identify its position in the log. The index of the first log is 1.</li>
</ol>
<h3 id="how-to-apply-a-log-entry-to-the-state-machines"><a class="markdownIt-Anchor" href="#how-to-apply-a-log-entry-to-the-state-machines"></a> How to apply a log entry to the state machines?</h3>
<ol>
<li>The leader decides when applying a log entry to the state machines is safe.
<ul>
<li>Such an entry is called <code>committed</code>.</li>
<li>Raft guarantees that committed entries are durable and will eventually be executed by all available state machines.</li>
</ul>
</li>
<li>A log entry is committed once the leader that created the entry has replicated it on a majority of the servers.</li>
<li>It also commits all preceding entries in the leader’s log, including entries created by previous leaders.</li>
<li>The leader keeps track of the highest index it knows to be committed, and it includes that index in future <code>AppendEntries</code> RPCs, including heartbeats, so that the other servers eventually find out that they should commit some new entries.</li>
<li>Once a follower learns that a log entry is committed, the entry is applied to its local state machine in log order.</li>
</ol>
<h3 id="how-to-determine-the-consistency-between-logs"><a class="markdownIt-Anchor" href="#how-to-determine-the-consistency-between-logs"></a> How to determine the consistency between logs?</h3>
<ol>
<li><strong>Log Matching property</strong>: If two logs contain an entry with the same index and term, the logs are identical in all entries up through the given index.</li>
<li>The Log Matching property is maintained through the following properties:
<ul>
<li>If two entries in different logs have the same index and term, they store the same command.</li>
<li>If two entries in different logs have the same index and term, then the logs are identical in all preceding entries.</li>
</ul>
</li>
</ol>
<h3 id="how-to-check-the-consistency-in-appendentries-rpcs"><a class="markdownIt-Anchor" href="#how-to-check-the-consistency-in-appendentries-rpcs"></a> How to check the consistency in AppendEntries RPCs?</h3>
<ol>
<li>When sending an <code>AppendEntries</code> RPC, the leader includes the index and term of the entry in its log, which immediately precedes the new entries.</li>
<li>If the follower does not find an entry with the same index and term in its log, it refuses the new entries.</li>
</ol>
<h3 id="what-kinds-of-inconsistency-may-incur"><a class="markdownIt-Anchor" href="#what-kinds-of-inconsistency-may-incur"></a> What kinds of inconsistency may incur?</h3>
<ol>
<li>Leader crashes can leave the logs inconsistent. The old leader may not have fully replicated all the entries in its log.</li>
<li>A follower may be missing entries that are present on the leader; it may have extra entries that are not present on the leader or both.</li>
</ol>
<h3 id="how-does-the-leader-handle-follower-inconsistencies"><a class="markdownIt-Anchor" href="#how-does-the-leader-handle-follower-inconsistencies"></a> How does the leader handle follower inconsistencies?</h3>
<ol>
<li><strong>Leader Append-Only</strong> property: a leader never overwrites or deletes entries in its log.</li>
<li>The leader handles inconsistencies by forcing the followers’ logs to duplicate its own. Namely, conflicting entries in follower logs will be overwritten with entries from the leader’s log.</li>
<li>The leader must find the latest log entry where the two logs agree, delete any entries in the follower’s log after that point, and send the follower all of the leader’s entries after that point.</li>
<li>These actions happen in response to the consistency check performed by AppendEntries RPCs.</li>
<li>A leader does not need to take any special actions to restore log consistency when it comes to power. It just begins normal operation, and the logs automatically converge in response to failures of the AppendEntries consistency check.</li>
</ol>
<h3 id="how-does-appendentries-rpc-perform-a-consistency-check"><a class="markdownIt-Anchor" href="#how-does-appendentries-rpc-perform-a-consistency-check"></a> How does AppendEntries RPC perform a consistency check?</h3>
<ol>
<li>The leader maintains a nextIndex for each follower. When a leader first comes to power, it initializes all nextIndex values to the index just after the last one in its log, i.e., assuming all followers are as up-to-date as itself.</li>
<li>If a follower’s log is inconsistent with the leader’s, the consistency check will fail in the next <code>AppendEntries</code> RPC.</li>
<li>After a rejection, the leader decrements nextIndex and retries the <code>AppendEntries</code> RPC.</li>
<li>Eventually, <code>nextIndex</code> will reach a point where the leader and follower logs match. When this happens, <code>AppendEntries</code> will succeed, removing any conflicting entries in the follower’s log and appending entries from the leader’s log (if any).</li>
<li>Once <code>AppendEntries</code> succeeds, the follower’s log is consistent with the leader’s, and it will remain that way for the rest of the term.</li>
</ol>
<h3 id="how-to-handle-uncommitted-entries-from-previous-leaders"><a class="markdownIt-Anchor" href="#how-to-handle-uncommitted-entries-from-previous-leaders"></a> How to handle uncommitted entries from previous leaders?</h3>
<ol>
<li>If a leader crashes before committing an entry, future leaders will attempt to finish replicating the entry.</li>
<li>A leader cannot immediately conclude that an entry from a previous term <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mi>e</mi><mi>r</mi><msub><mi>m</mi><mi>p</mi></msub></mrow><annotation encoding="application/x-tex">term_p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9011879999999999em;vertical-align:-0.286108em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span> is committed once it is stored on a majority of servers.
<ul>
<li>There could be other entries in a <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mi>e</mi><mi>r</mi><msub><mi>m</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">term_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76508em;vertical-align:-0.15em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> between <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mi>e</mi><mi>r</mi><msub><mi>m</mi><mi>p</mi></msub></mrow><annotation encoding="application/x-tex">term_p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9011879999999999em;vertical-align:-0.286108em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span> and the leader’s current term <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mi>e</mi><mi>r</mi><msub><mi>m</mi><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">term_c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76508em;vertical-align:-0.15em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>.</li>
<li>If nothing in the leader’s current term has reached an agreement after the leader dies, that server with <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mi>e</mi><mi>r</mi><msub><mi>m</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">term_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76508em;vertical-align:-0.15em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> may become the new leader, and it can overwrite entries of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mi>e</mi><mi>r</mi><msub><mi>m</mi><mi>p</mi></msub></mrow><annotation encoding="application/x-tex">term_p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9011879999999999em;vertical-align:-0.286108em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span> although those entries are committed since <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mi>e</mi><mi>r</mi><msub><mi>m</mi><mi>i</mi></msub><mo>&gt;</mo><mi>t</mi><mi>e</mi><mi>r</mi><msub><mi>m</mi><mi>p</mi></msub></mrow><annotation encoding="application/x-tex">term_i&gt;term_p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76508em;vertical-align:-0.15em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.9011879999999999em;vertical-align:-0.286108em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span></li>
</ul>
</li>
<li>Raft never commits log entries from previous terms by counting replicas.</li>
<li>Only log entries from the leader’s current term are committed by counting replicas; once an entry from the current term has been committed, all prior entries are committed indirectly because of the Log Matching Property.</li>
</ol>
<h3 id="appendentries-rpc"><a class="markdownIt-Anchor" href="#appendentries-rpc"></a> AppendEntries RPC</h3>
<ol>
<li>Leader invokes this to replicate log entries; also used as heartbeat.</li>
<li>Arguments:
<ul>
<li><code>term</code>: leader’s term</li>
<li><code>leaderId</code>: so follower can redirect clients</li>
<li><code>prevLogIndex</code>: index of log entry immediately preceding new ones.</li>
<li><code>prevLogTerm</code>: term of <code>prevLogIndex</code> entry</li>
<li><code>entries[]</code>: log entries to store (empty for hearbeat; may send more than one for efficiency)</li>
<li><code>leaderCommit</code>: leader’s <code>commitIndex</code></li>
</ul>
</li>
<li>Results:
<ul>
<li><code>term</code>: <code>currentTerm</code>, for the leader to update itself</li>
<li><code>success</code>: true if the follower contained an entry matching <code>prevLogIndex</code> and <code>prevLogTerm</code></li>
</ul>
</li>
<li>Receiver implementation:
<ul>
<li>Reply <code>false</code> if <code>term &lt; currentTerm</code></li>
<li>Reply <code>false</code> if log doesn’t contain an entry at <code>prevLogIndex</code> whose term matches <code>prevLogTerm</code></li>
<li>If an existing entry conflicts with a new one (same index but different terms), delete the existing entry and all that follow it.</li>
<li>Append any new entries that are not already in the log.</li>
<li>If <code>leaderCommit &gt; commitIndex</code>, set <code>commitIndex = min(leaderCommit, index of last new entry)</code>.</li>
</ul>
</li>
</ol>
<h2 id="log-compaction"><a class="markdownIt-Anchor" href="#log-compaction"></a> Log compaction</h2>
<h3 id="how-does-raft-compact-logs"><a class="markdownIt-Anchor" href="#how-does-raft-compact-logs"></a> How does Raft compact logs?</h3>
<ol>
<li>In snapshotting, the entire current system state is written to a snapshot on stable storage.</li>
<li>Once a server completes writing a snapshot, it may delete all log entries up through the last included index and any prior snapshot.</li>
<li>Each server takes snapshots independently, covering just the committed entries in its log.</li>
<li>Data still only flows from leaders to followers; followers can now reorganize their data.</li>
</ol>
<h3 id="how-to-handle-the-appendentries-that-require-compated-entries"><a class="markdownIt-Anchor" href="#how-to-handle-the-appendentries-that-require-compated-entries"></a> How to handle the AppendEntries that require compated entries?</h3>
<ol>
<li>Raft also includes a small amount of metadata in the snapshot.
<ul>
<li>The <code>last included index</code> is the index of the last entry in the log that the snapshot replaces (the last entry the state machine had applied).</li>
<li>The <code>last included term</code> is the term of this entry.</li>
</ul>
</li>
<li>When the leader has already discarded the next log entry that it needs to send to a follower.</li>
<li>This situation is unlikely in normal operation: a follower that has kept up with the leader would already have this entry. However, an exceptionally slow follower or a new server joining the cluster would not.</li>
</ol>
<h3 id="how-to-install-the-snapshot-from-the-leader"><a class="markdownIt-Anchor" href="#how-to-install-the-snapshot-from-the-leader"></a> How to install the snapshot from the leader?</h3>
<ol>
<li>The leader uses a new RPC called <code>InstallSnapshot</code> to send snapshots to followers that are too far behind.</li>
<li>When a follower receives a snapshot with this RPC, it must decide what to do with its existing log entries.</li>
<li>If the snapshot contains new information not already in the recipient’s log
<ul>
<li>The follower discards the entire log.</li>
<li>It is all superseded by the snapshot and may have uncommitted entries that conflict with the snapshot.</li>
</ul>
</li>
<li>If, instead, the follower receives a snapshot that describes a prefix of its log
<ul>
<li>This could be due to retransmission or by mistake.</li>
<li>Log entries covered by the snapshot have been deleted, but entries following the snapshot are still valid and must be retained.</li>
</ul>
</li>
</ol>
<h3 id="when-should-a-server-take-a-snapshot"><a class="markdownIt-Anchor" href="#when-should-a-server-take-a-snapshot"></a> When should a server take a snapshot?</h3>
<ol>
<li>If a server snapshots too often, it wastes disk bandwidth and energy; if it snapshots too infrequently, it risks exhausting its storage capacity, increasing the time required to replay the log during restarts.</li>
<li>A straightforward strategy is to take a snapshot when the log reaches a fixed size in bytes.</li>
<li>If this size is significantly larger than a snapshot’s expected size, then the disk bandwidth overhead for snapshotting will be small.</li>
</ol>
<h3 id="how-can-the-delays-of-normal-operations-caused-by-a-snapshot-be-reduced"><a class="markdownIt-Anchor" href="#how-can-the-delays-of-normal-operations-caused-by-a-snapshot-be-reduced"></a> How can the delays of normal operations caused by a snapshot be reduced?</h3>
<ol>
<li>The solution is to use copy-on-write techniques to accept new updates without impacting the snapshot being written.</li>
<li>The operating system’s copy-on-write support (e.g., fork on Linux) can create an in-memory snapshot of the entire state machine.</li>
</ol>
<h3 id="installsnapshot-rpc"><a class="markdownIt-Anchor" href="#installsnapshot-rpc"></a> InstallSnapshot RPC</h3>
<ol>
<li>The leader invokes this to send chunks of snapshot to a follower. Leaders always send chunks in order.</li>
<li>Arguments:
<ul>
<li><code>term</code>: leader’s term</li>
<li><code>leaderId</code>: so follower can redirect clients</li>
<li><code>lastIncludedIndex</code>: the snapshot replaces all entries up through and including this index</li>
<li><code>lastIncludedTerm</code>: term of <code>lastIncludedIndex</code></li>
<li><code>offset</code>: byte offset where the chunk is positioned in the snapshot file
<ul>
<li>The whole snapshot file may be large and hence divided into several chunks.</li>
</ul>
</li>
<li><code>data[]</code>: raw bytes of the snapshot chunk, starting at offset</li>
<li><code>done</code>: <code>true</code> if this is the last chunk</li>
</ul>
</li>
<li>Results:
<ul>
<li><code>term</code>: <code>currentTerm</code>, for the leader to update itself</li>
</ul>
</li>
<li>Receiver implementation:
<ul>
<li>Reply immediately if <code>term &lt; currentTerm</code></li>
<li>Create a new snapshot file if the first chunk (offset is 0)</li>
<li>Write data into a snapshot file at the given offset.</li>
<li>Reply and wait for more data chunks if done is <code>false</code>.</li>
<li>Save the snapshot file, and discard any existing or partial snapshots with a smaller index.</li>
<li>If the existing log entry has the same index and term as the snapshot’s last included entry, retain log entries following it and reply</li>
<li>Discard the entire log.</li>
<li>Reset state machine using snapshot contents (and load snapshot’s cluster configuration)</li>
</ul>
</li>
</ol>
<h2 id="client-interaction"><a class="markdownIt-Anchor" href="#client-interaction"></a> Client interaction</h2>
<h3 id="how-does-the-client-find-the-cluster-leader"><a class="markdownIt-Anchor" href="#how-does-the-client-find-the-cluster-leader"></a> How does the client find the cluster leader?</h3>
<ol>
<li>When a client first starts up
<ul>
<li>It connects to a randomly chosen server.</li>
<li>If the client’s first choice is not the leader, that server will reject the request and supply information about the most recent leader it has heard from.</li>
</ul>
</li>
<li>If the leader crashes
<ul>
<li>Client requests will time out.</li>
<li>Clients then try again with randomly chosen servers.</li>
</ul>
</li>
</ol>
<h3 id="how-to-prevent-raft-from-executing-a-command-multiple-times"><a class="markdownIt-Anchor" href="#how-to-prevent-raft-from-executing-a-command-multiple-times"></a> How to prevent Raft from executing a command multiple times?</h3>
<ol>
<li>Our goal for Raft is to implement linearizable semantics, i.e., each operation appears to execute instantaneously, exactly once, at some point between its invocation and its response.
<ul>
<li>One case of executing a command multiple times is if the leader crashes after committing the log entry but before responding to the client; the client will retry the command with a new leader, causing it to be executed a second time.</li>
</ul>
</li>
<li>The solution is for clients to assign unique serial numbers to every command.</li>
<li>Then, the state machine tracks the latest serial number processed for each client and the associated response.</li>
<li>If it receives a command with a serial number already executed, it responds immediately without re-executing the request.</li>
</ol>
<h3 id="how-to-prevent-returning-stale-data-to-a-read-only-operation"><a class="markdownIt-Anchor" href="#how-to-prevent-returning-stale-data-to-a-read-only-operation"></a> How to prevent returning stale data to a read-only operation?</h3>
<ol>
<li>The stale reading is because the leader responding to the request might have been superseded by a newer leader of which it is unaware.</li>
<li>A leader must have the latest information on which entries are committed.
<ul>
<li>The Leader Completeness Property guarantees that a leader has all committed entries, but at the start of its term, it may not know which those are.</li>
<li>To find out, it needs to commit an entry from its term.</li>
<li>Raft handles this by having each leader commit a blank <em>no-op</em> entry into the log at the start of its term.</li>
</ul>
</li>
<li>A leader must check whether it has been deposed before processing a read-only request since its information may be stale if a more recent leader has been elected).
<ul>
<li>Raft handles this by having the leader exchange heartbeat messages with a majority of the cluster before responding to read-only requests.</li>
<li>Alternatively, the leader could rely on the heartbeat mechanism to provide a lease, but this would rely on timing for safety (it assumes bounded clock skew).</li>
</ul>
</li>
</ol>
<h1 id="experiments-and-results"><a class="markdownIt-Anchor" href="#experiments-and-results"></a> Experiments and results</h1>
<ol>
<li>The main goal of Raft is to propose a consensus algorithm that is easier to understand than Paxos. Hence, the author measured this model’s understandability through learning student scores.</li>
<li>The most critical measure of a new system is its correctness. The author proved Raft’s correctness with formal specifications.</li>
<li>Finally, the author also measured the performance of Raft, which is similar to other consensus algorithms.</li>
<li>The election timeout will affect the system’s performance through the performance of the leader election. Hence, the author measured how the randomization and base election timeout would affect the performance.
<ul>
<li>A small randomization in the election timeout is enough to avoid split votes. Using more randomness improves worst-case behavior.</li>
<li>Downtime can be reduced by reducing the election timeout.
<ul>
<li>However, lowering the timeouts beyond 12 - 14 ms violates Raft’s timing requirement: leaders have difficulty broadcasting heartbeats before other servers start new elections. This can cause unnecessary leader changes and lower overall system availability.</li>
<li>The author recommends using a conservative election timeout such as 150–300ms; such timeouts are unlikely to cause unnecessary leader changes and will still provide good availability.</li>
</ul>
</li>
<li>
<img src="/imgs/Distributed/Raft/02.png" style="zoom:33%;" />
</li>
</ul>
</li>
</ol>
<h1 id="reproduce-and-unmentioned-parts"><a class="markdownIt-Anchor" href="#reproduce-and-unmentioned-parts"></a> Reproduce and unmentioned parts</h1>
<p>Reference to Labs 2, 3, and 4 of MIT 6.824.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="Previous page" aria-label="Previous page" href="/about/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/about/">1</a><span class="page-number current">2</span><a class="page-number" href="/about/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/about/page/7/">7</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/about/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">LiyunZhang</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" rel="noopener" target="_blank">NexT.Mist</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>







  




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.7/katex.min.css" integrity="sha256-hLTCMFlKxdNgPXyWlSSxYN0ykJmxxq9Yt3MNfdRGWeA=" crossorigin="anonymous">



</body>
</html>

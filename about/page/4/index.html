<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"liyun-zhang.github.io","root":"/","images":"/images","scheme":"Mist","darkmode":true,"version":"8.17.0","exturl":false,"sidebar":{"position":"right","display":"hide","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="LiyunZhang">
<meta property="og:url" content="http://liyun-zhang.github.io/about/page/4/index.html">
<meta property="og:site_name" content="LiyunZhang">
<meta property="og:locale">
<meta property="article:author" content="LiyunZhang">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://liyun-zhang.github.io/about/page/4/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-Hans","comments":"","permalink":"","path":"about/page/4/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>LiyunZhang</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">LiyunZhang</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">LiyunZhang</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">67</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">11</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">31</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://liyun-zhang.github.io/2023/08/31/Courses/15445/15-Introduction-to-Distributed-Databases/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LiyunZhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LiyunZhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LiyunZhang">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/08/31/Courses/15445/15-Introduction-to-Distributed-Databases/" class="post-title-link" itemprop="url">15 Introduction to Distributed Databases</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-08-31 23:53:22" itemprop="dateCreated datePublished" datetime="2023-08-31T23:53:22+08:00">2023-08-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-03-16 16:48:43" itemprop="dateModified" datetime="2024-03-16T16:48:43+08:00">2024-03-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Open-Courses/" itemprop="url" rel="index"><span itemprop="name">Open Courses</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Open-Courses/CMU-15-445-645-Database-System/" itemprop="url" rel="index"><span itemprop="name">CMU 15-445/645 Database System</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><ul class="markdownIt-TOC">
<li><a href="#system-architecture">System architecture</a>
<ul>
<li><a href="#what-will-system-architecture-affect">What will system architecture affect?</a></li>
<li><a href="#what-is-shared-memory-architecture">What is shared memory architecture?</a></li>
<li><a href="#what-is-shared-disk-architecture">What is shared disk architecture?</a></li>
<li><a href="#what-is-shared-nothing-architecture">What is shared-nothing architecture?</a></li>
</ul>
</li>
<li><a href="#design-issues">Design issues</a>
<ul>
<li><a href="#what-are-the-design-issues-of-distributed-databases">What are the design issues of distributed databases?</a></li>
<li><a href="#what-do-nodes-look-like">What do nodes look like?</a></li>
<li><a href="#how-to-coordinate-execution">How to coordinate execution?</a></li>
</ul>
</li>
<li><a href="#partitioning-schemes">Partitioning Schemes</a>
<ul>
<li><a href="#what-do-we-desire-when-partitioning-a-database">What do we desire when partitioning a database?</a></li>
<li><a href="#how-can-we-partition-the-database">How can we partition the database?</a></li>
<li><a href="#how-can-we-optimize-horizontal-partitioning">How can we optimize horizontal partitioning?</a></li>
</ul>
</li>
</ul>
</p>
<h1 id="system-architecture"><a class="markdownIt-Anchor" href="#system-architecture"></a> System architecture</h1>
<h2 id="what-will-system-architecture-affect"><a class="markdownIt-Anchor" href="#what-will-system-architecture-affect"></a> What will system architecture affect?</h2>
<ol>
<li>A distributed DBMS’s system architecture specifies what shared resources are directly accessible to CPUs.</li>
<li>This affects how CPUs coordinate with each other and where they retrieve/store objects in the database.</li>
<li>There are four architectures: shared everything, shared memory, shared disk, and shared nothing.</li>
<li>In shared everything architecture, CPU, memories, and disks are all local. This is more of a parallel architecture than a distributed architecture.</li>
</ol>
<h2 id="what-is-shared-memory-architecture"><a class="markdownIt-Anchor" href="#what-is-shared-memory-architecture"></a> What is shared memory architecture?</h2>
<ol>
<li>CPUs have access to common memory address space via a fast interconnect.</li>
<li>Each processor has a global view of all the in-memory data structures.
<ul>
<li>Each process’s memory scope is the same memory address space multiple processes can modify.</li>
</ul>
</li>
<li>Each DBMS instance on a processor must “know” about the other instances.</li>
<li>In practice, most DBMSs do not use this architecture, as it is provided at the OS/kernel level.</li>
</ol>
<img src="/imgs/15445/Distributed/shared_mem.png" width="30%">
<h2 id="what-is-shared-disk-architecture"><a class="markdownIt-Anchor" href="#what-is-shared-disk-architecture"></a> What is shared disk architecture?</h2>
<ol>
<li>All CPUs can access a single logical disk directly via an interconnect, but each has its own private memories.</li>
<li>It can scale the execution layer independently from the storage layer.
<ul>
<li>The advantage of shared disk over shared nothing is that it can easily scale up with the compute and storage layers independently.</li>
<li>What we want to persist after a crash is in the storage layer.</li>
<li>Theoretically, we can kill or add front-end nodes without losing the database or, add storage disks / change the storage layer by modifying compute nodes.</li>
</ul>
</li>
<li>It must send messages between CPUs to learn about their current state.</li>
<li>This architecture is commonly used in OLAP systems. Many DBSMs begin to think that shared disk architecture is better than shared nothing.</li>
</ol>
<img src="/imgs/15445/Distributed/shared_disk.png" width="30%">
<h2 id="what-is-shared-nothing-architecture"><a class="markdownIt-Anchor" href="#what-is-shared-nothing-architecture"></a> What is shared-nothing architecture?</h2>
<ol>
<li>Each DBMS instance has its own CPU, memory, and local disk.</li>
<li>Nodes only communicate with each other via network.
<ul>
<li>When executing a query that requires data from different nodes, the DBMS can either send data up to the node connected with the application or that node can ask another node to execute the query and return the result.</li>
</ul>
</li>
<li>All data in the database are sharded into different nodes.
<ul>
<li>When adding a new node into the architecture, that node is initially empty. The DBMS must re-shard data so that they are distributed evenly.</li>
<li>It is more difficult to increase capacity because the DBMS has to move data to new nodes physically.</li>
<li>It might have a small window for queries to receive false positives because part of the data was in that node and is now moving to another node.</li>
</ul>
</li>
<li>It is also difficult to ensure consistency across all nodes in the DBMS since the nodes must coordinate with each other regarding the state of transactions.</li>
<li>However, it can potentially achieve better performance and be more efficient than other types of distributed DBMS architectures.</li>
</ol>
<img src="/imgs/15445/Distributed/shared_nothing.png" width="30%">
<h1 id="design-issues"><a class="markdownIt-Anchor" href="#design-issues"></a> Design issues</h1>
<h2 id="what-are-the-design-issues-of-distributed-databases"><a class="markdownIt-Anchor" href="#what-are-the-design-issues-of-distributed-databases"></a> What are the design issues of distributed databases?</h2>
<ol>
<li>How does the application find data?</li>
<li>Where does the application send queries?</li>
<li>How to execute queries on distributed data? Push query to data? Or pull data to query?</li>
<li>How does the DBMS ensure correctness?</li>
<li>How do we divide the database across resources?</li>
</ol>
<h2 id="what-do-nodes-look-like"><a class="markdownIt-Anchor" href="#what-do-nodes-look-like"></a> What do nodes look like?</h2>
<ol>
<li>The first approach is homogenous nodes.
<ul>
<li>Every node in the cluster can perform the same set of tasks, albeit on potentially different partitions of data.</li>
<li>Makes provisioning and failover “easier” since any node can replace other nodes.</li>
</ul>
</li>
<li>The second approach is heterogeneous nodes.
<ul>
<li>Nodes are assigned specific tasks.</li>
<li>It can allow a single physical node to host multiple “virtual” node types for dedicated tasks.</li>
<li>A heterogeneous node design has two kinds of nodes: router and config server.
<ul>
<li>The router can directly access shards of the database, yet it does not know where the data is wanted.</li>
<li>The config server knows the data contained in each shard. However, it is not responsible for retrieving them.</li>
</ul>
</li>
</ul>
</li>
</ol>
<h2 id="how-to-coordinate-execution"><a class="markdownIt-Anchor" href="#how-to-coordinate-execution"></a> How to coordinate execution?</h2>
<ol>
<li>If our DBMS supports multi-operation and distributed transactions, we need a way to coordinate their execution in the system.</li>
<li>The first approach is a centralized coordinator. A centralized coordinator receives commands from the application.
<ul>
<li>The first design requires applications to handle transactions.
<ul>
<li>The client communicates with the coordinator to acquire locks on the partitions that the client wants to access.</li>
<li>Once it receives an acknowledgment from the coordinator, the client sends its queries to those partitions.</li>
<li>Once all queries for a given transaction are done, the client sends a commit request to the coordinator.</li>
<li>The coordinator then communicates with the partitions involved in the transaction to determine whether the transaction is allowed to be committed.</li>
</ul>
</li>
<li>Another design uses middleware to accept query requests and route queries to correct partitions.</li>
</ul>
</li>
<li>The second approach is decentralized.
<ul>
<li>The client directly sends queries to one of the partitions, which will be the leader node for that transaction.</li>
<li>The leader node will coordinate communicating with other partitions and committing.</li>
</ul>
</li>
</ol>
<h1 id="partitioning-schemes"><a class="markdownIt-Anchor" href="#partitioning-schemes"></a> Partitioning Schemes</h1>
<h2 id="what-do-we-desire-when-partitioning-a-database"><a class="markdownIt-Anchor" href="#what-do-we-desire-when-partitioning-a-database"></a> What do we desire when partitioning a database?</h2>
<ol>
<li>Applications should not be required to know where data is physically located in a distributed DBMS.
<ul>
<li>Any query that runs on a single-node DBMS should produce the same result on a distributed DBMS.</li>
<li>The DBMS executes query fragments on each partition and then combines the results to produce a single answer.</li>
</ul>
</li>
<li>In practice, developers need to be aware of the communication costs of queries to avoid excessively “expensive” data movement.</li>
<li>The DBMS can partition a database physically for shared nothing or logically for shared disk.
<ul>
<li>In Logical partitioning, each node is responsible for certain designated data. They cannot access data out of their duty. However, data are stored in independent storage nodes, which computation nodes can all access.</li>
<li>In physical partitioning, data out of their duty cannot be accessed directly since they are stored in the local disk of other nodes.</li>
</ul>
</li>
</ol>
<h2 id="how-can-we-partition-the-database"><a class="markdownIt-Anchor" href="#how-can-we-partition-the-database"></a> How can we partition the database?</h2>
<ol>
<li>The first method is the naive table partitioning.
<ul>
<li>Assign an entire table to a single node.</li>
<li>It assumes that each node has enough storage space for an entire table.</li>
<li>This is ideal if queries never join data across tables stored on different nodes and access patterns are uniform.</li>
</ul>
</li>
<li>The second method is vertical partitioning.
<ul>
<li>Split a table’s attributes into separate partitions.</li>
<li>It must store tuple information to reconstruct the original record.</li>
</ul>
</li>
<li>The third method is horizontal partitioning.
<ul>
<li>Split a table’s tuples into disjoint subsets based on some partitioning key and scheme.</li>
<li>Choose column(s) that divides the database equally in terms of size, load, or usage.</li>
<li>It can partition based on hashing, ranges, or predicates.</li>
</ul>
</li>
</ol>
<h2 id="how-can-we-optimize-horizontal-partitioning"><a class="markdownIt-Anchor" href="#how-can-we-optimize-horizontal-partitioning"></a> How can we optimize horizontal partitioning?</h2>
<ol>
<li>The main problem is that the DBMS needs to reshuffle data when adding a new storage node.</li>
<li>We can use the consistent hashing.
<ul>
<li>The hashing value is between <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span> forming a circle.</li>
<li>Each nodes are assigned a value between <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>. Data are stored in the node with the closest value to its hashing values going in clockwise order.</li>
<li>When adding a node, only one node needs to transmit data to the new node instead of transmitting data between all pairs of nodes.</li>
</ul>
</li>
<li>With consistent hashing, we can support replication easily.
<ul>
<li>Store data in the first batch of nodes with the closest value in clockwise order.</li>
</ul>
</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://liyun-zhang.github.io/2023/08/30/Courses/15445/14-Database-Recovery/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LiyunZhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LiyunZhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LiyunZhang">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/08/30/Courses/15445/14-Database-Recovery/" class="post-title-link" itemprop="url">14 Database Recovery</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-08-30 19:12:36" itemprop="dateCreated datePublished" datetime="2023-08-30T19:12:36+08:00">2023-08-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-03-16 16:30:32" itemprop="dateModified" datetime="2024-03-16T16:30:32+08:00">2024-03-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Open-Courses/" itemprop="url" rel="index"><span itemprop="name">Open Courses</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Open-Courses/CMU-15-445-645-Database-System/" itemprop="url" rel="index"><span itemprop="name">CMU 15-445/645 Database System</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><ul class="markdownIt-TOC">
<li><a href="#what-are-the-main-ideas-of-aries">What are the main ideas of ARIES?</a></li>
<li><a href="#record-logs">Record logs</a>
<ul>
<li><a href="#what-are-the-lsns">What are the LSNs?</a></li>
<li><a href="#how-to-handle-transaction-commits">How to handle transaction commits?</a></li>
<li><a href="#how-to-handle-transaction-abort">How to handle transaction abort?</a></li>
</ul>
</li>
<li><a href="#fuzzy-checkpoints">Fuzzy checkpoints</a>
<ul>
<li><a href="#how-can-we-improve-the-naive-checkpoints">How can we improve the naive checkpoints?</a></li>
<li><a href="#how-can-we-checkpoint-without-stalling-transactions">How can we checkpoint without stalling transactions?</a></li>
</ul>
</li>
<li><a href="#recovery">Recovery</a>
<ul>
<li><a href="#how-does-aries-recover-from-the-crash">How does ARIES recover from the crash?</a></li>
<li><a href="#what-does-the-analysis-phase-do">What does the analysis phase do?</a></li>
<li><a href="#what-does-the-redo-phase-do">What does the redo phase do?</a></li>
<li><a href="#what-does-the-undo-phase-do">What does the undo phase do?</a></li>
</ul>
</li>
</ul>
</p>
<h1 id="what-are-the-main-ideas-of-aries"><a class="markdownIt-Anchor" href="#what-are-the-main-ideas-of-aries"></a> What are the main ideas of ARIES?</h1>
<ol>
<li>ARIES: Algorithms for Recovery and Isolation Exploiting Semantics</li>
<li>Write-Ahead Logging:
<ul>
<li>Any change is recorded in the log on stable storage before the database change is written to disk.</li>
<li>Must use steal and no-force buffer pool policies.
<ul>
<li>Logs are forced to be flushed into the disk, while modified pages are not.</li>
<li>Force is also correct, but it damages runtime performance, making no one use it.</li>
</ul>
</li>
</ul>
</li>
<li>Repeating History During Redo: On DBMS restart, retrace actions and restore the database to the exact state before the crash.</li>
<li>Logging Changes During Undo: Record undo actions to log to ensure action is not repeated in the event of repeated failures.</li>
</ol>
<h1 id="record-logs"><a class="markdownIt-Anchor" href="#record-logs"></a> Record logs</h1>
<h2 id="what-are-the-lsns"><a class="markdownIt-Anchor" href="#what-are-the-lsns"></a> What are the LSNs?</h2>
<ol>
<li>Every log record now includes a globally unique, monotonically increasing log sequence number (LSN).
<ul>
<li>LSNs represent the physical order in which transactions make changes to the database.</li>
</ul>
</li>
<li>Various components in the system keep track of LSNs that pertain to them.
<ul>
<li>In memory, the system uses <code>flushedLSN</code> to track the last LSN in the log on disk.</li>
<li>In each disk page, <code>pageLSN</code> is used to track the newest update to that page, while <code>recLSN</code> is tracking the oldest update to that page since it was last flushed.</li>
<li>Each transaction maintains the <code>lastLSN</code> representing the latest record of that transaction.</li>
<li>There is also a MasterRecord in the disk, meaning the LSN of the latest checkpoint.</li>
</ul>
</li>
<li>Before the DBMS can write page x to disk, it must flush the log at least to the point where <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mi>a</mi><mi>g</mi><mi>e</mi><mi>L</mi><mi>S</mi><msub><mi>N</mi><mi>x</mi></msub><mo>≤</mo><mi>f</mi><mi>l</mi><mi>u</mi><mi>s</mi><mi>h</mi><mi>e</mi><mi>d</mi><mi>L</mi><mi>S</mi><mi>N</mi></mrow><annotation encoding="application/x-tex">pageLSN_x ≤ flushedLSN</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">p</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal">e</span><span class="mord mathnormal">L</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.10903em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">u</span><span class="mord mathnormal">s</span><span class="mord mathnormal">h</span><span class="mord mathnormal">e</span><span class="mord mathnormal">d</span><span class="mord mathnormal">L</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span>.</li>
<li>Update the <code>pageLSN</code> every time a transaction modifies a record in the page.</li>
<li>Update the <code>flushedLSN</code> in memory every time the DBMS writes out the WAL buffer to disk.</li>
</ol>
<h2 id="how-to-handle-transaction-commits"><a class="markdownIt-Anchor" href="#how-to-handle-transaction-commits"></a> How to handle transaction commits?</h2>
<ol>
<li>When a transaction is committed, the DBMS writes a <code>COMMIT</code> record to log and guarantees that all log records up to the transaction’s <code>COMMIT</code> record are flushed to disk.
<ul>
<li>Log flushes are sequential, synchronous writes to disk.</li>
</ul>
</li>
<li>When the commit succeeds, write a special <code>TXN-END</code> record to log.
<ul>
<li>Indicates that no new log record for a transaction will appear in the log ever again.</li>
<li>This does not need to be flushed immediately.</li>
</ul>
</li>
</ol>
<h2 id="how-to-handle-transaction-abort"><a class="markdownIt-Anchor" href="#how-to-handle-transaction-abort"></a> How to handle transaction abort?</h2>
<ol>
<li>Another <code>prevLSN</code> is added to log records pointing to the previous LSN for that transaction to make it easy to walk through its records.</li>
<li>First, write an <code>ABORT</code> record to log for the transaction.
<ul>
<li>Following that, we must record the steps taken to undo the transaction.
<ul>
<li>A <code>CLR</code> describes the actions taken to undo the actions of a previous update record.</li>
<li>It has all the fields of an update log record plus the <code>undoNext</code> pointer pointing to the next-to-be-undone LSN.</li>
<li><code>CLR</code>s are added to log records, but the DBMS does not wait for them to be flushed before notifying the application that the transaction was aborted.</li>
</ul>
</li>
<li>Lastly, write a <code>TXN-END</code> record.</li>
</ul>
</li>
<li>We need to analyze the transaction’s updates in reverse order to add <code>CLR</code> records.
<ul>
<li>Write a <code>CLR</code> entry to the log for each update record and restore the old value.</li>
<li><code>CLR</code>s never need to be undone.</li>
</ul>
</li>
</ol>
<h1 id="fuzzy-checkpoints"><a class="markdownIt-Anchor" href="#fuzzy-checkpoints"></a> Fuzzy checkpoints</h1>
<h2 id="how-can-we-improve-the-naive-checkpoints"><a class="markdownIt-Anchor" href="#how-can-we-improve-the-naive-checkpoints"></a> How can we improve the naive checkpoints?</h2>
<ol>
<li>The naive checkpoint needs to halt the start of any new transactions and wait until all active transactions finish executing.</li>
<li>We can only pause modifying transactions while the DBMS takes the checkpoint.
<ul>
<li>This can be done by preventing queries from acquiring a write latch on table/index pages.</li>
<li>Don’t have to wait until all transactions finish before taking the checkpoint.</li>
</ul>
</li>
<li>We must record the internal state as of the beginning of the checkpoint.
<ul>
<li>Active Transaction Table (ATT): What transactions were running when we took the checkpoint.</li>
<li>Dirty Page Table (DPT): What pages are dirty.</li>
</ul>
</li>
<li>ATT is maintained at runtime and recovery. There is an entry per currently active transaction.
<ul>
<li>Each entry contains
<ul>
<li><code>transactionId</code>: Unique transaction identifier</li>
<li><code>status</code>: The current “mode” of the transaction</li>
<li><code>lastLSN</code>: The most recent LSN created by the transaction.</li>
</ul>
</li>
<li>Remove the entry after the <code>TXN-END</code> record.</li>
<li>Txn Status Codes
<ul>
<li><code>R</code>: Running</li>
<li><code>C</code>: Committing</li>
<li><code>U</code>: Candidate for undo</li>
</ul>
</li>
<li><code>U</code> is the default mode in recovery.
<ul>
<li>When replaying the log, we cannot see what’s coming up, assuming we will not see a transaction commit record.</li>
<li>Flip to commit when we see a transaction commit record.</li>
</ul>
</li>
</ul>
</li>
<li>DPT contains one entry per dirty page in the buffer pool, including <code>recLSN</code>.
<ul>
<li><code>recLSN</code> is the LSN of the log record that first caused the page to be dirty.</li>
</ul>
</li>
<li>Each checkpoint record includes ATT and DPT in it.</li>
</ol>
<h2 id="how-can-we-checkpoint-without-stalling-transactions"><a class="markdownIt-Anchor" href="#how-can-we-checkpoint-without-stalling-transactions"></a> How can we checkpoint without stalling transactions?</h2>
<ol>
<li>In a fuzzy checkpoint, two kinds of records track checkpoint boundaries.
<ul>
<li><code>CHECKPOINT-BEGIN</code> indicates the start of the checkpoint. Recovery begins from here.</li>
<li><code>CHECKPOINT-END</code> contains ATT and DPT at the moment of <code>CHECKPOINT-BEGIN</code>.</li>
</ul>
</li>
<li>The <code>LSN</code> of the <code>CHECKPOINT-BEGIN</code> record is written in the MasterRecord when it is complete.</li>
<li>Any transaction after the checkpoint starts is excluded from the ATT in the <code>CHECKPOINT-END</code> record.</li>
</ol>
<h1 id="recovery"><a class="markdownIt-Anchor" href="#recovery"></a> Recovery</h1>
<h2 id="how-does-aries-recover-from-the-crash"><a class="markdownIt-Anchor" href="#how-does-aries-recover-from-the-crash"></a> How does ARIES recover from the crash?</h2>
<ol>
<li>The first phase is analysis.
<ul>
<li>Examine the WAL in a forward direction, starting at MasterRecord to identify dirty pages in the buffer pool and active transactions at the time of the crash.</li>
<li>This is to figure out which transactions committed or failed since checkpoint.</li>
</ul>
</li>
<li>The second phase is the redo phase.
<ul>
<li>Repeat all actions starting from an appropriate point in the log in the forward direction.</li>
<li>This phase is to repeat all actions, even transactions that will abort.</li>
</ul>
</li>
<li>The last phase is undo.
<ul>
<li>Reverse the actions of transactions that were not committed before the crash in reverse order.</li>
<li>This phase is to reverse the effects of failed transactions.</li>
</ul>
</li>
<li>If crashes happen during recovery, just rerun recovery.</li>
</ol>
<img src="/imgs/15445/Recovery/aries.png" width="20%">
<h2 id="what-does-the-analysis-phase-do"><a class="markdownIt-Anchor" href="#what-does-the-analysis-phase-do"></a> What does the analysis phase do?</h2>
<ol>
<li>Scan the log forward from the <code>CHECKPOINT-END</code> of the last successful checkpoint.</li>
<li>If the DBMS finds a <code>TXN-END</code> record, remove its corresponding transaction from ATT.</li>
<li>For all other records,
<ul>
<li>Suppose the transaction is not in ATT; add it with the status <code>UNDO</code>. On commit, change transaction status to <code>COMMIT</code>.</li>
<li>For update log records, if the page <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi></mrow><annotation encoding="application/x-tex">P</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span> not in DPT, add <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi></mrow><annotation encoding="application/x-tex">P</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span> to DPT, set its <code>recLSN=LSN</code>.</li>
</ul>
</li>
<li>At the end of the Analysis Phase,
<ul>
<li>ATT identifies which transactions were active at the time of the crash.</li>
<li>DPT identifies which dirty pages might not have made it to disk.</li>
</ul>
</li>
</ol>
<h2 id="what-does-the-redo-phase-do"><a class="markdownIt-Anchor" href="#what-does-the-redo-phase-do"></a> What does the redo phase do?</h2>
<ol>
<li>The goal is to repeat history to reconstruct the database state at the moment of the crash.</li>
<li>Scan forward from the log record containing the smallest <code>recLSN</code> in DPT.</li>
<li>For each update log record or <code>CLR</code> with a given LSN, redo the action unless the affected page is not in DPT or the affected page is in DPT but that record’s LSN is less than the page’s <code>recLSN</code>.
<ul>
<li>If the affected page is not in DPT, that modification is already flushed in the disk.</li>
<li>If that record’s LSN is less than the page’s <code>recLSN</code>, that page is dirty due to some updates after the record. The modification of that record is also flushed into the disk.</li>
</ul>
</li>
<li>To redo an action,
<ul>
<li>Reapply logged update.</li>
<li>Set <code>pageLSN</code> to log the record’s LSN.</li>
<li>No additional logging, no forced flushes.</li>
<li>To improve performance, we can assume that it will not crash again and that all changes to the disk will be flushed asynchronously in the background.</li>
</ul>
</li>
<li>At the end of the Redo Phase, write <code>TXN-END</code> log records for all transactions with status <code>C</code> and remove them from the ATT.</li>
</ol>
<h2 id="what-does-the-undo-phase-do"><a class="markdownIt-Anchor" href="#what-does-the-undo-phase-do"></a> What does the undo phase do?</h2>
<ol>
<li>Undo all active transactions at the time of the crash and, therefore, will never commit.</li>
<li>These are all the transactions with <code>U</code> status in the ATT after the Analysis Phase.</li>
<li>Process them in reverse LSN order using the <code>lastLSN</code> to speed up traversal.</li>
<li>Write a <code>CLR</code> for every modification.</li>
<li>To improve performance,
<ul>
<li>Lazily rollback changes before new transactions access pages.</li>
<li>Rewrite the application to avoid long-running transactions, which will never be used.</li>
</ul>
</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://liyun-zhang.github.io/2023/08/29/Courses/15445/13-Database-Logging/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LiyunZhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LiyunZhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LiyunZhang">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/08/29/Courses/15445/13-Database-Logging/" class="post-title-link" itemprop="url">13 Database Logging</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-08-29 11:42:20" itemprop="dateCreated datePublished" datetime="2023-08-29T11:42:20+08:00">2023-08-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-03-16 16:09:55" itemprop="dateModified" datetime="2024-03-16T16:09:55+08:00">2024-03-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Open-Courses/" itemprop="url" rel="index"><span itemprop="name">Open Courses</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Open-Courses/CMU-15-445-645-Database-System/" itemprop="url" rel="index"><span itemprop="name">CMU 15-445/645 Database System</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><ul class="markdownIt-TOC">
<li><a href="#crash">Crash</a>
<ul>
<li><a href="#how-to-recover-from-the-crash">How to recover from the crash?</a></li>
<li><a href="#what-are-the-possible-classifications-of-failures">What are the possible classifications of failures?</a></li>
</ul>
</li>
<li><a href="#naive-solution">Naive solution</a>
<ul>
<li><a href="#what-buffer-pool-policies-can-we-choose">What buffer pool policies can we choose?</a></li>
<li><a href="#what-are-the-pros-and-cons-of-no-steal-and-force-policy">What are the pros and cons of no-steal and force policy?</a></li>
<li><a href="#how-does-shadow-paging-work">How does shadow paging work?</a></li>
<li><a href="#what-are-the-disadvantages-of-shadow-paging">What are the disadvantages of shadow paging?</a></li>
<li><a href="#how-does-a-journal-file-work">How does a journal file work?</a></li>
</ul>
</li>
<li><a href="#write-ahead-log">Write-ahead log</a>
<ul>
<li><a href="#what-is-the-main-idea-of-wal">What is the main idea of WAL?</a></li>
<li><a href="#how-to-write-under-wal-protocol">How to write under WAL protocol?</a></li>
<li><a href="#how-to-reduce-flushing-the-log-buffer">How to reduce flushing the log buffer?</a></li>
<li><a href="#how-to-store-changes">How to store changes?</a></li>
<li><a href="#what-is-the-log-structured-system">What is the log-structured system?</a></li>
<li><a href="#how-to-prevent-wal-from-growing-forever">How to prevent WAL from growing forever?</a></li>
<li><a href="#what-is-the-problem-with-this-naive-checkpoint-protocol">What is the problem with this naive checkpoint protocol?</a></li>
</ul>
</li>
</ul>
</p>
<h1 id="crash"><a class="markdownIt-Anchor" href="#crash"></a> Crash</h1>
<h2 id="how-to-recover-from-the-crash"><a class="markdownIt-Anchor" href="#how-to-recover-from-the-crash"></a> How to recover from the crash?</h2>
<ol>
<li>Recovery algorithms are techniques to ensure database consistency, transaction atomicity, and durability despite failures.</li>
<li>The DBMS needs to ensure the following:
<ul>
<li>The changes for any transaction are durable once the DBMS has told somebody it has been committed.</li>
<li>No partial changes are durable if the transaction is aborted.</li>
</ul>
</li>
<li>Recovery algorithms have two parts:
<ul>
<li>The first is the runtime part: Actions during normal transaction processing to ensure the DBMS can recover from a failure.</li>
<li>The second is the startup part: Actions after a failure to recover the database to a state that ensures atomicity, consistency, and durability.</li>
</ul>
</li>
</ol>
<h2 id="what-are-the-possible-classifications-of-failures"><a class="markdownIt-Anchor" href="#what-are-the-possible-classifications-of-failures"></a> What are the possible classifications of failures?</h2>
<ol>
<li>Transaction failures:
<ul>
<li>Logical errors: Transactions cannot be completed due to internal error conditions (e.g., integrity constraint violation).</li>
<li>Internal state errors: DBMS must terminate an active transaction due to an error condition (e.g., deadlock).</li>
</ul>
</li>
<li>System failures:
<ul>
<li>Software failure: Problem with the OS or DBMS implementation (e.g., uncaught divide-by-zero exception).</li>
<li>Hardware failure: The computer hosting the DBMS crashes (e.g., the power plug gets pulled).</li>
<li>Fail-stop assumption: Non-volatile storage contents are assumed not to be corrupted by system crashes.</li>
</ul>
</li>
<li>Storage media failure:
<ul>
<li>Non-repairable hardware failure: A head crash or similar disk failure destroys all or part of non-volatile storage.</li>
<li>Destruction is assumed to be detectable (e.g., disk controllers use checksums to detect failures).</li>
<li>No DBMS can recover from this! The database must be restored from the archived version.</li>
<li>Stable storage is a non-existent form of non-volatile storage that survives all possible failure scenarios.</li>
</ul>
</li>
</ol>
<h1 id="naive-solution"><a class="markdownIt-Anchor" href="#naive-solution"></a> Naive solution</h1>
<h2 id="what-buffer-pool-policies-can-we-choose"><a class="markdownIt-Anchor" href="#what-buffer-pool-policies-can-we-choose"></a> What buffer pool policies can we choose?</h2>
<ol>
<li>Steal policy:
<ul>
<li>Whether the DBMS allows an uncommitted transaction to overwrite an object’s most recent committed value in non-volatile storage.</li>
<li>Steal: Is allowed</li>
<li>No-steal: Is not allowed</li>
</ul>
</li>
<li>Force policy:
<ul>
<li>Whether the DBMS requires that all updates made by a transaction are reflected on non-volatile storage before the transaction can commit.</li>
<li>Force: Is required</li>
<li>No-force: Is not required</li>
</ul>
</li>
<li>Undo: The process of removing the effects of an incomplete or aborted transaction.</li>
<li>Redo: The process of re-applying the effects of a committed transaction for durability.</li>
<li>Stead and no-force policy has the best runtime performance since it does not need to wait for conflicted uncommitted transactions and does not necessarily have to flush when committed.</li>
<li>The no-steal and force policy has the best recovery performance since it does not need to undo and redo anything.</li>
</ol>
<h2 id="what-are-the-pros-and-cons-of-no-steal-and-force-policy"><a class="markdownIt-Anchor" href="#what-are-the-pros-and-cons-of-no-steal-and-force-policy"></a> What are the pros and cons of no-steal and force policy?</h2>
<ol>
<li>This approach is the easiest to implement:
<ul>
<li>Never have to undo changes of an aborted transaction because the changes were not written to disk.</li>
<li>Never have to redo changes of a committed transaction because all the changes are guaranteed to be written to disk at commit time (assuming atomic hardware writes).</li>
</ul>
</li>
<li>An uncommitted transaction and another committing transaction may have written the same page. Then, the buffer pool manager must copy that page with only modifications from the committing transaction and write that copied page to non-volatile storage.</li>
<li>The disadvantages are as follows:
<ul>
<li>Copying data is expensive.</li>
<li>The buffer pool manager needs to be aware of the context.</li>
<li>Cannot support write sets that exceed the amount of physical memory available.</li>
</ul>
</li>
</ol>
<h2 id="how-does-shadow-paging-work"><a class="markdownIt-Anchor" href="#how-does-shadow-paging-work"></a> How does shadow paging work?</h2>
<ol>
<li>Instead of copying the entire database, the DBMS copies pages on write to create two versions
<ul>
<li>Master: Contains only changes from committed transactions. Read-only transactions access the current master.</li>
<li>Shadow: Temporary database with changes made from uncommitted transactions.</li>
</ul>
</li>
<li>Active modifying transaction copies the page table as the shadow page table.
<ul>
<li>When it tries to modify a page, it will copy that page and modify the shadow page table to point to the newly copied page.</li>
<li>To install updates when a transaction commits, overwrite the root so it points to the shadow, thereby swapping the master and shadow. Then, DMBS needs to collect some garbage.</li>
</ul>
</li>
<li>The buffer pool policy is no-steal and force.</li>
<li>The DBMS needs to remove the shadow pages to support rollbacks and recovery. Leave the master and the DB root pointer alone in the undo phase; redo is unnecessary.</li>
</ol>
<h2 id="what-are-the-disadvantages-of-shadow-paging"><a class="markdownIt-Anchor" href="#what-are-the-disadvantages-of-shadow-paging"></a> What are the disadvantages of shadow paging?</h2>
<ol>
<li>Copying the entire page table is expensive:
<ul>
<li>We can use a page table structured like a B+tree (LMDB). There is no need to copy the entire tree; only to copy paths in the tree that lead to updated leaf nodes.</li>
</ul>
</li>
<li>Commit overhead is high:
<ul>
<li>Need to flush every updated page, page table, and root.</li>
<li>Data gets fragmented, which is bad for sequential scans.</li>
<li>Require the DBMS to perform writes to random non-contiguous pages on disk.</li>
<li>Need garbage collection.</li>
</ul>
</li>
<li>Only supports one writer transaction at a time or transactions in a batch. If two concurrent writers write on the same page, they all copy from the master version, causing only one write to be reflected on the committed database.</li>
</ol>
<h2 id="how-does-a-journal-file-work"><a class="markdownIt-Anchor" href="#how-does-a-journal-file-work"></a> How does a journal file work?</h2>
<ol>
<li>When a transaction modifies a page, the DBMS copies the original page to a separate journal file before overwriting the master version.</li>
<li>After restarting, if a journal file exists, then the DBMS restores it to undo changes from uncommitted transactions.</li>
</ol>
<h1 id="write-ahead-log"><a class="markdownIt-Anchor" href="#write-ahead-log"></a> Write-ahead log</h1>
<h2 id="what-is-the-main-idea-of-wal"><a class="markdownIt-Anchor" href="#what-is-the-main-idea-of-wal"></a> What is the main idea of WAL?</h2>
<ol>
<li>Maintain a log file separate from data files containing the changes transactions make to the database.
<ul>
<li>Assume that the log is on stable storage.</li>
<li>The log contains enough information to perform the necessary undo and redo actions to restore the database.</li>
</ul>
</li>
<li>DBMS must write to disk the log file records that correspond to changes made to a database object before it can flush that object to disk.
<ul>
<li>The buffer pool policy is steal and no-force.</li>
</ul>
</li>
</ol>
<h2 id="how-to-write-under-wal-protocol"><a class="markdownIt-Anchor" href="#how-to-write-under-wal-protocol"></a> How to write under WAL protocol?</h2>
<ol>
<li>The DBMS stages all a transaction’s log records in volatile storage backed by a buffer pool.
<ul>
<li>All log records pertaining to an updated page are written to non-volatile storage before the page itself is over-written in non-volatile storage.</li>
<li>A transaction is not considered committed until all its log records have been written to stable storage.</li>
</ul>
</li>
<li>A <code>&lt;BEGIN&gt;</code> record is written to the log for each transaction to mark its starting point.
<ul>
<li>Most DBMS only writes <code>&lt;BEGIN&gt;</code> on the first write command of a transaction instead of at the beginning.</li>
</ul>
</li>
<li>When a transaction finishes, the DBMS will write a <code>&lt;COMMIT&gt;</code> record on the log and ensure all log records are flushed before it returns an acknowledgment to the application.</li>
<li>Each log entry contains information about the change to a single object.
<ul>
<li>Transaction ID, object ID, before value (for undo) and after value (for redo).</li>
</ul>
</li>
</ol>
<h2 id="how-to-reduce-flushing-the-log-buffer"><a class="markdownIt-Anchor" href="#how-to-reduce-flushing-the-log-buffer"></a> How to reduce flushing the log buffer?</h2>
<ol>
<li>Flushing the log buffer to disk every time a transaction commits will become a bottleneck.</li>
<li>The DBMS can use the group commit optimization to batch multiple log flushes together to amortize overhead.
<ul>
<li>When the buffer is full, flush it to disk. Or if there is a timeout.</li>
<li>Log records from different transactions are mixed. This is fine since we can sort them out by recorded transaction ID.</li>
</ul>
</li>
</ol>
<h2 id="how-to-store-changes"><a class="markdownIt-Anchor" href="#how-to-store-changes"></a> How to store changes?</h2>
<ol>
<li>The first logging scheme is physical logging.
<ul>
<li>Record the byte-level changes made to a specific page.</li>
</ul>
</li>
<li>The second is logical logging.
<ul>
<li>Record the high-level operations executed by transactions, e.g., queries.</li>
<li>Logical logging requires less data written in each log record than physical logging.</li>
<li>Difficult to implement recovery with logical logging if you have concurrent transactions running at lower isolation levels.
<ul>
<li>The crash may happen in the middle of a query.</li>
<li>It is hard to determine which parts of the database may have been modified by a query before the crash.</li>
</ul>
</li>
<li>It also takes longer to recover because you must re-execute every transaction all over again.</li>
</ul>
</li>
<li>The last is physiological logging.
<ul>
<li>Hybrid approach with byte-level changes for a single tuple identified by page ID and slot number.</li>
</ul>
</li>
</ol>
<h2 id="what-is-the-log-structured-system"><a class="markdownIt-Anchor" href="#what-is-the-log-structured-system"></a> What is the log-structured system?</h2>
<ol>
<li>Log-structured DBMSs do not have dirty pages.
<ul>
<li>Any page retrieved from the disk is immutable.</li>
<li>All modifications are reflected through logs.</li>
</ul>
</li>
<li>The DBMS buffers log records in in-memory pages (MemTable).
<ul>
<li>If this buffer is full, it must be flushed to disk. However, it may contain changes from uncommitted transactions.</li>
</ul>
</li>
<li>These DBMSs maintain a separate WAL to recreate the MemTable on the crash.</li>
</ol>
<h2 id="how-to-prevent-wal-from-growing-forever"><a class="markdownIt-Anchor" href="#how-to-prevent-wal-from-growing-forever"></a> How to prevent WAL from growing forever?</h2>
<ol>
<li>If the WAL grows forever after a crash, the DBMS must replay the entire log, which will take a long time.</li>
<li>The DBMS periodically takes a checkpoint where it flushes all buffers out to disk.</li>
<li>In blocking / consistent checkpoint protocol,
<ul>
<li>Procedure
<ul>
<li>Pause all queries</li>
<li>Flush all WAL records in memory to disk.</li>
<li>Flush all modified pages in the buffer pool to disk.</li>
<li>Write a <code>&lt;CHECKPOINT&gt;</code> entry to WAL and flush it to disk.</li>
<li>Resume queries</li>
</ul>
</li>
<li>On recovery, we can use the <code>&lt;CHECKPOINT&gt;</code> record as the starting point for analyzing the WAL.
<ul>
<li>Any transaction that is committed before the checkpoint is ignored.</li>
<li>Redo transactions that are committed after checkpoint and undo transactions not committed before the crash.</li>
</ul>
</li>
</ul>
</li>
</ol>
<h2 id="what-is-the-problem-with-this-naive-checkpoint-protocol"><a class="markdownIt-Anchor" href="#what-is-the-problem-with-this-naive-checkpoint-protocol"></a> What is the problem with this naive checkpoint protocol?</h2>
<ol>
<li>The DBMS must stall transactions when it takes a checkpoint to ensure a consistent snapshot.
<ul>
<li>Too often checkpointing causes the runtime performance to degrade because the system spends too much time flushing buffers.</li>
<li>But waiting a long time is just as bad since the checkpoint will be large and slow, which makes recovery time much longer.</li>
</ul>
</li>
<li>Scanning the log to find uncommitted transactions can take a long time.</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://liyun-zhang.github.io/2023/08/22/Courses/15445/12-Multi-Version-Concurrency-Control/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LiyunZhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LiyunZhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LiyunZhang">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/08/22/Courses/15445/12-Multi-Version-Concurrency-Control/" class="post-title-link" itemprop="url">12 Multi-Version Concurrency Control</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-08-22 15:34:19" itemprop="dateCreated datePublished" datetime="2023-08-22T15:34:19+08:00">2023-08-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-03-16 16:02:14" itemprop="dateModified" datetime="2024-03-16T16:02:14+08:00">2024-03-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Open-Courses/" itemprop="url" rel="index"><span itemprop="name">Open Courses</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Open-Courses/CMU-15-445-645-Database-System/" itemprop="url" rel="index"><span itemprop="name">CMU 15-445/645 Database System</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><ul class="markdownIt-TOC">
<li><a href="#multi-version-logic">Multi-version logic</a>
<ul>
<li><a href="#what-does-multi-version-mean">What does multi-version mean?</a></li>
<li><a href="#how-to-maintain-multi-version-logically">How to maintain multi-version logically?</a></li>
<li><a href="#what-isolation-can-mvcc-support">What isolation can MVCC support?</a></li>
</ul>
</li>
<li><a href="#design-decisions">Design decisions</a>
<ul>
<li><a href="#what-concurrency-control-protocol-can-be-used">What concurrency control protocol can be used?</a></li>
<li><a href="#how-are-versions-stored">How are versions stored?</a></li>
<li><a href="#how-to-perform-garbage-collection">How to perform garbage collection?</a></li>
<li><a href="#how-to-manage-indexes">How to manage indexes?</a></li>
<li><a href="#how-to-delete-a-tuple">How to delete a tuple?</a></li>
</ul>
</li>
</ul>
</p>
<h1 id="multi-version-logic"><a class="markdownIt-Anchor" href="#multi-version-logic"></a> Multi-version logic</h1>
<h2 id="what-does-multi-version-mean"><a class="markdownIt-Anchor" href="#what-does-multi-version-mean"></a> What does multi-version mean?</h2>
<ol>
<li>
<p>The DBMS maintains multiple physical versions of a single logical object in the database.</p>
<ul>
<li>
<p>When a transaction writes to an object, the DBMS creates a new version of that object.</p>
</li>
<li>
<p>When a transaction reads an object, it reads the newest version that existed when it started.</p>
</li>
</ul>
</li>
<li>
<p>Writers do not block readers, and readers do not block writers.</p>
</li>
<li>
<p>Read-only transactions can read a consistent snapshot without acquiring locks using timestamps to determine visibility.</p>
</li>
<li>
<p>Multi-version can easily support time-travel queries on a snapshot version of the database.</p>
</li>
</ol>
<h2 id="how-to-maintain-multi-version-logically"><a class="markdownIt-Anchor" href="#how-to-maintain-multi-version-logically"></a> How to maintain multi-version logically?</h2>
<ol>
<li>Each version describes the current version number, the value for this version, and the lifetime range, i.e., the beginning and end timestamps.</li>
<li>The end timestamp is marked infinity for the newest version.</li>
<li>When a transaction writes an object:
<ul>
<li>First, it creates a new entry with a new version number and sets its begin timestamp as its timestamp and end timestamp as infinity.</li>
<li>Then, it marks the end timestamp of the last version as its timestamp.</li>
<li>Physically, this transaction should modify the last version to point to this new version. Hence, it must wait for the transaction that has created the previous version to commit before beginning its commit phase.</li>
</ul>
</li>
</ol>
<h2 id="what-isolation-can-mvcc-support"><a class="markdownIt-Anchor" href="#what-isolation-can-mvcc-support"></a> What isolation can MVCC support?</h2>
<ol>
<li><code>SNAPSHOT ISOLATION</code> is another isolation supported by Oracle.
<ul>
<li>It guarantees that all reads made in a transaction see a consistent snapshot of the database when the transaction started.</li>
<li>A transaction will commit only if its writes do not conflict with any concurrent updates made since that snapshot.</li>
</ul>
</li>
<li>It is susceptible to write skew anomaly.
<ul>
<li>Two concurrent transactions modify different objects, resulting in race conditions.</li>
<li>If a transaction wants to modify all values to <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span> while another transaction wants to modify all values to <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span>. The first transaction changes all <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span>s, and the second transaction changes all <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>s. When their result merges with the database, it would be the <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>s and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span>s are flipped instead of all being <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>s or <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span>s.</li>
</ul>
</li>
</ol>
<h1 id="design-decisions"><a class="markdownIt-Anchor" href="#design-decisions"></a> Design decisions</h1>
<h2 id="what-concurrency-control-protocol-can-be-used"><a class="markdownIt-Anchor" href="#what-concurrency-control-protocol-can-be-used"></a> What concurrency control protocol can be used?</h2>
<ol>
<li>All aforementioned protocols can be used in MVCC.</li>
<li>Timestamp ordering assigns transaction timestamps to determine what they can see.</li>
<li>Optimistic concurrency control uses a private workspace for new versions.</li>
<li>Two-phase locking requires transactions to acquire an appropriate lock on a physical version before they can read/write a logical tuple.</li>
</ol>
<h2 id="how-are-versions-stored"><a class="markdownIt-Anchor" href="#how-are-versions-stored"></a> How are versions stored?</h2>
<ol>
<li>The DBMS uses the tuples’ pointer field to create a version chain per logical tuple.
<ul>
<li>This allows the DBMS to find the version visible to a particular transaction at runtime.</li>
<li>Indexes always point to the “head” of the chain.</li>
</ul>
</li>
<li>The first approach is append-only storage: New versions are appended to the same table space.
<ul>
<li>The versions of different logical tuples are inter-mixed.</li>
<li>On every update, append a new version of the tuple into an empty space in the table.</li>
<li>If the chain is from oldest to newest, the DBMS must traverse the chain on look-ups. However, the update does not need to update the index.</li>
<li>Or, the chain can be from oldest to newest. The pros and cons are contrary to the last scenario.</li>
</ul>
</li>
<li>The second approach is time-travel storage: Old versions are copied to separate table space.
<ul>
<li>On every update, copy the current version to the time-travel table. Update pointers. Then, Overwrite the master version in the main table and update pointers.</li>
</ul>
</li>
<li>The third approach is delta storage: The original values of the modified attributes are copied into a separate delta record space.
<ul>
<li>On every update, copy only the values modified to the delta storage and overwrite the master version.</li>
<li>Transactions can recreate old versions by applying the delta in reverse order.</li>
</ul>
</li>
</ol>
<h2 id="how-to-perform-garbage-collection"><a class="markdownIt-Anchor" href="#how-to-perform-garbage-collection"></a> How to perform garbage collection?</h2>
<ol>
<li>The DBMS needs to remove reclaimable physical versions from the database over time.
<ul>
<li>Reclaimable means that no active transaction in the DBMS can see an aborted transaction created that version (SI) or the version.</li>
<li>The DBMS can only reclaim versions created by an aborted transaction to support time-travel queries.</li>
</ul>
</li>
<li>To look for expired versions, the implementation has two choices.</li>
<li>The first approach is tuple-level: Find old versions by examining tuples directly.
<ul>
<li>In a background vacuuming manner, separate thread(s) periodically scan the table and look for reclaimable versions. This design works with any storage.</li>
<li>In a cooperative cleaning manner, worker threads identify reclaimable versions as they traverse the version chain. It only works with oldest-to-newest.</li>
</ul>
</li>
<li>The second approach is transaction-level: transactions keep track of their old versions on updates, so the DBMS does not have to scan tuples to determine visibility.
<ul>
<li>Each transaction keeps track of its read/write set. On commit/abort, the transaction provides this information to a centralized vacuum worker.</li>
<li>The DBMS periodically determines when all versions created by a finished transaction are no longer visible.</li>
</ul>
</li>
</ol>
<h2 id="how-to-manage-indexes"><a class="markdownIt-Anchor" href="#how-to-manage-indexes"></a> How to manage indexes?</h2>
<ol>
<li>Primary key indexes point to the version chain head.
<ul>
<li>How often the DBMS must update the primary key index depends on whether the system creates new versions when a tuple is updated.</li>
<li>If a transaction updates a tuple’s primary key attribute(s), then this is treated as a <code>DELETE</code> followed by an <code>INSERT</code>.</li>
</ul>
</li>
<li>Secondary indexes may use the physical address to the version chain head like a primary key index.</li>
<li>The secondary indexes may also use logical pointers.
<ul>
<li>It uses a fixed identifier per tuple that does not change, e.g., primary key or tuple ID.</li>
<li>This would require an extra indirection layer.</li>
</ul>
</li>
</ol>
<h2 id="how-to-delete-a-tuple"><a class="markdownIt-Anchor" href="#how-to-delete-a-tuple"></a> How to delete a tuple?</h2>
<ol>
<li>The DBMS physically deletes a tuple from the database only when all versions of a logically deleted tuple are not visible.</li>
<li>If a tuple is deleted, a new version cannot be after the latest version.</li>
<li>There are two ways to denote that a tuple has been logically deleted at some point in time.
<ul>
<li>The first way is to maintain a deleted flag to indicate that the logical tuple has been deleted after the newest physical version. The flag can either be in a tuple header or a separate column.</li>
<li>The second tombstone tuple way is to create an empty physical version to indicate that a logical tuple is deleted.
<ul>
<li>It uses a separate pool for tombstone tuples with only a special bit pattern in the version chain pointer to reduce the storage overhead.</li>
</ul>
</li>
</ul>
</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://liyun-zhang.github.io/2023/08/20/Courses/15445/11-Timestamp-Ordering-Concurrency-Control/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LiyunZhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LiyunZhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LiyunZhang">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/08/20/Courses/15445/11-Timestamp-Ordering-Concurrency-Control/" class="post-title-link" itemprop="url">11 Timestamp Ordering Concurrency Control</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-08-20 23:59:40" itemprop="dateCreated datePublished" datetime="2023-08-20T23:59:40+08:00">2023-08-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-03-16 15:48:54" itemprop="dateModified" datetime="2024-03-16T15:48:54+08:00">2024-03-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Open-Courses/" itemprop="url" rel="index"><span itemprop="name">Open Courses</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Open-Courses/CMU-15-445-645-Database-System/" itemprop="url" rel="index"><span itemprop="name">CMU 15-445/645 Database System</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><ul class="markdownIt-TOC">
<li><a href="#to-protocols">T/O Protocols</a>
<ul>
<li><a href="#what-is-the-difference-between-2pl-and-to">What is the difference between 2PL and T/O?</a></li>
<li><a href="#basic-to-protocol">Basic T/O protocol</a>
<ul>
<li><a href="#what-is-the-main-idea-of-basic-to-protocol">What is the main idea of basic T/O protocol?</a></li>
<li><a href="#how-does-basic-to-check-each-operation">How does basic T/O check each operation?</a></li>
<li><a href="#can-we-optimize-the-write-rule-to-decrease-the-possibility-of-abort">Can we optimize the write rule to decrease the possibility of abort?</a></li>
<li><a href="#what-are-the-issues-of-basic-to">What are the issues of basic T/O?</a></li>
</ul>
</li>
<li><a href="#optimistic-concurrency-control">Optimistic concurrency control</a>
<ul>
<li><a href="#what-is-the-main-idea-of-occ">What is the main idea of OCC?</a></li>
<li><a href="#what-will-happen-in-the-validation-phase">What will happen in the validation phase?</a></li>
<li><a href="#what-are-the-issues-of-occ">What are the issues of OCC?</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#the-phantom-problem">The phantom problem</a>
<ul>
<li><a href="#what-is-the-phantom-problem">What is the phantom problem?</a></li>
<li><a href="#how-can-we-solve-the-phantom-problem">How can we solve the phantom problem?</a></li>
<li><a href="#what-are-isolation-levels">What are isolation levels?</a></li>
</ul>
</li>
</ul>
</p>
<h1 id="to-protocols"><a class="markdownIt-Anchor" href="#to-protocols"></a> T/O Protocols</h1>
<h2 id="what-is-the-difference-between-2pl-and-to"><a class="markdownIt-Anchor" href="#what-is-the-difference-between-2pl-and-to"></a> What is the difference between 2PL and T/O?</h2>
<ol>
<li>2PL determines the serializability order of conflicting operations at runtime while transactions execute, while T/O determines the serializability order of transactions before they execute.
<ul>
<li>If <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>T</mi><mi>S</mi><mo stretchy="false">(</mo><msub><mi>T</mi><mi>i</mi></msub><mo stretchy="false">)</mo><mo>&lt;</mo><mi>T</mi><mi>S</mi><mo stretchy="false">(</mo><msub><mi>T</mi><mi>j</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">TS(T_i) &lt; TS(T_j)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>, then the DBMS must ensure that the execution schedule is equivalent to a serial schedule where <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">T_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> appears before <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">T_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.969438em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span>.</li>
<li>Different schemes assign timestamps at different times during the transaction.</li>
<li>Timestamps can be implemented using different strategies: system/wall clock, logical counter, or hybrid.</li>
</ul>
</li>
<li>2PL is pessimistic. It assumes that conflicts between transactions are very common.
<ul>
<li>Hence, it uses locks to prevent conflicts.</li>
</ul>
</li>
<li>Timestamp ordering (T/O) is a more optimistic way. It assumes that conflicts between transactions are rare.
<ul>
<li>Hence, it allows each transaction to execute all operations they want and validate their legitimacy after each transaction committing and before applying anything to the main database.</li>
</ul>
</li>
</ol>
<h2 id="basic-to-protocol"><a class="markdownIt-Anchor" href="#basic-to-protocol"></a> Basic T/O protocol</h2>
<h3 id="what-is-the-main-idea-of-basic-to-protocol"><a class="markdownIt-Anchor" href="#what-is-the-main-idea-of-basic-to-protocol"></a> What is the main idea of basic T/O protocol?</h3>
<ol>
<li>Txns read and write objects without locks.</li>
<li>The timestamp of each transaction is assigned at the <code>BEGIN</code> command.</li>
<li>Every object <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi></mrow><annotation encoding="application/x-tex">X</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span></span></span></span> is tagged with a timestamp of the last transaction that successfully read/write
<ul>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>W</mi><mo>−</mo><mi>T</mi><mi>S</mi><mo stretchy="false">(</mo><mi>X</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">W-TS(X)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mclose">)</span></span></span></span>: Write timestamp on <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi></mrow><annotation encoding="application/x-tex">X</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span></span></span></span></li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi><mo>−</mo><mi>T</mi><mi>S</mi><mo stretchy="false">(</mo><mi>X</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">R-TS(X)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mclose">)</span></span></span></span>: Read timestamp on <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi></mrow><annotation encoding="application/x-tex">X</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span></span></span></span></li>
</ul>
</li>
<li>Check timestamps for every operation. If a transaction tries to access an object “from the future,” it aborts and restarts.</li>
</ol>
<h3 id="how-does-basic-to-check-each-operation"><a class="markdownIt-Anchor" href="#how-does-basic-to-check-each-operation"></a> How does basic T/O check each operation?</h3>
<ol>
<li>When <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">T_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> wants to read <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi></mrow><annotation encoding="application/x-tex">X</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span></span></span></span>:
<ul>
<li>If <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>T</mi><mi>S</mi><mo stretchy="false">(</mo><msub><mi>T</mi><mi>i</mi></msub><mo stretchy="false">)</mo><mo>&lt;</mo><mi>W</mi><mo>−</mo><mi>T</mi><mi>S</mi><mo stretchy="false">(</mo><mi>X</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">TS(T_i)&lt;W-TS(X)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mclose">)</span></span></span></span>, abort <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">T_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> and restart it with a new TS to prevent it from starvation.
<ul>
<li>This condition means that this <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">T_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> is trying to read something from the future.</li>
</ul>
</li>
<li>Else, allow <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">T_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> to read <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi></mrow><annotation encoding="application/x-tex">X</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span></span></span></span>, and update <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi><mo>−</mo><mi>T</mi><mi>S</mi><mo stretchy="false">(</mo><mi>X</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">R-TS(X)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mclose">)</span></span></span></span> to <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi><mi>a</mi><mi>x</mi><mo stretchy="false">(</mo><mi>R</mi><mo>−</mo><mi>T</mi><mi>S</mi><mo stretchy="false">(</mo><mi>X</mi><mo stretchy="false">)</mo><mo separator="true">,</mo><mi>T</mi><mi>S</mi><mo stretchy="false">(</mo><msub><mi>T</mi><mi>i</mi></msub><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">max(R-TS(X), TS(T_i))</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">m</span><span class="mord mathnormal">a</span><span class="mord mathnormal">x</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mclose">)</span></span></span></span>.</li>
<li>A local copy of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi></mrow><annotation encoding="application/x-tex">X</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span></span></span></span> is made to ensure repeatable reads for <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">T_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>.</li>
</ul>
</li>
<li>When <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">T_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> wants to write <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi></mrow><annotation encoding="application/x-tex">X</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span></span></span></span>:
<ul>
<li>If <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>T</mi><mi>S</mi><mo stretchy="false">(</mo><msub><mi>T</mi><mi>i</mi></msub><mo stretchy="false">)</mo><mo>&lt;</mo><mi>R</mi><mo>−</mo><mi>T</mi><mi>S</mi><mo stretchy="false">(</mo><mi>X</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">TS(T_i)&lt;R-TS(X)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mclose">)</span></span></span></span> or <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>T</mi><mi>S</mi><mo stretchy="false">(</mo><msub><mi>T</mi><mi>i</mi></msub><mo stretchy="false">)</mo><mo>&lt;</mo><mi>W</mi><mo>−</mo><mi>T</mi><mi>S</mi><mo stretchy="false">(</mo><mi>X</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">TS(T_i)&lt;W-TS(X)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mclose">)</span></span></span></span>, abort and restart <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">T_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>.
<ul>
<li>The first condition means that another transaction from the future cannot see the write from <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">T_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> in the past.</li>
<li>The second condition means that another transaction from the future already wrote this object and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">T_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> cannot overwrite it in the past.</li>
</ul>
</li>
<li>Else, allow <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">T_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> to write <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi></mrow><annotation encoding="application/x-tex">X</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span></span></span></span> and update <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>W</mi><mo>−</mo><mi>T</mi><mi>S</mi><mo stretchy="false">(</mo><mi>X</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">W-TS(X)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mclose">)</span></span></span></span>.</li>
<li>Also, a local copy is made.</li>
</ul>
</li>
</ol>
<h3 id="can-we-optimize-the-write-rule-to-decrease-the-possibility-of-abort"><a class="markdownIt-Anchor" href="#can-we-optimize-the-write-rule-to-decrease-the-possibility-of-abort"></a> Can we optimize the write rule to decrease the possibility of abort?</h3>
<ol>
<li>Thomas write rule: If <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>T</mi><mi>S</mi><mo stretchy="false">(</mo><msub><mi>T</mi><mi>i</mi></msub><mo stretchy="false">)</mo><mo>&lt;</mo><mi>W</mi><mo>−</mo><mi>T</mi><mi>S</mi><mo stretchy="false">(</mo><mi>X</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">TS(T_i) &lt; W-TS(X)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mclose">)</span></span></span></span>, ignore the write to allow the transaction to continue executing without aborting.
<ul>
<li>The thought is that we can see this violation as an immediate write from a future transaction right after the successful write from <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">T_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>.</li>
<li>The effects are similar, i.e., no one sees what does <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">T_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> write.</li>
</ul>
</li>
<li>If <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>T</mi><mi>S</mi><mo stretchy="false">(</mo><msub><mi>T</mi><mi>i</mi></msub><mo stretchy="false">)</mo><mo>&lt;</mo><mi>R</mi><mo>−</mo><mi>T</mi><mi>S</mi><mo stretchy="false">(</mo><mi>X</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">TS(T_i)&lt;R-TS(X)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mclose">)</span></span></span></span>, we still need to abort <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">T_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>.</li>
</ol>
<h3 id="what-are-the-issues-of-basic-to"><a class="markdownIt-Anchor" href="#what-are-the-issues-of-basic-to"></a> What are the issues of basic T/O?</h3>
<ol>
<li>There is high overhead from copying data to the transaction’s workspace and updating timestamps. Every read requires the transaction to write to the database.</li>
<li>Long-running transactions can get starved. The likelihood that a transaction will read something from a newer transaction increases.</li>
<li>If you assume that conflicts between transactions are rare and that most transactions are short-lived, forcing transactions to acquire locks or update timestamps adds unnecessary overhead.</li>
</ol>
<h2 id="optimistic-concurrency-control"><a class="markdownIt-Anchor" href="#optimistic-concurrency-control"></a> Optimistic concurrency control</h2>
<h3 id="what-is-the-main-idea-of-occ"><a class="markdownIt-Anchor" href="#what-is-the-main-idea-of-occ"></a> What is the main idea of OCC?</h3>
<ol>
<li>OCC assumes that the number of conflicts is low. Especially when:
<ul>
<li>All transactions are read-only (ideal).</li>
<li>Txns access disjoint subsets of data.</li>
<li>The database is large, and the workload is not skewed.</li>
</ul>
</li>
<li>The DBMS creates a private workspace for each transaction.
<ul>
<li>Any object read is copied into the workspace. Modifications are applied to the workspace.</li>
<li>When a transaction is committed, the DBMS compares the workspace write set to see whether it conflicts with other transactions.</li>
<li>The write set is installed into the “global” database if there are no conflicts.</li>
</ul>
</li>
<li>OCC has three phases:
<ul>
<li>Read Phase: Track the read/write sets of transactions and store their writes in a private workspace, i.e., execution of transaction content.</li>
<li>Validation Phase: When a transaction commits, check whether it conflicts with other transactions.</li>
<li>Write Phase: If validation succeeds, apply private changes to the database. Otherwise, abort and restart the transaction.
<ul>
<li>Serial Commits: Use a global latch to limit a single transaction to be in the Validation/Write phases at a time.</li>
<li>Parallel Commits: Use fine-grained write latches to support parallel Validation/Write phases. Txns acquire latches in primary key order to avoid deadlocks.</li>
</ul>
</li>
</ul>
</li>
</ol>
<h3 id="what-will-happen-in-the-validation-phase"><a class="markdownIt-Anchor" href="#what-will-happen-in-the-validation-phase"></a> What will happen in the validation phase?</h3>
<ol>
<li>When transaction <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">T_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> invokes <code>COMMIT</code>, the DBMS checks if it conflicts with other transactions.
<ul>
<li>The DBMS needs to guarantee only serializable schedules are permitted.</li>
<li>Check other transactions for RW and WW conflicts and ensure that conflicts are in one direction (e.g., older→younger).</li>
</ul>
</li>
<li>There are two approaches to valid:
<ul>
<li>In backward validation, check whether the committing transaction intersects its read/write sets with any transactions already committed.<br />
<img src="/imgs/15445/TO/backward.png" width="50%"></li>
<li>In forward validation, check whether the committing transaction intersects its read/write sets with any active transactions that have not yet been committed.<br />
<img src="/imgs/15445/TO/forward.png" width="50%"></li>
</ul>
</li>
<li>Each transaction’s timestamp is assigned at the beginning of the validation phase. Check the timestamp ordering of the committing transaction with all other concerned transactions. When <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>T</mi><mi>S</mi><mo stretchy="false">(</mo><msub><mi>T</mi><mi>i</mi></msub><mo stretchy="false">)</mo><mo>&lt;</mo><mi>T</mi><mi>S</mi><mo stretchy="false">(</mo><msub><mi>T</mi><mi>j</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">TS(T_i)&lt;TS(T_j)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>, there are only three cases:
<ul>
<li>If <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">T_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> completes all three phases before <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">T_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.969438em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span> begins its execution. This means that there is serial ordering.</li>
<li>If <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">T_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> completes before <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">T_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.969438em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span> starts its Write phase, then we require that <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">T_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> does not write to any object read by <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">T_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.969438em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span>, i.e. <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>W</mi><mi>r</mi><mi>i</mi><mi>t</mi><mi>e</mi><mi>S</mi><mi>e</mi><mi>t</mi><mo stretchy="false">(</mo><msub><mi>T</mi><mi>i</mi></msub><mo stretchy="false">)</mo><mo>∩</mo><mi>R</mi><mi>e</mi><mi>a</mi><mi>d</mi><mi>S</mi><mi>e</mi><mi>t</mi><mo stretchy="false">(</mo><msub><mi>T</mi><mi>j</mi></msub><mo stretchy="false">)</mo><mo>=</mo><mi mathvariant="normal">∅</mi></mrow><annotation encoding="application/x-tex">WriteSet(T_i)\cap ReadSet(T_j)=\empty</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mord mathnormal">e</span><span class="mord mathnormal">t</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∩</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord mathnormal">e</span><span class="mord mathnormal">a</span><span class="mord mathnormal">d</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mord mathnormal">e</span><span class="mord mathnormal">t</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.80556em;vertical-align:-0.05556em;"></span><span class="mord">∅</span></span></span></span>.
<ul>
<li>At this condition, we can conclude that <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">T_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.969438em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span> cannot see anything written by <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">T_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>. Therefore, if <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">T_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.969438em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span> read anything written by <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">T_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>, it is a violation.</li>
</ul>
</li>
<li>If <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">T_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> completes its Read phase before <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">T_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.969438em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span>​ completes its Read phase, then we require that <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">T_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> does not write to any object that is either read or written by <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">T_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.969438em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span>.
<ul>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>W</mi><mi>r</mi><mi>i</mi><mi>t</mi><mi>e</mi><mi>S</mi><mi>e</mi><mi>t</mi><mo stretchy="false">(</mo><msub><mi>T</mi><mi>i</mi></msub><mo stretchy="false">)</mo><mo>∩</mo><mi>R</mi><mi>e</mi><mi>a</mi><mi>d</mi><mi>S</mi><mi>e</mi><mi>t</mi><mo stretchy="false">(</mo><msub><mi>T</mi><mi>j</mi></msub><mo stretchy="false">)</mo><mo>=</mo><mi mathvariant="normal">∅</mi></mrow><annotation encoding="application/x-tex">WriteSet(T_i) \cap ReadSet(T_j) = \empty</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mord mathnormal">e</span><span class="mord mathnormal">t</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∩</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord mathnormal">e</span><span class="mord mathnormal">a</span><span class="mord mathnormal">d</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mord mathnormal">e</span><span class="mord mathnormal">t</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.80556em;vertical-align:-0.05556em;"></span><span class="mord">∅</span></span></span></span> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>W</mi><mi>r</mi><mi>i</mi><mi>t</mi><mi>e</mi><mi>S</mi><mi>e</mi><mi>t</mi><mo stretchy="false">(</mo><msub><mi>T</mi><mi>i</mi></msub><mo stretchy="false">)</mo><mo>∩</mo><mi>W</mi><mi>r</mi><mi>i</mi><mi>t</mi><mi>e</mi><mi>S</mi><mi>e</mi><mi>t</mi><mo stretchy="false">(</mo><msub><mi>T</mi><mi>j</mi></msub><mo stretchy="false">)</mo><mo>=</mo><mi mathvariant="normal">∅</mi></mrow><annotation encoding="application/x-tex">WriteSet(T_i) \cap WriteSet(T_j) = \empty</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mord mathnormal">e</span><span class="mord mathnormal">t</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∩</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mord mathnormal">e</span><span class="mord mathnormal">t</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.80556em;vertical-align:-0.05556em;"></span><span class="mord">∅</span></span></span></span>.</li>
<li>Anything wrote by <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">T_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> should be seen by <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">T_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.969438em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span> and should not conflict with what <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">T_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.969438em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span> intends to write.</li>
<li>OCC wants more than just serializable orders. Similar to the Thomas write rule, if we allow the write sets to have something in common, it would still be serializable, yet in conflict.</li>
</ul>
</li>
</ul>
</li>
</ol>
<h3 id="what-are-the-issues-of-occ"><a class="markdownIt-Anchor" href="#what-are-the-issues-of-occ"></a> What are the issues of OCC?</h3>
<ol>
<li>High overhead for copying data locally.</li>
<li>Validation/Write phase bottlenecks.</li>
<li>Aborts are more wasteful than in 2PL because they only occur after a transaction has been executed.</li>
</ol>
<h1 id="the-phantom-problem"><a class="markdownIt-Anchor" href="#the-phantom-problem"></a> The phantom problem</h1>
<h2 id="what-is-the-phantom-problem"><a class="markdownIt-Anchor" href="#what-is-the-phantom-problem"></a> What is the phantom problem?</h2>
<ol>
<li>In the above transaction management protocols, we assume that the total number of tuples in a table is fixed, i.e., transactions will not execute insertion or deletion.</li>
<li>Insertions or deletions result in different results for the same range of scan queries, e.g., count, maximum.
<ul>
<li>The reason is that transactions can only lock on existing records, not one underway.</li>
</ul>
</li>
</ol>
<h2 id="how-can-we-solve-the-phantom-problem"><a class="markdownIt-Anchor" href="#how-can-we-solve-the-phantom-problem"></a> How can we solve the phantom problem?</h2>
<ol>
<li>The first approach is to re-execute scans.
<ul>
<li>The DBMS tracks the <code>WHERE</code> clause for all queries that the transaction executes. Retain the scan set for every range query in a transaction.</li>
<li>Upon committing, re-execute the scan portion of each query and check whether it generates the same result.</li>
<li>This could double the execution time for all queries, which may be unacceptable.</li>
</ul>
</li>
<li>The second approach is by predicate locking.
<ul>
<li>Shared lock on the predicate in a <code>WHERE</code> clause of a <code>SELECT</code> query.</li>
<li>Exclusive lock on the predicate in a <code>WHERE</code> clause of any <code>UPDATE</code>, <code>INSERT</code>, or <code>DELETE</code> query.</li>
<li>Prevent any query changing the result of the locked predicate from executing.</li>
</ul>
</li>
<li>The third approach is index locking.
<ul>
<li>Key-value locks only cover a single existing key-value in an index, while gap locks cover those virtual keys for non-existent values.</li>
<li>Key-range locks take multiple key-value and gap locks to lock on a range.</li>
<li>Hierarchical locking allows a transaction to hold wider key-range locks with different locking modes to reduce the number of visits to the lock manager.</li>
</ul>
</li>
<li>If there is no suitable index, then the transaction must obtain the following:
<ul>
<li>A lock on every page in the table to prevent a record’s attributes from being changed to fit the predicates.</li>
<li>The lock for the table itself prevents records that fit the predicates from being added or deleted.</li>
</ul>
</li>
</ol>
<h2 id="what-are-isolation-levels"><a class="markdownIt-Anchor" href="#what-are-isolation-levels"></a> What are isolation levels?</h2>
<ol>
<li>We may use a weaker level of consistency to improve scalability.</li>
<li>It provides for greater concurrency at the cost of exposing transactions to uncommitted changes: dirty reads, unrepeatable reads, and phantom reads.</li>
<li>The four isolation levels are as shown below:<br />
<img src="/imgs/15445/TO/isolation.png" width="50%"></li>
<li>Each isolation level requires different locks to implement:
<ul>
<li><code>SERIALIZABLE</code>: Obtain all locks first, plus index locks, plus strict 2PL.</li>
<li><code>REPEATABLE READS</code>: Same as above, but no index locks.</li>
<li><code>READ COMMITTED</code>: Same as above, but S locks are released immediately.</li>
<li><code>READ UNCOMMITTED</code>: Same as above, but allows dirty reads (no S locks).</li>
</ul>
</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://liyun-zhang.github.io/2023/08/04/Courses/15445/10-Two-Phase-Locking/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LiyunZhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LiyunZhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LiyunZhang">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/08/04/Courses/15445/10-Two-Phase-Locking/" class="post-title-link" itemprop="url">10 Two-Phase Locking</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-08-04 16:47:09" itemprop="dateCreated datePublished" datetime="2023-08-04T16:47:09+08:00">2023-08-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-03-16 15:37:10" itemprop="dateModified" datetime="2024-03-16T15:37:10+08:00">2024-03-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Open-Courses/" itemprop="url" rel="index"><span itemprop="name">Open Courses</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Open-Courses/CMU-15-445-645-Database-System/" itemprop="url" rel="index"><span itemprop="name">CMU 15-445/645 Database System</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><ul class="markdownIt-TOC">
<li><a href="#two-phase-locking">Two-phase Locking</a>
<ul>
<li><a href="#how-can-we-guarantee-serialization-without-knowing-the-entire-schedule-ahead-of-time">How can we guarantee serialization without knowing the entire schedule ahead of time?</a></li>
<li><a href="#what-is-the-problem-with-releasing-locks-and-acquiring-them-later-again">What is the problem with releasing locks and acquiring them later again?</a></li>
<li><a href="#what-is-the-problem-of-two-phase-locking">What is the problem of two-phase locking?</a></li>
</ul>
</li>
<li><a href="#deadlock">Deadlock</a>
<ul>
<li><a href="#how-to-detect-and-resolve-deadlocks">How to detect and resolve deadlocks?</a></li>
<li><a href="#how-to-prevent-deadlocks">How to prevent deadlocks?</a></li>
</ul>
</li>
<li><a href="#lock-granularity">Lock granularity</a>
<ul>
<li><a href="#what-are-the-database-objects">What are the database objects?</a></li>
<li><a href="#how-to-support-multiple-granularities">How to support multiple granularities?</a></li>
<li><a href="#how-to-use-locks">How to use locks?</a></li>
</ul>
</li>
</ul>
</p>
<h1 id="two-phase-locking"><a class="markdownIt-Anchor" href="#two-phase-locking"></a> Two-phase Locking</h1>
<h2 id="how-can-we-guarantee-serialization-without-knowing-the-entire-schedule-ahead-of-time"><a class="markdownIt-Anchor" href="#how-can-we-guarantee-serialization-without-knowing-the-entire-schedule-ahead-of-time"></a> How can we guarantee serialization without knowing the entire schedule ahead of time?</h2>
<ol>
<li>We can use locks to protect database objects.
<ul>
<li>When a transaction wants to access some objects, it needs to acquire locks of those objects from a centralized lock manager.</li>
<li>Locks are issued by applications and handled in the lock manager, while latches are issued and acquired locally. Hence, locks are more expensive than latches, even if they are free.</li>
</ul>
</li>
<li>There are <code>S-LOCK</code> and <code>X-LOCK</code>.
<ul>
<li><code>S-LOCKs</code> are shared locks for reads, while <code>X-LOCKs</code> are exclusive locks for writes.</li>
<li>Their compatibility matrix is as follows:<br />
<img src="/imgs/15445/2pl/sx_comp_matrix.png" width="50%"></li>
</ul>
</li>
<li>The lock manager keeps track of what transactions hold, what locks are locked, and what transactions are waiting to acquire any locks.
<ul>
<li>The lock manager grants or blocks requests when transactions request or upgrade locks. The lock manager updates its internal lock table when transactions release or downgrade locks.</li>
<li>The lock manager is responsible for detecting deadlock and choosing some transactions to kill.</li>
</ul>
</li>
</ol>
<h2 id="what-is-the-problem-with-releasing-locks-and-acquiring-them-later-again"><a class="markdownIt-Anchor" href="#what-is-the-problem-with-releasing-locks-and-acquiring-them-later-again"></a> What is the problem with releasing locks and acquiring them later again?</h2>
<ol>
<li>This may cause inconsistent reads for a transaction when another transaction modified the object when the lock was available.</li>
<li>This problem can be solved by two-phase locking.
<ul>
<li>The first phase is growing:
<ul>
<li>Each transaction requests or upgrades the locks it needs from the DBMS’s lock manager. The lock manager grants/denies lock requests.</li>
</ul>
</li>
<li>The second phase is shrinking:
<ul>
<li>The transaction can only release or downgrade the locks that it previously acquired. It cannot acquire new locks.</li>
</ul>
</li>
</ul>
</li>
<li>Two-phase locking is sufficient to guarantee conflict serializability because it generates schedules whose precedence graph is acyclic.</li>
</ol>
<h2 id="what-is-the-problem-of-two-phase-locking"><a class="markdownIt-Anchor" href="#what-is-the-problem-of-two-phase-locking"></a> What is the problem of two-phase locking?</h2>
<ol>
<li>It is subject to cascading aborts caused by dirty reads.
<ul>
<li>When a transaction modifies an object and releases the lock before it is aborted, the modified object is exposed to other transactions.</li>
<li>When the modifier is aborted, all other transactions using the modified object need to abort.</li>
</ul>
</li>
<li>This can be solved by strong strict two-phase locking (rigorous two-phase locking).
<ul>
<li>The transaction can only release locks after it ends, i.e., committed or aborted.</li>
</ul>
</li>
<li>A schedule is strict if a value written by a transaction is not read or overwritten by other transactions until that transaction finishes.
<ul>
<li>Its advantages are that it does not incur cascading aborts, and aborted transactions can be undone by restoring the original values of modified tuples.</li>
<li>However, it allows only conflict serializable schedules, but it is often stronger than needed for some apps. Most DBMSs prefer correctness before performance.</li>
</ul>
</li>
</ol>
<h1 id="deadlock"><a class="markdownIt-Anchor" href="#deadlock"></a> Deadlock</h1>
<h2 id="how-to-detect-and-resolve-deadlocks"><a class="markdownIt-Anchor" href="#how-to-detect-and-resolve-deadlocks"></a> How to detect and resolve deadlocks?</h2>
<ol>
<li>The two-phase locking may lead to deadlocks.</li>
<li>The DBMS creates a waits-for graph to keep track of what locks each transaction is waiting to acquire
<ul>
<li>Nodes are transactions. Edge from <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">T_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> to <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">T_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.969438em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span> if <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">T_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> is waiting for <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">T_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.969438em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span> to release a lock.</li>
<li>The system periodically checks for cycles in the waits-for graph and then decides how to break it.</li>
</ul>
</li>
<li>When the DBMS detects a deadlock, it will select a “victim” transaction to rollback to break the cycle.
<ul>
<li>Depending on how it was invoked, the victim transaction will either restart or abort (more common).</li>
<li>There is a trade-off between the frequency of checking for deadlocks and how long transactions wait before deadlocks are broken.</li>
</ul>
</li>
<li>Selecting the proper victim depends on a lot of different variables.
<ul>
<li>By age (lowest timestamp)</li>
<li>By progress (least/most queries executed)</li>
<li>By the number of items already locked</li>
<li>By the number of transactions that we have to rollback with it</li>
<li>We also should consider the # of times a transaction has been restarted in the past to prevent starvation.</li>
</ul>
</li>
<li>After selecting a victim transaction to abort, the DBMS can also decide how far to rollback the transaction’s changes.
<ul>
<li>The first approach is to rollback the entire transaction and tell the application that it was aborted.</li>
<li>The second approach is rolling back a portion of a transaction to break the deadlock and then attempting to re-execute the undone queries.</li>
</ul>
</li>
</ol>
<h2 id="how-to-prevent-deadlocks"><a class="markdownIt-Anchor" href="#how-to-prevent-deadlocks"></a> How to prevent deadlocks?</h2>
<ol>
<li>When a transaction tries to acquire a lock held by another transaction, the DBMS kills one to prevent a deadlock.</li>
<li>Assign priorities based on timestamps, e.g., older timestamp means higher priority.</li>
<li>The first kind of rule is Wait-Die (“Old Waits for Young”)
<ul>
<li>If requesting a transaction has higher priority than holding a transaction, then requesting a transaction waits for the holding transaction. Otherwise, requesting transaction aborts.</li>
</ul>
</li>
<li>The second kind of rule is Wound-Wait (“Young Waits for Old”)
<ul>
<li>If requesting a transaction has higher priority than holding a transaction, then holding the transaction aborts and releases the lock. Otherwise, requesting transaction waits.</li>
</ul>
</li>
<li>In this case, only one “type” of direction is allowed when waiting for a lock.</li>
<li>When a transaction restarts, its new priority remains its original timestamp to prevent it from getting starved for resources like an old man at a corrupt senior center.</li>
</ol>
<h1 id="lock-granularity"><a class="markdownIt-Anchor" href="#lock-granularity"></a> Lock granularity</h1>
<h2 id="what-are-the-database-objects"><a class="markdownIt-Anchor" href="#what-are-the-database-objects"></a> What are the database objects?</h2>
<ol>
<li>Depending on the lock granularity, it can be attributes, tuples, pages, or tables.</li>
<li>The trade-off is between parallelism versus overhead of requesting and lock manager processing.</li>
<li>In a hierarchical lock scheme, the objects from top-layer to lower-layer are database, table, page, tuple, and attribute.</li>
</ol>
<h2 id="how-to-support-multiple-granularities"><a class="markdownIt-Anchor" href="#how-to-support-multiple-granularities"></a> How to support multiple granularities?</h2>
<ol>
<li>With only <code>S-LOCK</code> and <code>X-LOCK</code>, we have to check the locks of all children when we try to lock a higher-level node.</li>
<li>An intention lock allows a higher-level node to be locked in a shared or exclusive mode without checking all descendent nodes.</li>
<li>If a node is locked in an intention mode, then some transaction explicitly locks at a lower level in the tree.
<ul>
<li>Intention-Shared (<code>IS</code>) indicates explicit locking at a lower level with shared locks.</li>
<li>Intention-Exclusive (<code>IX</code>) indicates explicit locking at a lower level with exclusive locks.</li>
<li>Shared+Intention-Exclusive (<code>SIX</code>) indicates that the subtree rooted by that node is locked explicitly in shared mode, and explicit locking is being done at a lower level with exclusive-mode locks.</li>
<li>Their compatibility matrix is as follows:<br />
<img src="/imgs/15445/2pl/intention.png" width="50%"></li>
</ul>
</li>
<li>Each transaction obtains an appropriate lock at the highest level of the database hierarchy.
<ul>
<li>The transaction must hold at least <code>IS</code> on the parent node to get an <code>S</code> or <code>IS</code> lock on a node.</li>
<li>It must hold at least <code>IX</code> on the parent node to get <code>X</code>, <code>IX</code>, or <code>SIX</code> on a node.</li>
</ul>
</li>
<li>Multiple lock granularities are shown in the <code>S</code>, <code>X</code>, and <code>SIX</code> locks on higher-level objects.
<ul>
<li>Intention-Shared (<code>IS</code>): Intent to get <code>S</code> lock(s) at a finer granularity.</li>
<li>Intention-Exclusive (<code>IX</code>): Intent to get <code>X</code> lock(s) at a finer granularity.</li>
<li>Shared+Intention-Exclusive (<code>SIX</code>): Like <code>S</code> and <code>IX</code> at the same time.</li>
</ul>
</li>
</ol>
<h2 id="how-to-use-locks"><a class="markdownIt-Anchor" href="#how-to-use-locks"></a> How to use locks?</h2>
<ol>
<li>Applications typically don’t acquire a transaction’s locks manually (i.e., explicit SQL commands).
<ul>
<li>Sometimes, you need to provide the DBMS with hints to help it improve concurrency.</li>
<li>Explicit locks are also helpful when making major changes to the database.</li>
</ul>
</li>
<li>Lock escalation: The DBMS can automatically switch to coarser-grained locks when a transaction acquires too many low-level locks. This reduces the number of requests that the lock manager must process.</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://liyun-zhang.github.io/2023/08/02/OpenSource/BusTub/Project-3-Query-Execution/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LiyunZhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LiyunZhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LiyunZhang">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/08/02/OpenSource/BusTub/Project-3-Query-Execution/" class="post-title-link" itemprop="url">Project #3: Query Execution</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-08-02 00:52:07" itemprop="dateCreated datePublished" datetime="2023-08-02T00:52:07+08:00">2023-08-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-03-16 23:40:29" itemprop="dateModified" datetime="2024-03-16T23:40:29+08:00">2024-03-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Open-Source-Code/" itemprop="url" rel="index"><span itemprop="name">Open Source Code</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Open-Source-Code/BusTub/" itemprop="url" rel="index"><span itemprop="name">BusTub</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><ul class="markdownIt-TOC">
<li><a href="#executors">Executors</a>
<ul>
<li><a href="#overall">Overall</a></li>
<li><a href="#scan">Scan</a></li>
<li><a href="#modification">Modification</a></li>
<li><a href="#aggregation">Aggregation</a></li>
<li><a href="#nestedloopjoin">NestedLoopJoin</a></li>
<li><a href="#hashjoin">HashJoin</a></li>
<li><a href="#sort-top-n">Sort &amp; Top-N</a></li>
</ul>
</li>
<li><a href="#optimizer">Optimizer</a>
<ul>
<li><a href="#nested-loop-join">Nested loop join</a></li>
<li><a href="#order-by">Order by</a></li>
<li><a href="#projection">Projection</a></li>
<li><a href="#filter">Filter</a></li>
</ul>
</li>
</ul>
</p>
<h1 id="executors"><a class="markdownIt-Anchor" href="#executors"></a> Executors</h1>
<h2 id="overall"><a class="markdownIt-Anchor" href="#overall"></a> Overall</h2>
<ol>
<li>The planner for each operation stores the necessary information to calculate the correct output.</li>
<li>The executor class for each operation stores the corresponding plan and other information to determine what tuple will be returned.
<ul>
<li>All executors must override the <code>Init()</code> and <code>Next(Tuple *tuple, RID *rid)</code>.</li>
<li><code>Init()</code> is used to initialize the information to determine what tuple will be returned. It is separated from the constructor because its parent executor may need to fetch the tuples of the current executor several times.</li>
</ul>
</li>
<li>The <code>ExecutorContext</code> in each executor stores the metadata of the database system, including catalog and buffer pool manager.
<ul>
<li>Catalog maintains the tables and indexes in the current database.</li>
<li>We can register a new table or index through a catalog or acquire metadata of a table (TableInfo) or index (IndexInfo) from the catalog.</li>
</ul>
</li>
<li><code>TableInfo</code> stores the name, OID, schema of the table, and a pointer for <code>TableHeap</code>.
<ul>
<li>We can manipulate a table through its <code>TableHeap</code>.</li>
<li>The <code>TableHeap</code> provides methods to insert or get tuples and update or get tuple metadata.
<ul>
<li>We need to mark the <code>is_deleted_</code> flag in its metadata to delete a tuple as <code>true</code>.</li>
<li>To update a tuple, we need to delete it first and insert the newly updated tuple into the table again.</li>
<li><code>TableHeap</code> also provides <code>MakeIterator()</code> to iterate through the table.</li>
</ul>
</li>
</ul>
</li>
<li>The <code>IndexInfo</code> stores the name and OID of the index, the schema for the index key, the name of the table, and a pointer of the <code>Index</code>.
<ul>
<li>We can manipulate an index through its <code>Index</code>.</li>
<li>The <code>Index</code> provides methods to insert or delete an entry from the index and get index metadata.
<ul>
<li>The metadata includes the names of the index and table, the mapping relation between the key schema and tuple schema, and the schema of the indexed key.</li>
<li>The <code>Index</code> is the abstract class of all kinds of index implementations. To use a specific known index implementation, we can <code>dynamic_cast</code> it.</li>
</ul>
</li>
</ul>
</li>
<li>This system supports <code>ArithmeticExpression</code>, <code>ColumnValueExpression</code>, <code>ComparisonExpression</code>, <code>ConstantValueExpression</code>, <code>LogicExpression</code>, <code>StringExpression</code>.
<ul>
<li>The <code>AbstractExpression</code> provides an <code>Evaluate</code> method to calculate the desired <code>Value</code> according to the provided one <code>Tuple</code> and <code>Schema</code>.
<ul>
<li>The <code>ArithmeticExpression</code> only supports <code>PLUS</code> and <code>MINUS</code> operation of two <code>Value</code>s.</li>
<li>The <code>ColumnValueExpression</code> returns the <code>Value</code> of the designated column.</li>
<li>The <code>ComparisonExpression</code> supports the comparison result of two <code>Values</code>s of <code>equal, not equal, less, less or equal, greater, greater or equal</code>.</li>
<li>The <code>ConstantValueExpression</code> returns a single constant <code>Value</code>.</li>
<li>The <code>LogicExpression</code> supports the <code>AND/OR</code> of two <code>Value</code>s.</li>
<li>The <code>StringExpression</code> converts a string to lower-case or upper-case.</li>
</ul>
</li>
<li>The <code>AbstractExpression</code> also provides an <code>EvaluateJoin</code> method to calculate the join condition of two <code>Tuple</code>s. They support the same functions as <code>Evaluation</code>, except that they consider two tuples.</li>
<li><code>ArithmeticExpression</code>, <code>ComparisonExpression</code>, <code>LogicExpression</code>, and <code>LogicExpression</code> may have child-expressions. During evaluation, they will first perform child expressions recursively.</li>
</ul>
</li>
</ol>
<h2 id="scan"><a class="markdownIt-Anchor" href="#scan"></a> Scan</h2>
<ol>
<li>In sequential scans, we only need to know which table to scan.
<ul>
<li>The object ID and name of the table are stored in the planner.</li>
<li>In the <code>Init()</code>, the table metadata (<code>TableInfo</code>) is fetched from the catalog, and the corresponding iterator of the table is created.</li>
<li>In the <code>Next(Tuple *tuple, RID *rid)</code>, if the iterator is not at the end, we need to find the first tuple with <code>is_deleted_</code> being <code>false</code> and matching with <code>filter_predicate_</code>.</li>
</ul>
</li>
<li>In the index scan, we need to know which index to scan and which table to fetch the tuple.
<ul>
<li>The OID of the index is stored in the planner, while the table name is stored in <code>IndexInfo</code>.</li>
<li>To fetch the iterator of the index, we need to cast the <code>Index</code> into the specific implementation.</li>
<li>Each iterator points to <code>(key, RecordID)</code> pair. We can fetch the tuple with the <code>GetTuple</code> of the <code>TableHeap</code>.</li>
<li>As long as the iterator is not at the end, we must find the first tuple with <code>is_deleted_</code> being <code>false</code>.</li>
</ul>
</li>
</ol>
<h2 id="modification"><a class="markdownIt-Anchor" href="#modification"></a> Modification</h2>
<ol>
<li>We will modify the table and all the associated indexes in the modification executors.
<ul>
<li>The table OIDs are stored in the corresponding planner, while we can fetch all indexes of that table with the name of the table in <code>TableInfo</code>.</li>
<li>The indexed keys can be acquired using the <code>KeyFromTuple</code> method of <code>Tuple</code>. The stored values are RecordIDs.</li>
</ul>
</li>
<li>All the modification executors only return one row representing the number of modified tuples. Hence, the executor should handle all the modifications in one <code>Next</code> call.
<ul>
<li>When no modification is performed, we should also return one row of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span>.</li>
<li>To distinguish between no modification and modification already finished in the last call, we should have a flag representing whether or not we have already modified the table.</li>
</ul>
</li>
<li>The tuples to insert or delete are acquired from the child executor in the insert executor and delete executor.</li>
<li>The update planner has a target expression for each output column.
<ul>
<li>After acquiring the original tuple from the child executor, we can evaluate each output column with target expressions.</li>
<li>The expressions can be any expressions here.</li>
<li>When updating indexes, the old ones must be deleted before insertion.</li>
</ul>
</li>
</ol>
<h2 id="aggregation"><a class="markdownIt-Anchor" href="#aggregation"></a> Aggregation</h2>
<ol>
<li>The aggregations are implemented with a hash table.
<ul>
<li>The hash table hashes the aggregate keys to the aggregate result.</li>
<li>When inserting a tuple into the hash table, it updates the aggregate result according to the aggregate function and the aggregate values from the tuple.</li>
<li>To use <code>std::hash</code>, the key is <code>AggregateKey</code> containing a vector of <code>Value</code> describing the group-by keys, while the value is <code>AggregateValue</code> containing another vector of <code>Value</code> describing aggregate values.
<ul>
<li>The <code>AggregateKey</code> needs to override the <code>==</code> operator and provide the <code>()</code> operator in <code>struct std::hash&lt;bustub::AggregateKey&gt;</code> to calculate the hash value of <code>AggregateKey</code>.</li>
</ul>
</li>
</ul>
</li>
<li>Aggregations are pipeline breakers. Hence, the build phase could be performed in the Init(), where all tuples from the child executor are read and inserted into the hash table to calculate the outputs.
<ul>
<li>If no tuple is inserted, the aggregation executor must return the default values for each aggregate function.</li>
<li>The aggregation planner has two vectors of <code>AbstractExpressionRef</code> to fetch the aggregate keys and aggregate values from tuples received from the child executor for aggregate computation. They are all <code>ColumnExpression</code>.</li>
</ul>
</li>
<li>In the <code>Next(Tuple *tuple, RID *rid)</code>, we must iterate over the hash table and output a tuple combining the aggregate keys and results.</li>
</ol>
<h2 id="nestedloopjoin"><a class="markdownIt-Anchor" href="#nestedloopjoin"></a> NestedLoopJoin</h2>
<ol>
<li>
<p>The executor must iterate over the left child executor and the right child executor.</p>
<ul>
<li>When the right child executor has emitted all tuples, the join executor will try to fetch a new tuple from the left child executor and re-initialize the right child executor for the following comparison.</li>
<li>Since we do not always fetch from the left child executor when the <code>Next</code> is called, we need to record the current left tuple when it is fetched.</li>
<li>To distinguish between the status of no more left tuples and those that have not fetched any left tuples yet, we can fetch the first left tuple in <code>Init()</code>.</li>
<li>To mark the status of no more left tuples, i.e., no more tuples to emit, we need a flag to record the status of left tuples and the returned value of the <code>Next</code> left child executor.</li>
</ul>
</li>
<li>
<p>For the left join, if an outer tuple does not match any inner tuple, we still need to emit the concatenation of that outer tuple with an all-null inner tuple.</p>
</li>
<li>
<p>The predicate expression of the executor can be either a <code>LogicExpression</code> or <code>ComparisonExpression</code>.</p>
</li>
</ol>
<h2 id="hashjoin"><a class="markdownIt-Anchor" href="#hashjoin"></a> HashJoin</h2>
<ol>
<li>Similar to aggregations, we need a hash table for the outer table. We define <code>JoinKey</code> and <code>JoinBucket</code> to hash.
<ul>
<li>We store all tuples with the same values in the attributes of the join condition.</li>
<li>We must also record whether one tuple is used to support left join.
<ul>
<li>When a tuple is matched with some inner tuple, all tuples in the same bucket must also matched. Hence, we only need to record the usage of each <code>JoinBucket</code>.</li>
<li>For left join, when there are no more right tuples, the executor still needs to iterate through the hash table to see if any bucket is unused.</li>
</ul>
</li>
<li>Similar to aggregation, <code>HashJoin</code> must build the hash table based on the outer table in <code>Init()</code>.</li>
</ul>
</li>
<li>Unlike <code>NestedLoopJoin</code>, the plan of HashJoin only needs to know how to fetch columns from each tuple to determine whether those tuples are matched.
<ul>
<li>The expressions of the <code>HashJoin</code> planner are only <code>ColumnValueExpression</code>.</li>
</ul>
</li>
</ol>
<h2 id="sort-top-n"><a class="markdownIt-Anchor" href="#sort-top-n"></a> Sort &amp; Top-N</h2>
<ol>
<li>The compare function needs specific expressions to fetch designated columns from each tuple.
<ul>
<li>Hence, we cannot implement only a non-static member function or a function with expressions as one of the parameters.</li>
<li>We need to implement a structure with an override <code>()</code> operator. The expressions are passed to the object in initialization.</li>
<li>For <code>priority_queue</code>, two nodes will be swapped when the comparison function returns true.</li>
</ul>
</li>
<li>In <code>Init()</code>, we must fetch and sort all tuples from the child executor.
<ul>
<li>For the Top-N executor, the heap size should not be larger than <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span>. The heap after the <code>Init()</code> is the counter-order of the output order. Hence, we still need a stack to support output in <code>Next</code>.</li>
</ul>
</li>
</ol>
<h1 id="optimizer"><a class="markdownIt-Anchor" href="#optimizer"></a> Optimizer</h1>
<ol>
<li>When optimizing a plan, the root plan is passed to the optimizer, and the optimizer will perform a DFS of the plan tree.</li>
<li>Each optimizer tries to recognize the pattern they must handle and produce a new plan when matched.</li>
</ol>
<h2 id="nested-loop-join"><a class="markdownIt-Anchor" href="#nested-loop-join"></a> Nested loop join</h2>
<ol>
<li>To optimize nested loop join with hash join, the optimizer must find a nested loop join and separate all the conditions from <code>LogicExpression</code> into <code>ComparisonExpression</code>.
<ul>
<li>If all the <code>ComparisonExpression</code> are <code>ComparisonType::Equal</code>, we can create a new plan of <code>HashJoin</code> with <code>left_key_expressions</code> and <code>right_key_expressions</code> extracted from those <code>ComparisonExpression</code>.</li>
</ul>
</li>
<li>Push down predicates of nested loop join to reduce the output of children of join and the complexity of join.
<ul>
<li>Only predicates that only involve one side of the input of the join operator can be pushed down.</li>
<li>Some predicates need to be pushed into the left child, some to the right child, and some remain in the join.</li>
<li>To push down the predicate, we can create a new FilterPlanNode as a child of join and father of the original child.</li>
</ul>
</li>
<li>Nested loop join can be replaced by hash join when the predicates are all equal conditions.</li>
<li>If the parent planner of a nested loop join is an aggregation planner, and that aggregation planner involves only data from one side, we can push down that aggregation as one of the children of join.
<ul>
<li>The insight is that aggregation usually outputs fewer rows than input since aggregation groups rows before sending one row for each group.</li>
<li>The columns in the mathematical expressions need to be modified according to the side of aggregation.</li>
</ul>
</li>
</ol>
<h2 id="order-by"><a class="markdownIt-Anchor" href="#order-by"></a> Order by</h2>
<ol>
<li>To optimize the sorted limit into top-N, we need to check whether the child of a limit plan is a sort.</li>
<li>When sorting the table, instead of executing sort algorithms, we may use the existing index to traverse the table.
<ul>
<li>It can only be used when the desired order is ascending, or default and the child of the sorting planner is the SeqScan planner.</li>
</ul>
</li>
</ol>
<h2 id="projection"><a class="markdownIt-Anchor" href="#projection"></a> Projection</h2>
<ol>
<li><code>SELECT *</code>, aggregations, or renaming the columns in the planner may cause multiple identical project planners.
<ul>
<li>The child of the projection planner is not required to be a projection.</li>
<li>We can remove the projection planner if it has the same schema as its child except for the column name.</li>
<li>Then, the output schema of the child is replaced by the output schema of the projection.</li>
</ul>
</li>
<li>The child of the projection planner may be emitting unnecessary columns.
<ul>
<li>Besides the naive projection, a projection planner could also perform arithmetical expressions.</li>
<li>If the child is another projection, we can merge them and express the new projection under the column schema of the child’s input schema.</li>
<li>If the child is an aggregation planner, it only needs to calculate those necessary aggregations.</li>
</ul>
</li>
</ol>
<h2 id="filter"><a class="markdownIt-Anchor" href="#filter"></a> Filter</h2>
<ol>
<li>Always true filters can be eliminated to avoid re-evaluation for every row.</li>
<li>The filter planner with a child of sequential scan can be merged to reduce the data transmission between executors.</li>
<li>When the predicate of sequential scan is all equal conditions, and a corresponding index exists, the sequential scan can be replaced by an index scan to avoid scanning the entire table.
<ul>
<li>It needs to modify the <code>IndexScanPlanner</code> and the <code>IndexScanExecutor</code> to support scanning only the row designated by the equal conditions.</li>
</ul>
</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://liyun-zhang.github.io/2023/07/16/Courses/15445/09-Concurrency-Control/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LiyunZhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LiyunZhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LiyunZhang">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/07/16/Courses/15445/09-Concurrency-Control/" class="post-title-link" itemprop="url">09 Concurrency Control</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-07-16 16:35:24" itemprop="dateCreated datePublished" datetime="2023-07-16T16:35:24+08:00">2023-07-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-03-16 15:27:44" itemprop="dateModified" datetime="2024-03-16T15:27:44+08:00">2024-03-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Open-Courses/" itemprop="url" rel="index"><span itemprop="name">Open Courses</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Open-Courses/CMU-15-445-645-Database-System/" itemprop="url" rel="index"><span itemprop="name">CMU 15-445/645 Database System</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><ul class="markdownIt-TOC">
<li><a href="#concurrency-control-recovery">Concurrency control &amp; recovery</a>
<ul>
<li><a href="#what-do-we-want-from-concurrency-control-recovery">What do we want from concurrency control &amp; recovery?</a></li>
<li><a href="#how-do-applications-issue-changes-to-a-dbms">How do applications issue changes to a DBMS?</a></li>
<li><a href="#what-does-the-dbms-want-to-prevent-when-supporting-concurrency">What does the DBMS want to prevent when supporting concurrency?</a></li>
</ul>
</li>
<li><a href="#correctness">Correctness</a>
<ul>
<li><a href="#what-are-the-correctness-criteria">What are the correctness criteria?</a></li>
<li><a href="#how-to-ensure-atomicity">How to ensure atomicity?</a></li>
<li><a href="#what-is-consistency">What is consistency?</a></li>
<li><a href="#isolation">Isolation</a>
<ul>
<li><a href="#what-do-we-want-from-isolation">What do we want from isolation?</a></li>
<li><a href="#how-to-decide-whether-a-schedule-matches-isolation">How to decide whether a schedule matches isolation?</a></li>
<li><a href="#what-conflicts-do-we-want-to-prevent">What conflicts do we want to prevent?</a></li>
<li><a href="#how-do-we-determine-whether-a-schedule-is-conflict-serializable">How do we determine whether a schedule is conflict serializable?</a></li>
<li><a href="#how-do-we-determine-whether-a-schedule-is-view-serializable">How do we determine whether a schedule is view serializable?</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</p>
<h1 id="concurrency-control-recovery"><a class="markdownIt-Anchor" href="#concurrency-control-recovery"></a> Concurrency control &amp; recovery</h1>
<h2 id="what-do-we-want-from-concurrency-control-recovery"><a class="markdownIt-Anchor" href="#what-do-we-want-from-concurrency-control-recovery"></a> What do we want from concurrency control &amp; recovery?</h2>
<ol>
<li>The concurrency control is responsible for the lost update problem.
<ul>
<li>How can we avoid race conditions when updating records at the same time?</li>
<li>This involves the buffer pool manager layer, access methods layer, and operator execution layer.</li>
</ul>
</li>
<li>Recovery is responsible for durability problems.
<ul>
<li>How can we ensure the correct state in case of a power failure?</li>
<li>This involves the disk manager layer and buffer pool manager layer.</li>
</ul>
</li>
</ol>
<h2 id="how-do-applications-issue-changes-to-a-dbms"><a class="markdownIt-Anchor" href="#how-do-applications-issue-changes-to-a-dbms"></a> How do applications issue changes to a DBMS?</h2>
<ol>
<li>A transaction is the execution of a sequence of one or more operations (e.g., SQL queries) on a database to perform some higher-level function.
<ul>
<li>Transaction is the basic unit of change in a DBMS. Partial transactions are not allowed.</li>
<li>A new transaction starts with the <code>BEGIN</code> command.</li>
<li>The transaction stops with either <code>COMMIT</code> or <code>ABORT</code>:
<ul>
<li>If committed, the DBMS either saves all the transaction’s changes <strong>or aborts</strong> it.</li>
<li>If aborted, all changes are undone so that it’s as if the transaction was never executed at all.</li>
<li>Abort can be either self-inflicted or caused by the DBMS.</li>
</ul>
</li>
</ul>
</li>
<li>In a strawman system, each transaction is executed one-by-one as they arrive at the DBMS.
<ul>
<li>Before a transaction starts, copy the entire database to a new file and make all changes.
<ul>
<li>If the transaction completes successfully, overwrite the original file with the new one.</li>
<li>If the transaction fails, remove the dirty copy.</li>
</ul>
</li>
<li>The problem with this system is that there is no concurrency, and copying the entire database can be expensive if it is large.</li>
</ul>
</li>
<li>Besides correctness and fairness, we also want the DBMS to allow concurrent execution of independent transactions to provide better utilization/throughput and increase user response times.</li>
</ol>
<h2 id="what-does-the-dbms-want-to-prevent-when-supporting-concurrency"><a class="markdownIt-Anchor" href="#what-does-the-dbms-want-to-prevent-when-supporting-concurrency"></a> What does the DBMS want to prevent when supporting concurrency?</h2>
<ol>
<li>Arbitrary interleaving of operations can lead to temporary inconsistency and permanent inconsistency.
<ul>
<li>Temporary inconsistency is unavoidable and fine as long as no other transactions can see it.</li>
<li>Permanent inconsistency is unacceptable.</li>
</ul>
</li>
<li>The DBMS is only concerned about what data is read/written from/to the database. Changes to the “outside world,” e.g., sending an email, are beyond the scope of the DBMS.</li>
</ol>
<h1 id="correctness"><a class="markdownIt-Anchor" href="#correctness"></a> Correctness</h1>
<h2 id="what-are-the-correctness-criteria"><a class="markdownIt-Anchor" href="#what-are-the-correctness-criteria"></a> What are the correctness criteria?</h2>
<ol>
<li><strong>Atomicity</strong>: All actions in the transaction happen, or none happen, i.e., “all or nothing.”</li>
<li><strong>Consistency</strong>: If each transaction is consistent and the DB starts consistent, it ends up consistent.</li>
<li><strong>Isolation</strong>: Execution of one transaction is isolated from that of other transactions.</li>
<li><strong>Durability</strong>: If a transaction commits, its effects persist.</li>
</ol>
<h2 id="how-to-ensure-atomicity"><a class="markdownIt-Anchor" href="#how-to-ensure-atomicity"></a> How to ensure atomicity?</h2>
<ol>
<li>The first approach is logging (Write Ahead Log / WAL).
<ul>
<li>DBMS logs all actions to undo the actions of aborted transactions.</li>
<li>Maintain undo records both in memory and on disk.</li>
<li>When the DBMS returns from a crash, partial transactions need to be undoed according to the undo records.</li>
</ul>
</li>
<li>Another approach is shadow paging.
<ul>
<li>DBMS makes copies of pages, and transactions make changes to those copies.</li>
<li>Only when the transaction is committed is the page made visible to others by modifying the pointer in the directory.</li>
<li>It does not need extra operations when it comes back from a crash.</li>
</ul>
</li>
</ol>
<h2 id="what-is-consistency"><a class="markdownIt-Anchor" href="#what-is-consistency"></a> What is consistency?</h2>
<ol>
<li>At a high level, consistency means the “world” represented by the database is logically correct. All questions (i.e., queries) the application asks about the data will return logically correct results.</li>
<li>There are two notions of consistency.
<ul>
<li>Database consistency means the database accurately models the real world and follows integrity constraints.
<ul>
<li>Transactions in the future see the effects of transactions committed in the past inside the database.</li>
<li>The DBMS designer should maintain this consistency.</li>
</ul>
</li>
<li>Transaction consistency means that if the database is consistent before the transaction starts, it will also be consistent after.
<ul>
<li>The application programmer is responsible for this consistency. The DBMS does not know the semantics of correctness.</li>
</ul>
</li>
</ul>
</li>
</ol>
<h2 id="isolation"><a class="markdownIt-Anchor" href="#isolation"></a> Isolation</h2>
<h3 id="what-do-we-want-from-isolation"><a class="markdownIt-Anchor" href="#what-do-we-want-from-isolation"></a> What do we want from isolation?</h3>
<ol>
<li>Users submit transactions, and each transaction executes as if it were running by itself, i.e., it is executed in a strawman system where no other transaction is executing simultaneously.</li>
<li>Isolation provides an easier programming model to reason about.</li>
<li>However, the DBMS achieves concurrency by interleaving the actions (reads/writes of DB objects) of transactions. Hence, we need to schedule interleave transactions but still make it appear they ran one at a time.</li>
<li>There is no guarantee that <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">T_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> will execute before <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">T_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> or vice-versa if both are submitted together. The net effect must be equivalent to these two transactions running serially in some order.</li>
</ol>
<h3 id="how-to-decide-whether-a-schedule-matches-isolation"><a class="markdownIt-Anchor" href="#how-to-decide-whether-a-schedule-matches-isolation"></a> How to decide whether a schedule matches isolation?</h3>
<ol>
<li>If the schedule is equivalent to some serial execution, we can consider it correct.</li>
<li>For any database state, if the effect of executing the first schedule is identical to the effect of executing the second schedule, we say these two schedules are equivalent.</li>
<li>A schedule is serializable if it is equivalent to some serial execution of the transactions.
<ul>
<li>If each transaction preserves consistency, every serializable schedule preserves consistency.</li>
</ul>
</li>
<li>There are two levels of serializability: conflict serializability (most commonly used) and view serializability.</li>
</ol>
<h3 id="what-conflicts-do-we-want-to-prevent"><a class="markdownIt-Anchor" href="#what-conflicts-do-we-want-to-prevent"></a> What conflicts do we want to prevent?</h3>
<ol>
<li>Two operations conflict if They are by different transactions and are on the same object while one is a write.</li>
<li>A read-write conflict will cause unrepeatable reading.
<ul>
<li>Transaction gets different values when reading the same object multiple times.</li>
<li>The conflict is between the write from one transaction and a repeated following read from another transaction, i.e., this is actually <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi><mi>e</mi><mi>a</mi><msub><mi>d</mi><mn>1</mn></msub><mo>−</mo><mi>w</mi><mi>r</mi><mi>i</mi><mi>t</mi><mi>e</mi><mo>−</mo><mi>r</mi><mi>e</mi><mi>a</mi><msub><mi>d</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">read_1-write-read_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">e</span><span class="mord mathnormal">a</span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.74285em;vertical-align:-0.08333em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">e</span><span class="mord mathnormal">a</span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> conflict where the conflict is between <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>w</mi><mi>r</mi><mi>i</mi><mi>t</mi><mi>e</mi><mo>−</mo><mi>r</mi><mi>e</mi><mi>a</mi><msub><mi>d</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">write-read_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.74285em;vertical-align:-0.08333em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">e</span><span class="mord mathnormal">a</span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>.</li>
<li>If there is only one read, it is not a read-write conflict. The first read will never be a read-write conflict.</li>
</ul>
</li>
</ol>
<ul>
<li>A write-read conflict will cause a dirty read.
<ul>
<li>One transaction reads data written by another transaction that has not been committed yet.</li>
<li>The problem will happen when the read transaction is committed before the write transaction aborts.</li>
<li>If the write transaction is successfully committed, there is no problem. But we cannot know that when we commit the read transaction first.</li>
</ul>
</li>
<li>A write-write conflict will cause a lost update.
<ul>
<li>One transaction overwrites uncommitted data from another uncommitted transaction.</li>
<li>This may cause the result to become a combination of two partial transactions.</li>
<li>There is no problem when every data written by <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">T_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> is the last write to that data, i.e., every data written by <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">T_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> is not overwritten by <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">T_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>. The problem happens when <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">T_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> overwrites some data of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">T_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> while <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">T_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> overwrites some data of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">T_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>.</li>
</ul>
</li>
</ul>
<h3 id="how-do-we-determine-whether-a-schedule-is-conflict-serializable"><a class="markdownIt-Anchor" href="#how-do-we-determine-whether-a-schedule-is-conflict-serializable"></a> How do we determine whether a schedule is conflict serializable?</h3>
<ol>
<li>When there are only two schedules:
<ul>
<li>Two schedules are conflict equivalent if and only if they involve the same actions of the same transactions and every pair of conflicting actions is ordered the same way.</li>
<li>Schedule S is conflict serializable if S is conflict equivalent to some serial schedule.</li>
<li>We can transform S into a serial schedule by swapping consecutive non-conflicting operations of different transactions.</li>
</ul>
</li>
<li>For more schedules, we can use the dependency graphs.
<ul>
<li>Create one node per transaction in the graph.</li>
<li>Create an edge from <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">T_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> to <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">T_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.969438em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span> if an operation <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>O</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">O_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">T_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> conflicts with an<br />
operation <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>O</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">O_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.969438em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span> of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">T_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.969438em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>O</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">O_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> appears earlier in the schedule than <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>O</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">O_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.969438em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span>.</li>
<li>A schedule is conflict serializable if and only if its dependency graph is acyclic.</li>
</ul>
</li>
</ol>
<h3 id="how-do-we-determine-whether-a-schedule-is-view-serializable"><a class="markdownIt-Anchor" href="#how-do-we-determine-whether-a-schedule-is-view-serializable"></a> How do we determine whether a schedule is view serializable?</h3>
<ol>
<li>Schedules <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>S</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">S_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>S</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">S_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> are view equivalent if:
<ul>
<li>If <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">T_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> reads the initial value of A in <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>S</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">S_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>, then <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">T_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> also reads the initial value of A in <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>S</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">S_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>.</li>
<li>If <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">T_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> reads the value of A written by <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">T_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> in <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>S</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">S_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>, then <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">T_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> also reads the value of A written by <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">T_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> in <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>S</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">S_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>.</li>
<li>If <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">T_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> writes the final value of A in <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>S</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">S_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>, then <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">T_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> also writes the final value of A in <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>S</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">S_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>.</li>
</ul>
</li>
<li>In a word, each transaction is different schedules that read the same values written by the same transaction, and at the end of all transactions, all data are written by the same transaction in the same value.</li>
<li>View Serializability allows for (slightly) more schedules than Conflict Serializability does. Neither definition allows all serializable schedules.</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://liyun-zhang.github.io/2023/07/15/Courses/15445/08-Query-Planning-Optimization/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LiyunZhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LiyunZhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LiyunZhang">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/07/15/Courses/15445/08-Query-Planning-Optimization/" class="post-title-link" itemprop="url">08 Query Planning & Optimization</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-07-15 19:52:41" itemprop="dateCreated datePublished" datetime="2023-07-15T19:52:41+08:00">2023-07-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-03-16 15:14:47" itemprop="dateModified" datetime="2024-03-16T15:14:47+08:00">2024-03-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Open-Courses/" itemprop="url" rel="index"><span itemprop="name">Open Courses</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Open-Courses/CMU-15-445-645-Database-System/" itemprop="url" rel="index"><span itemprop="name">CMU 15-445/645 Database System</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><ul class="markdownIt-TOC">
<li><a href="#query-planning">Query planning</a>
<ul>
<li><a href="#what-are-the-logical-plans-and-physical-plans">What are the logical plans and physical plans?</a></li>
<li><a href="#what-is-the-process-flow-of-query-execution">What is the process flow of query execution?</a></li>
<li><a href="#how-does-the-optimizer-work">How does the optimizer work?</a></li>
</ul>
</li>
<li><a href="#heuristics-optimization">Heuristics optimization</a>
<ul>
<li><a href="#how-should-we-optimize-logical-plans">How should we optimize logical plans?</a></li>
<li><a href="#how-should-we-optimize-for-nested-sub-queries">How should we optimize for nested sub-queries?</a></li>
<li><a href="#how-can-we-rewrite-expression">How can we rewrite expression?</a></li>
</ul>
</li>
<li><a href="#cost-based-search">Cost-based search</a>
<ul>
<li><a href="#cost-estimation">Cost estimation</a>
<ul>
<li><a href="#what-cost-do-we-care">What cost do we care?</a></li>
<li><a href="#how-does-dbms-estimate-the-costs">How does DBMS estimate the costs?</a></li>
<li><a href="#what-statistics-does-the-dbms-maintain">What statistics does the DBMS maintain?</a></li>
</ul>
</li>
<li><a href="#query-optimization">Query optimization</a>
<ul>
<li><a href="#how-do-we-perform-cost-based-optimization">How do we perform cost-based optimization?</a></li>
<li><a href="#how-does-bottom-up-optimization-work">How does bottom-up optimization work?</a></li>
<li><a href="#how-does-top-down-optimization-work">How does top-down optimization work?</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</p>
<h1 id="query-planning"><a class="markdownIt-Anchor" href="#query-planning"></a> Query planning</h1>
<h2 id="what-are-the-logical-plans-and-physical-plans"><a class="markdownIt-Anchor" href="#what-are-the-logical-plans-and-physical-plans"></a> What are the logical plans and physical plans?</h2>
<ol>
<li>The optimizer maps a logical algebra expression to the optimal equivalent physical algebra expression.</li>
<li>Physical operators define a specific execution strategy using an access path, i.e., a specific algorithm.
<ul>
<li>They depend on the physical format of the data they process, i.e., sorting and compression.</li>
</ul>
</li>
</ol>
<h2 id="what-is-the-process-flow-of-query-execution"><a class="markdownIt-Anchor" href="#what-is-the-process-flow-of-query-execution"></a> What is the process flow of query execution?</h2>
<ol>
<li>The application is connected to the database system and sends a SQL query, which may be rewritten to a different format in SQL rewriter.</li>
<li>The SQL string is parsed into tokens that make up the syntax tree.</li>
<li>The binder converts named objects in the syntax tree to internal identifiers by consulting the system catalog.</li>
<li>The binder emits a logical plan, which may be fed to a tree rewriter for additional schema info.</li>
<li>The logical plan is given to the optimizer, which will select the most efficient procedure to execute the plan.</li>
</ol>
<img src="/imgs/15445/Optimizer/architecture.png" width="50%">
<h2 id="how-does-the-optimizer-work"><a class="markdownIt-Anchor" href="#how-does-the-optimizer-work"></a> How does the optimizer work?</h2>
<ol>
<li>One way is heuristics/rules.
<ul>
<li>Rewrite the query to remove stupid/inefficient things.</li>
<li>These techniques may need to examine the catalog, but they do not need to examine data.</li>
</ul>
</li>
<li>Another way is the cost-based search.
<ul>
<li>We need a model to estimate the cost of executing a plan.</li>
<li>Enumerate multiple equivalent plans for a query and pick the one with the lowest cost.</li>
</ul>
</li>
</ol>
<h1 id="heuristics-optimization"><a class="markdownIt-Anchor" href="#heuristics-optimization"></a> Heuristics optimization</h1>
<h2 id="how-should-we-optimize-logical-plans"><a class="markdownIt-Anchor" href="#how-should-we-optimize-logical-plans"></a> How should we optimize logical plans?</h2>
<ol>
<li>Split conjunctive predicates.
<ul>
<li>Decompose predicates into their simplest forms to make it easier for the optimizer to move them around.</li>
</ul>
</li>
<li>Predicate pushdown
<ul>
<li>Move the predicate to the lowest applicable point in the plan.</li>
</ul>
</li>
<li>Replace cartesian products with joins.
<ul>
<li>Replace all Cartesian Products with inner joins using the join predicates.</li>
</ul>
</li>
<li>Projection pushdown
<ul>
<li>This eliminates redundant attributes before pipeline breakers to reduce materialization costs and the data passed around.</li>
</ul>
</li>
</ol>
<h2 id="how-should-we-optimize-for-nested-sub-queries"><a class="markdownIt-Anchor" href="#how-should-we-optimize-for-nested-sub-queries"></a> How should we optimize for nested sub-queries?</h2>
<ol>
<li>Rewrite to de-correlate and flatten them.
<ul>
<li>For example, an <code>EXISTS</code> sub-query in the <code>WHERE</code> clause may be rewritten as an inner-join.</li>
</ul>
</li>
<li>Decompose nested queries and store results in a temporary table.
<ul>
<li>For those sub-queries uncorrelated with an outer query, the optimizer breaks up queries into blocks and then concentrates on one block at a time.</li>
<li>Sub-queries are written to a temporary table and discarded after the query finishes.</li>
</ul>
</li>
</ol>
<h2 id="how-can-we-rewrite-expression"><a class="markdownIt-Anchor" href="#how-can-we-rewrite-expression"></a> How can we rewrite expression?</h2>
<ol>
<li>This is implemented using if/then/else clauses or a pattern-matching rule engine.
<ul>
<li>Search for expressions that match a pattern. When a match is found, rewrite the expression. Halt if there are no more rules that match.</li>
</ul>
</li>
<li>One approach is replacing impossible or unnecessary predicates with false ones.</li>
<li>Another approach is merging predicates, e.g., numeric ranging predicates.</li>
</ol>
<h1 id="cost-based-search"><a class="markdownIt-Anchor" href="#cost-based-search"></a> Cost-based search</h1>
<h2 id="cost-estimation"><a class="markdownIt-Anchor" href="#cost-estimation"></a> Cost estimation</h2>
<h3 id="what-cost-do-we-care"><a class="markdownIt-Anchor" href="#what-cost-do-we-care"></a> What cost do we care?</h3>
<ol>
<li>Physical Costs
<ul>
<li>Predict CPU cycles, I/O, cache misses, RAM consumption, and network messages.</li>
<li>This cost depends heavily on hardware.</li>
</ul>
</li>
<li>Logical Costs
<ul>
<li>Estimate output size per operator.</li>
<li>This cost is independent of the operator algorithm since algorithms are physical.</li>
<li>It needs estimations for operator result sizes.</li>
</ul>
</li>
<li>Algorithmic Costs
<ul>
<li>Mainly the complexity of the operator algorithm implementation.</li>
</ul>
</li>
<li>We may use a combination of multiple costs that are weighted by magic constant factors.
<ul>
<li>Some assumptions are that processing a tuple in memory is <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>400</mn><mo>×</mo></mrow><annotation encoding="application/x-tex">400\times</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">4</span><span class="mord">0</span><span class="mord">0</span><span class="mord">×</span></span></span></span> faster than reading a tuple from a disk, and sequential I/O is <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>4</mn><mo>×</mo></mrow><annotation encoding="application/x-tex">4\times</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">4</span><span class="mord">×</span></span></span></span> faster than random I/O.</li>
<li>The most commonly used cost is the combination of physical costs and logical costs.</li>
</ul>
</li>
</ol>
<h3 id="how-does-dbms-estimate-the-costs"><a class="markdownIt-Anchor" href="#how-does-dbms-estimate-the-costs"></a> How does DBMS estimate the costs?</h3>
<ol>
<li>The DBMS stores internal statistics about tables, attributes, and indexes in its internal catalog.
<ul>
<li>Different systems update them at different times.</li>
</ul>
</li>
<li>Then, DBMS derives a predicate’s selection cardinality (selectivity), the fraction of tuples that qualify.</li>
<li>We can make some assumptions to estimate selectivity.
<ul>
<li>Uniform data: The distribution of values (except for the heavy hitters) is the same. May maintain a heavy hitter list that stores the most common values and assume that the occurrence of the rest of the data is the same.</li>
<li>Independent predicates: The predicates on attributes are independent, i.e., the conjunction of predicates can result in the multiplication or addition of probabilities.</li>
<li>Inclusion principle: The domain of join keys overlaps such that each key in the inner relation will also exist in the outer table.</li>
<li>These assumptions may not be true.</li>
</ul>
</li>
</ol>
<h3 id="what-statistics-does-the-dbms-maintain"><a class="markdownIt-Anchor" href="#what-statistics-does-the-dbms-maintain"></a> What statistics does the DBMS maintain?</h3>
<ol>
<li>Histograms:
<ul>
<li>The naive and most accurate way is to maintain an occurrence count per value in a column.</li>
<li>Equi-width histograms maintain counts for a group of values. All buckets have the same width, i.e., the same number of values.</li>
<li>Equi-depth histograms vary the width of buckets so that the total number of occurrences for each bucket is roughly the same.</li>
<li>Equi-width or equi-depth histograms use the total count of a bucket divided by the number of values in that bucket as the count of each value.</li>
</ul>
</li>
<li>Sketches:
<ul>
<li>Probabilistic data structure that gives an approximate count for a given value.</li>
<li>The cost-model can replace histograms with sketches to improve its selectivity estimate accuracy.</li>
</ul>
</li>
<li>Sampling:
<ul>
<li>DBMS maintains a small subset of each table that it then uses to evaluate expressions to compute selectivity.</li>
<li>The selectivity is estimated by running the same query on the sample table.</li>
<li>The sample table is updated when the underlying tables change significantly.</li>
</ul>
</li>
</ol>
<h2 id="query-optimization"><a class="markdownIt-Anchor" href="#query-optimization"></a> Query optimization</h2>
<h3 id="how-do-we-perform-cost-based-optimization"><a class="markdownIt-Anchor" href="#how-do-we-perform-cost-based-optimization"></a> How do we perform cost-based optimization?</h3>
<ol>
<li>After performing rule-based rewriting, the DBMS will enumerate different plans for the query and estimate their costs.
<ul>
<li>After exhausting all plans or some timeout, it chooses the best plan it has seen for the query.</li>
<li>The time spent on the search should be significantly smaller than the time spent executing the query. DBMS can set a time threshold to end the search.</li>
</ul>
</li>
<li>DBMS mainly enumerates the access methods (sequential scan, binary search / clustered indexes, index scan) and evaluation order.</li>
<li>Query planning for OLTP queries is easy because they are <strong>sargable</strong> (Search Argument Able).
<ul>
<li>It is usually just picking the best index.</li>
<li>Joins are almost always on foreign key relationships with a small cardinality.</li>
</ul>
</li>
<li>There are two choices for multi-relation query planning.
<ul>
<li>Bottom-up optimization: Start with nothing and then build up the plan to get to the desired outcome.</li>
<li>Top-down optimization: Start with the outcome you want, then work down the tree to find the optimal plan that gets you to that goal.</li>
</ul>
</li>
</ol>
<h3 id="how-does-bottom-up-optimization-work"><a class="markdownIt-Anchor" href="#how-does-bottom-up-optimization-work"></a> How does bottom-up optimization work?</h3>
<ol>
<li>Break the query into blocks and generate the logical operators for each block. For each logical operator, generate a set of physical operators that implement it.</li>
<li>Relations or temporary relations can layer the whole diagram, i.e., results of logical operators.</li>
<li>We can visualize the whole optimization diagram as a tree with different layers.
<ul>
<li>The top layer is the query output, and the bottom contains all the relations.</li>
<li>The middle layers are the enumerations of different ordering. Each layer only performs one more operator than its last layer.</li>
<li>Hence, each pair of layers is connected to an undetermined physical operator.</li>
</ul>
</li>
<li>From the bottom layer up, we enumerate the possible physical algorithm of each logical operator.
<ul>
<li>Then, estimate the cost of all possible physical algorithms.</li>
<li>Leave only the more efficient physical algorithm for each logical operator after comparing with only the possible physical algorithms of the same logical operator.</li>
</ul>
</li>
<li>When it reaches the top layer, we can determine the most efficient path of all possible paths.</li>
<li>Then, iteratively construct a “left-deep” join tree that minimizes the estimated amount of work to execute the plan.
<ul>
<li>Generate a left-deep tree to take advantage of the pipeline.</li>
</ul>
</li>
</ol>
<h3 id="how-does-top-down-optimization-work"><a class="markdownIt-Anchor" href="#how-does-top-down-optimization-work"></a> How does top-down optimization work?</h3>
<ol>
<li>Start with a logical plan of what we want the query to be.</li>
<li>Perform a branch-and-bound search to traverse the plan tree by converting logical operators into physical operators.
<ul>
<li>Traversing from logical operator to logical operator enumerates different orderings.</li>
<li>Traversing from logical operators to physical operators enumerates different physical algorithms.</li>
<li>The layers are similar to bottom-up optimization.</li>
<li>When we meet a logical operator, we must estimate the cost of all possible physical algorithms.
<ul>
<li>So, for each physical algorithm, we must go deeper until the bottom to calculate the estimation.</li>
<li>For the sub-logical operators in the physical algorithm, we will enumerate its optimal execution in the lower levels.</li>
</ul>
</li>
<li>During the search, we can cut off a branch if its cost is already more expensive than another branch we have already seen.</li>
</ul>
</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://liyun-zhang.github.io/2023/07/12/Courses/15445/07-Query-Execution/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LiyunZhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LiyunZhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LiyunZhang">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/07/12/Courses/15445/07-Query-Execution/" class="post-title-link" itemprop="url">07 Query Execution</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-07-12 16:51:12" itemprop="dateCreated datePublished" datetime="2023-07-12T16:51:12+08:00">2023-07-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-03-16 15:06:34" itemprop="dateModified" datetime="2024-03-16T15:06:34+08:00">2024-03-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Open-Courses/" itemprop="url" rel="index"><span itemprop="name">Open Courses</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Open-Courses/CMU-15-445-645-Database-System/" itemprop="url" rel="index"><span itemprop="name">CMU 15-445/645 Database System</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><ul class="markdownIt-TOC">
<li><a href="#sequential-execution">Sequential Execution</a>
<ul>
<li><a href="#processing-model">Processing model</a>
<ul>
<li><a href="#what-does-the-processing-model-do">What does the processing model do?</a></li>
<li><a href="#how-does-the-iterator-model-execute">How does the iterator model execute?</a></li>
<li><a href="#how-does-the-materialization-model-execute">How does the materialization model execute?</a></li>
<li><a href="#how-does-the-vectorization-model-execute">How does the vectorization model execute?</a></li>
</ul>
</li>
<li><a href="#access-methods">Access methods</a>
<ul>
<li><a href="#how-can-we-optimize-sequential-scans-with-data-skipping">How can we optimize sequential scans with data skipping?</a></li>
<li><a href="#what-is-a-multi-index-scan">What is a multi-index scan?</a></li>
</ul>
</li>
<li><a href="#modification-queries">Modification queries</a>
<ul>
<li><a href="#how-should-we-execute-update-and-delete-queries">How should we execute update and delete queries?</a></li>
<li><a href="#how-should-we-execute-insert-queries">How should we execute insert queries?</a></li>
</ul>
</li>
<li><a href="#how-to-evaluate-expressions">How to evaluate expressions?</a></li>
</ul>
</li>
<li><a href="#parallel-execution">Parallel execution</a>
<ul>
<li><a href="#parallel-and-distributed">Parallel and distributed</a>
<ul>
<li><a href="#why-care-about-parallel-execution">Why care about parallel execution?</a></li>
<li><a href="#what-are-the-similarities-and-differences-between-parallel-and-distributed-dbms">What are the similarities and differences between parallel and distributed DBMS?</a></li>
</ul>
</li>
<li><a href="#process-model">Process model</a>
<ul>
<li><a href="#what-does-the-process-model-of-parallel-dbmss-need-to-do">What does the process model of parallel DBMSs need to do?</a></li>
<li><a href="#what-is-the-process-per-worker-model">What is the process per worker model?</a></li>
<li><a href="#what-is-the-thread-per-worker-model">What is the thread per worker model?</a></li>
<li><a href="#what-is-considered-when-dbms-scheduling-threads">What is considered when DBMS scheduling threads?</a></li>
<li><a href="#what-is-the-embedded-dbms-model">What is the embedded DBMS model?</a></li>
</ul>
</li>
<li><a href="#query-level-parallelism">Query-level parallelism</a>
<ul>
<li><a href="#what-are-the-query-level-parallelisms">What are the query-level parallelisms?</a></li>
<li><a href="#how-can-we-achieve-intra-query-parallelism">How can we achieve intra-query parallelism?</a></li>
</ul>
</li>
<li><a href="#io-parallelism">I/O parallelism</a>
<ul>
<li><a href="#what-is-the-problem-of-query-level-parallelism">What is the problem of query-level parallelism?</a></li>
<li><a href="#how-can-we-parallel-ios-with-multi-disk">How can we parallel I/Os with multi-disk?</a></li>
<li><a href="#how-can-we-partition-the-database">How can we partition the database?</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</p>
<h1 id="sequential-execution"><a class="markdownIt-Anchor" href="#sequential-execution"></a> Sequential Execution</h1>
<h2 id="processing-model"><a class="markdownIt-Anchor" href="#processing-model"></a> Processing model</h2>
<h3 id="what-does-the-processing-model-do"><a class="markdownIt-Anchor" href="#what-does-the-processing-model-do"></a> What does the processing model do?</h3>
<ol>
<li>The processing model defines how the system executes a query plan, i.e., how to traverse the query plan tree.</li>
<li>There are two processing directions:
<ul>
<li>Top-to-Bottom: Start with the root and “pull” data from its children. Tuples are always passed with function calls.</li>
<li>Bottom-to-Top: Start with leaf nodes and push data to their parents. Allows for tighter control of caches/registers in pipelines.</li>
</ul>
</li>
<li>There are three commonly used models: the iterator model (volcano/pipeline model), the materialization model, and the vectorized/batch model.</li>
</ol>
<h3 id="how-does-the-iterator-model-execute"><a class="markdownIt-Anchor" href="#how-does-the-iterator-model-execute"></a> How does the iterator model execute?</h3>
<ol>
<li>
<p>In the iterator model, operators are executed top-to-down.</p>
</li>
<li>
<p>Each query plan operator implements a <code>Next()</code> function. On each invocation, the operator returns either a single tuple or a <code>null</code> marker if there are no more tuples.</p>
<ul>
<li>
<p>The operator implements a loop that calls <code>Next()</code> on its children to retrieve their tuples and then process them.</p>
</li>
<li>
<p><code>Next()</code> is first called on the root operator, and the nodes on the tree will call the <code>Next()</code> on their children recursively.</p>
</li>
</ul>
</li>
<li>
<p>This model allows for up pipelining. However, some operators must block until their children emit all their tuples.</p>
<ul>
<li>Joins must wait until all tuples in the leaf child are processed and build the hash table to process tuples from the right child further. Hence, the tuples from the left child must block the pipeline, while those from the right child can enable the pipeline.</li>
<li>Subqueries and ordering (<code>Order By</code>) clauses must also block the pipeline. These are called pipeline breakers.</li>
</ul>
</li>
<li>
<p>Output control works easily with this approach. We only need to add constraints on the root operator.</p>
</li>
</ol>
<h3 id="how-does-the-materialization-model-execute"><a class="markdownIt-Anchor" href="#how-does-the-materialization-model-execute"></a> How does the materialization model execute?</h3>
<ol>
<li>
<p>In the materialization model, operators are called bottom-to-up.</p>
</li>
<li>
<p>Each query plan operator implements an <code>Output()</code> function.</p>
<ul>
<li>
<p>On each invocation, the operator processes its input all at once and then emits its output all at once.</p>
</li>
<li>
<p>The operator materializes its output as a single result.</p>
</li>
<li>
<p>The operators can send either a materialized row or a single column.</p>
</li>
</ul>
</li>
<li>
<p>The DBMS can push down hints (e.g., <code>LIMIT</code>) to avoid scanning too many tuples.</p>
</li>
<li>
<p>The output can be either whole tuples (NSM) or subsets of columns (DSM).</p>
</li>
<li>
<p>This model is better for OLTP workloads because queries only access a small number of tuples at a time, which means lower execution and coordination overhead and fewer function calls.</p>
<ul>
<li>It is not good for OLAP queries with large intermediate results.</li>
</ul>
</li>
</ol>
<h3 id="how-does-the-vectorization-model-execute"><a class="markdownIt-Anchor" href="#how-does-the-vectorization-model-execute"></a> How does the vectorization model execute?</h3>
<ol>
<li>The problem with the iterator model is that it can only process one tuple at a time when we can take multiple tuples and vectorize them to process in parallel (SIMD).</li>
<li>The vectorization model is similar to the iterator model except that each operator emits a batch of tuples instead of a single tuple.</li>
<li>This is ideal for OLAP queries because it greatly reduces the number of invocations per operator.
<ul>
<li>It allows operators to use vectorized (SIMD) instructions more easily to process tuple batches.</li>
</ul>
</li>
</ol>
<h2 id="access-methods"><a class="markdownIt-Anchor" href="#access-methods"></a> Access methods</h2>
<h3 id="how-can-we-optimize-sequential-scans-with-data-skipping"><a class="markdownIt-Anchor" href="#how-can-we-optimize-sequential-scans-with-data-skipping"></a> How can we optimize sequential scans with data skipping?</h3>
<ol>
<li>
<p>The first approach is approximate queries.</p>
<ul>
<li>
<p>This method is lossy and may return incorrect results, but it is OK.</p>
</li>
<li>
<p>Execute queries on a sampled subset of the entire table to produce approximate results.</p>
</li>
</ul>
</li>
<li>
<p>The second approach is zone maps.</p>
<ul>
<li>This method is lossless.</li>
<li>Pre-computed aggregates are used for the attribute values on a page. DBMS checks the zone map first to decide whether it wants to access the page.</li>
<li>The trade-off is between page size and filter efficacy.</li>
</ul>
</li>
</ol>
<h3 id="what-is-a-multi-index-scan"><a class="markdownIt-Anchor" href="#what-is-a-multi-index-scan"></a> What is a multi-index scan?</h3>
<ol>
<li>If there are multiple indexes that the DBMS can use for a query, one method for DBMS to execute is to try to filter tuples with an index with the least number of tuples matches and filter other indexes based on the filtered tuples of previous indexes.
<ul>
<li>This is ideal in the case that some indexes have little tuples that match. Filtering those indexes first can significantly reduce the number of tuples to process in the following indexes.</li>
</ul>
</li>
<li>If all indexes have a lot of matching tuples, we can use another method:
<ul>
<li>Compute sets of Record IDs using each matching index. Combine these sets based on the query’s predicates (union or intersect). Retrieve the records and apply any remaining predicates.</li>
<li>In this way, we can reduce a log of I/O and memory space by only fetching Record IDs in the first phase instead of fetching the entire tuple.</li>
</ul>
</li>
</ol>
<h2 id="modification-queries"><a class="markdownIt-Anchor" href="#modification-queries"></a> Modification queries</h2>
<h3 id="how-should-we-execute-update-and-delete-queries"><a class="markdownIt-Anchor" href="#how-should-we-execute-update-and-delete-queries"></a> How should we execute update and delete queries?</h3>
<ol>
<li>Operators that modify the database (<code>INSERT</code>, <code>UPDATE</code>, <code>DELETE</code>) are responsible for modifying the target table and its indexes.
<ul>
<li>The output of these operators can either be Record IDs or tuple data (i.e., <code>RETURNING</code>).</li>
</ul>
</li>
<li>To update or delete, child operators pass Record IDs to target tuples.
<ul>
<li>The operator should remove the corresponding item from the index.</li>
<li>Then, the operator can modify the tuple or remove the tuple.</li>
<li>The update should re-insert the modified tuple into the index again.</li>
</ul>
</li>
<li>Updates have a possible Halloween problem:
<ul>
<li>When we re-insert the modified tuple, its new place may be ahead of the cursor, i.e., we will pass the new tuple again in the future.
<ul>
<li>For example, when the index is sorted according to an attribute, the modification increases that attribute.</li>
</ul>
</li>
<li>An update operation changes the physical location of a tuple, which causes a scan operator to visit the tuple multiple times. It can occur on clustered tables or index scans.</li>
<li>The solution is to keep track of previously seen tuples (e.g., through Record IDs).</li>
</ul>
</li>
</ol>
<h3 id="how-should-we-execute-insert-queries"><a class="markdownIt-Anchor" href="#how-should-we-execute-insert-queries"></a> How should we execute insert queries?</h3>
<ol>
<li>The first choice is to materialize tuples inside of the operator.
<ul>
<li>The insert operator needs to implement its method of how to materialize tuples.</li>
</ul>
</li>
<li>The second choice is for the operator to insert any tuple passed in from child operators.
<ul>
<li>The insert operator only needs to accept tuples from its children instead of implementing itself.</li>
</ul>
</li>
</ol>
<h2 id="how-to-evaluate-expressions"><a class="markdownIt-Anchor" href="#how-to-evaluate-expressions"></a> How to evaluate expressions?</h2>
<ol>
<li>The DBMS represents a <code>WHERE</code> clause as an expression tree.</li>
<li>The nodes in the tree represent different expression types: Comparisons (<code>=, &lt;, &gt;, !=</code>), conjunction (<code>AND</code>), disjunction (<code>OR</code>), arithmetic operators (<code>+, -, *, /, %</code>), constant values, tuple attribute references.</li>
<li>When evaluating the expression, DFS through the expression tree from the root.
<ul>
<li>The performance is poor because the DBMS traverses the tree, and for each node it visits, it must figure out what the operator needs to do.</li>
</ul>
</li>
<li>A better approach is to evaluate the expression directly.
<ul>
<li>Compile a function of the express (e.g., JIT compilation). In evaluation, DBMS executes the compiled function instead of traversing the tree.</li>
</ul>
</li>
</ol>
<h1 id="parallel-execution"><a class="markdownIt-Anchor" href="#parallel-execution"></a> Parallel execution</h1>
<h2 id="parallel-and-distributed"><a class="markdownIt-Anchor" href="#parallel-and-distributed"></a> Parallel and distributed</h2>
<h3 id="why-care-about-parallel-execution"><a class="markdownIt-Anchor" href="#why-care-about-parallel-execution"></a> Why care about parallel execution?</h3>
<ol>
<li>It increased performance for potentially the same hardware resources, i.e., to gain higher throughput and lower latency.</li>
<li>It increased the responsiveness of the system.</li>
<li>It potentially lowers the total cost of ownership (TCO).
<ul>
<li>Fewer machines means less parts / physical footprint / energy consumption.</li>
</ul>
</li>
</ol>
<h3 id="what-are-the-similarities-and-differences-between-parallel-and-distributed-dbms"><a class="markdownIt-Anchor" href="#what-are-the-similarities-and-differences-between-parallel-and-distributed-dbms"></a> What are the similarities and differences between parallel and distributed DBMS?</h3>
<ol>
<li>Similarities:
<ul>
<li>The database is spread across multiple resources to improve different aspects of the DBMS.</li>
<li>They need to make the database appear as a single logical instance to the application, regardless of physical organization.</li>
<li>SQL query for a single-resource DBMS should generate the same result on a parallel or distributed DBMS.</li>
</ul>
</li>
<li>Differences:
<ul>
<li>For parallel DBMSs, resources are physically close to each other. Hence, resources communicate over high-speed interconnect. And communication is assumed to be cheap and reliable.</li>
<li>For distributed DBMSs, resources can be far from each other. Resources communicate using slow(er) interconnect. Therefore, communication costs and problems cannot be ignored. And communication is considered unreliable.</li>
</ul>
</li>
</ol>
<h2 id="process-model"><a class="markdownIt-Anchor" href="#process-model"></a> Process model</h2>
<h3 id="what-does-the-process-model-of-parallel-dbmss-need-to-do"><a class="markdownIt-Anchor" href="#what-does-the-process-model-of-parallel-dbmss-need-to-do"></a> What does the process model of parallel DBMSs need to do?</h3>
<ol>
<li>It defines how the system is architected to support concurrent requests from a multi-user application.</li>
<li>A worker is the DBMS component responsible for executing tasks on behalf of the client and returning the results.</li>
<li>There are three approaches: process per DBMS worker, thread per DBMS worker, and embedded DBMS.</li>
</ol>
<h3 id="what-is-the-process-per-worker-model"><a class="markdownIt-Anchor" href="#what-is-the-process-per-worker-model"></a> What is the process per worker model?</h3>
<ol>
<li>Each worker is a separate OS process. Hence, this model relies entirely on the OS scheduler.</li>
<li>When an application connects with DBMS, it connects with a dispatcher process. The dispatcher picks the application processes. Then, the application communicates with the process directly.</li>
<li>The processes can use shared-memory for global data structures.</li>
<li>The advantage of this model is that a process crash does not take down the entire system.</li>
</ol>
<h3 id="what-is-the-thread-per-worker-model"><a class="markdownIt-Anchor" href="#what-is-the-thread-per-worker-model"></a> What is the thread per worker model?</h3>
<ol>
<li>The whole DBMS is a single process with multiple worker threads in this model.</li>
<li>DBMS (mostly) manages its scheduling by controlling what each thread is doing.
<ul>
<li>This also means less overhead per context switch and that DBMS does not have to manage shared memory.</li>
</ul>
</li>
<li>There may or may not be a dispatcher thread in the front.
<ul>
<li>Applications may connect to the dispatcher, and the dispatcher immediately forwards the request to another thread while the application does not know about it.</li>
<li>Or applications can use the same scheme as the process per worker model.</li>
</ul>
</li>
<li>In this model, a thread crash may kill the entire system.</li>
</ol>
<h3 id="what-is-considered-when-dbms-scheduling-threads"><a class="markdownIt-Anchor" href="#what-is-considered-when-dbms-scheduling-threads"></a> What is considered when DBMS scheduling threads?</h3>
<p>The DBMS decides where, when, and how to execute each query plan.</p>
<ol>
<li>How many tasks should it use?</li>
<li>How many CPU cores should it use?</li>
<li>What CPU core should the tasks execute on?</li>
<li>Where should a task store its output?</li>
</ol>
<h3 id="what-is-the-embedded-dbms-model"><a class="markdownIt-Anchor" href="#what-is-the-embedded-dbms-model"></a> What is the embedded DBMS model?</h3>
<ol>
<li>In the aforementioned and most common systems, applications are in separate machines. They are connected through TCP or socket. Even if the applications crashed, DBMS remains running.</li>
<li>In embedded DBMS, DBMS runs inside of the same address space as the application. The application is (mostly) responsible for threads and scheduling.</li>
<li>The application may support outside connections.</li>
</ol>
<h2 id="query-level-parallelism"><a class="markdownIt-Anchor" href="#query-level-parallelism"></a> Query-level parallelism</h2>
<h3 id="what-are-the-query-level-parallelisms"><a class="markdownIt-Anchor" href="#what-are-the-query-level-parallelisms"></a> What are the query-level parallelisms?</h3>
<ol>
<li>Inter-Query: Execute multiple disparate queries simultaneously.
<ul>
<li>This parallelism increases throughput and reduces latency. It improves overall performance by allowing multiple queries to execute simultaneously.</li>
<li>If queries are read-only, almost no explicit coordination between queries is required. Buffer pool can handle most of the sharing if necessary.</li>
<li>If multiple queries update the database simultaneously, this is hard to do correctly.</li>
</ul>
</li>
<li>Intra-Query: Execute the operations of a single query in parallel.
<ul>
<li>This parallelism decreases latency for long-running queries, especially for OLAP queries. It improves the performance of a single query by executing its operators in parallel.</li>
<li>Organize operators in terms of a producer/consumer paradigm.</li>
</ul>
</li>
</ol>
<h3 id="how-can-we-achieve-intra-query-parallelism"><a class="markdownIt-Anchor" href="#how-can-we-achieve-intra-query-parallelism"></a> How can we achieve intra-query parallelism?</h3>
<ol>
<li>The first approach is using intra-operator (horizontal) parallelism.
<ul>
<li>Decompose operators into independent fragments that perform the same function on different subsets of data.</li>
<li>Those decomposed operators are copied for each thread in the generated query plan.</li>
<li>The DBMS inserts an exchange operator into the query plan to coalesce/split results from multiple children/parent operators. The exchange operators are similar with barriers stating that data cannot be sent to the parent until all results are received.</li>
<li>There are three kinds of exchange operators:
<ul>
<li>Gather: Combine the results from multiple workers into a single output stream.</li>
<li>Distribute: Split a single input stream into multiple output streams.</li>
<li>Repartition: Shuffle multiple input streams across multiple output streams.</li>
</ul>
</li>
</ul>
</li>
<li>The second approach is using inter-operator (vertical / pipeline) parallelism.
<ul>
<li>Operations are overlapped with pipeline data from one stage to the next without materialization.</li>
<li>Each operator is a worker. Workers execute operators from different segments of a query plan at the same time.</li>
</ul>
</li>
<li>We can also combine these two approaches, which is called bushy parallelism.</li>
</ol>
<h2 id="io-parallelism"><a class="markdownIt-Anchor" href="#io-parallelism"></a> I/O parallelism</h2>
<h3 id="what-is-the-problem-of-query-level-parallelism"><a class="markdownIt-Anchor" href="#what-is-the-problem-of-query-level-parallelism"></a> What is the problem of query-level parallelism?</h3>
<ol>
<li>Using additional processes/threads to execute queries in parallel won’t help if the disk is always the main bottleneck.</li>
<li>It can sometimes worsen the DBMS’s performance if a worker is accessing different segments of the disk simultaneously.</li>
</ol>
<h3 id="how-can-we-parallel-ios-with-multi-disk"><a class="markdownIt-Anchor" href="#how-can-we-parallel-ios-with-multi-disk"></a> How can we parallel I/Os with multi-disk?</h3>
<ol>
<li>
<p>Split the DBMS across multiple storage devices to improve disk bandwidth latency.</p>
<ul>
<li>There are many options
<ul>
<li>Multiple disks per database, one database per disk, one relation per disk, and split relation across multiple disks.</li>
<li>The main trade-off is the number of disks and I/O parallelism.</li>
</ul>
</li>
</ul>
</li>
<li>
<p>Configure OS/hardware to store the DBMS’s files across multiple storage<br />
devices, e.g., storage appliances, RAID configuration.</p>
<ul>
<li>
<p>This is transparent to the DBMS.</p>
</li>
<li>
<p>RAID 0 strips data into different disks. Each disk stores different data.</p>
</li>
<li>
<p>RAID 1 mirrors data in different disks. Each disk stores the same data.</p>
</li>
</ul>
</li>
</ol>
<h3 id="how-can-we-partition-the-database"><a class="markdownIt-Anchor" href="#how-can-we-partition-the-database"></a> How can we partition the database?</h3>
<ol>
<li>Some DBMSs allow you to specify the disk location of each individual database.
<ul>
<li>The buffer pool manager maps a page to a disk location.</li>
<li>This is also easy to do at the filesystem level if the DBMS stores each database in a separate directory.</li>
<li>The DBMS recovery log file might still be shared if transactions can update multiple databases.</li>
</ul>
</li>
<li>Logical splitting splits a single logical table into disjoint physical segments stored/managed separately.
<ul>
<li>Partitioning should (ideally) be transparent to the application.</li>
<li>The application should only access logical tables and not have to worry about how things are physically stored.</li>
</ul>
</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="Previous page" aria-label="Previous page" href="/about/page/3/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/about/">1</a><span class="space">&hellip;</span><a class="page-number" href="/about/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/about/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/about/page/7/">7</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/about/page/5/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">LiyunZhang</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" rel="noopener" target="_blank">NexT.Mist</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>







  




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.7/katex.min.css" integrity="sha256-hLTCMFlKxdNgPXyWlSSxYN0ykJmxxq9Yt3MNfdRGWeA=" crossorigin="anonymous">



</body>
</html>

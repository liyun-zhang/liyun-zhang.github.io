<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"liyun-zhang.github.io","root":"/","images":"/images","scheme":"Mist","darkmode":true,"version":"8.17.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="Paper: In Search of an Understandable Consensus Algorithm  Purpose Model  Basics  How does Raft implements consensus overall? What are the states of each server? How to divide the terms? How does term">
<meta property="og:type" content="article">
<meta property="og:title" content="Raft">
<meta property="og:url" content="http://liyun-zhang.github.io/2023/09/26/Paper/Distributed/Raft/index.html">
<meta property="og:site_name" content="LiyunZhang">
<meta property="og:description" content="Paper: In Search of an Understandable Consensus Algorithm  Purpose Model  Basics  How does Raft implements consensus overall? What are the states of each server? How to divide the terms? How does term">
<meta property="og:locale">
<meta property="og:image" content="http://liyun-zhang.github.io/imgs/Distributed/Raft/01.png">
<meta property="og:image" content="http://liyun-zhang.github.io/imgs/Distributed/Raft/02.png">
<meta property="article:published_time" content="2023-09-26T05:14:13.000Z">
<meta property="article:modified_time" content="2023-10-04T08:29:01.650Z">
<meta property="article:author" content="LiyunZhang">
<meta property="article:tag" content="Distributed System">
<meta property="article:tag" content="Distributed Storage">
<meta property="article:tag" content="Consensus Algorithm">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://liyun-zhang.github.io/imgs/Distributed/Raft/01.png">


<link rel="canonical" href="http://liyun-zhang.github.io/2023/09/26/Paper/Distributed/Raft/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-Hans","comments":true,"permalink":"http://liyun-zhang.github.io/2023/09/26/Paper/Distributed/Raft/","path":"2023/09/26/Paper/Distributed/Raft/","title":"Raft"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Raft | LiyunZhang</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">LiyunZhang</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#purpose"><span class="nav-number">1.</span> <span class="nav-text"> Purpose</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#model"><span class="nav-number">2.</span> <span class="nav-text"> Model</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#basics"><span class="nav-number">2.1.</span> <span class="nav-text"> Basics</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#how-does-raft-implements-consensus-overall"><span class="nav-number">2.1.1.</span> <span class="nav-text"> How does Raft implements consensus overall?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#what-are-the-states-of-each-server"><span class="nav-number">2.1.2.</span> <span class="nav-text"> What are the states of each server?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#how-to-divide-the-terms"><span class="nav-number">2.1.3.</span> <span class="nav-text"> How to divide the terms?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#how-does-terms-change"><span class="nav-number">2.1.4.</span> <span class="nav-text"> How does terms change?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#how-does-raft-handle-follower-and-candidate-crashes"><span class="nav-number">2.1.5.</span> <span class="nav-text"> How does Raft handle follower and candidate crashes?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#states-stored-on-servers"><span class="nav-number">2.1.6.</span> <span class="nav-text"> States stored on servers</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#leader-election"><span class="nav-number">2.2.</span> <span class="nav-text"> Leader election</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#how-does-the-servers-states-transit"><span class="nav-number">2.2.1.</span> <span class="nav-text"> How does the servers states transit?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#how-to-elect-a-leader"><span class="nav-number">2.2.2.</span> <span class="nav-text"> How to elect a leader?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#how-is-the-election-held"><span class="nav-number">2.2.3.</span> <span class="nav-text"> How is the election held?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#how-to-determine-that-a-server-loses-the-election"><span class="nav-number">2.2.4.</span> <span class="nav-text"> How to determine that a server loses the election?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#how-to-handle-a-split-vote"><span class="nav-number">2.2.5.</span> <span class="nav-text"> How to handle a split vote?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#how-to-ensure-that-the-leader-of-any-given-term-contains-all-of-the-entries-committed-in-previous-terms"><span class="nav-number">2.2.6.</span> <span class="nav-text"> How to ensure that the leader of any given term contains all of the entries committed in previous terms?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#what-is-the-limitation-of-broadcast-time-and-election-timeout"><span class="nav-number">2.2.7.</span> <span class="nav-text"> What is the limitation of broadcast time and election timeout?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#requestvote-rpc"><span class="nav-number">2.2.8.</span> <span class="nav-text"> RequestVote RPC</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#log-replication"><span class="nav-number">2.3.</span> <span class="nav-text"> Log replication</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#how-is-clients-request-handled"><span class="nav-number">2.3.1.</span> <span class="nav-text"> How is clients request handled?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#what-is-stored-in-a-log-entry"><span class="nav-number">2.3.2.</span> <span class="nav-text"> What is stored in a log entry?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#how-to-apply-a-log-entry-to-the-state-machines"><span class="nav-number">2.3.3.</span> <span class="nav-text"> How to apply a log entry to the state machines?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#how-to-determine-the-consistency-between-logs"><span class="nav-number">2.3.4.</span> <span class="nav-text"> How to determine the consistency between logs?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#how-to-check-the-consistency-in-appendentries-rpcs"><span class="nav-number">2.3.5.</span> <span class="nav-text"> How to check the consistency in AppendEntries RPCs?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#what-kinds-of-inconsistency-may-incur"><span class="nav-number">2.3.6.</span> <span class="nav-text"> What kinds of inconsistency may incur?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#how-does-leader-handle-follower-inconsistencies"><span class="nav-number">2.3.7.</span> <span class="nav-text"> How does leader handle follower inconsistencies?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#how-does-appendentries-rpc-perform-consistency-check"><span class="nav-number">2.3.8.</span> <span class="nav-text"> How does AppendEntries RPC perform consistency check?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#how-to-handle-uncommited-entries-from-previous-leaders"><span class="nav-number">2.3.9.</span> <span class="nav-text"> How to handle uncommited entries from previous leaders?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#appendentries-rpc"><span class="nav-number">2.3.10.</span> <span class="nav-text"> AppendEntries RPC</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#log-compaction"><span class="nav-number">2.4.</span> <span class="nav-text"> Log compaction</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#how-does-raft-compact-logs"><span class="nav-number">2.4.1.</span> <span class="nav-text"> How does Raft compact logs?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#how-to-handle-the-first-appendentries-following-the-snapshot"><span class="nav-number">2.4.2.</span> <span class="nav-text"> How to handle the first AppendEntries following the snapshot?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#when-will-leader-send-its-snapshot-to-followers"><span class="nav-number">2.4.3.</span> <span class="nav-text"> When will leader send its snapshot to followers?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#how-to-install-the-snapshot-from-leader"><span class="nav-number">2.4.4.</span> <span class="nav-text"> How to install the snapshot from leader?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#when-should-a-server-to-snapshot"><span class="nav-number">2.4.5.</span> <span class="nav-text"> When should a server to snapshot?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#how-to-reduce-the-delays-of-normal-operations-caused-by-a-snapshot"><span class="nav-number">2.4.6.</span> <span class="nav-text"> How to reduce the delays of normal operations caused by a snapshot?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#installsnapshot-rpc"><span class="nav-number">2.4.7.</span> <span class="nav-text"> InstallSnapshot RPC</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#client-interaction"><span class="nav-number">2.5.</span> <span class="nav-text"> Client interaction</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#how-does-client-find-cluster-leader"><span class="nav-number">2.5.1.</span> <span class="nav-text"> How does client find cluster leader?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#how-to-prevent-raft-execute-a-command-multiple-times"><span class="nav-number">2.5.2.</span> <span class="nav-text"> How to prevent Raft execute a command multiple times?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#how-to-prevent-returning-stale-date-to-a-read-only-operation"><span class="nav-number">2.5.3.</span> <span class="nav-text"> How to prevent returning stale date to a read-only operation?</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#experiements-and-results"><span class="nav-number">3.</span> <span class="nav-text"> Experiements and results</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#reproduce-and-unmentioned-parts"><span class="nav-number">4.</span> <span class="nav-text"> Reproduce and unmentioned parts</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">LiyunZhang</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">44</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">30</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">

  
  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://liyun-zhang.github.io/2023/09/26/Paper/Distributed/Raft/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LiyunZhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LiyunZhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Raft | LiyunZhang">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Raft
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-09-26 13:14:13" itemprop="dateCreated datePublished" datetime="2023-09-26T13:14:13+08:00">2023-09-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-10-04 16:29:01" itemprop="dateModified" datetime="2023-10-04T16:29:01+08:00">2023-10-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Paper-Notebook/" itemprop="url" rel="index"><span itemprop="name">Paper Notebook</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Paper-Notebook/Distributed-System/" itemprop="url" rel="index"><span itemprop="name">Distributed System</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p>Paper: <a target="_blank" rel="noopener" href="http://nil.csail.mit.edu/6.824/2020/papers/raft-extended.pdf">In Search of an Understandable Consensus Algorithm</a></p>
<p><ul class="markdownIt-TOC">
<li><a href="#purpose">Purpose</a></li>
<li><a href="#model">Model</a>
<ul>
<li><a href="#basics">Basics</a>
<ul>
<li><a href="#how-does-raft-implements-consensus-overall">How does Raft implements consensus overall?</a></li>
<li><a href="#what-are-the-states-of-each-server">What are the states of each server?</a></li>
<li><a href="#how-to-divide-the-terms">How to divide the terms?</a></li>
<li><a href="#how-does-terms-change">How does terms change?</a></li>
<li><a href="#how-does-raft-handle-follower-and-candidate-crashes">How does Raft handle follower and candidate crashes?</a></li>
<li><a href="#states-stored-on-servers">States stored on servers</a></li>
</ul>
</li>
<li><a href="#leader-election">Leader election</a>
<ul>
<li><a href="#how-does-the-servers-states-transit">How does the servers states transit?</a></li>
<li><a href="#how-to-elect-a-leader">How to elect a leader?</a></li>
<li><a href="#how-is-the-election-held">How is the election held?</a></li>
<li><a href="#how-to-determine-that-a-server-loses-the-election">How to determine that a server loses the election?</a></li>
<li><a href="#how-to-handle-a-split-vote">How to handle a split vote?</a></li>
<li><a href="#how-to-ensure-that-the-leader-of-any-given-term-contains-all-of-the-entries-committed-in-previous-terms">How to ensure that the leader of any given term contains all of the entries committed in previous terms?</a></li>
<li><a href="#what-is-the-limitation-of-broadcast-time-and-election-timeout">What is the limitation of broadcast time and election timeout?</a></li>
<li><a href="#requestvote-rpc">RequestVote RPC</a></li>
</ul>
</li>
<li><a href="#log-replication">Log replication</a>
<ul>
<li><a href="#how-is-clients-request-handled">How is clients request handled?</a></li>
<li><a href="#what-is-stored-in-a-log-entry">What is stored in a log entry?</a></li>
<li><a href="#how-to-apply-a-log-entry-to-the-state-machines">How to apply a log entry to the state machines?</a></li>
<li><a href="#how-to-determine-the-consistency-between-logs">How to determine the consistency between logs?</a></li>
<li><a href="#how-to-check-the-consistency-in-appendentries-rpcs">How to check the consistency in AppendEntries RPCs?</a></li>
<li><a href="#what-kinds-of-inconsistency-may-incur">What kinds of inconsistency may incur?</a></li>
<li><a href="#how-does-leader-handle-follower-inconsistencies">How does leader handle follower inconsistencies?</a></li>
<li><a href="#how-does-appendentries-rpc-perform-consistency-check">How does AppendEntries RPC perform consistency check?</a></li>
<li><a href="#how-to-handle-uncommited-entries-from-previous-leaders">How to handle uncommited entries from previous leaders?</a></li>
<li><a href="#appendentries-rpc">AppendEntries RPC</a></li>
</ul>
</li>
<li><a href="#log-compaction">Log compaction</a>
<ul>
<li><a href="#how-does-raft-compact-logs">How does Raft compact logs?</a></li>
<li><a href="#how-to-handle-the-first-appendentries-following-the-snapshot">How to handle the first AppendEntries following the snapshot?</a></li>
<li><a href="#when-will-leader-send-its-snapshot-to-followers">When will leader send its snapshot to followers?</a></li>
<li><a href="#how-to-install-the-snapshot-from-leader">How to install the snapshot from leader?</a></li>
<li><a href="#when-should-a-server-to-snapshot">When should a server to snapshot?</a></li>
<li><a href="#how-to-reduce-the-delays-of-normal-operations-caused-by-a-snapshot">How to reduce the delays of normal operations caused by a snapshot?</a></li>
<li><a href="#installsnapshot-rpc">InstallSnapshot RPC</a></li>
</ul>
</li>
<li><a href="#client-interaction">Client interaction</a>
<ul>
<li><a href="#how-does-client-find-cluster-leader">How does client find cluster leader?</a></li>
<li><a href="#how-to-prevent-raft-execute-a-command-multiple-times">How to prevent Raft execute a command multiple times?</a></li>
<li><a href="#how-to-prevent-returning-stale-date-to-a-read-only-operation">How to prevent returning stale date to a read-only operation?</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#experiements-and-results">Experiements and results</a></li>
<li><a href="#reproduce-and-unmentioned-parts">Reproduce and unmentioned parts</a></li>
</ul>
</p>
<h1 id="purpose"><a class="markdownIt-Anchor" href="#purpose"></a> Purpose</h1>
<ol>
<li>Enhance the understandability of Paxos
<ul>
<li>Raft separates the key elements of consensus, such as leader election, log replication, and safety</li>
<li>It enforces a stronger degree of coherency to reduce the number of states that must be considered</li>
</ul>
</li>
<li>Novel features: strong leader, leader election, membership changes.</li>
<li><strong>What is the common properties of consensus algorithms?</strong>
<ul>
<li>Safety: never returning an incorrect result under all non-Byzantine conditions, including network delays, partitions, and packet loss, duplication, and reordering.</li>
<li>Available as long as any majority of the servers are operational and can communicate with each other and with clients.</li>
<li>They do not depend on timing to ensure the consistency of the logs: faulty clocks and extreme message delays can, at worst, cause availability problems.</li>
<li>A command can complete as soon as a majority of the cluster has responded to a single round of remote procedure calls; a minority of slow servers need not impact overall system performance.</li>
</ul>
</li>
</ol>
<h1 id="model"><a class="markdownIt-Anchor" href="#model"></a> Model</h1>
<h2 id="basics"><a class="markdownIt-Anchor" href="#basics"></a> Basics</h2>
<h3 id="how-does-raft-implements-consensus-overall"><a class="markdownIt-Anchor" href="#how-does-raft-implements-consensus-overall"></a> How does Raft implements consensus overall?</h3>
<ol>
<li>
<p>First electing a distinguished leader, then giving the leader complete responsibility for managing the replicated log.</p>
</li>
<li>
<p>The leader accepts log entries from clients, replicates them on other servers, and tells servers when it is safe to apply log entries to their state machines.</p>
</li>
<li>
<p>A leader can fail or become disconnected from the other servers, in which case a new leader is elected.</p>
</li>
</ol>
<h3 id="what-are-the-states-of-each-server"><a class="markdownIt-Anchor" href="#what-are-the-states-of-each-server"></a> What are the states of each server?</h3>
<ol>
<li>At any given time each server is in one of three states: leader, follower, or candidate.</li>
<li>In normal operation there is exactly one leader and all of the other servers are followers.</li>
<li>Followers are passive: they issue no requests on their own but simply respond to requests from leaders and candidates.</li>
<li>The leader handles all client requests. If a client contacts a follower, the follower redirects it to the leader.</li>
<li>The candidate is used to elect a new leader.</li>
</ol>
<h3 id="how-to-divide-the-terms"><a class="markdownIt-Anchor" href="#how-to-divide-the-terms"></a> How to divide the terms?</h3>
<ol>
<li>Terms are numbered with consecutive integers. Each election begins a new term.</li>
<li>If an election results in a split vote, the term will end with no leader; a new term with a new election will begin shortly.</li>
<li>Terms act as a logical clock in Raft, and they allow servers to detect obsolete information such as stale leaders.</li>
</ol>
<h3 id="how-does-terms-change"><a class="markdownIt-Anchor" href="#how-does-terms-change"></a> How does terms change?</h3>
<ol>
<li>Each server stores a current term number, which increases monotonically over time.</li>
<li>Current terms are exchanged whenever servers communicate; if one server’s current term is smaller than the other’s, then it updates its current term to the larger value.</li>
<li>If a candidate or leader discovers that its term is out of date, it immediately reverts to follower state.</li>
<li>If a server receives a request with a stale term number, it rejects the request.</li>
</ol>
<h3 id="how-does-raft-handle-follower-and-candidate-crashes"><a class="markdownIt-Anchor" href="#how-does-raft-handle-follower-and-candidate-crashes"></a> How does Raft handle follower and candidate crashes?</h3>
<ol>
<li>
<p>If a follower or candidate crashes, then future RequestVote and AppendEntries RPCs sent to it will fail. Raft handles these failures by retrying indefinitely.</p>
</li>
<li>
<p>If a server crashes after completing an RPC but before responding, then it will receive the same RPC again after it restarts. Raft RPCs are idempotent, i.e. servers will ignore the RPCs that is already handled, so this causes no harm.</p>
</li>
</ol>
<h3 id="states-stored-on-servers"><a class="markdownIt-Anchor" href="#states-stored-on-servers"></a> States stored on servers</h3>
<ol>
<li>
<p>Persistent state on all servers: These states need to be updated on stable storage before responding to RPCs, i.e. communicating with outside.</p>
<ul>
<li><code>currentTerm</code>: latest term server has seen (initialized to 0 on first boot, increases monotonically)</li>
<li><code>votedFor</code>: candidateId that received vote in current term (or <code>null</code> if none)</li>
<li><code>log[]</code>: log entries</li>
</ul>
</li>
<li>
<p>Volatile state on all servers:</p>
<ul>
<li><code>commitIndex</code>: index of highest log entry known to be committed (initialized to 0, increases monotonically)</li>
<li><code>lastApplied</code>: index of highest log entry applied to state machine (initialized to 0, increases monotonically)</li>
</ul>
</li>
<li>
<p>Volatile state on leaders: These states need to be reinitialized after election</p>
<ul>
<li><code>nextIndex[]</code>: for each server, index of the next log entry to send to that server (initialized to leader last log index + 1)</li>
<li><code>matchIndex[]</code>: for each server, index of highest log entry known to be replicated on server (initialized to 0, increases monotonically)</li>
</ul>
</li>
</ol>
<h2 id="leader-election"><a class="markdownIt-Anchor" href="#leader-election"></a> Leader election</h2>
<h3 id="how-does-the-servers-states-transit"><a class="markdownIt-Anchor" href="#how-does-the-servers-states-transit"></a> How does the servers states transit?</h3>
<ol>
<li>
<p>When servers start up, they begin as followers. A server remains in follower state as long as it receives valid RPCs from a leader or candidate.</p>
</li>
<li>
<p>Leaders send periodic heartbeats (AppendEntries RPCs that carry no log entries) to all followers in order to maintain their authority.</p>
</li>
<li>
<p>If a follower receives no communication over a period of time called the election timeout, then it assumes there is no viable leader and become a candidate to initiate a new election.</p>
</li>
<li>
<p>A candidate that receives votes from a majority of the full cluster becomes the new leader.</p>
<p><img src="/imgs/Distributed/Raft/01.png" alt="" /></p>
</li>
</ol>
<h3 id="how-to-elect-a-leader"><a class="markdownIt-Anchor" href="#how-to-elect-a-leader"></a> How to elect a leader?</h3>
<ol>
<li>
<p>To begin an election, a follower increments its current term and transitions to candidate state.</p>
</li>
<li>
<p>It then votes for itself and issues RequestVote RPCs in parallel to each of the other servers in the cluster.</p>
</li>
<li>
<p>Candidate continues in this state until one of three things happens</p>
<ul>
<li>
<p>It wins the election</p>
</li>
<li>
<p>Another server establishes itself as leader</p>
</li>
<li>
<p>A period of time goes by with no winner.</p>
</li>
</ul>
</li>
</ol>
<h3 id="how-is-the-election-held"><a class="markdownIt-Anchor" href="#how-is-the-election-held"></a> How is the election held?</h3>
<ol>
<li>Each server will vote for at most one candidate in a given term, on a first-come-first-served basis to ensure that at most one candidate can win the election for a particular term.</li>
<li>A candidate wins an election if it receives votes from a majority of the servers in the full cluster for the same term.</li>
<li>Once a candidate wins an election, it becomes leader. It then sends heartbeat messages to all of the other servers to establish its authority and prevent new elections.</li>
</ol>
<h3 id="how-to-determine-that-a-server-loses-the-election"><a class="markdownIt-Anchor" href="#how-to-determine-that-a-server-loses-the-election"></a> How to determine that a server loses the election?</h3>
<ol>
<li>A candidate may receive an AppendEntries RPC from another server claiming to be leader.</li>
<li>If the leader’s term is at least as large as the candidate’s current term, then the candidate recognizes the leader as legitimate and returns to follower state.</li>
<li>If the term in the RPC is smaller than the candidate’s current term, then the candidate rejects the RPC and continues in candidate state.</li>
</ol>
<h3 id="how-to-handle-a-split-vote"><a class="markdownIt-Anchor" href="#how-to-handle-a-split-vote"></a> How to handle a split vote?</h3>
<ol>
<li>
<p>If many followers become candidates at the same time, votes could be split so that no candidate obtains a majority.</p>
</li>
<li>
<p>Each candidate will time out and start a new election by incrementing its term and initiating another round of RequestVote RPCs.</p>
</li>
<li>
<p>Raft uses randomized election timeouts to ensure that split votes are rare and that they are resolved quickly.</p>
<ul>
<li>
<p>Election timeouts are chosen randomly from a fixed interval at the start of an election, and it waits for that timeout to elapse before starting the next election.</p>
</li>
<li>
<p>In most cases only a single server will time out; it wins the election and sends heartbeats before any other servers time out.</p>
</li>
</ul>
</li>
</ol>
<h3 id="how-to-ensure-that-the-leader-of-any-given-term-contains-all-of-the-entries-committed-in-previous-terms"><a class="markdownIt-Anchor" href="#how-to-ensure-that-the-leader-of-any-given-term-contains-all-of-the-entries-committed-in-previous-terms"></a> How to ensure that the leader of any given term contains all of the entries committed in previous terms?</h3>
<ol>
<li>
<p>A candidate must contact a majority of the cluster in order to be elected, which means that every committed entry must be present in at least one of those servers.</p>
</li>
<li>
<p>If the candidate’s log is at least as up-to-date as any other log in that majority， then it will hold all the committed entries.</p>
</li>
<li>
<p>In the RequestVote RPC, the voter denies its vote if its own log is more up-to-date than that of the candidate.</p>
</li>
<li>
<p>Raft determines which of two logs is more up-to-date by comparing the index and term of the last entries in the logs.</p>
<ul>
<li>
<p>If the logs have last entries with different terms, then the log with the later term is more up-to-date.</p>
</li>
<li>
<p>If the logs end with the same term, then whichever log is longer is more up-to-date.</p>
</li>
</ul>
</li>
</ol>
<h3 id="what-is-the-limitation-of-broadcast-time-and-election-timeout"><a class="markdownIt-Anchor" href="#what-is-the-limitation-of-broadcast-time-and-election-timeout"></a> What is the limitation of broadcast time and election timeout?</h3>
<ol>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mi>r</mi><mi>o</mi><mi>a</mi><mi>d</mi><mi>c</mi><mi>a</mi><mi>s</mi><mi>t</mi><mi>T</mi><mi>i</mi><mi>m</mi><mi>e</mi><mo>≪</mo><mi>e</mi><mi>l</mi><mi>e</mi><mi>c</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi><mi>T</mi><mi>i</mi><mi>m</mi><mi>e</mi><mi>o</mi><mi>u</mi><mi>t</mi><mo>≪</mo><mi>M</mi><mi>T</mi><mi>B</mi><mi>F</mi></mrow><annotation encoding="application/x-tex">broadcastTime\ll electionTimeout\ll MTBF</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.73354em;vertical-align:-0.0391em;"></span><span class="mord mathnormal">b</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">o</span><span class="mord mathnormal">a</span><span class="mord mathnormal">d</span><span class="mord mathnormal">c</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord mathnormal">i</span><span class="mord mathnormal">m</span><span class="mord mathnormal">e</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≪</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.73354em;vertical-align:-0.0391em;"></span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mord mathnormal">c</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord mathnormal">i</span><span class="mord mathnormal">m</span><span class="mord mathnormal">e</span><span class="mord mathnormal">o</span><span class="mord mathnormal">u</span><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≪</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mord mathnormal" style="margin-right:0.13889em;">F</span></span></span></span></li>
<li>BbroadcastTime is the average time it takes a server to send RPCs in parallel to every server in the cluster and receive their responses. electionTimeout is the election timeout. MTBF is the average time between failures for a single server.</li>
<li>The broadcast time should be an order of magnitude less than the election timeout so that leaders can reliably send the heartbeat messages required to keep followers from starting elections.</li>
<li>The election timeout should be a few orders of magnitude less than MTBF so that the system makes steady progress.</li>
</ol>
<h3 id="requestvote-rpc"><a class="markdownIt-Anchor" href="#requestvote-rpc"></a> RequestVote RPC</h3>
<ol>
<li>This is invoked by candidates to gather votes.</li>
<li>Arguments:
<ul>
<li><code>term</code>: candidate’s term</li>
<li><code>candidateId</code>: candidate requesting vote</li>
<li><code>lastLogIndex</code>: index of candidate’s last log entry</li>
<li><code>lastLogTerm</code>: term of candidate’s last log entry</li>
</ul>
</li>
<li>Results:
<ul>
<li><code>term</code>: currentTerm, for candidate to update itself</li>
<li><code>voteGranted</code>: true means candidate received vote</li>
</ul>
</li>
<li>Receiver implementation:
<ul>
<li>Reply <code>false</code> if <code>term &lt; currentTerm</code></li>
<li>If votedFor is <code>null</code> or <code>candidateId</code>, and candidate’s log is at least as up-to-date as receiver’s log, grant vote</li>
</ul>
</li>
</ol>
<h2 id="log-replication"><a class="markdownIt-Anchor" href="#log-replication"></a> Log replication</h2>
<h3 id="how-is-clients-request-handled"><a class="markdownIt-Anchor" href="#how-is-clients-request-handled"></a> How is clients request handled?</h3>
<ol>
<li>Each client request contains a command to be executed by the replicated state machines.</li>
<li>The leader appends the command to its log as a new entry, then issues AppendEntries RPCs in parallel to each of the other servers to replicate the entry.</li>
<li>When the entry has been safely replicated, the leader applies the entry to its state machine and returns the result of that execution to the client.</li>
<li>If followers crash or run slowly, or if network packets are lost, the leader retries AppendEntries RPCs indefinitely (even after it has responded to the client) until all followers eventually store all log entries.</li>
</ol>
<h3 id="what-is-stored-in-a-log-entry"><a class="markdownIt-Anchor" href="#what-is-stored-in-a-log-entry"></a> What is stored in a log entry?</h3>
<ol>
<li>A command for state machine</li>
<li>A term number when entry was received by leader.</li>
<li>An index to identify its position in the log. The index of the first log is 1.</li>
</ol>
<h3 id="how-to-apply-a-log-entry-to-the-state-machines"><a class="markdownIt-Anchor" href="#how-to-apply-a-log-entry-to-the-state-machines"></a> How to apply a log entry to the state machines?</h3>
<ol>
<li>
<p>The leader decides when it is safe to apply a log entry to the state machines.</p>
<ul>
<li>
<p>Such an entry is called <code>committed</code>.</p>
</li>
<li>
<p>Raft guarantees that committed entries are durable and will eventually be executed by all of the available state machines.</p>
</li>
</ul>
</li>
<li>
<p>A log entry is committed once the leader that created the entry has replicated it on a majority of the servers.</p>
</li>
<li>
<p>It also commits all preceding entries in the leader’s log, including entries created by previous leaders.</p>
</li>
<li>
<p>The leader keeps track of the highest index it knows to be committed, and it includes that index in future AppendEntries RPCs, including heartbeats, so that the other servers eventually find out that they should commit some new entries.</p>
</li>
<li>
<p>Once a follower learns that a log entry is committed, it applies the entry to its local state machine in log order.</p>
</li>
</ol>
<h3 id="how-to-determine-the-consistency-between-logs"><a class="markdownIt-Anchor" href="#how-to-determine-the-consistency-between-logs"></a> How to determine the consistency between logs?</h3>
<ol>
<li>
<p><strong>Log Matching property</strong>: If two logs contain an entry with the same index and term, then the logs are identical in all entries up through the given index.</p>
</li>
<li>
<p>The Log Matching property is maintained through the following properties:</p>
<ul>
<li>
<p>If two entries in different logs have the same index and term, then they store the same command.</p>
</li>
<li>
<p>If two entries in different logs have the same index and term, then the logs are identical in all preceding entries.</p>
</li>
</ul>
</li>
</ol>
<h3 id="how-to-check-the-consistency-in-appendentries-rpcs"><a class="markdownIt-Anchor" href="#how-to-check-the-consistency-in-appendentries-rpcs"></a> How to check the consistency in AppendEntries RPCs?</h3>
<ol>
<li>When sending an AppendEntries RPC, the leader includes the index and term of the entry in its log that immediately precedes the new entries.</li>
<li>If the follower does not find an entry in its log with the same index and term, then it refuses the new entries.</li>
</ol>
<h3 id="what-kinds-of-inconsistency-may-incur"><a class="markdownIt-Anchor" href="#what-kinds-of-inconsistency-may-incur"></a> What kinds of inconsistency may incur?</h3>
<ol>
<li>Leader crashes can leave the logs inconsistent. The old leader may not have fully replicated all of the entries in its log.</li>
<li>A follower may be missing entries that are present on the leader, it may have extra entries that are not present on the leader, or both.</li>
</ol>
<h3 id="how-does-leader-handle-follower-inconsistencies"><a class="markdownIt-Anchor" href="#how-does-leader-handle-follower-inconsistencies"></a> How does leader handle follower inconsistencies?</h3>
<ol>
<li><strong>Leader Append-Only</strong> property: a leader never overwrites or deletes entries in its log.</li>
<li>The leader handles inconsistencies by forcing the followers’ logs to duplicate its own. Namely, conflicting entries in follower logs will be overwritten with entries from the leader’s log.</li>
<li>The leader must find the latest log entry where the two logs agree, delete any entries in the follower’s log after that point, and send the follower all of the leader’s entries after that point.</li>
<li>All of these actions happen in response to the consistency check performed by AppendEntries RPCs.</li>
<li>A leader does not need to take any special actions to restore log consistency when it comes to power. It just begins normal operation, and the logs automatically converge in response to failures of the AppendEntries consistency check.</li>
</ol>
<h3 id="how-does-appendentries-rpc-perform-consistency-check"><a class="markdownIt-Anchor" href="#how-does-appendentries-rpc-perform-consistency-check"></a> How does AppendEntries RPC perform consistency check?</h3>
<ol>
<li>The leader maintains a nextIndex for each follower. When a leader first comes to power, it initializes all nextIndex values to the index just after the last one in its log, i.e. assuming all followers are as up-to-date as itself.</li>
<li>If a follower’s log is inconsistent with the leader’s, the AppendEntries consistency check will fail in the next AppendEntries RPC.</li>
<li>After a rejection, the leader decrements nextIndex and retries the AppendEntries RPC.</li>
<li>Eventually nextIndex will reach a point where the leader and follower logs match. When this happens, AppendEntries will succeed, which removes any conflicting entries in the follower’s log and appends entries from the leader’s log (if any).</li>
<li>Once AppendEntries succeeds, the follower’s log is consistent with the leader’s, and it will remain that way for the rest of the term.</li>
</ol>
<h3 id="how-to-handle-uncommited-entries-from-previous-leaders"><a class="markdownIt-Anchor" href="#how-to-handle-uncommited-entries-from-previous-leaders"></a> How to handle uncommited entries from previous leaders?</h3>
<ol>
<li>If a leader crashes before committing an entry, future leaders will attempt to finish replicating the entry.</li>
<li>A leader cannot immediately conclude that an entry from a previous term <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mi>e</mi><mi>r</mi><msub><mi>m</mi><mi>p</mi></msub></mrow><annotation encoding="application/x-tex">term_p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9011879999999999em;vertical-align:-0.286108em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span> is committed once it is stored on a majority of servers.
<ul>
<li>There could have other entries in a <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mi>e</mi><mi>r</mi><msub><mi>m</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">term_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76508em;vertical-align:-0.15em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> between <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mi>e</mi><mi>r</mi><msub><mi>m</mi><mi>p</mi></msub></mrow><annotation encoding="application/x-tex">term_p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9011879999999999em;vertical-align:-0.286108em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span> and the leader’s current term <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mi>e</mi><mi>r</mi><msub><mi>m</mi><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">term_c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76508em;vertical-align:-0.15em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>.</li>
<li>If nothing in the leaders current term has reached agreement, after the leader dies, that server with <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mi>e</mi><mi>r</mi><msub><mi>m</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">term_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76508em;vertical-align:-0.15em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> may become the new leader, and it can overwrite entries of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mi>e</mi><mi>r</mi><msub><mi>m</mi><mi>p</mi></msub></mrow><annotation encoding="application/x-tex">term_p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9011879999999999em;vertical-align:-0.286108em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span> although those entries are committed since <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mi>e</mi><mi>r</mi><msub><mi>m</mi><mi>i</mi></msub><mo>&gt;</mo><mi>t</mi><mi>e</mi><mi>r</mi><msub><mi>m</mi><mi>p</mi></msub></mrow><annotation encoding="application/x-tex">term_i&gt;term_p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76508em;vertical-align:-0.15em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.9011879999999999em;vertical-align:-0.286108em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span></li>
</ul>
</li>
<li>Raft never commits log entries from previous terms by counting replicas.</li>
<li>Only log entries from the leader’s current term are committed by counting replicas; once an entry from the current term has been committed in this way, then all prior entries are committed indirectly because of the Log Matching Property.</li>
</ol>
<h3 id="appendentries-rpc"><a class="markdownIt-Anchor" href="#appendentries-rpc"></a> AppendEntries RPC</h3>
<ol>
<li>This is invoked by leader to replicate log entries; also used as heartbeat.</li>
<li>Arguments:
<ul>
<li><code>term</code>: leader’s term</li>
<li><code>leaderId</code>: so follower can redirect clients</li>
<li><code>prevLogIndex</code>: index of log entry immediately preceding new ones.</li>
<li><code>prevLogTerm</code>: term of <code>prevLogIndex</code> entry</li>
<li><code>entries[]</code>: log entries to store (empty for hearbeat; may send more than one for efficiency)</li>
<li><code>leaderCommit</code>: leader’s <code>commitIndex</code></li>
</ul>
</li>
<li>Results:
<ul>
<li><code>term</code>: <code>currentTerm</code>, for leader to update itself</li>
<li><code>success</code>: true if follower contrained entry matching <code>prevLogIndex</code> and <code>prevLogTerm</code></li>
</ul>
</li>
<li>Receiver implementation:
<ul>
<li>Reply <code>false</code> if <code>term &lt; currentTerm</code></li>
<li>Reply <code>false</code> if log doesn’t contrain an entry at <code>prevLogIndex</code> whose term matches <code>prevLogTerm</code></li>
<li>If an existing entry conflicts with a new one (same index but different terms), delete the existing entry and all that follow it.</li>
<li>Append any new entries not already in the log.</li>
<li>If <code>leaderCommit &gt; commitIndex</code>, set <code>commitIndex = min(leaderCommit, index of last new entry)</code>.</li>
</ul>
</li>
</ol>
<h2 id="log-compaction"><a class="markdownIt-Anchor" href="#log-compaction"></a> Log compaction</h2>
<h3 id="how-does-raft-compact-logs"><a class="markdownIt-Anchor" href="#how-does-raft-compact-logs"></a> How does Raft compact logs?</h3>
<ol>
<li>In snapshotting, the entire current system state is written to a snapshot on stable storage.</li>
<li>Once a server completes writing a snapshot, it may delete all log entries up through the last included index, as well as any prior snapshot.</li>
<li>Each server takes snapshots independently, covering just the committed entries in its log.</li>
<li>Data still only flows from leaders to followers, just followers can now reorganize their data.</li>
</ol>
<h3 id="how-to-handle-the-first-appendentries-following-the-snapshot"><a class="markdownIt-Anchor" href="#how-to-handle-the-first-appendentries-following-the-snapshot"></a> How to handle the first AppendEntries following the snapshot?</h3>
<ol>
<li>Raft also includes a small amount of metadata in the snapshot.</li>
<li>The <code>last included index</code> is the index of the last entry in the log that the snapshot replaces (the last entry the state machine had applied).</li>
<li>The <code>last included term</code> is the term of this entry.</li>
</ol>
<h3 id="when-will-leader-send-its-snapshot-to-followers"><a class="markdownIt-Anchor" href="#when-will-leader-send-its-snapshot-to-followers"></a> When will leader send its snapshot to followers?</h3>
<ol>
<li>When the leader has already discarded the next log entry that it needs to send to a follower.</li>
<li>This situation is unlikely in normal operation: a follower that has kept up with the leader would already have this entry.</li>
<li>However, an exceptionally slow follower or a new server joining the cluster would not.</li>
</ol>
<h3 id="how-to-install-the-snapshot-from-leader"><a class="markdownIt-Anchor" href="#how-to-install-the-snapshot-from-leader"></a> How to install the snapshot from leader?</h3>
<ol>
<li>
<p>The leader uses a new RPC called InstallSnapshot to send snapshots to followers that are too far behind.</p>
</li>
<li>
<p>When a follower receives a snapshot with this RPC, it must decide what to do with its existing log entries.</p>
</li>
<li>
<p>If the snapshot contains new information not already in the recipient’s log</p>
<ul>
<li>
<p>The follower discards its entire log</p>
</li>
<li>
<p>It is all superseded by the snapshot and may possibly have uncommitted entries that conflict with the snapshot.</p>
</li>
</ul>
</li>
<li>
<p>If instead the follower receives a snapshot that describes a prefix of its log</p>
<ul>
<li>
<p>This could be due to retransmission or by mistake.</p>
</li>
<li>
<p>Log entries covered by the snapshot are deleted but entries following the snapshot are still valid and must be retained.</p>
</li>
</ul>
</li>
</ol>
<h3 id="when-should-a-server-to-snapshot"><a class="markdownIt-Anchor" href="#when-should-a-server-to-snapshot"></a> When should a server to snapshot?</h3>
<ol>
<li>If a server snapshots too often, it wastes disk bandwidth and energy; if it snapshots too infrequently, it risks exhausting its storage capacity, and it increases the time required to replay the log during restarts.</li>
<li>One simple strategy is to take a snapshot when the log reaches a fixed size in bytes.</li>
<li>If this size is set to be significantly larger than the expected size of a snapshot, then the disk bandwidth overhead for snapshotting will be small.</li>
</ol>
<h3 id="how-to-reduce-the-delays-of-normal-operations-caused-by-a-snapshot"><a class="markdownIt-Anchor" href="#how-to-reduce-the-delays-of-normal-operations-caused-by-a-snapshot"></a> How to reduce the delays of normal operations caused by a snapshot?</h3>
<ol>
<li>The solution is to use copy-on-write techniques so that new updates can be accepted without impacting the snapshot being written.</li>
<li>The operating system’s copy-on-write support (e.g., fork on Linux) can be used to create an in-memory snapshot of the entire state machine.</li>
</ol>
<h3 id="installsnapshot-rpc"><a class="markdownIt-Anchor" href="#installsnapshot-rpc"></a> InstallSnapshot RPC</h3>
<ol>
<li>This is invoked by leader to send chunks of snapshot to a follower. Leaders always send chunks in order.</li>
<li>Arguments:
<ul>
<li><code>term</code>: leader’s term</li>
<li><code>leaderId</code>: so follower can redirect clients</li>
<li><code>lastIncludedIndex</code>: the snapshot replaces all entries up through and including this index</li>
<li><code>lastIncludedTerm</code>: term of <code>lastIncludedIndex</code></li>
<li><code>offset</code>: byte offset where chunk is positioned in the snapshot file
<ul>
<li>The whole snapshot file may be large, and hence divided into several chunks.</li>
</ul>
</li>
<li><code>data[]</code>: raw bytes of the snapshot chunk, starting at offset</li>
<li><code>done</code>: <code>true</code> if this is the last chunk</li>
</ul>
</li>
<li>Results:
<ul>
<li><code>term</code>: <code>currentTerm</code>, for leader to update itself</li>
</ul>
</li>
<li>Receiver implementation:
<ul>
<li>Reply immediately if <code>term &lt; currentTerm</code></li>
<li>Create new snapshot file if first chunk (offset is 0)</li>
<li>Write data into snapshot file at given offset</li>
<li>Reply and wait for more data chunks if done is <code>false</code>.</li>
<li>Save snapshot file, discard any existing or partial snapshot with smaller index</li>
<li>If existing log entry has same index and term as snapshot’s last included entry, retain log entries following it and reply</li>
<li>Discard the entire log</li>
<li>Reset state machine using snapshot contents (and load snapshot’s cluster configuration)</li>
</ul>
</li>
</ol>
<h2 id="client-interaction"><a class="markdownIt-Anchor" href="#client-interaction"></a> Client interaction</h2>
<h3 id="how-does-client-find-cluster-leader"><a class="markdownIt-Anchor" href="#how-does-client-find-cluster-leader"></a> How does client find cluster leader?</h3>
<ol>
<li>
<p>When a client first starts up</p>
<ul>
<li>
<p>It connects to a randomlychosen server.</p>
</li>
<li>
<p>If the client’s first choice is not the leader, that server will reject the client’s request and supply information about the most recent leader it has heard from.</p>
</li>
</ul>
</li>
<li>
<p>If the leader crashes</p>
<ul>
<li>
<p>Client requests will time out.</p>
</li>
<li>
<p>Clients then try again with randomly-chosen servers.</p>
</li>
</ul>
</li>
</ol>
<h3 id="how-to-prevent-raft-execute-a-command-multiple-times"><a class="markdownIt-Anchor" href="#how-to-prevent-raft-execute-a-command-multiple-times"></a> How to prevent Raft execute a command multiple times?</h3>
<ol>
<li>
<p>Our goal for Raft is to implement linearizable semantics, i.e. each operation appears to execute instantaneously, exactly once, at some point between its invocation and its response.</p>
<ul>
<li>One case of executing a command multiple times is that if the leader crashes after committing the log entry but before responding to the client, the client will retry the command with a new leader, causing it to be executed a second time.</li>
</ul>
</li>
<li>
<p>The solution is for clients to assign unique serial numbers to every command.</p>
</li>
<li>
<p>Then, the state machine tracks the latest serial number processed for each client, along with the associated response.</p>
</li>
<li>
<p>If it receives a command whose serial number has already been executed, it responds immediately without re-executing the request.</p>
</li>
</ol>
<h3 id="how-to-prevent-returning-stale-date-to-a-read-only-operation"><a class="markdownIt-Anchor" href="#how-to-prevent-returning-stale-date-to-a-read-only-operation"></a> How to prevent returning stale date to a read-only operation?</h3>
<ol>
<li>
<p>The reason for stale reading is that the leader responding to the request might have been superseded by a newer leader of which it is unaware.</p>
</li>
<li>
<p>A leader must have the latest information on which entries are committed.</p>
<ul>
<li>
<p>The Leader Completeness Property guarantees that a leader has all committed entries, but at the start of its term, it may not know which those are.</p>
</li>
<li>
<p>To find out, it needs to commit an entry from its term.</p>
</li>
<li>
<p>Raft handles this by having each leader commit a blank <em>no-op</em> entry into the log at the start of its term.</p>
</li>
</ul>
</li>
<li>
<p>A leader must check whether it has been deposed before processing a read-only request, since its information may be stale if a more recent leader has been elected).</p>
<ul>
<li>
<p>Raft handles this by having the leader exchange heartbeat messages with a majority of the cluster before responding to read-only requests.</p>
</li>
<li>
<p>Alternatively, the leader could rely on the heartbeat mechanism to provide a form of lease, but this would rely on timing for safety (it assumes bounded clock skew).</p>
</li>
</ul>
</li>
</ol>
<h1 id="experiements-and-results"><a class="markdownIt-Anchor" href="#experiements-and-results"></a> Experiements and results</h1>
<ol>
<li>The main goal of Raft is to propose a consensus algorithm which is easier to understand than Paxos. Hence the author measured the understandability of this model through scores of learning students.</li>
<li>A most important measure of a new system is its correctness. The author proved the correctness of Raft with a formal specification.</li>
<li>Finally, the author also measured the performance of Raft, which is similar to other consensus algorithms.</li>
<li>The election timeout will effect the performance of the system through the performance of leader election. Hence, the author measured how will the randomization and base election timeout effect the performance.
<ul>
<li>A small amount of randomization in the election timeout is enough to avoid split votes in elections. Using more randomness improves worst-case behavior.</li>
<li>Downtime can be reduced by reducing the election timeout.
<ul>
<li>However, lowering the timeouts beyond 12 - 14 ms violates Raft’s timing requirement: leaders have difficulty broadcasting heartbeats before other servers start new elections. This can cause unnecessary leader changes and lower overall system availability.</li>
<li>The author recommends using a conservative election timeout such as 150–300ms; such timeouts are unlikely to cause unnecessary leader changes and will still provide good availability.</li>
</ul>
</li>
<li>
<img src="/imgs/Distributed/Raft/02.png" style="zoom:33%;" />
</li>
</ul>
</li>
</ol>
<h1 id="reproduce-and-unmentioned-parts"><a class="markdownIt-Anchor" href="#reproduce-and-unmentioned-parts"></a> Reproduce and unmentioned parts</h1>
<p>Reference to the Lab 2, 3 and 4 of MIT 6.824.</p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Distributed-System/" rel="tag"><i class="fa fa-tag"></i> Distributed System</a>
              <a href="/tags/Distributed-Storage/" rel="tag"><i class="fa fa-tag"></i> Distributed Storage</a>
              <a href="/tags/Consensus-Algorithm/" rel="tag"><i class="fa fa-tag"></i> Consensus Algorithm</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2023/09/26/Paper/Distributed/Fault-Tolerance-VM/" rel="prev" title="Fault Tolerance VM">
                  <i class="fa fa-chevron-left"></i> Fault Tolerance VM
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2023/09/26/Paper/Distributed/Zookeeper/" rel="next" title="Zookeeper">
                  Zookeeper <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">LiyunZhang</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" rel="noopener" target="_blank">NexT.Mist</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>







  




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.7/katex.min.css" integrity="sha256-hLTCMFlKxdNgPXyWlSSxYN0ykJmxxq9Yt3MNfdRGWeA=" crossorigin="anonymous">



</body>
</html>

<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"liyun-zhang.github.io","root":"/","images":"/images","scheme":"Mist","darkmode":true,"version":"8.17.0","exturl":false,"sidebar":{"position":"right","display":"hide","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="Paper: Amazon Aurora: Design Considerations for High Throughput Cloud-Native Relational Databases @[toc] Purpose Aurora is a relational database service for OLTP workloads.  Issue:  In modern distribu">
<meta property="og:type" content="article">
<meta property="og:title" content="Aurora">
<meta property="og:url" content="http://liyun-zhang.github.io/2023/09/26/Paper/Distributed/Aurora/index.html">
<meta property="og:site_name" content="LiyunZhang">
<meta property="og:description" content="Paper: Amazon Aurora: Design Considerations for High Throughput Cloud-Native Relational Databases @[toc] Purpose Aurora is a relational database service for OLTP workloads.  Issue:  In modern distribu">
<meta property="og:locale">
<meta property="og:image" content="http://liyun-zhang.github.io/imgs/Distributed/Aurora/MySQL.png">
<meta property="og:image" content="http://liyun-zhang.github.io/imgs/Distributed/Aurora/NetworkIO.png">
<meta property="og:image" content="http://liyun-zhang.github.io/imgs/Distributed/Aurora/StorageNode.png">
<meta property="article:published_time" content="2023-09-26T05:28:51.000Z">
<meta property="article:modified_time" content="2024-03-15T09:08:34.424Z">
<meta property="article:author" content="LiyunZhang">
<meta property="article:tag" content="Distributed System">
<meta property="article:tag" content="Communication">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://liyun-zhang.github.io/imgs/Distributed/Aurora/MySQL.png">


<link rel="canonical" href="http://liyun-zhang.github.io/2023/09/26/Paper/Distributed/Aurora/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-Hans","comments":true,"permalink":"http://liyun-zhang.github.io/2023/09/26/Paper/Distributed/Aurora/","path":"2023/09/26/Paper/Distributed/Aurora/","title":"Aurora"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Aurora | LiyunZhang</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">LiyunZhang</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Purpose"><span class="nav-number">1.</span> <span class="nav-text">Purpose</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Model"><span class="nav-number">2.</span> <span class="nav-text">Model</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Background-conceptions-of-AWS"><span class="nav-number">2.1.</span> <span class="nav-text">Background conceptions of AWS</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Durability-at-scale"><span class="nav-number">2.2.</span> <span class="nav-text">Durability at scale</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#How-does-Aurora-tolerate-failures"><span class="nav-number">2.2.1.</span> <span class="nav-text">How does Aurora tolerate failures?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#How-does-Aurora-shrink-the-window-of-vulnerability"><span class="nav-number">2.2.2.</span> <span class="nav-text">How does Aurora shrink the window of vulnerability?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#What-are-the-problems-of-the-I-O-volume-of-mirrored-MySQL"><span class="nav-number">2.2.3.</span> <span class="nav-text">What are the problems of the I&#x2F;O volume of mirrored MySQL?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#How-does-Aurora-reduce-network-traffic"><span class="nav-number">2.2.4.</span> <span class="nav-text">How does Aurora reduce network traffic?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Logs"><span class="nav-number">2.2.5.</span> <span class="nav-text">Logs</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#How-does-Aurora-decide-what-is-completed-and-what-is-durable"><span class="nav-number">2.2.6.</span> <span class="nav-text">How does Aurora decide what is completed and what is durable?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#How-does-the-database-and-storage-interact"><span class="nav-number">2.2.7.</span> <span class="nav-text">How does the database and storage interact?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#How-does-the-database-write-data"><span class="nav-number">2.2.8.</span> <span class="nav-text">How does the database write data?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#How-does-the-database-commit-transactions"><span class="nav-number">2.2.9.</span> <span class="nav-text">How does the database commit transactions?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Where-does-the-database-read"><span class="nav-number">2.2.10.</span> <span class="nav-text">Where does the database read?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#How-does-the-database-read"><span class="nav-number">2.2.11.</span> <span class="nav-text">How does the database read?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#How-does-the-database-replicate"><span class="nav-number">2.2.12.</span> <span class="nav-text">How does the database replicate?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#How-does-the-database-perform-undo-and-redo"><span class="nav-number">2.2.13.</span> <span class="nav-text">How does the database perform undo and redo?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#How-does-the-database-reestablish-the-runtime-state"><span class="nav-number">2.2.14.</span> <span class="nav-text">How does the database reestablish the runtime state?</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">LiyunZhang</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">62</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">29</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">

  
  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://liyun-zhang.github.io/2023/09/26/Paper/Distributed/Aurora/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LiyunZhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LiyunZhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Aurora | LiyunZhang">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Aurora
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-09-26 13:28:51" itemprop="dateCreated datePublished" datetime="2023-09-26T13:28:51+08:00">2023-09-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-03-15 17:08:34" itemprop="dateModified" datetime="2024-03-15T17:08:34+08:00">2024-03-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Paper-Notebook/" itemprop="url" rel="index"><span itemprop="name">Paper Notebook</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Paper-Notebook/Distributed-System/" itemprop="url" rel="index"><span itemprop="name">Distributed System</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p>Paper: <a target="_blank" rel="noopener" href="http://nil.csail.mit.edu/6.824/2020/papers/aurora.pdf">Amazon Aurora: Design Considerations for High Throughput Cloud-Native Relational Databases</a></p>
<p>@[toc]</p>
<h1 id="Purpose"><a href="#Purpose" class="headerlink" title="Purpose"></a>Purpose</h1><ol>
<li>Aurora is a relational database service for OLTP workloads. </li>
<li>Issue: <ul>
<li>In modern distributed cloud services, resilience and scalability are increasingly achieved by decoupling computing from storage and replicating storage across multiple nodes. </li>
<li>The central constraint in high throughput data processing has moved from computing and storage to the network. </li>
</ul>
</li>
<li>Contribution: <ul>
<li>Build storage as an independent fault-tolerant and self-healing service across multiple datacenters. <ul>
<li>Protect the database from performance variance and transient or permanent failures at either the networking or storage tiers. </li>
</ul>
</li>
<li>Only write redo log records to storage.<ul>
<li>Reduce network IOPS by an order of magnitude. </li>
<li>When the bottleneck is removed, the system’s scalability is greatly improved. And they can aggressively optimize numerous other points of contention. </li>
</ul>
</li>
<li>Move some of the most complex and critical functions (backup and redo recovery) from one-time expensive operations in the database engine to continuous asynchronous operations amortized across a large distributed fleet. <ul>
<li>This yields near-instant crash recovery without checkpointing and inexpensive backups that do not interfere with foreground processing. </li>
</ul>
</li>
<li>Also, it achieves consensus on a durable state across numerous storage nodes using an efficient asynchronous scheme, avoiding expensive and chatty recovery protocols. </li>
</ul>
</li>
</ol>
<h1 id="Model"><a href="#Model" class="headerlink" title="Model"></a>Model</h1><h2 id="Background-conceptions-of-AWS"><a href="#Background-conceptions-of-AWS" class="headerlink" title="Background conceptions of AWS"></a>Background conceptions of AWS</h2><h2 id="Durability-at-scale"><a href="#Durability-at-scale" class="headerlink" title="Durability at scale"></a>Durability at scale</h2><h3 id="How-does-Aurora-tolerate-failures"><a href="#How-does-Aurora-tolerate-failures" class="headerlink" title="How does Aurora tolerate failures?"></a>How does Aurora tolerate failures?</h3><ol>
<li>It uses a quorum-based voting protocol. The ordinary quorum voting protocol is as follows:<ul>
<li>If each of the $V$ copies of a replicated data item are assigned a vote; a read must obtain a quorum of $V_r$ votes, while a writer must obtain a quorum of $V_w$ votes. </li>
<li>Each read must be aware of the most recent write, formulated as $V_r + V_w &gt; V$. </li>
<li>Each write must be aware of the most recent write to avoid conflicting writes, formulated as $V_w &gt; V/2$. </li>
</ul>
</li>
<li>The failure of each Availability Zone (AZ) is independent. <ul>
<li>For a common setting $V=3$, $V_r=2$, $V_w=2$, we can set $3$ replicas in different AZs to be tolerant to large-scale events in addition to the smaller individual failures. </li>
<li>However, the failure of an AZ will break the quorum for any of the replicas that concurrently have failures in another AZ. </li>
<li>While the individual failures of replicas in each of the AZs are uncorrelated, the failure of an AZ is a correlated failure of all disks and nodes in that AZ. </li>
</ul>
</li>
<li>Quorum protocol of Aurora:<ul>
<li>Replicate each data item $6$ ways across $3$ AZs with $2$ copies of each item in each AZ. </li>
<li>Use a quorum model with $6$ votes ($V = 6$), a write quorum of $4/6$ ($V_w = 4$), and a read quorum of $3/6$ ($V_r = 3$). </li>
<li>It can lose a single AZ and one additional node ($AZ+1$) without losing read availability, and lose any two nodes, including a single AZ failure, and maintain write availability. </li>
</ul>
</li>
</ol>
<h3 id="How-does-Aurora-shrink-the-window-of-vulnerability"><a href="#How-does-Aurora-shrink-the-window-of-vulnerability" class="headerlink" title="How does Aurora shrink the window of vulnerability?"></a>How does Aurora shrink the window of vulnerability?</h3><ol>
<li>To provide sufficient durability in this model, one must ensure the probability of a double fault on uncorrelated failures, represented by Mean Time to Failure (MTTF), is sufficiently low over the time it takes to repair one of these failures, Mean Time to Repair (MTTR). </li>
<li>It is difficult, past a point, to reduce the probability of MTTF on independent failures. </li>
<li>Focus on reducing MTTR.<ul>
<li>Partition the database volume into small fixed-size segments, currently $10$GB in size. <ul>
<li>These are each replicated $6$ ways into Protection Groups (PGs) so that each PG consists of six  segments organized across $3$ AZs, with two segments in each AZ. </li>
<li>A storage volume is a concatenated set of PGs, physically implemented using a large fleet of storage nodes that are provisioned as virtual hosts with attached SSDs using Amazon Elastic Compute Cloud (EC2). </li>
<li>The PGs that constitute a volume are allocated as the volume grows. </li>
</ul>
</li>
<li>Segments are now units of independent background noise failure and repair. The system monitors and automatically repairs faults as part of service. </li>
</ul>
</li>
</ol>
<h3 id="What-are-the-problems-of-the-I-O-volume-of-mirrored-MySQL"><a href="#What-are-the-problems-of-the-I-O-volume-of-mirrored-MySQL" class="headerlink" title="What are the problems of the I/O volume of mirrored MySQL?"></a>What are the problems of the I/O volume of mirrored MySQL?</h3><p><img src="/imgs/Distributed/Aurora/MySQL.png" width="50%"></p>
<ol>
<li>The engine needs to write various types of data: <ul>
<li>The redo log, the binary (statement) log that is archived to Amazon Simple Storage Service (S3) to support point-in-time restores</li>
<li>The modified data pages, a second temporary write of the data page (double-write) to prevent torn pages, and finally, the metadata (FRM) files. </li>
</ul>
</li>
<li>Steps 1, 3, and 5 are sequential and synchronous. <ul>
<li>Latency is additive because many writes are sequential. </li>
<li>Even on asynchronous writes, one must wait for the slowest operation, leaving the system at the mercy of outliers. </li>
<li>From a distributed system perspective, this model has a 4/4 write quorum and is vulnerable to failures and outlier performance. </li>
</ul>
</li>
<li>User operations resulting from OLTP applications cause many different types of writes often representing the same information in multiple ways. </li>
</ol>
<h3 id="How-does-Aurora-reduce-network-traffic"><a href="#How-does-Aurora-reduce-network-traffic" class="headerlink" title="How does Aurora reduce network traffic?"></a>How does Aurora reduce network traffic?</h3><ol>
<li><p>The only writes that cross the network are redo log records. The log applicator is pushed to the storage tier, where it can generate database pages in the background or on demand. </p>
</li>
<li><p>Generating each page from the complete chain of its modifications from the beginning of time is prohibitively expensive. </p>
<ul>
<li>Continually materialize database pages in the background to avoid regenerating them from scratch on demand every time. </li>
<li>As far as the engine is concerned, the log is the database, and any pages that the storage system materializes are simply a cache of log applications. </li>
</ul>
</li>
<li><p>The primary only writes log records to the storage service and streams those log records and metadata updates to the replica instances. </p>
<p><img src="/imgs/Distributed/Aurora/NetworkIO.png" width=50%></p>
</li>
<li><p>The storage node involves the following steps: </p>
<ul>
<li>(1) receive the log record and add it to an in-memory queue</li>
<li>(2) persist record on disk and acknowledge</li>
<li>(3) organize records and identify gaps in the log since some batches may be lost</li>
<li>(4) gossip with peers to fill in gaps</li>
<li>(5) coalesce log records into new data pages</li>
<li>(6) periodically stage log and new pages to S3</li>
<li>(7) periodically garbage collect old versions</li>
<li>(8) periodically validate CRC codes on pages</li>
<li>Each step above is asynchronous; only steps (1) and (2) are in the foreground path, potentially impacting latency. </li>
</ul>
<p><img src="/imgs/Distributed/Aurora/StorageNode.png" width="50%"></p>
</li>
</ol>
<h3 id="Logs"><a href="#Logs" class="headerlink" title="Logs"></a>Logs</h3><h3 id="How-does-Aurora-decide-what-is-completed-and-what-is-durable"><a href="#How-does-Aurora-decide-what-is-completed-and-what-is-durable" class="headerlink" title="How does Aurora decide what is completed and what is durable?"></a>How does Aurora decide what is completed and what is durable?</h3><ol>
<li>At a high level, The system maintains points of consistency and durability and continually advances them as it receives acknowledgments for outstanding storage requests. </li>
<li>The logic for tracking and undoing partially completed transactions is kept in the database engine, just as if written on simple disks.<br>Upon restart, before the database can access the storage volume, the storage service makes its recovery, focusing not on user-level transactions but on ensuring that the database sees a uniform view of storage despite its distributed nature. </li>
<li>Completeness: <ul>
<li><em>Log Sequence Number (LSN)</em>: Each log record has an associated LSN, a monotonically increasing value generated by the database. </li>
<li><em>Volume Complete LSN (VCL)</em>: The storage service determines the highest LSN to guarantee the availability of all prior log records. </li>
<li>Every log record with an LSN larger than the VCL during storage recovery must be truncated. </li>
</ul>
</li>
<li>Durability:<ul>
<li><em>Consistency Point LSNs (CPL)</em>: The database can further constrain a subset of points that are allowable for truncation by tagging log records</li>
<li><em>Volume Durable LSN (VDL)</em>: the highest CPL smaller than or equal to VCL and truncate all log records with LSN greater than the VDL.</li>
<li>A CPL delineates some limited storage system transactions that must be accepted in order. </li>
</ul>
</li>
</ol>
<h3 id="How-does-the-database-and-storage-interact"><a href="#How-does-the-database-and-storage-interact" class="headerlink" title="How does the database and storage interact?"></a>How does the database and storage interact?</h3><ol>
<li>Each database-level transaction is broken up into multiple mini-transactions (MTRs) ordered and must be performed atomically. </li>
<li>Each mini-transaction comprises multiple contiguous log records (as many as needed). </li>
<li>The final log record in a mini-transaction is a CPL. </li>
<li>On recovery, the database talks to the storage service to establish the durable point of each PG and uses that to establish the VDL. Then, commands are issued to truncate the log records above VDL.</li>
</ol>
<h3 id="How-does-the-database-write-data"><a href="#How-does-the-database-write-data" class="headerlink" title="How does the database write data?"></a>How does the database write data?</h3><ol>
<li>Database view:<ul>
<li>As the database receives acknowledgments to establish the write quorum for each batch of log records, it advances the current VDL. </li>
<li>The database allocates a unique ordered LSN for each redo log record of each transaction that is no greater than the sum of the current VDL and the LSN Allocation Limit (LAL). </li>
<li>This limit ensures the database does not get too far ahead of the storage system and introduces back pressure that can throttle the incoming writes if the storage or network cannot keep up.</li>
</ul>
</li>
<li>PG view:<ul>
<li>Each segment of each PG only sees a subset of log records in the volume that affects the pages residing on that segment. </li>
<li>Each log record contains a backlink that identifies the previous log record for that PG to track the point of completeness of the log records that have reached each segment. </li>
<li><em>Segment Complete LSN (SCL)</em>: Identifies the greatest LSN below which all log records of the PG have been received and established through backlinks. </li>
<li>The SCL is used by the storage nodes when they gossip with each other to find and exchange log records that they are missing. </li>
</ul>
</li>
</ol>
<h3 id="How-does-the-database-commit-transactions"><a href="#How-does-the-database-commit-transactions" class="headerlink" title="How does the database commit transactions?"></a>How does the database commit transactions?</h3><ol>
<li>When a client commits a transaction, the thread handling the commit request sets the transaction aside by recording its “commit LSN” as part of a separate list of transactions waiting on commit and moves on to perform other work. </li>
<li>Completing a commit only if the latest VDL is greater than or equal to the transaction’s commit LSN. </li>
<li>As the VDL advances, the database identifies qualifying transactions waiting to be committed and uses a dedicated thread to send commit acknowledgments to wait clients.</li>
</ol>
<h3 id="Where-does-the-database-read"><a href="#Where-does-the-database-read" class="headerlink" title="Where does the database read?"></a>Where does the database read?</h3><ol>
<li>Pages are served from the buffer cache, resulting in a storage IO request if the page is not in the cache. </li>
<li>While the Aurora database does not write out pages on cache eviction (or anywhere else), it enforces a similar guarantee: a page in the buffer cache must always be of the latest version. <ul>
<li><em>Page LSN</em>: identify the log record associated with the latest change to the page</li>
<li>Evict a page from the cache only if its page LSN is greater than or equal to the VDL. </li>
<li>Hence, all changes in the page have been hardened in the log, and on a cache miss, it is sufficient to request a version of the page as of the current VDL to get its latest durable version. </li>
</ul>
</li>
</ol>
<h3 id="How-does-the-database-read"><a href="#How-does-the-database-read" class="headerlink" title="How does the database read?"></a>How does the database read?</h3><ol>
<li>When reading a page from a disk, the database establishes a read-point, representing the VDL when the request was issued. </li>
<li>The database can then select a completed storage node with respect to the read point, knowing that it will, therefore, receive an up-to-date version. </li>
<li>Protection Group Min Read Point LSN (PGMRPL): represents that all the log records of the PG below it are unnecessary. <ul>
<li>If there are read replicas, the writer gossips with them to establish the per-PG Minimum Read Point LSN across all nodes. </li>
<li>A storage node segment guarantees that there will be no read page requests with a read point lower than the PGMRPL. </li>
<li>Each storage node is aware of the PGMRPL from the database and can, therefore, advance the materialized pages on disk by coalescing the older log records and then safely garbage collecting them. </li>
</ul>
</li>
</ol>
<h3 id="How-does-the-database-replicate"><a href="#How-does-the-database-replicate" class="headerlink" title="How does the database replicate?"></a>How does the database replicate?</h3><ol>
<li>A single writer and up to 15 read replicas can all mount a shared storage volume. </li>
<li>To minimize lag, the log stream generated by the writer and sent to the storage nodes is also sent to all read replicas. </li>
<li>The database consumes this log stream in the reader by considering each log record in turn. <ul>
<li>If the log record refers to a page in the reader’s buffer cache, it uses the log applicator to apply the specified redo operation to the page in the cache. </li>
<li>Otherwise, it simply discards the log record. </li>
<li>The replicas consume log records asynchronously from the writer’s perspective, which acknowledges user commits independent of the replica. </li>
<li>The only log records that will be applied are those whose LSN is less than or equal to the VDL.<br>The log records that are part of a single mini-transaction are applied atomically in the replica’s cache to ensure that the replica sees a consistent view of all database objects. </li>
</ul>
</li>
</ol>
<h3 id="How-does-the-database-perform-undo-and-redo"><a href="#How-does-the-database-perform-undo-and-redo" class="headerlink" title="How does the database perform undo and redo?"></a>How does the database perform undo and redo?</h3><ol>
<li>The same redo log applicator is used in the forward processing path and on recovery, where it operates synchronously and in the foreground while the database is offline. </li>
<li>The redo log applicator is decoupled from the database and operates on storage nodes, in parallel, and all the time in the background. Once the database starts up, it performs volume recovery in collaboration with the storage service. </li>
<li>Undo recovery can happen when the database is online after the system builds the list of these in-flight transactions from the undo segments. </li>
</ol>
<h3 id="How-does-the-database-reestablish-the-runtime-state"><a href="#How-does-the-database-reestablish-the-runtime-state" class="headerlink" title="How does the database reestablish the runtime state?"></a>How does the database reestablish the runtime state?</h3><ol>
<li>It contacts, for each PG, a read quorum of segments, which is sufficient to guarantee the discovery of any data that could have reached a write quorum. </li>
<li>Once the database has established a read quorum for every PG, it can recalculate the VDL above which data is truncated by generating a truncation range that annuls every log record after the new VDL, up to and including an end LSN, which the database can prove is at least as high as the highest possible outstanding log record that could ever have been seen. </li>
<li>The database infers this upper bound because it allocates LSNs and limits how far allocation can occur above VDL (the 10 million limit described earlier). </li>
<li>The truncation ranges are versioned with epoch numbers and written durably to the storage service so that there is no confusion over the durability of truncations in case recovery is interrupted and restarted.</li>
</ol>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Distributed-System/" rel="tag"><i class="fa fa-tag"></i> Distributed System</a>
              <a href="/tags/Communication/" rel="tag"><i class="fa fa-tag"></i> Communication</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2023/09/26/Paper/Distributed/CRAQ/" rel="prev" title="CRAQ">
                  <i class="fa fa-chevron-left"></i> CRAQ
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2023/09/26/Paper/Distributed/2-Phase-Commit/" rel="next" title="2-Phase Commit">
                  2-Phase Commit <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">LiyunZhang</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" rel="noopener" target="_blank">NexT.Mist</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>







  




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.7/katex.min.css" integrity="sha256-hLTCMFlKxdNgPXyWlSSxYN0ykJmxxq9Yt3MNfdRGWeA=" crossorigin="anonymous">



</body>
</html>

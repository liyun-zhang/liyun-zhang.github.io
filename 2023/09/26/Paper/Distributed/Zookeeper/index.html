<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"liyun-zhang.github.io","root":"/","images":"/images","scheme":"Mist","darkmode":true,"version":"8.17.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="Paper: ZooKeeper: Wait-free coordination for Internet-scale systems  Purpose Model  ZooKeeper service overview  How does client interact with ZooKeeper server? What are the flags of znodes? What are t">
<meta property="og:type" content="article">
<meta property="og:title" content="Zookeeper">
<meta property="og:url" content="http://liyun-zhang.github.io/2023/09/26/Paper/Distributed/Zookeeper/index.html">
<meta property="og:site_name" content="LiyunZhang">
<meta property="og:description" content="Paper: ZooKeeper: Wait-free coordination for Internet-scale systems  Purpose Model  ZooKeeper service overview  How does client interact with ZooKeeper server? What are the flags of znodes? What are t">
<meta property="og:locale">
<meta property="og:image" content="http://liyun-zhang.github.io/imgs/Distributed/ZooKeeper/Throughput.png">
<meta property="og:image" content="http://liyun-zhang.github.io/imgs/Distributed/ZooKeeper/AtomicBroadcast.png">
<meta property="og:image" content="http://liyun-zhang.github.io/imgs/Distributed/ZooKeeper/Failures.png">
<meta property="og:image" content="http://liyun-zhang.github.io/imgs/Distributed/ZooKeeper/Latency.png">
<meta property="og:image" content="http://liyun-zhang.github.io/imgs/Distributed/ZooKeeper/Barrier.png">
<meta property="article:published_time" content="2023-09-26T05:16:26.000Z">
<meta property="article:modified_time" content="2023-10-04T08:29:33.961Z">
<meta property="article:author" content="LiyunZhang">
<meta property="article:tag" content="Distributed System">
<meta property="article:tag" content="Distributed Storage">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://liyun-zhang.github.io/imgs/Distributed/ZooKeeper/Throughput.png">


<link rel="canonical" href="http://liyun-zhang.github.io/2023/09/26/Paper/Distributed/Zookeeper/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-Hans","comments":true,"permalink":"http://liyun-zhang.github.io/2023/09/26/Paper/Distributed/Zookeeper/","path":"2023/09/26/Paper/Distributed/Zookeeper/","title":"Zookeeper"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Zookeeper | LiyunZhang</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">LiyunZhang</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#purpose"><span class="nav-number">1.</span> <span class="nav-text"> Purpose</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#model"><span class="nav-number">2.</span> <span class="nav-text"> Model</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#zookeeper-service-overview"><span class="nav-number">2.1.</span> <span class="nav-text"> ZooKeeper service overview</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#how-does-client-interact-with-zookeeper-server"><span class="nav-number">2.1.1.</span> <span class="nav-text"> How does client interact with ZooKeeper server?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#what-are-the-flags-of-znodes"><span class="nav-number">2.1.2.</span> <span class="nav-text"> What are the flags of znodes?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#what-are-the-differences-between-znodes-and-files-in-file-system"><span class="nav-number">2.1.3.</span> <span class="nav-text"> What are the differences between znodes and files in file system?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#what-does-zookeeper-guarantee"><span class="nav-number">2.1.4.</span> <span class="nav-text"> What does ZooKeeper guarantee?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#how-to-change-configuration"><span class="nav-number">2.1.5.</span> <span class="nav-text"> How to change configuration?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#how-should-a-client-read-configurations"><span class="nav-number">2.1.6.</span> <span class="nav-text"> How should a client read configurations?</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#implement-primitives"><span class="nav-number">2.2.</span> <span class="nav-text"> Implement primitives</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#how-does-zookeeper-manage-configuration"><span class="nav-number">2.2.1.</span> <span class="nav-text"> How does ZooKeeper manage configuration?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#how-does-zookeeper-manage-rendezvous"><span class="nav-number">2.2.2.</span> <span class="nav-text"> How does ZooKeeper manage rendezvous?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#how-does-zookeeper-manage-group-mambership"><span class="nav-number">2.2.3.</span> <span class="nav-text"> How does ZooKeeper manage group mambership?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#how-does-zookeeper-manage-mini-transaction"><span class="nav-number">2.2.4.</span> <span class="nav-text"> How does ZooKeeper manage Mini-transaction?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#how-does-zookeeper-implement-simple-locks"><span class="nav-number">2.2.5.</span> <span class="nav-text"> How does ZooKeeper implement simple locks?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#how-does-zookeeper-implement-simple-locks-without-herd-effect"><span class="nav-number">2.2.6.</span> <span class="nav-text"> How does ZooKeeper implement simple locks without herd effect?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#how-does-zookeeper-implement-readwrite-locks"><span class="nav-number">2.2.7.</span> <span class="nav-text"> How does ZooKeeper implement Read&#x2F;Write locks?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#what-is-the-difference-between-zookeeper-locks-and-thread-mutex-locks"><span class="nav-number">2.2.8.</span> <span class="nav-text"> What is the difference between ZooKeeper locks and thread mutex locks?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#how-does-zookeeper-implementa-double-barrier"><span class="nav-number">2.2.9.</span> <span class="nav-text"> How does ZooKeeper implementa double barrier?</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#implementation-of-zookeeper"><span class="nav-number">2.3.</span> <span class="nav-text"> Implementation of ZooKeeper</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#how-does-zookeeper-serve-requests"><span class="nav-number">2.3.1.</span> <span class="nav-text"> How does ZooKeeper serve requests?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#how-does-zookeeper-manage-database"><span class="nav-number">2.3.2.</span> <span class="nav-text"> How does ZooKeeper manage database?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#how-does-request-processor-handle-write-requests"><span class="nav-number">2.3.3.</span> <span class="nav-text"> How does request processor handle write requests?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#how-does-servers-reach-agreement"><span class="nav-number">2.3.4.</span> <span class="nav-text"> How does servers reach agreement?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#how-does-zookeeper-take-snapshot"><span class="nav-number">2.3.5.</span> <span class="nav-text"> How does ZooKeeper take snapshot?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#how-does-zookeeper-handle-sync"><span class="nav-number">2.3.6.</span> <span class="nav-text"> How does ZooKeeper handle sync()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#how-does-zookeeper-ensure-to-serve-data-at-least-as-update-as-last-server-served-that-data"><span class="nav-number">2.3.7.</span> <span class="nav-text"> How does ZooKeeper ensure to serve data at least as update as last server served that data?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#how-to-detect-client-session-failures"><span class="nav-number">2.3.8.</span> <span class="nav-text"> How to detect client session failures?</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#evaluation-and-results"><span class="nav-number">3.</span> <span class="nav-text"> Evaluation and results</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">LiyunZhang</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">42</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">29</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">

  
  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://liyun-zhang.github.io/2023/09/26/Paper/Distributed/Zookeeper/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LiyunZhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LiyunZhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Zookeeper | LiyunZhang">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Zookeeper
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-09-26 13:16:26" itemprop="dateCreated datePublished" datetime="2023-09-26T13:16:26+08:00">2023-09-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-10-04 16:29:33" itemprop="dateModified" datetime="2023-10-04T16:29:33+08:00">2023-10-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Paper-Notebook/" itemprop="url" rel="index"><span itemprop="name">Paper Notebook</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Paper-Notebook/Distributed-System/" itemprop="url" rel="index"><span itemprop="name">Distributed System</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p>Paper: <a target="_blank" rel="noopener" href="http://nil.csail.mit.edu/6.824/2020/papers/zookeeper.pdf">ZooKeeper: Wait-free coordination for Internet-scale systems</a></p>
<p><ul class="markdownIt-TOC">
<li><a href="#purpose">Purpose</a></li>
<li><a href="#model">Model</a>
<ul>
<li><a href="#zookeeper-service-overview">ZooKeeper service overview</a>
<ul>
<li><a href="#how-does-client-interact-with-zookeeper-server">How does client interact with ZooKeeper server?</a></li>
<li><a href="#what-are-the-flags-of-znodes">What are the flags of znodes?</a></li>
<li><a href="#what-are-the-differences-between-znodes-and-files-in-file-system">What are the differences between znodes and files in file system?</a></li>
<li><a href="#what-does-zookeeper-guarantee">What does ZooKeeper guarantee?</a></li>
<li><a href="#how-to-change-configuration">How to change configuration?</a></li>
<li><a href="#how-should-a-client-read-configurations">How should a client read configurations?</a></li>
</ul>
</li>
<li><a href="#implement-primitives">Implement primitives</a>
<ul>
<li><a href="#how-does-zookeeper-manage-configuration">How does ZooKeeper manage configuration?</a></li>
<li><a href="#how-does-zookeeper-manage-rendezvous">How does ZooKeeper manage rendezvous?</a></li>
<li><a href="#how-does-zookeeper-manage-group-mambership">How does ZooKeeper manage group mambership?</a></li>
<li><a href="#how-does-zookeeper-manage-mini-transaction">How does ZooKeeper manage Mini-transaction?</a></li>
<li><a href="#how-does-zookeeper-implement-simple-locks">How does ZooKeeper implement simple locks?</a></li>
<li><a href="#how-does-zookeeper-implement-simple-locks-without-herd-effect">How does ZooKeeper implement simple locks without herd effect?</a></li>
<li><a href="#how-does-zookeeper-implement-readwrite-locks">How does ZooKeeper implement Read/Write locks?</a></li>
<li><a href="#what-is-the-difference-between-zookeeper-locks-and-thread-mutex-locks">What is the difference between ZooKeeper locks and thread mutex locks?</a></li>
<li><a href="#how-does-zookeeper-implementa-double-barrier">How does ZooKeeper implementa double barrier?</a></li>
</ul>
</li>
<li><a href="#implementation-of-zookeeper">Implementation of ZooKeeper</a>
<ul>
<li><a href="#how-does-zookeeper-serve-requests">How does ZooKeeper serve requests?</a></li>
<li><a href="#how-does-zookeeper-manage-database">How does ZooKeeper manage database?</a></li>
<li><a href="#how-does-request-processor-handle-write-requests">How does request processor handle write requests?</a></li>
<li><a href="#how-does-servers-reach-agreement">How does servers reach agreement?</a></li>
<li><a href="#how-does-zookeeper-take-snapshot">How does ZooKeeper take snapshot?</a></li>
<li><a href="#how-does-zookeeper-handle-sync">How does ZooKeeper handle sync()</a></li>
<li><a href="#how-does-zookeeper-ensure-to-serve-data-at-least-as-update-as-last-server-served-that-data">How does ZooKeeper ensure to serve data at least as update as last server served that data?</a></li>
<li><a href="#how-to-detect-client-session-failures">How to detect client session failures?</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#evaluation-and-results">Evaluation and results</a></li>
</ul>
</p>
<h1 id="purpose"><a class="markdownIt-Anchor" href="#purpose"></a> Purpose</h1>
<ol>
<li>Contribution
<ul>
<li>Moved away from implementing specific primitives on the server side
<ul>
<li>Opted for exposing an API that enables application developers to implement their own primitives.</li>
<li>It enables new primitives without requiring changes to the service core.</li>
</ul>
</li>
<li>Moved away from blocking primitives.
<ul>
<li>Manipulate simple wait-free data objects organized hierarchically as in file systems.</li>
</ul>
</li>
<li>Provide a per client guarantee of FIFO execution of requests and linearizability for all writes.
<ul>
<li>Read requests are satisfied by local servers.</li>
</ul>
</li>
</ul>
</li>
<li>Features
<ul>
<li>Provide a simple and high performance kernel for building more complex coordination primitives at the client.</li>
<li>Incorporates elements from group messaging, shared registers, and distributed lock services in a replicated, centralized service.</li>
<li>It has the wait-free aspects of shared registers with an event-driven mechanism.</li>
<li>Using a simple pipelined architecture that allows us to have hundreds or thousands of requests outstanding while still achieving low latency.</li>
<li>With asynchronous operations, a client is able to have multiple outstanding operations at a time.</li>
<li>Enables caching data on the client side with ZooKeeper watches to avoid the problem of delayed update caused by slow or faulty client.</li>
</ul>
</li>
</ol>
<h1 id="model"><a class="markdownIt-Anchor" href="#model"></a> Model</h1>
<h2 id="zookeeper-service-overview"><a class="markdownIt-Anchor" href="#zookeeper-service-overview"></a> ZooKeeper service overview</h2>
<p>Znode: an in-memory data node in the ZooKeeper data<br />
Data tree: a hierarchical namespace to organize znodes</p>
<h3 id="how-does-client-interact-with-zookeeper-server"><a class="markdownIt-Anchor" href="#how-does-client-interact-with-zookeeper-server"></a> How does client interact with ZooKeeper server?</h3>
<ol>
<li>
<p>Clients submit requests to ZooKeeper through a client API using a ZooKeeper client library.</p>
<ul>
<li><code>create(path, data, flags)</code>: returns the name of the new znode</li>
<li><code>delete(path, version)</code>: Deletes the znode path if that znode is at the expected version.</li>
<li><code>exists(path, watch)</code>: The watch flag enables a client to set a watch on the znode.</li>
<li><code>getData(path, watch)</code>: Returns the data and meta-data, such as version information, associated with the znode. ZooKeeper does not set the watch if the znode does not exist.</li>
<li><code>setData(path, data, version)</code>: Writes data[] to znode path if the version number is the current version of the znode.</li>
<li><code>getChildren(path, watch)</code></li>
<li><code>sync(path)</code>: Waits for all updates pending at the start of the operation to propagate to the server that the client is connected to. The path is currently ignored.</li>
</ul>
</li>
<li>
<p>All methods have both a synchronous and an asynchronous version available through the API.</p>
</li>
<li>
<p>If the actual version number of the znode does not match the expected version number the update fails with an unexpected version error.<br />
If the version number is −1, it does not perform version checking.</p>
</li>
<li>
<p>The client library also manages the network connections between the client and ZooKeeper servers.</p>
</li>
</ol>
<h3 id="what-are-the-flags-of-znodes"><a class="markdownIt-Anchor" href="#what-are-the-flags-of-znodes"></a> What are the flags of znodes?</h3>
<ol>
<li><em>Regular</em>: Clients manipulate regular znodes by creating and deleting them explicitly</li>
<li><em>Ephemeral</em>: Clients create such znodes, and they either delete them explicitly, or let the system remove them automatically when the session that creates them terminates</li>
<li><em>Sequential</em>: Those znodes in the same parent znode have a monotonically increasing counter appended to its name. The newer znode has larger sequence value.</li>
<li><em>Watch</em>
<ul>
<li>A read operation with a watch flag set completes as normal except that the server promises to notify the client when the information returned has changed.</li>
<li>Watches are one-time triggers associated with a session; they are unregistered once triggered or the session closes.</li>
<li>Watches indicate that a change has happened, but do not provide the change.</li>
<li>Session events, such as connection loss events, are also sent to watch callbacks so that clients know that watch events may be delayed.</li>
</ul>
</li>
</ol>
<h3 id="what-are-the-differences-between-znodes-and-files-in-file-system"><a class="markdownIt-Anchor" href="#what-are-the-differences-between-znodes-and-files-in-file-system"></a> What are the differences between znodes and files in file system?</h3>
<ol>
<li>
<p>Znodes map to abstractions of the client application, typically corresponding to meta-data used for coordination purposes.</p>
</li>
<li>
<p>Znodes allow clients to store some information that can be used for meta-data or configuration in a distributed computation, like the leadership of a replica group can be stored to a known location.</p>
</li>
<li>
<p>ZooKeeper does not use handles to access znodes. Each request instead includes the full path of the znode being operated on.</p>
<ul>
<li>
<p>It simplifies the API (no <code>open()</code> or <code>close()</code> methods)</p>
</li>
<li>
<p>It also eliminates extra state that the server would need to maintain.</p>
</li>
</ul>
</li>
</ol>
<h3 id="what-does-zookeeper-guarantee"><a class="markdownIt-Anchor" href="#what-does-zookeeper-guarantee"></a> What does ZooKeeper guarantee?</h3>
<ol>
<li>
<p>This definition of its linearizability is called A-linearizability (asynchronous linearizability) that allows a client to have multiple outstanding operations.</p>
<ul>
<li>
<p><em>Linearizable writes</em>: all requests that update the state of ZooKeeper are serializable and respect precedence.</p>
</li>
<li>
<p><em>FIFO client order</em>: all requests from a given client are executed in the order that they were sent by the client.</p>
</li>
</ul>
</li>
<li>
<p>A-linearizability can choose to guarantee no specific order for outstanding operations of the same client or to guarantee FIFO order.</p>
</li>
<li>
<p>A system that satisfies A-linearizability also satisfies linearizability. Because only update requests are A-linearizable, ZooKeeper processes read requests locally at each replica.</p>
</li>
</ol>
<h3 id="how-to-change-configuration"><a class="markdownIt-Anchor" href="#how-to-change-configuration"></a> How to change configuration?</h3>
<ol>
<li>
<p>Two requirements:</p>
<ul>
<li>As the new leader starts making changes, we do not want other processes to start using the configuration that is being changed.</li>
<li>If the new leader dies before the configuration has been fully updated, we do not want the processes to use this partial configuration.</li>
</ul>
</li>
<li>
<p>The new leader can designate a path as the ready znode; other processes will only use the configuration when that znode exists.</p>
<ul>
<li>The new leader makes the configuration change by deleting ready, updating the various configuration znodes, and creating ready.</li>
<li>All of these changes can be pipelined and issued asynchronously to quickly update the configuration state given the FIFO client order guarantee.</li>
</ul>
</li>
</ol>
<h3 id="how-should-a-client-read-configurations"><a class="markdownIt-Anchor" href="#how-should-a-client-read-configurations"></a> How should a client read configurations?</h3>
<ol>
<li>
<p>If a client sees the ready exists before the new leader starts to make a change, it could read the partial configuration in progress and cannot notice anything.</p>
<ul>
<li>The client need to set the watch flag when they check the existence of the ready znode.</li>
<li>Then it will see a notification informing the client of the change before it can read any of the new configuration.</li>
</ul>
</li>
<li>
<p>If A changes the shared configuration in ZooKeeper and tells B of the change through the shared communication channel, B would expect to see the change when it re-reads the configuration.</p>
<ul>
<li>If B’s ZooKeeper replica is slightly behind A’s, it may not see the new configuration.</li>
<li>B can make sure that it sees the most up-to-date information by issuing a write before re-reading the configuration.</li>
<li><code>sync</code> causes a server to apply all pending write requests before processing the read without the overhead of a full write.</li>
</ul>
</li>
</ol>
<h2 id="implement-primitives"><a class="markdownIt-Anchor" href="#implement-primitives"></a> Implement primitives</h2>
<h3 id="how-does-zookeeper-manage-configuration"><a class="markdownIt-Anchor" href="#how-does-zookeeper-manage-configuration"></a> How does ZooKeeper manage configuration?</h3>
<ol>
<li>Configuration is stored in a znode, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>z</mi><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">z_c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.04398em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>.</li>
<li>Processes start up with the full pathname of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>z</mi><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">z_c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.04398em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>. Starting processes obtain their configuration by reading zc with the watch flag set to true.</li>
<li>If the configuration in <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>z</mi><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">z_c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.04398em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> is ever updated, the processes are notified and read the new configuration, again setting the watch flag to true.</li>
</ol>
<h3 id="how-does-zookeeper-manage-rendezvous"><a class="markdownIt-Anchor" href="#how-does-zookeeper-manage-rendezvous"></a> How does ZooKeeper manage rendezvous?</h3>
<ol>
<li>Use a rendezvous znode, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>z</mi><mi>r</mi></msub></mrow><annotation encoding="application/x-tex">z_r</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.04398em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>, which is an node created by the client.</li>
<li>The client passes the full pathname of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>z</mi><mi>r</mi></msub></mrow><annotation encoding="application/x-tex">z_r</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.04398em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> as a startup parameter of the master and worker processes.</li>
<li>When the master starts, it fills in <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>z</mi><mi>r</mi></msub></mrow><annotation encoding="application/x-tex">z_r</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.04398em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> with information about addresses and ports it is using.</li>
<li>When workers start, they read <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>z</mi><mi>r</mi></msub></mrow><annotation encoding="application/x-tex">z_r</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.04398em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> with watch set to true.
<ul>
<li>If <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>z</mi><mi>r</mi></msub></mrow><annotation encoding="application/x-tex">z_r</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.04398em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> has not been filled in yet, the worker waits to be notified when <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>z</mi><mi>r</mi></msub></mrow><annotation encoding="application/x-tex">z_r</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.04398em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> is updated.</li>
<li>If <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>z</mi><mi>r</mi></msub></mrow><annotation encoding="application/x-tex">z_r</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.04398em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> is an ephemeral node, master and worker processes can watch for <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>z</mi><mi>r</mi></msub></mrow><annotation encoding="application/x-tex">z_r</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.04398em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> to be deleted and clean themselves up when the client ends.</li>
</ul>
</li>
</ol>
<h3 id="how-does-zookeeper-manage-group-mambership"><a class="markdownIt-Anchor" href="#how-does-zookeeper-manage-group-mambership"></a> How does ZooKeeper manage group mambership?</h3>
<ol>
<li>
<p>Designate a znode, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>z</mi><mi>g</mi></msub></mrow><annotation encoding="application/x-tex">z_g</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.716668em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:-0.04398em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span> to represent the group.</p>
</li>
<li>
<p>When a process member of the group starts, it creates an <code>ephemeral</code> child znode under <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>z</mi><mi>g</mi></msub></mrow><annotation encoding="application/x-tex">z_g</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.716668em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:-0.04398em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span>. Processes may put process information in the data of the child znode.</p>
</li>
<li>
<p>If each process has a unique name or identifier, then that name is used as the name of the child znode; otherwise, the process creates the znode with the <code>SEQUENTIAL</code> flag to obtain a unique name assignment.</p>
</li>
</ol>
<h3 id="how-does-zookeeper-manage-mini-transaction"><a class="markdownIt-Anchor" href="#how-does-zookeeper-manage-mini-transaction"></a> How does ZooKeeper manage Mini-transaction?</h3>
<ol>
<li>In a mini-transaction, we want the <code>getData</code> and <code>setData</code> to be atomic.</li>
<li>ZooKeeper can support mini-transaction using version number.</li>
</ol>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> <span class="literal">true</span>:</span><br><span class="line">	X, v = <span class="title function_ invoke__">getData</span>(K)</span><br><span class="line">  <span class="keyword">if</span> <span class="title function_ invoke__">setData</span>(K, X+<span class="number">1</span>, v):</span><br><span class="line">		<span class="keyword">break</span></span><br></pre></td></tr></table></figure>
<h3 id="how-does-zookeeper-implement-simple-locks"><a class="markdownIt-Anchor" href="#how-does-zookeeper-implement-simple-locks"></a> How does ZooKeeper implement simple locks?</h3>
<ol>
<li>
<p>The lock is represented by a znode. To acquire a lock, a client tries to create the designated znode with the <code>EPHEMERAL</code> flag.</p>
</li>
<li>
<p>If the create succeeds, the client holds the lock. Otherwise, the client can read the znode with the watch flag set to be notified if the current leader dies.</p>
</li>
<li>
<p>A client releases the lock when it dies or explicitly deletes the znode.</p>
</li>
<li>
<p>Other clients that are waiting for a lock try again to acquire a lock once they observe the znode being deleted.</p>
</li>
</ol>
<h3 id="how-does-zookeeper-implement-simple-locks-without-herd-effect"><a class="markdownIt-Anchor" href="#how-does-zookeeper-implement-simple-locks-without-herd-effect"></a> How does ZooKeeper implement simple locks without herd effect?</h3>
<ol>
<li>
<p>Herd effect of simple locks: If there are many clients waiting to acquire a lock, they will all vie for the lock when it is released even though only one client can acquire the lock.</p>
</li>
<li>
<p>Define a lock znode l to implement such locks. Line up all the clients requesting the lock and each client obtains the lock in order of request arrival.</p>
<ul>
<li>Use the <code>SEQUENTIAL</code> flag to order the client’s attempt to acquire the lock with respect to all other attempts.</li>
<li>If the client’s znode has the lowest sequence number, the client holds the lock.</li>
<li>Otherwise, the client waits for deletion of the znode that either has the lock or will receive the lock before this client’s znode.</li>
</ul>
</li>
<li>
<p>By only watching the znode that precedes the client’s znode, the herd effect can be avoided by only waking up one process when a lock is released or a lock request is abandoned.</p>
</li>
<li>
<p>Once the znode being watched by the client goes away, the client must check if it now holds the lock.</p>
<ul>
<li>The previous lock request may have been abandoned and there is a znode with a lower sequence number still waiting for or holding the lock.</li>
</ul>
</li>
<li>
<p>Releasing a lock is as simple as deleting the znode n that represents the lock request.</p>
</li>
<li>
<p>We can see by browsing the ZooKeeper data the amount of lock contention, break locks, and debug locking problems.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Lock</span></span><br><span class="line">n = create(l + “/lock-”, EPHEMERAL|SEQUENTIAL)</span><br><span class="line">C = getChildren(l, <span class="literal">false</span>)</span><br><span class="line"><span class="keyword">if</span> n is lowest znode in C, <span class="built_in">exit</span></span><br><span class="line">p = znode in C ordered just before n</span><br><span class="line"><span class="keyword">if</span> exists(p, <span class="literal">true</span>) wait <span class="keyword">for</span> watch event</span><br><span class="line"><span class="keyword">goto</span> <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Unlock</span></span><br><span class="line">delete(n)</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="how-does-zookeeper-implement-readwrite-locks"><a class="markdownIt-Anchor" href="#how-does-zookeeper-implement-readwrite-locks"></a> How does ZooKeeper implement Read/Write locks?</h3>
<ol>
<li>
<p>The write locks is similar to the simple locks since they are all exclusive.</p>
</li>
<li>
<p>Since read locks may be shared, and only earlier write lock znodes prevent the client from obtaining a read lock, read locks only need to check that no lower write znode.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Write lock</span></span><br><span class="line">n = create(l + “/write-”, EPHEMERAL|SEQUENTIAL)</span><br><span class="line">C = getChildren(l, <span class="literal">false</span>)</span><br><span class="line"><span class="keyword">if</span> n is lowest znode in C, <span class="built_in">exit</span></span><br><span class="line">p = znode in C ordered just before n</span><br><span class="line"><span class="keyword">if</span> exists(p, <span class="literal">true</span>) wait <span class="keyword">for</span> event</span><br><span class="line"><span class="keyword">goto</span> <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Read Lock</span></span><br><span class="line">n = create(l + “/read-”, EPHEMERAL|SEQUENTIAL)</span><br><span class="line">C = getChildren(l, <span class="literal">false</span>)</span><br><span class="line"><span class="keyword">if</span> no write znodes lower than n in C, <span class="built_in">exit</span></span><br><span class="line">p = write znode in C ordered just before n</span><br><span class="line"><span class="keyword">if</span> exists(p, <span class="literal">true</span>) wait <span class="keyword">for</span> event</span><br><span class="line"><span class="keyword">goto</span> <span class="number">3</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="what-is-the-difference-between-zookeeper-locks-and-thread-mutex-locks"><a class="markdownIt-Anchor" href="#what-is-the-difference-between-zookeeper-locks-and-thread-mutex-locks"></a> What is the difference between ZooKeeper locks and thread mutex locks?</h3>
<ol>
<li>In ZooKeeper lock, if lock holder fails, system automatically releases locks. So locks are not really enforcing atomicity of other activities.</li>
<li>To make writes atomic, use “ready” trick or mini-transactions.</li>
<li>For master/leader election, new leader must inspect state and clean up.</li>
<li>Or use soft locks like MapReduce, for performance but not correctness. Only one worker will do each task, and each task is OK to be done twice.</li>
</ol>
<h3 id="how-does-zookeeper-implementa-double-barrier"><a class="markdownIt-Anchor" href="#how-does-zookeeper-implementa-double-barrier"></a> How does ZooKeeper implementa double barrier?</h3>
<ol>
<li>Double barriers enable clients to synchronize the beginning and the end of a computation.
<ul>
<li>Enter barrier: At the beginning, a client need to wait until the number of waiting clients exceeds the threshold before it can execute the computation.</li>
<li>Leave barrier: At the end, a client need to wait until the number of finished clients exceeds the threshold before it can exit.</li>
</ul>
</li>
<li>Represent a barrier in ZooKeeper with a znode, referred to as <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi></mrow><annotation encoding="application/x-tex">b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">b</span></span></span></span>.</li>
<li>Every process <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">p</span></span></span></span> registers with <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi></mrow><annotation encoding="application/x-tex">b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">b</span></span></span></span> on entry by creating a znode as a child of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi></mrow><annotation encoding="application/x-tex">b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">b</span></span></span></span>, and unregisters when it is ready to leave by removing the child.
<ul>
<li>Processes can enter the barrier when the number of child znodes of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi></mrow><annotation encoding="application/x-tex">b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">b</span></span></span></span> exceeds the barrier threshold.</li>
<li>Processes can leave the barrier when all of the processes have removed their children.</li>
</ul>
</li>
<li>We use watches to efficiently wait for enter and exit conditions to be satisfied.
<ul>
<li>To enter, processes watch for the existence of a ready child of b that will be created by the process that causes the number of children to exceed the barrier threshold.</li>
<li>To leave, processes watch for a particular child to disappear and only check the exit condition once that znode has been removed.</li>
</ul>
</li>
</ol>
<h2 id="implementation-of-zookeeper"><a class="markdownIt-Anchor" href="#implementation-of-zookeeper"></a> Implementation of ZooKeeper</h2>
<h3 id="how-does-zookeeper-serve-requests"><a class="markdownIt-Anchor" href="#how-does-zookeeper-serve-requests"></a> How does ZooKeeper serve requests?</h3>
<ol>
<li>Upon receiving a request, a server prepares it for execution in request processor.</li>
<li>If a write request requires coordination among the servers, they use atomic broadcast to reach an agreement , and finally servers commit changes to the ZooKeeper database fully replicated across all servers of the ensemble.
<ul>
<li>When a server processes a write request, it also sends out and clears notifications relative to any watch that corresponds to that update.</li>
<li>Only the server that a client is connected to tracks and triggers notifications for that client.</li>
<li>Servers process writes in order and do not process other writes or reads concurrently. This ensures strict succession of notifications.</li>
</ul>
</li>
<li>In the case of read requests, a server simply reads the state of the local database and generates a response to the request.
<ul>
<li>Each read request is processed and tagged with a <em>zxid</em> that corresponds to the last transaction seen by the server.</li>
<li><em>Zxid</em> defines the partial order of the read requests with respect to the write requests.</li>
<li>For applications that require that ZooKeeper do not serve stale data, they can call <code>sync()</code> followed by the read operation.</li>
</ul>
</li>
</ol>
<h3 id="how-does-zookeeper-manage-database"><a class="markdownIt-Anchor" href="#how-does-zookeeper-manage-database"></a> How does ZooKeeper manage database?</h3>
<ol>
<li>The replicated database is an in-memory database containing the entire data tree.</li>
<li>Each znode in the tree stores a maximum of 1MB of data by default, but this maximum value is a configuration parameter that can be changed in specific cases.</li>
<li>For recoverability,
<ul>
<li>Efficiently log updates to disk, and we force writes to be on the disk media before they are applied to the in-memory database.</li>
<li>A replay log (a write-ahead log) of committed operations is kept and periodically generate snapshots of the in-memory database.</li>
</ul>
</li>
</ol>
<h3 id="how-does-request-processor-handle-write-requests"><a class="markdownIt-Anchor" href="#how-does-request-processor-handle-write-requests"></a> How does request processor handle write requests?</h3>
<ol>
<li>When the leader receives a write request, it calculates what the state of the system will be when the write is applied and transforms it into a transaction that captures this new state.</li>
<li>The future state must be calculated because there may be outstanding transactions that have not yet been applied to the database.</li>
</ol>
<h3 id="how-does-servers-reach-agreement"><a class="markdownIt-Anchor" href="#how-does-servers-reach-agreement"></a> How does servers reach agreement?</h3>
<ol>
<li>All requests that update ZooKeeper state are forwarded to the leader.</li>
<li>The leader executes the request and broadcasts the change to the ZooKeeper state through Zab.
<ul>
<li>Zab uses by default simple majority quorums to decide on a proposal, so Zab and thus ZooKeeper can only work if a majority of servers are correct.</li>
<li>Zab guarantees that changes broadcast by a leader are delivered in the order they were sent and all changes from previous leaders are delivered to an established leader before it broadcasts its own changes.</li>
<li>Because idempotent transactions is used, multiple delivery is acceptable as long as they are delivered in order.</li>
<li>ZooKeeper requires Zab to redeliver at least all messages that were delivered after the start of the last snapshot.</li>
</ul>
</li>
<li>The server that receives the client request responds to the client when it delivers the corresponding state change.</li>
<li>Use TCP for transport so message order is maintained by the network.</li>
</ol>
<h3 id="how-does-zookeeper-take-snapshot"><a class="markdownIt-Anchor" href="#how-does-zookeeper-take-snapshot"></a> How does ZooKeeper take snapshot?</h3>
<ol>
<li>ZooKeeper snapshots is called fuzzy snapshots since we do not lock the ZooKeeper state to take the snapshot.<br />
Instead, we do a depth first scan of the tree atomically reading each znode’s data and meta-data and writing them to disk.</li>
<li>Since the resulting fuzzy snapshot may have applied some subset of the state changes delivered during the generation of the snapshot, the result may not correspond to the state of ZooKeeper at any point in time.</li>
<li>However, since state changes are idempotent, we can apply them twice as long as we apply the state changes in order.</li>
</ol>
<h3 id="how-does-zookeeper-handle-sync"><a class="markdownIt-Anchor" href="#how-does-zookeeper-handle-sync"></a> How does ZooKeeper handle sync()</h3>
<ol>
<li>It does not need to atomically broadcast sync as using a leader-based algorithm, and it simply places the <code>sync</code> operation at the end of the queue of requests between the leader and the server executing the call to sync.</li>
<li>The follower must be sure that the leader is still the leader.
<ul>
<li>If there are pending transactions that commit, then the server does not suspect the leader.</li>
<li>If the pending queue is empty, the leader needs to issue a null transaction to commit and orders the <code>sync</code> after that transaction.</li>
<li>Hence, when the leader is under load, no extra broadcast traffic is generated.</li>
<li>Timeouts are set such that leaders realize they are not leaders before followers abandon them, so it does not issue the null transaction.</li>
</ul>
</li>
</ol>
<h3 id="how-does-zookeeper-ensure-to-serve-data-at-least-as-update-as-last-server-served-that-data"><a class="markdownIt-Anchor" href="#how-does-zookeeper-ensure-to-serve-data-at-least-as-update-as-last-server-served-that-data"></a> How does ZooKeeper ensure to serve data at least as update as last server served that data?</h3>
<ol>
<li>Check the last zxid of the client against its last zxid.</li>
<li>If the client has a more recent view than the server, the server does not reestablish the session with the client until the server has caught up.</li>
</ol>
<h3 id="how-to-detect-client-session-failures"><a class="markdownIt-Anchor" href="#how-to-detect-client-session-failures"></a> How to detect client session failures?</h3>
<ol>
<li>The leader determines that there has been a failure if no other server receives anything from a client session within the session timeout.</li>
<li>If the client sends requests frequently enough, then there is no need to send any other message.<br />
Otherwise, the client sends heartbeat messages during periods of low activity.</li>
<li>If the client cannot communicate with a server to send a request or heartbeat, it connects to a different ZooKeeper server to re-establish its session.</li>
<li>To prevent the session from timing out, the ZooKeeper client library sends a heartbeat after the session has been idle for <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi mathvariant="normal">/</mi><mn>3</mn></mrow><annotation encoding="application/x-tex">s/3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">s</span><span class="mord">/</span><span class="mord">3</span></span></span></span> ms and switch to a new server if it has not heard from a server for <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn><mi>s</mi><mi mathvariant="normal">/</mi><mn>3</mn></mrow><annotation encoding="application/x-tex">2s/3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">2</span><span class="mord mathnormal">s</span><span class="mord">/</span><span class="mord">3</span></span></span></span> ms, where <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi></mrow><annotation encoding="application/x-tex">s</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">s</span></span></span></span> is the session timeout in milliseconds.</li>
</ol>
<h1 id="evaluation-and-results"><a class="markdownIt-Anchor" href="#evaluation-and-results"></a> Evaluation and results</h1>
<ol>
<li>
<p>To show the scalability of the system, the author varied the number of servers that make up the ZooKeeper service, but always kept the number of clients the same.</p>
<p>The throughput performance of a saturated system as the ratio of reads to writes vary is as shown below.</p>
<img src="/imgs/Distributed/ZooKeeper/Throughput.png">
</li>
<li>
<p>There are two reasons for write requests taking longer than read requests.</p>
<ul>
<li>First, write requests must go through atomic broadcast, which requires some extra processing and adds latency to requests.</li>
<li>The other reason for longer processing of write requests is that servers must ensure that transactions are logged to non-volatile store before sending acknowledgments back to the leader.</li>
</ul>
</li>
<li>
<p>The atomic broadcast protocol does most of the work of the system and thus limits the performance of ZooKeeper more than any other component.</p>
<p>To benchmark its performance the author simulates clients by generating the transactions directly at the leader, so there is no client connections or client requests and replies.</p>
<p>The result is as shown below:</p>
<img src="/imgs/Distributed/ZooKeeper/AtomicBroadcast.png">
</li>
<li>
<p>The author also tested the throughput of the system when occurring different failure events.</p>
<p>The events are: ① Failure and recovery of a follower; ② Failure and recovery of a different follower; ③ Failure of the leader; ④Failure of two followers (a, b) in the first two marks, and recovery at the third mark ©; ⑤ Failure of the leader; ⑥Recovery of the leader.</p>
<img src="/imgs/Distributed/ZooKeeper/Failures.png">
</li>
<li>
<p>To assess the latency of requests, the author creates a worker process that simply sends a create, waits for it to finish, sends an asynchronous delete of the new node, and then starts the next create.</p>
<p>Then the throughput can be calculated by dividing the number of create requests completed by the total time it took for all the workers to complete.</p>
<img src="/imgs/Distributed/ZooKeeper/Latency.png">
</li>
<li>
<p>The author also measured the performance of primitives implemented with ZooKeeper. They measured the performance of barriers.</p>
<p>The time to process all barriers increase roughly linearly with the number of barriers, showing that concurrent access to the same part of the data tree did not produce any unexpected delay</p>
<p>Latency increases proportionally to the number of clients. This is a consequence of not saturating the ZooKeeper service due to clients waiting on other clients.</p>
<img src="/imgs/Distributed/ZooKeeper/Barrier.png">
</li>
</ol>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Distributed-System/" rel="tag"><i class="fa fa-tag"></i> Distributed System</a>
              <a href="/tags/Distributed-Storage/" rel="tag"><i class="fa fa-tag"></i> Distributed Storage</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2023/09/26/Paper/Distributed/Raft/" rel="prev" title="Raft">
                  <i class="fa fa-chevron-left"></i> Raft
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2023/09/26/Paper/Distributed/CRAQ/" rel="next" title="CRAQ">
                  CRAQ <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">LiyunZhang</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" rel="noopener" target="_blank">NexT.Mist</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>







  




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.7/katex.min.css" integrity="sha256-hLTCMFlKxdNgPXyWlSSxYN0ykJmxxq9Yt3MNfdRGWeA=" crossorigin="anonymous">



</body>
</html>
